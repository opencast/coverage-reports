<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>FFmpegEdit.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-videoeditor-ffmpeg-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.videoeditor.ffmpeg</a> &gt; <span class="el_source">FFmpegEdit.java</span></div><h1>FFmpegEdit.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */


package org.opencastproject.videoeditor.ffmpeg;

import org.opencastproject.util.IoSupport;
import org.opencastproject.videoeditor.impl.VideoClip;
import org.opencastproject.videoeditor.impl.VideoEditorProperties;

import org.apache.commons.lang3.StringUtils;
import org.osgi.framework.BundleContext;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.text.DecimalFormat;
import java.text.DecimalFormatSymbols;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Locale;
import java.util.Properties;

/**
 * FFmpeg wrappers:
 * processEdits:    process SMIL definitions of segments into one consecutive video
 *                  There is a fade in and a fade out at the beginning and end of each clip
 *
 */
public class FFmpegEdit {

<span class="fc" id="L52">  private static final Logger logger = LoggerFactory.getLogger(FFmpegEdit.class);</span>
  private static final String FFMPEG_BINARY_DEFAULT = &quot;ffmpeg&quot;;
  private static final String CONFIG_FFMPEG_PATH = &quot;org.opencastproject.composer.ffmpeg.path&quot;;

  private static final String DEFAULT_FFMPEG_PROPERTIES = &quot;-preset faster -crf 18&quot;;
  private static final String DEFAULT_AUDIO_FADE = &quot;0.2&quot;;
  private static final String DEFAULT_VIDEO_FADE = &quot;0.2&quot;;
<span class="fc" id="L59">  private static String binary = FFMPEG_BINARY_DEFAULT;</span>

  protected float vfade;
  protected float afade;
<span class="fc" id="L63">  protected String ffmpegProperties = DEFAULT_FFMPEG_PROPERTIES;</span>
<span class="fc" id="L64">  protected String ffmpegScaleFilter = null;</span>
<span class="fc" id="L65">  protected String videoCodec = null;  // By default, use the same codec as source</span>
<span class="fc" id="L66">  protected String audioCodec = null;</span>

  public static void init(BundleContext bundleContext) {
<span class="fc" id="L69">    String path = bundleContext.getProperty(CONFIG_FFMPEG_PATH);</span>

<span class="pc bpc" id="L71" title="1 of 2 branches missed.">    if (StringUtils.isNotBlank(path)) {</span>
<span class="nc" id="L72">      binary = path.trim();</span>
    }
<span class="fc" id="L74">  }</span>

<span class="fc" id="L76">  public FFmpegEdit() {</span>
<span class="fc" id="L77">    this.afade = Float.parseFloat(DEFAULT_AUDIO_FADE);</span>
<span class="fc" id="L78">    this.vfade = Float.parseFloat(DEFAULT_VIDEO_FADE);</span>
<span class="fc" id="L79">    this.ffmpegProperties = DEFAULT_FFMPEG_PROPERTIES;</span>
<span class="fc" id="L80">  }</span>

  /*
   * Init with properties
   */
<span class="fc" id="L85">  public FFmpegEdit(Properties properties) {</span>
<span class="fc" id="L86">    String fade = properties.getProperty(VideoEditorProperties.AUDIO_FADE, DEFAULT_AUDIO_FADE);</span>
<span class="fc" id="L87">    this.afade = Float.parseFloat(fade);</span>
<span class="fc" id="L88">    fade = properties.getProperty(VideoEditorProperties.VIDEO_FADE, DEFAULT_VIDEO_FADE);</span>
<span class="fc" id="L89">    this.vfade = Float.parseFloat(fade);</span>
<span class="fc" id="L90">    this.ffmpegProperties = properties.getProperty(VideoEditorProperties.FFMPEG_PROPERTIES, DEFAULT_FFMPEG_PROPERTIES);</span>
<span class="fc" id="L91">    this.ffmpegScaleFilter = properties.getProperty(VideoEditorProperties.FFMPEG_SCALE_FILTER, null);</span>
<span class="fc" id="L92">    this.videoCodec = properties.getProperty(VideoEditorProperties.VIDEO_CODEC, null);</span>
<span class="fc" id="L93">    this.audioCodec = properties.getProperty(VideoEditorProperties.AUDIO_CODEC, null);</span>
<span class="fc" id="L94">  }</span>

  public String processEdits(List&lt;String&gt; inputfiles, String dest, String outputSize, List&lt;VideoClip&gt; cleanclips)
          throws Exception {
<span class="fc" id="L98">    return processEdits(inputfiles, dest, outputSize, cleanclips, true, true);</span>
  }

  public String processEdits(List&lt;String&gt; inputfiles, String dest, String outputSize, List&lt;VideoClip&gt; cleanclips,
          boolean hasAudio, boolean hasVideo) throws Exception {
<span class="fc" id="L103">    List&lt;String&gt; cmd = makeEdits(inputfiles, dest, outputSize, cleanclips, hasAudio, hasVideo);</span>
<span class="fc" id="L104">    return run(cmd);</span>
  }

  /* Run the ffmpeg command with the params
   * Takes a list of words as params, the output is logged
   */
  private String run(List&lt;String&gt; params) {
<span class="fc" id="L111">    BufferedReader in = null;</span>
<span class="fc" id="L112">    Process encoderProcess = null;</span>
    try {
<span class="fc" id="L114">      params.add(0, &quot;-nostats&quot;);</span>
<span class="fc" id="L115">      params.add(0, &quot;-nostdin&quot;);</span>
<span class="fc" id="L116">      params.add(0, &quot;-hide_banner&quot;);</span>
<span class="fc" id="L117">      params.add(0, binary);</span>
<span class="fc" id="L118">      logger.info(&quot;executing command: &quot; + StringUtils.join(params, &quot; &quot;));</span>
<span class="fc" id="L119">      ProcessBuilder pbuilder = new ProcessBuilder(params);</span>
<span class="fc" id="L120">      pbuilder.redirectErrorStream(true);</span>
<span class="fc" id="L121">      encoderProcess = pbuilder.start();</span>
<span class="fc" id="L122">      in = new BufferedReader(new InputStreamReader(</span>
<span class="fc" id="L123">              encoderProcess.getInputStream()));</span>
      String line;
<span class="fc" id="L125">      int n = 5;</span>
<span class="fc bfc" id="L126" title="All 2 branches covered.">      while ((line = in.readLine()) != null) {</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">        if (n-- &gt; 0) {</span>
<span class="fc" id="L128">          logger.info(line);</span>
        }
      }

      // wait until the task is finished
<span class="fc" id="L133">      encoderProcess.waitFor();</span>
<span class="fc" id="L134">      int exitCode = encoderProcess.exitValue();</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">      if (exitCode != 0) {</span>
<span class="nc" id="L136">        throw new Exception(&quot;Ffmpeg exited abnormally with status &quot; + exitCode);</span>
      }

<span class="nc" id="L139">    } catch (Exception ex) {</span>
<span class="nc" id="L140">      logger.error(&quot;VideoEditor ffmpeg failed&quot;, ex);</span>
<span class="nc" id="L141">      return ex.toString();</span>
    } finally {
<span class="fc" id="L143">      IoSupport.closeQuietly(in);</span>
<span class="fc" id="L144">      IoSupport.closeQuietly(encoderProcess);</span>
    }
<span class="fc" id="L146">    return null;</span>
  }

  /*
   * Construct the ffmpeg command from  src, in-out points and output resolution
   * Inputfile is an ordered list of video src
   * clips is a list of edit points indexing into the video src list
   * outputResolution when specified is the size to which all the clips will scale
   * hasAudio and hasVideo specify media type of the input files
   * NOTE: This command will fail if the sizes are mismatched or
   * if some of the clips aren't same as specified mediatype
   * (hasn't audio or video stream while hasAudio, hasVideo parameter set)
   */
  public List&lt;String&gt; makeEdits(List&lt;String&gt; inputfiles, String dest, String outputResolution,
          List&lt;VideoClip&gt; clips, boolean hasAudio, boolean hasVideo) throws Exception {

<span class="pc bpc" id="L162" title="3 of 4 branches missed.">    if (!hasAudio &amp;&amp; !hasVideo) {</span>
<span class="nc" id="L163">      throw new IllegalArgumentException(&quot;Inputfiles should have at least audio or video stream.&quot;);</span>
    }

<span class="fc" id="L166">    DecimalFormat f = new DecimalFormat(&quot;0.00&quot;, new DecimalFormatSymbols(Locale.US));</span>
<span class="fc" id="L167">    int n = clips.size();</span>
    int i;
<span class="fc" id="L169">    String outmap = &quot;&quot;;</span>
<span class="fc" id="L170">    String scale = &quot;&quot;;</span>
<span class="fc" id="L171">    List&lt;String&gt; command = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L172">    List&lt;String&gt; vpads = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L173">    List&lt;String&gt; apads = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L174">    List&lt;String&gt; clauses = new ArrayList&lt;String&gt;(); // The clauses are ordered</span>

<span class="fc bfc" id="L176" title="All 2 branches covered.">    if (n &gt; 1) { // Create the input pads if we have multiple segments</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">      for (i = 0; i &lt; n ; i++) {</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">        if (hasVideo) {</span>
<span class="fc" id="L179">          vpads.add(&quot;[v&quot; + i + &quot;]&quot;);  // post filter</span>
        }
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">        if (hasAudio) {</span>
<span class="fc" id="L182">          apads.add(&quot;[a&quot; + i + &quot;]&quot;);</span>
        }
      }
    }
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">    if (hasVideo) {</span>
<span class="fc bfc" id="L187" title="All 4 branches covered.">      if (outputResolution != null &amp;&amp; outputResolution.length() &gt; 3) { // format is &quot;&lt;width&gt;x&lt;height&gt;&quot;</span>
        // scale each clip to the same size
<span class="fc" id="L189">        scale = &quot;,scale=&quot; + outputResolution;</span>
      }
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">      else if (ffmpegScaleFilter != null) {</span>
        // Use scale filter if configured
<span class="nc" id="L193">        scale = &quot;,scale=&quot; +  ffmpegScaleFilter;</span>
      }
    }

<span class="fc bfc" id="L197" title="All 2 branches covered.">    for (i = 0; i &lt; n; i++) { // Examine each clip</span>
      // get clip and add fades to each clip
<span class="fc" id="L199">      VideoClip vclip = clips.get(i);</span>
<span class="fc" id="L200">      int fileindx = vclip.getSrc();   // get source file by index</span>
<span class="fc" id="L201">      double inpt = vclip.getStartInSeconds();     // get in points</span>
<span class="fc" id="L202">      double duration = vclip.getDurationInSeconds();</span>

<span class="fc" id="L204">      String clip = &quot;&quot;;</span>
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">      if (hasVideo) {</span>
<span class="fc" id="L206">        String vfadeFilter = &quot;&quot;;</span>
        /* Only include fade into the filter graph if necessary */
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">        if (vfade &gt; 0.00001) {</span>
<span class="fc" id="L209">          double vend = duration - vfade;</span>
<span class="fc" id="L210">          vfadeFilter = &quot;,fade=t=in:st=0:d=&quot; + vfade + &quot;,fade=t=out:st=&quot; + f.format(vend) + &quot;:d=&quot; + vfade;</span>
        }
        /* Add filters for video */
<span class="fc" id="L213">        clip = &quot;[&quot; + fileindx + &quot;:v]trim=&quot; + f.format(inpt) + &quot;:duration=&quot; + f.format(duration)</span>
                  + scale + &quot;,setpts=PTS-STARTPTS&quot; + vfadeFilter + &quot;[v&quot; + i + &quot;]&quot;;

<span class="fc" id="L216">        clauses.add(clip);</span>
      }

<span class="pc bpc" id="L219" title="1 of 2 branches missed.">      if (hasAudio) {</span>
<span class="fc" id="L220">        String afadeFilter = &quot;&quot;;</span>
        /* Only include fade into the filter graph if necessary */
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">        if (afade &gt; 0.00001) {</span>
<span class="fc" id="L223">          double aend = duration - afade;</span>
<span class="fc" id="L224">          afadeFilter = &quot;,afade=t=in:st=0:d=&quot; + afade + &quot;,afade=t=out:st=&quot; + f.format(aend) + &quot;:d=&quot; + afade;</span>
        }
        /* Add filters for audio */
<span class="fc" id="L227">        clip = &quot;[&quot; + fileindx + &quot;:a]atrim=&quot; + f.format(inpt) + &quot;:duration=&quot; + f.format(duration)</span>
                  + &quot;,asetpts=PTS-STARTPTS&quot; + afadeFilter + &quot;[a&quot;
                  + i + &quot;]&quot;;
<span class="fc" id="L230">        clauses.add(clip);</span>
      }
    }
<span class="fc bfc" id="L233" title="All 2 branches covered.">    if (n &gt; 1) { // concat the outpads when there are more then 1 per stream</span>
                  // use unsafe because different files may have different SAR/framerate
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">      if (hasVideo) {</span>
<span class="fc" id="L236">        clauses.add(StringUtils.join(vpads, &quot;&quot;) + &quot;concat=n=&quot; + n + &quot;:unsafe=1[ov0]&quot;); // concat video clips</span>
      }
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">      if (hasAudio) {</span>
<span class="fc" id="L239">        clauses.add(StringUtils.join(apads, &quot;&quot;) + &quot;concat=n=&quot; + n</span>
                + &quot;:v=0:a=1[oa0]&quot;); // concat audio clips in stream 0, video in stream 1
      }
<span class="fc" id="L242">      outmap = &quot;o&quot;;                 // if more than one clip</span>
    }
<span class="fc bfc" id="L244" title="All 2 branches covered.">    for (String o : inputfiles) {</span>
<span class="fc" id="L245">      command.add(&quot;-i&quot;);   // Add inputfile in the order of entry</span>
<span class="fc" id="L246">      command.add(o);</span>
<span class="fc" id="L247">    }</span>
<span class="fc" id="L248">    command.add(&quot;-filter_complex&quot;);</span>
<span class="fc" id="L249">    command.add(StringUtils.join(clauses, &quot;;&quot;));</span>
<span class="fc" id="L250">    String[] options = ffmpegProperties.split(&quot; &quot;);</span>
<span class="fc" id="L251">    command.addAll(Arrays.asList(options));</span>
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">    if (hasAudio) {</span>
<span class="fc" id="L253">      command.add(&quot;-map&quot;);</span>
<span class="fc" id="L254">      command.add(&quot;[&quot; + outmap + &quot;a0]&quot;);</span>
    }
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">    if (hasVideo) {</span>
<span class="fc" id="L257">      command.add(&quot;-map&quot;);</span>
<span class="fc" id="L258">      command.add(&quot;[&quot; + outmap + &quot;v0]&quot;);</span>
    }
<span class="pc bpc" id="L260" title="2 of 4 branches missed.">    if (hasVideo &amp;&amp; videoCodec != null) { // If using different codecs from source, add them here</span>
<span class="nc" id="L261">      command.add(&quot;-c:v&quot;);</span>
<span class="nc" id="L262">      command.add(videoCodec);</span>
    }
<span class="pc bpc" id="L264" title="2 of 4 branches missed.">    if (hasAudio &amp;&amp; audioCodec != null) {</span>
<span class="nc" id="L265">      command.add(&quot;-c:a&quot;);</span>
<span class="nc" id="L266">      command.add(audioCodec);</span>
    }
<span class="fc" id="L268">    command.add(dest);</span>

<span class="fc" id="L270">    return command;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>