<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AdopterRegistrationRestService.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-adopter-registration-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.adopter.registration</a> &gt; <span class="el_source">AdopterRegistrationRestService.java</span></div><h1>AdopterRegistrationRestService.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.adopter.registration;

import static javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;
import static javax.servlet.http.HttpServletResponse.SC_OK;
import static org.opencastproject.util.RestUtil.R.ok;
import static org.opencastproject.util.RestUtil.R.serverError;
import static org.opencastproject.util.doc.rest.RestParameter.Type.BOOLEAN;
import static org.opencastproject.util.doc.rest.RestParameter.Type.STRING;

import org.opencastproject.adopter.registration.dto.Adopter;
import org.opencastproject.util.doc.rest.RestParameter;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestResponse;
import org.opencastproject.util.doc.rest.RestService;

import com.google.gson.Gson;

import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.jaxrs.whiteboard.propertytypes.JaxrsResource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Calendar;

import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.DELETE;
import javax.ws.rs.FormParam;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;

/**
 * The REST endpoint for the adopter statistics service.
 */
@Path(&quot;/admin-ng/adopter&quot;)
@RestService(name = &quot;registrationController&quot;,
        title = &quot;Adopter Statistics Registration Service Endpoint&quot;,
        abstractText = &quot;Rest Endpoint for the registration form.&quot;,
        notes = {&quot;Provides operations regarding the adopter registration form&quot;})
@Component(
    immediate = true,
    service = AdopterRegistrationRestService.class,
    property = {
        &quot;service.description=Adopter Statistics REST Endpoint&quot;,
        &quot;opencast.service.type=org.opencastproject.adopter.registration.AdopterRegistrationRestService&quot;,
        &quot;opencast.service.path=/admin-ng/adopter&quot;,
        &quot;opencast.service.jobproducer=false&quot;
    }
)
@JaxrsResource
<span class="nc" id="L76">public class AdopterRegistrationRestService {</span>

  /** The logger */
<span class="nc" id="L79">  private static final Logger logger = LoggerFactory.getLogger(AdopterRegistrationRestService.class);</span>

  /** The JSON parser */
<span class="nc" id="L82">  private static final Gson gson = new Gson();</span>

  /** The rest docs */
  protected String docs;

  /** The service that provides methods for the registration */
  protected AdopterRegistrationServiceImpl registrationService;

  /** OSGi setter for the registration service */
  @Reference
  public void setRegistrationService(AdopterRegistrationServiceImpl registrationService) {
<span class="nc" id="L93">    this.registrationService = registrationService;</span>
<span class="nc" id="L94">  }</span>

  @GET
  @Path(&quot;registration&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;getregistrationform&quot;, description = &quot;GETs the adopter registration data.&quot;, responses = {
          @RestResponse(description = &quot;Retrieved registration data.&quot;,
                        responseCode = HttpServletResponse.SC_OK),
          @RestResponse(description = &quot;Error while retrieving adopter registration data.&quot;,
                        responseCode = HttpServletResponse.SC_INTERNAL_SERVER_ERROR) },
                        returnDescription = &quot;GETs the adopter registration data.&quot;)
  public String getRegistrationForm() {
<span class="nc" id="L106">    logger.debug(&quot;Retrieving adopter registration data.&quot;);</span>
<span class="nc" id="L107">    return gson.toJson(registrationService.get());</span>
  }

  @GET
  @Path(&quot;summary&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;getsummary&quot;, description = &quot;GETs the adopter registration statistics data.&quot;,
      responses = {
          @RestResponse(description = &quot;Retrieved statistic data.&quot;,
              responseCode = HttpServletResponse.SC_OK),
          @RestResponse(description = &quot;Error while retrieving adopter statistic data.&quot;,
              responseCode = HttpServletResponse.SC_INTERNAL_SERVER_ERROR)
      },
      returnDescription = &quot;GETs the adopter registration statistics data.&quot;)
  public Response getAdopterStatistics() {
<span class="nc" id="L122">    logger.debug(&quot;Retrieving adopter registration statistics data.&quot;);</span>
    try {
<span class="nc" id="L124">      return Response.ok(registrationService.getRegistrationDataAsString()).build();</span>
<span class="nc" id="L125">    } catch (Exception e) {</span>
<span class="nc" id="L126">      return Response.serverError().build();</span>
    }
  }

  @POST
  @Path(&quot;registration&quot;)
  @RestQuery(name = &quot;saveregistrationform&quot;,
          description = &quot;Saves the adopter registration data.&quot;,
          returnDescription = &quot;Status&quot;,
          restParameters = {
                  @RestParameter(description = &quot;The Name of the organisation.&quot;,
                          isRequired = false, name = &quot;organisationName&quot;, type = STRING),
                  @RestParameter(description = &quot;The Name of the department.&quot;,
                          isRequired = false, name = &quot;departmentName&quot;, type = STRING),
                  @RestParameter(description = &quot;The First name.&quot;,
                          isRequired = false, name = &quot;firstName&quot;, type = STRING),
                  @RestParameter(description = &quot;The Last name.&quot;,
                          isRequired = false, name = &quot;lastName&quot;, type = STRING),
                  @RestParameter(description = &quot;The e-mail address.&quot;,
                          isRequired = false, name = &quot;email&quot;, type = STRING),
                  @RestParameter(description = &quot;The country.&quot;,
                          isRequired = false, name = &quot;country&quot;, type = STRING),
                  @RestParameter(description = &quot;The postal code.&quot;,
                          isRequired = false, name = &quot;postalCode&quot;, type = STRING),
                  @RestParameter(description = &quot;The city.&quot;,
                          isRequired = false, name = &quot;city&quot;, type = STRING),
                  @RestParameter(description = &quot;The street.&quot;,
                          isRequired = false, name = &quot;street&quot;, type = STRING),
                  @RestParameter(description = &quot;The street number.&quot;,
                          isRequired = false, name = &quot;streetNo&quot;, type = STRING),
                  @RestParameter(description = &quot;Does the adopter allows to be contacted.&quot;,
                          isRequired = false, name = &quot;contactMe&quot;, type = BOOLEAN),
                  @RestParameter(description = &quot;Does the adopter agreed to the policy.&quot;,
                          isRequired = false, name = &quot;agreedToPolicy&quot;, type = BOOLEAN),
                  @RestParameter(description = &quot;Does the adopter allow the gathering of error reports.&quot;,
                          isRequired = false, name = &quot;allowsErrorReports&quot;, type = BOOLEAN),
                  @RestParameter(description = &quot;Which type of system is this.&quot;,
                          isRequired = false, name = &quot;systemType&quot;, type = STRING),
                  @RestParameter(description = &quot;Does the adopter allow the gathering of statistic data.&quot;,
                          isRequired = false, name = &quot;allowsStatistics&quot;, type = BOOLEAN),
                  @RestParameter(description = &quot;Is the adopter already registered.&quot;,
                          isRequired = false, name = &quot;registered&quot;, type = BOOLEAN)
          },
          responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Adopter registration data saved.&quot;),
          @RestResponse(responseCode = SC_BAD_REQUEST, description = &quot;Couldn't save adopter registration data.&quot;)})
  public Response register(
          @FormParam(&quot;organisationName&quot;) String organisationName,
          @FormParam(&quot;departmentName&quot;) String departmentName,
          @FormParam(&quot;firstName&quot;) String firstName,
          @FormParam(&quot;lastName&quot;) String lastName,
          @FormParam(&quot;email&quot;) String email,
          @FormParam(&quot;country&quot;) String country,
          @FormParam(&quot;postalCode&quot;) String postalCode,
          @FormParam(&quot;city&quot;) String city,
          @FormParam(&quot;street&quot;) String street,
          @FormParam(&quot;streetNo&quot;) String streetNo,
          @FormParam(&quot;contactMe&quot;) boolean contactMe,
          @FormParam(&quot;agreedToPolicy&quot;) boolean agreedToPolicy,
          @FormParam(&quot;systemType&quot;) String systemType,
          @FormParam(&quot;allowsErrorReports&quot;) boolean allowsErrorReports,
          @FormParam(&quot;allowsStatistics&quot;) boolean allowsStatistics,
          @FormParam(&quot;registered&quot;) boolean registered) {
<span class="nc" id="L189">    logger.debug(&quot;Saving adopter registration data.&quot;);</span>

<span class="nc" id="L191">    Adopter adopter = new Adopter(organisationName, departmentName, firstName, lastName, email, country, postalCode,</span>
        city, street, streetNo, contactMe, systemType, allowsStatistics, allowsErrorReports, agreedToPolicy, registered
    );
    try {
<span class="nc" id="L195">      registrationService.save(adopter);</span>
<span class="nc" id="L196">    } catch (Exception e) {</span>
<span class="nc" id="L197">      logger.error(&quot;Error while saving adopter registration data.&quot;, e);</span>
<span class="nc" id="L198">      return Response.serverError().build();</span>
<span class="nc" id="L199">    }</span>
<span class="nc" id="L200">    return Response.ok().build();</span>
  }

  @POST
  @Path(&quot;registration/finalize&quot;)
  @RestQuery(name = &quot;finalizeRegistration&quot;,
      description = &quot;Finalizes the registration and starts sending data.&quot;,
      returnDescription = &quot;Status&quot;,
      restParameters = {},
      responses = { @RestResponse(responseCode = SC_OK, description = &quot;Registration finalized.&quot;) })
  public Response register() {
<span class="nc" id="L211">    logger.debug(&quot;Finalizing adopter registration.&quot;);</span>

<span class="nc" id="L213">    Adopter adopter = (Adopter) registrationService.get();</span>
<span class="nc" id="L214">    adopter.setRegistered(true);</span>

    try {
<span class="nc" id="L217">      registrationService.save(adopter);</span>
<span class="nc" id="L218">    } catch (Exception e) {</span>
<span class="nc" id="L219">      logger.error(&quot;Error while saving adopter registration data.&quot;, e);</span>
<span class="nc" id="L220">      return Response.serverError().build();</span>
<span class="nc" id="L221">    }</span>
<span class="nc" id="L222">    return Response.ok().build();</span>
  }

  @GET
  @Produces(MediaType.TEXT_PLAIN)
  @Path(&quot;isUpToDate&quot;)
  @RestQuery(name = &quot;isUpToDate&quot;, description = &quot;Returns true if Opencast has been able to register&quot;, responses = {
      @RestResponse(description = &quot;Registratino status&quot;,
          responseCode = HttpServletResponse.SC_OK)
      },
      returnDescription = &quot;true if registration has been updated in the last week, false otherwise&quot;)
  public Response isUpToDate() {
<span class="nc" id="L234">    Adopter data = (Adopter) registrationService.get();</span>
<span class="nc" id="L235">    Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L236">    cal.add(Calendar.DAY_OF_MONTH, -7);</span>
    //A fresh install might have no data at all, so we null check everything
<span class="nc bnc" id="L238" title="All 6 branches missed.">    if (data != null &amp;&amp; data.getDateModified() != null &amp;&amp; data.getDateModified().after(cal.getTime())) {</span>
<span class="nc" id="L239">      return Response.ok(&quot;true&quot;).build();</span>
    }
<span class="nc" id="L241">    return Response.ok(&quot;false&quot;).build();</span>
  }

  @DELETE
  @Path(&quot;registration&quot;)
  @RestQuery(name = &quot;deleteregistrationform&quot;, description = &quot;Deletes the adopter registration data&quot;, responses = {
          @RestResponse(description = &quot;Successful deleted form data.&quot;,
                  responseCode = HttpServletResponse.SC_OK),
          @RestResponse(description = &quot;Error while deleting adopter registration data.&quot;,
                  responseCode = HttpServletResponse.SC_INTERNAL_SERVER_ERROR) },
          returnDescription = &quot;DELETEs the adopter registration data.&quot;)
  public Response deleteRegistrationData() {
<span class="nc" id="L253">    logger.debug(&quot;Deleting adopter registration data.&quot;);</span>
    try {
<span class="nc" id="L255">      registrationService.markForDeletion();</span>
<span class="nc" id="L256">      return ok();</span>
<span class="nc" id="L257">    } catch (Exception e) {</span>
<span class="nc" id="L258">      logger.error(&quot;Error while deleting adopter registration data.&quot;, e);</span>
<span class="nc" id="L259">      return serverError();</span>
    }
  }


  @GET
  @Produces(MediaType.TEXT_PLAIN)
  @Path(&quot;latestToU&quot;)
  @RestQuery(name = &quot;getLatestTermsOfUse&quot;, description = &quot;Gets the latest terms of use version.&quot;, responses = {
      @RestResponse(description = &quot;Retrieved statistic data.&quot;, responseCode = HttpServletResponse.SC_OK) },
      returnDescription = &quot;The latest terms of use version.&quot;)
  public String getLatestTermsofUse() {
<span class="nc" id="L271">    return Adopter.getLatestTermsOfUse().name();</span>
  }


  @GET
  @Produces(MediaType.TEXT_HTML)
  @Path(&quot;docs&quot;)
  public String getDocs() {
<span class="nc" id="L279">    return docs;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>