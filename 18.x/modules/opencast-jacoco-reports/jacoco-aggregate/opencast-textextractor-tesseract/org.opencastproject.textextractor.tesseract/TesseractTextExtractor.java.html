<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>TesseractTextExtractor.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-textextractor-tesseract</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.textextractor.tesseract</a> &gt; <span class="el_source">TesseractTextExtractor.java</span></div><h1>TesseractTextExtractor.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */


package org.opencastproject.textextractor.tesseract;

import static java.nio.charset.StandardCharsets.UTF_8;

import org.opencastproject.textextractor.api.TextExtractor;
import org.opencastproject.textextractor.api.TextExtractorException;

import org.apache.commons.io.FileUtils;
import org.apache.commons.io.FilenameUtils;
import org.apache.commons.lang3.StringUtils;
import org.osgi.service.cm.ManagedService;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Component;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Dictionary;
import java.util.List;

/**
 * Commandline wrapper around tesseract' &lt;code&gt;tesseract&lt;/code&gt; command.
 */
@Component(
    immediate = true,
    service = { TextExtractor.class,ManagedService.class },
    property = {
        &quot;service.description=Tesseract Text Extractor&quot;
    }
)
public class TesseractTextExtractor implements TextExtractor, ManagedService {

  /** The logging facility */
<span class="fc" id="L62">  private static final Logger logger = LoggerFactory.getLogger(TesseractTextExtractor.class);</span>

  /** Default name of the tesseract binary */
  public static final String TESSERACT_BINARY_DEFAULT = &quot;tesseract&quot;;

  /** Configuration property that defines the path to the tesseract binary */
  public static final String TESSERACT_BINARY_CONFIG_KEY =
      &quot;org.opencastproject.textanalyzer.tesseract.path&quot;;

  /** Configuration property that defines additional tesseract options like the
   * language or the pagesegmode to use. This is just appended to the command
   * line when tesseract is called. */
  public static final String TESSERACT_OPTS_CONFIG_KEY =
      &quot;org.opencastproject.textanalyzer.tesseract.options&quot;;

  /** Binary of the tesseract command */
  private String binary;

  /** Additional options for the tesseract command */
<span class="fc" id="L81">  private String addOptions = &quot;&quot;;</span>

  /** Tesseract stderr lines not to log */
<span class="fc" id="L84">  private static final List&lt;String&gt; stderrFilter = java.util.Arrays.asList(</span>
          &quot;Page&quot;,
          &quot;Tesseract Open Source OCR Engine&quot;,
          &quot;Warning: Invalid resolution 0 dpi. Using 70 instead.&quot;,
          &quot;Estimating resolution as &quot;);

  /**
   * Creates a new tesseract command wrapper that will be using the default binary.
   */
  public TesseractTextExtractor() {
<span class="nc" id="L94">    this(TESSERACT_BINARY_DEFAULT);</span>
<span class="nc" id="L95">  }</span>

  /**
   * Creates a new tesseract command wrapper that will be using the given binary.
   *
   * @param binary
   *          the tesseract binary
   */
<span class="fc" id="L103">  public TesseractTextExtractor(String binary) {</span>
<span class="fc" id="L104">    this.binary = binary;</span>
<span class="fc" id="L105">  }</span>

  /**
   * Sets additional options for tesseract calls.
   *
   * @param addOptions
   */
  public void setAdditionalOptions(String addOptions) {
<span class="fc" id="L113">    this.addOptions = addOptions;</span>
<span class="fc" id="L114">  }</span>

  /**
   * Returns the additional options for tesseract..
   *
   * @return additional options
   */
  public String getAdditionalOptions() {
<span class="fc" id="L122">    return addOptions;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.textextractor.api.TextExtractor#extract(java.io.File)
   */
  @Override
  public List&lt;String&gt; extract(File image) throws TextExtractorException {
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">    if (binary == null) {</span>
<span class="nc" id="L133">      throw new IllegalStateException(&quot;Binary is not set&quot;);</span>
    }

<span class="fc" id="L136">    File outputFile = null;</span>
<span class="fc" id="L137">    File outputFileBase = new File(image.getParentFile(), FilenameUtils.getBaseName(image.getName()));</span>
    // Run tesseract
<span class="fc" id="L139">    List&lt;String&gt; command = getTesseractCommand(image, outputFileBase);</span>
<span class="fc" id="L140">    logger.info(&quot;Running Tesseract: {}&quot;, command);</span>
    try {
<span class="fc" id="L142">      ProcessBuilder processBuilder = new ProcessBuilder(command);</span>
<span class="fc" id="L143">      processBuilder.redirectErrorStream(true);</span>
      // Mitigation for new Tesseract 4.x spawning too many threads locking up the system. Limit to one thread.
<span class="fc" id="L145">      processBuilder.environment().put(&quot;OMP_THREAD_LIMIT&quot;, &quot;1&quot;);</span>
<span class="fc" id="L146">      Process tesseractProcess = processBuilder.start();</span>

      // listen to output
<span class="fc" id="L149">      try (BufferedReader in = new BufferedReader(new InputStreamReader(tesseractProcess.getInputStream()))) {</span>
        String line;
<span class="fc bfc" id="L151" title="All 2 branches covered.">        while ((line = in.readLine()) != null) {</span>
<span class="fc" id="L152">          final String trimmedLine = line.trim();</span>
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">          if (stderrFilter.parallelStream().noneMatch(trimmedLine::startsWith)) {</span>
<span class="nc" id="L154">            logger.info(line);</span>
          } else {
<span class="fc" id="L156">            logger.debug(line);</span>
          }
<span class="fc" id="L158">        }</span>
      }

      // wait until the task is finished
<span class="fc" id="L162">      int exitCode = tesseractProcess.waitFor();</span>
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">      if (exitCode != 0) {</span>
<span class="nc" id="L164">        throw new TextExtractorException(&quot;Tesseract exited abnormally with status &quot; + exitCode);</span>
      }

      // Read the tesseract output file
<span class="fc" id="L168">      outputFile = new File(outputFileBase.getAbsolutePath() + &quot;.txt&quot;);</span>
<span class="fc" id="L169">      ArrayList&lt;String&gt; output = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L170">      try (BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(outputFile), UTF_8))) {</span>
        String line;
<span class="fc bfc" id="L172" title="All 2 branches covered.">        while ((line = reader.readLine()) != null) {</span>
<span class="fc" id="L173">          final String trimmedLine = line.trim();</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">          if (!trimmedLine.isEmpty()) {</span>
<span class="fc" id="L175">            output.add(trimmedLine);</span>
          }
<span class="fc" id="L177">        }</span>
      }
<span class="fc" id="L179">      return output;</span>
<span class="nc" id="L180">    } catch (IOException | InterruptedException e) {</span>
<span class="nc" id="L181">      throw new TextExtractorException(&quot;Error running text extractor &quot; + binary, e);</span>
    } finally {
<span class="fc" id="L183">      FileUtils.deleteQuietly(outputFile);</span>
    }
  }

  /**
   * Generate the command line to run Tesseract
   *
   * @param image
   *          the image file
   * @param outputFile
   *          base name of output file. Tesseract will attach &lt;code&gt;.txt&lt;/code&gt;
   * @return the command line to runn Tesseract on the given input file
   */
  private List&lt;String&gt; getTesseractCommand(final File image, final File outputFile) {
<span class="fc" id="L197">    List&lt;String&gt; args = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L198">    args.add(binary);</span>
<span class="fc" id="L199">    args.add(image.getAbsolutePath());</span>
<span class="fc" id="L200">    args.add(outputFile.getAbsolutePath());</span>
<span class="fc" id="L201">    args.addAll(Arrays.asList(StringUtils.split(addOptions)));</span>
<span class="fc" id="L202">    return args;</span>
  }

  @Override
  public void updated(Dictionary properties) {
<span class="nc" id="L207">    String path = (String) properties.get(TESSERACT_BINARY_CONFIG_KEY);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">    if (path != null) {</span>
<span class="nc" id="L209">      logger.info(&quot;Setting Tesseract path to {}&quot;, path);</span>
<span class="nc" id="L210">      this.binary = path;</span>
    }
    /* Set additional options for tesseract (i.e. language to use) */
<span class="nc" id="L213">    String addopts = (String) properties.get(TESSERACT_OPTS_CONFIG_KEY);</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">    if (addopts != null) {</span>
<span class="nc" id="L215">      logger.info(&quot;Setting additional options for Tesseract path to '{}'&quot;, addopts);</span>
<span class="nc" id="L216">      this.addOptions = addopts;</span>
    }
<span class="nc" id="L218">  }</span>

  public void activate(ComponentContext cc) {
    // Configure ffmpeg
<span class="nc" id="L222">    String path = cc.getBundleContext().getProperty(TESSERACT_BINARY_CONFIG_KEY);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">    if (path == null) {</span>
<span class="nc" id="L224">      logger.debug(&quot;DEFAULT &quot; + TESSERACT_BINARY_CONFIG_KEY + &quot;: &quot; + TESSERACT_BINARY_DEFAULT);</span>
    } else {
<span class="nc" id="L226">      this.binary = path;</span>
<span class="nc" id="L227">      logger.info(&quot;Setting Tesseract path to binary from config: {}&quot;, path);</span>
    }
    /* Set additional options for tesseract (i.e. language to use) */
<span class="nc" id="L230">    String addopts = cc.getBundleContext().getProperty(TESSERACT_OPTS_CONFIG_KEY);</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">    if (addopts != null) {</span>
<span class="nc" id="L232">      logger.info(&quot;Setting additional options for Tesseract to '{}'&quot;, addopts);</span>
<span class="nc" id="L233">      this.addOptions = addopts;</span>
    } else {
<span class="nc" id="L235">      logger.info(&quot;No additional options for Tesseract&quot;);</span>
<span class="nc" id="L236">      this.addOptions = &quot;&quot;;</span>
    }
<span class="nc" id="L238">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>