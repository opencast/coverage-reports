<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>EventQueryBuilder.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-elasticsearch-index</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.elasticsearch.index.objects.event</a> &gt; <span class="el_source">EventQueryBuilder.java</span></div><h1>EventQueryBuilder.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.elasticsearch.index.objects.event;

import static org.opencastproject.security.api.SecurityConstants.GLOBAL_ADMIN_ROLE;

import org.opencastproject.elasticsearch.api.SearchTerms;
import org.opencastproject.elasticsearch.api.SearchTerms.Quantifier;
import org.opencastproject.elasticsearch.impl.AbstractElasticsearchQueryBuilder;
import org.opencastproject.elasticsearch.impl.IndexSchema;
import org.opencastproject.security.api.Role;
import org.opencastproject.security.api.User;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.ArrayList;

/**
 * Opencast {@link EventSearchQuery} implementation of the Elasticsearch query builder.
 */
public class EventQueryBuilder extends AbstractElasticsearchQueryBuilder&lt;EventSearchQuery&gt; {

  /** The logging facility */
<span class="nc" id="L44">  private static final Logger logger = LoggerFactory.getLogger(EventQueryBuilder.class);</span>

  /**
   * Creates a new elastic search query based on the events query.
   *
   * @param query
   *          the events query
   */
  public EventQueryBuilder(EventSearchQuery query) {
<span class="nc" id="L53">    super(query);</span>
<span class="nc" id="L54">  }</span>

  @Override
  public void buildQuery(EventSearchQuery query) {
    // Organization
<span class="nc bnc" id="L59" title="All 2 branches missed.">    if (query.getOrganization() == null) {</span>
<span class="nc" id="L60">      throw new IllegalStateException(&quot;No organization set on the event search query!&quot;);</span>
    }

<span class="nc" id="L63">    and(EventIndexSchema.ORGANIZATION, query.getOrganization());</span>

    // Recording identifier
<span class="nc bnc" id="L66" title="All 2 branches missed.">    if (query.getIdentifier().length &gt; 0) {</span>
<span class="nc" id="L67">      and(EventIndexSchema.UID, query.getIdentifier());</span>
    }

    // Title
<span class="nc bnc" id="L71" title="All 2 branches missed.">    if (query.getTitle() != null) {</span>
<span class="nc" id="L72">      and(EventIndexSchema.TITLE, query.getTitle());</span>
    }

    // Description
<span class="nc bnc" id="L76" title="All 2 branches missed.">    if (query.getDescription() != null) {</span>
<span class="nc" id="L77">      and(EventIndexSchema.DESCRIPTION, query.getDescription());</span>
    }

    // Action
<span class="nc bnc" id="L81" title="All 4 branches missed.">    if (query.getActions() != null &amp;&amp; query.getActions().length &gt; 0) {</span>
<span class="nc" id="L82">      User user = query.getUser();</span>
<span class="nc bnc" id="L83" title="All 4 branches missed.">      if (!user.hasRole(GLOBAL_ADMIN_ROLE) &amp;&amp; !user.hasRole(user.getOrganization().getAdminRole())) {</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        for (Role role : user.getRoles()) {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">          for (String action : query.getActions()) {</span>
<span class="nc" id="L86">            and(EventIndexSchema.ACL_PERMISSION_PREFIX.concat(action), role.getName());</span>
          }
<span class="nc" id="L88">        }</span>
      }
    }

    // Presenter
<span class="nc bnc" id="L93" title="All 2 branches missed.">    if (query.getPresenters() != null) {</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">      for (String presenter : query.getPresenters()) {</span>
<span class="nc" id="L95">        and(EventIndexSchema.PRESENTER, presenter);</span>
      }
    }

    // Contributors
<span class="nc bnc" id="L100" title="All 2 branches missed.">    if (query.getContributors().length &gt; 0) {</span>
<span class="nc" id="L101">      and(EventIndexSchema.CONTRIBUTOR, query.getContributors());</span>
    }

    // Subject
<span class="nc bnc" id="L105" title="All 2 branches missed.">    if (query.getSubject() != null) {</span>
<span class="nc" id="L106">      and(EventIndexSchema.SUBJECT, query.getSubject());</span>
    }

    // Location
<span class="nc bnc" id="L110" title="All 2 branches missed.">    if (query.getLocation() != null) {</span>
<span class="nc" id="L111">      and(EventIndexSchema.LOCATION, query.getLocation());</span>
    }

    // Series Id
<span class="nc bnc" id="L115" title="All 2 branches missed.">    if (query.getSeriesId() != null) {</span>
<span class="nc" id="L116">      and(EventIndexSchema.SERIES_ID, query.getSeriesId());</span>
    }

    // Series Name
<span class="nc bnc" id="L120" title="All 2 branches missed.">    if (query.getSeriesName() != null) {</span>
<span class="nc" id="L121">      and(EventIndexSchema.SERIES_NAME, query.getSeriesName());</span>
    }

    // Language
<span class="nc bnc" id="L125" title="All 2 branches missed.">    if (query.getLanguage() != null) {</span>
<span class="nc" id="L126">      and(EventIndexSchema.LANGUAGE, query.getLanguage());</span>
    }

    // Source
<span class="nc bnc" id="L130" title="All 2 branches missed.">    if (query.getSource() != null) {</span>
<span class="nc" id="L131">      and(EventIndexSchema.SOURCE, query.getSource());</span>
    }

    // Created
<span class="nc bnc" id="L135" title="All 2 branches missed.">    if (query.getCreated() != null) {</span>
<span class="nc" id="L136">      and(EventIndexSchema.CREATED, query.getCreated());</span>
    }

    // Creator
<span class="nc bnc" id="L140" title="All 2 branches missed.">    if (query.getCreator() != null) {</span>
<span class="nc" id="L141">      and(EventIndexSchema.CREATOR, query.getCreator());</span>
    }

    // Publisher
<span class="nc bnc" id="L145" title="All 2 branches missed.">    if (query.getPublisher() != null) {</span>
<span class="nc" id="L146">      and(EventIndexSchema.PUBLISHER, query.getPublisher());</span>
    }

    // License
<span class="nc bnc" id="L150" title="All 2 branches missed.">    if (query.getLicense() != null) {</span>
<span class="nc" id="L151">      and(EventIndexSchema.LICENSE, query.getLicense());</span>
    }

    // Rights
<span class="nc bnc" id="L155" title="All 2 branches missed.">    if (query.getRights() != null) {</span>
<span class="nc" id="L156">      and(EventIndexSchema.RIGHTS, query.getRights());</span>
    }

    // Access policy
<span class="nc bnc" id="L160" title="All 2 branches missed.">    if (query.getAccessPolicy() != null) {</span>
<span class="nc" id="L161">      and(EventIndexSchema.ACCESS_POLICY, query.getAccessPolicy());</span>
    }

    // Managed ACL
<span class="nc bnc" id="L165" title="All 2 branches missed.">    if (query.getManagedAcl() != null) {</span>
<span class="nc" id="L166">      and(EventIndexSchema.MANAGED_ACL, query.getManagedAcl());</span>
    }

    // Workflow state
<span class="nc bnc" id="L170" title="All 2 branches missed.">    if (query.getWorkflowState() != null) {</span>
<span class="nc" id="L171">      and(EventIndexSchema.WORKFLOW_STATE, query.getWorkflowState());</span>
    }

    // Workflow id
<span class="nc bnc" id="L175" title="All 2 branches missed.">    if (query.getWorkflowId() != null) {</span>
<span class="nc" id="L176">      and(EventIndexSchema.WORKFLOW_ID, query.getWorkflowId());</span>
    }

    // Workflow definition id
<span class="nc bnc" id="L180" title="All 2 branches missed.">    if (query.getWorkflowDefinition() != null) {</span>
<span class="nc" id="L181">      and(EventIndexSchema.WORKFLOW_DEFINITION_ID, query.getWorkflowDefinition());</span>
    }

    // Event status
<span class="nc bnc" id="L185" title="All 2 branches missed.">    if (query.getEventStatus() != null) {</span>
<span class="nc" id="L186">      and(EventIndexSchema.EVENT_STATUS, query.getEventStatus());</span>
    }

    // Recording start date period
<span class="nc bnc" id="L190" title="All 4 branches missed.">    if (query.getStartFrom() != null &amp;&amp; query.getStartTo() != null) {</span>
<span class="nc" id="L191">      and(EventIndexSchema.START_DATE, query.getStartFrom(), query.getStartTo());</span>
    }

    // Recording start date
<span class="nc bnc" id="L195" title="All 2 branches missed.">    if (query.getStartDate() != null) {</span>
<span class="nc" id="L196">      and(EventIndexSchema.START_DATE, query.getStartDate());</span>
    }

    // Recording duration
<span class="nc bnc" id="L200" title="All 2 branches missed.">    if (query.getDuration() != null) {</span>
<span class="nc" id="L201">      and(EventIndexSchema.DURATION, query.getDuration());</span>
    }

    // Has comments
<span class="nc bnc" id="L205" title="All 2 branches missed.">    if (query.getHasComments() != null) {</span>
<span class="nc" id="L206">      and(EventIndexSchema.HAS_COMMENTS, query.getHasComments());</span>
    }

    // Has open comments
<span class="nc bnc" id="L210" title="All 2 branches missed.">    if (query.getHasOpenComments() != null) {</span>
<span class="nc" id="L211">      and(EventIndexSchema.HAS_OPEN_COMMENTS, query.getHasOpenComments());</span>
    }

    // Publications
<span class="nc bnc" id="L215" title="All 2 branches missed.">    if (query.getComments() != null) {</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">      for (String comment : query.getComments()) {</span>
<span class="nc" id="L217">        and(EventIndexSchema.COMMENTS, comment);</span>
      }
    }

    // Publications
<span class="nc bnc" id="L222" title="All 2 branches missed.">    if (query.getPublications() != null) {</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">      for (String publication : query.getPublications()) {</span>
<span class="nc" id="L224">        and(EventIndexSchema.PUBLICATION, publication);</span>
      }
    }

    // Is published
<span class="nc bnc" id="L229" title="All 2 branches missed.">    if (query.getIsPublished() != null) {</span>
<span class="nc" id="L230">      and(EventIndexSchema.IS_PUBLISHED, query.getIsPublished());</span>
    }

    // Archive version
<span class="nc bnc" id="L234" title="All 2 branches missed.">    if (query.getArchiveVersion() != null) {</span>
<span class="nc" id="L235">      and(EventIndexSchema.ARCHIVE_VERSION, query.getArchiveVersion());</span>
    }

    // Technical agent identifier
<span class="nc bnc" id="L239" title="All 2 branches missed.">    if (query.getAgentId() != null) {</span>
<span class="nc" id="L240">      and(EventIndexSchema.AGENT_ID, query.getAgentId());</span>
    }

    // Technical start date period
<span class="nc bnc" id="L244" title="All 4 branches missed.">    if (query.getTechnicalStartFrom() != null &amp;&amp; query.getTechnicalStartTo() != null) {</span>
<span class="nc" id="L245">      and(EventIndexSchema.TECHNICAL_START, query.getTechnicalStartFrom(), query.getTechnicalStartTo());</span>
    }

    // Technical start date
<span class="nc bnc" id="L249" title="All 2 branches missed.">    if (query.getTechnicalStartTime() != null) {</span>
<span class="nc" id="L250">      and(EventIndexSchema.TECHNICAL_START, query.getTechnicalStartTime());</span>
    }

    // Technical end date
<span class="nc bnc" id="L254" title="All 2 branches missed.">    if (query.getTechnicalEndTime() != null) {</span>
<span class="nc" id="L255">      and(EventIndexSchema.TECHNICAL_END, query.getTechnicalEndTime());</span>
    }

    // Technical presenters
<span class="nc bnc" id="L259" title="All 2 branches missed.">    if (query.getTechnicalPresenters().length &gt; 0) {</span>
<span class="nc" id="L260">      and(EventIndexSchema.TECHNICAL_PRESENTERS, query.getTechnicalPresenters());</span>
    }

    // Text
<span class="nc bnc" id="L264" title="All 2 branches missed.">    if (query.getTerms() != null) {</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">      for (SearchTerms&lt;String&gt; terms : query.getTerms()) {</span>
<span class="nc" id="L266">        StringBuilder queryText = new StringBuilder();</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">        for (String term : terms.getTerms()) {</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">          if (queryText.length() &gt; 0) {</span>
<span class="nc" id="L269">            queryText.append(&quot; &quot;);</span>
          }
<span class="nc" id="L271">          queryText.append(term);</span>
<span class="nc" id="L272">        }</span>

<span class="nc" id="L274">        additionalMultiQueryFields.add(EventIndexSchema.UID);</span>
<span class="nc" id="L275">        additionalMultiQueryFields.add(EventIndexSchema.SERIES_ID);</span>

<span class="nc" id="L277">        fuzzy = query.isFuzzySearch();</span>

<span class="nc" id="L279">        this.text = queryText.toString();</span>

<span class="nc bnc" id="L281" title="All 2 branches missed.">        if (Quantifier.All.equals(terms.getQuantifier())) {</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">          if (groups == null) {</span>
<span class="nc" id="L283">            groups = new ArrayList&lt;&gt;();</span>
          }
<span class="nc bnc" id="L285" title="All 2 branches missed.">          if (query.isFuzzySearch()) {</span>
<span class="nc" id="L286">            logger.warn(&quot;All quantifier not supported in conjunction with wildcard text&quot;);</span>
          }
<span class="nc" id="L288">          groups.add(new ValueGroup(IndexSchema.TEXT, (Object[]) terms.getTerms().toArray(new String[terms.size()])));</span>
        }
<span class="nc" id="L290">      }</span>
    }

    // Filter query
<span class="nc bnc" id="L294" title="All 2 branches missed.">    if (query.getFilter() != null) {</span>
<span class="nc" id="L295">      this.filter = query.getFilter();</span>
    }

<span class="nc" id="L298">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>