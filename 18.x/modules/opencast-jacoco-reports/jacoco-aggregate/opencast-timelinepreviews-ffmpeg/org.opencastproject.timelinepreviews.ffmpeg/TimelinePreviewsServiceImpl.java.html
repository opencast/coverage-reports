<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>TimelinePreviewsServiceImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-timelinepreviews-ffmpeg</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.timelinepreviews.ffmpeg</a> &gt; <span class="el_source">TimelinePreviewsServiceImpl.java</span></div><h1>TimelinePreviewsServiceImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.timelinepreviews.ffmpeg;

import org.opencastproject.job.api.AbstractJobProducer;
import org.opencastproject.job.api.Job;
import org.opencastproject.mediapackage.Attachment;
import org.opencastproject.mediapackage.MediaPackageElement;
import org.opencastproject.mediapackage.MediaPackageElementBuilder;
import org.opencastproject.mediapackage.MediaPackageElementBuilderFactory;
import org.opencastproject.mediapackage.MediaPackageElementParser;
import org.opencastproject.mediapackage.MediaPackageException;
import org.opencastproject.mediapackage.Track;
import org.opencastproject.mediapackage.identifier.IdImpl;
import org.opencastproject.security.api.OrganizationDirectoryService;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.UserDirectoryService;
import org.opencastproject.serviceregistry.api.ServiceRegistry;
import org.opencastproject.serviceregistry.api.ServiceRegistryException;
import org.opencastproject.timelinepreviews.api.TimelinePreviewsException;
import org.opencastproject.timelinepreviews.api.TimelinePreviewsService;
import org.opencastproject.util.IoSupport;
import org.opencastproject.util.LoadUtil;
import org.opencastproject.util.MimeTypes;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.UnknownFileTypeException;
import org.opencastproject.workspace.api.Workspace;

import org.apache.commons.io.FileUtils;
import org.apache.commons.io.FilenameUtils;
import org.apache.commons.lang3.StringUtils;
import org.osgi.service.cm.ConfigurationException;
import org.osgi.service.cm.ManagedService;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.URI;
import java.util.Arrays;
import java.util.Dictionary;
import java.util.List;
import java.util.UUID;

/**
 * Media analysis plugin that takes a video stream and generates preview images that can be shown on the timeline.
 * This will be done using FFmpeg.
 */
@Component(
    immediate = true,
    service = { TimelinePreviewsService.class,ManagedService.class },
    property = {
        &quot;service.description=TimelinePreviews Service&quot;
    }
)
public class TimelinePreviewsServiceImpl extends AbstractJobProducer implements
    TimelinePreviewsService, ManagedService {

  /** Resulting collection in the working file repository */
  public static final String COLLECTION_ID = &quot;timelinepreviews&quot;;

  /** List of available operations on jobs */
<span class="fc" id="L89">  protected enum Operation {</span>
<span class="fc" id="L90">    TimelinePreview</span>
  };

  /** Path to the executable */
<span class="fc" id="L94">  protected String binary = FFMPEG_BINARY_DEFAULT;</span>

  /** The key to look for in the service configuration file to override the DEFAULT_FFMPEG_BINARY */
  public static final String FFMPEG_BINARY_CONFIG = &quot;org.opencastproject.composer.ffmpeg.path&quot;;

  /** The default path to the FFmpeg binary */
  public static final String FFMPEG_BINARY_DEFAULT = &quot;ffmpeg&quot;;

  /** Name of the constant used to retrieve the horizontal resolution */
  public static final String OPT_RESOLUTION_X = &quot;resolutionX&quot;;

  /** Default value for the horizontal resolution */
  public static final int DEFAULT_RESOLUTION_X = 160;

  /** Name of the constant used to retrieve the vertical resolution */
  public static final String OPT_RESOLUTION_Y = &quot;resolutionY&quot;;

  /** Default value for the vertical resolution */
  public static final int DEFAULT_RESOLUTION_Y = -1;

  /** Name of the constant used to retrieve the output file format */
  public static final String OPT_OUTPUT_FORMAT = &quot;outputFormat&quot;;

  /** Default value for the format of the output image file */
  public static final String DEFAULT_OUTPUT_FORMAT = &quot;.png&quot;;

  /** Name of the constant used to retrieve the mimetype */
  public static final String OPT_MIMETYPE = &quot;mimetype&quot;;

  /** Default value for the mimetype of the generated image */
  public static final String DEFAULT_MIMETYPE = &quot;image/png&quot;;


  /** The default job load of a timeline previews job */
  public static final float DEFAULT_TIMELINEPREVIEWS_JOB_LOAD = 0.1f;

  /** The key to look for in the service configuration file to override the DEFAULT_TIMELINEPREVIEWS_JOB_LOAD */
  public static final String TIMELINEPREVIEWS_JOB_LOAD_KEY = &quot;job.load.timelinepreviews&quot;;

  /** The load introduced on the system by creating a caption job */
<span class="fc" id="L134">  private float timelinepreviewsJobLoad = DEFAULT_TIMELINEPREVIEWS_JOB_LOAD;</span>

  /** The logging facility */
<span class="fc" id="L137">  protected static final Logger logger = LoggerFactory</span>
<span class="fc" id="L138">      .getLogger(TimelinePreviewsServiceImpl.class);</span>

  /** The horizontal resolution of a single preview image */
<span class="fc" id="L141">  protected int resolutionX = DEFAULT_RESOLUTION_X;</span>

  /** The vertical resolution of a single preview image */
<span class="fc" id="L144">  protected int resolutionY = DEFAULT_RESOLUTION_Y;</span>

  /** The file format of the generated preview images file */
<span class="fc" id="L147">  protected String outputFormat = DEFAULT_OUTPUT_FORMAT;</span>

  /** The mimetype that will be set for the generated Attachment containing the timeline previews image */
<span class="fc" id="L150">  protected String mimetype = DEFAULT_MIMETYPE;</span>


  /** Reference to the receipt service */
<span class="fc" id="L154">  protected ServiceRegistry serviceRegistry = null;</span>

  /** The workspace to use when retrieving remote media files */
<span class="fc" id="L157">  protected Workspace workspace = null;</span>

  /** The security service */
<span class="fc" id="L160">  protected SecurityService securityService = null;</span>

  /** The user directory service */
<span class="fc" id="L163">  protected UserDirectoryService userDirectoryService = null;</span>

  /** The organization directory service */
<span class="fc" id="L166">  protected OrganizationDirectoryService organizationDirectoryService = null;</span>

  /**
   * Creates a new instance of the timeline previews service.
   */
  public TimelinePreviewsServiceImpl() {
<span class="fc" id="L172">    super(JOB_TYPE);</span>
<span class="fc" id="L173">    this.binary = FFMPEG_BINARY_DEFAULT;</span>
<span class="fc" id="L174">  }</span>

  @Override
  public void activate(ComponentContext cc) {
<span class="nc" id="L178">    super.activate(cc);</span>
<span class="nc" id="L179">    logger.info(&quot;Activate ffmpeg timeline previews service&quot;);</span>
<span class="nc" id="L180">    final String path = cc.getBundleContext().getProperty(FFMPEG_BINARY_CONFIG);</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">    this.binary = path == null ? FFMPEG_BINARY_DEFAULT : path;</span>
<span class="nc" id="L182">    logger.debug(&quot;Configuration {}: {}&quot;, FFMPEG_BINARY_CONFIG, FFMPEG_BINARY_DEFAULT);</span>
<span class="nc" id="L183">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.osgi.service.cm.ManagedService#updated(java.util.Dictionary)
   */
  @Override
  public void updated(Dictionary&lt;String, ?&gt; properties) throws ConfigurationException {
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">    if (properties == null) {</span>
<span class="nc" id="L193">      return;</span>
    }
<span class="fc" id="L195">    logger.debug(&quot;Configuring the timeline previews service&quot;);</span>

    // Horizontal resolution
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">    if (properties.get(OPT_RESOLUTION_X) != null) {</span>
<span class="fc" id="L199">      String res = (String) properties.get(OPT_RESOLUTION_X);</span>
      try {
<span class="fc" id="L201">        resolutionX = Integer.parseInt(res);</span>
<span class="fc" id="L202">        logger.info(&quot;Horizontal resolution set to {} pixels&quot;, resolutionX);</span>
<span class="nc" id="L203">      } catch (Exception e) {</span>
<span class="nc" id="L204">        throw new ConfigurationException(OPT_RESOLUTION_X, &quot;Found illegal value '&quot; + res</span>
                + &quot;' for timeline previews horizontal resolution&quot;);
<span class="fc" id="L206">      }</span>
    }
    // Vertical resolution
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">    if (properties.get(OPT_RESOLUTION_Y) != null) {</span>
<span class="fc" id="L210">      String res = (String) properties.get(OPT_RESOLUTION_Y);</span>
      try {
<span class="fc" id="L212">        resolutionY = Integer.parseInt(res);</span>
<span class="fc" id="L213">        logger.info(&quot;Vertical resolution set to {} pixels&quot;, resolutionY);</span>
<span class="nc" id="L214">      } catch (Exception e) {</span>
<span class="nc" id="L215">        throw new ConfigurationException(OPT_RESOLUTION_Y, &quot;Found illegal value '&quot; + res</span>
                + &quot;' for timeline previews vertical resolution&quot;);
<span class="fc" id="L217">      }</span>
    }
    // Output file format
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">    if (properties.get(OPT_OUTPUT_FORMAT) != null) {</span>
<span class="fc" id="L221">      String format = (String) properties.get(OPT_OUTPUT_FORMAT);</span>
      try {
<span class="fc" id="L223">        outputFormat = format;</span>
<span class="fc" id="L224">        logger.info(&quot;Output file format set to \&quot;{}\&quot;&quot;, outputFormat);</span>
<span class="nc" id="L225">      } catch (Exception e) {</span>
<span class="nc" id="L226">        throw new ConfigurationException(OPT_OUTPUT_FORMAT, &quot;Found illegal value '&quot; + format</span>
                + &quot;' for timeline previews output file format&quot;);
<span class="fc" id="L228">      }</span>
    }
    // Output mimetype
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">    if (properties.get(OPT_MIMETYPE) != null) {</span>
<span class="fc" id="L232">      String type = (String) properties.get(OPT_MIMETYPE);</span>
      try {
<span class="fc" id="L234">        mimetype = type;</span>
<span class="fc" id="L235">        logger.info(&quot;Mime type set to \&quot;{}\&quot;&quot;, mimetype);</span>
<span class="nc" id="L236">      } catch (Exception e) {</span>
<span class="nc" id="L237">        throw new ConfigurationException(OPT_MIMETYPE, &quot;Found illegal value '&quot; + type</span>
                + &quot;' for timeline previews mimetype&quot;);
<span class="fc" id="L239">      }</span>
    }

<span class="fc" id="L242">    timelinepreviewsJobLoad = LoadUtil.getConfiguredLoadValue(properties, TIMELINEPREVIEWS_JOB_LOAD_KEY,</span>
<span class="fc" id="L243">            DEFAULT_TIMELINEPREVIEWS_JOB_LOAD, serviceRegistry);</span>
<span class="fc" id="L244">  }</span>

  @Override
  public Job createTimelinePreviewImages(Track track, int imageCount) throws TimelinePreviewsException,
          MediaPackageException {
    try {
<span class="fc" id="L250">      List&lt;String&gt; parameters = Arrays.asList(MediaPackageElementParser.getAsXml(track), Integer.toString(imageCount));</span>

<span class="fc" id="L252">      return serviceRegistry.createJob(JOB_TYPE,</span>
<span class="fc" id="L253">          Operation.TimelinePreview.toString(),</span>
          parameters,
<span class="fc" id="L255">          timelinepreviewsJobLoad);</span>
<span class="nc" id="L256">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L257">      throw new TimelinePreviewsException(&quot;Unable to create timelinepreviews job&quot;, e);</span>
    }
  }

  /**
   * Starts generation of timeline preview images for the given video track
   * and returns an attachment containing one image that contains all the
   * timeline preview images.
   *
   * @param job
   * @param track the element to analyze
   * @param imageCount number of preview images that will be generated
   * @return an attachment containing the resulting timeline previews image
   * @throws TimelinePreviewsException
   * @throws org.opencastproject.mediapackage.MediaPackageException
   */
  protected Attachment generatePreviewImages(Job job, Track track, int imageCount)
          throws TimelinePreviewsException, MediaPackageException {

    // Make sure the element can be analyzed using this analysis implementation
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">    if (!track.hasVideo()) {</span>
<span class="nc" id="L278">      logger.error(&quot;Element {} is not a video track&quot;, track.getIdentifier());</span>
<span class="nc" id="L279">      throw new TimelinePreviewsException(&quot;Element is not a video track&quot;);</span>
    }

    try {

<span class="pc bpc" id="L284" title="1 of 2 branches missed.">      if (track.getDuration() == null) {</span>
<span class="nc" id="L285">        throw new MediaPackageException(&quot;Track &quot; + track + &quot; does not have a duration&quot;);</span>
      }

<span class="fc" id="L288">      double duration = track.getDuration() / 1000.0;</span>
<span class="fc" id="L289">      double seconds = duration / (double)(imageCount);</span>
<span class="pc bpc" id="L290" title="1 of 2 branches missed.">      seconds = seconds &lt;= 0.0 ? 1.0 : seconds;</span>

      // calculate number of tiles for row and column in tiled image
<span class="fc" id="L293">      int imageSize = (int) Math.ceil(Math.sqrt(imageCount));</span>

<span class="fc" id="L295">      Attachment composedImage = createPreviewsFFmpeg(track, seconds, resolutionX, resolutionY, imageSize, imageSize,</span>
              duration);


<span class="pc bpc" id="L299" title="1 of 2 branches missed.">      if (composedImage == null) {</span>
<span class="nc" id="L300">        throw new IllegalStateException(&quot;Unable to compose image&quot;);</span>
      }

      // Set the mimetype
      try {
<span class="fc" id="L305">        composedImage.setMimeType(MimeTypes.parseMimeType(mimetype));</span>
<span class="nc" id="L306">      } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L307">        logger.warn(&quot;Invalid mimetype provided for timeline previews image&quot;);</span>
        try  {
<span class="nc" id="L309">          composedImage.setMimeType(MimeTypes.fromURI(composedImage.getURI()));</span>
<span class="nc" id="L310">        } catch (UnknownFileTypeException ex) {</span>
<span class="nc" id="L311">          logger.warn(&quot;No valid mimetype could be found for timeline previews image&quot;);</span>
<span class="nc" id="L312">        }</span>
<span class="fc" id="L313">      }</span>

<span class="fc" id="L315">      composedImage.getProperties().put(&quot;imageCount&quot;, String.valueOf(imageCount));</span>

<span class="fc" id="L317">      return composedImage;</span>

<span class="nc" id="L319">    } catch (Exception e) {</span>
<span class="nc" id="L320">      logger.warn(&quot;Error creating timeline preview images for &quot; + track, e);</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">      if (e instanceof TimelinePreviewsException) {</span>
<span class="nc" id="L322">        throw (TimelinePreviewsException) e;</span>
      } else {
<span class="nc" id="L324">        throw new TimelinePreviewsException(e);</span>
      }
    }
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.job.api.AbstractJobProducer#process(org.opencastproject.job.api.Job)
   */
  @Override
  protected String process(Job job) throws Exception {
<span class="fc" id="L336">    Operation op = null;</span>
<span class="fc" id="L337">    String operation = job.getOperation();</span>
<span class="fc" id="L338">    List&lt;String&gt; arguments = job.getArguments();</span>
    try {
<span class="fc" id="L340">      op = Operation.valueOf(operation);</span>
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">      switch (op) {</span>
        case TimelinePreview:
<span class="fc" id="L343">          Track track = (Track) MediaPackageElementParser</span>
<span class="fc" id="L344">              .getFromXml(arguments.get(0));</span>
<span class="fc" id="L345">          int imageCount = Integer.parseInt(arguments.get(1));</span>
<span class="fc" id="L346">          Attachment timelinePreviewsMpe = generatePreviewImages(job, track, imageCount);</span>
<span class="fc" id="L347">          return MediaPackageElementParser.getAsXml(timelinePreviewsMpe);</span>
        default:
<span class="nc" id="L349">          throw new IllegalStateException(&quot;Don't know how to handle operation '&quot; + operation + &quot;'&quot;);</span>
      }
<span class="nc" id="L351">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L352">      throw new ServiceRegistryException(&quot;This service can't handle operations of type '&quot; + op + &quot;'&quot;, e);</span>
<span class="nc" id="L353">    } catch (IndexOutOfBoundsException e) {</span>
<span class="nc" id="L354">      throw new ServiceRegistryException(&quot;This argument list for operation '&quot; + op + &quot;' does not meet expectations&quot;, e);</span>
<span class="nc" id="L355">    } catch (Exception e) {</span>
<span class="nc" id="L356">      throw new ServiceRegistryException(&quot;Error handling operation '&quot; + op + &quot;'&quot;, e);</span>
    }
  }

  /**
   * Executes the FFmpeg command to generate a timeline previews image
   *
   * @param track the track to generate the timeline previews image for
   * @param seconds the length of a segment that one preview image should represent
   * @param width the width of a single preview image
   * @param height the height of a single preview image
   * @param tileX the horizontal number of preview images that are stored in the timeline previews image
   * @param tileY the vertical number of preview images that are stored in the timeline previews image
   * @param duration the duration for which preview images should be generated
   * @return an attachment containing the timeline previews image
   * @throws TimelinePreviewsException
   */
  protected Attachment createPreviewsFFmpeg(Track track, double seconds, int width, int height, int tileX, int tileY,
          double duration) throws TimelinePreviewsException {

    // copy source file into workspace
    File mediaFile;
    try {
<span class="fc" id="L379">      mediaFile = workspace.get(track.getURI());</span>
<span class="nc" id="L380">    } catch (NotFoundException e) {</span>
<span class="nc" id="L381">      throw new TimelinePreviewsException(</span>
          &quot;Error finding the media file in the workspace&quot;, e);
<span class="nc" id="L383">    } catch (IOException e) {</span>
<span class="nc" id="L384">      throw new TimelinePreviewsException(</span>
          &quot;Error reading the media file in the workspace&quot;, e);
<span class="fc" id="L386">    }</span>

<span class="fc" id="L388">    String imageFilePath = FilenameUtils.removeExtension(mediaFile.getAbsolutePath()) + '_' + UUID.randomUUID()</span>
                           + &quot;_timelinepreviews&quot; + outputFormat;
<span class="fc" id="L390">    int exitCode = 1;</span>
<span class="fc" id="L391">    String[] command = new String[] {</span>
        binary,
        &quot;-loglevel&quot;, &quot;error&quot;,
<span class="fc" id="L394">        &quot;-t&quot;, String.valueOf(duration - seconds / 2.0),</span>
        // For longer videos, this operation only considers keyframes. This
        // significantly speeds up this command. The difference in output is
        // minimal and not relevant for the user. Nothing would crash without
        // this duration check: short videos would just repeat keyframes in the
        // output image, making the preview less useful.
<span class="pc bpc" id="L400" title="1 of 2 branches missed.">        &quot;-skip_frame&quot;, duration &gt; 15 * 60.0 ? &quot;nokey&quot; : &quot;default&quot;,</span>
<span class="fc" id="L401">        &quot;-i&quot;, mediaFile.getAbsolutePath(),</span>
        &quot;-vf&quot;, &quot;fps=1/&quot; + seconds + &quot;,scale=&quot; + width + &quot;:&quot; + height + &quot;,tile=&quot; + tileX + &quot;x&quot; + tileY,
        imageFilePath
    };

<span class="fc" id="L406">    logger.debug(&quot;Start timeline previews ffmpeg process: {}&quot;, StringUtils.join(command, &quot; &quot;));</span>
<span class="fc" id="L407">    logger.info(&quot;Create timeline preview images file for track '{}' at {}&quot;, track.getIdentifier(), imageFilePath);</span>

<span class="fc" id="L409">    ProcessBuilder pbuilder = new ProcessBuilder(command);</span>

<span class="fc" id="L411">    pbuilder.redirectErrorStream(true);</span>
<span class="fc" id="L412">    Process ffmpegProcess = null;</span>
<span class="fc" id="L413">    exitCode = 1;</span>
<span class="fc" id="L414">    BufferedReader errStream = null;</span>
    try {
<span class="fc" id="L416">      ffmpegProcess = pbuilder.start();</span>

<span class="fc" id="L418">      errStream = new BufferedReader(new InputStreamReader(ffmpegProcess.getInputStream()));</span>
<span class="fc" id="L419">      String line = errStream.readLine();</span>
<span class="pc bpc" id="L420" title="1 of 2 branches missed.">      while (line != null) {</span>
<span class="nc" id="L421">        logger.error(&quot;FFmpeg error: &quot; + line);</span>
<span class="nc" id="L422">        line = errStream.readLine();</span>
      }
<span class="fc" id="L424">      exitCode = ffmpegProcess.waitFor();</span>
<span class="nc" id="L425">    } catch (IOException ex) {</span>
<span class="nc" id="L426">      throw new TimelinePreviewsException(&quot;Starting ffmpeg process failed&quot;, ex);</span>
<span class="nc" id="L427">    } catch (InterruptedException ex) {</span>
<span class="nc" id="L428">      throw new TimelinePreviewsException(&quot;Timeline preview creation was unexpectedly interrupted&quot;, ex);</span>
    } finally {
<span class="fc" id="L430">      IoSupport.closeQuietly(ffmpegProcess);</span>
<span class="fc" id="L431">      IoSupport.closeQuietly(errStream);</span>
<span class="pc bpc" id="L432" title="1 of 2 branches missed.">      if (exitCode != 0) {</span>
        try {
<span class="nc" id="L434">          FileUtils.forceDelete(new File(imageFilePath));</span>
<span class="nc" id="L435">        } catch (IOException e) {</span>
          // it is ok, no output file was generated by ffmpeg
<span class="nc" id="L437">        }</span>
      }
    }

<span class="pc bpc" id="L441" title="1 of 2 branches missed.">    if (exitCode != 0) {</span>
<span class="nc" id="L442">      throw new TimelinePreviewsException(&quot;Generating timeline preview for track &quot; + track.getIdentifier()</span>
              + &quot; failed: ffmpeg process exited abnormally with exit code &quot; + exitCode);
    }

    // put timeline previews image into workspace
<span class="fc" id="L447">    FileInputStream timelinepreviewsFileInputStream = null;</span>
<span class="fc" id="L448">    URI previewsFileUri = null;</span>
    try {
<span class="fc" id="L450">      timelinepreviewsFileInputStream = new FileInputStream(imageFilePath);</span>
<span class="fc" id="L451">      previewsFileUri = workspace.putInCollection(COLLECTION_ID,</span>
<span class="fc" id="L452">              FilenameUtils.getName(imageFilePath), timelinepreviewsFileInputStream);</span>
<span class="fc" id="L453">      logger.info(&quot;Copied the created timeline preview images file to the workspace {}&quot;, previewsFileUri.toString());</span>
<span class="nc" id="L454">    } catch (FileNotFoundException ex) {</span>
<span class="nc" id="L455">      throw new TimelinePreviewsException(</span>
<span class="nc" id="L456">              String.format(&quot;Timeline previews image file '%s' not found&quot;, imageFilePath), ex);</span>
<span class="nc" id="L457">    } catch (IOException ex) {</span>
<span class="nc" id="L458">      throw new TimelinePreviewsException(</span>
<span class="nc" id="L459">              String.format(&quot;Can't write timeline preview images file '%s' to workspace&quot;, imageFilePath), ex);</span>
<span class="nc" id="L460">    } catch (IllegalArgumentException ex) {</span>
<span class="nc" id="L461">      throw new TimelinePreviewsException(ex);</span>
    } finally {
<span class="fc" id="L463">      IoSupport.closeQuietly(timelinepreviewsFileInputStream);</span>
<span class="fc" id="L464">      logger.info(&quot;Deleted local timeline preview images file at {}&quot;, imageFilePath);</span>
<span class="fc" id="L465">      FileUtils.deleteQuietly(new File(imageFilePath));</span>
    }

    // create media package element
<span class="fc" id="L469">    MediaPackageElementBuilder mpElementBuilder = MediaPackageElementBuilderFactory.newInstance().newElementBuilder();</span>
    // it is up to the workflow operation handler to set the attachment flavor
<span class="fc" id="L471">    Attachment timelinepreviewsMpe = (Attachment) mpElementBuilder.elementFromURI(</span>
<span class="fc" id="L472">            previewsFileUri, MediaPackageElement.Type.Attachment, track.getFlavor());</span>

    // add reference to track
<span class="fc" id="L475">    timelinepreviewsMpe.referTo(track);</span>

    // add additional properties to attachment
<span class="fc" id="L478">    timelinepreviewsMpe.getProperties().put(&quot;imageSizeX&quot;, String.valueOf(tileX));</span>
<span class="fc" id="L479">    timelinepreviewsMpe.getProperties().put(&quot;imageSizeY&quot;, String.valueOf(tileY));</span>
<span class="fc" id="L480">    timelinepreviewsMpe.getProperties().put(&quot;resolutionX&quot;, String.valueOf(resolutionX));</span>
<span class="fc" id="L481">    timelinepreviewsMpe.getProperties().put(&quot;resolutionY&quot;, String.valueOf(resolutionY));</span>

    // set the flavor and an ID
<span class="fc" id="L484">    timelinepreviewsMpe.setFlavor(track.getFlavor());</span>
<span class="fc" id="L485">    timelinepreviewsMpe.setIdentifier(IdImpl.fromUUID().toString());</span>

<span class="fc" id="L487">    return timelinepreviewsMpe;</span>
  }

  /**
   * Sets the workspace
   *
   * @param workspace
   *            an instance of the workspace
   */
  @Reference
  protected void setWorkspace(Workspace workspace) {
<span class="fc" id="L498">    this.workspace = workspace;</span>
<span class="fc" id="L499">  }</span>

  /**
   * Sets the receipt service
   *
   * @param serviceRegistry
   *            the service registry
   */
  @Reference
  protected void setServiceRegistry(ServiceRegistry serviceRegistry) {
<span class="fc" id="L509">    this.serviceRegistry = serviceRegistry;</span>
<span class="fc" id="L510">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.job.api.AbstractJobProducer#getServiceRegistry()
   */
  @Override
  protected ServiceRegistry getServiceRegistry() {
<span class="nc" id="L519">    return serviceRegistry;</span>
  }

  /**
   * Callback for setting the security service.
   *
   * @param securityService
   *            the securityService to set
   */
  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="nc" id="L530">    this.securityService = securityService;</span>
<span class="nc" id="L531">  }</span>

  /**
   * Callback for setting the user directory service.
   *
   * @param userDirectoryService
   *            the userDirectoryService to set
   */
  @Reference
  public void setUserDirectoryService(
      UserDirectoryService userDirectoryService) {
<span class="nc" id="L542">    this.userDirectoryService = userDirectoryService;</span>
<span class="nc" id="L543">  }</span>

  /**
   * Sets a reference to the organization directory service.
   *
   * @param organizationDirectory
   *            the organization directory
   */
  @Reference
  public void setOrganizationDirectoryService(
      OrganizationDirectoryService organizationDirectory) {
<span class="nc" id="L554">    this.organizationDirectoryService = organizationDirectory;</span>
<span class="nc" id="L555">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.job.api.AbstractJobProducer#getSecurityService()
   */
  @Override
  protected SecurityService getSecurityService() {
<span class="nc" id="L564">    return securityService;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.job.api.AbstractJobProducer#getUserDirectoryService()
   */
  @Override
  protected UserDirectoryService getUserDirectoryService() {
<span class="nc" id="L574">    return userDirectoryService;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.job.api.AbstractJobProducer#getOrganizationDirectoryService()
   */
  @Override
  protected OrganizationDirectoryService getOrganizationDirectoryService() {
<span class="nc" id="L584">    return organizationDirectoryService;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>