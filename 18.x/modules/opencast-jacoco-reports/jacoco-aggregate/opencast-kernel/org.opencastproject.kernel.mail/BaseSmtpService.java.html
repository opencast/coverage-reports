<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>BaseSmtpService.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-kernel</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.kernel.mail</a> &gt; <span class="el_source">BaseSmtpService.java</span></div><h1>BaseSmtpService.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.kernel.mail;

import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Date;
import java.util.Properties;

import javax.mail.MessagingException;
import javax.mail.Session;
import javax.mail.Transport;
import javax.mail.internet.MimeMessage;

/**
 * Base implementation that allows to send e-mails using &lt;code&gt;javax.mail&lt;/code&gt;.
 */
<span class="nc" id="L39">public class BaseSmtpService {</span>

  /** The logging facility */
<span class="fc" id="L42">  private static final Logger logger = LoggerFactory.getLogger(BaseSmtpService.class);</span>

  /** The mode */
<span class="nc" id="L45">  protected enum Mode {</span>
<span class="nc" id="L46">    production, test</span>
  };

  /** Parameter prefix common to all &quot;mail&quot; properties */
  protected static final String OPT_MAIL_PREFIX = &quot;mail.&quot;;

  /** Parameter name for the transport protocol */
  protected static final String OPT_MAIL_TRANSPORT = &quot;mail.transport.protocol&quot;;

  /** Parameter suffix for the mail host */
  protected static final String OPT_MAIL_HOST_SUFFIX = &quot;.host&quot;;

  /** Parameter suffix for the mail port */
  protected static final String OPT_MAIL_PORT_SUFFIX = &quot;.port&quot;;

  /** Parameter suffix for the start tls status */
  protected static final String OPT_MAIL_TLS_ENABLE_SUFFIX = &quot;.starttls.enable&quot;;

  /** Parameter suffix for the authentication setting */
  protected static final String OPT_MAIL_AUTH_SUFFIX = &quot;.auth&quot;;

  /** Parameter name for the username */
  protected static final String OPT_MAIL_USER = &quot;mail.user&quot;;

  /** Parameter name for the password */
  protected static final String OPT_MAIL_PASSWORD = &quot;mail.password&quot;;

  /** Parameter name for the recipient */
  protected static final String OPT_MAIL_FROM = &quot;mail.from&quot;;

  /** Parameter name for the debugging setting */
  protected static final String OPT_MAIL_DEBUG = &quot;mail.debug&quot;;

  /** Default value for the transport protocol */
  private static final String DEFAULT_MAIL_TRANSPORT = &quot;smtp&quot;;

  /** Default value for the mail port */
  private static final int DEFAULT_MAIL_PORT = 25;

  /** The current mail transport protocol */
<span class="nc" id="L86">  protected String mailTransport = DEFAULT_MAIL_TRANSPORT;</span>

  /** Flag indicating whether the service is actually sending messages */
<span class="nc" id="L89">  private boolean productionMode = true;</span>

  /** The mail host */
<span class="nc" id="L92">  private String host = null;</span>

  /** The mail port */
<span class="nc" id="L95">  private int port = DEFAULT_MAIL_PORT;</span>

  /** The mail user */
<span class="nc" id="L98">  private String user = null;</span>

  /** The mail password */
<span class="nc" id="L101">  private String password = null;</span>

  /** Whether debug is enabled */
<span class="nc" id="L104">  private boolean debug = false;</span>

  /** Whether SSL/TLS is enabled */
<span class="nc" id="L107">  private boolean ssl = false;</span>

  /** The optional sender */
<span class="nc" id="L110">  private String sender = null;</span>

  /** The mail properties */
<span class="nc" id="L113">  private Properties mailProperties = new Properties();</span>

  /** The default mail session */
<span class="nc" id="L116">  private Session defaultMailSession = null;</span>

  public void setProductionMode(boolean mode) {
<span class="nc" id="L119">    this.productionMode = mode;</span>
<span class="nc" id="L120">  }</span>

  public boolean isProductionMode() {
<span class="nc" id="L123">    return productionMode;</span>
  }

  public void setHost(String host) {
<span class="nc" id="L127">    this.host = host;</span>
<span class="nc" id="L128">  }</span>

  public void setMailTransport(String mailTransport) {
<span class="nc" id="L131">    this.mailTransport = mailTransport;</span>
<span class="nc" id="L132">  }</span>

  public void setPort(Integer port) {
<span class="nc" id="L135">    this.port = port;</span>
<span class="nc" id="L136">  }</span>

  public void setUser(String user) {
<span class="nc" id="L139">    this.user = user;</span>
<span class="nc" id="L140">  }</span>

  public void setPassword(String password) {
<span class="nc" id="L143">    this.password = password;</span>
<span class="nc" id="L144">  }</span>

  public void setDebug(boolean debug) {
<span class="nc" id="L147">    this.debug = debug;</span>
<span class="nc" id="L148">  }</span>

  public void setSender(String sender) {
<span class="nc" id="L151">    this.sender = sender;</span>
<span class="nc" id="L152">  }</span>

  public String getSender() {
<span class="nc" id="L155">    return this.sender;</span>
  }

  public void setSsl(boolean ssl) {
<span class="nc" id="L159">    this.ssl = ssl;</span>
<span class="nc" id="L160">  }</span>

  public void configure() {
<span class="nc" id="L163">    mailProperties.clear();</span>
<span class="nc" id="L164">    defaultMailSession = null;</span>

<span class="nc bnc" id="L166" title="All 4 branches missed.">    if (!(&quot;smtp&quot;.equals(mailTransport) || &quot;smtps&quot;.equals(mailTransport))) {</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">      if (mailTransport != null)</span>
<span class="nc" id="L168">        logger.warn(&quot;'{}' procotol not supported. Reverting to default: '{}'&quot;, mailTransport, DEFAULT_MAIL_TRANSPORT);</span>
<span class="nc" id="L169">      logger.debug(&quot;Mail transport protocol defaults to '{}'&quot;, DEFAULT_MAIL_TRANSPORT);</span>
<span class="nc" id="L170">      mailProperties.put(OPT_MAIL_TRANSPORT, DEFAULT_MAIL_TRANSPORT);</span>
    } else {
<span class="nc" id="L172">      logger.debug(&quot;Mail transport protocol is '{}'&quot;, mailTransport);</span>
<span class="nc" id="L173">      mailProperties.put(OPT_MAIL_TRANSPORT, mailTransport);</span>
    }

<span class="nc" id="L176">    mailProperties.put(OPT_MAIL_PREFIX + mailTransport + OPT_MAIL_HOST_SUFFIX, host);</span>
<span class="nc" id="L177">    logger.debug(&quot;Mail host is {}&quot;, host);</span>

<span class="nc" id="L179">    mailProperties.put(OPT_MAIL_PREFIX + mailTransport + OPT_MAIL_PORT_SUFFIX, port);</span>
<span class="nc" id="L180">    logger.debug(&quot;Mail server port is '{}'&quot;, port);</span>

    // User and Authentication
<span class="nc" id="L183">    String propName = OPT_MAIL_PREFIX + mailTransport + OPT_MAIL_AUTH_SUFFIX;</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">    if (StringUtils.isNotBlank(user)) {</span>
<span class="nc" id="L185">      mailProperties.put(OPT_MAIL_USER, user);</span>
<span class="nc" id="L186">      mailProperties.put(propName, Boolean.toString(true));</span>
<span class="nc" id="L187">      logger.debug(&quot;Mail user is '{}'&quot;, user);</span>
    } else {
<span class="nc" id="L189">      mailProperties.put(propName, Boolean.toString(false));</span>
<span class="nc" id="L190">      logger.debug(&quot;Sending mails to {} without authentication&quot;, host);</span>
    }

<span class="nc bnc" id="L193" title="All 2 branches missed.">    if (StringUtils.isNotBlank(password)) {</span>
<span class="nc" id="L194">      mailProperties.put(OPT_MAIL_PASSWORD, password);</span>
<span class="nc" id="L195">      logger.debug(&quot;Mail password set&quot;);</span>
    }

<span class="nc bnc" id="L198" title="All 2 branches missed.">    if (StringUtils.isNotBlank(sender)) {</span>
<span class="nc" id="L199">      mailProperties.put(OPT_MAIL_FROM, sender);</span>
<span class="nc" id="L200">      logger.debug(&quot;Mail sender is '{}'&quot;, sender);</span>
    } else {
<span class="nc" id="L202">      logger.debug(&quot;Mail sender defaults not set&quot;);</span>
    }

<span class="nc" id="L205">    mailProperties.put(OPT_MAIL_PREFIX + mailTransport + OPT_MAIL_TLS_ENABLE_SUFFIX, ssl);</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">    if (ssl) {</span>
<span class="nc" id="L207">      logger.debug(&quot;TLS over SMTP is enabled&quot;);</span>
    } else {
<span class="nc" id="L209">      logger.debug(&quot;TLS over SMTP is disabled&quot;);</span>
    }

<span class="nc" id="L212">    mailProperties.put(OPT_MAIL_DEBUG, Boolean.toString(debug));</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">    logger.debug(&quot;Mail debugging is {}&quot;, debug ? &quot;enabled&quot; : &quot;disabled&quot;);</span>

<span class="nc" id="L215">    logger.info(&quot;Mail service configured with {}&quot;, host);</span>
<span class="nc" id="L216">    Properties props = getSession().getProperties();</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">    for (String key : props.stringPropertyNames())</span>
<span class="nc" id="L218">      logger.info(&quot;{}: {}&quot;, key, props.getProperty(key));</span>
<span class="nc" id="L219">  }</span>

  /**
   * Returns the default mail session that can be used to create a new message.
   *
   * @return the default mail session
   */
  public Session getSession() {
<span class="nc bnc" id="L227" title="All 2 branches missed.">    if (defaultMailSession == null) {</span>
<span class="nc" id="L228">      defaultMailSession = Session.getInstance(mailProperties);</span>
    }
<span class="nc" id="L230">    return defaultMailSession;</span>
  }

  /**
   * Creates a new message.
   *
   * @return the new message
   */
  public MimeMessage createMessage() {
<span class="nc" id="L239">    return new MimeMessage(getSession());</span>
  }

  /**
   * Sends &lt;code&gt;message&lt;/code&gt; using the configured transport.
   *
   * @param message
   *          the message
   * @throws MessagingException
   *           if sending the message failed
   */
  public void send(MimeMessage message) throws MessagingException {
<span class="nc" id="L251">    message.setSentDate(new Date());</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">    if (!productionMode) {</span>
<span class="nc" id="L253">      logger.debug(&quot;Skipping sending of message {} due to test mode&quot;, message);</span>
<span class="nc" id="L254">      return;</span>
    }
<span class="nc" id="L256">    Transport t = getSession().getTransport(mailTransport);</span>
<span class="nc" id="L257">    ClassLoader cl = Thread.currentThread().getContextClassLoader();</span>
    try {
<span class="nc" id="L259">      Thread.currentThread().setContextClassLoader(javax.mail.Session.class.getClassLoader());</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">      if (user != null)</span>
<span class="nc" id="L261">        t.connect(user, password);</span>
      else
<span class="nc" id="L263">        t.connect();</span>
<span class="nc" id="L264">      t.sendMessage(message, message.getAllRecipients());</span>
    } finally {
<span class="nc" id="L266">      Thread.currentThread().setContextClassLoader(cl);</span>
<span class="nc" id="L267">      t.close();</span>
    }
<span class="nc" id="L269">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>