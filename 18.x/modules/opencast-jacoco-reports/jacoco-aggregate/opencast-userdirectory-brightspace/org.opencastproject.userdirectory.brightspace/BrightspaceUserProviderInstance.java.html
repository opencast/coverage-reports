<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>BrightspaceUserProviderInstance.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-userdirectory-brightspace</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.userdirectory.brightspace</a> &gt; <span class="el_source">BrightspaceUserProviderInstance.java</span></div><h1>BrightspaceUserProviderInstance.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */


package org.opencastproject.userdirectory.brightspace;

import org.opencastproject.security.api.CachingUserProviderMXBean;
import org.opencastproject.security.api.Group;
import org.opencastproject.security.api.JaxbOrganization;
import org.opencastproject.security.api.JaxbRole;
import org.opencastproject.security.api.JaxbUser;
import org.opencastproject.security.api.Organization;
import org.opencastproject.security.api.Role;
import org.opencastproject.security.api.Role.Target;
import org.opencastproject.security.api.RoleProvider;
import org.opencastproject.security.api.User;
import org.opencastproject.security.api.UserProvider;
import org.opencastproject.userdirectory.brightspace.client.BrightspaceClient;
import org.opencastproject.userdirectory.brightspace.client.BrightspaceClientException;
import org.opencastproject.userdirectory.brightspace.client.api.BrightspaceUser;

import com.google.common.cache.CacheBuilder;
import com.google.common.cache.CacheLoader;
import com.google.common.cache.LoadingCache;
import com.google.common.util.concurrent.ExecutionError;
import com.google.common.util.concurrent.UncheckedExecutionException;

//import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.lang.management.ManagementFactory;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Set;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.AtomicLong;

import javax.management.InstanceNotFoundException;
import javax.management.MBeanServer;
import javax.management.ObjectName;

public class BrightspaceUserProviderInstance implements UserProvider, RoleProvider, CachingUserProviderMXBean {

<span class="nc" id="L66">  private static final Logger logger = LoggerFactory.getLogger(BrightspaceUserProviderInstance.class);</span>

  private static final String LTI_LEARNER_ROLE = &quot;Learner&quot;;
  private static final String LTI_INSTRUCTOR_ROLE = &quot;Instructor&quot;;

  private String pid;
  private BrightspaceClient client;
  private Organization organization;
  private LoadingCache&lt;String, Object&gt; cache;
<span class="nc" id="L75">  private Object nullToken = new Object();</span>
  private AtomicLong loadUserRequests;
  private AtomicLong brightspaceWebServiceRequests;
  private final Set&lt;String&gt; instructorRoles;
  private final Set&lt;String&gt; ignoredUsernames;

  /**
   * Constructs a Brighspace user provider with the needed settings
   *
   * @param pid             The PID of this service.
   * @param client          The Brightspace rest service client.
   * @param organization    The organisation.
   * @param cacheSize       The number of users to cache.
   * @param cacheExpiration The number of minutes to cache users.
   */
  public BrightspaceUserProviderInstance(
      String pid,
      BrightspaceClient client,
      Organization organization,
      int cacheSize,
      int cacheExpiration,
      Set instructorRoles,
      Set ignoredUsernames
<span class="nc" id="L98">  ) {</span>

<span class="nc" id="L100">    this.pid = pid;</span>
<span class="nc" id="L101">    this.client = client;</span>
<span class="nc" id="L102">    this.organization = organization;</span>
<span class="nc" id="L103">    this.instructorRoles = instructorRoles;</span>
<span class="nc" id="L104">    this.ignoredUsernames = ignoredUsernames;</span>

<span class="nc" id="L106">    logger.info(&quot;Creating new BrightspaceUserProviderInstance(pid={}, url={}, cacheSize={}, cacheExpiration={}, &quot;</span>
<span class="nc" id="L107">                  + &quot;InstructorRoles={}, ignoredUserNames={})&quot;, pid, client.getURL(), cacheSize, cacheExpiration,</span>
                  instructorRoles, ignoredUsernames);

<span class="nc" id="L110">    cache = CacheBuilder.newBuilder().maximumSize(cacheSize).expireAfterWrite(cacheExpiration, TimeUnit.MINUTES)</span>
<span class="nc" id="L111">            .build(new CacheLoader&lt;String, Object&gt;() {</span>
              @Override
              public Object load(String username) {
<span class="nc" id="L114">                User user = loadUserFromBrightspace(username);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                return user == null ? nullToken : user;</span>
              }
            });

<span class="nc" id="L119">    this.registerMBean(pid);</span>
<span class="nc" id="L120">  }</span>

  @Override
  public float getCacheHitRatio() {
<span class="nc bnc" id="L124" title="All 2 branches missed.">    if (loadUserRequests.get() == 0) {</span>
<span class="nc" id="L125">      return 0;</span>
    }
<span class="nc" id="L127">    return (float) (loadUserRequests.get() - brightspaceWebServiceRequests.get()) / loadUserRequests.get();</span>
  }

  private void registerMBean(String pid) {
<span class="nc" id="L131">    this.loadUserRequests = new AtomicLong();</span>
<span class="nc" id="L132">    this.brightspaceWebServiceRequests = new AtomicLong();</span>

    try {
<span class="nc" id="L135">      ObjectName name = BrightspaceUserProviderFactory.getObjectName(pid);</span>
<span class="nc" id="L136">      MBeanServer mbs = ManagementFactory.getPlatformMBeanServer();</span>

      try {
<span class="nc" id="L139">        mbs.unregisterMBean(name);</span>
<span class="nc" id="L140">      } catch (InstanceNotFoundException ife) {</span>
<span class="nc" id="L141">        logger.debug(&quot;{} was not registered&quot;, name);</span>
<span class="nc" id="L142">      }</span>

<span class="nc" id="L144">      mbs.registerMBean(this, name);</span>
<span class="nc" id="L145">    } catch (Exception e) {</span>
<span class="nc" id="L146">      logger.error(&quot;Unable to register {} as an mbean&quot;, this, e);</span>
<span class="nc" id="L147">    }</span>

<span class="nc" id="L149">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.security.api.UserProvider#getName()
   */
  @Override
  public String getName() {
<span class="nc" id="L158">    return pid;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.security.api.UserProvider#getUsers()
   */
  @Override
  public Iterator&lt;User&gt; getUsers() {
<span class="nc" id="L168">    return Collections.emptyIterator();</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.security.api.UserProvider#loadUser(java.lang.String)
   */
  @Override
  public User loadUser(String userName) {
<span class="nc" id="L178">    this.loadUserRequests.incrementAndGet();</span>
<span class="nc" id="L179">    logger.debug(&quot;getting user from cache&quot;);</span>

    try {
<span class="nc" id="L182">      Object user = this.cache.getUnchecked(userName);</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">      if (user != this.nullToken) {</span>
<span class="nc" id="L184">        logger.debug(&quot;Returning user {} from cache&quot;, userName);</span>
<span class="nc" id="L185">        return (User) user;</span>
      } else {
<span class="nc" id="L187">        logger.debug(&quot;Returning null user from cache&quot;);</span>
<span class="nc" id="L188">        return null;</span>
      }
<span class="nc" id="L190">    } catch (ExecutionError | UncheckedExecutionException ee) {</span>
<span class="nc" id="L191">      logger.warn(&quot;Exception while loading user {}&quot;, userName, ee);</span>
<span class="nc" id="L192">      return null;</span>
    }
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.security.api.UserProvider#countUsers()
   */
  @Override
  public long countUsers() {
<span class="nc" id="L203">    return 0L;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.security.api.UserProvider#getOrganization()
   */
  @Override
  public String getOrganization() {
<span class="nc" id="L213">    return this.organization.getId();</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.security.api.UserProvider#findUsers(java.lang.String, int, int)
   */
  @Override
  public Iterator&lt;User&gt; findUsers(String query, int offset, int limit) {
<span class="nc" id="L223">    return Collections.emptyIterator();</span>
  }

  @Override
  public void invalidate(String userName) {
<span class="nc" id="L228">    this.cache.invalidate(userName);</span>
<span class="nc" id="L229">  }</span>

  @Override
  public List&lt;Role&gt; getRolesForUser(String username) {
<span class="nc" id="L233">    User user = this.loadUser(username);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">    if (user != null) {</span>
<span class="nc" id="L235">      logger.debug(&quot;Returning cached role set for {}&quot;, username);</span>
<span class="nc" id="L236">      return new ArrayList&lt;&gt;(user.getRoles());</span>
    }
<span class="nc" id="L238">    logger.debug(&quot;Return empty role set for {} - not found in Brightspace&quot;, username);</span>
<span class="nc" id="L239">    return Collections.emptyList();</span>
  }

  @Override
  public Iterator&lt;Role&gt; findRoles(String query, Target target, int offset, int limit) {
<span class="nc" id="L244">    return Collections.emptyIterator();</span>
  }

  private User loadUserFromBrightspace(String username) {
<span class="nc bnc" id="L248" title="All 2 branches missed.">    if (this.cache == null) {</span>
<span class="nc" id="L249">      throw new IllegalStateException(&quot;The Brightspace user detail service has not yet been configured&quot;);</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">    } else if (ignoredUsernames.stream().anyMatch(u -&gt; u.equals(username))) {</span>
<span class="nc" id="L251">      logger.debug(&quot;We don't answer for: &quot; + username);</span>
<span class="nc" id="L252">      return null;</span>
    } else {

<span class="nc" id="L255">      logger.debug(&quot;In loadUserFromBrightspace, currently processing user: {}&quot;, username);</span>
<span class="nc" id="L256">      JaxbOrganization jaxbOrganization = JaxbOrganization.fromOrganization(organization);</span>

<span class="nc" id="L258">      this.brightspaceWebServiceRequests.incrementAndGet();</span>
<span class="nc" id="L259">      Thread currentThread = Thread.currentThread();</span>
<span class="nc" id="L260">      ClassLoader originalClassloader = currentThread.getContextClassLoader();</span>
      BrightspaceUser brightspaceUser;

      try {
<span class="nc" id="L264">        brightspaceUser = this.client.findUser(username);</span>

<span class="nc bnc" id="L266" title="All 2 branches missed.">        if (brightspaceUser != null) {</span>
<span class="nc" id="L267">          logger.info(&quot;Retrieved user {}&quot;, brightspaceUser.getUserId());</span>
<span class="nc" id="L268">          String brightspaceUserId = brightspaceUser.getUserId();</span>

<span class="nc" id="L270">          List&lt;String&gt; roleList = client.getRolesFromBrightspace(brightspaceUserId, instructorRoles);</span>
<span class="nc" id="L271">          logger.debug(&quot;Brightspace user {} with id {} with roles: {}&quot;, username, brightspaceUserId, roleList);</span>

<span class="nc" id="L273">          Set&lt;JaxbRole&gt; roles = new HashSet&lt;&gt;();</span>
<span class="nc" id="L274">          boolean isInstructor = false;</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">          for (String roleStr: roleList) {</span>
<span class="nc" id="L276">            roles.add(new JaxbRole(roleStr, jaxbOrganization, &quot;Brightspace external role&quot;, Role.Type.EXTERNAL));</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">            if (roleStr.endsWith(LTI_INSTRUCTOR_ROLE)) {</span>
<span class="nc" id="L278">              isInstructor = true;</span>
            }
<span class="nc" id="L280">          }</span>
<span class="nc" id="L281">          roles.add(new JaxbRole(Group.ROLE_PREFIX + &quot;BRIGHTSPACE&quot;, jaxbOrganization, &quot;Brightspace User&quot;,</span>
                  Role.Type.EXTERNAL_GROUP));
<span class="nc bnc" id="L283" title="All 2 branches missed.">          if (isInstructor) {</span>
<span class="nc" id="L284">            roles.add(new JaxbRole(Group.ROLE_PREFIX + &quot;BRIGHTSPACE_INSTRUCTOR&quot;, jaxbOrganization,</span>
                      &quot;Brightspace Instructor&quot;, Role.Type.EXTERNAL_GROUP));
          }
<span class="nc" id="L287">          logger.debug(&quot;Returning JaxbRoles: {}&quot;, roles);</span>

<span class="nc" id="L289">          User user =  new JaxbUser(username, null, brightspaceUser.getDisplayName(),</span>
<span class="nc" id="L290">                  brightspaceUser.getExternalEmail(), this.getName(), jaxbOrganization, roles);</span>
<span class="nc" id="L291">          cache.put(username, user);</span>
<span class="nc" id="L292">          logger.debug(&quot;Returning user {}&quot;, user);</span>
<span class="nc" id="L293">          return user;</span>
        } else {
<span class="nc" id="L295">          cache.put(username, nullToken);</span>
<span class="nc" id="L296">          logger.debug(&quot;User {} not found in Brightspace system&quot;, username);</span>
<span class="nc" id="L297">          return null;</span>
        }
<span class="nc" id="L299">      } catch (BrightspaceClientException e) {</span>
<span class="nc" id="L300">        logger.error(&quot;A Brightspace API error ( {} ) occurred, user {} could not be retrieved&quot;, e, username);</span>
<span class="nc" id="L301">        return null;</span>
      } finally {
<span class="nc" id="L303">        currentThread.setContextClassLoader(originalClassloader);</span>
      }
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>