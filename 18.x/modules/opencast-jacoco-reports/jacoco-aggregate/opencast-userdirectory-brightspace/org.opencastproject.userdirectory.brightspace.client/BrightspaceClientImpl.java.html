<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>BrightspaceClientImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-userdirectory-brightspace</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.userdirectory.brightspace.client</a> &gt; <span class="el_source">BrightspaceClientImpl.java</span></div><h1>BrightspaceClientImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.userdirectory.brightspace.client;

import org.opencastproject.userdirectory.brightspace.client.api.BrightspaceUser;
import org.opencastproject.userdirectory.brightspace.client.api.OrgUnitItem;
import org.opencastproject.userdirectory.brightspace.client.api.OrgUnitResponse;
import org.opencastproject.userdirectory.brightspace.client.api.PagingInfo;
import org.opencastproject.userdirectory.brightspace.client.api.UsersResponse;

import com.fasterxml.jackson.databind.ObjectMapper;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.MalformedURLException;
import java.net.URI;
import java.net.URL;
import java.net.URLConnection;
import java.util.ArrayList;
import java.util.List;
import java.util.Set;

import javax.net.ssl.HttpsURLConnection;

import be.ugent.brightspace.idkeyauth.AuthenticationSecurityFactory;
import be.ugent.brightspace.idkeyauth.ID2LAppContext;
import be.ugent.brightspace.idkeyauth.ID2LUserContext;

public class BrightspaceClientImpl implements BrightspaceClient {

<span class="nc" id="L55">  private static final Logger logger = LoggerFactory.getLogger(BrightspaceClientImpl.class);</span>

  private static final String GET_USER_BY_USERNAME = &quot;/d2l/api/lp/1.31/users/?UserName=&quot;;
  private static final String GET_ALL_USERS = &quot;/d2l/api/lp/1.31/users/&quot;;
  private static final String GET_COURSES_BY_BRIGHTSPACE_USER_ID
      = &quot;/d2l/api/lp/1.31/enrollments/users/{brightspace-userid}/orgUnits/?orgUnitTypeId=3&quot;;
  private static final String UNEXPECTED_JSON_RESPONSE = &quot;The brightspace API returned a unexpected json response&quot;;
  private static final String SUPER_ADMIN = &quot;Super Administrator&quot;;
  private static final String LTI_LEARNER_ROLE = &quot;Learner&quot;;
  private static final String LTI_INSTRUCTOR_ROLE = &quot;Instructor&quot;;

  private final String url;
  private final String applicationId;
  private final String applicationKey;
  private final String systemUserId;
  private final String systemUserKey;
  private final ID2LUserContext userContext;

<span class="nc" id="L73">  private final ObjectMapper objectMapper = new ObjectMapper();</span>

  public BrightspaceClientImpl(String url, String applicationId, String applicationKey, String systemUserId,
<span class="nc" id="L76">          String systemUserKey) {</span>
<span class="nc" id="L77">    this.url = url;</span>
<span class="nc" id="L78">    this.applicationId = applicationId;</span>
<span class="nc" id="L79">    this.applicationKey = applicationKey;</span>
<span class="nc" id="L80">    this.systemUserId = systemUserId;</span>
<span class="nc" id="L81">    this.systemUserKey = systemUserKey;</span>
<span class="nc" id="L82">    userContext = createUserContext();</span>
<span class="nc" id="L83">  }</span>

  public BrightspaceUser findUser(String userName) throws BrightspaceClientException {
<span class="nc" id="L86">    String request = GET_USER_BY_USERNAME + userName;</span>

    try {
<span class="nc" id="L89">      String response = httpGetRequest(request);</span>
<span class="nc" id="L90">      logger.debug(response);</span>

<span class="nc" id="L92">      BrightspaceUser brightspaceUser = objectMapper</span>
<span class="nc" id="L93">              .readerFor(BrightspaceUser.class)</span>
<span class="nc" id="L94">              .readValue(response);</span>
<span class="nc" id="L95">      return brightspaceUser;</span>
<span class="nc" id="L96">    } catch (BrightspaceNotFoundException nfe) {</span>
<span class="nc" id="L97">      return null;</span>
<span class="nc" id="L98">    } catch (IOException e) {</span>
<span class="nc" id="L99">      logger.debug(e.toString());</span>
<span class="nc" id="L100">      throw new BrightspaceClientException(UNEXPECTED_JSON_RESPONSE, e);</span>
    }
  }

  @Override public List&lt;String&gt; getRolesFromBrightspace(String userid, Set&lt;String&gt; instructorRoles)
                            throws BrightspaceClientException {
<span class="nc" id="L106">    logger.debug(&quot;Retrieving subscribed courses for user: {}&quot;, userid);</span>

    boolean hasMoreItems;
<span class="nc" id="L109">    String bookmark = null;</span>
<span class="nc" id="L110">    List&lt;String&gt; roleList = new ArrayList&lt;&gt;();</span>
    try {
      do {
<span class="nc" id="L113">        String request = composePagedUrl(bookmark, userid);</span>
<span class="nc" id="L114">        OrgUnitResponse orgUnitPage = findOrgUnitPage(request);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (SUPER_ADMIN.equals(orgUnitPage.getItems().get(0).getRole().getName())) {</span>
<span class="nc" id="L116">          roleList.add(&quot;BRIGHTSPACE_ADMIN&quot;);</span>
<span class="nc" id="L117">          return roleList;</span>
        }

<span class="nc bnc" id="L120" title="All 2 branches missed.">        for (OrgUnitItem course: orgUnitPage.getItems()) {</span>
<span class="nc" id="L121">          String brightspaceRole = course.getRole().getName();</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">          String ltiRole = instructorRoles.contains(brightspaceRole) ? LTI_INSTRUCTOR_ROLE : LTI_LEARNER_ROLE;</span>
<span class="nc" id="L123">          String opencastRole = String.format(&quot;%s_%s&quot;, course.getOrgUnit().getId(), ltiRole);</span>
<span class="nc" id="L124">          roleList.add(opencastRole);</span>
<span class="nc" id="L125">        }</span>

<span class="nc" id="L127">        PagingInfo pagingInfo = orgUnitPage.getPagingInfo();</span>
<span class="nc" id="L128">        hasMoreItems = pagingInfo.hasMoreItems();</span>
<span class="nc" id="L129">        bookmark = pagingInfo.getBookmark();</span>

<span class="nc bnc" id="L131" title="All 2 branches missed.">      } while (hasMoreItems);</span>

<span class="nc" id="L133">      return roleList;</span>
<span class="nc" id="L134">    } catch (BrightspaceClientException e) {</span>
<span class="nc" id="L135">      logger.warn(&quot;Exception getting site/role membership for brightspace user {}&quot;, userid, e);</span>
<span class="nc" id="L136">      throw new BrightspaceClientException(UNEXPECTED_JSON_RESPONSE, e);</span>
    }

  }

  @Override
  public List&lt;BrightspaceUser&gt; findAllUsers() throws BrightspaceClientException {
    try {
<span class="nc" id="L144">      String response = httpGetRequest(GET_ALL_USERS);</span>
<span class="nc" id="L145">      UsersResponse usersResponse = objectMapper.readValue(response, UsersResponse.class);</span>
<span class="nc" id="L146">      return usersResponse.getItems();</span>
<span class="nc" id="L147">    } catch (IOException e) {</span>
<span class="nc" id="L148">      throw new BrightspaceClientException(UNEXPECTED_JSON_RESPONSE, e);</span>
<span class="nc" id="L149">    } catch (BrightspaceNotFoundException nfe) {</span>
<span class="nc" id="L150">      throw new BrightspaceClientException(UNEXPECTED_JSON_RESPONSE, nfe);</span>
    }

  }

  public String getURL() {
<span class="nc" id="L156">    return this.url;</span>
  }

  private String httpGetRequest(String request) throws BrightspaceClientException, BrightspaceNotFoundException {
<span class="nc" id="L160">    URL url = createUrl(request);</span>

    try {
<span class="nc" id="L163">      HttpsURLConnection urlConnection = (HttpsURLConnection) getURLConnection(url);</span>

<span class="nc bnc" id="L165" title="All 2 branches missed.">      if (urlConnection.getResponseCode() == 404) {</span>
<span class="nc" id="L166">        logger.debug(&quot;Not found, 404 response&quot;);</span>
<span class="nc" id="L167">        throw new BrightspaceNotFoundException(&quot;not found&quot;);</span>
      }

<span class="nc" id="L170">      InputStream inputStream = urlConnection.getInputStream();</span>
<span class="nc" id="L171">      return readInputStream(inputStream);</span>
<span class="nc" id="L172">    } catch (IOException io) {</span>
<span class="nc" id="L173">      logger.warn(&quot;error in brightspace data fetching&quot;, io);</span>
<span class="nc" id="L174">      throw new BrightspaceClientException(&quot;could not read response&quot;);</span>
    }
  }

  private URL createUrl(String request) throws BrightspaceClientException {
<span class="nc" id="L179">    URI uri = userContext.createAuthenticatedUri(request, &quot;GET&quot;);</span>
    URL url;
    try {
<span class="nc" id="L182">      url = uri.toURL();</span>
<span class="nc" id="L183">    } catch (MalformedURLException mue) {</span>
<span class="nc" id="L184">      throw new BrightspaceClientException(&quot;url was malformed&quot;, mue);</span>
<span class="nc" id="L185">    }</span>
<span class="nc" id="L186">    logger.debug(&quot;about to make GET request to : {}&quot;, uri);</span>
<span class="nc" id="L187">    return url;</span>
  }

  private ID2LUserContext createUserContext() {
<span class="nc" id="L191">    ID2LAppContext securityContext = AuthenticationSecurityFactory</span>
<span class="nc" id="L192">            .createSecurityContext(applicationId, applicationKey, url);</span>
<span class="nc" id="L193">    return securityContext.createUserContext(systemUserId, systemUserKey);</span>
  }

  private URLConnection getURLConnection(URL url) throws BrightspaceClientException {
    try {
<span class="nc" id="L198">      HttpsURLConnection urlConnection = (HttpsURLConnection) url.openConnection();</span>
<span class="nc" id="L199">      urlConnection.setRequestMethod(&quot;GET&quot;);</span>
<span class="nc" id="L200">      urlConnection.setRequestProperty(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<span class="nc" id="L201">      urlConnection.setRequestProperty(&quot;Accept-Charset&quot;, &quot;utf-8&quot;);</span>
<span class="nc" id="L202">      urlConnection.setDoInput(true);</span>
<span class="nc" id="L203">      urlConnection.setDoOutput(true);</span>
<span class="nc" id="L204">      return urlConnection;</span>
<span class="nc" id="L205">    } catch (IOException ioe) {</span>
<span class="nc" id="L206">      throw new BrightspaceClientException(&quot;Brightspace api unreachable&quot;, ioe);</span>
    }
  }

  private String readInputStream(InputStream inputStream) throws BrightspaceClientException {
<span class="nc" id="L211">    StringBuilder content = new StringBuilder();</span>
<span class="nc" id="L212">    try (BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(inputStream))) {</span>
      String inputline;
<span class="nc bnc" id="L214" title="All 2 branches missed.">      while ((inputline = bufferedReader.readLine()) != null) {</span>
<span class="nc" id="L215">        content.append(inputline);</span>
      }
<span class="nc" id="L217">      logger.debug(&quot;call to brightspace api: {}&quot;, content);</span>
<span class="nc" id="L218">      return content.toString();</span>
<span class="nc" id="L219">    } catch (IOException io) {</span>
<span class="nc" id="L220">      throw new BrightspaceClientException(&quot;Could not read response&quot;, io);</span>
    }

  }

  private OrgUnitResponse findOrgUnitPage(String request) throws BrightspaceClientException {
    try {
<span class="nc" id="L227">      String response = httpGetRequest(request);</span>
<span class="nc" id="L228">      return objectMapper.readValue(response, OrgUnitResponse.class);</span>
<span class="nc" id="L229">    } catch (IOException e) {</span>
<span class="nc" id="L230">      logger.error(UNEXPECTED_JSON_RESPONSE);</span>
<span class="nc" id="L231">      throw new BrightspaceClientException(UNEXPECTED_JSON_RESPONSE, e);</span>
<span class="nc" id="L232">    } catch (BrightspaceNotFoundException nfe) {</span>
<span class="nc" id="L233">      logger.error(UNEXPECTED_JSON_RESPONSE);</span>
<span class="nc" id="L234">      throw new BrightspaceClientException(UNEXPECTED_JSON_RESPONSE, nfe);</span>
    }
  }

  private String composePagedUrl(String bookmark, String brightspaceUserId) {
<span class="nc" id="L239">    String request = GET_COURSES_BY_BRIGHTSPACE_USER_ID.replaceAll(&quot;\\{\\S+}&quot;, brightspaceUserId);</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">    if (bookmark != null) {</span>
<span class="nc" id="L241">      request += &quot;&amp;bookmark=&quot; + bookmark;</span>
    }
<span class="nc" id="L243">    return request;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>