<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AbstractCoverImageService.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-cover-image-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.coverimage.impl</a> &gt; <span class="el_source">AbstractCoverImageService.java</span></div><h1>AbstractCoverImageService.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.coverimage.impl;

import static org.apache.commons.lang3.StringUtils.isNotBlank;

import org.opencastproject.coverimage.CoverImageException;
import org.opencastproject.coverimage.CoverImageService;
import org.opencastproject.job.api.AbstractJobProducer;
import org.opencastproject.job.api.Job;
import org.opencastproject.mediapackage.Attachment;
import org.opencastproject.mediapackage.MediaPackageElement.Type;
import org.opencastproject.mediapackage.MediaPackageElementBuilderFactory;
import org.opencastproject.mediapackage.MediaPackageElementFlavor;
import org.opencastproject.mediapackage.MediaPackageElementParser;
import org.opencastproject.security.api.OrganizationDirectoryService;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.UserDirectoryService;
import org.opencastproject.serviceregistry.api.ServiceRegistry;
import org.opencastproject.serviceregistry.api.ServiceRegistryException;
import org.opencastproject.util.XmlSafeParser;
import org.opencastproject.workspace.api.Workspace;

import org.apache.batik.apps.rasterizer.DestinationType;
import org.apache.batik.apps.rasterizer.SVGConverter;
import org.apache.batik.apps.rasterizer.SVGConverterException;
import org.apache.commons.io.FileUtils;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.w3c.dom.Document;
import org.xml.sax.InputSource;
import org.xml.sax.SAXException;

import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.StringReader;
import java.net.URI;
import java.util.Arrays;
import java.util.List;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.Result;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerConfigurationException;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.TransformerFactoryConfigurationError;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;

/**
 * Service for creating cover images
 */
public abstract class AbstractCoverImageService extends AbstractJobProducer implements CoverImageService {

  protected static final String COVERIMAGE_WORKSPACE_COLLECTION = &quot;coverimage&quot;;

  /** List of available operations on jobs */
<span class="nc" id="L83">  protected enum Operation {</span>
<span class="nc" id="L84">    Generate</span>
  }

  /** The workspace service */
<span class="nc" id="L88">  protected Workspace workspace = null;</span>

  /** The service registry service */
  protected ServiceRegistry serviceRegistry;

  /** The security service */
  protected SecurityService securityService;

  /** The user directory service */
  protected UserDirectoryService userDirectoryService;

  /** The organization directory service */
  protected OrganizationDirectoryService organizationDirectoryService;

  /** The logging facility */
<span class="fc" id="L103">  private static final Logger log = LoggerFactory.getLogger(AbstractCoverImageService.class);</span>

  /** Creates a new composer service instance. */
  public AbstractCoverImageService() {
<span class="nc" id="L107">    super(JOB_TYPE);</span>
<span class="nc" id="L108">  }</span>

  @Override
  protected String process(Job job) throws Exception {

<span class="nc" id="L113">    List&lt;String&gt; arguments = job.getArguments();</span>
<span class="nc" id="L114">    String xml = arguments.get(0);</span>
<span class="nc" id="L115">    String xsl = arguments.get(1);</span>
<span class="nc" id="L116">    int width = Integer.valueOf(arguments.get(2));</span>
<span class="nc" id="L117">    int height = Integer.valueOf(arguments.get(3));</span>
<span class="nc" id="L118">    String posterImage = arguments.get(4);</span>
<span class="nc" id="L119">    String targetFlavor = arguments.get(5);</span>

<span class="nc" id="L121">    Operation op = null;</span>
<span class="nc" id="L122">    op = Operation.valueOf(job.getOperation());</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">    switch (op) {</span>
      case Generate:
<span class="nc" id="L125">        Attachment result = generateCoverImageInternal(job, xml, xsl, width, height, posterImage, targetFlavor);</span>
<span class="nc" id="L126">        return MediaPackageElementParser.getAsXml(result);</span>
      default:
<span class="nc" id="L128">        throw new IllegalStateException(&quot;Don't know how to handle operation '&quot; + job.getOperation() + &quot;'&quot;);</span>
    }
  }

  @Override
  public Job generateCoverImage(String xml, String xsl, String width, String height, String posterImageUri,
          String targetFlavor) throws CoverImageException {

    // Null values are not passed to the arguments list
<span class="nc bnc" id="L137" title="All 2 branches missed.">    if (posterImageUri == null) {</span>
<span class="nc" id="L138">      posterImageUri = &quot;&quot;;</span>
    }

    try {
<span class="nc" id="L142">      return serviceRegistry.createJob(JOB_TYPE, Operation.Generate.toString(),</span>
<span class="nc" id="L143">          Arrays.asList(xml, xsl, width, height, posterImageUri, targetFlavor));</span>
<span class="nc" id="L144">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L145">      throw new CoverImageException(&quot;Unable to create a job&quot;, e);</span>
    }
  }

  protected Attachment generateCoverImageInternal(Job job, String xml, String xsl, int width, int height,
      String posterImage, String targetFlavor) throws CoverImageException {

    URI result;
<span class="nc" id="L153">    File tempSvg = null;</span>
<span class="nc" id="L154">    File tempPng = null;</span>

<span class="nc" id="L156">    try (StringReader xmlReader =  new StringReader(xml)) {</span>
<span class="nc" id="L157">      Document xslDoc = parseXsl(xsl);</span>

      // Create temp SVG file for transformation result
<span class="nc" id="L160">      tempSvg = createTempFile(job, &quot;.svg&quot;);</span>
<span class="nc" id="L161">      Result svg = new StreamResult(tempSvg);</span>

      // Load Metadata (from resources)
<span class="nc" id="L164">      InputSource xmlSource = new InputSource(xmlReader);</span>

      // Transform XML metadata with stylesheet to SVG
<span class="nc" id="L167">      transformSvg(svg, xmlSource, xslDoc, width, height, posterImage);</span>

      // Rasterize SVG to PNG
<span class="nc" id="L170">      tempPng = createTempFile(job, &quot;.png&quot;);</span>
<span class="nc" id="L171">      rasterizeSvg(tempSvg, tempPng);</span>

<span class="nc" id="L173">      try (FileInputStream in = new FileInputStream(tempPng)) {</span>
<span class="nc" id="L174">        result = workspace.putInCollection(COVERIMAGE_WORKSPACE_COLLECTION, job.getId() + &quot;_coverimage.png&quot;, in);</span>
<span class="nc" id="L175">        log.debug(&quot;Put the cover image into the workspace ({})&quot;, result);</span>
<span class="nc" id="L176">      } catch (IOException e) {</span>
<span class="nc" id="L177">        log.warn(&quot;Error while putting resulting image into workspace collection '{}'&quot;,</span>
                COVERIMAGE_WORKSPACE_COLLECTION, e);
<span class="nc" id="L179">        throw new CoverImageException(&quot;Error while putting resulting image into workspace collection&quot;, e);</span>
<span class="nc" id="L180">      }</span>
    } finally {
<span class="nc" id="L182">      FileUtils.deleteQuietly(tempSvg);</span>
<span class="nc" id="L183">      FileUtils.deleteQuietly(tempPng);</span>
<span class="nc" id="L184">      log.debug(&quot;Removed temporary files&quot;);</span>
    }

<span class="nc" id="L187">    return (Attachment) MediaPackageElementBuilderFactory.newInstance().newElementBuilder()</span>
<span class="nc" id="L188">        .elementFromURI(result, Type.Attachment, MediaPackageElementFlavor.parseFlavor(targetFlavor));</span>
  }

  protected static Document parseXsl(String xsl) throws CoverImageException {
<span class="fc bfc" id="L192" title="All 2 branches covered.">    if (StringUtils.isBlank(xsl)) {</span>
<span class="fc" id="L193">      throw new IllegalArgumentException(&quot;XSL string must not be empty&quot;);</span>
    }

<span class="fc" id="L196">    DocumentBuilderFactory dbFactory = XmlSafeParser.newDocumentBuilderFactory();</span>

<span class="fc" id="L198">    dbFactory.setNamespaceAware(true);</span>
    Document xslDoc;
    try {
<span class="fc" id="L201">      log.debug(&quot;Parse given XSL to a org.w3c.dom.Document object&quot;);</span>
<span class="fc" id="L202">      DocumentBuilder dBuilder = dbFactory.newDocumentBuilder();</span>
<span class="fc" id="L203">      xslDoc = dBuilder.parse(new InputSource(new ByteArrayInputStream(xsl.getBytes(&quot;utf-8&quot;))));</span>
<span class="nc" id="L204">    } catch (ParserConfigurationException e) {</span>
      // this should never happen...
<span class="nc" id="L206">      throw new CoverImageException(&quot;The XSLT parser has serious configuration errors&quot;, e);</span>
<span class="fc" id="L207">    } catch (SAXException e) {</span>
<span class="fc" id="L208">      log.warn(&quot;Error while parsing the XSLT stylesheet: {}&quot;, e.getMessage());</span>
<span class="fc" id="L209">      throw new CoverImageException(&quot;Error while parsing the XSLT stylesheet&quot;, e);</span>
<span class="nc" id="L210">    } catch (IOException e) {</span>
<span class="nc" id="L211">      log.warn(&quot;Error while reading the XSLT stylesheet: {}&quot;, e.getMessage());</span>
<span class="nc" id="L212">      throw new CoverImageException(&quot;Error while reading the XSLT stylesheet&quot;, e);</span>
<span class="fc" id="L213">    }</span>
<span class="fc" id="L214">    return xslDoc;</span>
  }

  protected static void transformSvg(Result svg, InputSource xmlSource, Document xslDoc, int width, int height,
      String posterImage) throws TransformerFactoryConfigurationError, CoverImageException {
<span class="fc bfc" id="L219" title="All 6 branches covered.">    if (svg == null || xmlSource == null || xslDoc == null) {</span>
<span class="fc" id="L220">      throw new IllegalArgumentException(&quot;Neither svg nor xmlSource nor xslDoc must be null&quot;);</span>
    }

<span class="fc" id="L223">    Thread thread = Thread.currentThread();</span>
<span class="fc" id="L224">    ClassLoader loader = thread.getContextClassLoader();</span>
<span class="fc" id="L225">    thread.setContextClassLoader(AbstractCoverImageService.class.getClassLoader());</span>
    try {
      Transformer transformer;
      // CHECKSTYLE:OFF
      // Xalan Transformer can't be configured safely
      // xslDoc is an already parsed Document
<span class="fc" id="L231">      transformer = TransformerFactory</span>
<span class="fc" id="L232">          .newInstance(&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl&quot;, null)</span>
<span class="fc" id="L233">          .newTransformer(new DOMSource(xslDoc));</span>
      // CHECKSTYLE:ON

<span class="fc" id="L236">      transformer.setParameter(&quot;width&quot;, width);</span>
<span class="fc" id="L237">      transformer.setParameter(&quot;height&quot;, height);</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">      if (isNotBlank(posterImage)) {</span>
<span class="nc" id="L239">        transformer.setParameter(&quot;posterimage&quot;, posterImage);</span>
      }

<span class="fc" id="L242">      log.debug(&quot;Transform XML source to SVG&quot;);</span>
      // Xalan Transformer can't be configured safely
      // Preparsing the XML with a safe parser
<span class="fc" id="L245">      transformer.transform(new DOMSource(XmlSafeParser.parse(xmlSource)), svg);</span>
<span class="nc" id="L246">    } catch (TransformerConfigurationException e) {</span>
      // this should never happen...
<span class="nc" id="L248">      throw new CoverImageException(&quot;The XSL transformer factory has serious configuration errors&quot;, e);</span>
<span class="nc" id="L249">    } catch (TransformerException | IOException | SAXException e) {</span>
<span class="nc" id="L250">      log.warn(&quot;Error while transforming SVG to image: {}&quot;, e.getMessage());</span>
<span class="nc" id="L251">      throw new CoverImageException(&quot;Error while transforming SVG to image&quot;, e);</span>
    } finally {
<span class="fc" id="L253">      thread.setContextClassLoader(loader);</span>
    }
<span class="fc" id="L255">  }</span>

  protected File createTempFile(Job job, String suffix) throws CoverImageException {
    File tempFile;
    try {
<span class="nc" id="L260">      tempFile = File.createTempFile(COVERIMAGE_WORKSPACE_COLLECTION, Long.toString(job.getId()) + &quot;_&quot; + suffix);</span>
<span class="nc" id="L261">      log.debug(&quot;Created temporary file {}&quot;, tempFile);</span>
<span class="nc" id="L262">    } catch (IOException e) {</span>
<span class="nc" id="L263">      log.warn(&quot;Error creating temporary file:&quot;, e);</span>
<span class="nc" id="L264">      throw new CoverImageException(&quot;Error creating temporary file&quot;, e);</span>
<span class="nc" id="L265">    }</span>
<span class="nc" id="L266">    return tempFile;</span>
  }

  protected static void rasterizeSvg(File svgSource, File pngResult) throws CoverImageException {
<span class="nc" id="L270">    SVGConverter converter = new SVGConverter();</span>
<span class="nc" id="L271">    converter.setDestinationType(DestinationType.PNG);</span>
<span class="nc" id="L272">    converter.setDst(pngResult);</span>
<span class="nc" id="L273">    converter.setSources(new String[] { svgSource.getAbsolutePath() });</span>
    try {
<span class="nc" id="L275">      log.debug(&quot;Start converting SVG to PNG&quot;);</span>
<span class="nc" id="L276">      converter.execute();</span>
<span class="nc" id="L277">    } catch (SVGConverterException e) {</span>
<span class="nc" id="L278">      log.warn(&quot;Error while converting the SVG to a PNG: {}&quot;, e.getMessage());</span>
<span class="nc" id="L279">      throw new CoverImageException(&quot;Error while converting the SVG to a PNG&quot;, e);</span>
<span class="nc" id="L280">    }</span>
<span class="nc" id="L281">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>