<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>WorkflowServiceDatabaseImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-workflow-service-api</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.workflow.api</a> &gt; <span class="el_source">WorkflowServiceDatabaseImpl.java</span></div><h1>WorkflowServiceDatabaseImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.workflow.api;

import static org.opencastproject.db.Queries.namedQuery;

import org.opencastproject.db.DBSession;
import org.opencastproject.db.DBSessionFactory;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.util.NotFoundException;

import org.apache.commons.lang3.tuple.Pair;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Date;
import java.util.List;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.NoResultException;

/**
 * Implements {@link WorkflowServiceDatabase}. Defines permanent storage for workflow.
 */
@Component(
        property = {
                &quot;service.description=Workflow Service Database&quot;
        },
        immediate = true,
        service = { WorkflowServiceDatabase.class }
)
<span class="fc" id="L56">public class WorkflowServiceDatabaseImpl implements WorkflowServiceDatabase {</span>
  /** Logging utilities */
<span class="fc" id="L58">  private static final Logger logger = LoggerFactory.getLogger(WorkflowServiceDatabaseImpl.class);</span>

  /** JPA persistence unit name */
  public static final String PERSISTENCE_UNIT = &quot;org.opencastproject.workflow.api&quot;;

  /** Factory used to create {@link EntityManager}s for transactions */
  protected EntityManagerFactory emf;

  protected DBSessionFactory dbSessionFactory;

  protected DBSession db;

  /** The security service */
  protected SecurityService securityService;

  /** OSGi DI */
  @Reference(name = &quot;entityManagerFactory&quot;, target = &quot;(osgi.unit.name=org.opencastproject.workflow.api)&quot;)
  public void setEntityManagerFactory(EntityManagerFactory emf) {
<span class="fc" id="L76">    this.emf = emf;</span>
<span class="fc" id="L77">  }</span>

  @Reference
  public void setDBSessionFactory(DBSessionFactory dbSessionFactory) {
<span class="fc" id="L81">    this.dbSessionFactory = dbSessionFactory;</span>
<span class="fc" id="L82">  }</span>

  /**
   * OSGi callback to set the security service.
   *
   * @param securityService
   *          the securityService to set
   */
  @Reference(name = &quot;security-service&quot;)
  public void setSecurityService(SecurityService securityService) {
<span class="fc" id="L92">    this.securityService = securityService;</span>
<span class="fc" id="L93">  }</span>

  /**
   * Creates {@link EntityManagerFactory} using persistence provider and properties passed via OSGi.
   *
   * @param cc
   */
  @Activate
  public void activate(ComponentContext cc) {
<span class="fc" id="L102">    logger.info(&quot;Activating persistence manager for workflow&quot;);</span>
<span class="fc" id="L103">    db = dbSessionFactory.createSession(emf);</span>
<span class="fc" id="L104">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see WorkflowServiceDatabase#getWorkflow(long)
   */
  @Override
  public WorkflowInstance getWorkflow(long workflowId) throws NotFoundException, WorkflowDatabaseException {
<span class="fc" id="L113">    return getWorkflow(workflowId, securityService.getOrganization().getId());</span>
  }

  public WorkflowInstance getWorkflow(long workflowId, String orgId) throws NotFoundException, WorkflowDatabaseException {
    try {
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">      if (null != orgId) {</span>
<span class="fc" id="L119">        return db.exec(namedQuery.find(</span>
            &quot;Workflow.workflowById&quot;,
            WorkflowInstance.class,
<span class="fc" id="L122">            Pair.of(&quot;workflowId&quot;, workflowId),</span>
<span class="fc" id="L123">            Pair.of(&quot;organizationId&quot;, orgId)</span>
        ));
      } else {
<span class="nc" id="L126">        return db.exec(namedQuery.find(</span>
            &quot;Workflow.workflowByIdOrganizationIndependent&quot;,
            WorkflowInstance.class,
<span class="nc" id="L129">            Pair.of(&quot;workflowId&quot;, workflowId)</span>
        ));
      }
<span class="fc" id="L132">    } catch (NoResultException e) {</span>
<span class="fc" id="L133">      throw new NotFoundException(&quot;No workflow with id=&quot; + workflowId + &quot; exists&quot;);</span>
<span class="nc" id="L134">    } catch (Exception e) {</span>
<span class="nc" id="L135">      logger.error(&quot;Could not retrieve workflow with ID '{}'&quot;, workflowId, e);</span>
<span class="nc" id="L136">      throw new WorkflowDatabaseException(e);</span>
    }
  }

  /**
   * {@inheritDoc}
   *
   * @see WorkflowServiceDatabase#getWorkflowInstances(int limit, int offset)
   */
  public List&lt;WorkflowInstance&gt; getWorkflowInstances(int limit, int offset) throws WorkflowDatabaseException {
    try {
<span class="nc" id="L147">      return db.exec(em -&gt; {</span>
<span class="nc" id="L148">        var query = em</span>
<span class="nc" id="L149">            .createNamedQuery(&quot;Workflow.findAll&quot;, WorkflowInstance.class)</span>
<span class="nc" id="L150">            .setParameter(&quot;organizationId&quot;, securityService.getOrganization().getId())</span>
<span class="nc" id="L151">            .setMaxResults(limit)</span>
<span class="nc" id="L152">            .setFirstResult(offset);</span>

<span class="nc" id="L154">        logger.debug(&quot;Requesting workflows using query: {}&quot;, query);</span>
<span class="nc" id="L155">        return query.getResultList();</span>
      });
<span class="nc" id="L157">    } catch (Exception e) {</span>
<span class="nc" id="L158">      throw new WorkflowDatabaseException(&quot;Error fetching workflows from database&quot;, e);</span>
    }
  }

  /**
   * {@inheritDoc}
   *
   * @see WorkflowServiceDatabase#getWorkflowInstancesForCleanup(WorkflowInstance.WorkflowState state, Date dateCreated)
   */
  public List&lt;WorkflowInstance&gt; getWorkflowInstancesForCleanup(WorkflowInstance.WorkflowState state, Date dateCreated)
          throws WorkflowDatabaseException {
    try {
<span class="fc" id="L170">      return db.exec(namedQuery.findAll(</span>
          &quot;Workflow.toCleanup&quot;,
          WorkflowInstance.class,
<span class="fc" id="L173">          Pair.of(&quot;organizationId&quot;, securityService.getOrganization().getId()),</span>
<span class="fc" id="L174">          Pair.of(&quot;state&quot;, state),</span>
<span class="fc" id="L175">          Pair.of(&quot;dateCreated&quot;, dateCreated)</span>
      ));
<span class="nc" id="L177">    } catch (Exception e) {</span>
<span class="nc" id="L178">      throw new WorkflowDatabaseException(e);</span>
    }
  }

  /**
   * {@inheritDoc}
   *
   * @see WorkflowServiceDatabase#countWorkflows(WorkflowInstance.WorkflowState state)
   */
  public long countWorkflows(WorkflowInstance.WorkflowState state) throws WorkflowDatabaseException {
    try {
<span class="fc" id="L189">      return db.exec(namedQuery.find(</span>
          &quot;Workflow.getCount&quot;,
          Long.class,
<span class="fc" id="L192">          Pair.of(&quot;organizationId&quot;, securityService.getOrganization().getId()),</span>
<span class="fc" id="L193">          Pair.of(&quot;state&quot;, state)</span>
      ));
<span class="nc" id="L195">    } catch (Exception e) {</span>
<span class="nc" id="L196">      throw new WorkflowDatabaseException(&quot;Could not find number of workflows.&quot;, e);</span>
    }
  }

  /**
   * {@inheritDoc}
   *
   * @see WorkflowServiceDatabase#getWorkflowIndexData(int limit, int offset)
   */
  public List&lt;WorkflowIndexData&gt; getWorkflowIndexData(int limit, int offset) throws WorkflowDatabaseException {
    try {
<span class="nc" id="L207">      return db.exec(em -&gt; {</span>
<span class="nc" id="L208">        return em</span>
<span class="nc" id="L209">            .createNamedQuery(&quot;WorkflowIndexData.getAll&quot;, WorkflowIndexData.class)</span>
<span class="nc" id="L210">            .setMaxResults(limit)</span>
<span class="nc" id="L211">            .setFirstResult(offset)</span>
<span class="nc" id="L212">            .getResultList();</span>
      });
<span class="nc" id="L214">    } catch (Exception e) {</span>
<span class="nc" id="L215">      throw new WorkflowDatabaseException(e);</span>
    }
  }

  /**
   * {@inheritDoc}
   *
   * @see WorkflowServiceDatabase#countMediaPackages()
   */
  public int countMediaPackages() throws WorkflowDatabaseException {
    try {
<span class="nc" id="L226">      return db.exec(namedQuery.find(&quot;Workflow.countLatest&quot;, Number.class)).intValue();</span>
<span class="nc" id="L227">    } catch (Exception e) {</span>
<span class="nc" id="L228">      throw new WorkflowDatabaseException(e);</span>
    }
  }

  /**
   * {@inheritDoc}
   *
   * @see WorkflowServiceDatabase#getWorkflowInstancesByMediaPackage(String mediaPackageId)
   */
  public List&lt;WorkflowInstance&gt; getWorkflowInstancesByMediaPackage(String mediaPackageId)
          throws WorkflowDatabaseException {
    try {
<span class="fc" id="L240">      return db.exec(namedQuery.findAll(</span>
          &quot;Workflow.byMediaPackage&quot;,
          WorkflowInstance.class,
<span class="fc" id="L243">          Pair.of(&quot;organizationId&quot;, securityService.getOrganization().getId()),</span>
<span class="fc" id="L244">          Pair.of(&quot;mediaPackageId&quot;, mediaPackageId)</span>
      ));
<span class="nc" id="L246">    } catch (Exception e) {</span>
<span class="nc" id="L247">      throw new WorkflowDatabaseException(&quot;Failed to get workflows from database&quot;, e);</span>
    }
  }

  /**
   * {@inheritDoc}
   *
   * @see WorkflowServiceDatabase#getRunningWorkflowInstancesByMediaPackage(String mediaPackageId)
   */
  public List&lt;WorkflowInstance&gt; getRunningWorkflowInstancesByMediaPackage(String mediaPackageId)
          throws WorkflowDatabaseException {
    try {
<span class="fc" id="L259">      return db.exec(namedQuery.findAll(</span>
          &quot;Workflow.byMediaPackageAndActive&quot;,
          WorkflowInstance.class,
<span class="fc" id="L262">          Pair.of(&quot;organizationId&quot;, securityService.getOrganization().getId()),</span>
<span class="fc" id="L263">          Pair.of(&quot;mediaPackageId&quot;, mediaPackageId),</span>
<span class="fc" id="L264">          Pair.of(&quot;stateInstantiated&quot;, WorkflowInstance.WorkflowState.INSTANTIATED),</span>
<span class="fc" id="L265">          Pair.of(&quot;stateRunning&quot;, WorkflowInstance.WorkflowState.RUNNING),</span>
<span class="fc" id="L266">          Pair.of(&quot;statePaused&quot;, WorkflowInstance.WorkflowState.PAUSED),</span>
<span class="fc" id="L267">          Pair.of(&quot;stateFailing&quot;, WorkflowInstance.WorkflowState.FAILING)</span>
      ));
<span class="nc" id="L269">    } catch (Exception e) {</span>
<span class="nc" id="L270">      throw new WorkflowDatabaseException(e);</span>
    }
  }

  /**
   * {@inheritDoc}
   *
   * @see WorkflowServiceDatabase#mediaPackageHasActiveWorkflows(String mediaPackageId)
   */
  public boolean mediaPackageHasActiveWorkflows(String mediaPackageId) throws WorkflowDatabaseException {
    try {
<span class="fc" id="L281">      long count = db.exec(namedQuery.find(</span>
          &quot;Workflow.countActiveByMediaPackage&quot;,
          Long.class,
<span class="fc" id="L284">          Pair.of(&quot;organizationId&quot;, securityService.getOrganization().getId()),</span>
<span class="fc" id="L285">          Pair.of(&quot;mediaPackageId&quot;, mediaPackageId),</span>
<span class="fc" id="L286">          Pair.of(&quot;stateInstantiated&quot;, WorkflowInstance.WorkflowState.INSTANTIATED),</span>
<span class="fc" id="L287">          Pair.of(&quot;stateRunning&quot;, WorkflowInstance.WorkflowState.RUNNING),</span>
<span class="fc" id="L288">          Pair.of(&quot;statePaused&quot;, WorkflowInstance.WorkflowState.PAUSED),</span>
<span class="fc" id="L289">          Pair.of(&quot;stateFailing&quot;, WorkflowInstance.WorkflowState.FAILING)</span>
      ));
<span class="pc bpc" id="L291" title="1 of 2 branches missed.">      return count &gt; 0;</span>
<span class="nc" id="L292">    } catch (Exception e) {</span>
<span class="nc" id="L293">      throw new WorkflowDatabaseException(e);</span>
    }
  }

  /**
   * {@inheritDoc}
   *
   * @see WorkflowServiceDatabase#userHasActiveWorkflows(String mediaPackageId)
   */
  public boolean userHasActiveWorkflows(String userId) throws WorkflowDatabaseException {
    try {
<span class="nc" id="L304">      long count = db.exec(namedQuery.find(</span>
              &quot;Workflow.countActiveByUser&quot;,
              Long.class,
<span class="nc" id="L307">              Pair.of(&quot;organizationId&quot;, securityService.getOrganization().getId()),</span>
<span class="nc" id="L308">              Pair.of(&quot;userId&quot;, userId),</span>
<span class="nc" id="L309">              Pair.of(&quot;stateInstantiated&quot;, WorkflowInstance.WorkflowState.INSTANTIATED),</span>
<span class="nc" id="L310">              Pair.of(&quot;stateRunning&quot;, WorkflowInstance.WorkflowState.RUNNING),</span>
<span class="nc" id="L311">              Pair.of(&quot;statePaused&quot;, WorkflowInstance.WorkflowState.PAUSED),</span>
<span class="nc" id="L312">              Pair.of(&quot;stateFailing&quot;, WorkflowInstance.WorkflowState.FAILING)</span>
      ));
<span class="nc bnc" id="L314" title="All 2 branches missed.">      return count &gt; 0;</span>
<span class="nc" id="L315">    } catch (Exception e) {</span>
<span class="nc" id="L316">      throw new WorkflowDatabaseException(e);</span>
    }
  }

  /**
   * {@inheritDoc}
   *
   * @see WorkflowServiceDatabase#updateInDatabase(WorkflowInstance instance)
   */
  public void updateInDatabase(WorkflowInstance instance) throws WorkflowDatabaseException {
    try {
<span class="fc" id="L327">      db.execTx(em -&gt; {</span>
<span class="fc" id="L328">        WorkflowInstance fromDb = em.find(WorkflowInstance.class, instance.getId());</span>
<span class="fc bfc" id="L329" title="All 2 branches covered.">        if (fromDb == null) {</span>
<span class="fc" id="L330">          em.persist(instance);</span>
        } else {
<span class="fc" id="L332">          em.merge(instance);</span>
        }
<span class="fc" id="L334">      });</span>
<span class="nc" id="L335">    } catch (Exception e) {</span>
<span class="nc" id="L336">      throw new WorkflowDatabaseException(&quot;Could not update workflow with ID '&quot; + instance.getId() + &quot;'&quot;, e);</span>
<span class="fc" id="L337">    }</span>
<span class="fc" id="L338">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see WorkflowServiceDatabase#removeFromDatabase(WorkflowInstance instance)
   */
  public void removeFromDatabase(WorkflowInstance instance) throws WorkflowDatabaseException {
    try {
<span class="fc" id="L347">      db.execTx(em -&gt; {</span>
<span class="fc" id="L348">        WorkflowInstance fromDb = em.find(WorkflowInstance.class, instance.getId());</span>
<span class="pc bpc" id="L349" title="1 of 2 branches missed.">        if (fromDb != null) {</span>
<span class="fc" id="L350">          fromDb = em.merge(instance);</span>
<span class="fc" id="L351">          em.remove(fromDb);</span>
        }
<span class="fc" id="L353">      });</span>
<span class="fc" id="L354">      logger.debug(&quot;Workflow with id {} was deleted.&quot;, instance.getId());</span>
<span class="nc" id="L355">    } catch (Exception e) {</span>
<span class="nc" id="L356">      throw new WorkflowDatabaseException(&quot;Could not delete workflow with ID '&quot; + instance.getId() + &quot;'&quot;, e);</span>
<span class="fc" id="L357">    }</span>
<span class="fc" id="L358">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>