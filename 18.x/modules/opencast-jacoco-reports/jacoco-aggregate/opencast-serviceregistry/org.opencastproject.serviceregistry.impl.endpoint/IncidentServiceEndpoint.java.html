<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>IncidentServiceEndpoint.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-serviceregistry</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.serviceregistry.impl.endpoint</a> &gt; <span class="el_source">IncidentServiceEndpoint.java</span></div><h1>IncidentServiceEndpoint.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.serviceregistry.impl.endpoint;

import static javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;
import static javax.servlet.http.HttpServletResponse.SC_CONFLICT;
import static javax.servlet.http.HttpServletResponse.SC_CREATED;
import static javax.servlet.http.HttpServletResponse.SC_NOT_FOUND;
import static javax.servlet.http.HttpServletResponse.SC_OK;
import static javax.ws.rs.core.Response.Status.INTERNAL_SERVER_ERROR;
import static org.opencastproject.util.EqualsUtil.eq;
import static org.opencastproject.util.RestUtil.R.badRequest;
import static org.opencastproject.util.RestUtil.R.ok;
import static org.opencastproject.util.RestUtil.getResponseType;

import org.opencastproject.job.api.Incident;
import org.opencastproject.job.api.Incident.Severity;
import org.opencastproject.job.api.IncidentTree;
import org.opencastproject.job.api.JaxbIncident;
import org.opencastproject.job.api.JaxbIncidentDigestList;
import org.opencastproject.job.api.JaxbIncidentFullList;
import org.opencastproject.job.api.JaxbIncidentFullTree;
import org.opencastproject.job.api.JaxbIncidentList;
import org.opencastproject.job.api.JaxbIncidentTree;
import org.opencastproject.job.api.Job;
import org.opencastproject.job.api.JobParser;
import org.opencastproject.rest.RestConstants;
import org.opencastproject.serviceregistry.api.IncidentL10n;
import org.opencastproject.serviceregistry.api.IncidentService;
import org.opencastproject.serviceregistry.api.IncidentServiceException;
import org.opencastproject.serviceregistry.api.ServiceRegistry;
import org.opencastproject.systems.OpencastConstants;
import org.opencastproject.util.DateTimeSupport;
import org.opencastproject.util.LocalHashMap;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.UrlSupport;
import org.opencastproject.util.data.Tuple;
import org.opencastproject.util.doc.rest.RestParameter;
import org.opencastproject.util.doc.rest.RestParameter.Type;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestResponse;
import org.opencastproject.util.doc.rest.RestService;

import org.apache.commons.lang3.LocaleUtils;
import org.apache.commons.lang3.StringUtils;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.JSONValue;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.jaxrs.whiteboard.propertytypes.JaxrsResource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.net.URI;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.ws.rs.DefaultValue;
import javax.ws.rs.FormParam;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.WebApplicationException;
import javax.ws.rs.core.Context;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.Response.Status;

/** REST endpoint for Incident Service. */
@Path(&quot;/incidents&quot;)
@RestService(name = &quot;incidentservice&quot;, title = &quot;Incident Service&quot;, abstractText = &quot;This service creates, edits and retrieves and helps managing incidents.&quot;, notes = {
        &quot;All paths above are relative to the REST endpoint base (something like http://your.server/files)&quot;,
        &quot;If the service is down or not working it will return a status 503, this means the the underlying service is &quot;
                + &quot;not working and is either restarting or has failed&quot;,
        &quot;A status code 500 means a general failure has occurred which is not recoverable and was not anticipated. In &quot;
                + &quot;other words, there is a bug! You should file an error report with your server logs from the time when the &quot;
                + &quot;error occurred: &lt;a href=\&quot;https://github.com/opencast/opencast/issues\&quot;&gt;Opencast Issue Tracker&lt;/a&gt;&quot;})
@Component(
  property = {
    &quot;service.description=Incident Service REST Endpoint&quot;,
    &quot;opencast.service.type=org.opencastproject.incident&quot;,
    &quot;opencast.service.path=/incidents&quot;
  },
  immediate = true,
  service = { IncidentServiceEndpoint.class }
)
@JaxrsResource
<span class="nc" id="L116">public class IncidentServiceEndpoint {</span>
  /** Logging utility */
<span class="nc" id="L118">  private static final Logger logger = LoggerFactory.getLogger(IncidentServiceEndpoint.class);</span>

  public static final String FMT_FULL = &quot;full&quot;;
  public static final String FMT_DIGEST = &quot;digest&quot;;
  public static final String FMT_SYS = &quot;sys&quot;;
  private static final String FMT_DEFAULT = FMT_SYS;

  /** The incident service */
  protected IncidentService svc;

  /** The remote service manager */
<span class="nc" id="L129">  protected ServiceRegistry serviceRegistry = null;</span>

  /** This server's base URL */
<span class="nc" id="L132">  protected String serverUrl = UrlSupport.DEFAULT_BASE_URL;</span>

  /** The REST endpoint's base URL */
<span class="nc" id="L135">  protected String serviceUrl = &quot;/incidents&quot;;</span>

  /** OSGi callback for setting the incident service. */
  @Reference
  public void setIncidentService(IncidentService incidentService) {
<span class="nc" id="L140">    this.svc = incidentService;</span>
<span class="nc" id="L141">  }</span>

  /**
   * The method that is called, when the service is activated
   *
   * @param cc
   *         The ComponentContext of this service
   */
  public void activate(ComponentContext cc) {
    // Get the configured server URL
<span class="nc bnc" id="L151" title="All 2 branches missed.">    if (cc != null) {</span>
<span class="nc" id="L152">      String ccServerUrl = cc.getBundleContext().getProperty(OpencastConstants.SERVER_URL_PROPERTY);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">      if (StringUtils.isNotBlank(ccServerUrl))</span>
<span class="nc" id="L154">        serverUrl = ccServerUrl;</span>
<span class="nc" id="L155">      serviceUrl = (String) cc.getProperties().get(RestConstants.SERVICE_PATH_PROPERTY);</span>
    }
<span class="nc" id="L157">  }</span>

  @GET
  @Produces({MediaType.APPLICATION_XML, MediaType.APPLICATION_JSON})
  @Path(&quot;job/incidents.{type:xml|json}&quot;)
  @RestQuery(name = &quot;incidentsofjobaslist&quot;,
             description = &quot;Returns the job incidents with the given identifiers.&quot;,
             returnDescription = &quot;Returns the job incidents.&quot;,
             pathParameters = {
                     @RestParameter(name = &quot;type&quot;, isRequired = true,
                                    description = &quot;The media type of the response [xml|json]&quot;,
                                    defaultValue = &quot;xml&quot;,
                                    type = Type.STRING)},
             restParameters = {
                     @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;The job identifiers.&quot;, type = Type.INTEGER),
                     @RestParameter(name = &quot;format&quot;, isRequired = false,
                                    description = &quot;The response format [full|digest|sys]. Defaults to sys&quot;,
                                    defaultValue = &quot;sys&quot;,
                                    type = Type.STRING)},
             responses = {
                     @RestResponse(responseCode = SC_OK, description = &quot;The job incidents.&quot;)})
  public Response getIncidentsOfJobAsList(
          @Context HttpServletRequest request,
          @QueryParam(&quot;id&quot;) final List&lt;Long&gt; jobIds,
          @QueryParam(&quot;format&quot;) @DefaultValue(FMT_DEFAULT) final String format,
          @PathParam(&quot;type&quot;) final String type) {
    try {
<span class="nc" id="L184">      final List&lt;Incident&gt; incidents = svc.getIncidentsOfJob(jobIds);</span>
<span class="nc" id="L185">      final MediaType mt = getResponseType(type);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">      if (eq(FMT_SYS, format)) {</span>
<span class="nc" id="L187">        return ok(mt, new JaxbIncidentList(incidents));</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">      } else if (eq(FMT_DIGEST, format)) {</span>
<span class="nc" id="L189">        return ok(mt, new JaxbIncidentDigestList(svc, request.getLocale(), incidents));</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">      } else if (eq(FMT_FULL, format)) {</span>
<span class="nc" id="L191">        return ok(mt, new JaxbIncidentFullList(svc, request.getLocale(), incidents));</span>
      } else {
<span class="nc" id="L193">        return unknownFormat();</span>
      }
<span class="nc" id="L195">    } catch (NotFoundException e) {</span>
      // should not happen
<span class="nc" id="L197">      logger.error(&quot;Unable to get job incident! Consistency issue!&quot;, e);</span>
<span class="nc" id="L198">      throw new WebApplicationException(e, INTERNAL_SERVER_ERROR);</span>
<span class="nc" id="L199">    } catch (IncidentServiceException e) {</span>
<span class="nc" id="L200">      logger.warn(&quot;Unable to get job incident for id {}: {}&quot;, jobIds, e.getMessage());</span>
<span class="nc" id="L201">      throw new WebApplicationException(INTERNAL_SERVER_ERROR);</span>
    }
  }

  @GET
  @Produces({MediaType.APPLICATION_XML, MediaType.APPLICATION_JSON})
  @Path(&quot;job/{id}.{type:xml|json}&quot;)
  @RestQuery(name = &quot;incidentsofjobastree&quot;,
             description = &quot;Returns the job incident for the job with the given identifier.&quot;,
             returnDescription = &quot;Returns the job incident.&quot;,
             pathParameters = {
                     @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;The job identifier.&quot;, type = Type.INTEGER),
                     @RestParameter(name = &quot;type&quot;, isRequired = true,
                                    description = &quot;The media type of the response [xml|json]&quot;,
                                    defaultValue = &quot;xml&quot;,
                                    type = Type.STRING)},
             restParameters = {
                     @RestParameter(name = &quot;cascade&quot;, isRequired = false, description = &quot;Whether to show the cascaded incidents.&quot;,
                                    type = Type.BOOLEAN, defaultValue = &quot;false&quot;),
                     @RestParameter(name = &quot;format&quot;, isRequired = false,
                                    description = &quot;The response format [full|digest|sys]. Defaults to sys&quot;,
                                    defaultValue = &quot;sys&quot;,
                                    type = Type.STRING)},
             responses = {
                     @RestResponse(responseCode = SC_OK, description = &quot;The job incident.&quot;),
                     @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No job incident with this identifier was found.&quot;)})
  public Response getIncidentsOfJobAsTree(
          @Context HttpServletRequest request,
          @PathParam(&quot;id&quot;) final long jobId,
          @QueryParam(&quot;cascade&quot;) @DefaultValue(&quot;false&quot;) boolean cascade,
          @QueryParam(&quot;format&quot;) @DefaultValue(FMT_DEFAULT) final String format,
          @PathParam(&quot;type&quot;) final String type)
          throws NotFoundException {
    try {
<span class="nc" id="L235">      final IncidentTree tree = svc.getIncidentsOfJob(jobId, cascade);</span>
<span class="nc" id="L236">      final MediaType mt = getResponseType(type);</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">      if (eq(FMT_SYS, format)) {</span>
<span class="nc" id="L238">        return ok(mt, new JaxbIncidentTree(tree));</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">      } else if (eq(FMT_DIGEST, format)) {</span>
<span class="nc" id="L240">        return ok(mt, new JaxbIncidentFullTree(svc, request.getLocale(), tree));</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">      } else if (eq(FMT_FULL, format)) {</span>
<span class="nc" id="L242">        return ok(mt, new JaxbIncidentFullTree(svc, request.getLocale(), tree));</span>
      } else {
<span class="nc" id="L244">        return unknownFormat();</span>
      }
<span class="nc" id="L246">    } catch (IncidentServiceException e) {</span>
<span class="nc" id="L247">      logger.warn(&quot;Unable to get job incident for id {}: {}&quot;, jobId, e.getMessage());</span>
<span class="nc" id="L248">      throw new WebApplicationException(INTERNAL_SERVER_ERROR);</span>
    }
  }

  @GET
  @Produces({MediaType.APPLICATION_XML, MediaType.APPLICATION_JSON})
  @Path(&quot;{id}.{type:xml|json}&quot;)
  @RestQuery(name = &quot;incidentjson&quot;,
             description = &quot;Returns the job incident by it's incident identifier.&quot;,
             returnDescription = &quot;Returns the job incident.&quot;,
             pathParameters = {
                     @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;The incident identifier.&quot;, type = Type.INTEGER),
                     @RestParameter(name = &quot;type&quot;, isRequired = true,
                                    description = &quot;The media type of the response [xml|json]&quot;,
                                    defaultValue = &quot;xml&quot;,
                                    type = Type.STRING)},
             responses = {
                     @RestResponse(responseCode = SC_OK, description = &quot;The job incident.&quot;),
                     @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No job incident with this identifier was found.&quot;)})
  public Response getIncident(@PathParam(&quot;id&quot;) final long incidentId, @PathParam(&quot;type&quot;) final String type)
          throws NotFoundException {
    try {
<span class="nc" id="L270">      Incident incident = svc.getIncident(incidentId);</span>
<span class="nc" id="L271">      return ok(getResponseType(type), new JaxbIncident(incident));</span>
<span class="nc" id="L272">    } catch (IncidentServiceException e) {</span>
<span class="nc" id="L273">      logger.warn(&quot;Unable to get job incident for incident id {}&quot;, incidentId, e);</span>
<span class="nc" id="L274">      throw new WebApplicationException(INTERNAL_SERVER_ERROR);</span>
    }
  }

  @GET
  @SuppressWarnings(&quot;unchecked&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @Path(&quot;localization/{id}&quot;)
  @RestQuery(name = &quot;getlocalization&quot;,
             description = &quot;Returns the localization of an incident by it's id as JSON&quot;,
             returnDescription = &quot;The localization of the incident as JSON&quot;,
             pathParameters = {
                     @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;The incident identifiers.&quot;, type = Type.INTEGER)},
             restParameters = {
                     @RestParameter(name = &quot;locale&quot;, isRequired = true, description = &quot;The locale.&quot;, type = Type.STRING)},
             responses = {
                     @RestResponse(responseCode = SC_OK, description = &quot;The localization of the given job incidents.&quot;),
                     @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No job incident with this incident identifier was found.&quot;)})
  public Response getLocalization(@PathParam(&quot;id&quot;) final long incidentId, @QueryParam(&quot;locale&quot;) String locale)
          throws NotFoundException {
    try {
<span class="nc" id="L295">      IncidentL10n localization = svc.getLocalization(incidentId, LocaleUtils.toLocale(locale));</span>
<span class="nc" id="L296">      JSONObject json = new JSONObject();</span>
<span class="nc" id="L297">      json.put(&quot;title&quot;, localization.getTitle());</span>
<span class="nc" id="L298">      json.put(&quot;description&quot;, localization.getDescription());</span>
<span class="nc" id="L299">      return Response.ok(json.toJSONString()).build();</span>
<span class="nc" id="L300">    } catch (IncidentServiceException e) {</span>
<span class="nc" id="L301">      logger.warn(&quot;Unable to get job localization of jo incident:&quot;, e);</span>
<span class="nc" id="L302">      throw new WebApplicationException(INTERNAL_SERVER_ERROR);</span>
    }
  }

  @POST
  @Produces(MediaType.APPLICATION_XML)
  @Path(&quot;/&quot;)
  @RestQuery(name = &quot;postincident&quot;, description = &quot;Creates a new job incident and returns it as XML&quot;, returnDescription = &quot;Returns the created job incident as XML&quot;, restParameters = {
          @RestParameter(name = &quot;job&quot;, isRequired = true, description = &quot;The job on where to create the incident&quot;, type = Type.TEXT),
          @RestParameter(name = &quot;date&quot;, isRequired = true, description = &quot;The incident creation date&quot;, type = Type.STRING),
          @RestParameter(name = &quot;code&quot;, isRequired = true, description = &quot;The incident error code&quot;, type = Type.STRING),
          @RestParameter(name = &quot;severity&quot;, isRequired = true, description = &quot;The incident error code&quot;, type = Type.STRING),
          @RestParameter(name = &quot;details&quot;, isRequired = false, description = &quot;The incident details&quot;, type = Type.TEXT),
          @RestParameter(name = &quot;params&quot;, isRequired = false, description = &quot;The incident parameters&quot;, type = Type.TEXT)}, responses = {
          @RestResponse(responseCode = SC_CREATED, description = &quot;New job incident has been created&quot;),
          @RestResponse(responseCode = SC_BAD_REQUEST, description = &quot;Unable to parse the one of the form params&quot;),
          @RestResponse(responseCode = SC_CONFLICT, description = &quot;No job incident related job exists&quot;)})
  public Response postIncident(@FormParam(&quot;job&quot;) String jobXml, @FormParam(&quot;date&quot;) String date,
                               @FormParam(&quot;code&quot;) String code, @FormParam(&quot;severity&quot;) String severityString,
                               @FormParam(&quot;details&quot;) String details, @FormParam(&quot;params&quot;) LocalHashMap params) {
    Job job;
    Date timestamp;
    Severity severity;
<span class="nc" id="L325">    Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L326">    List&lt;Tuple&lt;String, String&gt;&gt; list = new ArrayList&lt;Tuple&lt;String, String&gt;&gt;();</span>
    try {
<span class="nc" id="L328">      job = JobParser.parseJob(jobXml);</span>
<span class="nc" id="L329">      timestamp = new Date(DateTimeSupport.fromUTC(date));</span>
<span class="nc" id="L330">      severity = Severity.valueOf(severityString);</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">      if (params != null)</span>
<span class="nc" id="L332">        map = params.getMap();</span>

<span class="nc bnc" id="L334" title="All 2 branches missed.">      if (StringUtils.isNotBlank(details)) {</span>
<span class="nc" id="L335">        final JSONArray array = (JSONArray) JSONValue.parse(details);</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">        for (int i = 0; i &lt; array.size(); i++) {</span>
<span class="nc" id="L337">          JSONObject tuple = (JSONObject) array.get(i);</span>
<span class="nc" id="L338">          list.add(Tuple.tuple((String) tuple.get(&quot;title&quot;), (String) tuple.get(&quot;content&quot;)));</span>
        }
      }
<span class="nc" id="L341">    } catch (Exception e) {</span>
<span class="nc" id="L342">      return Response.status(Status.BAD_REQUEST).entity(e.getMessage()).build();</span>
<span class="nc" id="L343">    }</span>

    try {
<span class="nc" id="L346">      Incident incident = svc.storeIncident(job, timestamp, code, severity, map, list);</span>
<span class="nc" id="L347">      String uri = UrlSupport.concat(serverUrl, serviceUrl, Long.toString(incident.getId()), &quot;.xml&quot;);</span>
<span class="nc" id="L348">      return Response.created(new URI(uri)).entity(new JaxbIncident(incident)).build();</span>
<span class="nc" id="L349">    } catch (IllegalStateException e) {</span>
<span class="nc" id="L350">      return Response.status(Status.CONFLICT).build();</span>
<span class="nc" id="L351">    } catch (Exception e) {</span>
<span class="nc" id="L352">      logger.warn(&quot;Unable to post incident for job {}&quot;, job.getId(), e);</span>
<span class="nc" id="L353">      throw new WebApplicationException(INTERNAL_SERVER_ERROR);</span>
    }
  }

  private Response unknownFormat() {
<span class="nc" id="L358">    return badRequest(&quot;Unknown format&quot;);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>