<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ConfigurablePublishWorkflowOperationHandler.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-distribution-workflowoperation</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.workflow.handler.distribution</a> &gt; <span class="el_source">ConfigurablePublishWorkflowOperationHandler.java</span></div><h1>ConfigurablePublishWorkflowOperationHandler.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.workflow.handler.distribution;

import org.opencastproject.distribution.api.DistributionException;
import org.opencastproject.distribution.api.DownloadDistributionService;
import org.opencastproject.distribution.api.StreamingDistributionService;
import org.opencastproject.job.api.Job;
import org.opencastproject.job.api.JobContext;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.mediapackage.MediaPackageElement;
import org.opencastproject.mediapackage.MediaPackageElementFlavor;
import org.opencastproject.mediapackage.MediaPackageElementParser;
import org.opencastproject.mediapackage.MediaPackageException;
import org.opencastproject.mediapackage.Publication;
import org.opencastproject.mediapackage.PublicationImpl;
import org.opencastproject.mediapackage.selector.SimpleElementSelector;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.serviceregistry.api.ServiceRegistry;
import org.opencastproject.util.MimeType;
import org.opencastproject.util.MimeTypes;
import org.opencastproject.util.RequireUtil;
import org.opencastproject.util.doc.DocUtil;
import org.opencastproject.workflow.api.WorkflowInstance;
import org.opencastproject.workflow.api.WorkflowOperationException;
import org.opencastproject.workflow.api.WorkflowOperationHandler;
import org.opencastproject.workflow.api.WorkflowOperationInstance;
import org.opencastproject.workflow.api.WorkflowOperationResult;
import org.opencastproject.workflow.api.WorkflowOperationResult.Action;

import org.apache.commons.lang3.ArrayUtils;
import org.apache.commons.lang3.BooleanUtils;
import org.apache.commons.lang3.StringUtils;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.net.URI;
import java.net.URISyntaxException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.UUID;

/**
 * WOH that distributes selected elements to an internal distribution channel and adds reflective publication elements
 * to the media package.
 */

@Component(
    immediate = true,
    service = WorkflowOperationHandler.class,
    property = {
        &quot;service.description=Configurable Publication Workflow Handler&quot;,
        &quot;workflow.operation=publish-configure&quot;
    }
)
<span class="fc" id="L82">public class ConfigurablePublishWorkflowOperationHandler extends ConfigurableWorkflowOperationHandlerBase {</span>

  /** The logging facility */
<span class="fc" id="L85">  private static final Logger logger = LoggerFactory.getLogger(ConfigurablePublishWorkflowOperationHandler.class);</span>

  /** The template key for adding the mediapackage / event id to the publication path. */
  protected static final String EVENT_ID_TEMPLATE_KEY = &quot;event_id&quot;;
  /** The template key for adding the player location path to the publication path. */
  protected static final String PLAYER_PATH_TEMPLATE_KEY = &quot;player_path&quot;;
  /** The template key for adding the publication id to the publication path. */
  protected static final String PUBLICATION_ID_TEMPLATE_KEY = &quot;publication_id&quot;;
  /** The template key for adding the series id to the publication path. */
  protected static final String SERIES_ID_TEMPLATE_KEY = &quot;series_id&quot;;
  /** The configuration property value for the player location. */
  protected static final String PLAYER_PROPERTY = &quot;player&quot;;
  /** The template key name prefix for organization keys */
  protected static final String ORG_TEMPLATE_KEY_PREFIX = &quot;org_&quot;;

  // service references
  private DownloadDistributionService downloadDistributionService;
  private StreamingDistributionService streamingDistributionService;
  private SecurityService securityService;

  /** Workflow configuration options */
  static final String DOWNLOAD_SOURCE_FLAVORS = &quot;download-source-flavors&quot;;
  static final String DOWNLOAD_SOURCE_TAGS = &quot;download-source-tags&quot;;
  static final String STREAMING_SOURCE_TAGS = &quot;streaming-source-tags&quot;;
  static final String STREAMING_SOURCE_FLAVORS = &quot;streaming-source-flavors&quot;;
  static final String CHANNEL_ID_KEY = &quot;channel-id&quot;;
  static final String MIME_TYPE = &quot;mimetype&quot;;
  static final String WITH_PUBLISHED_ELEMENTS = &quot;with-published-elements&quot;;
  static final String CHECK_AVAILABILITY = &quot;check-availability&quot;;
  static final String STRATEGY = &quot;strategy&quot;;
  static final String MODE = &quot;mode&quot;;

  /** Known values for mode **/
  static final String MODE_SINGLE = &quot;single&quot;;
  static final String MODE_MIXED = &quot;mixed&quot;;
  static final String MODE_BULK = &quot;bulk&quot;;

<span class="fc" id="L122">  static final String[] KNOWN_MODES = { MODE_SINGLE, MODE_MIXED, MODE_BULK };</span>

  static final String DEFAULT_MODE = MODE_BULK;

  /** The workflow configuration key for defining the url pattern. */
  static final String URL_PATTERN = &quot;url-pattern&quot;;

  static final String RETRACT_STREAMING = &quot;retract-streaming&quot;;
  static final boolean RETRACT_STREAMING_DEFAULT = false;

  /** OSGi DI */
  @Reference(target = &quot;(distribution.channel=download)&quot;)
  void setDownloadDistributionService(DownloadDistributionService distributionService) {
<span class="fc" id="L135">    this.downloadDistributionService = distributionService;</span>
<span class="fc" id="L136">  }</span>

  @Reference(target = &quot;(distribution.channel=streaming)&quot;)
  void setStreamingDistributionService(StreamingDistributionService streamingDistributionService) {
<span class="fc" id="L140">    this.streamingDistributionService = streamingDistributionService;</span>
<span class="fc" id="L141">  }</span>

  /** OSGi DI */
  @Reference
  protected void setSecurityService(SecurityService securityService) {
<span class="fc" id="L146">    this.securityService = securityService;</span>
<span class="fc" id="L147">  }</span>

  @Override
  protected DownloadDistributionService getDownloadDistributionService() {
<span class="nc bnc" id="L151" title="All 2 branches missed.">    assert (downloadDistributionService != null);</span>
<span class="nc" id="L152">    return downloadDistributionService;</span>
  }

  @Override
  protected StreamingDistributionService getStreamingDistributionService() {
<span class="nc bnc" id="L157" title="All 2 branches missed.">    assert (streamingDistributionService != null);</span>
<span class="nc" id="L158">    return streamingDistributionService;</span>
  }

  /**
   * Replace possible variables in the url-pattern configuration for this workflow operation handler.
   *
   * @param urlPattern
   *          The operation's template for replacing the variables.
   * @param mp
   *          The {@link MediaPackage} used to get the event / mediapackage id.
   * @param pubUUID
   *          The UUID for the published element.
   * @return The URI of the published element with the variables replaced.
   * @throws WorkflowOperationException
   *           Thrown if the URI is malformed after replacing the variables.
   */
  public URI populateUrlWithVariables(String urlPattern, MediaPackage mp, String pubUUID)
          throws WorkflowOperationException {
<span class="fc" id="L176">    Map&lt;String, Object&gt; values = new HashMap&lt;&gt;();</span>
<span class="fc" id="L177">    values.put(EVENT_ID_TEMPLATE_KEY, mp.getIdentifier().toString());</span>
<span class="fc" id="L178">    values.put(PUBLICATION_ID_TEMPLATE_KEY, pubUUID);</span>
<span class="fc" id="L179">    String playerPath = securityService.getOrganization().getProperties().get(PLAYER_PROPERTY);</span>
<span class="fc" id="L180">    values.put(PLAYER_PATH_TEMPLATE_KEY, playerPath);</span>
<span class="fc" id="L181">    values.put(SERIES_ID_TEMPLATE_KEY, StringUtils.trimToEmpty(mp.getSeries()));</span>
<span class="fc" id="L182">    Map&lt;String, String&gt; orgProperties = securityService.getOrganization().getProperties();</span>
<span class="fc" id="L183">    orgProperties.put(&quot;id&quot;, securityService.getOrganization().getId());</span>
<span class="fc" id="L184">    orgProperties.put(&quot;name&quot;, securityService.getOrganization().getName());</span>
<span class="fc" id="L185">    orgProperties.put(&quot;admin_role&quot;, securityService.getOrganization().getAdminRole());</span>
<span class="fc" id="L186">    orgProperties.put(&quot;anonymous_role&quot;, securityService.getOrganization().getAnonymousRole());</span>
<span class="fc bfc" id="L187" title="All 2 branches covered.">    for (Map.Entry&lt;String, String&gt; orgProperty : orgProperties.entrySet()) {</span>
<span class="fc" id="L188">      values.put(ORG_TEMPLATE_KEY_PREFIX + orgProperty.getKey().replace('.', '_').toLowerCase(),</span>
<span class="fc" id="L189">              orgProperty.getValue());</span>
<span class="fc" id="L190">    }</span>
<span class="fc" id="L191">    String uriWithVariables = DocUtil.processTextTemplate(&quot;Replacing Variables in Publish URL&quot;, urlPattern, values);</span>
    URI publicationURI;
    try {
<span class="fc" id="L194">      publicationURI = new URI(uriWithVariables);</span>
<span class="nc" id="L195">    } catch (URISyntaxException e) {</span>
<span class="nc" id="L196">      throw new WorkflowOperationException(String.format(</span>
              &quot;Unable to create URI from template '%s', replacement was: '%s'&quot;, urlPattern, uriWithVariables), e);
<span class="fc" id="L198">    }</span>
<span class="fc" id="L199">    return publicationURI;</span>
  }

  @Override
  public WorkflowOperationResult start(WorkflowInstance workflowInstance, JobContext context)
          throws WorkflowOperationException {
<span class="fc" id="L205">    RequireUtil.notNull(workflowInstance, &quot;workflowInstance&quot;);</span>

<span class="fc" id="L207">    final MediaPackage mp = workflowInstance.getMediaPackage();</span>
<span class="fc" id="L208">    final WorkflowOperationInstance op = workflowInstance.getCurrentOperation();</span>

<span class="fc" id="L210">    final String channelId = StringUtils.trimToEmpty(op.getConfiguration(CHANNEL_ID_KEY));</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">    if (&quot;&quot;.equals(channelId)) {</span>
<span class="fc" id="L212">      throw new WorkflowOperationException(&quot;Unable to publish this mediapackage as the configuration key &quot;</span>
              + CHANNEL_ID_KEY + &quot; is missing. Unable to determine where to publish these elements.&quot;);
    }

<span class="fc" id="L216">    final String urlPattern = StringUtils.trimToEmpty(op.getConfiguration(URL_PATTERN));</span>

<span class="fc" id="L218">    MimeType mimetype = null;</span>
<span class="fc" id="L219">    String mimetypeString = StringUtils.trimToEmpty(op.getConfiguration(MIME_TYPE));</span>
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">    if (!&quot;&quot;.equals(mimetypeString)) {</span>
      try {
<span class="fc" id="L222">        mimetype = MimeTypes.parseMimeType(mimetypeString);</span>
<span class="nc" id="L223">      } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L224">        throw new WorkflowOperationException(&quot;Unable to parse the provided configuration for &quot; + MIME_TYPE, e);</span>
<span class="fc" id="L225">      }</span>
    }

<span class="fc" id="L228">    final boolean withPublishedElements = BooleanUtils</span>
<span class="fc" id="L229">            .toBoolean(StringUtils.trimToEmpty(op.getConfiguration(WITH_PUBLISHED_ELEMENTS)));</span>

<span class="fc" id="L231">    boolean checkAvailability = BooleanUtils</span>
<span class="fc" id="L232">            .toBoolean(StringUtils.trimToEmpty(op.getConfiguration(CHECK_AVAILABILITY)));</span>

<span class="fc" id="L234">    boolean retractStreaming = RETRACT_STREAMING_DEFAULT;</span>
<span class="fc" id="L235">    String retractStreamingString = workflowInstance.getConfiguration(RETRACT_STREAMING);</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">    if (retractStreamingString != null) {</span>
<span class="nc" id="L237">      retractStreaming = BooleanUtils.toBoolean(StringUtils.trimToEmpty(retractStreamingString));</span>
    }

<span class="pc bpc" id="L240" title="1 of 2 branches missed.">    if (getPublications(mp, channelId).size() &gt; 0) {</span>
<span class="fc" id="L241">      final String rePublishStrategy = StringUtils.trimToEmpty(op.getConfiguration(STRATEGY));</span>

<span class="pc bpc" id="L243" title="2 of 3 branches missed.">      switch (rePublishStrategy) {</span>

        case (&quot;fail&quot;):
          // fail is a dummy function for further distribution strategies
<span class="nc" id="L247">          fail(mp);</span>
<span class="nc" id="L248">          break;</span>
        case (&quot;merge&quot;):
          // nothing to do here. other publication strategies can be added to this list later on
<span class="nc" id="L251">          break;</span>
        default:
<span class="fc" id="L253">          retract(mp, channelId, retractStreaming);</span>
      }
    }

<span class="fc" id="L257">    String mode = StringUtils.trimToEmpty(op.getConfiguration(MODE));</span>
<span class="pc bpc" id="L258" title="1 of 2 branches missed.">    if (&quot;&quot;.equals(mode)) {</span>
<span class="nc" id="L259">      mode = DEFAULT_MODE;</span>
<span class="pc bpc" id="L260" title="1 of 2 branches missed.">    } else if (!ArrayUtils.contains(KNOWN_MODES, mode)) {</span>
<span class="nc" id="L261">      logger.error(&quot;Unknown value for configuration key mode: '{}'&quot;, mode);</span>
<span class="nc" id="L262">      throw new IllegalArgumentException(&quot;Unknown value for configuration key mode&quot;);</span>
    }

<span class="fc" id="L265">    final String[] downloadSourceFlavors</span>
<span class="fc" id="L266">        = StringUtils.split(StringUtils.trimToEmpty(op.getConfiguration(DOWNLOAD_SOURCE_FLAVORS)), &quot;,&quot;);</span>
<span class="fc" id="L267">    final String[] downloadSourceTags</span>
<span class="fc" id="L268">        = StringUtils.split(StringUtils.trimToEmpty(op.getConfiguration(DOWNLOAD_SOURCE_TAGS)), &quot;,&quot;);</span>
<span class="fc" id="L269">    final String[] streamingSourceFlavors</span>
<span class="fc" id="L270">        = StringUtils.split(StringUtils.trimToEmpty(op.getConfiguration(STREAMING_SOURCE_FLAVORS)), &quot;,&quot;);</span>
<span class="fc" id="L271">    final String[] streamingSourceTags</span>
<span class="fc" id="L272">        = StringUtils.split(StringUtils.trimToEmpty(op.getConfiguration(STREAMING_SOURCE_TAGS)), &quot;,&quot;);</span>

<span class="fc" id="L274">    String publicationUUID = UUID.randomUUID().toString();</span>
<span class="fc" id="L275">    Publication publication = PublicationImpl.publication(publicationUUID, channelId, null, null);</span>

    // Configure the element selectors
<span class="fc" id="L278">    final SimpleElementSelector downloadSelector = new SimpleElementSelector();</span>
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">    for (String flavor : downloadSourceFlavors) {</span>
<span class="nc" id="L280">      downloadSelector.addFlavor(MediaPackageElementFlavor.parseFlavor(flavor));</span>
    }
<span class="fc bfc" id="L282" title="All 2 branches covered.">    for (String tag : downloadSourceTags) {</span>
<span class="fc" id="L283">      downloadSelector.addTag(tag);</span>
    }

<span class="fc" id="L286">    final SimpleElementSelector streamingSelector = new SimpleElementSelector();</span>
<span class="pc bpc" id="L287" title="1 of 2 branches missed.">    for (String flavor : streamingSourceFlavors) {</span>
<span class="nc" id="L288">      streamingSelector.addFlavor(MediaPackageElementFlavor.parseFlavor(flavor));</span>
    }
<span class="fc bfc" id="L290" title="All 2 branches covered.">    for (String tag : streamingSourceTags) {</span>
<span class="fc" id="L291">      streamingSelector.addTag(tag);</span>
    }

<span class="fc" id="L294">    boolean streamingElementsDistributed = false;</span>
<span class="fc" id="L295">    boolean downloadElementsDistributed = false;</span>

<span class="pc bpc" id="L297" title="4 of 8 branches missed.">    if (streamingDistributionService != null &amp;&amp; streamingDistributionService.publishToStreaming()</span>
            &amp;&amp; (streamingSourceFlavors.length &gt; 0 || streamingSourceTags.length &gt; 0)) {
<span class="fc" id="L299">      streamingElementsDistributed = distributeElements(streamingSelector, mp, publication, channelId, mode,</span>
              withPublishedElements, checkAvailability, true);
    }

<span class="pc bpc" id="L303" title="2 of 4 branches missed.">    if (downloadSourceFlavors.length &gt; 0 || downloadSourceTags.length &gt; 0) {</span>
<span class="fc" id="L304">      downloadElementsDistributed = distributeElements(downloadSelector, mp, publication, channelId, mode,</span>
              withPublishedElements, checkAvailability, false);
    }

<span class="pc bpc" id="L308" title="11 of 12 branches missed.">    if (!downloadElementsDistributed &amp;&amp; !streamingElementsDistributed</span>
        &amp;&amp; (downloadSourceFlavors.length &gt; 0 || downloadSourceTags.length &gt; 0
        || streamingSourceFlavors.length &gt; 0 || streamingSourceTags.length &gt; 0)) {
      // skip publication if no elements was distributed but should be
<span class="nc" id="L312">      return createResult(mp, Action.SKIP);</span>
    }

<span class="pc bpc" id="L315" title="1 of 2 branches missed.">    if (!&quot;&quot;.equals(urlPattern)) {</span>
<span class="fc" id="L316">      publication.setURI(populateUrlWithVariables(urlPattern, mp, publicationUUID));</span>
    }
<span class="pc bpc" id="L318" title="1 of 2 branches missed.">    if (mimetype != null) {</span>
<span class="fc" id="L319">      publication.setMimeType(mimetype);</span>
    }
<span class="fc" id="L321">    mp.add(publication);</span>
<span class="fc" id="L322">    return createResult(mp, Action.CONTINUE);</span>
  }

  private boolean distributeElements(SimpleElementSelector selector, MediaPackage mp, Publication publication,
          String channelId, String mode, boolean withPublishedElements, boolean checkAvailability, boolean streaming)
          throws WorkflowOperationException {

<span class="fc bfc" id="L329" title="All 2 branches covered.">    String target = (streaming ? &quot;streaming&quot; : &quot;download&quot;);</span>
<span class="pc bpc" id="L330" title="1 of 2 branches missed.">    if (!withPublishedElements) {</span>
<span class="fc" id="L331">      Set&lt;MediaPackageElement&gt; elements = distribute(selector.select(mp, false), mp, channelId, mode,</span>
              checkAvailability, streaming);
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">      if (elements.size() &gt; 0) {</span>
<span class="fc bfc" id="L334" title="All 2 branches covered.">        for (MediaPackageElement element : elements) {</span>
          // Make sure the mediapackage is prompted to create a new identifier for this element
<span class="fc" id="L336">          element.setIdentifier(null);</span>
<span class="fc" id="L337">          PublicationImpl.addElementToPublication(publication, element);</span>
<span class="fc" id="L338">        }</span>
      } else {
<span class="nc" id="L340">        logger.info(&quot;No element found for distribution to &quot; + target + &quot; in media package '{}'&quot;, mp);</span>
<span class="nc" id="L341">        return false;</span>
      }
<span class="fc" id="L343">    } else {</span>
<span class="nc" id="L344">      List&lt;MediaPackageElement&gt; publishedElements = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">      for (Publication alreadyPublished : mp.getPublications()) {</span>
<span class="nc" id="L346">        publishedElements.addAll(Arrays.asList(alreadyPublished.getAttachments()));</span>
<span class="nc" id="L347">        publishedElements.addAll(Arrays.asList(alreadyPublished.getCatalogs()));</span>
<span class="nc" id="L348">        publishedElements.addAll(Arrays.asList(alreadyPublished.getTracks()));</span>
      }

<span class="nc" id="L351">      Collection&lt;MediaPackageElement&gt; elements = selector.select(publishedElements, false);</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">      if (elements.size() &gt; 0) {</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">        for (MediaPackageElement element : elements) {</span>
<span class="nc" id="L354">          PublicationImpl.addElementToPublication(publication, element);</span>
<span class="nc" id="L355">        }</span>
      } else {
<span class="nc" id="L357">        logger.info(&quot;No elements found for publication to &quot; + target + &quot; in media package '{}'&quot;, mp);</span>
<span class="nc" id="L358">        return false;</span>
      }
    }
<span class="fc" id="L361">    return true;</span>
  }

  private Set&lt;MediaPackageElement&gt; distribute(
      Collection&lt;MediaPackageElement&gt; elements,
      MediaPackage mediapackage,
      String channelId,
      String mode,
      boolean checkAvailability,
      boolean streaming
  ) throws WorkflowOperationException {

<span class="fc" id="L373">    Set&lt;MediaPackageElement&gt; result = new HashSet&lt;&gt;();</span>

<span class="fc" id="L375">    Set&lt;String&gt; bulkElementIds = new HashSet&lt;&gt;();</span>
<span class="fc" id="L376">    Set&lt;String&gt; singleElementIds = new HashSet&lt;&gt;();</span>

<span class="fc bfc" id="L378" title="All 2 branches covered.">    for (MediaPackageElement element : elements) {</span>
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">      if (MODE_BULK.equals(mode)</span>
<span class="pc bpc" id="L380" title="3 of 4 branches missed.">              || (MODE_MIXED.equals(mode) &amp;&amp; (element.getElementType() != MediaPackageElement.Type.Track))) {</span>
<span class="nc" id="L381">        bulkElementIds.add(element.getIdentifier());</span>
      } else {
<span class="fc" id="L383">        singleElementIds.add(element.getIdentifier());</span>
      }
<span class="fc" id="L385">    }</span>

<span class="fc" id="L387">    Set&lt;Job&gt; jobs = new HashSet&lt;&gt;();</span>
<span class="pc bpc" id="L388" title="1 of 2 branches missed.">    if (bulkElementIds.size() &gt; 0) {</span>
<span class="nc" id="L389">      logger.info(&quot;Start bulk publishing of {} elements of media package '{}' to publication channel '{}'&quot;,</span>
<span class="nc" id="L390">              bulkElementIds.size(), mediapackage, channelId);</span>
      try {
        Job job;
<span class="nc bnc" id="L393" title="All 2 branches missed.">        if (streaming) {</span>
<span class="nc" id="L394">          job = streamingDistributionService.distribute(channelId, mediapackage, bulkElementIds);</span>
        } else {
<span class="nc" id="L396">          job = downloadDistributionService.distribute(channelId, mediapackage, bulkElementIds, checkAvailability);</span>
        }
<span class="nc" id="L398">        jobs.add(job);</span>
<span class="nc" id="L399">      } catch (DistributionException | MediaPackageException e) {</span>
<span class="nc" id="L400">        logger.error(&quot;Creating the distribution job for {} elements of media package '{}' failed&quot;,</span>
<span class="nc" id="L401">                bulkElementIds.size(), mediapackage, e);</span>
<span class="nc" id="L402">        throw new WorkflowOperationException(e);</span>
<span class="nc" id="L403">      }</span>
    }
<span class="pc bpc" id="L405" title="1 of 2 branches missed.">    if (singleElementIds.size() &gt; 0) {</span>
<span class="fc" id="L406">      logger.info(&quot;Start single publishing of {} elements of media package '{}' to publication channel '{}'&quot;,</span>
<span class="fc" id="L407">              singleElementIds.size(), mediapackage, channelId);</span>
<span class="fc bfc" id="L408" title="All 2 branches covered.">      for (String elementId : singleElementIds) {</span>
        try {
          Job job;
<span class="fc bfc" id="L411" title="All 2 branches covered.">          if (streaming) {</span>
<span class="fc" id="L412">            job = streamingDistributionService.distribute(channelId, mediapackage, elementId);</span>
          } else {
<span class="fc" id="L414">            job = downloadDistributionService.distribute(channelId, mediapackage, elementId, checkAvailability);</span>
          }
<span class="fc" id="L416">          jobs.add(job);</span>
<span class="nc" id="L417">        } catch (DistributionException | MediaPackageException e) {</span>
<span class="nc" id="L418">          logger.error(&quot;Creating the distribution job for element '{}' of media package '{}' failed&quot;, elementId,</span>
                  mediapackage, e);
<span class="nc" id="L420">          throw new WorkflowOperationException(e);</span>
<span class="fc" id="L421">        }</span>
<span class="fc" id="L422">      }</span>
    }

<span class="pc bpc" id="L425" title="1 of 2 branches missed.">    if (jobs.size() &gt; 0) {</span>
<span class="pc bpc" id="L426" title="1 of 2 branches missed.">      if (!waitForStatus(jobs.toArray(new Job[jobs.size()])).isSuccess()) {</span>
<span class="nc" id="L427">        throw new WorkflowOperationException(&quot;At least one of the distribution jobs did not complete successfully&quot;);</span>
      }
<span class="fc bfc" id="L429" title="All 2 branches covered.">      for (Job job : jobs) {</span>
        try {
<span class="fc" id="L431">          List&lt;? extends MediaPackageElement&gt; elems = MediaPackageElementParser.getArrayFromXml(job.getPayload());</span>
<span class="fc" id="L432">          result.addAll(elems);</span>
<span class="nc" id="L433">        } catch (MediaPackageException e) {</span>
<span class="nc" id="L434">          logger.error(&quot;Job '{}' returned payload ({}) that could not be parsed to media package elements&quot;, job,</span>
<span class="nc" id="L435">                  job.getPayload(), e);</span>
<span class="nc" id="L436">          throw new WorkflowOperationException(e);</span>
<span class="fc" id="L437">        }</span>
<span class="fc" id="L438">      }</span>
<span class="fc" id="L439">      logger.info(&quot;Published {} elements of media package {} to publication channel {}&quot;,</span>
<span class="fc" id="L440">              bulkElementIds.size() + singleElementIds.size(), mediapackage, channelId);</span>
    }
<span class="fc" id="L442">    return result;</span>
  }

  /**
   * Dummy function for further publication strategies
   *
   * @param mp
   * @throws WorkflowOperationException
   */
  private void fail(MediaPackage mp) throws WorkflowOperationException {
<span class="nc" id="L452">    logger.error(&quot;There is already a Published Media, fail Stragy for Mediapackage {}&quot;, mp.getIdentifier());</span>
<span class="nc" id="L453">    throw new WorkflowOperationException(&quot;There is already a Published Media, fail Stragy for Mediapackage &quot;);</span>
  }

  @Reference
  @Override
  public void setServiceRegistry(ServiceRegistry serviceRegistry) {
<span class="fc" id="L459">    super.setServiceRegistry(serviceRegistry);</span>
<span class="fc" id="L460">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>