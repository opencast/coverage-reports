<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>JpaGroupRoleProvider.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-userdirectory</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.userdirectory</a> &gt; <span class="el_source">JpaGroupRoleProvider.java</span></div><h1>JpaGroupRoleProvider.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.userdirectory;

import org.opencastproject.db.DBSession;
import org.opencastproject.db.DBSessionFactory;
import org.opencastproject.security.api.Group;
import org.opencastproject.security.api.GroupProvider;
import org.opencastproject.security.api.JaxbGroupList;
import org.opencastproject.security.api.JaxbOrganization;
import org.opencastproject.security.api.JaxbRole;
import org.opencastproject.security.api.OrganizationDirectoryService;
import org.opencastproject.security.api.Role;
import org.opencastproject.security.api.RoleProvider;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.UnauthorizedException;
import org.opencastproject.security.api.UserDirectoryService;
import org.opencastproject.security.api.UserProvider;
import org.opencastproject.security.impl.jpa.JpaGroup;
import org.opencastproject.security.impl.jpa.JpaOrganization;
import org.opencastproject.security.impl.jpa.JpaRole;
import org.opencastproject.userdirectory.api.AAIRoleProvider;
import org.opencastproject.userdirectory.api.GroupRoleProvider;
import org.opencastproject.userdirectory.utils.UserDirectoryUtils;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.requests.SortCriterion;

import org.apache.commons.lang3.StringUtils;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.regex.Pattern;

import javax.persistence.EntityManagerFactory;

/**
 * Manages and locates users using JPA.
 */
@Component(
    property = {
        &quot;service.description=Provides a group role directory&quot;
    },
    immediate = true,
    service = { RoleProvider.class, JpaGroupRoleProvider.class }
)
<span class="fc" id="L76">public class JpaGroupRoleProvider implements AAIRoleProvider, GroupProvider, GroupRoleProvider {</span>

  /** The logger */
<span class="fc" id="L79">  private static final Logger logger = LoggerFactory.getLogger(JpaGroupRoleProvider.class);</span>

  /** The JPA persistence unit name */
  public static final String PERSISTENCE_UNIT = &quot;org.opencastproject.common&quot;;

  /** The security service */
<span class="fc" id="L85">  protected SecurityService securityService = null;</span>

  /** The factory used to generate the entity manager */
<span class="fc" id="L88">  protected EntityManagerFactory emf = null;</span>

  protected DBSessionFactory dbSessionFactory;

  protected DBSession db;

  /** The organization directory service */
  protected OrganizationDirectoryService organizationDirectoryService;

  /** The user directory service */
<span class="fc" id="L98">  protected UserDirectoryService userDirectoryService = null;</span>

  /** The component context */
  private ComponentContext cc;

  /** OSGi DI */
  @Reference(target = &quot;(osgi.unit.name=org.opencastproject.common)&quot;)
  public void setEntityManagerFactory(EntityManagerFactory emf) {
<span class="fc" id="L106">    this.emf = emf;</span>
<span class="fc" id="L107">  }</span>

  @Reference
  public void setDBSessionFactory(DBSessionFactory dbSessionFactory) {
<span class="fc" id="L111">    this.dbSessionFactory = dbSessionFactory;</span>
<span class="fc" id="L112">  }</span>

  /**
   * Sets the user directory service
   *
   * @param userDirectoryService
   *          the userDirectoryService to set
   */
  @Reference
  public void setUserDirectoryService(UserDirectoryService userDirectoryService) {
<span class="nc" id="L122">    this.userDirectoryService = userDirectoryService;</span>
<span class="nc" id="L123">  }</span>

  /**
   * @param securityService
   *          the securityService to set
   */
  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="fc" id="L131">    this.securityService = securityService;</span>
<span class="fc" id="L132">  }</span>

  /**
   * @param organizationDirectoryService
   *          the organizationDirectoryService to set
   */
  @Reference
  public void setOrganizationDirectoryService(OrganizationDirectoryService organizationDirectoryService) {
<span class="nc" id="L140">    this.organizationDirectoryService = organizationDirectoryService;</span>
<span class="nc" id="L141">  }</span>

  /**
   * Callback for activation of this component.
   *
   * @param cc
   *          the component context
   */
  @Activate
  public void activate(ComponentContext cc) {
<span class="fc" id="L151">    logger.debug(&quot;Activate group role provider&quot;);</span>
<span class="fc" id="L152">    this.cc = cc;</span>
<span class="fc" id="L153">    db = dbSessionFactory.createSession(emf);</span>
<span class="fc" id="L154">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.userdirectory.api.AAIRoleProvider#getRoles()
   */
  @Override
  public Iterator&lt;Role&gt; getRoles() {
<span class="nc" id="L163">    String orgId = securityService.getOrganization().getId();</span>
<span class="nc" id="L164">    List&lt;JpaGroup&gt; roles = db.exec(UserDirectoryPersistenceUtil.findGroupsQuery(orgId, 0, 0));</span>
<span class="nc" id="L165">    return getGroupsRoles(roles).iterator();</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.security.api.RoleProvider#getRolesForUser(String)
   */
  @Override
  public List&lt;Role&gt; getRolesForUser(String userName) {
<span class="fc" id="L175">    String orgId = securityService.getOrganization().getId();</span>
<span class="fc" id="L176">    List&lt;JpaGroup&gt; roles = db.exec(UserDirectoryPersistenceUtil.findGroupsByUserQuery(userName, orgId));</span>
<span class="fc" id="L177">    return getGroupsRoles(roles);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.security.api.RoleProvider#getRolesForUser(String)
   */
  @Override
  public List&lt;Role&gt; getRolesForGroup(String groupName) {
<span class="nc" id="L187">    List&lt;Role&gt; roles = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L188">    String orgId = securityService.getOrganization().getId();</span>
<span class="nc" id="L189">    Optional&lt;JpaGroup&gt; group = db.exec(UserDirectoryPersistenceUtil.findGroupByRoleQuery(groupName, orgId));</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">    if (group.isPresent()) {</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">      for (Role role : group.get().getRoles()) {</span>
<span class="nc" id="L192">        roles.add(new JaxbRole(role.getName(), role.getOrganizationId(), role.getDescription(), Role.Type.DERIVED));</span>
<span class="nc" id="L193">      }</span>
    } else {
<span class="nc" id="L195">      logger.warn(&quot;Group {} not found&quot;, groupName);</span>
    }
<span class="nc" id="L197">    return roles;</span>
  }


  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.security.api.RoleProvider#getOrganization()
   */
  @Override
  public String getOrganization() {
<span class="nc" id="L208">    return UserProvider.ALL_ORGANIZATIONS;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.security.api.RoleProvider#findRoles(String, Role.Target, int, int)
   */
  @Override
  public Iterator&lt;Role&gt; findRoles(String query, Role.Target target, int offset, int limit) {
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">    if (query == null) {</span>
<span class="nc" id="L219">      throw new IllegalArgumentException(&quot;Query must be set&quot;);</span>
    }
<span class="fc" id="L221">    String orgId = securityService.getOrganization().getId();</span>

    //  Here we want to return only the ROLE_GROUP_ names, not the roles associated with a group
<span class="fc" id="L224">    List&lt;JpaGroup&gt; groups = db.exec(UserDirectoryPersistenceUtil.findGroupsQuery(orgId, 0, 0));</span>

<span class="fc" id="L226">    List&lt;Role&gt; roles = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">    for (JpaGroup group : groups) {</span>
<span class="fc bfc" id="L228" title="All 2 branches covered.">      if (like(group.getRole(), query)) {</span>
<span class="fc" id="L229">        roles.add(new JaxbRole(</span>
<span class="fc" id="L230">            group.getRole(),</span>
<span class="fc" id="L231">            JaxbOrganization.fromOrganization(group.getOrganization()),</span>
            &quot;&quot;,
            Role.Type.GROUP
        ));
      }
<span class="fc" id="L236">    }</span>

<span class="fc" id="L238">    Set&lt;Role&gt; result = new HashSet&lt;&gt;();</span>
<span class="fc" id="L239">    int i = 0;</span>
<span class="fc bfc" id="L240" title="All 2 branches covered.">    for (Role entry : roles) {</span>
<span class="pc bpc" id="L241" title="1 of 4 branches missed.">      if (limit != 0 &amp;&amp; result.size() &gt;= limit) {</span>
<span class="nc" id="L242">        break;</span>
      }
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">      if (i &gt;= offset) {</span>
<span class="fc" id="L245">        result.add(entry);</span>
      }
<span class="fc" id="L247">      i++;</span>
<span class="fc" id="L248">    }</span>
<span class="fc" id="L249">    return result.iterator();</span>
  }

  /**
   * Updates a user's group membership
   *
   * @param userName
   *          the username
   * @param orgId
   *          the user's organization
   * @param roleList
   *          the list of group role names
   */
  public void updateGroupMembershipFromRoles(String userName, String orgId, List&lt;String&gt; roleList) {
<span class="nc" id="L263">    updateGroupMembershipFromRoles(userName, orgId, roleList, &quot;&quot;);</span>
<span class="nc" id="L264">  }</span>

  /**
   * Updates a user's group membership
   *
   * @param userName
   *          the username
   * @param orgId
              the user's organization
   * @param roleList
   *          the list of group role names
   * @param prefix
   *          handle only roles with given prefix
   */
  public void updateGroupMembershipFromRoles(String userName, String orgId, List&lt;String&gt; roleList, String prefix) {
<span class="nc" id="L279">    logger.debug(&quot;updateGroupMembershipFromRoles({}, size={})&quot;, userName, roleList.size());</span>

    // Add the user to all groups which are in the roleList, but allow the user to be part of groups
    // without having the group role

<span class="nc" id="L284">    Set&lt;String&gt; membershipRoles = new HashSet&lt;&gt;();</span>

    // List of the user's groups
<span class="nc" id="L287">    List&lt;JpaGroup&gt; membership = db.exec(UserDirectoryPersistenceUtil.findGroupsByUserQuery(userName, orgId));</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">    for (JpaGroup group : membership) {</span>
<span class="nc bnc" id="L289" title="All 4 branches missed.">      if (StringUtils.isNotBlank(prefix) &amp;&amp; !group.getRole().startsWith(prefix)) {</span>
        //ignore groups of other providers
<span class="nc" id="L291">        continue;</span>
      }
<span class="nc bnc" id="L293" title="All 2 branches missed.">      if (roleList.contains(group.getRole())) {</span>
        // record this membership
<span class="nc" id="L295">        membershipRoles.add(group.getRole());</span>
      }
<span class="nc" id="L297">    }</span>

    // Now add the user to any groups that they are not already a member of
<span class="nc bnc" id="L300" title="All 2 branches missed.">    for (String rolename : roleList) {</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">      if (!membershipRoles.contains(rolename)) {</span>
<span class="nc" id="L302">        Optional&lt;JpaGroup&gt; group = db.exec(UserDirectoryPersistenceUtil.findGroupByRoleQuery(rolename, orgId));</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">        if (group.isPresent()) {</span>
          try {
<span class="nc" id="L305">            logger.debug(&quot;Adding user {} to group {}&quot;, userName, rolename);</span>
<span class="nc" id="L306">            group.get().getMembers().add(userName);</span>
<span class="nc" id="L307">            addGroup(group.get());</span>
<span class="nc" id="L308">          } catch (UnauthorizedException e) {</span>
<span class="nc" id="L309">            logger.warn(&quot;Unauthorized to add user {} to group {}&quot;, userName, group.get().getRole(), e);</span>
<span class="nc" id="L310">          }</span>
        } else {
<span class="nc" id="L312">          logger.warn(&quot;Cannot add user {} to group {} - no group found with that role&quot;, userName, rolename);</span>
        }
      }
<span class="nc" id="L315">    }</span>
<span class="nc" id="L316">  }</span>

  /**
   * Removes a user from all groups
   *
   * @param userName
   *          the username
   * @param orgId
   *          the user's organization
   *
   */
  public void removeMemberFromAllGroups(String userName, String orgId) {
    // List of the user's groups
<span class="fc" id="L329">    List&lt;JpaGroup&gt; membership = db.exec(UserDirectoryPersistenceUtil.findGroupsByUserQuery(userName, orgId));</span>
<span class="fc bfc" id="L330" title="All 2 branches covered.">    for (JpaGroup group : membership) {</span>
      try {
<span class="fc" id="L332">        logger.debug(&quot;Removing user {} from group {}&quot;, userName, group.getRole());</span>
<span class="fc" id="L333">        group.getMembers().remove(userName);</span>
<span class="fc" id="L334">        addGroup(group);</span>
<span class="nc" id="L335">      } catch (UnauthorizedException e) {</span>
<span class="nc" id="L336">        logger.warn(&quot;Unauthorized to add or remove user {} from group {}&quot;, userName, group.getRole(), e);</span>
<span class="fc" id="L337">      }</span>
<span class="fc" id="L338">    }</span>
<span class="fc" id="L339">  }</span>

  /**
   * Loads a group from persistence
   *
   * @param groupId
   *          the group id
   * @param orgId
   *          the organization id
   * @return the loaded group or &lt;code&gt;null&lt;/code&gt; if not found
   */
  public JpaGroup loadGroup(String groupId, String orgId) {
<span class="fc" id="L351">    return db.exec(UserDirectoryPersistenceUtil.findGroupQuery(groupId, orgId))</span>
<span class="fc" id="L352">        .orElse(null);</span>
  }

  /**
   * Get group.
   *
   * @param groupId
   *
   * @return the group
   */
  public JpaGroup getGroup(String groupId) {
<span class="nc" id="L363">    String orgId = securityService.getOrganization().getId();</span>
<span class="nc" id="L364">    return loadGroup(groupId, orgId);</span>
  }

  /**
   * Adds or updates a group to the persistence.
   *
   * @param group
   *          the group to add
   */
  @Override
  public void addGroup(final JpaGroup group) throws UnauthorizedException {
<span class="pc bpc" id="L375" title="1 of 4 branches missed.">    if (group != null &amp;&amp; !UserDirectoryUtils.isCurrentUserAuthorizedHandleRoles(securityService, group.getRoles())) {</span>
<span class="fc" id="L376">      throw new UnauthorizedException(&quot;The user is not allowed to add or update a group with the admin role&quot;);</span>
    }

<span class="fc" id="L379">    Group existingGroup = loadGroup(group.getGroupId(), group.getOrganization().getId());</span>
<span class="fc bfc" id="L380" title="All 2 branches covered.">    if (existingGroup != null</span>
<span class="fc bfc" id="L381" title="All 2 branches covered.">        &amp;&amp; !UserDirectoryUtils.isCurrentUserAuthorizedHandleRoles(securityService, existingGroup.getRoles())) {</span>
<span class="fc" id="L382">      throw new UnauthorizedException(&quot;The user is not allowed to update a group with the admin role&quot;);</span>
    }

<span class="fc" id="L385">    db.execTx(em -&gt; {</span>
<span class="fc" id="L386">      Set&lt;JpaRole&gt; roles = UserDirectoryPersistenceUtil.saveRolesQuery(group.getRoles()).apply(em);</span>
<span class="fc" id="L387">      JpaOrganization organization = UserDirectoryPersistenceUtil.saveOrganizationQuery(group.getOrganization())</span>
<span class="fc" id="L388">          .apply(em);</span>

<span class="fc" id="L390">      JpaGroup jpaGroup = new JpaGroup(group.getGroupId(), organization, group.getName(), group.getDescription(), roles,</span>
<span class="fc" id="L391">          group.getMembers());</span>

      // Then save the jpaGroup
<span class="fc" id="L394">      Optional&lt;JpaGroup&gt; foundGroup = UserDirectoryPersistenceUtil.findGroupQuery(jpaGroup.getGroupId(),</span>
<span class="fc" id="L395">          jpaGroup.getOrganization().getId()).apply(em);</span>
<span class="fc bfc" id="L396" title="All 2 branches covered.">      if (foundGroup.isEmpty()) {</span>
<span class="fc" id="L397">        em.persist(jpaGroup);</span>
      } else {
<span class="fc" id="L399">        foundGroup.get().setName(jpaGroup.getName());</span>
<span class="fc" id="L400">        foundGroup.get().setDescription(jpaGroup.getDescription());</span>
<span class="fc" id="L401">        foundGroup.get().setMembers(jpaGroup.getMembers());</span>
<span class="fc" id="L402">        foundGroup.get().setRoles(roles);</span>
<span class="fc" id="L403">        em.merge(foundGroup.get());</span>
      }
<span class="fc" id="L405">    });</span>
<span class="fc" id="L406">  }</span>

  private void removeGroup(String groupId, String orgId) throws NotFoundException, UnauthorizedException {
<span class="fc" id="L409">    Group group = loadGroup(groupId, orgId);</span>
<span class="pc bpc" id="L410" title="2 of 4 branches missed.">    if (group != null &amp;&amp; !UserDirectoryUtils.isCurrentUserAuthorizedHandleRoles(securityService, group.getRoles())) {</span>
<span class="fc" id="L411">      throw new UnauthorizedException(&quot;The user is not allowed to delete a group with the admin role&quot;);</span>
    }

<span class="nc" id="L414">    db.execTxChecked(UserDirectoryPersistenceUtil.removeGroupQuery(groupId, orgId));</span>
<span class="nc" id="L415">  }</span>

  /**
   * Returns all roles from a given group list
   *
   * @param groups
   *          the group list
   * @return the role list
   */
  private List&lt;Role&gt; getGroupsRoles(List&lt;JpaGroup&gt; groups) {
<span class="fc" id="L425">    List&lt;Role&gt; roles = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L426" title="All 2 branches covered.">    for (Group group : groups) {</span>
<span class="fc" id="L427">      roles.add(new JaxbRole(</span>
<span class="fc" id="L428">          group.getRole(),</span>
<span class="fc" id="L429">          JaxbOrganization.fromOrganization(group.getOrganization()),</span>
          &quot;&quot;,
          Role.Type.GROUP
      ));
<span class="fc bfc" id="L433" title="All 2 branches covered.">      for (Role role : group.getRoles()) {</span>
<span class="fc" id="L434">        roles.add(new JaxbRole(role.getName(), role.getOrganizationId(), role.getDescription(), Role.Type.DERIVED));</span>
<span class="fc" id="L435">      }</span>
<span class="fc" id="L436">    }</span>
<span class="fc" id="L437">    return roles;</span>
  }

  public Iterator&lt;Group&gt; getGroups() {
<span class="nc" id="L441">    String orgId = securityService.getOrganization().getId();</span>
<span class="nc" id="L442">    return new ArrayList&lt;Group&gt;(db.exec(UserDirectoryPersistenceUtil.findGroupsQuery(orgId, 0, 0)))</span>
<span class="nc" id="L443">        .iterator();</span>
  }

  private boolean like(final String str, final String expr) {
<span class="pc bpc" id="L447" title="1 of 2 branches missed.">    if (str == null) {</span>
<span class="nc" id="L448">      return false;</span>
    }
<span class="fc" id="L450">    String regex = expr.replace(&quot;_&quot;, &quot;.&quot;).replace(&quot;%&quot;, &quot;.*?&quot;);</span>
<span class="fc" id="L451">    Pattern p = Pattern.compile(regex, Pattern.CASE_INSENSITIVE | Pattern.DOTALL);</span>
<span class="fc" id="L452">    return p.matcher(str).matches();</span>
  }

  /**
   * Returns a XML representation of the list of groups available the current user's organization.
   *
   * @param limit
   *          the int amount to limit the results
   * @param offset
   *          the offset to start this result set at
   * @return the JaxbGroupList of results
   * @throws IOException
   *           if unexpected IO exception occurs
   */
  public JaxbGroupList getGroups(int limit, int offset) throws IOException {
<span class="nc bnc" id="L467" title="All 2 branches missed.">    if (limit &lt; 1) {</span>
<span class="nc" id="L468">      limit = 100;</span>
    }
<span class="nc" id="L470">    String orgId = securityService.getOrganization().getId();</span>
<span class="nc" id="L471">    JaxbGroupList groupList = new JaxbGroupList();</span>
<span class="nc" id="L472">    List&lt;JpaGroup&gt; groups = db.exec(UserDirectoryPersistenceUtil.findGroupsQuery(orgId, limit, offset));</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">    for (JpaGroup group : groups) {</span>
<span class="nc" id="L474">      groupList.add(group);</span>
<span class="nc" id="L475">    }</span>
<span class="nc" id="L476">    return groupList;</span>
  }

  /**
   * Get groups by the defined filter and sorting criteria.
   *
   * @param limit
   *          how many groups to get (optional)
   * @param offset
   *          where to start the list for pagination (optional)
   * @param nameFilter
   *          filter by group name (optional)
   * @param textFilter
   *          fulltext filter (optional)
   * @param sortCriteria
   *          the sorting criteria
   *
   * @return a list of groups
   */
  public List&lt;JpaGroup&gt; getGroups(Optional&lt;Integer&gt; limit, Optional&lt;Integer&gt; offset, Optional&lt;String&gt; nameFilter,
          Optional&lt;String&gt; textFilter, ArrayList&lt;SortCriterion&gt; sortCriteria) {
<span class="nc" id="L497">    String orgId = securityService.getOrganization().getId();</span>
<span class="nc" id="L498">    return db.exec(UserDirectoryPersistenceUtil.findGroupsQuery(orgId, limit, offset, nameFilter, textFilter,</span>
        sortCriteria));
  }

  /**
   * Count groups that fit the filter criteria in total.
   *
   * @param nameFilter
   *          filter by group name (optional)
   * @param textFilter
   *          fulltext filter (optional)
   *
   * @return a list of groups
   */
  public long countTotalGroups(Optional&lt;String&gt; nameFilter, Optional&lt;String&gt; textFilter) {
<span class="nc" id="L513">    String orgId = securityService.getOrganization().getId();</span>
<span class="nc" id="L514">    return db.exec(UserDirectoryPersistenceUtil.countTotalGroupsQuery(orgId, nameFilter, textFilter));</span>
  }

  /**
   * Remove a group by id
   *
   * @param groupId
   *          the id of the group to remove
   * @throws Exception
   *           unexpected error occurred
   * @throws UnauthorizedException
   *           user is not authorized to remove this group
   * @throws NotFoundException
   *           the group was not found
   */
  public void removeGroup(String groupId) throws NotFoundException, UnauthorizedException, Exception {
<span class="fc" id="L530">    String orgId = securityService.getOrganization().getId();</span>
<span class="nc" id="L531">    removeGroup(groupId, orgId);</span>
<span class="nc" id="L532">  }</span>

  /**
   * Create a new group
   *
   * @param name
   *          the name of the group
   * @param description
   *          a description of the group
   * @param roles
   *          the roles of the group
   * @param users
   *          the users in the group
   * @throws IllegalArgumentException
   *           if missing or bad parameters
   * @throws UnauthorizedException
   *           if user does not have rights to create group
   * @throws ConflictException
   *           if group already exists
   */
  public void createGroup(String name, String description, String roles, String users)
          throws IllegalArgumentException, UnauthorizedException, ConflictException {
<span class="fc" id="L554">    JpaOrganization organization = (JpaOrganization) securityService.getOrganization();</span>

<span class="fc" id="L556">    HashSet&lt;JpaRole&gt; roleSet = new HashSet&lt;&gt;();</span>
<span class="pc bpc" id="L557" title="1 of 2 branches missed.">    if (roles != null) {</span>
<span class="fc bfc" id="L558" title="All 2 branches covered.">      for (String role : StringUtils.split(roles, &quot;,&quot;)) {</span>
<span class="fc" id="L559">        roleSet.add(new JpaRole(StringUtils.trim(role), organization));</span>
      }
    }

<span class="fc" id="L563">    HashSet&lt;String&gt; members = new HashSet&lt;&gt;();</span>
<span class="pc bpc" id="L564" title="1 of 2 branches missed.">    if (users != null) {</span>
<span class="fc bfc" id="L565" title="All 2 branches covered.">      for (String member : StringUtils.split(users, &quot;,&quot;)) {</span>
<span class="fc" id="L566">        members.add(StringUtils.trim(member));</span>
      }
    }

<span class="fc" id="L570">    final String groupId = name.toLowerCase().replaceAll(&quot;\\W&quot;, &quot;_&quot;);</span>

<span class="fc" id="L572">    Optional&lt;JpaGroup&gt; existingGroup = db.exec(UserDirectoryPersistenceUtil.findGroupQuery(groupId,</span>
<span class="fc" id="L573">        organization.getId()));</span>
<span class="fc bfc" id="L574" title="All 2 branches covered.">    if (existingGroup.isPresent()) {</span>
<span class="fc" id="L575">      throw new ConflictException(&quot;group already exists&quot;);</span>
    }

<span class="fc" id="L578">    addGroup(new JpaGroup(groupId, organization, name, description, roleSet, members));</span>
<span class="fc" id="L579">  }</span>

  /**
   * Remove member from group.
   *
   * @param groupId
   * @param member
   *
   * @return true if we updated the group, false otherwise
   *
   * @throws NotFoundException
   * @throws UnauthorizedException
   */
  public boolean removeMemberFromGroup(String groupId, String member) throws NotFoundException, UnauthorizedException {
<span class="nc" id="L593">    JpaGroup group = getGroup(groupId);</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">    if (group == null) {</span>
<span class="nc" id="L595">      throw new NotFoundException();</span>
    }
<span class="nc" id="L597">    Set&lt;String&gt; members = group.getMembers();</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">    if (!members.contains(member)) {</span>
<span class="nc" id="L599">      return false; // nothing to do here</span>
    }
<span class="nc" id="L601">    group.removeMember(member);</span>
<span class="nc" id="L602">    userDirectoryService.invalidate(member);</span>

<span class="nc" id="L604">    addGroup(group);</span>
<span class="nc" id="L605">    return true;</span>
  }

  /**
   * Add member to group.
   *
   * @param groupId
   * @param member
   *
   * @return true if we updated the group, false otherwise
   *
   * @throws NotFoundException
   * @throws UnauthorizedException
   */
  public boolean addMemberToGroup(String groupId, String member) throws NotFoundException, UnauthorizedException {
<span class="nc" id="L620">    JpaGroup group = getGroup(groupId);</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">    if (group == null) {</span>
<span class="nc" id="L622">      throw new NotFoundException();</span>
    }
<span class="nc" id="L624">    Set&lt;String&gt; members = group.getMembers();</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">    if (members.contains(member)) {</span>
<span class="nc" id="L626">      return false; // nothing to do here</span>
    }
<span class="nc" id="L628">    group.addMember(member);</span>
<span class="nc" id="L629">    userDirectoryService.invalidate(member);</span>

<span class="nc" id="L631">    addGroup(group);</span>
<span class="nc" id="L632">    return true;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.userdirectory.api.GroupRoleProvider#updateGroup(String, String, String, String, String)
   */
  @Override
  public void updateGroup(String groupId, String name, String description, String roles, String users)
          throws NotFoundException, UnauthorizedException {
<span class="fc" id="L643">    JpaOrganization organization = (JpaOrganization) securityService.getOrganization();</span>

<span class="fc" id="L645">    Optional&lt;JpaGroup&gt; groupOpt = db.exec(UserDirectoryPersistenceUtil.findGroupQuery(groupId, organization.getId()));</span>
<span class="pc bpc" id="L646" title="1 of 2 branches missed.">    if (groupOpt.isEmpty()) {</span>
<span class="nc" id="L647">      throw new NotFoundException();</span>
    }
<span class="fc" id="L649">    JpaGroup group = groupOpt.get();</span>

<span class="pc bpc" id="L651" title="1 of 2 branches missed.">    if (StringUtils.isNotBlank(name)) {</span>
<span class="fc" id="L652">      group.setName(StringUtils.trim(name));</span>
    }

<span class="pc bpc" id="L655" title="1 of 2 branches missed.">    if (StringUtils.isNotBlank(description)) {</span>
<span class="fc" id="L656">      group.setDescription(StringUtils.trim(description));</span>
    }

<span class="pc bpc" id="L659" title="1 of 2 branches missed.">    if (StringUtils.isNotBlank(roles)) {</span>
<span class="fc" id="L660">      HashSet&lt;JpaRole&gt; roleSet = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L661" title="All 2 branches covered.">      for (String role : StringUtils.split(roles, &quot;,&quot;)) {</span>
<span class="fc" id="L662">        roleSet.add(new JpaRole(StringUtils.trim(role), organization));</span>
      }
<span class="fc" id="L664">      group.setRoles(roleSet);</span>
<span class="fc" id="L665">    } else {</span>
<span class="nc" id="L666">      group.setRoles(new HashSet&lt;&gt;());</span>
    }

<span class="pc bpc" id="L669" title="1 of 2 branches missed.">    if (users != null) {</span>
<span class="nc" id="L670">      HashSet&lt;String&gt; members = new HashSet&lt;&gt;();</span>
<span class="nc" id="L671">      HashSet&lt;String&gt; invalidateUsers = new HashSet&lt;&gt;();</span>

<span class="nc" id="L673">      Set&lt;String&gt; groupMembers = group.getMembers();</span>

<span class="nc bnc" id="L675" title="All 2 branches missed.">      for (String member : StringUtils.split(users, &quot;,&quot;)) {</span>
<span class="nc" id="L676">        String newMember = StringUtils.trim(member);</span>
<span class="nc" id="L677">        members.add(newMember);</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">        if (!groupMembers.contains(newMember)) {</span>
<span class="nc" id="L679">          invalidateUsers.add(newMember);</span>
        }
      }

<span class="nc bnc" id="L683" title="All 2 branches missed.">      for (String member : groupMembers) {</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">        if (!members.contains(member)) {</span>
<span class="nc" id="L685">          invalidateUsers.add(member);</span>
        }
<span class="nc" id="L687">      }</span>

<span class="nc" id="L689">      group.setMembers(members);</span>

      // Invalidate cache entries for users who have been added or removed
<span class="nc bnc" id="L692" title="All 2 branches missed.">      for (String member : invalidateUsers) {</span>
<span class="nc" id="L693">        userDirectoryService.invalidate(member);</span>
<span class="nc" id="L694">      }</span>
    }
<span class="nc" id="L696">    addGroup(group);</span>
<span class="nc" id="L697">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>