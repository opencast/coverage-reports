<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CustomRoleProvider.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-userdirectory</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.userdirectory</a> &gt; <span class="el_source">CustomRoleProvider.java</span></div><h1>CustomRoleProvider.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.userdirectory;

import static org.opencastproject.security.api.UserProvider.ALL_ORGANIZATIONS;

import org.opencastproject.security.api.JaxbOrganization;
import org.opencastproject.security.api.JaxbRole;
import org.opencastproject.security.api.Role;
import org.opencastproject.security.api.Role.Type;
import org.opencastproject.security.api.RoleProvider;
import org.opencastproject.security.api.SecurityService;

import org.apache.commons.lang3.StringUtils;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Arrays;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;
import java.util.Set;
import java.util.TreeSet;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.regex.PatternSyntaxException;


/**
 * An in-memory role provider containing administratively-defined custom roles
 */
@Component(
    property = {
        &quot;service.description=Provides custom roles&quot;
    },
    immediate = true,
    service = { RoleProvider.class }
)
<span class="fc" id="L61">public class CustomRoleProvider implements RoleProvider {</span>

  /** The logging facility */
<span class="fc" id="L64">  private static final Logger logger = LoggerFactory.getLogger(CustomRoleProvider.class);</span>

  /** Configuration key for the custom role list */
  public static final String CUSTOM_ROLES_KEY = &quot;org.opencastproject.security.custom.roles&quot;;

  /** Configuration key for the custom role pattern */
  public static final String CUSTOM_ROLES_PATTERN_KEY = &quot;org.opencastproject.security.custom.roles.pattern&quot;;

  /** The security service */
<span class="fc" id="L73">  protected SecurityService securityService = null;</span>

  /** The list of custom roles */
<span class="fc" id="L76">  private Set&lt;String&gt; roles = null;</span>

  /** The custom roles pattern */
<span class="fc" id="L79">  private Pattern rolematch = null;</span>

  /**
   * @param securityService
   *          the securityService to set
   */
  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="fc" id="L87">    this.securityService = securityService;</span>
<span class="fc" id="L88">  }</span>

  /**
   * Callback to activate the component.
   *
   * @param cc
   *          the declarative services component context
   */
  protected void activate(ComponentContext cc) {

<span class="fc" id="L98">    roles = new TreeSet&lt;&gt;();</span>
<span class="fc" id="L99">    String customRoleList = StringUtils.trimToNull(cc.getBundleContext().getProperty(CUSTOM_ROLES_KEY));</span>

<span class="pc bpc" id="L101" title="1 of 2 branches missed.">    if (customRoleList != null) {</span>
<span class="fc" id="L102">      List&lt;String&gt; items = Arrays.asList(customRoleList.split(&quot;\\s*,\\s*&quot;));</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">      for (String item : items) {</span>
<span class="fc" id="L104">        logger.debug(&quot;Adding custom role '{}'&quot;, item);</span>
<span class="fc" id="L105">        roles.add(item);</span>
<span class="fc" id="L106">      }</span>
    }

<span class="fc" id="L109">    String rolePattern = StringUtils.trimToNull(cc.getBundleContext().getProperty(CUSTOM_ROLES_PATTERN_KEY));</span>
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">    if (rolePattern != null) {</span>
      try {
<span class="fc" id="L112">        rolematch = Pattern.compile(rolePattern);</span>
<span class="nc" id="L113">      } catch (PatternSyntaxException e) {</span>
<span class="nc" id="L114">        logger.warn(&quot;Invalid regular expression for custom roles pattern: {}&quot;, rolePattern);</span>
<span class="fc" id="L115">      }</span>
    }

<span class="pc bpc" id="L118" title="1 of 2 branches missed.">    if (rolematch != null) {</span>
<span class="fc" id="L119">      logger.info(&quot;CustomRoleProvider activated, {} custom role(s), custom role pattern {}&quot;, roles.size(), rolePattern);</span>
    } else {
<span class="nc" id="L121">      logger.info(&quot;CustomRoleProvider activated, {} custom role(s)&quot;, roles.size());</span>
    }
<span class="fc" id="L123">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.security.api.UserProvider#getOrganization()
   */
  @Override
  public String getOrganization() {
<span class="nc" id="L132">    return ALL_ORGANIZATIONS;</span>
  }

  /**
   * @see org.opencastproject.security.api.RoleProvider#getRolesForUser(String)
   */
  @Override
  public List&lt;Role&gt; getRolesForUser(String userName) {
<span class="nc" id="L140">    return Collections.emptyList();</span>
  }

  /**
   * @see org.opencastproject.security.api.RoleProvider#findRoles(String, Role.Target, int, int)
   */
  @Override
  public Iterator&lt;Role&gt; findRoles(String query, Role.Target target, int offset, int limit) {
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">    if (query == null) {</span>
<span class="nc" id="L149">      throw new IllegalArgumentException(&quot;Query must be set&quot;);</span>
    }

<span class="fc" id="L152">    var organization = JaxbOrganization.fromOrganization(securityService.getOrganization());</span>

    // Match the custom regular expression first if this is an ACL role query
<span class="pc bpc" id="L155" title="2 of 4 branches missed.">    if ((target == Role.Target.ACL) &amp;&amp; (rolematch != null)) {</span>
<span class="fc" id="L156">      String exactQuery = StringUtils.removeEnd(query, &quot;%&quot;);</span>
<span class="fc" id="L157">      Matcher m = rolematch.matcher(exactQuery);</span>
<span class="fc bfc" id="L158" title="All 2 branches covered.">      if (m.matches()) {</span>
<span class="fc" id="L159">        return Collections</span>
<span class="fc" id="L160">            .singletonList((Role) new JaxbRole(exactQuery, organization, &quot;Custom Role&quot;, Role.Type.EXTERNAL))</span>
<span class="fc" id="L161">            .iterator();</span>
      }
    }

    // Otherwise match on the custom roles specified in a list
<span class="fc" id="L166">    return roles.stream()</span>
<span class="fc" id="L167">        .filter(role -&gt; like(role, query))</span>
<span class="fc" id="L168">        .skip(offset)</span>
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">        .limit(limit &gt; 0 ? limit : Long.MAX_VALUE)</span>
<span class="fc" id="L170">        .map(role -&gt; (Role) new JaxbRole(role, organization, &quot;Custom Role&quot;, Type.INTERNAL))</span>
<span class="fc" id="L171">        .iterator();</span>
  }

  private static boolean like(String string, final String query) {
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">    if (string == null) {</span>
<span class="nc" id="L176">      return false;</span>
    }
<span class="fc" id="L178">    String regex = query.replace(&quot;_&quot;, &quot;.&quot;).replace(&quot;%&quot;, &quot;.*?&quot;);</span>
<span class="fc" id="L179">    Pattern p = Pattern.compile(regex, Pattern.CASE_INSENSITIVE | Pattern.DOTALL);</span>
<span class="fc" id="L180">    return p.matcher(string).matches();</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>