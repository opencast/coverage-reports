<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ThemesEndpoint.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-admin-ui</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.adminui.endpoint</a> &gt; <span class="el_source">ThemesEndpoint.java</span></div><h1>ThemesEndpoint.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.adminui.endpoint;

import static com.entwinemedia.fn.data.Opt.nul;
import static com.entwinemedia.fn.data.json.Jsons.arr;
import static com.entwinemedia.fn.data.json.Jsons.f;
import static com.entwinemedia.fn.data.json.Jsons.obj;
import static com.entwinemedia.fn.data.json.Jsons.v;
import static javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;
import static javax.servlet.http.HttpServletResponse.SC_NOT_FOUND;
import static javax.servlet.http.HttpServletResponse.SC_NO_CONTENT;
import static javax.servlet.http.HttpServletResponse.SC_OK;
import static javax.servlet.http.HttpServletResponse.SC_UNAUTHORIZED;
import static org.apache.commons.lang3.StringUtils.isNotBlank;
import static org.apache.commons.lang3.StringUtils.trimToNull;
import static org.opencastproject.index.service.util.RestUtils.notFound;
import static org.opencastproject.index.service.util.RestUtils.okJson;
import static org.opencastproject.index.service.util.RestUtils.okJsonList;
import static org.opencastproject.util.doc.rest.RestParameter.Type.STRING;

import org.opencastproject.elasticsearch.api.SearchIndexException;
import org.opencastproject.elasticsearch.api.SearchResult;
import org.opencastproject.elasticsearch.api.SearchResultItem;
import org.opencastproject.elasticsearch.index.ElasticsearchIndex;
import org.opencastproject.elasticsearch.index.objects.series.Series;
import org.opencastproject.elasticsearch.index.objects.series.SeriesSearchQuery;
import org.opencastproject.elasticsearch.index.objects.theme.IndexTheme;
import org.opencastproject.elasticsearch.index.objects.theme.ThemeIndexSchema;
import org.opencastproject.elasticsearch.index.objects.theme.ThemeSearchQuery;
import org.opencastproject.index.service.resources.list.query.ThemesListQuery;
import org.opencastproject.index.service.util.RestUtils;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.UnauthorizedException;
import org.opencastproject.security.api.User;
import org.opencastproject.series.api.SeriesException;
import org.opencastproject.series.api.SeriesService;
import org.opencastproject.staticfiles.api.StaticFileService;
import org.opencastproject.staticfiles.endpoint.StaticFileRestService;
import org.opencastproject.themes.Theme;
import org.opencastproject.themes.ThemesServiceDatabase;
import org.opencastproject.themes.persistence.ThemesServiceDatabaseException;
import org.opencastproject.util.DateTimeSupport;
import org.opencastproject.util.EqualsUtil;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.RestUtil;
import org.opencastproject.util.RestUtil.R;
import org.opencastproject.util.data.Option;
import org.opencastproject.util.doc.rest.RestParameter;
import org.opencastproject.util.doc.rest.RestParameter.Type;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestResponse;
import org.opencastproject.util.doc.rest.RestService;
import org.opencastproject.util.requests.SortCriterion;

import com.entwinemedia.fn.data.Opt;
import com.entwinemedia.fn.data.json.Field;
import com.entwinemedia.fn.data.json.JValue;
import com.entwinemedia.fn.data.json.Jsons;

import org.apache.commons.lang3.BooleanUtils;
import org.apache.commons.lang3.StringUtils;
import org.osgi.framework.BundleContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.jaxrs.whiteboard.propertytypes.JaxrsResource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.DELETE;
import javax.ws.rs.FormParam;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.PUT;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.WebApplicationException;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.Response.Status;

@Path(&quot;/admin-ng/themes&quot;)
@RestService(name = &quot;themes&quot;, title = &quot;Themes facade service&quot;,
  abstractText = &quot;Provides operations for the themes&quot;,
  notes = { &quot;This service offers the default themes CRUD Operations for the admin UI.&quot;,
            &quot;&lt;strong&gt;Important:&lt;/strong&gt; &quot;
              + &quot;&lt;em&gt;This service is for exclusive use by the module admin-ui. Its API might change &quot;
              + &quot;anytime without prior notice. Any dependencies other than the admin UI will be strictly ignored. &quot;
              + &quot;DO NOT use this for integration of third-party applications.&lt;em&gt;&quot;})
@Component(
        immediate = true,
        service = ThemesEndpoint.class,
        property = {
                &quot;service.description=Admin UI - Themes Endpoint&quot;,
                &quot;opencast.service.type=org.opencastproject.adminui.ThemesEndpoint&quot;,
                &quot;opencast.service.path=/admin-ng/themes&quot;,
        }
)
@JaxrsResource
<span class="fc" id="L129">public class ThemesEndpoint {</span>

  /** The logging facility */
<span class="fc" id="L132">  private static final Logger logger = LoggerFactory.getLogger(ThemesEndpoint.class);</span>

  /** The themes service database */
  private ThemesServiceDatabase themesServiceDatabase;

  /** The security service */
  private SecurityService securityService;

  /** The admin UI search index */
  private ElasticsearchIndex searchIndex;

  /** The series service */
  private SeriesService seriesService;

  /** The static file service */
  private StaticFileService staticFileService;

  /** The static file REST service */
  private StaticFileRestService staticFileRestService;

  /** OSGi callback for the themes service database. */
  @Reference
  public void setThemesServiceDatabase(ThemesServiceDatabase themesServiceDatabase) {
<span class="fc" id="L155">    this.themesServiceDatabase = themesServiceDatabase;</span>
<span class="fc" id="L156">  }</span>

  /** OSGi callback for the security service. */
  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="fc" id="L161">    this.securityService = securityService;</span>
<span class="fc" id="L162">  }</span>

  /** OSGi DI. */
  @Reference
  public void setIndex(ElasticsearchIndex index) {
<span class="fc" id="L167">    this.searchIndex = index;</span>
<span class="fc" id="L168">  }</span>

  /** OSGi DI. */
  @Reference
  public void setSeriesService(SeriesService seriesService) {
<span class="fc" id="L173">    this.seriesService = seriesService;</span>
<span class="fc" id="L174">  }</span>

  /** OSGi DI. */
  @Reference
  public void setStaticFileService(StaticFileService staticFileService) {
<span class="fc" id="L179">    this.staticFileService = staticFileService;</span>
<span class="fc" id="L180">  }</span>

  /** OSGi DI. */
  @Reference
  public void setStaticFileRestService(StaticFileRestService staticFileRestService) {
<span class="fc" id="L185">    this.staticFileRestService = staticFileRestService;</span>
<span class="fc" id="L186">  }</span>

  @Activate
  public void activate(BundleContext bundleContext) {
<span class="nc" id="L190">    logger.info(&quot;Activate themes endpoint&quot;);</span>
<span class="nc" id="L191">  }</span>

  @GET
  @Produces({ MediaType.APPLICATION_JSON })
  @Path(&quot;themes.json&quot;)
  @RestQuery(name = &quot;getThemes&quot;, description = &quot;Return all of the known themes on the system&quot;, restParameters = {
          @RestParameter(name = &quot;filter&quot;, isRequired = false, description = &quot;The filter used for the query. They should be formated like that: 'filter1:value1,filter2:value2'&quot;, type = STRING),
          @RestParameter(defaultValue = &quot;0&quot;, description = &quot;The maximum number of items to return per page.&quot;, isRequired = false, name = &quot;limit&quot;, type = RestParameter.Type.INTEGER),
          @RestParameter(defaultValue = &quot;0&quot;, description = &quot;The page number.&quot;, isRequired = false, name = &quot;offset&quot;, type = RestParameter.Type.INTEGER),
          @RestParameter(name = &quot;sort&quot;, isRequired = false, description = &quot;The sort order. May include any of the following: NAME, CREATOR.  Add '_DESC' to reverse the sort order (e.g. CREATOR_DESC).&quot;, type = STRING) }, responses = { @RestResponse(description = &quot;A JSON representation of the themes&quot;, responseCode = HttpServletResponse.SC_OK) }, returnDescription = &quot;&quot;)
  public Response getThemes(@QueryParam(&quot;filter&quot;) String filter, @QueryParam(&quot;limit&quot;) int limit,
          @QueryParam(&quot;offset&quot;) int offset, @QueryParam(&quot;sort&quot;) String sort) {
<span class="fc" id="L203">    Option&lt;Integer&gt; optLimit = Option.option(limit);</span>
<span class="fc" id="L204">    Option&lt;Integer&gt; optOffset = Option.option(offset);</span>
<span class="fc" id="L205">    Option&lt;String&gt; optSort = Option.option(trimToNull(sort));</span>

<span class="fc" id="L207">    ThemeSearchQuery query = new ThemeSearchQuery(securityService.getOrganization().getId(), securityService.getUser());</span>

    // If the limit is set to 0, this is not taken into account
<span class="pc bpc" id="L210" title="2 of 4 branches missed.">    if (optLimit.isSome() &amp;&amp; limit == 0) {</span>
<span class="fc" id="L211">      optLimit = Option.none();</span>
    }

<span class="pc bpc" id="L214" title="1 of 2 branches missed.">    if (optLimit.isSome())</span>
<span class="nc" id="L215">      query.withLimit(optLimit.get());</span>
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">    if (optOffset.isSome())</span>
<span class="fc" id="L217">      query.withOffset(offset);</span>

<span class="fc" id="L219">    Map&lt;String, String&gt; filters = RestUtils.parseFilter(filter);</span>
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">    for (String name : filters.keySet()) {</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">      if (ThemesListQuery.FILTER_CREATOR_NAME.equals(name))</span>
<span class="nc" id="L222">        query.withCreator(filters.get(name));</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">      if (ThemesListQuery.FILTER_TEXT_NAME.equals(name))</span>
<span class="nc" id="L224">        query.withText(filters.get(name));</span>
<span class="nc" id="L225">    }</span>

<span class="pc bpc" id="L227" title="1 of 2 branches missed.">    if (optSort.isSome()) {</span>
<span class="nc" id="L228">      ArrayList&lt;SortCriterion&gt; sortCriteria = RestUtils.parseSortQueryParameter(optSort.get());</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">      for (SortCriterion criterion : sortCriteria) {</span>
<span class="nc bnc" id="L230" title="All 6 branches missed.">        switch (criterion.getFieldName()) {</span>
          case ThemeIndexSchema.NAME:
<span class="nc" id="L232">            query.sortByName(criterion.getOrder());</span>
<span class="nc" id="L233">            break;</span>
          case ThemeIndexSchema.DESCRIPTION:
<span class="nc" id="L235">            query.sortByDescription(criterion.getOrder());</span>
<span class="nc" id="L236">            break;</span>
          case ThemeIndexSchema.CREATOR:
<span class="nc" id="L238">            query.sortByCreator(criterion.getOrder());</span>
<span class="nc" id="L239">            break;</span>
          case ThemeIndexSchema.DEFAULT:
<span class="nc" id="L241">            query.sortByDefault(criterion.getOrder());</span>
<span class="nc" id="L242">            break;</span>
          case ThemeIndexSchema.CREATION_DATE:
<span class="nc" id="L244">            query.sortByCreatedDateTime(criterion.getOrder());</span>
<span class="nc" id="L245">            break;</span>
          default:
<span class="nc" id="L247">            logger.info(&quot;Unknown sort criteria {}&quot;, criterion.getFieldName());</span>
<span class="nc" id="L248">            return Response.status(SC_BAD_REQUEST).build();</span>
        }
<span class="nc" id="L250">      }</span>
    }

<span class="fc" id="L253">    logger.trace(&quot;Using Query: &quot; + query.toString());</span>

<span class="fc" id="L255">    SearchResult&lt;IndexTheme&gt; results = null;</span>
    try {
<span class="fc" id="L257">      results = searchIndex.getByQuery(query);</span>
<span class="nc" id="L258">    } catch (SearchIndexException e) {</span>
<span class="nc" id="L259">      logger.error(&quot;The admin UI Search Index was not able to get the themes list:&quot;, e);</span>
<span class="nc" id="L260">      return RestUtil.R.serverError();</span>
<span class="fc" id="L261">    }</span>

<span class="fc" id="L263">    List&lt;JValue&gt; themesJSON = new ArrayList&lt;JValue&gt;();</span>

    // If the results list if empty, we return already a response.
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">    if (results.getPageSize() == 0) {</span>
<span class="nc" id="L267">      logger.debug(&quot;No themes match the given filters.&quot;);</span>
<span class="nc" id="L268">      return okJsonList(themesJSON, nul(offset).getOr(0), nul(limit).getOr(0), 0);</span>
    }

<span class="fc bfc" id="L271" title="All 2 branches covered.">    for (SearchResultItem&lt;IndexTheme&gt; item : results.getItems()) {</span>
<span class="fc" id="L272">      IndexTheme theme = item.getSource();</span>
<span class="fc" id="L273">      themesJSON.add(themeToJSON(theme, false));</span>
    }

<span class="fc" id="L276">    return okJsonList(themesJSON, nul(offset).getOr(0), nul(limit).getOr(0), results.getHitCount());</span>
  }

  @GET
  @Path(&quot;{themeId}.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;getTheme&quot;, description = &quot;Returns the theme by the given id as JSON&quot;, returnDescription = &quot;The theme as JSON&quot;, pathParameters = { @RestParameter(name = &quot;themeId&quot;, description = &quot;The theme id&quot;, isRequired = true, type = RestParameter.Type.INTEGER) }, responses = {
          @RestResponse(description = &quot;Returns the theme as JSON&quot;, responseCode = HttpServletResponse.SC_OK),
          @RestResponse(description = &quot;No theme with this identifier was found.&quot;, responseCode = HttpServletResponse.SC_NOT_FOUND) })
  public Response getThemeResponse(@PathParam(&quot;themeId&quot;) long id) throws Exception {
<span class="fc" id="L286">    Opt&lt;IndexTheme&gt; theme = getTheme(id);</span>
<span class="fc bfc" id="L287" title="All 2 branches covered.">    if (theme.isNone())</span>
<span class="fc" id="L288">      return notFound(&quot;Cannot find a theme with id '%s'&quot;, id);</span>

<span class="fc" id="L290">    return okJson(themeToJSON(theme.get(), true));</span>
  }

  @GET
  @Path(&quot;{themeId}/usage.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;getThemeUsage&quot;, description = &quot;Returns the theme usage by the given id as JSON&quot;, returnDescription = &quot;The theme usage as JSON&quot;, pathParameters = { @RestParameter(name = &quot;themeId&quot;, description = &quot;The theme id&quot;, isRequired = true, type = RestParameter.Type.INTEGER) }, responses = {
          @RestResponse(description = &quot;Returns the theme usage as JSON&quot;, responseCode = HttpServletResponse.SC_OK),
          @RestResponse(description = &quot;Theme with the given id does not exist&quot;, responseCode = HttpServletResponse.SC_NOT_FOUND) })
  public Response getThemeUsage(@PathParam(&quot;themeId&quot;) long themeId) throws Exception {
<span class="fc" id="L300">    Opt&lt;IndexTheme&gt; theme = getTheme(themeId);</span>
<span class="fc bfc" id="L301" title="All 2 branches covered.">    if (theme.isNone())</span>
<span class="fc" id="L302">      return notFound(&quot;Cannot find a theme with id {}&quot;, themeId);</span>

<span class="fc" id="L304">    SeriesSearchQuery query = new SeriesSearchQuery(securityService.getOrganization().getId(),</span>
<span class="fc" id="L305">            securityService.getUser()).withTheme(themeId);</span>
<span class="fc" id="L306">    SearchResult&lt;Series&gt; results = null;</span>
    try {
<span class="fc" id="L308">      results = searchIndex.getByQuery(query);</span>
<span class="nc" id="L309">    } catch (SearchIndexException e) {</span>
<span class="nc" id="L310">      logger.error(&quot;The admin UI Search Index was not able to get the series with theme '{}':&quot;, themeId,</span>
              e);
<span class="nc" id="L312">      return RestUtil.R.serverError();</span>
<span class="fc" id="L313">    }</span>
<span class="fc" id="L314">    List&lt;JValue&gt; seriesValues = new ArrayList&lt;JValue&gt;();</span>
<span class="fc bfc" id="L315" title="All 2 branches covered.">    for (SearchResultItem&lt;Series&gt; item : results.getItems()) {</span>
<span class="fc" id="L316">      Series series = item.getSource();</span>
<span class="fc" id="L317">      seriesValues.add(obj(f(&quot;id&quot;, v(series.getIdentifier())), f(&quot;title&quot;, v(series.getTitle()))));</span>
    }
<span class="fc" id="L319">    return okJson(obj(f(&quot;series&quot;, arr(seriesValues))));</span>
  }

  @POST
  @Path(&quot;&quot;)
  @RestQuery(name = &quot;createTheme&quot;, description = &quot;Add a theme&quot;, returnDescription = &quot;Return the created theme&quot;, restParameters = {
          @RestParameter(name = &quot;default&quot;, description = &quot;Whether the theme is default&quot;, isRequired = true, type = Type.BOOLEAN),
          @RestParameter(name = &quot;name&quot;, description = &quot;The theme name&quot;, isRequired = true, type = Type.STRING),
          @RestParameter(name = &quot;description&quot;, description = &quot;The theme description&quot;, isRequired = false, type = Type.TEXT),
          @RestParameter(name = &quot;bumperActive&quot;, description = &quot;Whether the theme bumper is active&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;trailerActive&quot;, description = &quot;Whether the theme trailer is active&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;titleSlideActive&quot;, description = &quot;Whether the theme title slide is active&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;licenseSlideActive&quot;, description = &quot;Whether the theme license slide is active&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;watermarkActive&quot;, description = &quot;Whether the theme watermark is active&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;bumperFile&quot;, description = &quot;The theme bumper file&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;trailerFile&quot;, description = &quot;The theme trailer file&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;watermarkFile&quot;, description = &quot;The theme watermark file&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;titleSlideBackground&quot;, description = &quot;The theme title slide background file&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;licenseSlideBackground&quot;, description = &quot;The theme license slide background file&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;titleSlideMetadata&quot;, description = &quot;The theme title slide metadata&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;licenseSlideDescription&quot;, description = &quot;The theme license slide description&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;watermarkPosition&quot;, description = &quot;The theme watermark position&quot;, isRequired = false, type = Type.STRING), }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Theme created&quot;),
          @RestResponse(responseCode = SC_BAD_REQUEST, description = &quot;The theme references a non-existing file&quot;) })
  public Response createTheme(@FormParam(&quot;default&quot;) boolean isDefault, @FormParam(&quot;name&quot;) String name,
          @FormParam(&quot;description&quot;) String description, @FormParam(&quot;bumperActive&quot;) Boolean bumperActive,
          @FormParam(&quot;trailerActive&quot;) Boolean trailerActive, @FormParam(&quot;titleSlideActive&quot;) Boolean titleSlideActive,
          @FormParam(&quot;licenseSlideActive&quot;) Boolean licenseSlideActive,
          @FormParam(&quot;watermarkActive&quot;) Boolean watermarkActive, @FormParam(&quot;bumperFile&quot;) String bumperFile,
          @FormParam(&quot;trailerFile&quot;) String trailerFile, @FormParam(&quot;watermarkFile&quot;) String watermarkFile,
          @FormParam(&quot;titleSlideBackground&quot;) String titleSlideBackground,
          @FormParam(&quot;licenseSlideBackground&quot;) String licenseSlideBackground,
          @FormParam(&quot;titleSlideMetadata&quot;) String titleSlideMetadata,
          @FormParam(&quot;licenseSlideDescription&quot;) String licenseSlideDescription,
          @FormParam(&quot;watermarkPosition&quot;) String watermarkPosition) {
<span class="fc" id="L354">    User creator = securityService.getUser();</span>

<span class="fc" id="L356">    Theme theme = new Theme(Option.&lt;Long&gt; none(), new Date(), isDefault, creator, name,</span>
<span class="fc" id="L357">            StringUtils.trimToNull(description), BooleanUtils.toBoolean(bumperActive),</span>
<span class="fc" id="L358">            StringUtils.trimToNull(bumperFile), BooleanUtils.toBoolean(trailerActive),</span>
<span class="fc" id="L359">            StringUtils.trimToNull(trailerFile), BooleanUtils.toBoolean(titleSlideActive),</span>
<span class="fc" id="L360">            StringUtils.trimToNull(titleSlideMetadata), StringUtils.trimToNull(titleSlideBackground),</span>
<span class="fc" id="L361">            BooleanUtils.toBoolean(licenseSlideActive), StringUtils.trimToNull(licenseSlideBackground),</span>
<span class="fc" id="L362">            StringUtils.trimToNull(licenseSlideDescription), BooleanUtils.toBoolean(watermarkActive),</span>
<span class="fc" id="L363">            StringUtils.trimToNull(watermarkFile), StringUtils.trimToNull(watermarkPosition));</span>

    try {
<span class="fc" id="L366">      persistReferencedFiles(theme);</span>
<span class="nc" id="L367">    } catch (NotFoundException e) {</span>
<span class="nc" id="L368">      logger.warn(&quot;A file that is referenced in theme '{}' was not found: {}&quot;, theme, e.getMessage());</span>
<span class="nc" id="L369">      return R.badRequest(&quot;Referenced non-existing file&quot;);</span>
<span class="nc" id="L370">    } catch (IOException e) {</span>
<span class="nc" id="L371">      logger.warn(&quot;Error while persisting file: {}&quot;, e.getMessage());</span>
<span class="nc" id="L372">      return R.serverError();</span>
<span class="fc" id="L373">    }</span>

    try {
<span class="fc" id="L376">      Theme createdTheme = themesServiceDatabase.updateTheme(theme);</span>
<span class="fc" id="L377">      return RestUtils.okJson(themeToJSON(createdTheme));</span>
<span class="nc" id="L378">    } catch (ThemesServiceDatabaseException e) {</span>
<span class="nc" id="L379">      logger.error(&quot;Unable to create a theme&quot;);</span>
<span class="nc" id="L380">      return RestUtil.R.serverError();</span>
    }
  }

  @PUT
  @Path(&quot;{themeId}&quot;)
  @RestQuery(name = &quot;updateTheme&quot;, description = &quot;Updates a theme&quot;, returnDescription = &quot;Return the updated theme&quot;, pathParameters = { @RestParameter(name = &quot;themeId&quot;, description = &quot;The theme identifier&quot;, isRequired = true, type = Type.INTEGER) }, restParameters = {
          @RestParameter(name = &quot;default&quot;, description = &quot;Whether the theme is default&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;name&quot;, description = &quot;The theme name&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;description&quot;, description = &quot;The theme description&quot;, isRequired = false, type = Type.TEXT),
          @RestParameter(name = &quot;bumperActive&quot;, description = &quot;Whether the theme bumper is active&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;trailerActive&quot;, description = &quot;Whether the theme trailer is active&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;titleSlideActive&quot;, description = &quot;Whether the theme title slide is active&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;licenseSlideActive&quot;, description = &quot;Whether the theme license slide is active&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;watermarkActive&quot;, description = &quot;Whether the theme watermark is active&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;bumperFile&quot;, description = &quot;The theme bumper file&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;trailerFile&quot;, description = &quot;The theme trailer file&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;watermarkFile&quot;, description = &quot;The theme watermark file&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;titleSlideBackground&quot;, description = &quot;The theme title slide background file&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;licenseSlideBackground&quot;, description = &quot;The theme license slide background file&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;titleSlideMetadata&quot;, description = &quot;The theme title slide metadata&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;licenseSlideDescription&quot;, description = &quot;The theme license slide description&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;watermarkPosition&quot;, description = &quot;The theme watermark position&quot;, isRequired = false, type = Type.STRING), }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Theme updated&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;If the theme has not been found.&quot;), })
  public Response updateTheme(@PathParam(&quot;themeId&quot;) long themeId, @FormParam(&quot;default&quot;) Boolean isDefault,
          @FormParam(&quot;name&quot;) String name, @FormParam(&quot;description&quot;) String description,
          @FormParam(&quot;bumperActive&quot;) Boolean bumperActive, @FormParam(&quot;trailerActive&quot;) Boolean trailerActive,
          @FormParam(&quot;titleSlideActive&quot;) Boolean titleSlideActive,
          @FormParam(&quot;licenseSlideActive&quot;) Boolean licenseSlideActive,
          @FormParam(&quot;watermarkActive&quot;) Boolean watermarkActive, @FormParam(&quot;bumperFile&quot;) String bumperFile,
          @FormParam(&quot;trailerFile&quot;) String trailerFile, @FormParam(&quot;watermarkFile&quot;) String watermarkFile,
          @FormParam(&quot;titleSlideBackground&quot;) String titleSlideBackground,
          @FormParam(&quot;licenseSlideBackground&quot;) String licenseSlideBackground,
          @FormParam(&quot;titleSlideMetadata&quot;) String titleSlideMetadata,
          @FormParam(&quot;licenseSlideDescription&quot;) String licenseSlideDescription,
          @FormParam(&quot;watermarkPosition&quot;) String watermarkPosition) throws NotFoundException {
    try {
<span class="fc" id="L418">      Theme origTheme = themesServiceDatabase.getTheme(themeId);</span>

<span class="pc bpc" id="L420" title="1 of 2 branches missed.">      if (isDefault == null)</span>
<span class="nc" id="L421">        isDefault = origTheme.isDefault();</span>
<span class="pc bpc" id="L422" title="1 of 2 branches missed.">      if (StringUtils.isBlank(name))</span>
<span class="nc" id="L423">        name = origTheme.getName();</span>
<span class="pc bpc" id="L424" title="1 of 2 branches missed.">      if (StringUtils.isEmpty(description))</span>
<span class="nc" id="L425">        description = origTheme.getDescription();</span>
<span class="pc bpc" id="L426" title="1 of 2 branches missed.">      if (bumperActive == null)</span>
<span class="nc" id="L427">        bumperActive = origTheme.isBumperActive();</span>
<span class="pc bpc" id="L428" title="1 of 2 branches missed.">      if (StringUtils.isEmpty(bumperFile))</span>
<span class="nc" id="L429">        bumperFile = origTheme.getBumperFile();</span>
<span class="pc bpc" id="L430" title="1 of 2 branches missed.">      if (trailerActive == null)</span>
<span class="nc" id="L431">        trailerActive = origTheme.isTrailerActive();</span>
<span class="pc bpc" id="L432" title="1 of 2 branches missed.">      if (StringUtils.isEmpty(trailerFile))</span>
<span class="nc" id="L433">        trailerFile = origTheme.getTrailerFile();</span>
<span class="pc bpc" id="L434" title="1 of 2 branches missed.">      if (titleSlideActive == null)</span>
<span class="nc" id="L435">        titleSlideActive = origTheme.isTitleSlideActive();</span>
<span class="pc bpc" id="L436" title="1 of 2 branches missed.">      if (StringUtils.isEmpty(titleSlideMetadata))</span>
<span class="nc" id="L437">        titleSlideMetadata = origTheme.getTitleSlideMetadata();</span>
<span class="pc bpc" id="L438" title="1 of 2 branches missed.">      if (StringUtils.isEmpty(titleSlideBackground))</span>
<span class="nc" id="L439">        titleSlideBackground = origTheme.getTitleSlideBackground();</span>
<span class="pc bpc" id="L440" title="1 of 2 branches missed.">      if (licenseSlideActive == null)</span>
<span class="nc" id="L441">        licenseSlideActive = origTheme.isLicenseSlideActive();</span>
<span class="pc bpc" id="L442" title="1 of 2 branches missed.">      if (StringUtils.isEmpty(licenseSlideBackground))</span>
<span class="nc" id="L443">        licenseSlideBackground = origTheme.getLicenseSlideBackground();</span>
<span class="pc bpc" id="L444" title="1 of 2 branches missed.">      if (StringUtils.isEmpty(licenseSlideDescription))</span>
<span class="nc" id="L445">        licenseSlideDescription = origTheme.getLicenseSlideDescription();</span>
<span class="pc bpc" id="L446" title="1 of 2 branches missed.">      if (watermarkActive == null)</span>
<span class="nc" id="L447">        watermarkActive = origTheme.isWatermarkActive();</span>
<span class="pc bpc" id="L448" title="1 of 2 branches missed.">      if (StringUtils.isEmpty(watermarkFile))</span>
<span class="nc" id="L449">        watermarkFile = origTheme.getWatermarkFile();</span>
<span class="pc bpc" id="L450" title="1 of 2 branches missed.">      if (StringUtils.isEmpty(watermarkPosition))</span>
<span class="nc" id="L451">        watermarkPosition = origTheme.getWatermarkPosition();</span>

<span class="fc" id="L453">      Theme theme = new Theme(origTheme.getId(), origTheme.getCreationDate(), isDefault, origTheme.getCreator(), name,</span>
<span class="fc" id="L454">              StringUtils.trimToNull(description), BooleanUtils.toBoolean(bumperActive),</span>
<span class="fc" id="L455">              StringUtils.trimToNull(bumperFile), BooleanUtils.toBoolean(trailerActive),</span>
<span class="fc" id="L456">              StringUtils.trimToNull(trailerFile), BooleanUtils.toBoolean(titleSlideActive),</span>
<span class="fc" id="L457">              StringUtils.trimToNull(titleSlideMetadata), StringUtils.trimToNull(titleSlideBackground),</span>
<span class="fc" id="L458">              BooleanUtils.toBoolean(licenseSlideActive), StringUtils.trimToNull(licenseSlideBackground),</span>
<span class="fc" id="L459">              StringUtils.trimToNull(licenseSlideDescription), BooleanUtils.toBoolean(watermarkActive),</span>
<span class="fc" id="L460">              StringUtils.trimToNull(watermarkFile), StringUtils.trimToNull(watermarkPosition));</span>

      try {
<span class="fc" id="L463">        updateReferencedFiles(origTheme, theme);</span>
<span class="nc" id="L464">      } catch (IOException e) {</span>
<span class="nc" id="L465">        logger.warn(&quot;Error while persisting file: {}&quot;, e.getMessage());</span>
<span class="nc" id="L466">        return R.serverError();</span>
<span class="nc" id="L467">      } catch (NotFoundException e) {</span>
<span class="nc" id="L468">        logger.warn(&quot;A file that is referenced in theme '{}' was not found: {}&quot;, theme, e.getMessage());</span>
<span class="nc" id="L469">        return R.badRequest(&quot;Referenced non-existing file&quot;);</span>
<span class="fc" id="L470">      }</span>

<span class="fc" id="L472">      Theme updatedTheme = themesServiceDatabase.updateTheme(theme);</span>
<span class="fc" id="L473">      return RestUtils.okJson(themeToJSON(updatedTheme));</span>
<span class="nc" id="L474">    } catch (ThemesServiceDatabaseException e) {</span>
<span class="nc" id="L475">      logger.error(&quot;Unable to update theme {}&quot;, themeId, e);</span>
<span class="nc" id="L476">      return RestUtil.R.serverError();</span>
    }
  }

  @DELETE
  @Path(&quot;{themeId}&quot;)
  @RestQuery(name = &quot;deleteTheme&quot;, description = &quot;Deletes a theme&quot;, returnDescription = &quot;The method doesn't return any content&quot;, pathParameters = { @RestParameter(name = &quot;themeId&quot;, isRequired = true, description = &quot;The theme identifier&quot;, type = RestParameter.Type.INTEGER) }, responses = {
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;If the theme has not been found.&quot;),
          @RestResponse(responseCode = SC_NO_CONTENT, description = &quot;The method does not return any content&quot;),
          @RestResponse(responseCode = SC_UNAUTHORIZED, description = &quot;If the current user is not authorized to perform this action&quot;) })
  public Response deleteTheme(@PathParam(&quot;themeId&quot;) long themeId) throws NotFoundException, UnauthorizedException {
    try {
<span class="fc" id="L488">      Theme theme = themesServiceDatabase.getTheme(themeId);</span>
      try {
<span class="fc" id="L490">        deleteReferencedFiles(theme);</span>
<span class="nc" id="L491">      } catch (IOException e) {</span>
<span class="nc" id="L492">        logger.warn(&quot;Error while deleting referenced file: {}&quot;, e.getMessage());</span>
<span class="nc" id="L493">        return R.serverError();</span>
<span class="fc" id="L494">      }</span>

<span class="fc" id="L496">      themesServiceDatabase.deleteTheme(themeId);</span>
<span class="fc" id="L497">      deleteThemeOnSeries(themeId);</span>

<span class="fc" id="L499">      return RestUtil.R.noContent();</span>
<span class="fc" id="L500">    } catch (NotFoundException e) {</span>
<span class="fc" id="L501">      logger.warn(&quot;Unable to find a theme with id &quot; + themeId);</span>
<span class="fc" id="L502">      throw e;</span>
<span class="nc" id="L503">    } catch (ThemesServiceDatabaseException e) {</span>
<span class="nc" id="L504">      logger.error(&quot;Error getting theme {} during delete operation because:&quot;, themeId,</span>
              e);
<span class="nc" id="L506">      return RestUtil.R.serverError();</span>
    }
  }

  /**
   * Deletes all related series theme entries
   *
   * @param themeId
   *          the theme id
   */
  private void deleteThemeOnSeries(long themeId) throws UnauthorizedException {
<span class="fc" id="L517">    SeriesSearchQuery query = new SeriesSearchQuery(securityService.getOrganization().getId(),</span>
<span class="fc" id="L518">            securityService.getUser()).withTheme(themeId);</span>
<span class="fc" id="L519">    SearchResult&lt;Series&gt; results = null;</span>
    try {
<span class="fc" id="L521">      results = searchIndex.getByQuery(query);</span>
<span class="nc" id="L522">    } catch (SearchIndexException e) {</span>
<span class="nc" id="L523">      logger.error(&quot;The admin UI Search Index was not able to get the series with theme '{}':&quot;, themeId, e);</span>
<span class="nc" id="L524">      throw new WebApplicationException(e, Status.INTERNAL_SERVER_ERROR);</span>
<span class="fc" id="L525">    }</span>
<span class="fc bfc" id="L526" title="All 2 branches covered.">    for (SearchResultItem&lt;Series&gt; item : results.getItems()) {</span>
<span class="fc" id="L527">      String seriesId = item.getSource().getIdentifier();</span>
      try {
<span class="fc" id="L529">        seriesService.deleteSeriesProperty(seriesId, SeriesEndpoint.THEME_KEY);</span>
<span class="nc" id="L530">      } catch (NotFoundException e) {</span>
<span class="nc" id="L531">        logger.warn(&quot;Theme {} already deleted on series {}&quot;, themeId, seriesId);</span>
<span class="nc" id="L532">      } catch (SeriesException e) {</span>
<span class="nc" id="L533">        logger.error(&quot;Unable to remove theme from series {}&quot;, seriesId, e);</span>
<span class="nc" id="L534">        throw new WebApplicationException(e, Status.INTERNAL_SERVER_ERROR);</span>
<span class="pc" id="L535">      }</span>
    }
<span class="fc" id="L537">  }</span>

  /**
   * Get a single theme
   *
   * @param id
   *          the theme id
   * @return a theme or none if not found, wrapped in an option
   * @throws SearchIndexException
   */
  private Opt&lt;IndexTheme&gt; getTheme(long id) throws SearchIndexException {
<span class="fc" id="L548">    SearchResult&lt;IndexTheme&gt; result = searchIndex</span>
<span class="fc" id="L549">            .getByQuery(new ThemeSearchQuery(securityService.getOrganization().getId(), securityService.getUser())</span>
<span class="fc" id="L550">                    .withIdentifier(id));</span>
<span class="fc bfc" id="L551" title="All 2 branches covered.">    if (result.getPageSize() == 0) {</span>
<span class="fc" id="L552">      logger.debug(&quot;Didn't find theme with id {}&quot;, id);</span>
<span class="fc" id="L553">      return Opt.&lt;IndexTheme&gt; none();</span>
    }
<span class="fc" id="L555">    return Opt.some(result.getItems()[0].getSource());</span>
  }

  /**
   * Returns the JSON representation of this theme.
   *
   * @param theme
   *          the theme
   * @param editResponse
   *          whether the returning representation should contain edit information
   * @return the JSON representation of this theme.
   */
  private JValue themeToJSON(IndexTheme theme, boolean editResponse) {
<span class="fc" id="L568">    List&lt;Field&gt; fields = new ArrayList&lt;Field&gt;();</span>
<span class="fc" id="L569">    fields.add(f(&quot;id&quot;, v(theme.getIdentifier())));</span>
<span class="fc" id="L570">    fields.add(f(&quot;creationDate&quot;, v(DateTimeSupport.toUTC(theme.getCreationDate().getTime()))));</span>
<span class="fc" id="L571">    fields.add(f(&quot;default&quot;, v(theme.isDefault())));</span>
<span class="fc" id="L572">    fields.add(f(&quot;name&quot;, v(theme.getName())));</span>
<span class="fc" id="L573">    fields.add(f(&quot;creator&quot;, v(theme.getCreator())));</span>
<span class="fc" id="L574">    fields.add(f(&quot;description&quot;, v(theme.getDescription(), Jsons.BLANK)));</span>
<span class="fc" id="L575">    fields.add(f(&quot;bumperActive&quot;, v(theme.isBumperActive())));</span>
<span class="fc" id="L576">    fields.add(f(&quot;bumperFile&quot;, v(theme.getBumperFile(), Jsons.BLANK)));</span>
<span class="fc" id="L577">    fields.add(f(&quot;trailerActive&quot;, v(theme.isTrailerActive())));</span>
<span class="fc" id="L578">    fields.add(f(&quot;trailerFile&quot;, v(theme.getTrailerFile(), Jsons.BLANK)));</span>
<span class="fc" id="L579">    fields.add(f(&quot;titleSlideActive&quot;, v(theme.isTitleSlideActive())));</span>
<span class="fc" id="L580">    fields.add(f(&quot;titleSlideMetadata&quot;, v(theme.getTitleSlideMetadata(), Jsons.BLANK)));</span>
<span class="fc" id="L581">    fields.add(f(&quot;titleSlideBackground&quot;, v(theme.getTitleSlideBackground(), Jsons.BLANK)));</span>
<span class="fc" id="L582">    fields.add(f(&quot;licenseSlideActive&quot;, v(theme.isLicenseSlideActive())));</span>
<span class="fc" id="L583">    fields.add(f(&quot;licenseSlideDescription&quot;, v(theme.getLicenseSlideDescription(), Jsons.BLANK)));</span>
<span class="fc" id="L584">    fields.add(f(&quot;licenseSlideBackground&quot;, v(theme.getLicenseSlideBackground(), Jsons.BLANK)));</span>
<span class="fc" id="L585">    fields.add(f(&quot;watermarkActive&quot;, v(theme.isWatermarkActive())));</span>
<span class="fc" id="L586">    fields.add(f(&quot;watermarkFile&quot;, v(theme.getWatermarkFile(), Jsons.BLANK)));</span>
<span class="fc" id="L587">    fields.add(f(&quot;watermarkPosition&quot;, v(theme.getWatermarkPosition(), Jsons.BLANK)));</span>
<span class="fc bfc" id="L588" title="All 2 branches covered.">    if (editResponse) {</span>
<span class="fc" id="L589">      extendStaticFileInfo(&quot;bumperFile&quot;, theme.getBumperFile(), fields);</span>
<span class="fc" id="L590">      extendStaticFileInfo(&quot;trailerFile&quot;, theme.getTrailerFile(), fields);</span>
<span class="fc" id="L591">      extendStaticFileInfo(&quot;titleSlideBackground&quot;, theme.getTitleSlideBackground(), fields);</span>
<span class="fc" id="L592">      extendStaticFileInfo(&quot;licenseSlideBackground&quot;, theme.getLicenseSlideBackground(), fields);</span>
<span class="fc" id="L593">      extendStaticFileInfo(&quot;watermarkFile&quot;, theme.getWatermarkFile(), fields);</span>
    }
<span class="fc" id="L595">    return obj(fields);</span>
  }

  private void extendStaticFileInfo(String fieldName, String staticFileId, List&lt;Field&gt; fields) {
<span class="fc bfc" id="L599" title="All 2 branches covered.">    if (StringUtils.isNotBlank(staticFileId)) {</span>
      try {
<span class="fc" id="L601">        fields.add(f(fieldName.concat(&quot;Name&quot;), v(staticFileService.getFileName(staticFileId))));</span>
<span class="fc" id="L602">        fields.add(f(fieldName.concat(&quot;Url&quot;), v(staticFileRestService.getStaticFileURL(staticFileId).toString(), Jsons.BLANK)));</span>
<span class="nc" id="L603">      } catch (IllegalStateException | NotFoundException e) {</span>
<span class="nc" id="L604">        logger.error(&quot;Error retreiving static file '{}' &quot;, staticFileId, e);</span>
<span class="fc" id="L605">      }</span>
    }
<span class="fc" id="L607">  }</span>

  /**
   * @return The JSON representation of this theme.
   */
  private JValue themeToJSON(Theme theme) {
<span class="pc bpc" id="L613" title="1 of 2 branches missed.">    String creator = StringUtils.isNotBlank(theme.getCreator().getName()) ? theme.getCreator().getName() : theme</span>
<span class="pc" id="L614">            .getCreator().getUsername();</span>

<span class="fc" id="L616">    List&lt;Field&gt; fields = new ArrayList&lt;Field&gt;();</span>
<span class="fc" id="L617">    fields.add(f(&quot;id&quot;, v(theme.getId().getOrElse(-1L))));</span>
<span class="fc" id="L618">    fields.add(f(&quot;creationDate&quot;, v(DateTimeSupport.toUTC(theme.getCreationDate().getTime()))));</span>
<span class="fc" id="L619">    fields.add(f(&quot;default&quot;, v(theme.isDefault())));</span>
<span class="fc" id="L620">    fields.add(f(&quot;name&quot;, v(theme.getName())));</span>
<span class="fc" id="L621">    fields.add(f(&quot;creator&quot;, v(creator)));</span>
<span class="fc" id="L622">    fields.add(f(&quot;description&quot;, v(theme.getDescription(), Jsons.BLANK)));</span>
<span class="fc" id="L623">    fields.add(f(&quot;bumperActive&quot;, v(theme.isBumperActive())));</span>
<span class="fc" id="L624">    fields.add(f(&quot;bumperFile&quot;, v(theme.getBumperFile(), Jsons.BLANK)));</span>
<span class="fc" id="L625">    fields.add(f(&quot;trailerActive&quot;, v(theme.isTrailerActive())));</span>
<span class="fc" id="L626">    fields.add(f(&quot;trailerFile&quot;, v(theme.getTrailerFile(), Jsons.BLANK)));</span>
<span class="fc" id="L627">    fields.add(f(&quot;titleSlideActive&quot;, v(theme.isTitleSlideActive())));</span>
<span class="fc" id="L628">    fields.add(f(&quot;titleSlideMetadata&quot;, v(theme.getTitleSlideMetadata(), Jsons.BLANK)));</span>
<span class="fc" id="L629">    fields.add(f(&quot;titleSlideBackground&quot;, v(theme.getTitleSlideBackground(), Jsons.BLANK)));</span>
<span class="fc" id="L630">    fields.add(f(&quot;licenseSlideActive&quot;, v(theme.isLicenseSlideActive())));</span>
<span class="fc" id="L631">    fields.add(f(&quot;licenseSlideDescription&quot;, v(theme.getLicenseSlideDescription(), Jsons.BLANK)));</span>
<span class="fc" id="L632">    fields.add(f(&quot;licenseSlideBackground&quot;, v(theme.getLicenseSlideBackground(), Jsons.BLANK)));</span>
<span class="fc" id="L633">    fields.add(f(&quot;watermarkActive&quot;, v(theme.isWatermarkActive())));</span>
<span class="fc" id="L634">    fields.add(f(&quot;watermarkFile&quot;, v(theme.getWatermarkFile(), Jsons.BLANK)));</span>
<span class="fc" id="L635">    fields.add(f(&quot;watermarkPosition&quot;, v(theme.getWatermarkPosition(), Jsons.BLANK)));</span>
<span class="fc" id="L636">    return obj(fields);</span>
  }

  /**
   * Persist all files that are referenced in the theme.
   *
   * @param theme
   *          The theme
   * @throws NotFoundException
   *           If a referenced file is not found.
   * @throws IOException
   *           If there was an error while persisting the file.
   */
  private void persistReferencedFiles(Theme theme) throws NotFoundException, IOException {
<span class="pc bpc" id="L650" title="1 of 2 branches missed.">    if (isNotBlank(theme.getBumperFile()))</span>
<span class="fc" id="L651">      staticFileService.persistFile(theme.getBumperFile());</span>
<span class="pc bpc" id="L652" title="1 of 2 branches missed.">    if (isNotBlank(theme.getLicenseSlideBackground()))</span>
<span class="fc" id="L653">      staticFileService.persistFile(theme.getLicenseSlideBackground());</span>
<span class="pc bpc" id="L654" title="1 of 2 branches missed.">    if (isNotBlank(theme.getTitleSlideBackground()))</span>
<span class="fc" id="L655">      staticFileService.persistFile(theme.getTitleSlideBackground());</span>
<span class="pc bpc" id="L656" title="1 of 2 branches missed.">    if (isNotBlank(theme.getTrailerFile()))</span>
<span class="fc" id="L657">      staticFileService.persistFile(theme.getTrailerFile());</span>
<span class="pc bpc" id="L658" title="1 of 2 branches missed.">    if (isNotBlank(theme.getWatermarkFile()))</span>
<span class="fc" id="L659">      staticFileService.persistFile(theme.getWatermarkFile());</span>
<span class="fc" id="L660">  }</span>

  /**
   * Delete all files that are referenced in the theme.
   *
   * @param theme
   *          The theme
   * @throws NotFoundException
   *           If a referenced file is not found.
   * @throws IOException
   *           If there was an error while persisting the file.
   */
  private void deleteReferencedFiles(Theme theme) throws NotFoundException, IOException {
<span class="pc bpc" id="L673" title="1 of 2 branches missed.">    if (isNotBlank(theme.getBumperFile()))</span>
<span class="fc" id="L674">      staticFileService.deleteFile(theme.getBumperFile());</span>
<span class="pc bpc" id="L675" title="1 of 2 branches missed.">    if (isNotBlank(theme.getLicenseSlideBackground()))</span>
<span class="fc" id="L676">      staticFileService.deleteFile(theme.getLicenseSlideBackground());</span>
<span class="pc bpc" id="L677" title="1 of 2 branches missed.">    if (isNotBlank(theme.getTitleSlideBackground()))</span>
<span class="fc" id="L678">      staticFileService.deleteFile(theme.getTitleSlideBackground());</span>
<span class="pc bpc" id="L679" title="1 of 2 branches missed.">    if (isNotBlank(theme.getTrailerFile()))</span>
<span class="fc" id="L680">      staticFileService.deleteFile(theme.getTrailerFile());</span>
<span class="pc bpc" id="L681" title="1 of 2 branches missed.">    if (isNotBlank(theme.getWatermarkFile()))</span>
<span class="fc" id="L682">      staticFileService.deleteFile(theme.getWatermarkFile());</span>
<span class="fc" id="L683">  }</span>

  /**
   * Update all files that have changed between {@code original} and {@code updated}.
   *
   * @param original
   *          The original theme
   * @param updated
   *          The updated theme
   * @throws NotFoundException
   *           If one of the referenced files could not be found.
   * @throws IOException
   *           If there was an error while updating the referenced files.
   */
  private void updateReferencedFiles(Theme original, Theme updated) throws NotFoundException, IOException {
<span class="fc" id="L698">    updateReferencedFile(original.getBumperFile(), updated.getBumperFile());</span>
<span class="fc" id="L699">    updateReferencedFile(original.getLicenseSlideBackground(), updated.getLicenseSlideBackground());</span>
<span class="fc" id="L700">    updateReferencedFile(original.getTitleSlideBackground(), updated.getTitleSlideBackground());</span>
<span class="fc" id="L701">    updateReferencedFile(original.getTrailerFile(), updated.getTrailerFile());</span>
<span class="fc" id="L702">    updateReferencedFile(original.getWatermarkFile(), updated.getWatermarkFile());</span>
<span class="fc" id="L703">  }</span>

  /**
   * If the file resource has changed between {@code original} and {@code updated}, the original file is deleted and the
   * updated one persisted.
   *
   * @param original
   *          The UUID of the original file
   * @param updated
   *          The UUID of the updated file
   * @throws NotFoundException
   *           If the file could not be found
   * @throws IOException
   *           If there was an error while persisting or deleting one of the files.
   */
  private void updateReferencedFile(String original, String updated) throws NotFoundException, IOException {
<span class="pc bpc" id="L719" title="1 of 2 branches missed.">    if (EqualsUtil.ne(original, updated)) {</span>
<span class="pc bpc" id="L720" title="1 of 2 branches missed.">      if (isNotBlank(original))</span>
<span class="fc" id="L721">        staticFileService.deleteFile(original);</span>
<span class="pc bpc" id="L722" title="1 of 2 branches missed.">      if (isNotBlank(updated))</span>
<span class="fc" id="L723">        staticFileService.persistFile(updated);</span>
    }
<span class="fc" id="L725">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>