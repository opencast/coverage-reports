<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ListProvidersEndpoint.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-admin-ui</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.adminui.endpoint</a> &gt; <span class="el_source">ListProvidersEndpoint.java</span></div><h1>ListProvidersEndpoint.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.adminui.endpoint;

import static org.opencastproject.adminui.endpoint.EndpointUtil.addRequestFiltersToQuery;
import static org.opencastproject.adminui.endpoint.EndpointUtil.generateJSONObject;

import org.opencastproject.adminui.exception.JsonCreationException;
import org.opencastproject.index.service.resources.list.query.AclsListQuery;
import org.opencastproject.index.service.resources.list.query.AgentsListQuery;
import org.opencastproject.index.service.resources.list.query.EventListQuery;
import org.opencastproject.index.service.resources.list.query.GroupsListQuery;
import org.opencastproject.index.service.resources.list.query.JobsListQuery;
import org.opencastproject.index.service.resources.list.query.SeriesListQuery;
import org.opencastproject.index.service.resources.list.query.ServersListQuery;
import org.opencastproject.index.service.resources.list.query.ServicesListQuery;
import org.opencastproject.index.service.resources.list.query.ThemesListQuery;
import org.opencastproject.index.service.resources.list.query.UsersListQuery;
import org.opencastproject.index.service.util.JSONUtils;
import org.opencastproject.index.service.util.RestUtils;
import org.opencastproject.list.api.ListProviderException;
import org.opencastproject.list.api.ListProvidersService;
import org.opencastproject.list.api.ResourceListQuery;
import org.opencastproject.list.impl.ListProviderNotFoundException;
import org.opencastproject.list.impl.ResourceListQueryImpl;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.util.doc.rest.RestParameter;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestResponse;
import org.opencastproject.util.doc.rest.RestService;

import org.apache.commons.lang3.StringUtils;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.osgi.framework.BundleContext;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.jaxrs.whiteboard.propertytypes.JaxrsResource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Map;

import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.core.Context;
import javax.ws.rs.core.HttpHeaders;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;

@Path(&quot;/admin-ng/resources&quot;)
@RestService(name = &quot;ResourceListsProviders&quot;, title = &quot;Admin UI - Resources List&quot;,
  abstractText = &quot;This service provides key-value list from different resources to use in the admin UI.&quot;,
  notes = { &quot;This service offers access to list providers for the admin UI.&quot;,
            &quot;&lt;strong&gt;Important:&lt;/strong&gt; &quot;
              + &quot;&lt;em&gt;This service is for exclusive use by the module admin-ui. Its API might change &quot;
              + &quot;anytime without prior notice. Any dependencies other than the admin UI will be strictly ignored. &quot;
              + &quot;DO NOT use this for integration of third-party applications.&lt;em&gt;&quot;})
@Component(
        immediate = true,
        service = ListProvidersEndpoint.class,
        property = {
                &quot;service.description=Admin UI - Resource List Provider Endpoint&quot;,
                &quot;opencast.service.type=org.opencastproject.adminui.ListProvidersEndpoint&quot;,
                &quot;opencast.service.path=/admin-ng/resources&quot;,
        }
)
@JaxrsResource
<span class="fc" id="L92">public class ListProvidersEndpoint {</span>

<span class="fc" id="L94">  private static final Logger logger = LoggerFactory.getLogger(ListProvidersEndpoint.class);</span>

<span class="fc" id="L96">  public static final Response UNAUTHORIZED = Response.status(Response.Status.UNAUTHORIZED).build();</span>
<span class="fc" id="L97">  public static final Response NOT_FOUND = Response.status(Response.Status.NOT_FOUND).build();</span>
<span class="fc" id="L98">  public static final Response SERVER_ERROR = Response.serverError().build();</span>
<span class="fc" id="L99">  public static final Response NO_CONTENT = Response.noContent().build();</span>

  private SecurityService securityService;
  private ListProvidersService listProvidersService;
  private SeriesEndpoint seriesEndpoint;

  /** This regex is used to reduce the users in the filter selectbox.
   * The filter is located in the top right corner in the admin ui. */
  private static final String PROP_KEY_USER_FILTER_REGEX = &quot;org.opencastproject.adminui.filter.user.regex&quot;;
  private static final String PROP_KEY_USER_FILTER_REGEX_DEFAULT = &quot;.*&quot;;

  protected void activate(BundleContext bundleContext) {
<span class="nc" id="L111">    logger.info(&quot;Activate list provider service&quot;);</span>
<span class="nc" id="L112">    JSONUtils.setUserRegex(StringUtils.defaultIfBlank(</span>
<span class="nc" id="L113">            bundleContext.getProperty(PROP_KEY_USER_FILTER_REGEX),</span>
            PROP_KEY_USER_FILTER_REGEX_DEFAULT));
<span class="nc" id="L115">  }</span>

  /** OSGi callback for series services. */
  @Reference
  public void setListProvidersService(ListProvidersService listProvidersService) {
<span class="fc" id="L120">    this.listProvidersService = listProvidersService;</span>
<span class="fc" id="L121">  }</span>

  /** OSGi callback for sercurity service. */
  @Reference
  public void setSecurityService(SecurityService securitySerivce) {
<span class="fc" id="L126">    this.securityService = securitySerivce;</span>
<span class="fc" id="L127">  }</span>

  /** OSGi callback for series end point. */
  @Reference
  public void setSeriesEndpoint(SeriesEndpoint seriesEndpoint) {
<span class="nc" id="L132">    this.seriesEndpoint = seriesEndpoint;</span>
<span class="nc" id="L133">  }</span>

  @GET
  @Path(&quot;{source}.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;list&quot;, description = &quot;Provides key-value list from the given source&quot;, pathParameters = { @RestParameter(name = &quot;source&quot;, description = &quot;The source for the key-value list&quot;, isRequired = true, type = RestParameter.Type.STRING) }, restParameters = {
          @RestParameter(description = &quot;The maximum number of items to return per page&quot;, isRequired = false, name = &quot;limit&quot;, type = RestParameter.Type.INTEGER),
          @RestParameter(description = &quot;The offset&quot;, isRequired = false, name = &quot;offset&quot;, type = RestParameter.Type.INTEGER),
          @RestParameter(description = &quot;Filters&quot;, isRequired = false, name = &quot;filter&quot;, type = RestParameter.Type.STRING) }, responses = { @RestResponse(description = &quot;Returns the key-value list for the given source.&quot;, responseCode = HttpServletResponse.SC_OK) }, returnDescription = &quot;&quot;)
  public Response getList(@PathParam(&quot;source&quot;) final String source, @QueryParam(&quot;limit&quot;) final int limit,
          @QueryParam(&quot;filter&quot;) final String filter, @QueryParam(&quot;offset&quot;) final int offset,
          @Context HttpHeaders headers) {

<span class="fc" id="L146">    ResourceListQueryImpl query = new ResourceListQueryImpl();</span>
<span class="fc" id="L147">    query.setLimit(limit);</span>
<span class="fc" id="L148">    query.setOffset(offset);</span>
<span class="fc" id="L149">    addRequestFiltersToQuery(filter, query);</span>
    Map&lt;String, String&gt; autocompleteList;
    try {
<span class="fc" id="L152">      autocompleteList = listProvidersService.getList(source, query, false);</span>
<span class="fc" id="L153">    } catch (ListProviderNotFoundException e) {</span>
<span class="fc" id="L154">      logger.debug(&quot;No list found for {}&quot;, source, e);</span>
<span class="fc" id="L155">      return NOT_FOUND;</span>
<span class="nc" id="L156">    } catch (ListProviderException e) {</span>
<span class="nc" id="L157">      logger.error(&quot;Server error when getting list from provider {}&quot;, source, e);</span>
<span class="nc" id="L158">      return SERVER_ERROR;</span>
<span class="fc" id="L159">    }</span>

    JSONObject jsonList;
    try {
<span class="fc" id="L163">      jsonList = generateJSONObject(autocompleteList);</span>
<span class="nc" id="L164">    } catch (JsonCreationException e) {</span>
<span class="nc" id="L165">      logger.error(&quot;Not able to generate resources list JSON from source {}&quot;, source, e);</span>
<span class="nc" id="L166">      return SERVER_ERROR;</span>
<span class="fc" id="L167">    }</span>

<span class="fc" id="L169">    return Response.ok(jsonList.toString()).build();</span>
  }

  @GET
  @Path(&quot;components.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;components&quot;, description = &quot;Provides a set of constants lists (right now only eventCommentReasons) for use in the admin UI&quot;,
    responses = { @RestResponse(description = &quot;Returns a set of constants lists (right now only eventCommentReasons) for use in the admin UI&quot;,
    responseCode = HttpServletResponse.SC_OK) }, returnDescription = &quot;&quot;)
  public Response getComponents(@Context HttpHeaders headers) {
<span class="nc" id="L179">    String[] sources = { &quot;eventCommentReasons&quot; };</span>
<span class="nc" id="L180">    ResourceListQuery query = new ResourceListQueryImpl();</span>

<span class="nc" id="L182">    JSONObject list = new JSONObject();</span>

<span class="nc bnc" id="L184" title="All 2 branches missed.">    for (String source : sources) {</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">      if (listProvidersService.hasProvider(source)) {</span>
        JSONObject subList;
        try {
<span class="nc" id="L188">          subList = generateJSONObject(listProvidersService.getList(source, query, true));</span>
<span class="nc" id="L189">          list.put(source, subList);</span>
<span class="nc" id="L190">        } catch (JsonCreationException e) {</span>
<span class="nc" id="L191">          logger.error(&quot;Not able to generate resources list JSON from source {}&quot;, source, e);</span>
<span class="nc" id="L192">          return SERVER_ERROR;</span>
<span class="nc" id="L193">        } catch (ListProviderException e) {</span>
<span class="nc" id="L194">          logger.error(&quot;Not able to get list from provider {}&quot;, source, e);</span>
<span class="nc" id="L195">          return SERVER_ERROR;</span>
<span class="nc" id="L196">        }</span>
      } else {
<span class="nc" id="L198">        return NOT_FOUND;</span>
      }
    }

<span class="nc" id="L202">    return Response.ok(list.toString()).build();</span>
  }

  @GET
  @Path(&quot;providers.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;availableProviders&quot;, description = &quot;Provides the list of the available list providers&quot;, responses = { @RestResponse(description = &quot;Returns the availables list providers.&quot;, responseCode = HttpServletResponse.SC_OK) }, returnDescription = &quot;&quot;)
  public Response getAvailablesProviders(@Context HttpHeaders headers) {
<span class="nc" id="L210">    JSONArray list = new JSONArray();</span>

<span class="nc" id="L212">    list.add(listProvidersService.getAvailableProviders());</span>

<span class="nc" id="L214">    return Response.ok(list.toString()).build();</span>
  }

  @GET
  @Path(&quot;{page}/filters.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;filters&quot;, description = &quot;Provides filters for the given page&quot;, pathParameters = { @RestParameter(name = &quot;page&quot;, description = &quot;The page for which the filters are required&quot;, isRequired = true, type = RestParameter.Type.STRING) }, responses = { @RestResponse(description = &quot;Returns the filters for the given page.&quot;, responseCode = HttpServletResponse.SC_OK) }, returnDescription = &quot;&quot;)
  public Response getFilters(@PathParam(&quot;page&quot;) final String page, @Context HttpHeaders headers)
          throws ListProviderException {

    ResourceListQuery query;

<span class="nc bnc" id="L226" title="All 2 branches missed.">    if (&quot;series&quot;.equals(page)) {</span>
<span class="nc" id="L227">      query = new SeriesListQuery();</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">    } else if (&quot;events&quot;.equals(page)) {</span>
<span class="nc" id="L229">      query = new EventListQuery();</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">    } else if (&quot;jobs&quot;.equals(page)) {</span>
<span class="nc" id="L231">      query = new JobsListQuery();</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">    } else if (&quot;recordings&quot;.equals(page)) {</span>
<span class="nc" id="L233">      query = new AgentsListQuery();</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">    } else if (&quot;users&quot;.equals(page)) {</span>
<span class="nc" id="L235">      query = new UsersListQuery();</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">    } else if (&quot;groups&quot;.equals(page)) {</span>
<span class="nc" id="L237">      query = new GroupsListQuery();</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">    } else if (&quot;acls&quot;.equals(page)) {</span>
<span class="nc" id="L239">      query = new AclsListQuery();</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">    } else if (&quot;servers&quot;.equals(page)) {</span>
<span class="nc" id="L241">      query = new ServersListQuery();</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">    } else if (&quot;services&quot;.equals(page)) {</span>
<span class="nc" id="L243">      query = new ServicesListQuery();</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">    } else if (&quot;themes&quot;.equals(page)) {</span>
<span class="nc" id="L245">      query = new ThemesListQuery();</span>
    } else {
<span class="nc" id="L247">      logger.debug(&quot;No filters defined for the page {}.&quot;, page);</span>
<span class="nc" id="L248">      return NO_CONTENT;</span>
    }

    try {
<span class="nc bnc" id="L252" title="All 4 branches missed.">      if (&quot;events&quot;.equals(page) &amp;&amp; seriesEndpoint.getOnlySeriesWithWriteAccessEventsFilter()) {</span>
<span class="nc" id="L253">        Map&lt;String, String&gt; seriesWriteAccess = seriesEndpoint.getUserSeriesByAccess(true);</span>
<span class="nc" id="L254">        return RestUtils.okJson(JSONUtils.filtersToJSONSeriesWriteAccess(query, listProvidersService,</span>
                seriesWriteAccess));
      } else {
<span class="nc" id="L257">        return RestUtils.okJson(JSONUtils.filtersToJSON(query, listProvidersService, securityService.getOrganization()));</span>
      }
<span class="nc" id="L259">    } catch (ListProviderException e) {</span>
<span class="nc" id="L260">      logger.error(&quot;Not able to get list of options for the filters for the page {}&quot;, page, e);</span>
<span class="nc" id="L261">      return SERVER_ERROR;</span>
    }
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>