<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>UserSettingsEndpoint.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-admin-ui</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.adminui.endpoint</a> &gt; <span class="el_source">UserSettingsEndpoint.java</span></div><h1>UserSettingsEndpoint.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.adminui.endpoint;

import static org.apache.http.HttpStatus.SC_NOT_FOUND;
import static org.apache.http.HttpStatus.SC_OK;
import static org.opencastproject.util.RestUtil.getEndpointUrl;
import static org.opencastproject.util.doc.rest.RestParameter.Type.INTEGER;
import static org.opencastproject.util.doc.rest.RestParameter.Type.STRING;

import org.opencastproject.adminui.usersettings.UserSetting;
import org.opencastproject.adminui.usersettings.UserSettings;
import org.opencastproject.adminui.usersettings.UserSettingsService;
import org.opencastproject.adminui.usersettings.persistence.UserSettingsServiceException;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.UrlSupport;
import org.opencastproject.util.data.Tuple;
import org.opencastproject.util.doc.rest.RestParameter;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestResponse;
import org.opencastproject.util.doc.rest.RestService;

import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.jaxrs.whiteboard.propertytypes.JaxrsResource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;

import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.DELETE;
import javax.ws.rs.FormParam;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.PUT;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;

@Path(&quot;/admin-ng/user-settings&quot;)
@RestService(name = &quot;usersettings&quot;, title = &quot;User Settings service&quot;,
  abstractText = &quot;Provides operations for user settings&quot;,
  notes = { &quot;This service offers the default CRUD Operations for user settings for the admin UI.&quot;,
            &quot;&lt;strong&gt;Important:&lt;/strong&gt; &quot;
              + &quot;&lt;em&gt;This service is for exclusive use by the module admin-ui. Its API might change &quot;
              + &quot;anytime without prior notice. Any dependencies other than the admin UI will be strictly ignored. &quot;
              + &quot;DO NOT use this for integration of third-party applications.&lt;em&gt;&quot;})
@Component(
  immediate = true,
  service = UserSettingsEndpoint.class,
  property = {
    &quot;service.description=Admin UI - Users Settings facade Endpoint&quot;,
    &quot;opencast.service.type=org.opencastproject.adminui.endpoint.UserSettingsEndpoint&quot;,
    &quot;opencast.service.path=/admin-ng/user-settings&quot;
  }
)
@JaxrsResource
<span class="fc" id="L84">public class UserSettingsEndpoint {</span>

  /** The logging facility */
<span class="fc" id="L87">  private static final Logger logger = LoggerFactory.getLogger(ServerEndpoint.class);</span>

  /** Base url of this endpoint */
  private String endpointBaseUrl;

  private UserSettingsService userSettingsService;

  private SecurityService securityService;

  /**
   * OSGi callback to set the service to retrieve user settings from.
   */
  @Reference
  public void setUserSettingsService(UserSettingsService userSettingsService) {
<span class="fc" id="L101">    this.userSettingsService = userSettingsService;</span>
<span class="fc" id="L102">  }</span>

  /**
   * OSGi callback to set the security service
   */
  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="fc" id="L109">    this.securityService = securityService;</span>
<span class="fc" id="L110">  }</span>

  /** OSGi callback. */
  @Activate
  protected void activate(ComponentContext cc) {
<span class="nc" id="L115">    logger.info(&quot;Activate the Admin ui - Users facade endpoint&quot;);</span>
<span class="nc" id="L116">    final Tuple&lt;String, String&gt; endpointUrl = getEndpointUrl(cc);</span>
<span class="nc" id="L117">    endpointBaseUrl = UrlSupport.concat(endpointUrl.getA(), endpointUrl.getB());</span>
<span class="nc" id="L118">  }</span>

  @GET
  @Path(&quot;/settings.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;getUserSettings&quot;, description = &quot;Returns a list of the user settings for the current user&quot;, returnDescription = &quot;Returns a JSON representation of the list of user settings&quot;, restParameters = {
          @RestParameter(defaultValue = &quot;100&quot;, description = &quot;The maximum number of items to return per page.&quot;, isRequired = false, name = &quot;limit&quot;, type = RestParameter.Type.STRING),
          @RestParameter(defaultValue = &quot;0&quot;, description = &quot;The page number.&quot;, isRequired = false, name = &quot;offset&quot;, type = RestParameter.Type.STRING) }, responses = { @RestResponse(responseCode = SC_OK, description = &quot;The user settings.&quot;) })
  public Response getUserSettings(@QueryParam(&quot;limit&quot;) int limit, @QueryParam(&quot;offset&quot;) int offset) throws IOException {
<span class="fc bfc" id="L127" title="All 2 branches covered.">    if (limit &lt; 1) {</span>
<span class="fc" id="L128">      limit = 100;</span>
    }

    UserSettings userSettings;
    try {
<span class="fc" id="L133">      userSettings = userSettingsService.findUserSettings(limit, offset);</span>
<span class="nc" id="L134">    } catch (UserSettingsServiceException e) {</span>
<span class="nc" id="L135">      logger.error(&quot;Unable to get user settings:&quot;, e);</span>
<span class="nc" id="L136">      return (Response.serverError().build());</span>
<span class="fc" id="L137">    }</span>

<span class="fc" id="L139">    return Response.ok(userSettings.toJson().toJson()).build();</span>
  }

  @POST
  @Path(&quot;/setting&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;createUserSetting&quot;, description = &quot;Create a new user setting&quot;, returnDescription = &quot;Status ok&quot;, restParameters = {
          @RestParameter(description = &quot;The key used to represent this setting.&quot;, isRequired = true, name = &quot;key&quot;, type = STRING),
          @RestParameter(description = &quot;The value representing this setting.&quot;, isRequired = true, name = &quot;value&quot;, type = STRING) }, responses = { @RestResponse(responseCode = HttpServletResponse.SC_OK, description = &quot;User setting has been created.&quot;) })
  public Response createUserSetting(@FormParam(&quot;key&quot;) String key, @FormParam(&quot;value&quot;) String value)
          throws NotFoundException {
<span class="fc" id="L150">    String orgId = securityService.getOrganization().getId();</span>
<span class="fc" id="L151">    String username = securityService.getUser().getUsername();</span>
    try {
<span class="fc" id="L153">      UserSetting newUserSetting = userSettingsService.addUserSetting(key, value);</span>
<span class="fc" id="L154">      return Response.ok(newUserSetting.toJson().toJson(), MediaType.APPLICATION_JSON).build();</span>
<span class="nc" id="L155">    } catch (UserSettingsServiceException e) {</span>
<span class="nc" id="L156">      logger.error(&quot;Could not add user setting username '{}' org: '{}' key: '{}' value: '{}'&quot;, username, orgId,</span>
          key, value);
<span class="nc" id="L158">      return Response.serverError().build();</span>
    }
  }

  @PUT
  @Path(&quot;/setting/{settingId}&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;updateUserSetting&quot;, description = &quot;Update a user setting&quot;, returnDescription = &quot;The updated user setting as JSON&quot;, pathParameters = { @RestParameter(name = &quot;settingId&quot;, description = &quot;The setting's id&quot;, isRequired = true, type = RestParameter.Type.INTEGER) }, restParameters = {
          @RestParameter(description = &quot;The key used to represent this setting.&quot;, isRequired = true, name = &quot;key&quot;, type = STRING),
          @RestParameter(description = &quot;The value representing this setting.&quot;, isRequired = true, name = &quot;value&quot;, type = STRING) }, responses = { @RestResponse(responseCode = SC_OK, description = &quot;User setting has been created.&quot;) })
  public Response updateUserSetting(@PathParam(&quot;settingId&quot;) final int id, @FormParam(&quot;key&quot;) String key,
          @FormParam(&quot;value&quot;) String value) throws NotFoundException {
    try {
<span class="fc" id="L171">      UserSetting updatedUserSetting = userSettingsService.updateUserSetting(id, key, value);</span>
<span class="fc" id="L172">      return Response.ok(updatedUserSetting.toJson().toJson(), MediaType.APPLICATION_JSON).build();</span>
<span class="nc" id="L173">    } catch (UserSettingsServiceException e) {</span>
<span class="nc" id="L174">      logger.error(&quot;Unable to update user setting&quot;, e);</span>
<span class="nc" id="L175">      return Response.serverError().build();</span>
    }
  }

  @DELETE
  @Path(&quot;/setting/{settingId}&quot;)
  @RestQuery(name = &quot;deleteUserSetting&quot;, description = &quot;Delete a user setting&quot;, returnDescription = &quot;Status ok&quot;, pathParameters = @RestParameter(name = &quot;settingId&quot;, type = INTEGER, isRequired = true, description = &quot;The id of the user setting.&quot;), responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;User setting has been deleted.&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;User setting not found.&quot;) })
  public Response deleteUserSetting(@PathParam(&quot;settingId&quot;) long id) throws NotFoundException {
    try {
<span class="fc" id="L186">      userSettingsService.deleteUserSetting(id);</span>
<span class="nc" id="L187">    } catch (UserSettingsServiceException e) {</span>
<span class="nc" id="L188">      logger.error(&quot;Unable to remove user setting id: '{}'&quot;, id, e);</span>
<span class="nc" id="L189">      return Response.serverError().build();</span>
<span class="fc" id="L190">    }</span>
<span class="fc" id="L191">    logger.debug(&quot;User setting with id {} removed.&quot;, id);</span>
<span class="fc" id="L192">    return Response.status(SC_OK).build();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>