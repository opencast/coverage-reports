<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>JobEndpoint.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-admin-ui</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.adminui.endpoint</a> &gt; <span class="el_source">JobEndpoint.java</span></div><h1>JobEndpoint.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.adminui.endpoint;

import static com.entwinemedia.fn.Stream.$;
import static com.entwinemedia.fn.data.json.Jsons.arr;
import static com.entwinemedia.fn.data.json.Jsons.f;
import static com.entwinemedia.fn.data.json.Jsons.obj;
import static com.entwinemedia.fn.data.json.Jsons.v;
import static org.opencastproject.util.DateTimeSupport.toUTC;

import org.opencastproject.adminui.exception.JobEndpointException;
import org.opencastproject.index.service.resources.list.query.JobsListQuery;
import org.opencastproject.index.service.util.RestUtils;
import org.opencastproject.job.api.Incident;
import org.opencastproject.job.api.IncidentTree;
import org.opencastproject.job.api.Job;
import org.opencastproject.security.api.UserDirectoryService;
import org.opencastproject.serviceregistry.api.HostRegistration;
import org.opencastproject.serviceregistry.api.IncidentL10n;
import org.opencastproject.serviceregistry.api.IncidentService;
import org.opencastproject.serviceregistry.api.IncidentServiceException;
import org.opencastproject.serviceregistry.api.ServiceRegistry;
import org.opencastproject.serviceregistry.api.ServiceRegistryException;
import org.opencastproject.util.DateTimeSupport;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.RestUtil;
import org.opencastproject.util.SmartIterator;
import org.opencastproject.util.data.Tuple;
import org.opencastproject.util.doc.rest.RestParameter;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestResponse;
import org.opencastproject.util.doc.rest.RestService;
import org.opencastproject.util.requests.SortCriterion;
import org.opencastproject.util.requests.SortCriterion.Order;
import org.opencastproject.workflow.api.WorkflowService;

import com.entwinemedia.fn.Fn;
import com.entwinemedia.fn.Stream;
import com.entwinemedia.fn.data.json.JObject;
import com.entwinemedia.fn.data.json.JValue;
import com.entwinemedia.fn.data.json.Jsons;
import com.entwinemedia.fn.data.json.SimpleSerializer;

import org.apache.commons.lang3.StringUtils;
import org.osgi.framework.BundleContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.jaxrs.whiteboard.propertytypes.JaxrsResource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.List;
import java.util.Locale;
import java.util.Optional;

import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.WebApplicationException;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;

@Path(&quot;/admin-ng/job&quot;)
@RestService(name = &quot;JobProxyService&quot;, title = &quot;UI Jobs&quot;,
  abstractText = &quot;This service provides the job data for the UI.&quot;,
  notes = { &quot;These Endpoints deliver informations about the job required for the UI.&quot;,
            &quot;&lt;strong&gt;Important:&lt;/strong&gt; &quot;
              + &quot;&lt;em&gt;This service is for exclusive use by the module admin-ui. Its API might change &quot;
              + &quot;anytime without prior notice. Any dependencies other than the admin UI will be strictly ignored. &quot;
              + &quot;DO NOT use this for integration of third-party applications.&lt;em&gt;&quot;})
@Component(
  immediate = true,
  service = JobEndpoint.class,
  property = {
    &quot;service.description=Admin UI - Job facade Endpoint&quot;,
    &quot;opencast.service.type=org.opencastproject.adminui.endpoint.JobEndpoint&quot;,
    &quot;opencast.service.path=/admin-ng/job&quot;
  }
)
@JaxrsResource
<span class="fc" id="L107">public class JobEndpoint {</span>

<span class="fc" id="L109">  private static final Logger logger = LoggerFactory.getLogger(JobEndpoint.class);</span>
<span class="fc" id="L110">  private static final SimpleSerializer serializer = new SimpleSerializer();</span>

<span class="fc" id="L112">  public static final Response NOT_FOUND = Response.status(Response.Status.NOT_FOUND).build();</span>

<span class="fc" id="L114">  private enum JobSort {</span>
<span class="fc" id="L115">    CREATOR, OPERATION, PROCESSINGHOST, PROCESSINGNODE, STATUS, STARTED, SUBMITTED, TYPE, ID</span>
  }

  private static final String NEGATE_PREFIX = &quot;-&quot;;
  private static final String WORKFLOW_STATUS_TRANSLATION_PREFIX = &quot;EVENTS.EVENTS.DETAILS.WORKFLOWS.OPERATION_STATUS.&quot;;
  private static final String JOB_STATUS_TRANSLATION_PREFIX = &quot;SYSTEMS.JOBS.STATUS.&quot;;

  private WorkflowService workflowService;
  private ServiceRegistry serviceRegistry;
  private IncidentService incidentService;
  private UserDirectoryService userDirectoryService;

  /** OSGi callback for the workflow service. */
  @Reference
  public void setWorkflowService(WorkflowService workflowService) {
<span class="fc" id="L130">    this.workflowService = workflowService;</span>
<span class="fc" id="L131">  }</span>

  /** OSGi callback for the service registry. */
  @Reference
  public void setServiceRegistry(ServiceRegistry serviceRegistry) {
<span class="fc" id="L136">    this.serviceRegistry = serviceRegistry;</span>
<span class="fc" id="L137">  }</span>

  /** OSGi callback for the incident service. */
  @Reference
  public void setIncidentService(IncidentService incidentService) {
<span class="fc" id="L142">    this.incidentService = incidentService;</span>
<span class="fc" id="L143">  }</span>

  @Reference
  public void setUserDirectoryService(UserDirectoryService userDirectoryService) {
<span class="fc" id="L147">    this.userDirectoryService = userDirectoryService;</span>
<span class="fc" id="L148">  }</span>

  @Activate
  protected void activate(BundleContext bundleContext) {
<span class="fc" id="L152">    logger.info(&quot;Activate job endpoint&quot;);</span>
<span class="fc" id="L153">  }</span>

  @GET
  @Path(&quot;jobs.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(description = &quot;Returns the list of active jobs&quot;, name = &quot;jobs&quot;, restParameters = {
          @RestParameter(name = &quot;limit&quot;, description = &quot;The maximum number of items to return per page&quot;, isRequired = false, type = RestParameter.Type.INTEGER),
          @RestParameter(name = &quot;offset&quot;, description = &quot;The offset&quot;, isRequired = false, type = RestParameter.Type.INTEGER),
          @RestParameter(name = &quot;filter&quot;, description = &quot;Filter results by hostname, status or free text query&quot;, isRequired = false, type = RestParameter.Type.STRING),
          @RestParameter(name = &quot;sort&quot;, description = &quot;The sort order. May include any of the following: CREATOR, OPERATION, PROCESSINGHOST, STATUS, STARTED, SUBMITTED or TYPE. &quot;
                  + &quot;The suffix must be :ASC for ascending or :DESC for descending sort order (e.g. OPERATION:DESC)&quot;, isRequired = false, type = RestParameter.Type.STRING)},
          responses = { @RestResponse(description = &quot;Returns the list of active jobs from Opencast&quot;, responseCode = HttpServletResponse.SC_OK) },
          returnDescription = &quot;The list of jobs as JSON&quot;)
  public Response getJobs(@QueryParam(&quot;limit&quot;) final int limit, @QueryParam(&quot;offset&quot;) final int offset,
          @QueryParam(&quot;filter&quot;) final String filter, @QueryParam(&quot;sort&quot;) final String sort) {
<span class="fc" id="L168">    JobsListQuery query = new JobsListQuery();</span>
<span class="fc" id="L169">    EndpointUtil.addRequestFiltersToQuery(filter, query);</span>
<span class="fc" id="L170">    query.setLimit(limit);</span>
<span class="fc" id="L171">    query.setOffset(offset);</span>

<span class="fc" id="L173">    String fHostname = null;</span>
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">    if (query.getHostname().isSome())</span>
<span class="nc" id="L175">      fHostname = StringUtils.trimToNull(query.getHostname().get());</span>
<span class="fc" id="L176">    String fNodeName = null;</span>
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">    if (query.getNodeName().isSome())</span>
<span class="nc" id="L178">      fNodeName = StringUtils.trimToNull(query.getNodeName().get());</span>
<span class="fc" id="L179">    String fStatus = null;</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">    if (query.getStatus().isSome())</span>
<span class="nc" id="L181">      fStatus = StringUtils.trimToNull(query.getStatus().get());</span>
<span class="fc" id="L182">    String fFreeText = null;</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">    if (query.getFreeText().isSome())</span>
<span class="nc" id="L184">      fFreeText = StringUtils.trimToNull(query.getFreeText().get());</span>

<span class="fc" id="L186">    List&lt;JobExtended&gt; jobs = new ArrayList&lt;&gt;();</span>
    try {
      String vNodeName;
      Optional&lt;HostRegistration&gt; server;
<span class="fc" id="L190">      List&lt;HostRegistration&gt; servers = serviceRegistry.getHostRegistrations();</span>
<span class="fc bfc" id="L191" title="All 2 branches covered.">      for (Job job : serviceRegistry.getActiveJobs()) {</span>
        // filter workflow jobs
<span class="fc bfc" id="L193" title="All 2 branches covered.">        if (StringUtils.equals(WorkflowService.JOB_TYPE, job.getJobType())</span>
<span class="fc bfc" id="L194" title="All 2 branches covered.">                &amp;&amp; StringUtils.equals(&quot;START_WORKFLOW&quot;, job.getOperation()))</span>
<span class="fc" id="L195">          continue;</span>

        // filter by hostname
<span class="pc bpc" id="L198" title="3 of 4 branches missed.">        if (fHostname != null &amp;&amp; !StringUtils.equalsIgnoreCase(job.getProcessingHost(), fHostname))</span>
<span class="nc" id="L199">          continue;</span>

<span class="fc" id="L201">        server = findServerByHost(job.getProcessingHost(), servers);</span>
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">        vNodeName = server.isPresent() ? server.get().getNodeName() : &quot;&quot;;</span>

        // filter by node name
<span class="pc bpc" id="L205" title="5 of 6 branches missed.">        if (fNodeName != null &amp;&amp; (server.isPresent()) &amp;&amp; !StringUtils.equalsIgnoreCase(vNodeName, fNodeName))</span>
<span class="nc" id="L206">          continue;</span>

        // filter by status
<span class="pc bpc" id="L209" title="3 of 4 branches missed.">        if (fStatus != null &amp;&amp; !StringUtils.equalsIgnoreCase(job.getStatus().toString(), fStatus))</span>
<span class="nc" id="L210">          continue;</span>

        // fitler by user free text
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">        if (fFreeText != null</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">              &amp;&amp; !StringUtils.equalsIgnoreCase(job.getProcessingHost(), fFreeText)</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">              &amp;&amp; !StringUtils.equalsIgnoreCase(vNodeName, fFreeText)</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">              &amp;&amp; !StringUtils.equalsIgnoreCase(job.getJobType(), fFreeText)</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">              &amp;&amp; !StringUtils.equalsIgnoreCase(job.getOperation(), fFreeText)</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">              &amp;&amp; !StringUtils.equalsIgnoreCase(job.getCreator(), fFreeText)</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">              &amp;&amp; !StringUtils.equalsIgnoreCase(job.getStatus().toString(), fFreeText)</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">              &amp;&amp; !StringUtils.equalsIgnoreCase(Long.toString(job.getId()), fFreeText)</span>
<span class="nc bnc" id="L221" title="All 4 branches missed.">              &amp;&amp; (job.getRootJobId() != null &amp;&amp; !StringUtils.equalsIgnoreCase(Long.toString(job.getRootJobId()), fFreeText)))</span>
<span class="nc" id="L222">          continue;</span>
<span class="fc" id="L223">        jobs.add(new JobExtended(job, vNodeName));</span>
<span class="fc" id="L224">      }</span>
<span class="nc" id="L225">    } catch (ServiceRegistryException ex) {</span>
<span class="nc" id="L226">      logger.error(&quot;Failed to retrieve jobs list from service registry.&quot;, ex);</span>
<span class="nc" id="L227">      return RestUtil.R.serverError();</span>
<span class="fc" id="L228">    }</span>

<span class="fc" id="L230">    JobSort sortKey = JobSort.SUBMITTED;</span>
<span class="fc" id="L231">    boolean ascending = true;</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">    if (StringUtils.isNotBlank(sort)) {</span>
      try {
<span class="fc" id="L234">        SortCriterion sortCriterion = RestUtils.parseSortQueryParameter(sort).iterator().next();</span>
<span class="fc" id="L235">        sortKey = JobSort.valueOf(sortCriterion.getFieldName().toUpperCase());</span>
<span class="fc bfc" id="L236" title="All 2 branches covered.">        ascending = Order.Ascending == sortCriterion.getOrder()</span>
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">                || Order.None == sortCriterion.getOrder();</span>
<span class="nc" id="L238">      } catch (WebApplicationException ex) {</span>
<span class="nc" id="L239">        logger.warn(&quot;Failed to parse sort criterion \&quot;{}\&quot;, invalid format.&quot;, sort);</span>
<span class="nc" id="L240">      } catch (IllegalArgumentException ex) {</span>
<span class="nc" id="L241">        logger.warn(&quot;Can not apply sort criterion \&quot;{}\&quot;, no field with this name.&quot;, sort);</span>
<span class="pc" id="L242">      }</span>
    }

<span class="fc" id="L245">    JobComparator comparator = new JobComparator(sortKey, ascending);</span>
<span class="fc" id="L246">    Collections.sort(jobs, comparator);</span>
<span class="fc" id="L247">    List&lt;JValue&gt; json = getJobsAsJSON(new SmartIterator(</span>
<span class="fc" id="L248">            query.getLimit().getOrElse(0),</span>
<span class="fc" id="L249">            query.getOffset().getOrElse(0))</span>
<span class="fc" id="L250">            .applyLimitAndOffset(jobs));</span>

<span class="fc" id="L252">    return RestUtils.okJsonList(json, offset, limit, jobs.size());</span>
  }

  /* Class to handle additional information related to a job */
  class JobExtended {

    private final Job job;
    private final String nodeName;

<span class="fc" id="L261">    JobExtended(Job job, String nodeName) {</span>
<span class="fc" id="L262">      this.job = job;</span>
<span class="fc" id="L263">      this.nodeName = nodeName;</span>
<span class="fc" id="L264">    }</span>

    public Job getJob() {
<span class="fc" id="L267">      return job;</span>
    }

    public String getNodeName() {
<span class="fc" id="L271">      return nodeName;</span>
    }
  }

  public List&lt;JValue&gt; getJobsAsJSON(List&lt;JobExtended&gt; jobs) {
<span class="fc" id="L276">    List&lt;JValue&gt; jsonList = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L277" title="All 2 branches covered.">    for (JobExtended jobEx : jobs) {</span>
<span class="fc" id="L278">      Job job = jobEx.getJob();</span>
<span class="fc" id="L279">      long id = job.getId();</span>
<span class="fc" id="L280">      String jobType = job.getJobType();</span>
<span class="fc" id="L281">      String operation = job.getOperation();</span>
<span class="fc" id="L282">      Job.Status status = job.getStatus();</span>
<span class="fc" id="L283">      Date dateCreated = job.getDateCreated();</span>
<span class="fc" id="L284">      String created = null;</span>
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">      if (dateCreated != null)</span>
<span class="fc" id="L286">        created = DateTimeSupport.toUTC(dateCreated.getTime());</span>
<span class="fc" id="L287">      Date dateStarted = job.getDateStarted();</span>
<span class="fc" id="L288">      String started = null;</span>
<span class="pc bpc" id="L289" title="1 of 2 branches missed.">      if (dateStarted != null)</span>
<span class="fc" id="L290">        started = DateTimeSupport.toUTC(dateStarted.getTime());</span>
<span class="fc" id="L291">      String creator = job.getCreator();</span>
<span class="fc" id="L292">      String processingHost = job.getProcessingHost();</span>
<span class="fc" id="L293">      String processingNode = jobEx.getNodeName();</span>

<span class="fc" id="L295">      jsonList.add(obj(f(&quot;id&quot;, v(id)),</span>
<span class="fc" id="L296">              f(&quot;type&quot;, v(jobType)),</span>
<span class="fc" id="L297">              f(&quot;operation&quot;, v(operation)),</span>
<span class="fc" id="L298">              f(&quot;status&quot;, v(JOB_STATUS_TRANSLATION_PREFIX + status.toString())),</span>
<span class="fc" id="L299">              f(&quot;submitted&quot;, v(created, Jsons.BLANK)),</span>
<span class="fc" id="L300">              f(&quot;started&quot;, v(started, Jsons.BLANK)),</span>
<span class="fc" id="L301">              f(&quot;creator&quot;, v(creator, Jsons.BLANK)),</span>
<span class="fc" id="L302">              f(&quot;processingHost&quot;, v(processingHost, Jsons.BLANK)),</span>
<span class="fc" id="L303">              f(&quot;processingNode&quot;, v(processingNode, Jsons.BLANK))));</span>
<span class="fc" id="L304">    }</span>

<span class="fc" id="L306">    return jsonList;</span>
  }

  /**
   * Returns the list of incidents for a given workflow instance
   *
   * @param jobId
   *          the workflow instance id
   * @param locale
   *          the language in which title and description shall be returned
   * @param cascade
   *          if true, return the incidents of the given job and those of of its descendants
   * @return the list incidents as JSON array
   * @throws JobEndpointException
   * @throws NotFoundException
   */
  public JValue getIncidentsAsJSON(long jobId, final Locale locale, boolean cascade)
          throws JobEndpointException, NotFoundException {
    final List&lt;Incident&gt; incidents;
    try {
<span class="fc" id="L326">      final IncidentTree it = incidentService.getIncidentsOfJob(jobId, cascade);</span>
<span class="pc bpc" id="L327" title="1 of 2 branches missed.">      incidents = cascade ? flatten(it) : it.getIncidents();</span>
<span class="nc" id="L328">    } catch (IncidentServiceException e) {</span>
<span class="nc" id="L329">      throw new JobEndpointException(String.format(</span>
<span class="nc" id="L330">              &quot;Not able to get the incidents for the job %d from the incident service : %s&quot;, jobId, e), e.getCause());</span>
<span class="fc" id="L331">    }</span>
<span class="fc" id="L332">    final Stream&lt;JValue&gt; json = $(incidents).map(new Fn&lt;Incident, JValue&gt;() {</span>
      @Override
      public JValue apply(Incident i) {
<span class="fc" id="L335">        return obj(f(&quot;id&quot;, v(i.getId())), f(&quot;severity&quot;, v(i.getSeverity(), Jsons.BLANK)),</span>
<span class="fc" id="L336">                f(&quot;timestamp&quot;, v(toUTC(i.getTimestamp().getTime()), Jsons.BLANK))).merge(</span>
<span class="fc" id="L337">                localizeIncident(i, locale));</span>
      }
    });
<span class="fc" id="L340">    return arr(json);</span>
  }

  /**
   * Flatten a tree of incidents.
   *
   * @return a list of incidents
   */
  private List&lt;Incident&gt; flatten(IncidentTree incidentsTree) {
<span class="fc" id="L349">    final List&lt;Incident&gt; incidents = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L350">    incidents.addAll(incidentsTree.getIncidents());</span>
<span class="fc bfc" id="L351" title="All 2 branches covered.">    for (IncidentTree descendantTree : incidentsTree.getDescendants()) {</span>
<span class="fc" id="L352">      incidents.addAll(flatten(descendantTree));</span>
<span class="fc" id="L353">    }</span>
<span class="fc" id="L354">    return incidents;</span>
  }

  /**
   * Return localized title and description of an incident as JSON.
   *
   * @param incident
   *          the incident to localize
   * @param locale
   *          the locale to be used to create title and description
   * @return JSON object
   */
  private JObject localizeIncident(Incident incident, Locale locale) {
    try {
<span class="fc" id="L368">      final IncidentL10n loc = incidentService.getLocalization(incident.getId(), locale);</span>
<span class="nc" id="L369">      return obj(f(&quot;title&quot;, v(loc.getTitle(), Jsons.BLANK)), f(&quot;description&quot;, v(loc.getDescription(), Jsons.BLANK)));</span>
<span class="fc" id="L370">    } catch (Exception e) {</span>
<span class="fc" id="L371">      return obj(f(&quot;title&quot;, v(&quot;&quot;)), f(&quot;description&quot;, v(&quot;&quot;)));</span>
    }
  }

  /**
   * Return an incident serialized as JSON.
   *
   * @param id
   *          incident id
   * @param locale
   *          the locale to be used to create title and description
   * @return JSON object
   */
  public JValue getIncidentAsJSON(long id, Locale locale) throws JobEndpointException, NotFoundException {
    final Incident incident;
    try {
<span class="nc" id="L387">      incident = incidentService.getIncident(id);</span>
<span class="nc" id="L388">    } catch (IncidentServiceException e) {</span>
<span class="nc" id="L389">      throw new JobEndpointException(String.format(&quot;Not able to get the incident %d: %s&quot;, id, e), e.getCause());</span>
<span class="nc" id="L390">    }</span>
<span class="nc" id="L391">    Long rootJobId = null;</span>
    try {
<span class="nc" id="L393">      Job job = serviceRegistry.getJob(incident.getJobId());</span>
<span class="nc" id="L394">      rootJobId = job.getRootJobId();</span>
<span class="nc" id="L395">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L396">      logger.info(&quot;Could not find job \&quot;{}\&quot; in service registry&quot;, incident.getJobId());</span>
<span class="nc" id="L397">    }</span>
<span class="nc" id="L398">    return obj(f(&quot;id&quot;, v(incident.getId(), Jsons.BLANK)), f(&quot;job_id&quot;, v(incident.getJobId(), Jsons.BLANK)),</span>
<span class="nc" id="L399">            f(&quot;root_job_id&quot;, v(rootJobId, Jsons.BLANK)),</span>
<span class="nc" id="L400">            f(&quot;severity&quot;, v(incident.getSeverity(), Jsons.BLANK)),</span>
<span class="nc" id="L401">            f(&quot;timestamp&quot;, v(toUTC(incident.getTimestamp().getTime()), Jsons.BLANK)),</span>
<span class="nc" id="L402">            f(&quot;processing_host&quot;, v(incident.getProcessingHost(), Jsons.BLANK)), f(&quot;service_type&quot;, v(incident.getServiceType(), Jsons.BLANK)),</span>
<span class="nc" id="L403">            f(&quot;technical_details&quot;, v(incident.getDescriptionParameters(), Jsons.BLANK)),</span>
<span class="nc" id="L404">            f(&quot;details&quot;, arr($(incident.getDetails()).map(errorDetailToJson))))</span>
<span class="nc" id="L405">      .merge(localizeIncident(incident, locale));</span>
  }

<span class="fc" id="L408">  private final Fn&lt;Tuple&lt;String, String&gt;, JObject&gt; errorDetailToJson = new Fn&lt;Tuple&lt;String, String&gt;, JObject&gt;() {</span>
    @Override
    public JObject apply(Tuple&lt;String, String&gt; detail) {
<span class="nc" id="L411">      return obj(f(&quot;name&quot;, v(detail.getA(), Jsons.BLANK)), f(&quot;value&quot;, v(detail.getB(), Jsons.BLANK)));</span>
    }
  };

  private class JobComparator implements Comparator&lt;JobExtended&gt; {

    private JobSort sortType;
    private boolean ascending;

<span class="fc" id="L420">    JobComparator(JobSort sortType, boolean ascending) {</span>
<span class="fc" id="L421">      this.sortType = sortType;</span>
<span class="fc" id="L422">      this.ascending = ascending;</span>
<span class="fc" id="L423">    }</span>

    @Override
    public int compare(JobExtended jobEx1, JobExtended jobEx2) {
<span class="fc" id="L427">      int result = 0;</span>
<span class="fc" id="L428">      Object value1 = null;</span>
<span class="fc" id="L429">      Object value2 = null;</span>
<span class="fc" id="L430">      Job job1 = jobEx1.getJob();</span>
<span class="fc" id="L431">      Job job2 = jobEx2.getJob();</span>
<span class="pc bpc" id="L432" title="4 of 10 branches missed.">      switch (sortType) {</span>
        case CREATOR:
<span class="fc" id="L434">          value1 = job1.getCreator();</span>
<span class="fc" id="L435">          value2 = job2.getCreator();</span>
<span class="fc" id="L436">          break;</span>
        case OPERATION:
<span class="fc" id="L438">          value1 = job1.getOperation();</span>
<span class="fc" id="L439">          value2 = job2.getOperation();</span>
<span class="fc" id="L440">          break;</span>
        case PROCESSINGHOST:
<span class="fc" id="L442">          value1 = job1.getProcessingHost();</span>
<span class="fc" id="L443">          value2 = job2.getProcessingHost();</span>
<span class="fc" id="L444">          break;</span>
        case PROCESSINGNODE:
<span class="nc" id="L446">          value1 = jobEx1.getNodeName();</span>
<span class="nc" id="L447">          value2 = jobEx2.getNodeName();</span>
<span class="nc" id="L448">          break;        case STARTED:</span>
<span class="fc" id="L449">          value1 = job1.getDateStarted();</span>
<span class="fc" id="L450">          value2 = job2.getDateStarted();</span>
<span class="fc" id="L451">          break;</span>
        case STATUS:
<span class="nc" id="L453">          value1 = job1.getStatus();</span>
<span class="nc" id="L454">          value2 = job2.getStatus();</span>
<span class="nc" id="L455">          break;</span>
        case SUBMITTED:
<span class="fc" id="L457">          value1 = job1.getDateCreated();</span>
<span class="fc" id="L458">          value2 = job2.getDateCreated();</span>
<span class="fc" id="L459">          break;</span>
        case TYPE:
<span class="fc" id="L461">          value1 = job1.getJobType();</span>
<span class="fc" id="L462">          value2 = job2.getJobType();</span>
<span class="fc" id="L463">          break;</span>
        case ID:
<span class="nc" id="L465">          value1 = job1.getId();</span>
<span class="nc" id="L466">          value2 = job2.getId();</span>
<span class="nc" id="L467">          break;</span>
        default:
      }

<span class="pc bpc" id="L471" title="1 of 2 branches missed.">      if (value1 == null) {</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">        return value2 == null ? 0 : 1;</span>
      }
<span class="pc bpc" id="L474" title="1 of 2 branches missed.">      if (value2 == null) {</span>
<span class="nc" id="L475">        return -1;</span>
      }
      try {
<span class="fc" id="L478">        result = ((Comparable)value1).compareTo(value2);</span>
<span class="nc" id="L479">      } catch (ClassCastException ex) {</span>
<span class="nc" id="L480">        logger.debug(&quot;Can not compare \&quot;{}\&quot; with \&quot;{}\&quot;&quot;,</span>
                value1, value2, ex);
<span class="fc" id="L482">      }</span>

<span class="fc bfc" id="L484" title="All 2 branches covered.">      return ascending ? result : -1 * result;</span>
    }
  }

  /**
   * @param hostname of server to find in list
   * @param servers list of all host registrations
   */
  private Optional&lt;HostRegistration&gt; findServerByHost(String hostname, List&lt;HostRegistration&gt; servers) {
<span class="fc" id="L493">    return servers.stream().filter(o -&gt; o.getBaseUrl().equals(hostname)).findFirst();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>