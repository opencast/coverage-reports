<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>Mpeg7CatalogImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-mpeg7</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.metadata.mpeg7</a> &gt; <span class="el_source">Mpeg7CatalogImpl.java</span></div><h1>Mpeg7CatalogImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */


package org.opencastproject.metadata.mpeg7;

import org.opencastproject.util.XmlSafeParser;

import org.w3c.dom.Document;
import org.w3c.dom.Element;

import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;

import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.TransformerException;

/**
 * Implements the mpeg-7 metadata container.
 */
public class Mpeg7CatalogImpl implements Mpeg7Catalog {

  /** Serial version UID */
  private static final long serialVersionUID = 5521535164920498997L;

  /** The multimedia content list */
<span class="fc" id="L49">  private HashMap&lt;MultimediaContent.Type, MultimediaContentImpl&lt;? extends MultimediaContentType&gt;&gt; multimediaContent = null;</span>

  /** The default element namespace */
  public static final String NS = &quot;mpeg7&quot;;

  /**
   * Creates a new mpeg-7 metadata container.
   */
<span class="fc" id="L57">  public Mpeg7CatalogImpl() {</span>
<span class="fc" id="L58">    multimediaContent = new HashMap&lt;MultimediaContent.Type, MultimediaContentImpl&lt;? extends MultimediaContentType&gt;&gt;();</span>
<span class="fc" id="L59">  }</span>

  /**
   * Creates a new mpeg-7 metadata container from the serialized stream.
   */
  public Mpeg7CatalogImpl(InputStream in) {
<span class="fc" id="L65">    this();</span>
<span class="fc" id="L66">    loadCatalogData(in);</span>
<span class="fc" id="L67">  }</span>

  /**
   * Populates the catalog.
   *
   * @param in
   *          The input stream containing the content
   * @throws IllegalStateException
   *           if reading the catalog fails
   */
  private void loadCatalogData(InputStream in) throws IllegalStateException {
<span class="fc" id="L78">    Mpeg7Parser parser = new Mpeg7Parser(this);</span>
    try {
<span class="fc" id="L80">      parser.parse(in);</span>
<span class="nc" id="L81">    } catch (Exception e) {</span>
<span class="nc" id="L82">      throw new IllegalStateException(&quot;Unable to load mpeg-7 catalog data:&quot; + e.getMessage(), e);</span>
<span class="fc" id="L83">    }</span>
<span class="fc" id="L84">  }</span>

  /**
   * Creates a new mpeg-7 metadata container file.
   *
   * @return the new mpeg-7 metadata container
   */
  public static Mpeg7CatalogImpl newInstance() {
<span class="fc" id="L92">    Mpeg7CatalogImpl mpeg7 = new Mpeg7CatalogImpl();</span>
<span class="fc" id="L93">    return mpeg7;</span>
  }

  /**
   * @see org.opencastproject.metadata.mpeg7.Mpeg7#multimediaContent()
   */
  public Iterator&lt;MultimediaContent&lt;? extends MultimediaContentType&gt;&gt; multimediaContent() {
<span class="fc" id="L100">    List&lt;MultimediaContent&lt;? extends MultimediaContentType&gt;&gt; result = new ArrayList&lt;MultimediaContent&lt;? extends MultimediaContentType&gt;&gt;();</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">    for (MultimediaContent&lt;? extends MultimediaContentType&gt; o : multimediaContent.values()) {</span>
<span class="fc" id="L102">      result.add(o);</span>
<span class="fc" id="L103">    }</span>
<span class="fc" id="L104">    return result.iterator();</span>
  }

  /**
   * @see org.opencastproject.metadata.mpeg7.Mpeg7#getMultimediaContent(org.opencastproject.mediapackage.mpeg7.MultimediaContent.Type)
   */
  public MultimediaContent&lt;? extends MultimediaContentType&gt; getMultimediaContent(MultimediaContent.Type type) {
<span class="fc" id="L111">    return multimediaContent.get(type);</span>
  }

  /**
   * Saves the mpeg-7 metadata container to disk.
   *
   * @throws ParserConfigurationException
   *           if the xml parser environment is not correctly configured
   * @throws TransformerException
   *           if serialization of the metadata document fails
   * @throws IOException
   *           if an error with catalog file handling occurs
   */
  public Document toXml() throws ParserConfigurationException, TransformerException, IOException {
<span class="fc" id="L125">    Document doc = createDocument();</span>

    // Root element
<span class="fc" id="L128">    Element root = doc.getDocumentElement();</span>

    // Description
<span class="fc" id="L131">    Element descriptionNode = doc.createElement(&quot;Description&quot;);</span>
<span class="fc" id="L132">    descriptionNode.setAttribute(&quot;xsi:type&quot;, &quot;ContentEntityType&quot;);</span>
<span class="fc" id="L133">    root.appendChild(descriptionNode);</span>

    // MultimediaContent
<span class="fc bfc" id="L136" title="All 2 branches covered.">    for (MultimediaContent&lt;? extends MultimediaContentType&gt; mc : multimediaContent.values()) {</span>
<span class="fc" id="L137">      descriptionNode.appendChild(mc.toXml(doc));</span>
<span class="fc" id="L138">    }</span>

<span class="fc" id="L140">    return doc;</span>
  }

  /**
   * Create a DOM representation of the Mpeg-7.
   */
  private Document createDocument() throws ParserConfigurationException {
<span class="fc" id="L147">    Document doc = XmlSafeParser.newDocumentBuilderFactory().newDocumentBuilder().newDocument();</span>
<span class="fc" id="L148">    Element rootElement = doc.createElementNS(&quot;urn:mpeg:mpeg7:schema:2001&quot;, &quot;Mpeg7&quot;);</span>
<span class="fc" id="L149">    rootElement.setAttributeNS(&quot;http://www.w3.org/2000/xmlns/&quot;, &quot;xmlns:mpeg7&quot;, &quot;urn:mpeg7:schema:2001&quot;);</span>
<span class="fc" id="L150">    rootElement.setAttributeNS(&quot;http://www.w3.org/2000/xmlns/&quot;, &quot;xmlns:xsi&quot;,</span>
            &quot;http://www.w3.org/2001/XMLSchema-instance&quot;);
<span class="fc" id="L152">    doc.appendChild(rootElement);</span>
<span class="fc" id="L153">    return doc;</span>
  }

  /**
   * @see org.opencastproject.metadata.mpeg7.Mpeg7#addAudioContent(java.lang.String,
   *      org.opencastproject.metadata.mpeg7.MediaTime, org.opencastproject.metadata.mpeg7.MediaLocator)
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  public Audio addAudioContent(String id, MediaTime time, MediaLocator locator) {
<span class="fc" id="L162">    MultimediaContentImpl&lt;Audio&gt; content = (MultimediaContentImpl&lt;Audio&gt;) getMultimediaContent(MultimediaContent.Type.AudioType);</span>
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">    if (content == null) {</span>
<span class="fc" id="L164">      content = new MultimediaContentImpl&lt;Audio&gt;(MultimediaContent.Type.AudioType);</span>
<span class="fc" id="L165">      multimediaContent.put(MultimediaContent.Type.AudioType, content);</span>
    }
<span class="fc" id="L167">    MultimediaContentTypeImpl&lt;AudioSegment&gt; audio = new MultimediaContentTypeImpl&lt;AudioSegment&gt;(MultimediaContentType.Type.Audio, id);</span>
<span class="fc" id="L168">    audio.setMediaTime(time);</span>
<span class="fc" id="L169">    audio.setMediaLocator(locator);</span>
<span class="fc" id="L170">    content.add(audio);</span>
<span class="fc" id="L171">    return audio;</span>
  }

  /**
   * @see org.opencastproject.metadata.mpeg7.Mpeg7#removeAudioContent(java.lang.String)
   */
  public Audio removeAudioContent(String id) {
<span class="nc" id="L178">    MultimediaContentType element = removeContentElement(id, MultimediaContent.Type.AudioType);</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">    if (element != null)</span>
<span class="nc" id="L180">      return (Audio) element;</span>
<span class="nc" id="L181">    return null;</span>
  }

  /**
   * @see org.opencastproject.metadata.mpeg7.Mpeg7#hasAudioContent()
   */
  public boolean hasAudioContent() {
<span class="fc" id="L188">    MultimediaContent&lt;?&gt; content = getMultimediaContent(MultimediaContent.Type.AudioType);</span>
<span class="pc bpc" id="L189" title="2 of 4 branches missed.">    return content != null &amp;&amp; content.size() &gt; 0;</span>
  }

  /**
   * @see org.opencastproject.metadata.mpeg7.Mpeg7#audioContent()
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  public Iterator&lt;Audio&gt; audioContent() {
<span class="fc" id="L197">    MultimediaContent&lt;Audio&gt; content = (MultimediaContent&lt;Audio&gt;) getMultimediaContent(MultimediaContent.Type.AudioType);</span>
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">    if (content != null)</span>
<span class="fc" id="L199">      return content.elements();</span>
<span class="nc" id="L200">    return null;</span>
  }

  /**
   * @see org.opencastproject.metadata.mpeg7.Mpeg7#addVideoContent(java.lang.String,
   *      org.opencastproject.mediapackage.mpeg7.MediaTime, org.opencastproject.mediapackage.mpeg7.MediaLocator)
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  public Video addVideoContent(String id, MediaTime time, MediaLocator locator) {
<span class="fc" id="L209">    MultimediaContentImpl&lt;Video&gt; content = (MultimediaContentImpl&lt;Video&gt;) getMultimediaContent(MultimediaContent.Type.VideoType);</span>
<span class="fc bfc" id="L210" title="All 2 branches covered.">    if (content == null) {</span>
<span class="fc" id="L211">      content = new MultimediaContentImpl&lt;Video&gt;(MultimediaContent.Type.VideoType);</span>
<span class="fc" id="L212">      multimediaContent.put(MultimediaContent.Type.VideoType, content);</span>
    }
<span class="fc" id="L214">    MultimediaContentTypeImpl&lt;VideoSegment&gt; video = new MultimediaContentTypeImpl&lt;VideoSegment&gt;(MultimediaContentType.Type.Video, id);</span>
<span class="fc" id="L215">    content.add(video);</span>
<span class="fc" id="L216">    video.setMediaTime(time);</span>
<span class="fc" id="L217">    video.setMediaLocator(locator);</span>
<span class="fc" id="L218">    return video;</span>
  }

  /**
   * @see org.opencastproject.metadata.mpeg7.Mpeg7#removeVideoContent(java.lang.String)
   */
  public Video removeVideoContent(String id) {
<span class="nc" id="L225">    MultimediaContentType element = removeContentElement(id, MultimediaContent.Type.VideoType);</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">    if (element != null)</span>
<span class="nc" id="L227">      return (Video) element;</span>
<span class="nc" id="L228">    return null;</span>
  }

  /**
   * @see org.opencastproject.metadata.mpeg7.Mpeg7#hasVideoContent()
   */
  public boolean hasVideoContent() {
<span class="fc" id="L235">    MultimediaContent&lt;?&gt; content = getMultimediaContent(MultimediaContent.Type.VideoType);</span>
<span class="pc bpc" id="L236" title="2 of 4 branches missed.">    return content != null &amp;&amp; content.size() &gt; 0;</span>
  }

  /**
   * @see org.opencastproject.metadata.mpeg7.Mpeg7#videoContent()
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  public Iterator&lt;Video&gt; videoContent() {
<span class="nc" id="L244">    MultimediaContent&lt;Video&gt; content = (MultimediaContent&lt;Video&gt;) getMultimediaContent(MultimediaContent.Type.VideoType);</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">    if (content != null)</span>
<span class="nc" id="L246">      return content.elements();</span>
<span class="nc" id="L247">    return null;</span>
  }

  /**
   * @see org.opencastproject.metadata.mpeg7.Mpeg7#addAudioVisualContent(java.lang.String,
   *      org.opencastproject.mediapackage.mpeg7.MediaTime, org.opencastproject.mediapackage.mpeg7.MediaLocator)
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  public AudioVisual addAudioVisualContent(String id, MediaTime time, MediaLocator locator) {
<span class="nc" id="L256">    MultimediaContentImpl&lt;AudioVisual&gt; content = (MultimediaContentImpl&lt;AudioVisual&gt;) getMultimediaContent(MultimediaContent.Type.AudioVisualType);</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">    if (content == null) {</span>
<span class="nc" id="L258">      content = new MultimediaContentImpl&lt;AudioVisual&gt;(MultimediaContent.Type.AudioVisualType);</span>
<span class="nc" id="L259">      multimediaContent.put(MultimediaContent.Type.AudioVisualType, content);</span>
    }
<span class="nc" id="L261">    MultimediaContentTypeImpl&lt;AudioVisualSegment&gt; audioVisual = new MultimediaContentTypeImpl&lt;AudioVisualSegment&gt;(MultimediaContentType.Type.AudioVisual, id);</span>
<span class="nc" id="L262">    audioVisual.setMediaTime(time);</span>
<span class="nc" id="L263">    audioVisual.setMediaLocator(locator);</span>
<span class="nc" id="L264">    content.add(audioVisual);</span>
<span class="nc" id="L265">    return audioVisual;</span>
  }

  /**
   * @see org.opencastproject.metadata.mpeg7.Mpeg7#removeAudioVisualContent(java.lang.String)
   */
  public AudioVisual removeAudioVisualContent(String id) {
<span class="nc" id="L272">    MultimediaContentType element = removeContentElement(id, MultimediaContent.Type.AudioVisualType);</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">    if (element != null)</span>
<span class="nc" id="L274">      return (AudioVisual) element;</span>
<span class="nc" id="L275">    return null;</span>
  }

  /**
   * @see org.opencastproject.metadata.mpeg7.Mpeg7#hasAudioVisualContent()
   */
  public boolean hasAudioVisualContent() {
<span class="fc" id="L282">    MultimediaContent&lt;?&gt; content = getMultimediaContent(MultimediaContent.Type.AudioVisualType);</span>
<span class="pc bpc" id="L283" title="3 of 4 branches missed.">    return content != null &amp;&amp; content.size() &gt; 0;</span>
  }

  /**
   * @see org.opencastproject.metadata.mpeg7.Mpeg7#audiovisualContent()
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  public Iterator&lt;AudioVisual&gt; audiovisualContent() {
<span class="nc" id="L291">    MultimediaContent&lt;AudioVisual&gt; content = (MultimediaContent&lt;AudioVisual&gt;) getMultimediaContent(MultimediaContent.Type.AudioVisualType);</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">    if (content != null)</span>
<span class="nc" id="L293">      return content.elements();</span>
<span class="nc" id="L294">    return null;</span>
  }

  /**
   * @see org.opencastproject.metadata.mpeg7.Mpeg7#getAudioById(java.lang.String)
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  public Audio getAudioById(String id) {
<span class="fc" id="L302">    MultimediaContent&lt;Audio&gt; content = (MultimediaContent&lt;Audio&gt;) getMultimediaContent(MultimediaContent.Type.AudioType);</span>
<span class="pc bpc" id="L303" title="1 of 2 branches missed.">    if (content == null)</span>
<span class="nc" id="L304">      return null;</span>
<span class="fc" id="L305">    return content.getElementById(id);</span>
  }

  /**
   * @see org.opencastproject.metadata.mpeg7.Mpeg7#getAudioVisualById(java.lang.String)
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  public AudioVisual getAudioVisualById(String id) {
<span class="nc" id="L313">    MultimediaContent&lt;AudioVisual&gt; content = (MultimediaContent&lt;AudioVisual&gt;) getMultimediaContent(MultimediaContent.Type.AudioVisualType);</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">    if (content == null)</span>
<span class="nc" id="L315">      return null;</span>
<span class="nc" id="L316">    return content.getElementById(id);</span>
  }

  /**
   * @see org.opencastproject.metadata.mpeg7.Mpeg7#getVideoById(java.lang.String)
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  public Video getVideoById(String id) {
<span class="fc" id="L324">    MultimediaContent&lt;Video&gt; content = (MultimediaContent&lt;Video&gt;) getMultimediaContent(MultimediaContent.Type.VideoType);</span>
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">    if (content == null)</span>
<span class="nc" id="L326">      return null;</span>
<span class="fc" id="L327">    return content.getElementById(id);</span>
  }

  /**
   * Removes the content element of the specified type with the given identifier.
   *
   * @param id
   *          the content element identifier
   * @param type
   *          the content type
   * @return the element or &lt;code&gt;null&lt;/code&gt;
   */
  private MultimediaContentType removeContentElement(String id, MultimediaContent.Type type) {
<span class="nc" id="L340">    MultimediaContentImpl&lt;? extends MultimediaContentType&gt; content = multimediaContent.get(type);</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">    if (content != null)</span>
<span class="nc" id="L342">      return content.remove(id);</span>
<span class="nc" id="L343">    return null;</span>
  }

  @SuppressWarnings(&quot;unchecked&quot;)
  @Override
  public Mpeg7Catalog clone() {
<span class="nc" id="L349">    Mpeg7CatalogImpl clone = new Mpeg7CatalogImpl();</span>
<span class="nc" id="L350">    clone.multimediaContent = (HashMap&lt;MultimediaContent.Type, MultimediaContentImpl&lt;? extends MultimediaContentType&gt;&gt;) this.multimediaContent</span>
<span class="nc" id="L351">            .clone();</span>
<span class="nc" id="L352">    return clone;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>