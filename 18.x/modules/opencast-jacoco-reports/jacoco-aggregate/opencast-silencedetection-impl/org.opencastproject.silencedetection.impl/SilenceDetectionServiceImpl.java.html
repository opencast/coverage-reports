<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SilenceDetectionServiceImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-silencedetection-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.silencedetection.impl</a> &gt; <span class="el_source">SilenceDetectionServiceImpl.java</span></div><h1>SilenceDetectionServiceImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.silencedetection.impl;

import org.opencastproject.job.api.AbstractJobProducer;
import org.opencastproject.job.api.Job;
import org.opencastproject.mediapackage.MediaPackageElementParser;
import org.opencastproject.mediapackage.MediaPackageException;
import org.opencastproject.mediapackage.Track;
import org.opencastproject.security.api.OrganizationDirectoryService;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.UserDirectoryService;
import org.opencastproject.serviceregistry.api.ServiceRegistry;
import org.opencastproject.serviceregistry.api.ServiceRegistryException;
import org.opencastproject.silencedetection.api.MediaSegment;
import org.opencastproject.silencedetection.api.MediaSegments;
import org.opencastproject.silencedetection.api.SilenceDetectionFailedException;
import org.opencastproject.silencedetection.api.SilenceDetectionService;
import org.opencastproject.silencedetection.ffmpeg.FFmpegSilenceDetector;
import org.opencastproject.smil.api.SmilException;
import org.opencastproject.smil.api.SmilResponse;
import org.opencastproject.smil.api.SmilService;
import org.opencastproject.smil.entity.api.Smil;
import org.opencastproject.util.LoadUtil;
import org.opencastproject.workspace.api.Workspace;

import org.apache.commons.lang3.StringUtils;
import org.osgi.framework.BundleContext;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Deactivate;
import org.osgi.service.component.annotations.Modified;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Arrays;
import java.util.Dictionary;
import java.util.Enumeration;
import java.util.LinkedList;
import java.util.List;
import java.util.Properties;

/**
 * Implementation of SilenceDetectionService using FFmpeg.
 */
@Component(
    property = {
        &quot;service.description=Silence Detection Service&quot;
    },
    immediate = true,
    service = SilenceDetectionService.class
)
public class SilenceDetectionServiceImpl extends AbstractJobProducer implements SilenceDetectionService {

  /**
   * The logging instance
   */
<span class="nc" id="L79">  private static final Logger logger = LoggerFactory.getLogger(SilenceDetectionServiceImpl.class);</span>

  public static final String JOB_LOAD_KEY = &quot;job.load.videoeditor.silencedetection&quot;;

  private static final float DEFAULT_JOB_LOAD = 0.2f;

<span class="nc" id="L85">  private float jobload = DEFAULT_JOB_LOAD;</span>

<span class="nc" id="L87">  private enum Operation {</span>
<span class="nc" id="L88">    SILENCE_DETECTION</span>
  }
  /**
   * Reference to the workspace service
   */
<span class="nc" id="L93">  private Workspace workspace = null;</span>
  /**
   * Reference to the receipt service
   */
  private ServiceRegistry serviceRegistry;
  /**
   * The organization directory service
   */
<span class="nc" id="L101">  protected OrganizationDirectoryService organizationDirectoryService = null;</span>
  /**
   * The security service
   */
<span class="nc" id="L105">  protected SecurityService securityService = null;</span>
  /**
   * The user directory service
   */
<span class="nc" id="L109">  protected UserDirectoryService userDirectoryService = null;</span>
<span class="nc" id="L110">  protected SmilService smilService = null;</span>
  private Properties properties;

  public SilenceDetectionServiceImpl() {
<span class="nc" id="L114">    super(JOB_TYPE);</span>
<span class="nc" id="L115">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.silencedetection.api.SilenceDetectionService#detect(
   * org.opencastproject.mediapackage.Track)
   */
  @Override
  public Job detect(Track sourceTrack) throws SilenceDetectionFailedException {
<span class="nc" id="L125">    return detect(sourceTrack, null);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.silencedetection.api.SilenceDetectionService#detect(
   * org.opencastproject.mediapackage.Track, org.opencastproject.mediapackage.Track[])
   */
  @Override
  public Job detect(Track sourceTrack, Track[] referenceTracks) throws SilenceDetectionFailedException {
    try {
<span class="nc bnc" id="L137" title="All 2 branches missed.">      if (sourceTrack == null) {</span>
<span class="nc" id="L138">        throw new SilenceDetectionFailedException(&quot;Source track is null!&quot;);</span>
      }
<span class="nc" id="L140">      List&lt;String&gt; arguments = new LinkedList&lt;String&gt;();</span>
      // put source track as job argument
<span class="nc" id="L142">      arguments.add(0, MediaPackageElementParser.getAsXml(sourceTrack));</span>

      // put reference tracks as second argument
<span class="nc bnc" id="L145" title="All 2 branches missed.">      if (referenceTracks != null) {</span>
<span class="nc" id="L146">        arguments.add(1, MediaPackageElementParser.getArrayAsXml(Arrays.asList(referenceTracks)));</span>
      }

<span class="nc" id="L149">      return serviceRegistry.createJob(</span>
<span class="nc" id="L150">              getJobType(),</span>
<span class="nc" id="L151">              Operation.SILENCE_DETECTION.toString(),</span>
              arguments,
<span class="nc" id="L153">              jobload);</span>

<span class="nc" id="L155">    } catch (ServiceRegistryException ex) {</span>
<span class="nc" id="L156">      throw new SilenceDetectionFailedException(&quot;Unable to create job! &quot; + ex.getMessage());</span>
<span class="nc" id="L157">    } catch (MediaPackageException ex) {</span>
<span class="nc" id="L158">      throw new SilenceDetectionFailedException(&quot;Unable to serialize track!&quot;);</span>
    }
  }

  @Override
  protected String process(Job job) throws SilenceDetectionFailedException, SmilException, MediaPackageException {
<span class="nc bnc" id="L164" title="All 2 branches missed.">    if (Operation.SILENCE_DETECTION.toString().equals(job.getOperation())) {</span>
      // get source track
<span class="nc" id="L166">      String sourceTrackXml = StringUtils.trimToNull(job.getArguments().get(0));</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">      if (sourceTrackXml == null) {</span>
<span class="nc" id="L168">        throw new SilenceDetectionFailedException(&quot;Track not set!&quot;);</span>
      }
<span class="nc" id="L170">      Track sourceTrack = (Track) MediaPackageElementParser.getFromXml(sourceTrackXml);</span>

      // run detection on source track
<span class="nc" id="L173">      MediaSegments segments = runDetection(sourceTrack);</span>

      // get reference tracks if any
<span class="nc" id="L176">      List&lt;Track&gt; referenceTracks = null;</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">      if (job.getArguments().size() &gt; 1) {</span>
<span class="nc" id="L178">        String referenceTracksXml = StringUtils.trimToNull(job.getArguments().get(1));</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (referenceTracksXml != null) {</span>
<span class="nc" id="L180">          referenceTracks = (List&lt;Track&gt;) MediaPackageElementParser.getArrayFromXml(referenceTracksXml);</span>
        }
      }

<span class="nc bnc" id="L184" title="All 2 branches missed.">      if (referenceTracks == null) {</span>
<span class="nc" id="L185">        referenceTracks = Arrays.asList(sourceTrack);</span>
      }

      // create smil XML as result
      try {
<span class="nc" id="L190">        return generateSmil(segments, referenceTracks).toXML();</span>
<span class="nc" id="L191">      } catch (Exception ex) {</span>
<span class="nc" id="L192">        throw new SmilException(&quot;Failed to create smil document.&quot;, ex);</span>
      }
    }

<span class="nc" id="L196">    throw new SilenceDetectionFailedException(&quot;Can't handle this operation: &quot; + job.getOperation());</span>
  }

  /**
   * Run silence detection on the source track and returns
   * {@link org.opencastproject.silencedetection.api.MediaSegments}
   * XML as string. Source track should have an audio stream. All detected
   * {@link org.opencastproject.silencedetection.api.MediaSegment}s
   * (one or more) are non silent sequences.
   *
   * @param track track where to run silence detection
   * @return {@link MediaSegments} Xml as String
   * @throws SilenceDetectionFailedException if an error occures
   */
  protected MediaSegments runDetection(Track track) throws SilenceDetectionFailedException {
    try {
<span class="nc" id="L212">      FFmpegSilenceDetector silenceDetector = new FFmpegSilenceDetector(properties, track, workspace);</span>
<span class="nc" id="L213">      return silenceDetector.getMediaSegments();</span>
<span class="nc" id="L214">    } catch (Exception ex) {</span>
<span class="nc" id="L215">      throw new SilenceDetectionFailedException(ex.getMessage());</span>
    }
  }

  /**
   * Create a smil from given parameters.
   *
   * @param segments media segment list with timestamps
   * @param referenceTracks tracks to put as media segment source files
   * @return generated smil
   * @throws SmilException if smil creation failed
   */
  protected Smil generateSmil(MediaSegments segments, List&lt;Track&gt; referenceTracks) throws SmilException {
<span class="nc" id="L228">    SmilResponse smilResponse = smilService.createNewSmil();</span>
<span class="nc" id="L229">    Track[] referenceTracksArr = referenceTracks.toArray(new Track[0]);</span>

<span class="nc bnc" id="L231" title="All 2 branches missed.">    for (MediaSegment segment : segments.getMediaSegments()) {</span>
<span class="nc" id="L232">      smilResponse = smilService.addParallel(smilResponse.getSmil());</span>
<span class="nc" id="L233">      String parId = smilResponse.getEntity().getId();</span>

<span class="nc" id="L235">      smilResponse = smilService.addClips(smilResponse.getSmil(), parId, referenceTracksArr,</span>
<span class="nc" id="L236">              segment.getSegmentStart(), segment.getSegmentStop() - segment.getSegmentStart());</span>
<span class="nc" id="L237">    }</span>
<span class="nc" id="L238">    return smilResponse.getSmil();</span>
  }

  @Override
  protected ServiceRegistry getServiceRegistry() {
<span class="nc" id="L243">    return serviceRegistry;</span>
  }

  @Override
  protected SecurityService getSecurityService() {
<span class="nc" id="L248">    return securityService;</span>
  }

  @Override
  protected UserDirectoryService getUserDirectoryService() {
<span class="nc" id="L253">    return userDirectoryService;</span>
  }

  @Override
  protected OrganizationDirectoryService getOrganizationDirectoryService() {
<span class="nc" id="L258">    return organizationDirectoryService;</span>
  }

  @Activate
  @Modified
  public void activate(BundleContext bundleContext, ComponentContext context) {
<span class="nc" id="L264">    logger.debug(&quot;Loading configuration&quot;);</span>
<span class="nc" id="L265">    super.activate(context);</span>

<span class="nc" id="L267">    this.properties = new Properties();</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">    if (bundleContext == null) {</span>
<span class="nc" id="L269">      logger.info(&quot;No configuration available, using defaults&quot;);</span>
<span class="nc" id="L270">      return;</span>
    }
<span class="nc" id="L272">    FFmpegSilenceDetector.init(bundleContext);</span>
<span class="nc" id="L273">    Dictionary&lt;String, Object&gt; properties = context.getProperties();</span>
<span class="nc" id="L274">    Enumeration&lt;String&gt; keys = properties.keys();</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">    while (keys.hasMoreElements()) {</span>
<span class="nc" id="L276">      final String key = keys.nextElement();</span>
<span class="nc" id="L277">      logger.debug(&quot;{} = {}&quot;, key, properties.get(key));</span>
<span class="nc" id="L278">      this.properties.put(key, properties.get(key));</span>
<span class="nc" id="L279">    }</span>
<span class="nc" id="L280">    logger.debug(&quot;Properties updated!&quot;);</span>

<span class="nc" id="L282">    jobload = LoadUtil.getConfiguredLoadValue(properties, JOB_LOAD_KEY, DEFAULT_JOB_LOAD, serviceRegistry);</span>
<span class="nc" id="L283">  }</span>

  @Deactivate
  protected void deactivate(ComponentContext context) {
<span class="nc" id="L287">    logger.debug(&quot;deactivating...&quot;);</span>
<span class="nc" id="L288">  }</span>

  @Reference
  public void setServiceRegistry(ServiceRegistry serviceRegistry) {
<span class="nc" id="L292">    this.serviceRegistry = serviceRegistry;</span>
<span class="nc" id="L293">  }</span>

  @Reference
  public void setWorkspace(Workspace workspace) {
<span class="nc" id="L297">    this.workspace = workspace;</span>
<span class="nc" id="L298">  }</span>

  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="nc" id="L302">    this.securityService = securityService;</span>
<span class="nc" id="L303">  }</span>

  @Reference
  public void setUserDirectoryService(UserDirectoryService userDirectoryService) {
<span class="nc" id="L307">    this.userDirectoryService = userDirectoryService;</span>
<span class="nc" id="L308">  }</span>

  @Reference
  public void setOrganizationDirectoryService(OrganizationDirectoryService organizationDirectoryService) {
<span class="nc" id="L312">    this.organizationDirectoryService = organizationDirectoryService;</span>
<span class="nc" id="L313">  }</span>

  @Reference
  public void setSmilService(SmilService smilService) {
<span class="nc" id="L317">    this.smilService = smilService;</span>
<span class="nc" id="L318">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>