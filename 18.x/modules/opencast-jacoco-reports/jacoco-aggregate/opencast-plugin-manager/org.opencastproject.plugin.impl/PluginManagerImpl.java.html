<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>PluginManagerImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-plugin-manager</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.plugin.impl</a> &gt; <span class="el_source">PluginManagerImpl.java</span></div><h1>PluginManagerImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.plugin.impl;

import org.opencastproject.plugin.PluginManager;

import org.apache.commons.lang3.BooleanUtils;
import org.apache.karaf.features.Feature;
import org.apache.karaf.features.FeaturesService;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Deactivate;
import org.osgi.service.component.annotations.Modified;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Arrays;
import java.util.Collections;
import java.util.EnumSet;
import java.util.Map;
import java.util.Objects;
import java.util.Set;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.stream.Collectors;

/**
 * A simple tutorial class to learn about Opencast Services
 */
@Component(
    property = {
        &quot;service.description=Plugin Manager Service&quot;
    },
    immediate = true
)
<span class="nc" id="L56">public class PluginManagerImpl implements PluginManager {</span>

  /** The module specific logger */
<span class="nc" id="L59">  private static final Logger logger = LoggerFactory.getLogger(PluginManagerImpl.class);</span>

  private static final String OPENCAST_FEATURE_PREFIX = &quot;opencast-&quot;;
  private static final String PLUGIN_FEATURE_PREFIX = OPENCAST_FEATURE_PREFIX + &quot;plugin-&quot;;
  private static final String VERBOSE = &quot;verbose&quot;;

  private ExecutorService executor;
  private FeaturesService featuresService;
  private Set&lt;String&gt; activePlugins;
  private boolean verbose;

  @Reference
  public void setFeaturesService(FeaturesService featuresService) {
<span class="nc" id="L72">    this.featuresService = featuresService;</span>
<span class="nc" id="L73">  }</span>

  @Activate
  @Modified
  void activate(Map&lt;String, Object&gt; properties) {
<span class="nc" id="L78">    logger.debug(&quot;Activating {}&quot;, PluginManagerImpl.class);</span>

<span class="nc bnc" id="L80" title="All 2 branches missed.">    if (executor == null) {</span>
<span class="nc" id="L81">      executor = Executors.newSingleThreadExecutor(</span>
<span class="nc" id="L82">          runnable -&gt; new Thread(runnable, PluginManager.class.getSimpleName())</span>
      );
    }

    // Load plugin configuration
<span class="nc" id="L87">    activePlugins = properties.entrySet().stream()</span>
<span class="nc" id="L88">            .filter(e -&gt; BooleanUtils.toBoolean(Objects.toString(e.getValue(), &quot;&quot;).trim()))</span>
<span class="nc" id="L89">            .map(Map.Entry::getKey)</span>
<span class="nc" id="L90">            .collect(Collectors.toSet());</span>
<span class="nc" id="L91">    logger.debug(&quot;Active plugin configuration: {}&quot;, activePlugins);</span>

    // Verbose Karaf logs active?
<span class="nc" id="L94">    verbose = BooleanUtils.toBoolean(Objects.toString(properties.get(VERBOSE)));</span>

<span class="nc" id="L96">    executor.submit(new PluginStarter());</span>
<span class="nc" id="L97">  }</span>

  @Deactivate
  void deactivate() {
<span class="nc bnc" id="L101" title="All 2 branches missed.">    if (executor != null) {</span>
<span class="nc" id="L102">      executor.shutdownNow();</span>
<span class="nc" id="L103">      executor = null;</span>
    }
<span class="nc" id="L105">  }</span>

  @Override
  public Set&lt;String&gt; listAvailablePlugins() {
    try {
<span class="nc" id="L110">      return Arrays.stream(featuresService.listFeatures())</span>
<span class="nc" id="L111">          .map(Feature::getName)</span>
<span class="nc" id="L112">          .filter(feature -&gt; feature.startsWith(PLUGIN_FEATURE_PREFIX))</span>
<span class="nc" id="L113">          .collect(Collectors.toSet());</span>
<span class="nc" id="L114">    } catch (Exception e) {</span>
<span class="nc" id="L115">      return Collections.emptySet();</span>
    }
  }

  @Override
  public Set&lt;String&gt; listInstalledPlugins() {
    try {
<span class="nc" id="L122">      return Arrays.stream(featuresService.listInstalledFeatures())</span>
<span class="nc" id="L123">          .map(Feature::getName)</span>
<span class="nc" id="L124">          .filter(feature -&gt; feature.startsWith(PLUGIN_FEATURE_PREFIX))</span>
<span class="nc" id="L125">          .collect(Collectors.toSet());</span>
<span class="nc" id="L126">    } catch (Exception e) {</span>
<span class="nc" id="L127">      return Collections.emptySet();</span>
    }
  }

<span class="nc" id="L131">  public class PluginStarter implements Runnable {</span>
    public void run() {
<span class="nc" id="L133">      EnumSet&lt;FeaturesService.Option&gt; options = EnumSet.noneOf(FeaturesService.Option.class);</span>
<span class="nc" id="L134">      options.add(FeaturesService.Option.NoAutoRefreshBundles);</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">      if (verbose) {</span>
<span class="nc" id="L136">        options.add(FeaturesService.Option.Verbose);</span>
      }

      try {
<span class="nc" id="L140">        var ocFeatures = Arrays.stream(featuresService.listInstalledFeatures())</span>
<span class="nc" id="L141">                .map(Feature::getName)</span>
<span class="nc" id="L142">                .filter(feature -&gt; feature.startsWith(OPENCAST_FEATURE_PREFIX))</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">                .filter(feature -&gt; !feature.startsWith(PLUGIN_FEATURE_PREFIX))</span>
<span class="nc" id="L144">                .collect(Collectors.toSet());</span>
<span class="nc" id="L145">        logger.debug(&quot;Detected active Opencast features: {}&quot;, ocFeatures);</span>

<span class="nc" id="L147">        var installedPlugins = listInstalledPlugins();</span>
<span class="nc" id="L148">        logger.debug(&quot;Detected, already active Opencast plugins: {}&quot;, installedPlugins);</span>

<span class="nc" id="L150">        logger.info(&quot;Loading plug-insâ€¦&quot;);</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">        for (Feature feature : featuresService.listFeatures()) {</span>
          // Check if feature actually is a plugin
<span class="nc bnc" id="L153" title="All 2 branches missed.">          if (!feature.getName().startsWith(PLUGIN_FEATURE_PREFIX)) {</span>
<span class="nc" id="L154">            logger.debug(&quot;Skipping non-plugin feature {}&quot;, feature);</span>
<span class="nc" id="L155">            continue;</span>
          }

          // Get the base name of the plugin.
          // We can have multiple variants of a plugin defining different modules for different distributions like:
          // - opencast-plugin-xy_admin
          // - opencast-plugin-xy_worker
          // But we want both to be enabled if `opencast-plugin-xy = on` is set.
<span class="nc" id="L163">          var baseName = feature.getName().split(&quot;_&quot;)[0];</span>

          // Check if plugin is active
<span class="nc bnc" id="L166" title="All 2 branches missed.">          if (!activePlugins.contains(baseName)) {</span>
<span class="nc" id="L167">            logger.info(&quot;Skipping disabled plugin {}&quot;, feature);</span>
<span class="nc" id="L168">            continue;</span>
          }

          // Check if conditions match (or if there are none)
<span class="nc" id="L172">          var conditionsMatch = feature.getConditional().stream()</span>
<span class="nc" id="L173">                  .flatMap(conditional -&gt; conditional.getCondition().stream())</span>
<span class="nc" id="L174">                  .map(ocFeatures::contains)</span>
<span class="nc" id="L175">                  .reduce(Boolean::logicalOr)</span>
<span class="nc" id="L176">                  .orElse(true);</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">          if (!conditionsMatch) {</span>
<span class="nc" id="L178">            logger.info(&quot;Plugin conditions do not match. Skipping {}&quot;, feature);</span>
<span class="nc" id="L179">            continue;</span>
          }

<span class="nc" id="L182">          logger.info(&quot;Installing plugin {}&quot;, feature);</span>
<span class="nc" id="L183">          featuresService.installFeature(feature, options);</span>
        }

        // Check if any of the previously installed features need to be uninstalled
<span class="nc bnc" id="L187" title="All 2 branches missed.">        for (var plugin: installedPlugins) {</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">          if (!activePlugins.contains(plugin)) {</span>
<span class="nc" id="L189">            logger.info(&quot;Uninstalling plugin {}&quot;, plugin);</span>
<span class="nc" id="L190">            featuresService.uninstallFeature(plugin, options);</span>
          }
<span class="nc" id="L192">        }</span>
<span class="nc" id="L193">      } catch (Exception e) {</span>
<span class="nc" id="L194">        logger.error(&quot;Installing plugins failed&quot;, e);</span>
<span class="nc" id="L195">      }</span>
<span class="nc" id="L196">    }</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>