<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CutMarksToSmilWorkflowOperationHandler.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-smil-workflowoperation</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.workflow.handler.smil</a> &gt; <span class="el_source">CutMarksToSmilWorkflowOperationHandler.java</span></div><h1>CutMarksToSmilWorkflowOperationHandler.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.workflow.handler.smil;

import org.opencastproject.job.api.JobContext;
import org.opencastproject.mediapackage.Catalog;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.mediapackage.MediaPackageElement;
import org.opencastproject.mediapackage.MediaPackageElementBuilder;
import org.opencastproject.mediapackage.MediaPackageElementBuilderFactory;
import org.opencastproject.mediapackage.MediaPackageElementFlavor;
import org.opencastproject.mediapackage.Track;
import org.opencastproject.mediapackage.selector.TrackSelector;
import org.opencastproject.serviceregistry.api.ServiceRegistry;
import org.opencastproject.smil.api.SmilException;
import org.opencastproject.smil.api.SmilResponse;
import org.opencastproject.smil.api.SmilService;
import org.opencastproject.smil.entity.api.Smil;
import org.opencastproject.smil.entity.media.container.api.SmilMediaContainer;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.workflow.api.AbstractWorkflowOperationHandler;
import org.opencastproject.workflow.api.WorkflowInstance;
import org.opencastproject.workflow.api.WorkflowOperationException;
import org.opencastproject.workflow.api.WorkflowOperationHandler;
import org.opencastproject.workflow.api.WorkflowOperationInstance;
import org.opencastproject.workflow.api.WorkflowOperationResult;
import org.opencastproject.workspace.api.Workspace;

import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;

import org.apache.commons.io.IOUtils;
import org.apache.commons.lang3.StringUtils;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.xml.sax.SAXException;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.IOException;
import java.io.InputStream;
import java.lang.reflect.Type;
import java.net.URI;
import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.ListIterator;

import javax.xml.bind.JAXBException;

/**
 * The workflow definition for converting a smil containing cut marks into a legal smil for cutting
 */
@Component(
    immediate = true,
    service = WorkflowOperationHandler.class,
    property = {
        &quot;service.description=Cut Marks To Smil Operation Handler&quot;,
        &quot;workflow.operation=cut-marks-to-smil&quot;
    }
)
<span class="fc" id="L83">public class CutMarksToSmilWorkflowOperationHandler extends AbstractWorkflowOperationHandler {</span>

  /** Workflow configuration keys */
  private static final String SOURCE_MEDIA_FLAVORS = &quot;source-media-flavors&quot;;
  private static final String SOURCE_JSON_FLAVOR = &quot;source-json-flavor&quot;;

  private static final String TARGET_SMIL_FLAVOR = &quot;target-smil-flavor&quot;;
  private static final String TARGET_TAGS = &quot;target-tags&quot;;

  private static final String CUTTING_SMIL_NAME = &quot;prepared_cutting_smil&quot;;

  /** The logging facility */
<span class="fc" id="L95">  private static final Logger logger = LoggerFactory.getLogger(CutMarksToSmilWorkflowOperationHandler.class);</span>

  /** The local workspace */
<span class="fc" id="L98">  private Workspace workspace = null;</span>

  /**
   * Callback for declarative services configuration that will introduce us to the local workspace service.
   * Implementation assumes that the reference is configured as being static.
   *
   * @param workspace
   *          an instance of the workspace
   */
  @Reference
  public void setWorkspace(Workspace workspace) {
<span class="fc" id="L109">    this.workspace = workspace;</span>
<span class="fc" id="L110">  }</span>

  /**
   * The SMIL service to modify SMIL files.
   */
  private SmilService smilService;

  @Reference
  public void setSmilService(SmilService smilService) {
<span class="fc" id="L119">    this.smilService = smilService;</span>
<span class="fc" id="L120">  }</span>

  /** JSON Parser */
<span class="fc" id="L123">  private static final Gson gson = new Gson();</span>
<span class="fc" id="L124">  private static final Type timesListType = new TypeToken&lt;List&lt;Times&gt;&gt;() { }.getType();</span>

  /** Stores information read from JSON */
<span class="fc" id="L127">  static class Times {</span>
    private Long begin;
    private Long duration;
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowOperationHandler#start(
   *        org.opencastproject.workflow.api.WorkflowInstance,
   *        JobContext)
   */
  @Override
  public WorkflowOperationResult start(final WorkflowInstance workflowInstance, JobContext context)
          throws WorkflowOperationException {
<span class="fc" id="L142">    logger.info(&quot;Running cut marks to smil workflow operation on workflow {}&quot;, workflowInstance.getId());</span>

<span class="fc" id="L144">    WorkflowOperationInstance operation = workflowInstance.getCurrentOperation();</span>
<span class="fc" id="L145">    final MediaPackage mediaPackage = (MediaPackage) workflowInstance.getMediaPackage().clone();</span>

    // Read config options
<span class="fc" id="L148">    final MediaPackageElementFlavor jsonFlavor = MediaPackageElementFlavor.parseFlavor(</span>
<span class="fc" id="L149">            getConfig(operation, SOURCE_JSON_FLAVOR));</span>
<span class="fc" id="L150">    final MediaPackageElementFlavor targetSmilFlavor = MediaPackageElementFlavor.parseFlavor(</span>
<span class="fc" id="L151">            getConfig(operation, TARGET_SMIL_FLAVOR));</span>

<span class="fc" id="L153">    String flavorNames = operation.getConfiguration(SOURCE_MEDIA_FLAVORS);</span>
<span class="fc" id="L154">    final List&lt;MediaPackageElementFlavor&gt; flavors = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">    for (String flavorName : asList(flavorNames)) {</span>
<span class="fc" id="L156">      flavors.add(MediaPackageElementFlavor.parseFlavor(flavorName));</span>
<span class="fc" id="L157">    }</span>

    // Target tags
<span class="fc" id="L160">    String targetTagsOption = StringUtils.trimToNull(operation.getConfiguration(TARGET_TAGS));</span>
<span class="fc" id="L161">    List&lt;String&gt; targetTags = asList(targetTagsOption);</span>

    // Is there a catalog?
<span class="fc" id="L164">    MediaPackageElement[] cutMarksElements = mediaPackage.getAttachments(jsonFlavor);</span>
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">    if (cutMarksElements.length &lt; 1) {</span>
<span class="fc" id="L166">      logger.debug(&quot;No cut marks found as attachment. Falling back to catalogs…&quot;);</span>
<span class="fc" id="L167">      cutMarksElements = mediaPackage.getCatalogs(jsonFlavor);</span>
    }
<span class="fc bfc" id="L169" title="All 2 branches covered.">    if (cutMarksElements.length &lt; 1) {</span>
<span class="fc" id="L170">      logger.warn(&quot;No cut marks with source flavor {} found. Skipping…&quot;, jsonFlavor);</span>
<span class="fc" id="L171">      return createResult(mediaPackage, WorkflowOperationResult.Action.SKIP);</span>
<span class="fc bfc" id="L172" title="All 2 branches covered.">    } else if (cutMarksElements.length &gt; 1) {</span>
      // Remember Highlander? There can be only one!
<span class="fc" id="L174">      throw new WorkflowOperationException(String.format(</span>
          &quot;More than one cut marks element with source flavor %s found! Make sure there is only one.&quot;, jsonFlavor));
    }

    // Parse JSON
    List&lt;Times&gt; cutMarks;
<span class="fc" id="L180">    MediaPackageElement jsonWithTimes = cutMarksElements[0];</span>
<span class="fc" id="L181">    try (BufferedReader reader = new BufferedReader(new FileReader(getMediaPackageElementPath(jsonWithTimes)))) {</span>
<span class="fc" id="L182">      cutMarks = gson.fromJson(reader, timesListType);</span>
<span class="fc" id="L183">    } catch (Exception e) {</span>
<span class="fc" id="L184">      throw new WorkflowOperationException(&quot;Could not read JSON&quot;, e);</span>
<span class="fc" id="L185">    }</span>

    // If the catalog was empty, give up
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">    if (cutMarks.size() &lt; 1) {</span>
<span class="nc" id="L189">      logger.warn(&quot;Source JSON did not contain any timestamps! Skipping...&quot;);</span>
<span class="nc" id="L190">      return createResult(mediaPackage, WorkflowOperationResult.Action.SKIP);</span>
    }

    // Check parsing results
<span class="fc bfc" id="L194" title="All 2 branches covered.">    for (Times entry : cutMarks) {</span>
<span class="fc" id="L195">      logger.debug(&quot;Entry begin={}, duration={}&quot;, entry.begin, entry.duration);</span>
<span class="pc bpc" id="L196" title="2 of 4 branches missed.">      if (entry.begin &lt; 0 || entry.duration &lt; 0) {</span>
<span class="nc" id="L197">        throw new WorkflowOperationException(&quot;Times may not be negative.&quot;);</span>
      }
<span class="fc" id="L199">    }</span>

    // Get video tracks
<span class="fc" id="L202">    logger.info(&quot;Get tracks from media package&quot;);</span>
<span class="fc" id="L203">    ArrayList&lt;Track&gt; tracksFromFlavors = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L204" title="All 2 branches covered.">    for (MediaPackageElementFlavor flavor : flavors) {</span>
<span class="fc" id="L205">      logger.debug(&quot;Trying to get tracks with flavor {}&quot;, flavor);</span>
<span class="fc" id="L206">      TrackSelector trackSelector = new TrackSelector();</span>
<span class="fc" id="L207">      trackSelector.addFlavor(flavor);</span>
<span class="fc" id="L208">      Collection&lt;Track&gt; tracks = trackSelector.select(mediaPackage, false);</span>
<span class="fc" id="L209">      logger.debug(&quot;Found {} tracks with flavor {}&quot;, tracks.size(), flavor);</span>
<span class="fc" id="L210">      tracksFromFlavors.addAll(tracks);</span>
<span class="fc" id="L211">    }</span>

    // Are there actually any tracks?
<span class="fc bfc" id="L214" title="All 2 branches covered.">    if (tracksFromFlavors.isEmpty()) {</span>
<span class="fc" id="L215">      logger.warn(&quot;No track with given flavors. Skipping…&quot;);</span>
<span class="fc" id="L216">      return createResult(mediaPackage, WorkflowOperationResult.Action.SKIP);</span>
    }

    // Check for cut marks that would lead to errors with the given tracks and remove them
    // Possible TODO: Instead of removing, only apply cut marks to tracks with a long enough duration?
    // Get the shortest duration of all tracks
<span class="fc" id="L222">    long shortestDuration = Long.MAX_VALUE;</span>
<span class="fc bfc" id="L223" title="All 2 branches covered.">    for (Track track : tracksFromFlavors) {</span>
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">      if (track.getDuration() &lt; shortestDuration) {</span>
<span class="fc" id="L225">        shortestDuration = track.getDuration();</span>
      }
<span class="fc" id="L227">    }</span>
    // Remove all timestamps that begin after the shortest duration
<span class="fc" id="L229">    ListIterator&lt;Times&gt; iter = cutMarks.listIterator();</span>
<span class="fc bfc" id="L230" title="All 2 branches covered.">    while (iter.hasNext()) {</span>
<span class="fc" id="L231">      long begin = iter.next().begin;</span>
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">      if (begin &gt; shortestDuration) {</span>
<span class="nc" id="L233">        logger.info(&quot;Skipped mark with begin: {}, &quot;, begin);</span>
<span class="nc" id="L234">        iter.remove();</span>
      }
<span class="fc" id="L236">    }</span>
    // If the timestamp list is now empty, give up
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">    if (cutMarks.size() &lt; 1) {</span>
<span class="nc" id="L239">      logger.warn(&quot;No timestamps are valid for the given tracks! Skipping...&quot;);</span>
<span class="nc" id="L240">      return createResult(mediaPackage, WorkflowOperationResult.Action.SKIP);</span>
    }

    // Create the new SMIL document
    Smil smil;
    try {
<span class="fc" id="L246">      SmilResponse smilResponse = smilService.createNewSmil(mediaPackage);</span>

<span class="fc" id="L248">      logger.info(&quot;Start adding tracks&quot;);</span>
<span class="fc bfc" id="L249" title="All 2 branches covered.">      for (Times mark : cutMarks) {</span>
<span class="fc" id="L250">        smilResponse = smilService.addParallel(smilResponse.getSmil());</span>
<span class="fc" id="L251">        SmilMediaContainer par = (SmilMediaContainer) smilResponse.getEntity();</span>
<span class="fc" id="L252">        logger.debug(&quot;Segment begin: {}; Segment duration: {}&quot;, mark.begin, mark.duration);</span>
        // Add tracks (as array) to par
<span class="fc" id="L254">        smilResponse = smilService</span>
<span class="fc" id="L255">                .addClips(smilResponse.getSmil(),</span>
<span class="fc" id="L256">                        par.getId(),</span>
<span class="fc" id="L257">                        tracksFromFlavors.toArray(new Track[0]),</span>
<span class="fc" id="L258">                        mark.begin,</span>
<span class="fc" id="L259">                        mark.duration);</span>
<span class="fc" id="L260">      }</span>

<span class="fc" id="L262">      smil = smilResponse.getSmil();</span>
<span class="fc" id="L263">      logger.info(&quot;Done adding tracks&quot;);</span>
<span class="nc" id="L264">    } catch (SmilException e) {</span>
<span class="nc" id="L265">      throw new WorkflowOperationException(&quot;Failed to create SMIL Catalog&quot;, e);</span>
<span class="fc" id="L266">    }</span>

    // Put new SMIL into workspace and add it to media package
<span class="fc" id="L269">    try (InputStream is = IOUtils.toInputStream(smil.toXML(), &quot;UTF-8&quot;)) {</span>
<span class="fc" id="L270">      URI smilURI = workspace.put(mediaPackage.getIdentifier().toString(), smil.getId(), CUTTING_SMIL_NAME, is);</span>
<span class="fc" id="L271">      MediaPackageElementBuilder mpeBuilder = MediaPackageElementBuilderFactory.newInstance().newElementBuilder();</span>
<span class="fc" id="L272">      Catalog catalog = (Catalog) mpeBuilder</span>
<span class="fc" id="L273">              .elementFromURI(smilURI, MediaPackageElement.Type.Catalog, targetSmilFlavor);</span>
<span class="fc" id="L274">      catalog.setIdentifier(smil.getId());</span>
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">      for (String tag : targetTags) {</span>
<span class="nc" id="L276">        catalog.addTag(tag);</span>
<span class="nc" id="L277">      }</span>
<span class="fc" id="L278">      mediaPackage.add(catalog);</span>
<span class="nc" id="L279">    } catch (JAXBException | SAXException | IOException e) {</span>
<span class="nc" id="L280">      throw new WorkflowOperationException(&quot;Failed to parse crated SMIL Catalog&quot;, e);</span>
<span class="fc" id="L281">    }</span>

<span class="fc" id="L283">    final WorkflowOperationResult result = createResult(mediaPackage, WorkflowOperationResult.Action.CONTINUE);</span>
<span class="fc" id="L284">    logger.debug(&quot;Cut marks to smil operation completed&quot;);</span>
<span class="fc" id="L285">    return result;</span>
  }

  /**
   * Returns the absolute path for a given MediaPackageElement
   * @param mpe
   *          The MediaPackageElement we want to know the absolute path for
   * @return
   *          The absolute path
   * @throws WorkflowOperationException
   */
  private String getMediaPackageElementPath(MediaPackageElement mpe) throws WorkflowOperationException {
    File mediaFile;
    try {
<span class="fc" id="L299">      mediaFile = workspace.get(mpe.getURI());</span>
<span class="nc" id="L300">    } catch (NotFoundException | IOException e) {</span>
<span class="nc" id="L301">      throw new WorkflowOperationException(</span>
              &quot;Error finding the media file in the workspace&quot;, e);
<span class="fc" id="L303">    }</span>

<span class="fc" id="L305">    return mediaFile.getAbsolutePath();</span>
  }

  @Reference
  @Override
  public void setServiceRegistry(ServiceRegistry serviceRegistry) {
<span class="nc" id="L311">    super.setServiceRegistry(serviceRegistry);</span>
<span class="nc" id="L312">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>