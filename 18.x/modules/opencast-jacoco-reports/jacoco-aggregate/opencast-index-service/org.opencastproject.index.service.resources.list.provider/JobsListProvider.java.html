<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>JobsListProvider.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-index-service</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.index.service.resources.list.provider</a> &gt; <span class="el_source">JobsListProvider.java</span></div><h1>JobsListProvider.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.index.service.resources.list.provider;

import org.opencastproject.job.api.Job;
import org.opencastproject.list.api.ResourceListProvider;
import org.opencastproject.list.api.ResourceListQuery;
import org.opencastproject.workflow.api.WorkflowDatabaseException;
import org.opencastproject.workflow.api.WorkflowDefinition;
import org.opencastproject.workflow.api.WorkflowService;

import org.apache.commons.lang3.StringUtils;
import org.osgi.framework.BundleContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.HashMap;
import java.util.Map;

/** Jobs list provider. */
@Component(
    service = ResourceListProvider.class,
    property = {
        &quot;service.description=Jobs list provider&quot;,
        &quot;opencast.service.type=org.opencastproject.index.service.resources.list.provider.JobsListProvider&quot;
    }
)
<span class="fc" id="L50">public class JobsListProvider implements ResourceListProvider {</span>

<span class="fc" id="L52">  private static final Logger logger = LoggerFactory.getLogger(JobsListProvider.class);</span>

  /** Prefix for list names. */
  private static final String PROVIDER_PREFIX = &quot;JOBS&quot;;
  /** Status list name. */
  public static final String LIST_STATUS = PROVIDER_PREFIX + &quot;.STATUS&quot;;
  /** Workflow list name. */
  public static final String LIST_WORKFLOW = PROVIDER_PREFIX + &quot;.WORKFLOW&quot;;

  /** Filter label prefix. */
  private static final String FILTER_LABEL_PREFIX = &quot;FILTERS.&quot; + PROVIDER_PREFIX;
  /** Job status label prefix. */
  public static final String JOB_STATUS_FILTER_PREFIX = FILTER_LABEL_PREFIX + &quot;.STATUS.&quot;;

  /** The names of the different list available through this provider. */
<span class="fc" id="L67">  protected static final String[] NAMES = { PROVIDER_PREFIX, LIST_STATUS, LIST_WORKFLOW };</span>

  /** Workflow service instance. */
  private WorkflowService workflowService;

  @Override
  public String[] getListNames() {
<span class="nc" id="L74">    return NAMES;</span>
  }

  @Override
  public Map&lt;String, String&gt; getList(String listName, ResourceListQuery query) {

<span class="fc" id="L80">    String listNameTrimmed = StringUtils.trimToEmpty(listName);</span>
<span class="fc" id="L81">    Map&lt;String, String&gt; jobList = new HashMap&lt;String, String&gt;();</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">    if (StringUtils.equalsIgnoreCase(LIST_STATUS, listName)) {</span>
<span class="fc" id="L83">      jobList.put(Job.Status.PAUSED.toString(), JOB_STATUS_FILTER_PREFIX + Job.Status.PAUSED.toString());</span>
<span class="fc" id="L84">      jobList.put(Job.Status.QUEUED.toString(), JOB_STATUS_FILTER_PREFIX + Job.Status.QUEUED.toString());</span>
<span class="fc" id="L85">      jobList.put(Job.Status.RUNNING.toString(), JOB_STATUS_FILTER_PREFIX + Job.Status.RUNNING.toString());</span>
<span class="fc" id="L86">      jobList.put(Job.Status.WAITING.toString(), JOB_STATUS_FILTER_PREFIX + Job.Status.WAITING.toString());</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">    } else if (StringUtils.equalsIgnoreCase(LIST_WORKFLOW, listNameTrimmed)) {</span>
      try {
<span class="fc bfc" id="L89" title="All 2 branches covered.">        for (WorkflowDefinition workflowDef : workflowService.listAvailableWorkflowDefinitions()) {</span>
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">          if (StringUtils.isNotBlank(workflowDef.getTitle())</span>
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">                  &amp;&amp; !jobList.containsKey(workflowDef.getId())</span>
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">                  &amp;&amp; !jobList.containsValue(workflowDef.getTitle())) {</span>
<span class="fc" id="L93">            jobList.put(workflowDef.getId(), workflowDef.getTitle());</span>
          }
<span class="fc" id="L95">        }</span>
<span class="nc" id="L96">      } catch (WorkflowDatabaseException ex) {</span>
<span class="nc" id="L97">        logger.error(&quot;Failed to get available workflow definitions from workflow service: {}&quot;, ex.getMessage());</span>
<span class="fc" id="L98">      }</span>
    }

<span class="fc" id="L101">    return jobList;</span>
  }

  /** OSGi service activation callback. */
  @Activate
  protected void activate(BundleContext bundleContext) {
<span class="fc" id="L107">    logger.info(&quot;Jobs list provider activated!&quot;);</span>
<span class="fc" id="L108">  }</span>

  /** OSGi callback for the workflow service. */
  @Reference
  public void setWorkflowService(WorkflowService workflowService) {
<span class="fc" id="L113">    this.workflowService = workflowService;</span>
<span class="fc" id="L114">  }</span>

  @Override
  public boolean isTranslatable(String listName) {
<span class="nc" id="L118">    return StringUtils.equalsIgnoreCase(LIST_STATUS, listName);</span>
  }

  @Override
  public String getDefault() {
<span class="nc" id="L123">    return null;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>