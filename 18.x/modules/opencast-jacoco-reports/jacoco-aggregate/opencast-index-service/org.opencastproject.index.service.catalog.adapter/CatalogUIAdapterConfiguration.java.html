<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CatalogUIAdapterConfiguration.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-index-service</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.index.service.catalog.adapter</a> &gt; <span class="el_source">CatalogUIAdapterConfiguration.java</span></div><h1>CatalogUIAdapterConfiguration.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.index.service.catalog.adapter;

import static java.lang.String.format;
import static org.apache.commons.lang3.StringUtils.isBlank;

import org.opencastproject.util.ConfigurationException;
import org.opencastproject.util.XmlNamespaceContext;

import java.util.Dictionary;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.Map;

/**
 * This class parses a catalog UI adapter configuration and provides convenience access methods.
 */
public final class CatalogUIAdapterConfiguration {

  /* Configuration keys */
  public static final String KEY_XML_ROOT_ELEMENT_NAME = &quot;xml.rootElement.name&quot;;
  public static final String KEY_XML_ROOT_ELEMENT_NS_URI = &quot;xml.rootElement.namespace.URI&quot;;
  public static final String XML_BINDING_KEY_PREFIX = &quot;xml.namespaceBinding.&quot;;
  public static final String XML_BINDING_URI_SUFFIX = &quot;.URI&quot;;
  public static final String XML_BINDING_PREFIX_SUFFIX = &quot;.prefix&quot;;

  /** The raw configuration properties */
  private final Dictionary&lt;String, ?&gt; configProperties;

  /** The xml namespace binding context */
  private XmlNamespaceContext xmlNSContext;

  /**
   * Load configuration from a dictionary.
   *
   * @param properties
   *          The configuration properties
   * @return The parsed configuration as {@link CatalogUIAdapterConfiguration} instance
   * @throws ConfigurationException
   *           If the configuration has any errors
   */
  public static CatalogUIAdapterConfiguration loadFromDictionary(Dictionary&lt;String, ?&gt; properties)
          throws ConfigurationException {
<span class="fc" id="L64">    return new CatalogUIAdapterConfiguration(properties);</span>
  }

<span class="fc" id="L67">  private CatalogUIAdapterConfiguration(Dictionary&lt;String, ?&gt; properties) throws ConfigurationException {</span>
<span class="fc" id="L68">    this.configProperties = properties;</span>
<span class="fc" id="L69">    loadXmlNSContext();</span>
<span class="fc" id="L70">    validate();</span>
<span class="fc" id="L71">  }</span>

  /**
   * Validates the configuration and throws a {@link ConfigurationException} if there is any error.
   *
   * @throws ConfigurationException
   *           if the configuration is not valid
   */
  private void validate() throws ConfigurationException {
<span class="fc bfc" id="L80" title="All 2 branches covered.">    if (configProperties.get(KEY_XML_ROOT_ELEMENT_NAME) == null)</span>
<span class="fc" id="L81">      throw new ConfigurationException(</span>
<span class="fc" id="L82">              format(&quot;Value for configuration key '%s' is missing&quot;, KEY_XML_ROOT_ELEMENT_NAME));</span>

<span class="fc bfc" id="L84" title="All 2 branches covered.">    if (configProperties.get(KEY_XML_ROOT_ELEMENT_NS_URI) == null)</span>
<span class="fc" id="L85">      throw new ConfigurationException(</span>
<span class="fc" id="L86">              format(&quot;Value for configuration key '%s' is missing&quot;, KEY_XML_ROOT_ELEMENT_NS_URI));</span>

<span class="fc bfc" id="L88" title="All 2 branches covered.">    if (xmlNSContext.getPrefix(getCatalogXmlRootNamespace()) == null)</span>
<span class="fc" id="L89">      throw new ConfigurationException(</span>
<span class="fc" id="L90">              format(&quot;Binding for XML namespace URI '%s' is missing&quot;, getCatalogXmlRootNamespace()));</span>
<span class="fc" id="L91">  }</span>

  /**
   * Load the XML namespace bindings from the configuration and build the XML namespace context.
   */
  private void loadXmlNSContext() {
<span class="fc" id="L97">    final Enumeration&lt;String&gt; keys = configProperties.keys();</span>
<span class="fc" id="L98">    final Map&lt;String, String&gt; prefixToUri = new HashMap&lt;String, String&gt;();</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">    while (keys.hasMoreElements()) {</span>
<span class="fc" id="L100">      final String key = keys.nextElement();</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">      if (key.startsWith(XML_BINDING_KEY_PREFIX)) {</span>
        // First, we need to get the name of the binding
<span class="fc" id="L103">        final String nsBindingName = getXmlBindingNameFromConfigKey(key);</span>
        // Once we have the name, we're able to retrieve the URI as well as the prefix
<span class="fc" id="L105">        final String nsUri = (String) configProperties</span>
<span class="fc" id="L106">                .get(XML_BINDING_KEY_PREFIX + nsBindingName + XML_BINDING_URI_SUFFIX);</span>
<span class="fc" id="L107">        final String nsPrefix = (String) configProperties</span>
<span class="fc" id="L108">                .get(XML_BINDING_KEY_PREFIX + nsBindingName + XML_BINDING_PREFIX_SUFFIX);</span>
        // Check if URI and the prefix have valid values
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">        if (isBlank(nsUri))</span>
<span class="nc" id="L111">          throw new ConfigurationException(format(&quot;No URI for namespace binding '%s' found&quot;, nsBindingName));</span>
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">        if (nsPrefix == null)</span>
<span class="nc" id="L113">          throw new ConfigurationException(format(&quot;No prefix for namespace binding '%s' found&quot;, nsBindingName));</span>
        // Add prefix &amp; URI to the intermediate map
<span class="fc" id="L115">        prefixToUri.put(nsPrefix, nsUri);</span>
      }
<span class="fc" id="L117">    }</span>

<span class="fc" id="L119">    xmlNSContext = new XmlNamespaceContext(prefixToUri);</span>
<span class="fc" id="L120">  }</span>

  /**
   * Get the name of an XML namespace binding by one of its configuration keys.
   *
   * @param key
   *          the key name
   * @return the XML namespace binding name
   */
  private static String getXmlBindingNameFromConfigKey(final String key) {
<span class="pc bpc" id="L130" title="2 of 4 branches missed.">    if (isBlank(key) || !key.startsWith(XML_BINDING_KEY_PREFIX))</span>
<span class="nc" id="L131">      throw new IllegalArgumentException(format(&quot;The given key '%s' is not part of a XML binding definition&quot;, key));</span>
<span class="fc" id="L132">    final String keyWithoutPrefix = key.substring(XML_BINDING_KEY_PREFIX.length());</span>
<span class="fc" id="L133">    return keyWithoutPrefix.substring(0, keyWithoutPrefix.indexOf(&quot;.&quot;));</span>
  }

  /**
   * Return the value of the configuration property {@link CatalogUIAdapterConfiguration#KEY_XML_ROOT_ELEMENT_NAME}
   */
  public String getCatalogXmlRootElementName() {
<span class="fc" id="L140">    return (String) configProperties.get(KEY_XML_ROOT_ELEMENT_NAME);</span>
  }

  /**
   * Return the value of the configuration property {@link CatalogUIAdapterConfiguration#KEY_XML_ROOT_ELEMENT_NS_URI}
   */
  public String getCatalogXmlRootNamespace() {
<span class="fc" id="L147">    return (String) configProperties.get(KEY_XML_ROOT_ELEMENT_NS_URI);</span>
  }

  /**
   * Returns the XML namespace context that could be built out of the configuration.
   */
  public XmlNamespaceContext getXmlNamespaceContext() {
<span class="fc" id="L154">    return xmlNSContext;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>