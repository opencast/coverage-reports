<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>MicrosoftAzureStorageClient.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-transcription-service-microsoft-azure</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.transcription.microsoft.azure</a> &gt; <span class="el_source">MicrosoftAzureStorageClient.java</span></div><h1>MicrosoftAzureStorageClient.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.transcription.microsoft.azure;

import org.apache.commons.codec.binary.Base64;
import org.apache.commons.lang3.StringUtils;
import org.apache.http.HttpStatus;
import org.apache.http.NameValuePair;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpDelete;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPut;
import org.apache.http.entity.ByteArrayEntity;
import org.apache.http.entity.ContentType;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.util.EntityUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.net.URL;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Map;
import java.util.UUID;
import java.util.stream.Collectors;

public class MicrosoftAzureStorageClient {

<span class="nc" id="L56">  private static final Logger logger = LoggerFactory.getLogger(MicrosoftAzureStorageClient.class);</span>

  private MicrosoftAzureAuthorization azureAuthorization;

<span class="nc" id="L60">  public MicrosoftAzureStorageClient(MicrosoftAzureAuthorization azureAuthorization) {</span>
<span class="nc" id="L61">    this.azureAuthorization = azureAuthorization;</span>
<span class="nc" id="L62">  }</span>

  public String getContainerUrl(String azureContainerName) {
<span class="nc" id="L65">    return String.format(&quot;https://%s.%s/%s&quot;, azureAuthorization.getAzureStorageAccountName(),</span>
        MicrosoftAzureAuthorization.AZURE_BLOB_STORE_URL_SUFFIX,
<span class="nc" id="L67">        StringUtils.trimToEmpty(azureContainerName));</span>
  }

  public boolean containerExists(String azureContainerName)
          throws MicrosoftAzureStorageClientException, IOException, MicrosoftAzureNotAllowedException {
    try {
<span class="nc" id="L73">      Map&lt;String, String&gt; containerProperties = getContainerProperties(azureContainerName);</span>
<span class="nc bnc" id="L74" title="All 4 branches missed.">      return containerProperties.containsKey(&quot;x-ms-blob-public-access&quot;) &amp;&amp; StringUtils.equalsIgnoreCase(&quot;unlocked&quot;,</span>
<span class="nc" id="L75">          containerProperties.getOrDefault(&quot;x-ms-lease-status&quot;, &quot;INVALID&quot;));</span>
<span class="nc" id="L76">    } catch (MicrosoftAzureNotFoundException ex) {</span>
<span class="nc" id="L77">      return false;</span>
    }
  }

  public Map&lt;String, String&gt; getContainerProperties(String azureContainerName)
          throws MicrosoftAzureStorageClientException, IOException, MicrosoftAzureNotAllowedException,
          MicrosoftAzureNotFoundException {
<span class="nc" id="L84">    String containerUrl = String.format(&quot;%s?%s&quot;, getContainerUrl(azureContainerName), &quot;restype=container&quot;);</span>
<span class="nc" id="L85">    String sasToken = azureAuthorization.generateAccountSASToken(&quot;r&quot;, &quot;c&quot;,</span>
        null, null, null, null);
<span class="nc" id="L87">    containerUrl = containerUrl + &quot;&amp;&quot; + sasToken;</span>

<span class="nc" id="L89">    try (CloseableHttpClient httpClient = HttpUtils.makeHttpClient()) {</span>
<span class="nc" id="L90">      HttpGet httpGet = new HttpGet(containerUrl);</span>
<span class="nc" id="L91">      try (CloseableHttpResponse response = httpClient.execute(httpGet)) {</span>
<span class="nc" id="L92">        int code = response.getStatusLine().getStatusCode();</span>
<span class="nc" id="L93">        Map&lt;String, String&gt; headersMap = Arrays.stream(response.getAllHeaders())</span>
<span class="nc" id="L94">            .collect(Collectors.toMap(NameValuePair::getName, NameValuePair::getValue));</span>
<span class="nc bnc" id="L95" title="All 4 branches missed.">        switch (code) {</span>
          case HttpStatus.SC_OK: // 200
<span class="nc" id="L97">            EntityUtils.consume(response.getEntity());</span>
<span class="nc" id="L98">            break;</span>
          case HttpStatus.SC_FORBIDDEN: // 403
<span class="nc" id="L100">            throw new MicrosoftAzureNotAllowedException(HttpUtils.formatResponseErrorString(response, String.format(</span>
                &quot;Not allowed to read Azure storage container properties for container %s.&quot;,
                azureContainerName)));
          case HttpStatus.SC_NOT_FOUND: // 404
<span class="nc" id="L104">            throw new MicrosoftAzureNotFoundException(HttpUtils.formatResponseErrorString(response, String.format(</span>
                &quot;Azure storage container %s does not exists.&quot;, azureContainerName)));
          default:
<span class="nc" id="L107">            throw new MicrosoftAzureStorageClientException(HttpUtils.formatResponseErrorString(response, String.format(</span>
                &quot;Getting Azure storage container metadata failed with HTTP response code %d for container %s.&quot;,
<span class="nc" id="L109">                code, azureContainerName)));</span>
        }
<span class="nc" id="L111">        return headersMap;</span>
      }
    }
  }

  public void createContainer(String azureContainerName)
          throws MicrosoftAzureStorageClientException, IOException, MicrosoftAzureNotAllowedException {
<span class="nc bnc" id="L118" title="All 2 branches missed.">    if (containerExists(azureContainerName)) {</span>
<span class="nc" id="L119">      return;</span>
    }
<span class="nc" id="L121">    String containerUrl = String.format(&quot;%s?%s&quot;, getContainerUrl(azureContainerName), &quot;restype=container&quot;);</span>
<span class="nc" id="L122">    String sasToken = azureAuthorization.generateAccountSASToken(&quot;w&quot;, &quot;c&quot;, null, null, null, null);</span>
<span class="nc" id="L123">    containerUrl = containerUrl + &quot;&amp;&quot; + sasToken;</span>
<span class="nc" id="L124">    try (CloseableHttpClient httpClient = HttpUtils.makeHttpClient()) {</span>
<span class="nc" id="L125">      HttpPut httpPut = new HttpPut(containerUrl);</span>
<span class="nc" id="L126">      httpPut.addHeader(&quot;x-ms-blob-public-access&quot;, &quot;blob&quot;);</span>
<span class="nc" id="L127">      try (CloseableHttpResponse response = httpClient.execute(httpPut)) {</span>
<span class="nc" id="L128">        int code = response.getStatusLine().getStatusCode();</span>
<span class="nc bnc" id="L129" title="All 3 branches missed.">        switch (code) {</span>
          case HttpStatus.SC_CREATED: // 201
<span class="nc" id="L131">            EntityUtils.consume(response.getEntity());</span>
<span class="nc" id="L132">            break;</span>
          case HttpStatus.SC_FORBIDDEN: // 403
<span class="nc" id="L134">            throw new MicrosoftAzureNotAllowedException(HttpUtils.formatResponseErrorString(response, String.format(</span>
                &quot;Not allowed to read Azure storage container properties for container %s.&quot;, azureContainerName)));

          default:
<span class="nc" id="L138">            throw new MicrosoftAzureStorageClientException(HttpUtils.formatResponseErrorString(response, String.format(</span>
<span class="nc" id="L139">                &quot;Creating Azure storage container %s failed with HTTP response code %d.&quot;, azureContainerName, code)));</span>
        }
      }
    }
<span class="nc" id="L143">  }</span>

  public String uploadFile(File trackFile, String azureContainerName, String azureBlobPath, String azureBlobName)
          throws MicrosoftAzureStorageClientException, IOException, MicrosoftAzureNotAllowedException {
<span class="nc" id="L147">    String containerUrl = getContainerUrl(azureContainerName);</span>
<span class="nc" id="L148">    String blobPath = Paths.get(StringUtils.trimToEmpty(azureBlobPath), StringUtils.trimToEmpty(azureBlobName))</span>
<span class="nc" id="L149">        .normalize().toString();</span>
<span class="nc" id="L150">    URL blobUrl = new URL(containerUrl + &quot;/&quot; + blobPath);</span>
<span class="nc" id="L151">    int blockSize = 100000000; // 100MB</span>
<span class="nc" id="L152">    String sasToken = azureAuthorization.generateServiceSasToken(&quot;w&quot;, null, null, blobUrl.getPath(), &quot;b&quot;);</span>
<span class="nc" id="L153">    try (FileInputStream trackStream = new FileInputStream(trackFile)) {</span>
<span class="nc" id="L154">      try (CloseableHttpClient httpClient = HttpUtils.makeHttpClient()) {</span>
<span class="nc" id="L155">        List&lt;String&gt; blockIds = new ArrayList&lt;&gt;();</span>
        // put blocks (file chunks)
<span class="nc bnc" id="L157" title="All 2 branches missed.">        for (int iteration = 0; iteration * blockSize &lt; trackFile.length(); iteration++) {</span>
<span class="nc" id="L158">          String blockId = Base64.encodeBase64String(UUID.randomUUID().toString().getBytes(StandardCharsets.UTF_8));</span>
<span class="nc" id="L159">          String putBlockUrl = blobUrl + &quot;?comp=block&amp;blockid=&quot;</span>
<span class="nc" id="L160">              + URLEncoder.encode(blockId, StandardCharsets.UTF_8) + &quot;&amp;&quot; + sasToken;</span>
<span class="nc" id="L161">          HttpPut httpPut = new HttpPut(putBlockUrl);</span>
<span class="nc" id="L162">          byte[] blockData = trackStream.readNBytes(blockSize);</span>
<span class="nc" id="L163">          httpPut.setEntity(new ByteArrayEntity(blockData, ContentType.APPLICATION_OCTET_STREAM));</span>
<span class="nc" id="L164">          try (CloseableHttpResponse response = httpClient.execute(httpPut)) {</span>
<span class="nc" id="L165">            int code = response.getStatusLine().getStatusCode();</span>
<span class="nc bnc" id="L166" title="All 3 branches missed.">            switch (code) {</span>
              case HttpStatus.SC_CREATED: // 201
<span class="nc" id="L168">                blockIds.add(blockId);</span>
<span class="nc" id="L169">                EntityUtils.consume(response.getEntity());</span>
<span class="nc" id="L170">                break;</span>
              case HttpStatus.SC_FORBIDDEN: // 403
<span class="nc" id="L172">                throw new MicrosoftAzureNotAllowedException(HttpUtils.formatResponseErrorString(response, String.format(</span>
                    &quot;Not allowed to put block to Azure storage container %s.&quot;, azureContainerName)));
              default:
<span class="nc" id="L175">                throw new MicrosoftAzureStorageClientException(HttpUtils.formatResponseErrorString(response,</span>
<span class="nc" id="L176">                    String.format(&quot;Putting block to Azure storage container %s failed with HTTP response code %d. &quot;,</span>
<span class="nc" id="L177">                        azureContainerName, code)));</span>
            }
          }
        }
        // commit block list
<span class="nc" id="L182">        StringBuffer blockList = new StringBuffer();</span>
<span class="nc" id="L183">        blockList.append(&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;utf-8\&quot;?&gt;&quot;);</span>
<span class="nc" id="L184">        blockList.append(&quot;&lt;BlockList&gt;&quot;);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">        for (String blockId : blockIds) {</span>
<span class="nc" id="L186">          blockList.append(&quot;&lt;Uncommitted&gt;&quot;);</span>
<span class="nc" id="L187">          blockList.append(blockId);</span>
<span class="nc" id="L188">          blockList.append(&quot;&lt;/Uncommitted&gt;&quot;);</span>
<span class="nc" id="L189">        }</span>
<span class="nc" id="L190">        blockList.append(&quot;&lt;/BlockList&gt;&quot;);</span>
<span class="nc" id="L191">        String putBlockListUrl = blobUrl + &quot;?comp=blocklist&amp;&quot; + sasToken;</span>
<span class="nc" id="L192">        HttpPut httpPut = new HttpPut(putBlockListUrl);</span>
<span class="nc" id="L193">        httpPut.setEntity(new StringEntity(blockList.toString(),</span>
<span class="nc" id="L194">            ContentType.create(&quot;application/xml&quot;, StandardCharsets.UTF_8)));</span>
<span class="nc" id="L195">        try (CloseableHttpResponse response = httpClient.execute(httpPut)) {</span>
<span class="nc" id="L196">          int code = response.getStatusLine().getStatusCode();</span>
<span class="nc bnc" id="L197" title="All 3 branches missed.">          switch (code) {</span>
            case HttpStatus.SC_CREATED: // 201
<span class="nc" id="L199">              EntityUtils.consume(response.getEntity());</span>
<span class="nc" id="L200">              break;</span>
            case HttpStatus.SC_FORBIDDEN: // 403
<span class="nc" id="L202">              throw new MicrosoftAzureNotAllowedException(HttpUtils.formatResponseErrorString(response, String.format(</span>
                  &quot;Not allowed to put block list to Azure storage container %s.&quot;, azureContainerName)));
            default:
<span class="nc" id="L205">              throw new MicrosoftAzureStorageClientException(HttpUtils.formatResponseErrorString(response,</span>
<span class="nc" id="L206">                  String.format(&quot;Putting block list to Azure storage container %s failed with HTTP response code %d.&quot;,</span>
<span class="nc" id="L207">                      azureContainerName, code)));</span>
          }
        }
      }
    }
<span class="nc" id="L212">    return blobUrl.toString();</span>
  }

  public void deleteFile(URL fileUrl)
          throws IOException, MicrosoftAzureNotAllowedException, MicrosoftAzureStorageClientException {
<span class="nc" id="L217">    String sasToken = azureAuthorization.generateServiceSasToken(&quot;dy&quot;, null, null, fileUrl.getPath(), &quot;b&quot;);</span>
<span class="nc" id="L218">    String deleteUrl = String.format(&quot;https://%s%s?%s&quot;, fileUrl.getHost(), fileUrl.getPath(), sasToken);</span>
<span class="nc" id="L219">    try (CloseableHttpClient httpClient = HttpUtils.makeHttpClient()) {</span>
<span class="nc" id="L220">      HttpDelete httpDelete = new HttpDelete(deleteUrl);</span>
<span class="nc" id="L221">      try (CloseableHttpResponse response = httpClient.execute(httpDelete)) {</span>
<span class="nc" id="L222">        int code = response.getStatusLine().getStatusCode();</span>
<span class="nc" id="L223">        String responseString = &quot;&quot;;</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">        if (response.getEntity() != null) {</span>
<span class="nc" id="L225">          responseString = EntityUtils.toString(response.getEntity());</span>
        }
<span class="nc bnc" id="L227" title="All 3 branches missed.">        switch (code) {</span>
          case HttpStatus.SC_ACCEPTED:  // 202
          case HttpStatus.SC_NOT_FOUND: // 404
<span class="nc" id="L230">            break;</span>
          case HttpStatus.SC_FORBIDDEN: // 403
<span class="nc" id="L232">            throw new MicrosoftAzureNotAllowedException(String.format(&quot;Not allowed to delete storage blob %s. &quot;</span>
<span class="nc" id="L233">                + &quot;Microsoft Azure Storage Service response: %s&quot;, httpDelete.getURI().toASCIIString(), responseString));</span>
          default:
<span class="nc" id="L235">            throw new MicrosoftAzureStorageClientException(String.format(&quot;Deleting Azure storage blob '%s' failed &quot;</span>
                    + &quot;with HTTP response code %d. Microsoft Azure Storage Service response: %s&quot;,
<span class="nc" id="L237">                httpDelete.getURI().toASCIIString(), code, responseString));</span>
        }
      }
    }
<span class="nc" id="L241">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>