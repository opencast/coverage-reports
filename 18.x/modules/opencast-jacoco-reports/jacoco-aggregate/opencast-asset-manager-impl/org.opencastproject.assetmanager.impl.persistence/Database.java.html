<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>Database.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-asset-manager-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.assetmanager.impl.persistence</a> &gt; <span class="el_source">Database.java</span></div><h1>Database.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.assetmanager.impl.persistence;

import static org.opencastproject.db.Queries.namedQuery;

import org.opencastproject.assetmanager.api.Availability;
import org.opencastproject.assetmanager.api.Property;
import org.opencastproject.assetmanager.api.PropertyId;
import org.opencastproject.assetmanager.api.Snapshot;
import org.opencastproject.assetmanager.impl.PartialMediaPackage;
import org.opencastproject.assetmanager.impl.VersionImpl;
import org.opencastproject.assetmanager.impl.persistence.AssetDtos.Full;
import org.opencastproject.assetmanager.impl.persistence.AssetDtos.Medium;
import org.opencastproject.db.DBSession;
import org.opencastproject.mediapackage.MediaPackageElement;
import org.opencastproject.util.data.Function;

import com.entwinemedia.fn.data.Opt;
import com.mysema.query.Tuple;
import com.mysema.query.jpa.EclipseLinkTemplates;
import com.mysema.query.jpa.JPQLTemplates;
import com.mysema.query.jpa.impl.JPADeleteClause;
import com.mysema.query.jpa.impl.JPAQuery;
import com.mysema.query.jpa.impl.JPAQueryFactory;
import com.mysema.query.jpa.impl.JPAUpdateClause;
import com.mysema.query.types.expr.BooleanExpression;

import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Date;
import java.util.List;
import java.util.Optional;

import javax.annotation.ParametersAreNonnullByDefault;

/**
 * Data access object.
 */
@ParametersAreNonnullByDefault
public class Database implements EntityPaths {
<span class="fc" id="L62">  private static final Logger logger = LoggerFactory.getLogger(Database.class);</span>

<span class="fc" id="L64">  public static final JPQLTemplates TEMPLATES = EclipseLinkTemplates.DEFAULT;</span>

  private final DBSession db;

<span class="fc" id="L68">  public Database(DBSession db) {</span>
<span class="fc" id="L69">    this.db = db;</span>
<span class="fc" id="L70">  }</span>

  /**
   * Run a Queryldsl query inside a persistence context/transaction.
   *
   * @param q the query function to run
   */
  public &lt;A&gt; A run(final Function&lt;JPAQueryFactory, A&gt; q) {
<span class="fc" id="L78">    return db.execTx(em -&gt; {</span>
<span class="fc" id="L79">      return q.apply(new JPAQueryFactory(TEMPLATES, () -&gt; em));</span>
    });
  }

  public void logQuery(JPAQuery q) {
<span class="fc" id="L84">    logger.debug(&quot;\n---\nQUERY\n{}\n---&quot;, q);</span>
<span class="fc" id="L85">  }</span>

  public void logDelete(String queryName, JPADeleteClause q) {
<span class="fc" id="L88">    logger.debug(&quot;\n---\nDELETE {}\n{}\n---&quot;, queryName, q);</span>
<span class="fc" id="L89">  }</span>

  /**
   * Save a property to the database. This is either an insert or an update operation.
   */
  public boolean saveProperty(final Property property) {
<span class="fc" id="L95">    return db.execTx(em -&gt; {</span>
<span class="fc" id="L96">      final PropertyId pId = property.getId();</span>
      // check the existence of both the media package and the property in one query
      //
      // either the property matches or it does not exist &lt;- left outer join
<span class="fc" id="L100">      final BooleanExpression eitherMatchOrNull =</span>
<span class="fc" id="L101">          Q_PROPERTY.namespace.eq(pId.getNamespace())</span>
<span class="fc" id="L102">              .and(Q_PROPERTY.propertyName.eq(pId.getName())).or(Q_PROPERTY.namespace.isNull());</span>
<span class="fc" id="L103">      final Tuple result = new JPAQuery(em, TEMPLATES)</span>
<span class="fc" id="L104">          .from(Q_SNAPSHOT)</span>
<span class="fc" id="L105">          .leftJoin(Q_PROPERTY).on(Q_SNAPSHOT.mediaPackageId.eq(Q_PROPERTY.mediaPackageId).and(eitherMatchOrNull))</span>
<span class="fc" id="L106">          .where(Q_SNAPSHOT.mediaPackageId.eq(pId.getMediaPackageId()))</span>
          // only one result is interesting, no need to fetch all versions of the media package
<span class="fc" id="L108">          .singleResult(Q_SNAPSHOT.id, Q_PROPERTY);</span>
<span class="fc bfc" id="L109" title="All 2 branches covered.">      if (result != null) {</span>
        // media package exists, now check if the property exists
<span class="fc" id="L111">        final PropertyDto exists = result.get(Q_PROPERTY);</span>
<span class="fc" id="L112">        namedQuery</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">            .persistOrUpdate(exists == null</span>
<span class="fc" id="L114">                ? PropertyDto.mk(property)</span>
<span class="fc" id="L115">                : exists.update(property.getValue()))</span>
<span class="fc" id="L116">            .apply(em);</span>
<span class="fc" id="L117">        return true;</span>
      } else {
        // media package does not exist
<span class="fc" id="L120">        return false;</span>
      }
    });
  }

  /**
   * Claim a new version for media package &lt;code&gt;mpId&lt;/code&gt;.
   */
  public VersionImpl claimVersion(final String mpId) {
<span class="fc" id="L129">    return db.execTx(em -&gt; {</span>
<span class="fc" id="L130">      final Optional&lt;VersionClaimDto&gt; lastOpt = VersionClaimDto.findLastQuery(mpId).apply(em);</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">      if (lastOpt.isPresent()) {</span>
<span class="fc" id="L132">        final VersionImpl claim = VersionImpl.next(lastOpt.get().getLastClaimed());</span>
<span class="fc" id="L133">        VersionClaimDto.updateQuery(mpId, claim.value()).apply(em);</span>
<span class="fc" id="L134">        return claim;</span>
      } else {
<span class="fc" id="L136">        final VersionImpl first = VersionImpl.FIRST;</span>
<span class="fc" id="L137">        em.persist(VersionClaimDto.mk(mpId, first.value()));</span>
<span class="fc" id="L138">        return first;</span>
      }
    });
  }

  /**
   * Save a snapshot and all of its assets.
   */
  public SnapshotDto saveSnapshot(
          final String orgId,
          final PartialMediaPackage pmp,
          final Date archivalDate,
          final VersionImpl version,
          final Availability availability,
          final String storageId,
          final String owner) {
<span class="fc" id="L154">    final SnapshotDto snapshotDto = SnapshotDto.mk(</span>
<span class="fc" id="L155">            pmp.getMediaPackage(),</span>
            version,
            orgId,
            archivalDate,
            availability,
            storageId,
            owner);
<span class="fc" id="L162">    return db.execTx(em -&gt; {</span>
      // persist snapshot
<span class="fc" id="L164">      em.persist(snapshotDto);</span>
      // persist assets
<span class="fc bfc" id="L166" title="All 2 branches covered.">      for (MediaPackageElement e : pmp.getElements()) {</span>
<span class="fc" id="L167">        final AssetDto a = AssetDto.mk(</span>
<span class="fc" id="L168">            e.getIdentifier(),</span>
            snapshotDto,
<span class="fc" id="L170">            e.getChecksum().toString(),</span>
<span class="fc" id="L171">            Optional.ofNullable(e.getMimeType()),</span>
            storageId,
<span class="fc" id="L173">            e.getSize());</span>
<span class="fc" id="L174">        em.persist(a);</span>
<span class="fc" id="L175">      }</span>
<span class="fc" id="L176">      return snapshotDto;</span>
    });
  }

  public void setStorageLocation(Snapshot snapshot, final String storageId) {
<span class="fc" id="L181">    setStorageLocation(</span>
<span class="fc" id="L182">        VersionImpl.mk(snapshot.getVersion()),</span>
<span class="fc" id="L183">        snapshot.getMediaPackage().getIdentifier().toString(),</span>
        storageId
    );
<span class="fc" id="L186">  }</span>

  public void setStorageLocation(final VersionImpl version, final String mpId, final String storageId) {
<span class="fc" id="L189">    db.execTx(em -&gt; {</span>
<span class="fc" id="L190">      final QSnapshotDto q = QSnapshotDto.snapshotDto;</span>
<span class="fc" id="L191">      final QAssetDto a = QAssetDto.assetDto;</span>
      // Update the snapshot
<span class="fc" id="L193">      new JPAUpdateClause(em, q, TEMPLATES)</span>
<span class="fc" id="L194">          .where(q.version.eq(version.value()).and(q.mediaPackageId.eq(mpId)))</span>
<span class="fc" id="L195">          .set(q.storageId, storageId)</span>
<span class="fc" id="L196">          .execute();</span>
      // Get the snapshot (to get its database ID)
<span class="fc" id="L198">      Optional&lt;SnapshotDtos.Medium&gt; s = getSnapshot(version, mpId);</span>
      // Update the assets
<span class="fc" id="L200">      new JPAUpdateClause(em, a, TEMPLATES)</span>
<span class="fc" id="L201">          .where(a.snapshot.id.eq(s.get().getSnapshotDto().getId()))</span>
<span class="fc" id="L202">          .set(a.storageId, storageId)</span>
<span class="fc" id="L203">          .execute();</span>
<span class="fc" id="L204">      return null;</span>
    });
<span class="fc" id="L206">  }</span>

  public void setAssetStorageLocation(final VersionImpl version, final String mpId, final String mpeId,
          final String storageId) {
<span class="fc" id="L210">    db.execTx(em -&gt; {</span>
<span class="fc" id="L211">      final QAssetDto a = QAssetDto.assetDto;</span>
<span class="fc" id="L212">      Optional&lt;SnapshotDtos.Medium&gt; s = getSnapshot(version, mpId);</span>
      // Update the asset store id
<span class="fc" id="L214">      new JPAUpdateClause(em, a, TEMPLATES)</span>
<span class="fc" id="L215">          .where(a.snapshot.id.eq(s.get().getSnapshotDto().getId()).and(a.mediaPackageElementId.eq(mpeId)))</span>
<span class="fc" id="L216">          .set(a.storageId, storageId).execute();</span>
<span class="fc" id="L217">      return null;</span>
    });
<span class="fc" id="L219">  }</span>

  public void setAvailability(final VersionImpl version, final String mpId, final Availability availability) {
<span class="fc" id="L222">    db.execTx(em -&gt; {</span>
<span class="fc" id="L223">      final QSnapshotDto q = QSnapshotDto.snapshotDto;</span>
<span class="fc" id="L224">      new JPAUpdateClause(em, q, TEMPLATES)</span>
<span class="fc" id="L225">          .where(q.version.eq(version.value()).and(q.mediaPackageId.eq(mpId)))</span>
<span class="fc" id="L226">          .set(q.availability, availability.name())</span>
<span class="fc" id="L227">          .execute();</span>
<span class="fc" id="L228">      return null;</span>
    });
<span class="fc" id="L230">  }</span>

  /**
   * Get an asset. If no version is specified return the latest version.
   *
   * @return the asset or none, if no asset can be found
   */
  public Optional&lt;AssetDtos.Medium&gt; getAsset(final VersionImpl version, final String mpId, final String mpeId) {
<span class="fc" id="L238">    return db.execTx(em -&gt; {</span>
<span class="fc" id="L239">      final QAssetDto assetDto = QAssetDto.assetDto;</span>
<span class="fc" id="L240">      final Tuple result = AssetDtos.baseJoin(em)</span>
<span class="fc" id="L241">          .where(assetDto.snapshot.mediaPackageId.eq(mpId)</span>
<span class="fc" id="L242">              .and(assetDto.mediaPackageElementId.eq(mpeId))</span>
<span class="fc" id="L243">              .and(assetDto.snapshot.version.eq(version.value())))</span>
          // if no version has been specified make sure to get the latest by ordering
<span class="fc" id="L245">          .orderBy(assetDto.snapshot.version.desc())</span>
<span class="fc" id="L246">          .uniqueResult(Medium.select);</span>
<span class="fc" id="L247">      var dtoOpt = Opt.nul(result).map(AssetDtos.Medium.fromTuple);</span>
<span class="fc bfc" id="L248" title="All 2 branches covered.">      return dtoOpt.isSome() ? Optional.of(dtoOpt.get()) : Optional.empty();</span>
    });
  }

  public Optional&lt;SnapshotDtos.Medium&gt; getSnapshot(final VersionImpl version, final String mpId) {
<span class="fc" id="L253">    return db.execTx(em -&gt; {</span>
<span class="fc" id="L254">      final QSnapshotDto snapshotDto = QSnapshotDto.snapshotDto;</span>
<span class="fc" id="L255">      final Tuple result = SnapshotDtos.baseQuery(em)</span>
<span class="fc" id="L256">          .where(snapshotDto.mediaPackageId.eq(mpId)</span>
<span class="fc" id="L257">              .and(snapshotDto.version.eq(version.value())))</span>
          // if no version has been specified make sure to get the latest by ordering
<span class="fc" id="L259">          .orderBy(snapshotDto.version.desc())</span>
<span class="fc" id="L260">          .uniqueResult(SnapshotDtos.Medium.select);</span>
<span class="fc" id="L261">      var dtoOpt = Opt.nul(result).map(SnapshotDtos.Medium.fromTuple);</span>
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">      return dtoOpt.isSome() ? Optional.of(dtoOpt.get()) : Optional.empty();</span>
    });
  }

  public Optional&lt;AssetDtos.Full&gt; findAssetByChecksum(final String checksum) {
<span class="fc" id="L267">    return db.execTx(em -&gt; {</span>
<span class="fc" id="L268">      final Tuple result = AssetDtos.baseJoin(em)</span>
<span class="fc" id="L269">          .where(QAssetDto.assetDto.checksum.eq(checksum))</span>
<span class="fc" id="L270">          .singleResult(Full.select);</span>
<span class="fc" id="L271">      var dtoOpt = Opt.nul(result).map(Full.fromTuple);</span>
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">      return dtoOpt.isSome() ? Optional.of(dtoOpt.get()) : Optional.empty();</span>
    });
  }

  /**
   * Delete all properties for a given media package identifier
   *
   * @param mediaPackageId
   *          Media package identifier
   * @return Number of deleted rows
   */
  public int deleteProperties(final String mediaPackageId) {
<span class="fc" id="L284">    return db.execTx(PropertyDto.deleteQuery(mediaPackageId));</span>
  }

  /**
   * Delete all properties for a given media package identifier and namespace.
   *
   * @param mediaPackageId
   *          Media package identifier
   * @param namespace
   *          A namespace prefix to use for deletion
   * @return Number of deleted rows
   */
  public int deleteProperties(final String mediaPackageId, final String namespace) {
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">    if (StringUtils.isBlank(namespace)) {</span>
<span class="nc" id="L298">      return db.execTx(PropertyDto.deleteQuery(mediaPackageId));</span>
    }
<span class="fc" id="L300">    return db.execTx(PropertyDto.deleteQuery(mediaPackageId, namespace));</span>
  }

  /**
   * Check if any snapshot with the given media package identifier exists.
   *
   * @param mediaPackageId
   *          The media package identifier to check for
   * @return If a snapshot exists for the given media package
   */
  public boolean snapshotExists(final String mediaPackageId) {
<span class="fc" id="L311">    return db.execTx(SnapshotDto.existsQuery(mediaPackageId));</span>
  }

  /**
   * Check if any snapshot with the given media package identifier exists.
   *
   * @param mediaPackageId
   *          The media package identifier to check for
   * @param organization
   *          The organization to filter for
   * @return If a snapshot exists for the given media package
   */
  public boolean snapshotExists(final String mediaPackageId, final String organization) {
<span class="fc" id="L324">    return db.exec(SnapshotDto.existsQuery(mediaPackageId, organization));</span>
  }

  /**
   * Select all properties for a specific media package.
   *
   * @param mediaPackageId
   *          Media package identifier to check for
   * @param namespace
   *          Namespace to limit the search to
   * @return List of properties
   */
  public List&lt;Property&gt; selectProperties(final String mediaPackageId, final String namespace) {
<span class="fc" id="L337">    return db.exec(PropertyDto.selectQuery(mediaPackageId, namespace));</span>
  }

  /**
   * Count events with snapshots in the asset manager
   *
   * @param organization
   *          An organization to count in
   * @return Number of events
   */
  public long countEvents(final String organization) {
<span class="nc" id="L348">    return db.exec(SnapshotDto.countEventsQuery(organization));</span>
  }

  public Optional&lt;AssetDtos.Full&gt; findAssetByChecksumAndStoreAndOrg(final String checksum, final String storeId,
      final String orgId) {
<span class="fc" id="L353">    return db.execTx(em -&gt; {</span>
<span class="fc" id="L354">      final Tuple result = AssetDtos.baseJoin(em)</span>
<span class="fc" id="L355">          .where(QAssetDto.assetDto.checksum.eq(checksum)</span>
<span class="fc" id="L356">              .and(QAssetDto.assetDto.storageId.eq(storeId))</span>
<span class="fc" id="L357">              .and(QAssetDto.assetDto.snapshot.organizationId.eq(orgId)))</span>
<span class="fc" id="L358">          .singleResult(Full.select);</span>
<span class="fc" id="L359">      var dtoOpt = Opt.nul(result).map(Full.fromTuple);</span>
<span class="fc bfc" id="L360" title="All 2 branches covered.">      return dtoOpt.isSome() ? Optional.of(dtoOpt.get()) : Optional.empty();</span>
    });
  }

  //
  // Utility
  //

  public static &lt;A&gt; A insidePersistenceContextCheck(A a) {
<span class="pc bpc" id="L369" title="1 of 2 branches missed.">    if (a != null) {</span>
<span class="fc" id="L370">      return a;</span>
    } else {
<span class="nc" id="L372">      throw new RuntimeException(</span>
          &quot;Used DTO outside of a persistence context or the DTO has not been assigned an ID yet.&quot;);
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>