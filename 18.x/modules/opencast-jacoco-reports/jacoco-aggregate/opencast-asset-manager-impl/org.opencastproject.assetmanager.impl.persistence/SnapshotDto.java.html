<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SnapshotDto.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-asset-manager-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.assetmanager.impl.persistence</a> &gt; <span class="el_source">SnapshotDto.java</span></div><h1>SnapshotDto.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.assetmanager.impl.persistence;

import static org.opencastproject.util.data.functions.Functions.chuck;

import org.opencastproject.assetmanager.api.Availability;
import org.opencastproject.assetmanager.api.Snapshot;
import org.opencastproject.assetmanager.impl.SnapshotImpl;
import org.opencastproject.assetmanager.impl.VersionImpl;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.mediapackage.MediaPackageElement;
import org.opencastproject.mediapackage.MediaPackageParser;

import org.eclipse.persistence.annotations.CascadeOnDelete;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Arrays;
import java.util.Date;
import java.util.Set;
import java.util.function.Function;

import javax.persistence.CascadeType;
import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.EntityManager;
import javax.persistence.FetchType;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Index;
import javax.persistence.Lob;
import javax.persistence.NamedQueries;
import javax.persistence.NamedQuery;
import javax.persistence.OneToMany;
import javax.persistence.Table;
import javax.persistence.TableGenerator;
import javax.persistence.Temporal;
import javax.persistence.TemporalType;
import javax.persistence.TypedQuery;
import javax.persistence.UniqueConstraint;

/** JPA DTO. */
@Entity(name = &quot;Snapshot&quot;)
@Table(name = &quot;oc_assets_snapshot&quot;, indexes = {
    @Index(name = &quot;IX_oc_assets_snapshot_archival_date&quot;, columnList = (&quot;archival_date&quot;)),
    @Index(name = &quot;IX_oc_assets_snapshot_mediapackage_id&quot;, columnList = (&quot;mediapackage_id&quot;)),
    @Index(name = &quot;IX_oc_assets_snapshot_organization_id&quot;, columnList = (&quot;organization_id&quot;)),
    @Index(name = &quot;IX_oc_assets_snapshot_owner&quot;, columnList = (&quot;owner&quot;)),
    @Index(name = &quot;IX_oc_assets_snapshot_series&quot;, columnList = (&quot;series_id, version&quot;))
    }, uniqueConstraints = {
    @UniqueConstraint(columnNames = {&quot;mediapackage_id&quot;, &quot;version&quot;}) })
@NamedQueries({
        @NamedQuery(name = &quot;Snapshot.countOrgEvents&quot;, query = &quot;select count(distinct s.mediaPackageId) from Snapshot s &quot;
                + &quot;where s.organizationId = :organizationId&quot;),
        @NamedQuery(name = &quot;Snapshot.countEvents&quot;, query = &quot;select count(distinct s.mediaPackageId) from Snapshot s&quot;),
        @NamedQuery(name = &quot;Snapshot.countByMediaPackage&quot;, query = &quot;select count(s) from Snapshot s &quot;
                + &quot;where s.mediaPackageId = :mediaPackageId&quot;),
        @NamedQuery(name = &quot;Snapshot.countByMediaPackageAndOrg&quot;, query = &quot;select count(s) from Snapshot s &quot;
                + &quot;where s.mediaPackageId = :mediaPackageId and s.organizationId = :organizationId&quot;)})
// Maintain own generator to support database migrations from Archive to AssetManager
// The generator's initial value has to be set after the data migration.
// Otherwise duplicate key errors will most likely happen.
@TableGenerator(name = &quot;seq_oc_assets_snapshot&quot;, initialValue = 0, allocationSize = 50)
<span class="fc" id="L84">public class SnapshotDto {</span>
<span class="fc" id="L85">  private static final Logger logger = LoggerFactory.getLogger(SnapshotDto.class);</span>

  @Id
  @Column(name = &quot;id&quot;)
  @GeneratedValue(strategy = GenerationType.TABLE, generator = &quot;seq_oc_assets_snapshot&quot;)
  private Long id;

  @Column(name = &quot;mediapackage_id&quot;, length = 128, nullable = false)
  private String mediaPackageId;

  @Column(name = &quot;version&quot;, nullable = false)
  private Long version;

  @Column(name = &quot;series_id&quot;, length = 128)
  private String seriesId;

  @Column(name = &quot;organization_id&quot;, length = 128, nullable = false)
  private String organizationId;

  @Column(name = &quot;archival_date&quot;, nullable = false)
  @Temporal(TemporalType.TIMESTAMP)
  private Date archivalDate;

  @Column(name = &quot;availability&quot;, nullable = false, length = 32)
  private String availability;

  @Column(name = &quot;storage_id&quot;, nullable = false, length = 256)
  private String storageId;

  @Column(name = &quot;owner&quot;, nullable = false, length = 256)
  private String owner;

  @Lob
  @Column(name = &quot;mediapackage_xml&quot;, length = 65535, nullable = false)
  private String mediaPackageXml;

  @CascadeOnDelete
  @OneToMany(targetEntity = AssetDto.class, fetch = FetchType.LAZY, cascade = CascadeType.ALL, mappedBy = &quot;snapshot&quot;)
  private Set&lt;AssetDto&gt; assets;

  public static SnapshotDto mk(
          MediaPackage mediaPackage,
          VersionImpl version,
          String organization,
          Date archivalDate,
          Availability availability,
          String storageId,
          String owner) {
    try {
<span class="fc" id="L134">      final SnapshotDto dto = new SnapshotDto();</span>
<span class="fc" id="L135">      dto.mediaPackageId = mediaPackage.getIdentifier().toString();</span>
<span class="fc" id="L136">      dto.version = version.value();</span>
<span class="fc" id="L137">      dto.seriesId = mediaPackage.getSeries();</span>
<span class="fc" id="L138">      dto.organizationId = organization;</span>
<span class="fc" id="L139">      dto.archivalDate = archivalDate;</span>
<span class="fc" id="L140">      dto.mediaPackageXml = MediaPackageParser.getAsXml(mediaPackage);</span>
<span class="fc" id="L141">      dto.availability = availability.name();</span>
<span class="fc" id="L142">      dto.storageId = storageId;</span>
<span class="fc" id="L143">      dto.owner = owner;</span>
<span class="fc" id="L144">      return dto;</span>
<span class="nc" id="L145">    } catch (Exception e) {</span>
<span class="nc" id="L146">      return chuck(e);</span>
    }
  }

  public static SnapshotDto mk(Snapshot snapshot) {
    try {
<span class="nc" id="L152">      return mk(snapshot.getMediaPackage(),</span>
<span class="nc" id="L153">              VersionImpl.mk(Long.parseLong(snapshot.getVersion().toString())),</span>
<span class="nc" id="L154">              snapshot.getOrganizationId(),</span>
<span class="nc" id="L155">              snapshot.getArchivalDate(),</span>
<span class="nc" id="L156">              snapshot.getAvailability(),</span>
<span class="nc" id="L157">              snapshot.getStorageId(),</span>
<span class="nc" id="L158">              snapshot.getOwner());</span>
<span class="nc" id="L159">    } catch (Exception e) {</span>
<span class="nc" id="L160">      return chuck(e);</span>
    }
  }

  public Long getId() {
<span class="fc" id="L165">    return Database.insidePersistenceContextCheck(id);</span>
  }

  public VersionImpl getVersion() {
<span class="nc" id="L169">    return Conversions.toVersion(version);</span>
  }

  public String getMediaPackageId() {
<span class="fc" id="L173">    return mediaPackageId;</span>
  }

  public String getStorageId() {
<span class="nc" id="L177">    return storageId;</span>
  }

  void setAvailability(Availability a) {
<span class="nc" id="L181">    this.availability = a.name();</span>
<span class="nc" id="L182">  }</span>

  void setStorageId(String id) {
<span class="nc" id="L185">    this.storageId = id;</span>
<span class="nc" id="L186">  }</span>

  public boolean addAsset(AssetDto asset) {
<span class="nc" id="L189">    return this.assets.add(asset);</span>
  }

  public boolean removeAsset(AssetDto asset) {
<span class="nc" id="L193">    return this.assets.remove(asset);</span>
  }

  public Snapshot toSnapshot() {
<span class="fc" id="L197">    MediaPackage mediaPackage = Conversions.toMediaPackage(mediaPackageXml);</span>
    // ensure elements are tagged `archive`
<span class="fc bfc" id="L199" title="All 2 branches covered.">    for (MediaPackageElement element: mediaPackage.getElements()) {</span>
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">      if (!Arrays.asList(element.getTags()).contains(&quot;archive&quot;)) {</span>
<span class="fc" id="L201">        logger.debug(&quot;Adding additional tag `archive` to element {} retrieved from asset manager&quot;, element);</span>
<span class="fc" id="L202">        element.addTag(&quot;archive&quot;);</span>
      }
    }
<span class="fc" id="L205">    return new SnapshotImpl(</span>
            id,
<span class="fc" id="L207">            Conversions.toVersion(version),</span>
            organizationId,
            archivalDate,
<span class="fc" id="L210">            Availability.valueOf(availability),</span>
            storageId,
            owner,
            mediaPackage);
  }

  /**
   * Check if any snapshot with the given media package exists.
   *
   * @param mediaPackageId
   *          The media package identifier to check for
   * @return If a snapshot exists for the given media package
   */
  public static Function&lt;EntityManager, Boolean&gt; existsQuery(final String mediaPackageId) {
<span class="fc" id="L224">    return existsQuery(mediaPackageId, null);</span>
  }

  /**
   * Check if any snapshot with the given media package exists.
   *
   * @param mediaPackageId
   *          The media package identifier to check for
   * @param organization
   *          An organization to limit the check for
   * @return If a snapshot exists for the given media package
   */
  public static Function&lt;EntityManager, Boolean&gt; existsQuery(final String mediaPackageId, final String organization) {
<span class="fc" id="L237">    return em -&gt; {</span>
      TypedQuery&lt;Long&gt; query;
<span class="fc bfc" id="L239" title="All 2 branches covered.">      if (organization == null) {</span>
<span class="fc" id="L240">        query = em.createNamedQuery(&quot;Snapshot.countByMediaPackage&quot;, Long.class)</span>
<span class="fc" id="L241">            .setParameter(&quot;mediaPackageId&quot;, mediaPackageId);</span>
      } else {
<span class="fc" id="L243">        query = em.createNamedQuery(&quot;Snapshot.countByMediaPackageAndOrg&quot;, Long.class)</span>
<span class="fc" id="L244">            .setParameter(&quot;mediaPackageId&quot;, mediaPackageId)</span>
<span class="fc" id="L245">            .setParameter(&quot;organizationId&quot;, organization);</span>
      }
<span class="fc" id="L247">      logger.debug(&quot;Executing query {}&quot;, query);</span>
<span class="fc bfc" id="L248" title="All 2 branches covered.">      return query.getSingleResult() &gt; 0;</span>
    };
  }

  /**
   * Count events with snapshots in the asset manager
   *
   * @param organization
   *          An organization to count in
   * @return Number of events
   */
  public static Function&lt;EntityManager, Long&gt; countEventsQuery(final String organization) {
<span class="nc" id="L260">    return em -&gt; {</span>
      TypedQuery&lt;Long&gt; query;
<span class="nc bnc" id="L262" title="All 2 branches missed.">      if (null != organization) {</span>
<span class="nc" id="L263">        query = em.createNamedQuery(&quot;Snapshot.countOrgEvents&quot;, Long.class)</span>
<span class="nc" id="L264">            .setParameter(&quot;organizationId&quot;, organization);</span>
      } else {
<span class="nc" id="L266">        query = em.createNamedQuery(&quot;Snapshot.countEvents&quot;, Long.class);</span>
      }
<span class="nc" id="L268">      logger.debug(&quot;Executing query {}&quot;, query);</span>
<span class="nc" id="L269">      return query.getSingleResult();</span>
    };
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>