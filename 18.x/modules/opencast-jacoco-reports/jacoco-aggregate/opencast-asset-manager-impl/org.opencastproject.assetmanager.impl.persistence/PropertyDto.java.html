<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>PropertyDto.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-asset-manager-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.assetmanager.impl.persistence</a> &gt; <span class="el_source">PropertyDto.java</span></div><h1>PropertyDto.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.assetmanager.impl.persistence;

import org.opencastproject.assetmanager.api.Property;
import org.opencastproject.assetmanager.api.PropertyId;
import org.opencastproject.assetmanager.api.Value;
import org.opencastproject.assetmanager.api.Version;
import org.opencastproject.assetmanager.impl.RuntimeTypes;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Date;
import java.util.List;
import java.util.function.Function;
import java.util.stream.Collectors;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.EntityManager;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;
import javax.persistence.Index;
import javax.persistence.NamedQueries;
import javax.persistence.NamedQuery;
import javax.persistence.Table;
import javax.persistence.Temporal;
import javax.persistence.TemporalType;
import javax.persistence.TypedQuery;

@Entity(name = &quot;Property&quot;)
@Table(name = &quot;oc_assets_properties&quot;, indexes = {
    @Index(name = &quot;IX_oc_assets_properties_val_date&quot;, columnList = (&quot;val_date&quot;)),
    @Index(name = &quot;IX_oc_assets_properties_val_long&quot;, columnList = (&quot;val_long&quot;)),
    @Index(name = &quot;IX_oc_assets_properties_val_string&quot;, columnList = (&quot;val_string&quot;)),
    @Index(name = &quot;IX_oc_assets_properties_val_bool&quot;, columnList = (&quot;val_bool&quot;)),
    @Index(name = &quot;IX_oc_assets_properties_mediapackage_id&quot;, columnList = (&quot;mediapackage_id&quot;)),
    @Index(name = &quot;IX_oc_assets_properties_namespace&quot;, columnList = (&quot;namespace&quot;)),
    @Index(name = &quot;IX_oc_assets_properties_property_name&quot;, columnList = (&quot;property_name&quot;)) })
@NamedQueries({
    @NamedQuery(name = &quot;Property.selectByMediaPackageAndNamespace&quot;, query = &quot;select p from Property p where &quot;
            + &quot;p.mediaPackageId = :mediaPackageId and p.namespace = :namespace&quot;),
    @NamedQuery(name = &quot;Property.delete&quot;, query = &quot;delete from Property p where p.mediaPackageId = :mediaPackageId&quot;),
    @NamedQuery(name = &quot;Property.deleteByNamespace&quot;, query = &quot;delete from Property p &quot;
            + &quot;where p.mediaPackageId = :mediaPackageId and p.namespace = :namespace&quot;)})
<span class="fc" id="L65">public class PropertyDto {</span>
<span class="fc" id="L66">  private static final Logger logger = LoggerFactory.getLogger(PropertyDto.class);</span>

  /** Surrogate key. */
  @Id
  @GeneratedValue
  @Column(name = &quot;id&quot;)
  private Long id;

  /** Part 1 of the business key. */
  @Column(name = &quot;mediapackage_id&quot;, nullable = false, length = 128)
  private String mediaPackageId;

  /** Part 2 of the business key. */
  @Column(name = &quot;namespace&quot;, nullable = false, length = 128)
  private String namespace;

  /** Part 3 of the business key. */
  @Column(name = &quot;property_name&quot;, nullable = false, length = 128)
  private String propertyName;

  @Column(name = &quot;val_string&quot;, nullable = true)
  private String stringValue;

  @Column(name = &quot;val_date&quot;, nullable = true)
  @Temporal(TemporalType.TIMESTAMP)
  private Date dateValue;

  @Column(name = &quot;val_long&quot;, nullable = true)
  private Long longValue;

  @Column(name = &quot;val_bool&quot;, nullable = true)
  private Boolean boolValue;

  public static PropertyDto mk(Property property) {
<span class="fc" id="L100">    final PropertyDto dto = new PropertyDto();</span>
<span class="fc" id="L101">    dto.mediaPackageId = property.getId().getMediaPackageId();</span>
<span class="fc" id="L102">    dto.namespace = property.getId().getNamespace();</span>
<span class="fc" id="L103">    dto.propertyName = property.getId().getName();</span>
<span class="fc" id="L104">    setValue(dto, property.getValue());</span>
<span class="fc" id="L105">    return dto;</span>
  }

  public Property toProperty() {
<span class="fc" id="L109">    final PropertyId id = new PropertyId(mediaPackageId, namespace, propertyName);</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">    if (stringValue != null) {</span>
<span class="fc" id="L111">      return new Property(id, Value.mk(stringValue));</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">    } else if (dateValue != null) {</span>
<span class="fc" id="L113">      return new Property(id, Value.mk(dateValue));</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">    } else if (longValue != null) {</span>
<span class="fc" id="L115">      return new Property(id, Value.mk(longValue));</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">    } else if (boolValue != null) {</span>
<span class="fc" id="L117">      return new Property(id, Value.mk(boolValue));</span>
    } else {
<span class="nc" id="L119">      throw new RuntimeException(&quot;Bug. At least one of the value columns must be non null.&quot;);</span>
    }
  }

  public PropertyDto update(Value value) {
<span class="fc" id="L124">    final PropertyDto dto = new PropertyDto();</span>
<span class="fc" id="L125">    dto.id = id;</span>
<span class="fc" id="L126">    dto.mediaPackageId = mediaPackageId;</span>
<span class="fc" id="L127">    dto.namespace = namespace;</span>
<span class="fc" id="L128">    dto.propertyName = propertyName;</span>
<span class="fc" id="L129">    setValue(dto, value);</span>
<span class="fc" id="L130">    return dto;</span>
  }

  private static void setValue(final PropertyDto dto, final Value value) {
<span class="fc" id="L134">    value.decompose(</span>
<span class="fc" id="L135">        new Function&lt;String, Void&gt;() {</span>
          @Override public Void apply(String a) {
<span class="fc" id="L137">            dto.stringValue = a;</span>
<span class="fc" id="L138">            return null;</span>
          }
        },
<span class="fc" id="L141">        new Function&lt;Date, Void&gt;() {</span>
          @Override public Void apply(Date a) {
<span class="fc" id="L143">            dto.dateValue = a;</span>
<span class="fc" id="L144">            return null;</span>
          }
        },
<span class="fc" id="L147">        new Function&lt;Long, Void&gt;() {</span>
          @Override public Void apply(Long a) {
<span class="fc" id="L149">            dto.longValue = a;</span>
<span class="fc" id="L150">            return null;</span>
          }
        },
<span class="fc" id="L153">        new Function&lt;Boolean, Void&gt;() {</span>
          @Override public Void apply(Boolean a) {
<span class="fc" id="L155">            dto.boolValue = a;</span>
<span class="fc" id="L156">            return null;</span>
          }
        },
<span class="fc" id="L159">        new Function&lt;Version, Void&gt;() {</span>
          @Override public Void apply(Version a) {
<span class="fc" id="L161">            dto.longValue = RuntimeTypes.convert(a).value();</span>
<span class="fc" id="L162">            return null;</span>
          }
        });
<span class="fc" id="L165">  }</span>

  public static Function&lt;EntityManager, Integer&gt; deleteQuery(final String mediaPackageId) {
<span class="fc" id="L168">    return deleteQuery(mediaPackageId, null);</span>
  }

  public static Function&lt;EntityManager, Integer&gt; deleteQuery(final String mediaPackageId, final String namespace) {
<span class="fc" id="L172">    return em -&gt; {</span>
      TypedQuery&lt;PropertyDto&gt; query;
<span class="fc bfc" id="L174" title="All 2 branches covered.">      if (namespace == null) {</span>
<span class="fc" id="L175">        query = em.createNamedQuery(&quot;Property.delete&quot;, PropertyDto.class)</span>
<span class="fc" id="L176">            .setParameter(&quot;mediaPackageId&quot;, mediaPackageId);</span>
      } else {
<span class="fc" id="L178">        query = em.createNamedQuery(&quot;Property.deleteByNamespace&quot;, PropertyDto.class)</span>
<span class="fc" id="L179">            .setParameter(&quot;mediaPackageId&quot;, mediaPackageId)</span>
<span class="fc" id="L180">            .setParameter(&quot;namespace&quot;, namespace);</span>
      }
<span class="fc" id="L182">      logger.debug(&quot;Executing query {}&quot;, query);</span>
<span class="fc" id="L183">      return query.executeUpdate();</span>
    };
  }

  public static Function&lt;EntityManager, List&lt;Property&gt;&gt; selectQuery(final String mediaPackageId,
      final String namespace) {
<span class="fc" id="L189">    return em -&gt; {</span>
<span class="fc" id="L190">      TypedQuery&lt;PropertyDto&gt; query = em.createNamedQuery(&quot;Property.selectByMediaPackageAndNamespace&quot;,</span>
              PropertyDto.class)
<span class="fc" id="L192">          .setParameter(&quot;mediaPackageId&quot;, mediaPackageId)</span>
<span class="fc" id="L193">          .setParameter(&quot;namespace&quot;, namespace);</span>
<span class="fc" id="L194">      logger.debug(&quot;Executing query {}&quot;, query);</span>
<span class="fc" id="L195">      return query.getResultList().parallelStream().map(PropertyDto::toProperty).collect(Collectors.toList());</span>
    };
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>