<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AbstractTieredStorageAssetManagerRestEndpoint.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-asset-manager-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.assetmanager.impl.endpoint</a> &gt; <span class="el_source">AbstractTieredStorageAssetManagerRestEndpoint.java</span></div><h1>AbstractTieredStorageAssetManagerRestEndpoint.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.assetmanager.impl.endpoint;

import static javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;
import static javax.servlet.http.HttpServletResponse.SC_INTERNAL_SERVER_ERROR;
import static javax.servlet.http.HttpServletResponse.SC_OK;
import static org.opencastproject.util.RestUtil.R.badRequest;
import static org.opencastproject.util.RestUtil.R.ok;

import org.opencastproject.assetmanager.impl.AssetManagerJobProducer;
import org.opencastproject.assetmanager.impl.VersionImpl;
import org.opencastproject.job.api.JaxbJob;
import org.opencastproject.job.api.Job;
import org.opencastproject.job.api.JobProducer;
import org.opencastproject.serviceregistry.api.ServiceRegistry;
import org.opencastproject.util.doc.rest.RestParameter;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestResponse;

import org.apache.commons.lang3.StringUtils;

import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;

import javax.ws.rs.FormParam;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;

<span class="nc" id="L53">public abstract class AbstractTieredStorageAssetManagerRestEndpoint extends AbstractAssetManagerRestEndpoint {</span>
  public static final String SDF_FORMAT = &quot;yyyy-MM-dd'T'HH:mm:ss'Z'&quot;;

<span class="nc" id="L56">  protected AssetManagerJobProducer tsamjp = null;</span>
<span class="nc" id="L57">  protected ServiceRegistry serviceRegistry = null;</span>

  public void setJobProducer(AssetManagerJobProducer producer) {
<span class="nc" id="L60">    tsamjp = producer;</span>
<span class="nc" id="L61">  }</span>

  @Override
  public JobProducer getService() {
<span class="nc" id="L65">    return this.tsamjp;</span>
  }

  /**
   * Callback from the OSGi declarative services to set the service registry.
   *
   * @param serviceRegistry
   *          the service registry
   */
  protected void setServiceRegistry(ServiceRegistry serviceRegistry) {
<span class="nc" id="L75">    this.serviceRegistry = serviceRegistry;</span>
<span class="nc" id="L76">  }</span>

  @Override
  public ServiceRegistry getServiceRegistry() {
<span class="nc" id="L80">    return this.serviceRegistry;</span>
  }

  @POST
  @Path(&quot;moveById&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(name = &quot;moveById&quot;, description = &quot;Move a mediapackage based on its ID.&quot;,
      restParameters = {
          @RestParameter(
              name = &quot;id&quot;,
              isRequired = true,
              type = RestParameter.Type.STRING,
              defaultValue = &quot;&quot;,
              description = &quot;The mediapackage ID to move.&quot;),
          @RestParameter(
              name = &quot;target&quot;,
              isRequired = true,
              type = RestParameter.Type.STRING,
              defaultValue = &quot;&quot;,
              description = &quot;The target storage to move the mediapackage to.&quot;)},
      responses = {
          @RestResponse(
              description = &quot;The job created to move the snapshot.&quot;,
              responseCode = SC_OK),
          @RestResponse(
              description = &quot;Invalid parameters, and the job was not created&quot;,
              responseCode = SC_BAD_REQUEST),
          @RestResponse(
              description = &quot;There has been an internal error, and the job was not created&quot;,
              responseCode = SC_INTERNAL_SERVER_ERROR)},
      returnDescription = &quot;The Job created&quot;)
  public Response moveById(@FormParam(&quot;id&quot;) final String id, @FormParam(&quot;target&quot;) final String target) {
<span class="nc" id="L112">    String mpid = StringUtils.trimToNull(id);</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">    if (null == mpid) {</span>
<span class="nc" id="L114">      return badRequest(&quot;Invalid mediapackage ID: &quot; + mpid);</span>
    }

<span class="nc" id="L117">    final String trimmedTarget = StringUtils.trimToNull(target);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">    if (null == trimmedTarget) {</span>
<span class="nc" id="L119">      return badRequest(&quot;Invalid target store ID: &quot; + trimmedTarget);</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">    } else if (!tsamjp.datastoreExists(trimmedTarget)) {</span>
<span class="nc" id="L121">      return badRequest(&quot;Target store &quot; + trimmedTarget + &quot; not found&quot;);</span>
    }

    try {
<span class="nc" id="L125">      Job j = tsamjp.moveById(mpid, trimmedTarget);</span>
<span class="nc" id="L126">      return Response.ok(new JaxbJob(j)).build();</span>
<span class="nc" id="L127">    } catch (Exception e) {</span>
<span class="nc" id="L128">      return handleException(e);</span>
    }
  }

  @POST
  @Path(&quot;moveByIdAndVersion&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(name = &quot;moveByIdAndVersion&quot;, description = &quot;Move a mediapackage based on its ID and version.&quot;,
      restParameters = {
          @RestParameter(
              name = &quot;id&quot;,
              isRequired = true,
              type = RestParameter.Type.STRING,
              defaultValue = &quot;&quot;,
              description = &quot;The mediapackage ID to move.&quot;),
          @RestParameter(
              name = &quot;version&quot;,
              isRequired = true,
              type = RestParameter.Type.STRING,
              defaultValue = &quot;&quot;,
              description = &quot;The version to move.&quot;),
          @RestParameter(
              name = &quot;target&quot;,
              isRequired = true,
              type = RestParameter.Type.STRING,
              defaultValue = &quot;&quot;,
              description = &quot;The target storage to move the mediapackage to.&quot;)},
      responses = {
          @RestResponse(
              description = &quot;The job created to move the snapshot.&quot;,
              responseCode = SC_OK),
          @RestResponse(
              description = &quot;Invalid parameters, and the job was not created&quot;,
              responseCode = SC_BAD_REQUEST),
          @RestResponse(
              description = &quot;There has been an internal error, and the job was not created&quot;,
              responseCode = SC_INTERNAL_SERVER_ERROR)},
      returnDescription = &quot;The Job created&quot;)
  public Response moveByIdAndVersion(
      @FormParam(&quot;id&quot;) final String id,
      @FormParam(&quot;version&quot;) final String version,
      @FormParam(&quot;target&quot;) final String target
  ) {
<span class="nc" id="L171">    final String mpid = StringUtils.trimToNull(id);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">    if (null == mpid) {</span>
<span class="nc" id="L173">      return badRequest(&quot;Invalid mediapackage ID: &quot; + mpid);</span>
    }

    final VersionImpl v;
    try {
<span class="nc" id="L178">      Long versionNumber = Long.parseLong(version);</span>
<span class="nc" id="L179">      v = new VersionImpl(versionNumber);</span>
<span class="nc" id="L180">    } catch (NumberFormatException e) {</span>
<span class="nc" id="L181">      return badRequest(&quot;Invalid version number format&quot;);</span>
<span class="nc" id="L182">    }</span>

<span class="nc" id="L184">    final String trimmedTarget = StringUtils.trimToNull(target);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">    if (null == trimmedTarget) {</span>
<span class="nc" id="L186">      return badRequest(&quot;Invalid target store ID: &quot; + trimmedTarget);</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">    } else if (!tsamjp.datastoreExists(trimmedTarget)) {</span>
<span class="nc" id="L188">      return badRequest(&quot;Target store &quot; + trimmedTarget + &quot; not found&quot;);</span>
    }

    try {
<span class="nc" id="L192">      Job j = tsamjp.moveByIdAndVersion(v, mpid, trimmedTarget);</span>
<span class="nc" id="L193">      return ok(new JaxbJob(j));</span>
<span class="nc" id="L194">    } catch (Exception e) {</span>
<span class="nc" id="L195">      return handleException(e);</span>
    }
  }

  @POST
  @Path(&quot;moveByDate&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(name = &quot;moveByDate&quot;, description = &quot;Move all snapshots between two dates.&quot;,
      restParameters = {
          @RestParameter(
              name = &quot;start&quot;,
              isRequired = true,
              type = RestParameter.Type.STRING,
              defaultValue = &quot;&quot;,
              description = &quot;The start date, in the format yyyy-MM-dd'T'HH:mm:ss'Z'.&quot;),
          @RestParameter(
              name = &quot;end&quot;,
              isRequired = true,
              type = RestParameter.Type.STRING,
              defaultValue = &quot;&quot;,
              description = &quot;The end date, in the format yyyy-MM-dd'T'HH:mm:ss'Z'.&quot;),
          @RestParameter(
              name = &quot;target&quot;,
              isRequired = true,
              type = RestParameter.Type.STRING,
              defaultValue = &quot;&quot;,
              description = &quot;The target storage to move the mediapackage to.&quot;)},
      responses = {
          @RestResponse(
              description = &quot;The job created to move the snapshots.&quot;,
              responseCode = SC_OK),
          @RestResponse(
              description = &quot;Invalid parameters, and the job was not created&quot;,
              responseCode = SC_BAD_REQUEST),
          @RestResponse(
              description = &quot;There has been an internal error, and the job was not created&quot;,
              responseCode = SC_INTERNAL_SERVER_ERROR)},
      returnDescription = &quot;The Job created&quot;)
  public Response moveByDate(
      @FormParam(&quot;start&quot;) final String startString,
      @FormParam(&quot;end&quot;) final String endString,
      @FormParam(&quot;target&quot;) final String target
  ) {
<span class="nc" id="L238">    DateFormat sdf = new SimpleDateFormat(SDF_FORMAT);</span>
    Date start;
    Date end;
    try {
<span class="nc" id="L242">      start = sdf.parse(startString);</span>
<span class="nc" id="L243">      end = sdf.parse(endString);</span>
<span class="nc" id="L244">    } catch (ParseException e) {</span>
<span class="nc" id="L245">      return badRequest(&quot;Invalid start or end date format&quot;);</span>
<span class="nc" id="L246">    }</span>

<span class="nc bnc" id="L248" title="All 2 branches missed.">    if (end.before(start)) {</span>
<span class="nc" id="L249">      return badRequest(&quot;Start date &quot; + start + &quot; must be before end date &quot; + end);</span>
    }

<span class="nc" id="L252">    final String trimmedTarget = StringUtils.trimToNull(target);</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">    if (null == trimmedTarget) {</span>
<span class="nc" id="L254">      return badRequest(&quot;Invalid target store ID: &quot; + trimmedTarget);</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">    } else if (!tsamjp.datastoreExists(trimmedTarget)) {</span>
<span class="nc" id="L256">      return badRequest(&quot;Target store &quot; + trimmedTarget + &quot; not found&quot;);</span>
    }

    try {
<span class="nc" id="L260">      Job j = tsamjp.moveByDate(start, end, trimmedTarget);</span>
<span class="nc" id="L261">      return ok(new JaxbJob(j));</span>
<span class="nc" id="L262">    } catch (Exception e) {</span>
<span class="nc" id="L263">      return handleException(e);</span>
    }
  }

  @POST
  @Path(&quot;moveByIdAndDate&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(
      name = &quot;moveByIdAndDate&quot;,
      description = &quot;Move all snapshots for a given mediapackage taken between two dates.&quot;,
      restParameters = {
          @RestParameter(
              name = &quot;id&quot;,
              isRequired = true,
              type = RestParameter.Type.STRING,
              defaultValue = &quot;&quot;,
              description = &quot;The mediapackage ID to move.&quot;),
          @RestParameter(
              name = &quot;start&quot;,
              isRequired = true,
              type = RestParameter.Type.STRING,
              defaultValue = &quot;&quot;,
              description = &quot;The start date, in the format yyyy-MM-dd'T'HH:mm:ss'Z'.&quot;),
          @RestParameter(
              name = &quot;end&quot;,
              isRequired = true,
              type = RestParameter.Type.STRING,
              defaultValue = &quot;&quot;,
              description = &quot;The end date, in the format yyyy-MM-dd'T'HH:mm:ss'Z'.&quot;),
          @RestParameter(
              name = &quot;target&quot;,
              isRequired = true,
              type = RestParameter.Type.STRING,
              defaultValue = &quot;&quot;,
              description = &quot;The target storage to move the mediapackage to.&quot;)},
      responses = {
          @RestResponse(
              description = &quot;The job created to move the snapshots.&quot;,
              responseCode = SC_OK),
          @RestResponse(
              description = &quot;Invalid parameters, and the job was not created&quot;,
              responseCode = SC_BAD_REQUEST),
          @RestResponse(
              description = &quot;There has been an internal error, and the job was not created&quot;,
              responseCode = SC_INTERNAL_SERVER_ERROR)},
      returnDescription = &quot;The Job created&quot;)
  public Response moveByIdAndDate(
      @FormParam(&quot;id&quot;) final String id,
      @FormParam(&quot;start&quot;) final String startString,
      @FormParam(&quot;end&quot;) final String endString,
      @FormParam(&quot;target&quot;) final String target
  ) {
<span class="nc" id="L315">    DateFormat sdf = new SimpleDateFormat(SDF_FORMAT);</span>
<span class="nc" id="L316">    final String mpid = StringUtils.trimToNull(id);</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">    if (null == mpid) {</span>
<span class="nc" id="L318">      return badRequest(&quot;Invalid mediapackage ID: &quot; + mpid);</span>
    }

    Date start;
    Date end;
    try {
<span class="nc" id="L324">      start = sdf.parse(startString);</span>
<span class="nc" id="L325">      end = sdf.parse(endString);</span>
<span class="nc" id="L326">    } catch (ParseException e) {</span>
<span class="nc" id="L327">      return badRequest(&quot;Invalid start or end date format&quot;);</span>
<span class="nc" id="L328">    }</span>

<span class="nc bnc" id="L330" title="All 2 branches missed.">    if (end.before(start)) {</span>
<span class="nc" id="L331">      return badRequest(&quot;Start date &quot; + start + &quot; must be before end date &quot; + end);</span>
    }

<span class="nc" id="L334">    final String trimmedTarget = StringUtils.trimToNull(target);</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">    if (null == trimmedTarget) {</span>
<span class="nc" id="L336">      return badRequest(&quot;Invalid target store ID: &quot; + trimmedTarget);</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">    } else if (!tsamjp.datastoreExists(trimmedTarget)) {</span>
<span class="nc" id="L338">      return badRequest(&quot;Target store &quot; + trimmedTarget + &quot; not found&quot;);</span>
    }

    try {
<span class="nc" id="L342">      Job j = tsamjp.moveByIdAndDate(mpid, start, end, trimmedTarget);</span>
<span class="nc" id="L343">      return ok(new JaxbJob(j));</span>
<span class="nc" id="L344">    } catch (Exception e) {</span>
<span class="nc" id="L345">      return handleException(e);</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>