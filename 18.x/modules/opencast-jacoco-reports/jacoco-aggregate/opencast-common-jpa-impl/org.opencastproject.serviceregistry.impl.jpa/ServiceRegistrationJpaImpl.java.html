<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ServiceRegistrationJpaImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-common-jpa-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.serviceregistry.impl.jpa</a> &gt; <span class="el_source">ServiceRegistrationJpaImpl.java</span></div><h1>ServiceRegistrationJpaImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.serviceregistry.impl.jpa;

import org.opencastproject.serviceregistry.api.ServiceRegistration;
import org.opencastproject.serviceregistry.api.ServiceState;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Date;

import javax.persistence.Access;
import javax.persistence.AccessType;
import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;
import javax.persistence.Index;
import javax.persistence.JoinColumn;
import javax.persistence.ManyToOne;
import javax.persistence.NamedQueries;
import javax.persistence.NamedQuery;
import javax.persistence.PostLoad;
import javax.persistence.Table;
import javax.persistence.Temporal;
import javax.persistence.TemporalType;
import javax.persistence.Transient;
import javax.persistence.UniqueConstraint;

/**
 * A record of a service that creates and manages receipts.
 */
@Entity(name = &quot;ServiceRegistration&quot;)
@Access(AccessType.FIELD)
@Table(
    name = &quot;oc_service_registration&quot;,
    indexes = {
        @Index(name = &quot;IX_oc_service_registration_service_type&quot;, columnList = (&quot;service_type&quot;)),
        @Index(name = &quot;IX_oc_service_registration_service_state&quot;, columnList = (&quot;service_state&quot;)),
        @Index(name = &quot;IX_oc_service_registration_active&quot;, columnList = (&quot;active&quot;)),
        @Index(name = &quot;IX_oc_service_registration_host_registration&quot;, columnList = (&quot;host_registration&quot;)),
    },
    uniqueConstraints = @UniqueConstraint(
        name = &quot;UNQ_oc_service_registration&quot;,
        columnNames = { &quot;host_registration&quot;, &quot;service_type&quot; }
    )
)
@NamedQueries({
    @NamedQuery(
        name = &quot;ServiceRegistration.statistics&quot;,
        query = &quot;SELECT job.processorServiceRegistrationFK as serviceRegistration, job.status, &quot;
            + &quot;count(job.status) as numJobs, &quot;
            + &quot;avg(job.queueTime) as meanQueue, &quot;
            + &quot;avg(job.runTime) as meanRun FROM Job job &quot;
            + &quot;where job.dateCreated &gt;= :minDateCreated and job.dateCreated &lt;= :maxDateCreated &quot;
            + &quot;group by job.processorServiceRegistrationFK, job.status&quot;
    ),
    @NamedQuery(
        name = &quot;ServiceRegistration.hostloads&quot;,
        query = &quot;SELECT job.processorServiceRegistration.hostRegistration.baseUrl as host, &quot;
            + &quot;job.status, sum(job.jobLoad), job.processorServiceRegistration.hostRegistration.maxLoad &quot;
            + &quot;FROM Job job &quot;
            + &quot;WHERE job.processorServiceRegistration.online=true &quot;
            + &quot;and job.processorServiceRegistration.active=true &quot;
            + &quot;and job.processorServiceRegistration.hostRegistration.maintenanceMode=false &quot;
            + &quot;AND job.status in :statuses &quot;
            + &quot;AND job.creatorServiceRegistration.serviceType != :workflow_type &quot;
            + &quot;GROUP BY job.processorServiceRegistration.hostRegistration.baseUrl, &quot;
            + &quot;job.status, job.processorServiceRegistration.hostRegistration.maxLoad&quot;
    ),
    @NamedQuery(
        name = &quot;ServiceRegistration.getRegistration&quot;,
        query = &quot;SELECT r from ServiceRegistration r &quot;
            + &quot;where r.hostRegistration.baseUrl = :host and r.serviceType = :serviceType&quot;
    ),
    @NamedQuery(
        name = &quot;ServiceRegistration.getAll&quot;,
        query = &quot;SELECT rh FROM ServiceRegistration rh WHERE rh.hostRegistration.active = true&quot;
    ),
    @NamedQuery(
        name = &quot;ServiceRegistration.getAllOnline&quot;,
        query = &quot;SELECT rh FROM ServiceRegistration rh &quot;
            + &quot;WHERE rh.hostRegistration.online=true AND rh.hostRegistration.active = true&quot;
    ),
    @NamedQuery(
        name = &quot;ServiceRegistration.getByHost&quot;,
        query = &quot;SELECT rh FROM ServiceRegistration rh &quot;
        + &quot;where rh.hostRegistration.baseUrl=:host AND rh.hostRegistration.active = true&quot;
    ),
    @NamedQuery(
        name = &quot;ServiceRegistration.getByType&quot;,
        query = &quot;SELECT rh FROM ServiceRegistration rh &quot;
        + &quot;where rh.serviceType=:serviceType AND rh.hostRegistration.active = true&quot;
    ),
    @NamedQuery(
        name = &quot;ServiceRegistration.relatedservices.warning_error&quot;,
        query = &quot;SELECT rh FROM ServiceRegistration rh &quot;
        + &quot;WHERE rh.serviceType = :serviceType AND (rh.serviceState = 1 OR rh.serviceState = 2)&quot;
    ),
    @NamedQuery(
        name = &quot;ServiceRegistration.relatedservices.warning&quot;,
        query = &quot;SELECT rh FROM ServiceRegistration rh &quot;
        + &quot;WHERE rh.serviceType = :serviceType AND rh.serviceState = 1&quot;
    ),
})
public class ServiceRegistrationJpaImpl implements ServiceRegistration {

  /** The logger */
<span class="fc" id="L129">  private static final Logger logger = LoggerFactory.getLogger(ServiceRegistrationJpaImpl.class);</span>

  @Id
  @Column(name = &quot;id&quot;)
  @GeneratedValue
  private Long id;

<span class="pc" id="L136">  @Column(name = &quot;online_from&quot;)</span>
  @Temporal(TemporalType.TIMESTAMP)
  private Date onlineFrom = new Date();

  @Column(name = &quot;service_type&quot;, nullable = false, length = 255)
  private String serviceType;

  @ManyToOne
  @JoinColumn(name = &quot;host_registration&quot;)
  private HostRegistrationJpaImpl hostRegistration;

  @Column(name = &quot;path&quot;, nullable = false, length = 255)
  private String path;

<span class="pc" id="L150">  @Column(name = &quot;service_state&quot;, nullable = false)</span>
<span class="pc" id="L151">  private int serviceState = ServiceState.NORMAL.ordinal();</span>

<span class="pc" id="L153">  @Column(name = &quot;state_changed&quot;)</span>
  @Temporal(TemporalType.TIMESTAMP)
  private Date stateChanged = new Date();

  @Column(name = &quot;warning_state_trigger&quot;)
  private int warningStateTrigger;

  @Column(name = &quot;error_state_trigger&quot;)
  private int errorStateTrigger;

<span class="pc" id="L163">  @Column(name = &quot;active&quot;, nullable = false)</span>
  private boolean active = true;

<span class="pc" id="L166">  @Column(name = &quot;online&quot;, nullable = false)</span>
  private boolean online = true;

  @Column(name = &quot;job_producer&quot;, nullable = false)
  private boolean isJobProducer;

<span class="pc" id="L172">  @Transient</span>
  private boolean maintenanceMode = false;

  @Transient
  private String host;

  /**
   * Creates a new service registration which is online
   */
<span class="fc" id="L181">  public ServiceRegistrationJpaImpl() {</span>
<span class="fc" id="L182">  }</span>

  /**
   * Creates a new service registration which is online
   *
   * @param hostRegistration
   *          the host registration
   * @param serviceType
   *          the type of job this service handles
   * @param path
   *          the URL path on this host to the service endpoint
   */
<span class="nc" id="L194">  public ServiceRegistrationJpaImpl(HostRegistrationJpaImpl hostRegistration, String serviceType, String path) {</span>
<span class="nc" id="L195">    this.hostRegistration = hostRegistration;</span>
<span class="nc" id="L196">    this.serviceType = serviceType;</span>
<span class="nc" id="L197">    this.path = path;</span>
<span class="nc" id="L198">  }</span>

  /**
   * Creates a new service registration which is online and not in maintenance mode.
   *
   * @param hostRegistration
   *          the host registration
   * @param serviceType
   *          the type of job this service handles
   * @param path
   *          the URL path on this host to the service endpoint
   * @param jobProducer
   */
  public ServiceRegistrationJpaImpl(HostRegistrationJpaImpl hostRegistration, String serviceType, String path,
<span class="fc" id="L212">          boolean jobProducer) {</span>
<span class="fc" id="L213">    this.hostRegistration = hostRegistration;</span>
<span class="fc" id="L214">    this.host = hostRegistration.getBaseUrl();</span>
<span class="fc" id="L215">    this.serviceType = serviceType;</span>
<span class="fc" id="L216">    this.path = path;</span>
<span class="fc" id="L217">    this.isJobProducer = jobProducer;</span>
<span class="fc" id="L218">  }</span>

  /**
   * Gets the primary key for this service registration.
   *
   * @return the primary key
   */
  public Long getId() {
<span class="fc" id="L226">    return id;</span>
  }

  /**
   * Sets the primary key identifier.
   *
   * @param id
   *          the identifier
   */
  public void setId(Long id) {
<span class="nc" id="L236">    this.id = id;</span>
<span class="nc" id="L237">  }</span>

  @Override
  public Date getOnlineFrom() {
<span class="fc" id="L241">    return onlineFrom;</span>
  }

  public void setOnlineFrom(Date onlineFrom) {
<span class="fc" id="L245">    this.onlineFrom = onlineFrom;</span>
<span class="fc" id="L246">  }</span>

  @Override
  public String getServiceType() {
<span class="fc" id="L250">    return serviceType;</span>
  }

  @Override
  public String getPath() {
<span class="fc" id="L255">    return path;</span>
  }

  public void setPath(String path) {
<span class="fc" id="L259">    this.path = path;</span>
<span class="fc" id="L260">  }</span>

  @Override
  public ServiceState getServiceState() {
<span class="fc" id="L264">    return ServiceState.values()[serviceState];</span>
  }

  public void setServiceState(ServiceState serviceState) {
<span class="fc" id="L268">    this.serviceState = serviceState.ordinal();</span>
<span class="fc" id="L269">  }</span>

  public void setServiceState(ServiceState state, int triggerJobSignature) {
<span class="fc" id="L272">    setServiceState(state);</span>
<span class="fc" id="L273">    setStateChanged(new Date());</span>
<span class="fc bfc" id="L274" title="All 2 branches covered.">    if (state == ServiceState.WARNING) {</span>
<span class="fc" id="L275">      setWarningStateTrigger(triggerJobSignature);</span>
<span class="fc bfc" id="L276" title="All 2 branches covered.">    } else if (state == ServiceState.ERROR) {</span>
<span class="fc" id="L277">      setErrorStateTrigger(triggerJobSignature);</span>
    }
<span class="fc" id="L279">  }</span>

  @Override
  public Date getStateChanged() {
<span class="fc" id="L283">    return stateChanged;</span>
  }

  public void setStateChanged(Date stateChanged) {
<span class="fc" id="L287">    this.stateChanged = stateChanged;</span>
<span class="fc" id="L288">  }</span>

  @Override
  public int getWarningStateTrigger() {
<span class="fc" id="L292">    return warningStateTrigger;</span>
  }

  public void setWarningStateTrigger(int warningStateTrigger) {
<span class="fc" id="L296">    this.warningStateTrigger = warningStateTrigger;</span>
<span class="fc" id="L297">  }</span>

  @Override
  public int getErrorStateTrigger() {
<span class="fc" id="L301">    return errorStateTrigger;</span>
  }

  public void setErrorStateTrigger(int errorStateTrigger) {
<span class="fc" id="L305">    this.errorStateTrigger = errorStateTrigger;</span>
<span class="fc" id="L306">  }</span>

  @Override
  public boolean isActive() {
<span class="fc" id="L310">    return active;</span>
  }

  public void setActive(boolean isActive) {
<span class="nc" id="L314">    this.active = isActive;</span>
<span class="nc" id="L315">  }</span>

  @Override
  public boolean isOnline() {
<span class="fc" id="L319">    return online;</span>
  }

  public void setOnline(boolean online) {
<span class="pc bpc" id="L323" title="1 of 4 branches missed.">    if (online &amp;&amp; !isOnline()) {</span>
<span class="fc" id="L324">      setOnlineFrom(new Date());</span>
    }
<span class="fc" id="L326">    this.online = online;</span>
<span class="fc" id="L327">  }</span>

  @Override
  public boolean isJobProducer() {
<span class="fc" id="L331">    return isJobProducer;</span>
  }

  public void setJobProducer(boolean isJobProducer) {
<span class="fc" id="L335">    this.isJobProducer = isJobProducer;</span>
<span class="fc" id="L336">  }</span>

  @Override
  public boolean isInMaintenanceMode() {
<span class="fc" id="L340">    return maintenanceMode;</span>
  }

  @Override
  public String getHost() {
<span class="fc" id="L345">    return host;</span>
  }

  /**
   * Gets the associated {@link HostRegistrationJpaImpl}
   *
   * @return the host registration
   */
  public HostRegistrationJpaImpl getHostRegistration() {
<span class="fc" id="L354">    return hostRegistration;</span>
  }

  /**
   * @param hostRegistration
   *          the hostRegistration to set
   */
  public void setHostRegistration(HostRegistrationJpaImpl hostRegistration) {
<span class="nc" id="L362">    this.hostRegistration = hostRegistration;</span>
<span class="nc" id="L363">  }</span>

  @PostLoad
  public void postLoad() {
<span class="pc bpc" id="L367" title="1 of 2 branches missed.">    if (hostRegistration == null) {</span>
<span class="nc" id="L368">      logger.warn(&quot;host registration is null&quot;);</span>
    } else {
<span class="fc" id="L370">      host = hostRegistration.getBaseUrl();</span>
<span class="fc" id="L371">      maintenanceMode = hostRegistration.isMaintenanceMode();</span>
<span class="fc bfc" id="L372" title="All 2 branches covered.">      if (!hostRegistration.isOnline()) {</span>
<span class="fc" id="L373">        online = false;</span>
      }
<span class="pc bpc" id="L375" title="1 of 2 branches missed.">      if (!hostRegistration.isActive()) {</span>
<span class="nc" id="L376">        active = false;</span>
      }
    }
<span class="fc" id="L379">  }</span>

  @Override
  public int hashCode() {
<span class="nc" id="L383">    return toString().hashCode();</span>
  }

  @Override
  public boolean equals(Object obj) {
<span class="pc bpc" id="L388" title="1 of 2 branches missed.">    if (!(obj instanceof ServiceRegistration)) {</span>
<span class="nc" id="L389">      return false;</span>
    }
<span class="fc" id="L391">    ServiceRegistration registration = (ServiceRegistration) obj;</span>
<span class="pc bpc" id="L392" title="1 of 4 branches missed.">    return getHost().equals(registration.getHost()) &amp;&amp; getServiceType().equals(registration.getServiceType());</span>
  }

  @Override
  public String toString() {
<span class="fc" id="L397">    return getServiceType() + &quot;@&quot; + getHost();</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>