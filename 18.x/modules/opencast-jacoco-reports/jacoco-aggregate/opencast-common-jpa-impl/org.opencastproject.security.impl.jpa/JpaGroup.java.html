<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>JpaGroup.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-common-jpa-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.security.impl.jpa</a> &gt; <span class="el_source">JpaGroup.java</span></div><h1>JpaGroup.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.security.impl.jpa;

import org.opencastproject.security.api.Group;
import org.opencastproject.security.api.Role;
import org.opencastproject.util.EqualsUtil;

import java.util.HashSet;
import java.util.Set;
import java.util.stream.Collectors;

import javax.persistence.Access;
import javax.persistence.AccessType;
import javax.persistence.CascadeType;
import javax.persistence.CollectionTable;
import javax.persistence.Column;
import javax.persistence.ElementCollection;
import javax.persistence.Entity;
import javax.persistence.FetchType;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;
import javax.persistence.JoinColumn;
import javax.persistence.JoinTable;
import javax.persistence.ManyToMany;
import javax.persistence.NamedQueries;
import javax.persistence.NamedQuery;
import javax.persistence.OneToOne;
import javax.persistence.Table;
import javax.persistence.UniqueConstraint;

/**
 * JPA-annotated group object.
 */
@Entity
@Access(AccessType.FIELD)
@Table(
    name = &quot;oc_group&quot;,
    uniqueConstraints = { @UniqueConstraint(columnNames = { &quot;group_id&quot;, &quot;organization&quot; }) }
)
@NamedQueries({
    @NamedQuery(
        name = &quot;Group.findAll&quot;,
        query = &quot;Select g FROM JpaGroup g WHERE g.organization.id = :organization&quot;
    ),
    @NamedQuery(
        name = &quot;Group.findByUser&quot;,
        query = &quot;Select g FROM JpaGroup g WHERE g.organization.id = :organization AND :username MEMBER OF g.members&quot;
    ),
    @NamedQuery(
        name = &quot;Group.findById&quot;,
        query = &quot;Select g FROM JpaGroup g WHERE g.groupId = :groupId AND g.organization.id = :organization&quot;
    ),
    @NamedQuery(
        name = &quot;Group.findByRole&quot;,
        query = &quot;Select g FROM JpaGroup g WHERE g.role = :role AND g.organization.id = :organization&quot;
    ),
})
public final class JpaGroup implements Group {
  @Id
  @GeneratedValue
  @Column(name = &quot;id&quot;)
  private Long id;

  @Column(name = &quot;group_id&quot;, length = 128)
  private String groupId;

  @Column(name = &quot;name&quot;, length = 128)
  private String name;

  @OneToOne()
  @JoinColumn(name = &quot;organization&quot;)
  private JpaOrganization organization;

  @Column(name = &quot;description&quot;)
  private String description;

  @Column(name = &quot;role&quot;)
  private String role;

  @ElementCollection
  @CollectionTable(name = &quot;oc_group_member&quot;, joinColumns = {
      @JoinColumn(name = &quot;group_id&quot;, nullable = false) })
  @Column(name = &quot;member&quot;)
  private Set&lt;String&gt; members;

  @ManyToMany(cascade = { CascadeType.MERGE }, fetch = FetchType.LAZY)
  @JoinTable(name = &quot;oc_group_role&quot;, joinColumns = {
      @JoinColumn(name = &quot;group_id&quot;)
      }, inverseJoinColumns = {
      @JoinColumn(name = &quot;role_id&quot;)
      }, uniqueConstraints = {
      @UniqueConstraint(name = &quot;UNQ_oc_group_role&quot;, columnNames = { &quot;group_id&quot;, &quot;role_id&quot; }) })
  private Set&lt;JpaRole&gt; roles;

  /**
   * No-arg constructor needed by JPA
   */
<span class="fc" id="L118">  public JpaGroup() {</span>
<span class="fc" id="L119">  }</span>

  /**
   * Constructs a group with the specified groupId, name, description and group role.
   *
   * @param groupId
   *          the group id
   * @param organization
   *          the organization
   * @param name
   *          the name
   * @param description
   *          the description
   * @throws IllegalArgumentException
   *           if group id or name is longer than 128 Bytes
   */
  public JpaGroup(String groupId, JpaOrganization organization, String name, String description)
          throws IllegalArgumentException {
<span class="fc" id="L137">    super();</span>
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">    if (groupId.length() &gt; 128) {</span>
<span class="nc" id="L139">      throw new IllegalArgumentException(&quot;Group id must not be longer than 128 Bytes&quot;);</span>
    }
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">    if (name.length() &gt; 128) {</span>
<span class="nc" id="L142">      throw new IllegalArgumentException(&quot;Name must not be longer than 128 Bytes&quot;);</span>
    }
<span class="fc" id="L144">    this.groupId = groupId;</span>
<span class="fc" id="L145">    this.organization = organization;</span>
<span class="fc" id="L146">    this.name = name;</span>
<span class="fc" id="L147">    this.description = description;</span>
<span class="fc" id="L148">    this.role = ROLE_PREFIX + groupId.toUpperCase();</span>
<span class="fc" id="L149">    this.roles = new HashSet&lt;JpaRole&gt;();</span>
<span class="fc" id="L150">  }</span>

  /**
   * Constructs a group with the specified groupId, name, description, group role and roles.
   *
   * @param groupId
   *          the group id
   * @param organization
   *          the organization
   * @param name
   *          the name
   * @param description
   *          the description
   * @param roles
   *          the additional group roles
   * @throws IllegalArgumentException
   *           if group id or name is longer than 128 Bytes
   */
  public JpaGroup(String groupId, JpaOrganization organization, String name, String description, Set&lt;JpaRole&gt; roles)
          throws IllegalArgumentException {
<span class="fc" id="L170">    this(groupId, organization, name, description);</span>
<span class="fc" id="L171">    this.roles = roles;</span>
<span class="fc" id="L172">  }</span>

  /**
   * Constructs a group with the specified groupId, name, description, group role and roles.
   *
   * @param groupId
   *          the group id
   * @param organization
   *          the organization
   * @param name
   *          the name
   * @param description
   *          the description
   * @param roles
   *          the additional group roles
   * @param members
   *          the group members
   * @throws IllegalArgumentException
   *           if group id or name is longer than 128 Bytes
   */
  public JpaGroup(String groupId, JpaOrganization organization, String name, String description, Set&lt;JpaRole&gt; roles,
          Set&lt;String&gt; members) throws IllegalArgumentException {
<span class="fc" id="L194">    this(groupId, organization, name, description, roles);</span>
<span class="fc" id="L195">    this.members = members;</span>
<span class="fc" id="L196">  }</span>

  /**
   * @see org.opencastproject.security.api.Group#getGroupId()
   */
  @Override
  public String getGroupId() {
<span class="fc" id="L203">    return groupId;</span>
  }

  /**
   * @see org.opencastproject.security.api.Group#getName()
   */
  @Override
  public String getName() {
<span class="fc" id="L211">    return name;</span>
  }

  /**
   * Sets the group name
   *
   * @param name
   *          the name
   */
  public void setName(String name) {
<span class="fc" id="L221">    this.name = name;</span>
<span class="fc" id="L222">  }</span>

  /**
   * @see org.opencastproject.security.api.Group#getOrganization()
   */
  @Override
  public JpaOrganization getOrganization() {
<span class="fc" id="L229">    return organization;</span>
  }

  /**
   * @see org.opencastproject.security.api.Group#getDescription()
   */
  @Override
  public String getDescription() {
<span class="fc" id="L237">    return description;</span>
  }

  /**
   * Sets the description
   *
   * @param description
   *          the description
   */
  public void setDescription(String description) {
<span class="fc" id="L247">    this.description = description;</span>
<span class="fc" id="L248">  }</span>

  @Override
  public String getRole() {
<span class="fc" id="L252">    return role;</span>
  }

  @Override
  public Set&lt;String&gt; getMembers() {
<span class="fc" id="L257">    return members;</span>
  }

  /**
   * Sets the members
   *
   * @param members
   *          the members
   */
  public void setMembers(Set&lt;String&gt; members) {
<span class="fc" id="L267">    this.members = members;</span>
<span class="fc" id="L268">  }</span>

  /**
   * Add a member
   *
   * @param member
   *          The member's name.
   */
  public void addMember(String member) {
<span class="nc bnc" id="L277" title="All 2 branches missed.">    if (members == null) {</span>
<span class="nc" id="L278">      members = new HashSet&lt;&gt;();</span>
    }
<span class="nc" id="L280">    members.add(member);</span>
<span class="nc" id="L281">  }</span>

  /**
   * Remove a member
   *
   * @param member
   *          The member's name.
   */
  public void removeMember(String member) {
<span class="nc bnc" id="L290" title="All 2 branches missed.">    if (members != null) {</span>
<span class="nc" id="L291">      members.remove(member);</span>
    }
<span class="nc" id="L293">  }</span>

  @Override
  public Set&lt;Role&gt; getRoles() {
<span class="fc" id="L297">    return new HashSet&lt;Role&gt;(roles);</span>
  }

  /**
   * Get only the names of the roles
   *
   * @return the role names in a set
   */
  public Set&lt;String&gt; getRoleNames() {
<span class="nc" id="L306">    return roles.stream().map(role -&gt; role.getName()).collect(Collectors.toSet());</span>
  }

  /**
   * Sets the roles
   *
   * @param roles
   *          the roles
   */
  public void setRoles(Set&lt;JpaRole&gt; roles) {
<span class="fc" id="L316">    this.roles = roles;</span>
<span class="fc" id="L317">  }</span>

  @Override
  public int hashCode() {
<span class="nc" id="L321">    return EqualsUtil.hash(id, organization);</span>
  }

  @Override
  public boolean equals(Object obj) {
<span class="nc bnc" id="L326" title="All 2 branches missed.">    if (!(obj instanceof Group)) {</span>
<span class="nc" id="L327">      return false;</span>
    }
<span class="nc" id="L329">    Group other = (Group) obj;</span>
<span class="nc bnc" id="L330" title="All 4 branches missed.">    return groupId.equals(other.getGroupId()) &amp;&amp; organization.equals(other.getOrganization());</span>
  }

  @Override
  public String toString() {
<span class="nc" id="L335">    return new StringBuilder(groupId).append(&quot;:&quot;).append(organization).toString();</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>