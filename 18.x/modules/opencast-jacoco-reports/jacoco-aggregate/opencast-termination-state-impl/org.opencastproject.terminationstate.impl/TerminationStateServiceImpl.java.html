<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>TerminationStateServiceImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-termination-state-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.terminationstate.impl</a> &gt; <span class="el_source">TerminationStateServiceImpl.java</span></div><h1>TerminationStateServiceImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.terminationstate.impl;

import org.opencastproject.serviceregistry.api.ServiceRegistry;
import org.opencastproject.serviceregistry.api.ServiceRegistryException;
import org.opencastproject.terminationstate.api.AbstractJobTerminationStateService;
import org.opencastproject.terminationstate.api.TerminationStateService;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.OsgiUtil;

import org.osgi.service.cm.ConfigurationException;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Deactivate;
import org.osgi.service.component.annotations.Reference;
import org.quartz.Job;
import org.quartz.JobDetail;
import org.quartz.JobExecutionContext;
import org.quartz.JobExecutionException;
import org.quartz.Scheduler;
import org.quartz.SchedulerException;
import org.quartz.Trigger;
import org.quartz.TriggerUtils;
import org.quartz.impl.StdSchedulerFactory;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Dictionary;

@Component(
    immediate = true,
    service = TerminationStateService.class,
    property = {
        &quot;service.description=Termination State Service&quot;,
        &quot;service.pid=org.opencastproject.terminationstate.impl.TerminationStateService&quot;,
        &quot;vendor.name=opencast&quot;,
        &quot;vendor.service=basic&quot;
    }
)
<span class="fc" id="L60">public final class TerminationStateServiceImpl extends AbstractJobTerminationStateService {</span>
<span class="fc" id="L61">  private static final Logger logger = LoggerFactory.getLogger(TerminationStateServiceImpl.class);</span>

  public static final String CONFIG_JOB_POLLING_PERIOD = &quot;job.polling.period&quot;;
  private static final int DEFAULT_JOB_POLLING_PERIOD = 300; // secs

<span class="fc" id="L66">  protected static final String SCHEDULE_GROUP = AbstractJobTerminationStateService.class.getSimpleName();</span>
  private static final String SCHEDULE_JOB_POLLING = &quot;JobPolling&quot;;
  protected static final String SCHEDULE_JOB_POLLING_TRIGGER = &quot;TriggerJobPolling&quot;;
  private static final String SCHEDULE_JOB_PARAM_PARENT = &quot;parent&quot;;

  private Scheduler scheduler;

<span class="fc" id="L73">  private int jobPollingPeriod = DEFAULT_JOB_POLLING_PERIOD;</span>


  @Activate
  protected void activate(ComponentContext componentContext) {
    try {
<span class="nc" id="L79">      configure(componentContext.getProperties());</span>
<span class="nc" id="L80">    } catch (ConfigurationException e) {</span>
<span class="nc" id="L81">      logger.error(&quot;Unable to read configuration, using defaults&quot;, e);</span>
<span class="nc" id="L82">    }</span>

    try {
<span class="nc" id="L85">      scheduler = new StdSchedulerFactory().getScheduler();</span>
<span class="nc" id="L86">    } catch (SchedulerException e) {</span>
<span class="nc" id="L87">      logger.error(&quot;Cannot create quartz scheduler&quot;, e);</span>
<span class="nc" id="L88">    }</span>
<span class="nc" id="L89">  }</span>


  protected void configure(Dictionary config) throws ConfigurationException {
<span class="fc" id="L93">    this.jobPollingPeriod = OsgiUtil.getOptCfgAsInt(config, CONFIG_JOB_POLLING_PERIOD)</span>
<span class="fc" id="L94">        .getOrElse(DEFAULT_JOB_POLLING_PERIOD);</span>
<span class="fc" id="L95">  }</span>

  @Override
  public void setState(TerminationState state) {
<span class="fc" id="L99">    super.setState(state);</span>

<span class="pc bpc" id="L101" title="1 of 2 branches missed.">    if (getState() != TerminationState.NONE) {</span>
      // stop accepting new jobs, maintenance mode
      try {
<span class="fc" id="L104">        String host = getServiceRegistry().getRegistryHostname();</span>
<span class="fc" id="L105">        getServiceRegistry().setMaintenanceStatus(host, true);</span>
<span class="nc" id="L106">      } catch (ServiceRegistryException | NotFoundException e) {</span>
<span class="nc" id="L107">        logger.error(&quot;Cannot put this host into maintenance&quot;, e);</span>
<span class="fc" id="L108">      }</span>
<span class="fc" id="L109">      startJobPolling();</span>
    } else {
      // termination terminated? unset maintenance
      try {
<span class="nc" id="L113">        String host = getServiceRegistry().getRegistryHostname();</span>
<span class="nc" id="L114">        getServiceRegistry().setMaintenanceStatus(host, false);</span>
<span class="nc" id="L115">      } catch (ServiceRegistryException | NotFoundException e) {</span>
<span class="nc" id="L116">        logger.error(&quot;Cannot take this host out of maintenance&quot;, e);</span>
<span class="nc" id="L117">      }</span>
    }
<span class="fc" id="L119">  }</span>

  protected void startJobPolling() {
    try {
      // create and set the job. To actually run it call schedule(..)
<span class="fc" id="L124">      final JobDetail job = new JobDetail(SCHEDULE_GROUP, SCHEDULE_JOB_POLLING, CheckTerminationState.class);</span>
<span class="fc" id="L125">      job.getJobDataMap().put(SCHEDULE_JOB_PARAM_PARENT, this);</span>
<span class="fc" id="L126">      final Trigger trigger = TriggerUtils.makeSecondlyTrigger(jobPollingPeriod);</span>
<span class="fc" id="L127">      trigger.setGroup(SCHEDULE_GROUP);</span>
<span class="fc" id="L128">      trigger.setName(SCHEDULE_JOB_POLLING_TRIGGER);</span>
<span class="fc" id="L129">      scheduler.scheduleJob(job, trigger);</span>
<span class="fc" id="L130">      scheduler.start();</span>
<span class="fc" id="L131">      logger.info(&quot;Started polling if jobs are complete&quot;);</span>
<span class="nc" id="L132">    } catch (org.quartz.SchedulerException e) {</span>
<span class="nc" id="L133">      throw new RuntimeException(e);</span>
<span class="fc" id="L134">    }</span>
<span class="fc" id="L135">  }</span>

  protected void stopJobPolling() {
    try {
<span class="fc" id="L139">      scheduler.deleteJob(SCHEDULE_GROUP, SCHEDULE_JOB_POLLING);</span>
<span class="nc" id="L140">    } catch (SchedulerException e) {</span>
      // ignore
<span class="fc" id="L142">    }</span>
<span class="fc" id="L143">  }</span>

<span class="fc" id="L145">  public static class CheckTerminationState implements Job {</span>

    @Override
    public void execute(JobExecutionContext context) throws JobExecutionException {
<span class="fc" id="L149">      TerminationStateServiceImpl parent</span>
<span class="fc" id="L150">          = (TerminationStateServiceImpl) context.getJobDetail().getJobDataMap().get(SCHEDULE_JOB_PARAM_PARENT);</span>

<span class="fc bfc" id="L152" title="All 2 branches covered.">      if (parent.readyToTerminate()) {</span>
<span class="fc" id="L153">        logger.info(&quot;No jobs running, sent complete Lifecycle action&quot;);</span>
<span class="fc" id="L154">        parent.stopJobPolling();</span>
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">      } else if (parent.getState() == TerminationState.WAIT) {</span>
<span class="fc" id="L156">        logger.info(&quot;Jobs still running&quot;);</span>
      }
<span class="fc" id="L158">    }</span>
  }

  /**
   * Stop scheduled jobs and free resources
   */
  private void stop() {
    try {
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">      if (scheduler != null) {</span>
<span class="fc" id="L167">        this.scheduler.shutdown();</span>
      }
<span class="nc" id="L169">    } catch (SchedulerException e) {</span>
<span class="nc" id="L170">      logger.error(&quot;Failed to stop scheduler&quot;, e);</span>
<span class="fc" id="L171">    }</span>
<span class="fc" id="L172">  }</span>

  /**
   * OSGI deactivate callback
   */
  @Deactivate
  public void deactivate() {
<span class="fc" id="L179">    stop();</span>
<span class="fc" id="L180">  }</span>

  /** Methods below are used by test class */

  protected void setScheduler(Scheduler scheduler) {
<span class="fc" id="L185">    this.scheduler = scheduler;</span>
<span class="fc" id="L186">  }</span>

  @Reference
  @Override
  public void setServiceRegistry(ServiceRegistry serviceRegistry) {
<span class="fc" id="L191">    super.setServiceRegistry(serviceRegistry);</span>
<span class="fc" id="L192">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>