<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>WowzaResourceStrategyImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-urlsigning-service-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.security.urlsigning</a> &gt; <span class="el_source">WowzaResourceStrategyImpl.java</span></div><h1>WowzaResourceStrategyImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.security.urlsigning;

import org.opencastproject.urlsigning.common.ResourceStrategy;

import org.apache.commons.lang3.StringUtils;

import java.net.URI;
import java.net.URISyntaxException;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * A {@link ResourceStrategy} that transforms URLs for a Wowza streaming server. Based upon:
 * http://www.wowza.com/forums/content.php?55-How-to-format-Adobe-Flash-RTMP-URLs and http://docs.aws.amazon.com/
 * AmazonCloudFront/latest/DeveloperGuide/private-content-creating-signed-url-custom-policy.html
 */
<span class="fc" id="L37">public class WowzaResourceStrategyImpl implements ResourceStrategy {</span>
  /** Regex pattern that matches something like mp4:path/to/resource/video */
  private static final String FIND_STREAM_FORMAT = &quot;.{3}[:].*$&quot;;
  /** The URI scheme that an RTMP address uses. */
  private static final String RTMP_SCHEME = &quot;rtmp&quot;;
  /** The URI scheme that an http address uses. */
  private static final String ADAPTIVESTREAMING_HTTP_SCHEME = &quot;http&quot;;
  /** The URI scheme that an https address uses. */
  private static final String ADAPTIVESTREAMING_HTTPS_SCHEME = &quot;https&quot;;
  /** The possible delimiter between the server &amp; application and the stream path and file. */
  private static final String WOWZA_STREAM_DELIMITER = &quot;_definst_&quot;;

  /**
   * Transform a base URI into a proper stream location without the host and application name.
   *
   * @param baseUri
   *          The full URI to the resource including the host and application.
   * @return A safe standard RTMP or HTTP resource location.
   */
  @Override
  public String getResource(String baseUri) {
    try {
<span class="fc" id="L59">      URI uri = new URI(baseUri);</span>
<span class="fc" id="L60">      String scheme = uri.getScheme();</span>

<span class="pc bpc" id="L62" title="1 of 2 branches missed.">      if (ADAPTIVESTREAMING_HTTP_SCHEME.equals(scheme)</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">          || ADAPTIVESTREAMING_HTTPS_SCHEME.equals(scheme)) {</span>
<span class="fc" id="L64">        return getHTTPResource(uri);</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">      } else if (RTMP_SCHEME.equals(scheme)) {</span>
<span class="nc" id="L66">        return getRTMPResource(uri);</span>
      } else {
        //return getHTTPResource(uri);
<span class="nc" id="L69">        throw new IllegalArgumentException(WowzaResourceStrategyImpl.class.getSimpleName()</span>
                + &quot; is unable to sign urls with scheme &quot; + scheme);
      }
<span class="nc" id="L72">    } catch (URISyntaxException e) {</span>
<span class="nc" id="L73">      throw new IllegalStateException(e);</span>
    }
  }

  /**
   * Transform a base URI into a proper stream location without the host and application name.
   *
   * @param baseUri
   *          The full URI to the resource including the host and application.
   * @return A safe standard RTMP resource location.
   */
  protected static String getRTMPResource(URI baseUri) {
<span class="fc" id="L85">    String stream = null;</span>
<span class="fc bfc" id="L86" title="All 2 branches covered.">    if (baseUri.toString().contains(WOWZA_STREAM_DELIMITER)) {</span>
      // There is the explicit delimiter so return the stream as the resource.
<span class="fc" id="L88">      stream = baseUri.toString().split(WOWZA_STREAM_DELIMITER)[1];</span>
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">      if (stream.charAt(0) == '/') {</span>
<span class="fc" id="L90">        return stream.substring(1);</span>
      }
<span class="nc" id="L92">      return stream;</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">    } else if (baseUri.getPath().contains(&quot;:&quot;)) {</span>
      // The path contains a &quot;:&quot; denoting the type e.g. mp4 which is always the start of the stream path.
<span class="fc" id="L95">      Pattern pattern = Pattern.compile(FIND_STREAM_FORMAT);</span>
<span class="fc" id="L96">      Matcher matcher = pattern.matcher(baseUri.getPath());</span>
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">      if (matcher.find()) {</span>
<span class="fc" id="L98">        return baseUri.getPath().substring(matcher.start())</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">                + (StringUtils.isNotBlank(baseUri.getQuery()) ? &quot;?&quot; + baseUri.getQuery() : &quot;&quot;);</span>
      }
    }
    // There are no special delimiters so assume the first value between two forward slashes (/.../) is the application.
<span class="fc" id="L103">    return baseUri.getPath().substring(baseUri.getPath().indexOf(&quot;/&quot;, 1) + 1)</span>
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">            + (StringUtils.isNotBlank(baseUri.getQuery()) ? &quot;?&quot; + baseUri.getQuery() : &quot;&quot;);</span>
  }
  /**
   * Transform a base URI into a proper stream location without the host.
   *
   * @param baseUri
   *          The full URI to the resource including the host and application.
   * @return A safe standard RTMP resource location.
   */
  protected static String getHTTPResource(URI baseUri) {
    // There are no special delimiters so assume the first value between two forward slashes (/.../) is the application.
<span class="fc" id="L115">    return baseUri.getPath().substring(baseUri.getPath().indexOf(&quot;/&quot;) + 1, baseUri.getPath().lastIndexOf(&quot;/&quot;));</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>