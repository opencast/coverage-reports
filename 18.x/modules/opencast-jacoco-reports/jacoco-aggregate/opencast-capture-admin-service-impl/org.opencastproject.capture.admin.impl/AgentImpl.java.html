<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AgentImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-capture-admin-service-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.capture.admin.impl</a> &gt; <span class="el_source">AgentImpl.java</span></div><h1>AgentImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.capture.admin.impl;

import org.opencastproject.capture.CaptureParameters;
import org.opencastproject.capture.admin.api.Agent;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.io.StringReader;
import java.io.StringWriter;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Properties;
import java.util.Set;

import javax.persistence.CollectionTable;
import javax.persistence.Column;
import javax.persistence.ElementCollection;
import javax.persistence.Entity;
import javax.persistence.Id;
import javax.persistence.IdClass;
import javax.persistence.Index;
import javax.persistence.JoinColumn;
import javax.persistence.Lob;
import javax.persistence.NamedQueries;
import javax.persistence.NamedQuery;
import javax.persistence.PostLoad;
import javax.persistence.Table;
import javax.persistence.Transient;
import javax.persistence.UniqueConstraint;

/**
 * An in-memory construct to represent the state of a capture agent, and when it was last heard from.
 */
@Entity @IdClass(AgentImplId.class)
@Table(name = &quot;oc_capture_agent_state&quot;)
@NamedQueries({
  @NamedQuery(name = &quot;Agent.get&quot;, query = &quot;select a from AgentImpl a where a.name = :id and a.organization = :org&quot;),
  @NamedQuery(name = &quot;Agent.byOrganization&quot;, query = &quot;SELECT a FROM AgentImpl a where a.organization = :org&quot;)
})
public class AgentImpl implements Agent {

<span class="fc" id="L65">  private static final Logger log = LoggerFactory.getLogger(AgentImpl.class);</span>

  /**
   * The name of the agent.
   */
  @Id
  @Column(name = &quot;id&quot;, length = 128)
  protected String name;

  /**
   * The state of the agent. This should be defined from the constants in AgentState.
   */
  @Lob
  @Column(name = &quot;state&quot;, nullable = false, length = 65535)
  protected String state;

  /**
   * The URL of the agent. This is determined from the referer header parameter when the agent is registered.
   */
  @Lob
  @Column(name = &quot;url&quot;, length = 65535)
  protected String url;

  @Id
  @Column(name = &quot;organization&quot;, length = 128)
  protected String organization;

  /**
   * The time at which the agent last checked in with this service. Note that this is an absolute timestamp (ie,
   * milliseconds since 1970) rather than a relative timestamp (ie, it's been 3000 ms since it last checked in).
   */
  @Column(name = &quot;last_heard_from&quot;, nullable = false)
  protected Long lastHeardFrom;

  /** The roles allowed to schedule this agent */
<span class="fc" id="L100">  @ElementCollection</span>
  @Column(name = &quot;role&quot;, nullable = false)
  @CollectionTable(name = &quot;oc_capture_agent_role&quot;, indexes = {
      @Index(name = &quot;IX_oc_capture_agent_role_pk&quot;, columnList = &quot;id, organization&quot;)
    }, uniqueConstraints = {
      @UniqueConstraint(name = &quot;UNQ_capture_agent_role_id_org_role&quot;, columnNames = {&quot;id&quot;, &quot;organization&quot;, &quot;role&quot;})
    }, joinColumns = {
      @JoinColumn(name = &quot;id&quot;, referencedColumnName = &quot;id&quot;, nullable = false),
      @JoinColumn(name = &quot;organization&quot;, referencedColumnName = &quot;organization&quot;, nullable = false) })
  protected Set&lt;String&gt; schedulerRoles = new HashSet&lt;&gt;();

  /**
   * The capabilities the agent has Capabilities are the devices this agent can record from, with a friendly name
   * associated to determine their nature (e.g. PRESENTER --&amp;gt; dev/video0)
   */
  @Lob
  @Column(name = &quot;configuration&quot;, nullable = true, length = 65535)
  protected String configurationString;

  // Private var to store the caps as a properties object.
  @Transient
  private Properties capabilitiesProperties;

  // Private var to store the configuration as a properties object.
  @Transient
  private Properties configurationProperties;

  /**
   * Required 0-arg constructor for JAXB, creates a blank agent.
   */
<span class="fc" id="L130">  public AgentImpl() {</span>
<span class="fc" id="L131">  };</span>

  /**
   * Builds a representation of the agent.
   *
   * @param agentName
   *          The name of the agent.
   * @param organization
   *          The organization identifier to which this agent belongs
   * @param agentState
   *          The state of the agent. This should be defined from the constants in AgentState
   * @param configuration
   *          The configuration of the agent.
   */
<span class="fc" id="L145">  public AgentImpl(String agentName, String organization, String agentState, String agentUrl, Properties configuration) {</span>
<span class="fc" id="L146">    name = agentName;</span>
<span class="fc" id="L147">    this.setState(agentState);</span>
<span class="fc" id="L148">    this.setUrl(agentUrl);</span>
<span class="fc" id="L149">    this.setOrganization(organization);</span>
    // Agents with no capabilities are allowed. These can/will be updated after the agent is built if necessary.
<span class="fc" id="L151">    setConfiguration(configuration);</span>
<span class="fc" id="L152">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.capture.admin.api.Agent#getName()
   */
  public String getName() {
<span class="fc" id="L160">    return name;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.capture.admin.api.Agent#setState(java.lang.String)
   */
  public void setState(String newState) {
<span class="fc" id="L169">    state = newState;</span>
<span class="fc" id="L170">    setLastHeardFrom(System.currentTimeMillis());</span>
<span class="fc" id="L171">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.capture.admin.api.Agent#getState()
   */
  public String getState() {
<span class="fc" id="L179">    return state;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.capture.admin.api.Agent#setUrl(java.lang.String)
   */
  public void setUrl(String agentUrl) {
<span class="fc" id="L188">    url = agentUrl;</span>
<span class="fc" id="L189">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.capture.admin.api.Agent#getUrl()
   */
  public String getUrl() {
<span class="fc" id="L197">    return url;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.capture.admin.api.Agent#setLastHeardFrom(java.lang.Long)
   */
  public void setLastHeardFrom(Long time) {
<span class="fc" id="L206">    lastHeardFrom = time;</span>
<span class="fc" id="L207">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.capture.admin.api.Agent#getLastHeardFrom()
   */
  public Long getLastHeardFrom() {
<span class="fc" id="L215">    return lastHeardFrom;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.capture.admin.api.Agent#getCapabilities()
   */
  public Properties getCapabilities() {
<span class="fc" id="L224">    return capabilitiesProperties;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.capture.admin.api.Agent#getConfiguration()
   */
  public Properties getConfiguration() {
<span class="fc" id="L233">    return configurationProperties;</span>
  }

  /**
   * @return the schedulerRoles
   */
  public Set&lt;String&gt; getSchedulerRoles() {
<span class="fc" id="L240">    return schedulerRoles;</span>
  }

  /**
   * @param schedulerRoles
   *          the schedulerRoles to set
   */
  public void setSchedulerRoles(Set&lt;String&gt; schedulerRoles) {
<span class="fc" id="L248">    this.schedulerRoles = schedulerRoles;</span>
<span class="fc" id="L249">  }</span>

  /**
   * @return the organization
   */
  public String getOrganization() {
<span class="fc" id="L255">    return organization;</span>
  }

  /**
   * @param organization
   *          the organization to set
   */
  public void setOrganization(String organization) {
<span class="fc" id="L263">    this.organization = organization;</span>
<span class="fc" id="L264">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.capture.admin.api.Agent#setConfiguration(java.util.Properties)
   */
  public void setConfiguration(Properties configuration) {
<span class="fc bfc" id="L272" title="All 2 branches covered.">    if (configuration == null) {</span>
<span class="fc" id="L273">      return;</span>
    }

    // Set the configuration variables
<span class="fc" id="L277">    configurationProperties = configuration;</span>
    try {
<span class="fc" id="L279">      StringWriter sw = new StringWriter();</span>
<span class="fc" id="L280">      configuration.store(sw, &quot;&quot;);</span>
<span class="fc" id="L281">      this.configurationString = sw.toString();</span>
<span class="nc" id="L282">    } catch (IOException e) {</span>
<span class="nc" id="L283">      log.warn(&quot;Unable to store agent &quot; + &quot;'s capabilities to the database, IO exception occurred.&quot;, e);</span>
<span class="fc" id="L284">    }</span>

    // Figure out the capabilities variables

<span class="fc" id="L288">    capabilitiesProperties = new Properties();</span>

<span class="fc" id="L290">    String names = configuration.getProperty(CaptureParameters.CAPTURE_DEVICE_NAMES);</span>
<span class="fc bfc" id="L291" title="All 2 branches covered.">    if (names == null) {</span>
<span class="fc" id="L292">      log.debug(&quot;Capture agent '{}' failed to provide device names ({})&quot;, name, CaptureParameters.CAPTURE_DEVICE_NAMES);</span>
<span class="fc" id="L293">      return;</span>
    }

<span class="fc" id="L296">    capabilitiesProperties.put(CaptureParameters.CAPTURE_DEVICE_NAMES, names);</span>
    // Get the names and setup a hash map of them
<span class="fc" id="L298">    String[] friendlyNames = names.split(&quot;,&quot;);</span>
<span class="fc" id="L299">    HashMap&lt;String, Integer&gt; propertyCounts = new HashMap&lt;String, Integer&gt;();</span>
<span class="fc bfc" id="L300" title="All 2 branches covered.">    for (String name : friendlyNames) {</span>
<span class="fc" id="L301">      propertyCounts.put(name, 0);</span>
    }

    // For each key
<span class="fc bfc" id="L305" title="All 2 branches covered.">    for (String key : configuration.stringPropertyNames()) {</span>
      // For each device
<span class="fc bfc" id="L307" title="All 2 branches covered.">      for (String name : friendlyNames) {</span>
<span class="fc" id="L308">        String check = CaptureParameters.CAPTURE_DEVICE_PREFIX + name;</span>
        // If the key looks like a device prefix + the name, copy it
<span class="fc bfc" id="L310" title="All 2 branches covered.">        if (key.contains(check)) {</span>
<span class="fc" id="L311">          String property = configuration.getProperty(key);</span>
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">          if (property == null) {</span>
<span class="nc" id="L313">            log.error(&quot;Unable to expand variable in value for key {}, returning null!&quot;, key);</span>
<span class="nc" id="L314">            capabilitiesProperties = null;</span>
<span class="nc" id="L315">            return;</span>
          }
<span class="fc" id="L317">          capabilitiesProperties.setProperty(key, property);</span>
<span class="fc" id="L318">          propertyCounts.put(name, propertyCounts.get(name) + 1);</span>
        }
      }
<span class="fc" id="L321">    }</span>
<span class="fc" id="L322">  }</span>

  /**
   * Post load method to load the capabilities from a string to the properties object
   */
  @SuppressWarnings(&quot;unused&quot;)
  @PostLoad
  private void loadCaps() {
<span class="fc" id="L330">    configurationProperties = new Properties();</span>
<span class="pc bpc" id="L331" title="1 of 2 branches missed.">    if (configurationString == null) {</span>
<span class="nc" id="L332">      log.info(&quot;No configuration properties set yet for '{}'&quot;, name);</span>
    } else {
      try {
<span class="fc" id="L335">        configurationProperties.load(new StringReader(this.configurationString));</span>
<span class="fc" id="L336">        this.setConfiguration(configurationProperties);</span>
<span class="nc" id="L337">      } catch (IOException e) {</span>
<span class="nc" id="L338">        log.warn(&quot;Unable to load agent &quot; + name + &quot;'s capabilities, IO exception occurred.&quot;, e);</span>
<span class="fc" id="L339">      }</span>
    }
<span class="fc" id="L341">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see java.lang.Object#equals(java.lang.Object)
   */
  @Override
  public boolean equals(Object o) {
<span class="nc bnc" id="L350" title="All 2 branches missed.">    if (this == o) {</span>
<span class="nc" id="L351">      return true;</span>
    }
<span class="nc bnc" id="L353" title="All 2 branches missed.">    if (o instanceof AgentImpl) {</span>
<span class="nc" id="L354">      return name.equals(((AgentImpl) o).name);</span>
    } else {
<span class="nc" id="L356">      return false;</span>
    }
  }

  /**
   * {@inheritDoc}
   *
   * @see java.lang.Object#hashCode()
   */
  @Override
  public int hashCode() {
<span class="nc" id="L367">    return name.hashCode();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>