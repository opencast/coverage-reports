<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CaptureAgentAdminRoleProviderImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-capture-admin-service-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.capture.admin.impl</a> &gt; <span class="el_source">CaptureAgentAdminRoleProviderImpl.java</span></div><h1>CaptureAgentAdminRoleProviderImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.capture.admin.impl;

import org.opencastproject.capture.admin.api.CaptureAgentStateService;
import org.opencastproject.security.api.JaxbOrganization;
import org.opencastproject.security.api.JaxbRole;
import org.opencastproject.security.api.Role;
import org.opencastproject.security.api.RoleProvider;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.UserProvider;
import org.opencastproject.security.util.SecurityUtil;

import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;

import java.util.Collections;
import java.util.Iterator;
import java.util.List;
import java.util.regex.Pattern;
import java.util.stream.Stream;

/**
 * The capture agent admin role provider provides a role for each registered capture agent
 */
@Component(
  property = {
    &quot;service.description=Manages Roles for each capture agent&quot;
  },
  immediate = true,
  service = { RoleProvider.class }
)
<span class="nc" id="L52">public class CaptureAgentAdminRoleProviderImpl implements RoleProvider {</span>

  private SecurityService securityService;

  /**
   * @param service
   *          the securityService to set
   */
  @Reference
  public void setSecurityService(final SecurityService service) {
<span class="nc" id="L62">    this.securityService = service;</span>
<span class="nc" id="L63">  }</span>


  private CaptureAgentStateService captureAgentService;

  @Reference
  public void setCaptureAgentStateService(final CaptureAgentStateService service) {
<span class="nc" id="L70">    this.captureAgentService = service;</span>
<span class="nc" id="L71">  }</span>

  private Role generateCaRole(final String name) {
<span class="nc" id="L74">    final String roleName = SecurityUtil.getCaptureAgentRole(name);</span>
<span class="nc" id="L75">    final JaxbOrganization organization = JaxbOrganization.fromOrganization(securityService.getOrganization());</span>
<span class="nc" id="L76">    final String description = &quot;Role for capture agent \&quot;&quot; + name + &quot;\&quot;&quot;;</span>
<span class="nc" id="L77">    final Role.Type system = Role.Type.INTERNAL;</span>
<span class="nc" id="L78">    return new JaxbRole(roleName, organization, description, system);</span>
  }

  private Stream&lt;Role&gt; getRolesStream() {
<span class="nc" id="L82">    return this.captureAgentService.getKnownAgents()</span>
<span class="nc" id="L83">            .keySet()</span>
<span class="nc" id="L84">            .stream()</span>
<span class="nc" id="L85">            .map(this::generateCaRole);</span>
  }

  /**
   * @see RoleProvider#getRolesForUser(String)
   */
  @Override
  public List&lt;Role&gt; getRolesForUser(final String userName) {
<span class="nc" id="L93">    return Collections.emptyList();</span>
  }

  /**
   * @see RoleProvider#getOrganization()
   */
  @Override
  public String getOrganization() {
<span class="nc" id="L101">    return UserProvider.ALL_ORGANIZATIONS;</span>
  }

  /**
   * @see RoleProvider#findRoles(String,Role.Target, int, int)
   */
  @Override
  public Iterator&lt;Role&gt; findRoles(final String query, final Role.Target target, final int offset, final int limit) {
<span class="nc bnc" id="L109" title="All 2 branches missed.">    if (query == null) {</span>
<span class="nc" id="L110">      throw new IllegalArgumentException(&quot;Query must be set&quot;);</span>
    }

    // These roles are not meaningful for use in ACLs
<span class="nc bnc" id="L114" title="All 2 branches missed.">    if (target == Role.Target.ACL) {</span>
<span class="nc" id="L115">      return Collections.emptyIterator();</span>
    }

<span class="nc" id="L118">    Stream&lt;Role&gt; roleStream = getRolesStream()</span>
<span class="nc bnc" id="L119" title="All 4 branches missed.">            .filter(e -&gt; like(e.getName(), query) || like(e.getDescription(), query))</span>
<span class="nc" id="L120">            .skip(offset);</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">    if (limit != 0) {</span>
<span class="nc" id="L122">      roleStream = roleStream.limit(limit);</span>
    }
<span class="nc" id="L124">    return roleStream.iterator();</span>
  }

  // This is taken liberally from ConfigurableLoginHandler. This really needs to go into a separate interface.
  private static boolean like(final String string, final String query) {
<span class="nc" id="L129">    final String regex = query.replace(&quot;_&quot;, &quot;.&quot;).replace(&quot;%&quot;, &quot;.*?&quot;);</span>
<span class="nc" id="L130">    final Pattern p = Pattern.compile(regex, Pattern.CASE_INSENSITIVE | Pattern.DOTALL);</span>
<span class="nc" id="L131">    return p.matcher(string).matches();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>