<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>WorkflowRestService.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-workflow-service-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.workflow.endpoint</a> &gt; <span class="el_source">WorkflowRestService.java</span></div><h1>WorkflowRestService.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.workflow.endpoint;

import static javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;
import static javax.servlet.http.HttpServletResponse.SC_CONFLICT;
import static javax.servlet.http.HttpServletResponse.SC_FORBIDDEN;
import static javax.servlet.http.HttpServletResponse.SC_NOT_FOUND;
import static javax.servlet.http.HttpServletResponse.SC_NO_CONTENT;
import static javax.servlet.http.HttpServletResponse.SC_OK;
import static javax.servlet.http.HttpServletResponse.SC_UNAUTHORIZED;
import static org.opencastproject.util.doc.rest.RestParameter.Type.STRING;
import static org.opencastproject.util.doc.rest.RestParameter.Type.TEXT;

import org.opencastproject.job.api.JobProducer;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.mediapackage.MediaPackageElement;
import org.opencastproject.mediapackage.MediaPackageImpl;
import org.opencastproject.mediapackage.MediaPackageParser;
import org.opencastproject.mediapackage.MediaPackageSupport;
import org.opencastproject.rest.AbstractJobProducerEndpoint;
import org.opencastproject.rest.RestConstants;
import org.opencastproject.security.api.Permissions;
import org.opencastproject.security.api.UnauthorizedException;
import org.opencastproject.serviceregistry.api.ServiceRegistry;
import org.opencastproject.systems.OpencastConstants;
import org.opencastproject.util.LocalHashMap;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.UrlSupport;
import org.opencastproject.util.doc.rest.RestParameter;
import org.opencastproject.util.doc.rest.RestParameter.Type;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestResponse;
import org.opencastproject.util.doc.rest.RestService;
import org.opencastproject.workflow.api.JaxbWorkflowInstance;
import org.opencastproject.workflow.api.WorkflowDatabaseException;
import org.opencastproject.workflow.api.WorkflowDefinition;
import org.opencastproject.workflow.api.WorkflowDefinitionImpl;
import org.opencastproject.workflow.api.WorkflowDefinitionSet;
import org.opencastproject.workflow.api.WorkflowException;
import org.opencastproject.workflow.api.WorkflowInstance;
import org.opencastproject.workflow.api.WorkflowInstance.WorkflowState;
import org.opencastproject.workflow.api.WorkflowOperationHandler;
import org.opencastproject.workflow.api.WorkflowParsingException;
import org.opencastproject.workflow.api.WorkflowService;
import org.opencastproject.workflow.api.WorkflowSetImpl;
import org.opencastproject.workflow.api.WorkflowStateException;
import org.opencastproject.workflow.api.XmlWorkflowParser;
import org.opencastproject.workflow.impl.WorkflowServiceImpl;
import org.opencastproject.workflow.impl.WorkflowServiceImpl.HandlerRegistration;
import org.opencastproject.workspace.api.Workspace;

import com.google.common.util.concurrent.Striped;

import org.apache.commons.lang3.StringUtils;
import org.apache.commons.lang3.exception.ExceptionUtils;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.jaxrs.whiteboard.propertytypes.JaxrsResource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.concurrent.locks.Lock;

import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.DELETE;
import javax.ws.rs.FormParam;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.WebApplicationException;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.Response.Status;

/**
 * A REST endpoint for the {@link WorkflowService}
 */
@Path(&quot;/workflow&quot;)
@RestService(name = &quot;workflowservice&quot;, title = &quot;Workflow Service&quot;, abstractText = &quot;This service lists available workflows and starts, stops, suspends and resumes workflow instances.&quot;, notes = {
        &quot;All paths above are relative to the REST endpoint base (something like http://your.server/files)&quot;,
        &quot;If the service is down or not working it will return a status 503, this means the the underlying service is &quot;
                + &quot;not working and is either restarting or has failed&quot;,
        &quot;A status code 500 means a general failure has occurred which is not recoverable and was not anticipated. In &quot;
                + &quot;other words, there is a bug! You should file an error report with your server logs from the time when the &quot;
                + &quot;error occurred: &lt;a href=\&quot;https://github.com/opencast/opencast/issues\&quot;&gt;Opencast Issue Tracker&lt;/a&gt;&quot; })
@Component(
    immediate = true,
    service = WorkflowRestService.class,
    property = {
        &quot;service.description=Workflow REST Endpoint&quot;,
        &quot;opencast.service.type=org.opencastproject.workflow&quot;,
        &quot;opencast.service.path=/workflow&quot;,
        &quot;opencast.service.jobproducer=true&quot;
    }
)
@JaxrsResource
<span class="fc" id="L128">public class WorkflowRestService extends AbstractJobProducerEndpoint {</span>

  /** The default number of results returned */
  private static final int DEFAULT_LIMIT = 20;
  /** The constant used to negate a querystring parameter. This is only supported on some parameters. */
  public static final String NEGATE_PREFIX = &quot;-&quot;;
  /** The constant used to switch the direction of the sorting querystring parameter. */
  public static final String DESCENDING_SUFFIX = &quot;_DESC&quot;;
  /** The logger */
<span class="fc" id="L137">  private static final Logger logger = LoggerFactory.getLogger(WorkflowRestService.class);</span>

  /** The default server URL */
<span class="fc" id="L140">  protected String serverUrl = UrlSupport.DEFAULT_BASE_URL;</span>
  /** The default service URL */
<span class="fc" id="L142">  protected String serviceUrl = serverUrl + &quot;/workflow&quot;;</span>
  /** The workflow service instance */
  private WorkflowService service;
  /** The service registry */
<span class="fc" id="L146">  protected ServiceRegistry serviceRegistry = null;</span>
  /** The workspace */
  private Workspace workspace;

  /** Resource lock */
<span class="fc" id="L151">  private final Striped&lt;Lock&gt; lock = Striped.lazyWeakLock(1024);</span>

  /**
   * Callback from the OSGi declarative services to set the service registry.
   *
   * @param serviceRegistry
   *          the service registry
   */
  @Reference
  protected void setServiceRegistry(ServiceRegistry serviceRegistry) {
<span class="nc" id="L161">    this.serviceRegistry = serviceRegistry;</span>
<span class="nc" id="L162">  }</span>

  /**
   * Sets the workflow service
   *
   * @param service
   *          the workflow service instance
   */
  @Reference
  public void setService(WorkflowService service) {
<span class="fc" id="L172">    this.service = service;</span>
<span class="fc" id="L173">  }</span>

  /**
   * Callback from the OSGi declarative services to set the workspace.
   *
   * @param workspace
   *          the workspace
   */
  @Reference
  public void setWorkspace(Workspace workspace) {
<span class="nc" id="L183">    this.workspace = workspace;</span>
<span class="nc" id="L184">  }</span>

  /**
   * OSGI callback for component activation
   *
   * @param cc
   *          the OSGI declarative services component context
   */
  @Activate
  public void activate(ComponentContext cc) {
    // Get the configured server URL
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">    if (cc == null) {</span>
<span class="fc" id="L196">      serverUrl = UrlSupport.DEFAULT_BASE_URL;</span>
    } else {
<span class="nc" id="L198">      String ccServerUrl = cc.getBundleContext().getProperty(OpencastConstants.SERVER_URL_PROPERTY);</span>
<span class="nc" id="L199">      logger.info(&quot;configured server url is {}&quot;, ccServerUrl);</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">      if (ccServerUrl == null) {</span>
<span class="nc" id="L201">        serverUrl = UrlSupport.DEFAULT_BASE_URL;</span>
      } else {
<span class="nc" id="L203">        serverUrl = ccServerUrl;</span>
      }
<span class="nc" id="L205">      serviceUrl = (String) cc.getProperties().get(RestConstants.SERVICE_PATH_PROPERTY);</span>
    }
<span class="fc" id="L207">  }</span>

  @GET
  @Produces(MediaType.TEXT_PLAIN)
  @Path(&quot;/count&quot;)
  @RestQuery(name = &quot;count&quot;, description = &quot;Returns the number of workflow instances in a specific state&quot;, returnDescription = &quot;Returns the number of workflow instances in a specific state&quot;, restParameters = {
          @RestParameter(name = &quot;state&quot;, isRequired = false, description = &quot;The workflow state&quot;, type = STRING)},
          responses = { @RestResponse(responseCode = SC_OK, description = &quot;The number of workflow instances.&quot;) })
  public Response getCount(@QueryParam(&quot;state&quot;) WorkflowInstance.WorkflowState state,
          @QueryParam(&quot;operation&quot;) String operation) {
    try {
<span class="nc" id="L218">      Long count = service.countWorkflowInstances(state);</span>
<span class="nc" id="L219">      return Response.ok(count).build();</span>
<span class="nc" id="L220">    } catch (WorkflowDatabaseException e) {</span>
<span class="nc" id="L221">      throw new WebApplicationException(e);</span>
    }
  }

  @GET
  @Path(&quot;definitions.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;definitions&quot;, description = &quot;List all available workflow definitions as JSON&quot;, returnDescription = &quot;Returns the workflow definitions as JSON&quot;, responses = { @RestResponse(responseCode = SC_OK, description = &quot;The workflow definitions.&quot;) })
  public WorkflowDefinitionSet getWorkflowDefinitionsAsJson() throws Exception {
<span class="nc" id="L230">    return getWorkflowDefinitionsAsXml();</span>
  }

  @GET
  @Path(&quot;definitions.xml&quot;)
  @Produces(MediaType.APPLICATION_XML)
  @RestQuery(name = &quot;definitions&quot;, description = &quot;List all available workflow definitions as XML&quot;, returnDescription = &quot;Returns the workflow definitions as XML&quot;, responses = { @RestResponse(responseCode = SC_OK, description = &quot;The workflow definitions.&quot;) })
  public WorkflowDefinitionSet getWorkflowDefinitionsAsXml() throws Exception {
<span class="nc" id="L238">    List&lt;WorkflowDefinition&gt; list = service.listAvailableWorkflowDefinitions();</span>
<span class="nc" id="L239">    return new WorkflowDefinitionSet(list);</span>
  }

  @GET
  @Produces(MediaType.APPLICATION_JSON)
  @Path(&quot;definition/{id}.json&quot;)
  @RestQuery(name = &quot;definitionasjson&quot;, description = &quot;Returns a single workflow definition&quot;, returnDescription = &quot;Returns a JSON representation of the workflow definition with the specified identifier&quot;, pathParameters = { @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;The workflow definition identifier&quot;, type = STRING) }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;The workflow definition.&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;Workflow definition not found.&quot;) })
  public Response getWorkflowDefinitionAsJson(@PathParam(&quot;id&quot;) String workflowDefinitionId)
          throws NotFoundException {
    WorkflowDefinition def;
    try {
<span class="nc" id="L252">      def = service.getWorkflowDefinitionById(workflowDefinitionId);</span>
<span class="nc" id="L253">    } catch (WorkflowDatabaseException e) {</span>
<span class="nc" id="L254">      throw new WebApplicationException(e);</span>
<span class="nc" id="L255">    }</span>
<span class="nc" id="L256">    return Response.ok(def).build();</span>
  }

  @GET
  @Produces(MediaType.TEXT_XML)
  @Path(&quot;definition/{id}.xml&quot;)
  @RestQuery(name = &quot;definitionasxml&quot;, description = &quot;Returns a single workflow definition&quot;, returnDescription = &quot;Returns an XML representation of the workflow definition with the specified identifier&quot;, pathParameters = { @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;The workflow definition identifier&quot;, type = STRING) }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;The workflow definition.&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;Workflow definition not found.&quot;) })
  public Response getWorkflowDefinitionAsXml(@PathParam(&quot;id&quot;) String workflowDefinitionId)
          throws NotFoundException {
<span class="nc" id="L267">    return getWorkflowDefinitionAsJson(workflowDefinitionId);</span>
  }

  /**
   * Returns the workflow configuration panel HTML snippet for the workflow definition specified by
   *
   * @param definitionId
   * @return config panel HTML snippet
   */
  @GET
  @Produces(MediaType.TEXT_HTML)
  @Path(&quot;configurationPanel&quot;)
  @RestQuery(name = &quot;configpanel&quot;, description = &quot;Get the configuration panel for a specific workflow&quot;, returnDescription = &quot;The HTML workflow configuration panel&quot;, restParameters = { @RestParameter(name = &quot;definitionId&quot;, isRequired = false, description = &quot;The workflow definition identifier&quot;, type = STRING) }, responses = { @RestResponse(responseCode = SC_OK, description = &quot;The workflow configuration panel.&quot;) })
  public Response getConfigurationPanel(@QueryParam(&quot;definitionId&quot;) String definitionId)
          throws NotFoundException {
    try {
<span class="nc" id="L283">      final WorkflowDefinition def = service.getWorkflowDefinitionById(definitionId);</span>
<span class="nc" id="L284">      final String out = def.getConfigurationPanel();</span>
<span class="nc" id="L285">      return Response.ok(out).build();</span>
<span class="nc" id="L286">    } catch (WorkflowDatabaseException e) {</span>
<span class="nc" id="L287">      throw new WebApplicationException(Status.INTERNAL_SERVER_ERROR);</span>
    }
  }

  @GET
  @Produces(MediaType.APPLICATION_JSON)
  @Path(&quot;mediaPackage/{id}/hasActiveWorkflows&quot;)
  @RestQuery(name = &quot;hasactiveworkflows&quot;, description = &quot;Returns if a media package has active workflows&quot;,
          returnDescription = &quot;Returns wether the media package has active workflows as a boolean.&quot;,
          pathParameters = {
                  @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;The media package identifier&quot;, type = STRING) },
          responses = {
                  @RestResponse(responseCode = SC_OK, description = &quot;Whether the media package has active workflows.&quot;)})
  public Response mediaPackageHasActiveWorkflows(@PathParam(&quot;id&quot;) String mediaPackageId) {
    try {
<span class="nc" id="L302">      return Response.ok(Boolean.toString(service.mediaPackageHasActiveWorkflows(mediaPackageId))).build();</span>

<span class="nc" id="L304">    } catch (WorkflowDatabaseException e) {</span>
<span class="nc" id="L305">      throw new WebApplicationException(Status.INTERNAL_SERVER_ERROR);</span>
    }
  }

  @GET
  @Produces(MediaType.APPLICATION_JSON)
  @Path(&quot;mediaPackage/{id}/instances.json&quot;)
  @RestQuery(name = &quot;workflowsofmediapackage&quot;, description = &quot;Returns the workflows for a media package&quot;,
          returnDescription = &quot;Returns the workflows that are associated with the media package as JSON.&quot;,
          pathParameters = {
                  @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;The media package identifier&quot;, type = STRING) },
          responses = {
                  @RestResponse(responseCode = SC_OK, description = &quot;Returns the workflows for a media package.&quot;)})
  public Response getWorkflowsOfMediaPackage(@PathParam(&quot;id&quot;) String mediaPackageId) {
    try {
<span class="nc" id="L320">      return Response.ok(new WorkflowSetImpl(service.getWorkflowInstancesByMediaPackage(mediaPackageId))).build();</span>
<span class="nc" id="L321">    } catch (UnauthorizedException e) {</span>
<span class="nc" id="L322">      return Response.status(Status.FORBIDDEN).build();</span>
<span class="nc" id="L323">    } catch (WorkflowDatabaseException e) {</span>
<span class="nc" id="L324">      throw new WebApplicationException(Status.INTERNAL_SERVER_ERROR);</span>
    }
  }

  @GET
  @Produces(MediaType.APPLICATION_JSON)
  @Path(&quot;mediaPackage/{id}/currentInstance.json&quot;)
  @RestQuery(name = &quot;currentworkflowofmediapackage&quot;, description = &quot;Returns the current workflow for a media package&quot;,
          returnDescription = &quot;Returns the currentworkflow that are associated with the media package as JSON.&quot;,
          pathParameters = {
                  @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;The media package identifier&quot;, type = STRING) },
          responses = {
                  @RestResponse(responseCode = SC_OK, description = &quot;Returns the workflows for a media package.&quot;),
                  @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;Current workflow not found.&quot;) })
  public Response getRunningWorkflowOfMediaPackage(@PathParam(&quot;id&quot;) String mediaPackageId) {
    try {
<span class="nc" id="L340">      Optional&lt;WorkflowInstance&gt; optWorkflowInstance = service.</span>
<span class="nc" id="L341">              getRunningWorkflowInstanceByMediaPackage(mediaPackageId, Permissions.Action.READ.toString());</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">      if (optWorkflowInstance.isPresent()) {</span>
<span class="nc" id="L343">        return Response.ok(new JaxbWorkflowInstance(optWorkflowInstance.get())).build();</span>
      } else {
<span class="nc" id="L345">        return Response.status(Response.Status.NOT_FOUND).build();</span>
      }

<span class="nc" id="L348">    } catch (WorkflowException | UnauthorizedException e) {</span>
<span class="nc" id="L349">      throw new WebApplicationException(Status.INTERNAL_SERVER_ERROR);</span>
    }
  }

  @GET
  @Produces(MediaType.APPLICATION_JSON)
  @Path(&quot;user/{id}/hasActiveWorkflows&quot;)
  @RestQuery(name = &quot;userhasactiveworkflows&quot;, description = &quot;Returns if there are currently workflow(s) running that&quot;
          + &quot;were started by the given user&quot;,
          returnDescription = &quot;Returns if there are currently workflow(s) running that were started by the given user &quot;
                  + &quot;as a boolean.&quot;,
          pathParameters = {
                  @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;The user identifier&quot;, type = STRING) },
          responses = {
                  @RestResponse(responseCode = SC_OK, description = &quot;Whether there are active workflow for the user.&quot;)})
  public Response userHasActiveWorkflows(@PathParam(&quot;id&quot;) String userId) {
    try {
<span class="nc" id="L366">      return Response.ok(Boolean.toString(service.userHasActiveWorkflows(userId))).build();</span>

<span class="nc" id="L368">    } catch (WorkflowDatabaseException e) {</span>
<span class="nc" id="L369">      throw new WebApplicationException(Status.INTERNAL_SERVER_ERROR);</span>
    }
  }

  @GET
  @Produces(MediaType.TEXT_XML)
  @Path(&quot;instance/{id}.xml&quot;)
  @RestQuery(name = &quot;workflowasxml&quot;, description = &quot;Get a specific workflow instance.&quot;, returnDescription = &quot;An XML representation of a workflow instance&quot;, pathParameters = { @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;The workflow instance identifier&quot;, type = STRING) }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;An XML representation of the workflow instance.&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No workflow instance with that identifier exists.&quot;) })
  public JaxbWorkflowInstance getWorkflowAsXml(@PathParam(&quot;id&quot;) long id) throws WorkflowDatabaseException,
          NotFoundException, UnauthorizedException {
<span class="fc" id="L381">    return new JaxbWorkflowInstance(service.getWorkflowById(id));</span>
  }

  @GET
  @Produces(MediaType.APPLICATION_JSON)
  @Path(&quot;instance/{id}.json&quot;)
  @RestQuery(name = &quot;workflowasjson&quot;, description = &quot;Get a specific workflow instance.&quot;, returnDescription = &quot;A JSON representation of a workflow instance&quot;, pathParameters = { @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;The workflow instance identifier&quot;, type = STRING) }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;A JSON representation of the workflow instance.&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No workflow instance with that identifier exists.&quot;) })
  public JaxbWorkflowInstance getWorkflowAsJson(@PathParam(&quot;id&quot;) long id) throws WorkflowDatabaseException,
          NotFoundException, UnauthorizedException {
<span class="nc" id="L392">    return getWorkflowAsXml(id);</span>
  }

  @POST
  @Path(&quot;start&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(name = &quot;start&quot;, description = &quot;Start a new workflow instance.&quot;, returnDescription = &quot;An XML representation of the new workflow instance&quot;, restParameters = {
          @RestParameter(name = &quot;definition&quot;, isRequired = true, description = &quot;The workflow definition ID or an XML representation of a workflow definition&quot;, type = TEXT, jaxbClass = WorkflowDefinitionImpl.class),
          @RestParameter(name = &quot;mediapackage&quot;, isRequired = true, description = &quot;The XML representation of a mediapackage&quot;, type = TEXT, jaxbClass = MediaPackageImpl.class),
          @RestParameter(name = &quot;parent&quot;, isRequired = false, description = &quot;An optional parent workflow instance identifier&quot;, type = STRING),
          @RestParameter(name = &quot;properties&quot;, isRequired = false, description = &quot;An optional set of key=value\\n properties&quot;, type = TEXT) }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;An XML representation of the new workflow instance.&quot;),
          @RestResponse(responseCode = SC_UNAUTHORIZED, description = &quot;You do not have permission to resume. Maybe you need to authenticate.&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;If the parent workflow does not exist&quot;) })
  public JaxbWorkflowInstance start(@FormParam(&quot;definition&quot;) String workflowDefinitionXmlOrId,
          @FormParam(&quot;mediapackage&quot;) MediaPackageImpl mp, @FormParam(&quot;parent&quot;) String parentWorkflowId,
          @FormParam(&quot;properties&quot;) LocalHashMap localMap) {
<span class="nc bnc" id="L409" title="All 4 branches missed.">    if (mp == null || StringUtils.isBlank(workflowDefinitionXmlOrId))</span>
<span class="nc" id="L410">      throw new WebApplicationException(Status.BAD_REQUEST);</span>

    WorkflowDefinition workflowDefinition;
    try {
<span class="nc" id="L414">      workflowDefinition = service.getWorkflowDefinitionById(workflowDefinitionXmlOrId);</span>
<span class="nc" id="L415">    } catch (Exception e) {</span>
      // Not an ID. Let's try if it's an XML definition
      try {
<span class="nc" id="L418">        workflowDefinition = XmlWorkflowParser.parseWorkflowDefinition(workflowDefinitionXmlOrId);</span>
<span class="nc" id="L419">      } catch (WorkflowParsingException wpe) {</span>
<span class="nc" id="L420">        throw new WebApplicationException(wpe, Status.BAD_REQUEST);</span>
<span class="nc" id="L421">      }</span>
<span class="nc" id="L422">    }</span>

<span class="nc" id="L424">    WorkflowInstance instance = null;</span>
    try {
<span class="nc" id="L426">      instance = startWorkflow(workflowDefinition, mp, parentWorkflowId, localMap);</span>
<span class="nc" id="L427">    } catch (UnauthorizedException e) {</span>
<span class="nc" id="L428">      throw new WebApplicationException(e, Status.UNAUTHORIZED);</span>
<span class="nc" id="L429">    }</span>
<span class="nc" id="L430">    return new JaxbWorkflowInstance(instance);</span>
  }

  private WorkflowInstance startWorkflow(WorkflowDefinition workflowDefinition, MediaPackageImpl mp,
          String parentWorkflowId, LocalHashMap localMap) throws UnauthorizedException {
<span class="nc" id="L435">    Map&lt;String, String&gt; properties = new HashMap&lt;String, String&gt;();</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">    if (localMap != null)</span>
<span class="nc" id="L437">      properties = localMap.getMap();</span>

<span class="nc" id="L439">    Long parentIdAsLong = null;</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">    if (StringUtils.isNotEmpty(parentWorkflowId)) {</span>
      try {
<span class="nc" id="L442">        parentIdAsLong = Long.parseLong(parentWorkflowId);</span>
<span class="nc" id="L443">      } catch (NumberFormatException e) {</span>
<span class="nc" id="L444">        throw new WebApplicationException(e, Status.BAD_REQUEST);</span>
<span class="nc" id="L445">      }</span>
    }

    try {
<span class="nc" id="L449">      return (WorkflowInstance) service.start(workflowDefinition, mp, parentIdAsLong, properties);</span>
<span class="nc" id="L450">    } catch (WorkflowException e) {</span>
<span class="nc" id="L451">      throw new WebApplicationException(e);</span>
<span class="nc" id="L452">    } catch (NotFoundException e) {</span>
<span class="nc" id="L453">      throw new WebApplicationException(e);</span>
    }
  }

  @POST
  @Path(&quot;stop&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(name = &quot;stop&quot;, description = &quot;Stops a workflow instance.&quot;, returnDescription = &quot;An XML representation of the stopped workflow instance&quot;, restParameters = { @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;The workflow instance identifier&quot;, type = STRING) }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;An XML representation of the stopped workflow instance.&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No running workflow instance with that identifier exists.&quot;) })
  public JaxbWorkflowInstance stop(@FormParam(&quot;id&quot;) long workflowInstanceId) throws WorkflowException, NotFoundException,
          UnauthorizedException {
<span class="nc" id="L465">    WorkflowInstance instance = service.stop(workflowInstanceId);</span>
<span class="nc" id="L466">    return new JaxbWorkflowInstance(instance);</span>
  }

  @DELETE
  @Path(&quot;remove/{id}&quot;)
  @Produces(MediaType.TEXT_PLAIN)
  @RestQuery(name = &quot;remove&quot;, description = &quot;Danger! Permenantly removes a workflow instance including all its child jobs. In most circumstances, /stop is what you should use.&quot;, returnDescription = &quot;HTTP 204 No Content&quot;, pathParameters = {
          @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;The workflow instance identifier&quot;, type = STRING)}, restParameters = {
          @RestParameter(name = &quot;force&quot;, isRequired = false, description = &quot;If the workflow status should be ignored and the workflow removed anyway&quot;, type = Type.BOOLEAN, defaultValue = &quot;false&quot;)}, responses = {
          @RestResponse(responseCode = HttpServletResponse.SC_NO_CONTENT, description = &quot;If workflow instance could be removed successfully, no content is returned&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No workflow instance with that identifier exists.&quot;),
          @RestResponse(responseCode = SC_FORBIDDEN, description = &quot;It's not allowed to remove other workflow instance statues than STOPPED, SUCCEEDED and FAILED (use force parameter to override AT YOUR OWN RISK).&quot;) })
  public Response remove(@PathParam(&quot;id&quot;) long workflowInstanceId, @QueryParam(&quot;force&quot;) boolean force) throws WorkflowException, NotFoundException,
          UnauthorizedException {
    try {
<span class="nc" id="L481">      service.remove(workflowInstanceId, force);</span>
<span class="nc" id="L482">    } catch (WorkflowStateException e) {</span>
<span class="nc" id="L483">      return Response.status(Status.FORBIDDEN).build();</span>
<span class="nc" id="L484">    }</span>
<span class="nc" id="L485">    return Response.noContent().build();</span>
  }

  @POST
  @Path(&quot;suspend&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(name = &quot;suspend&quot;, description = &quot;Suspends a workflow instance.&quot;, returnDescription = &quot;An XML representation of the suspended workflow instance&quot;, restParameters = { @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;The workflow instance identifier&quot;, type = STRING) }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;An XML representation of the suspended workflow instance.&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No running workflow instance with that identifier exists.&quot;) })
  public Response suspend(@FormParam(&quot;id&quot;) long workflowInstanceId) throws NotFoundException, UnauthorizedException {
    try {
<span class="nc" id="L496">      WorkflowInstance workflow = service.suspend(workflowInstanceId);</span>
<span class="nc" id="L497">      return Response.ok(new JaxbWorkflowInstance(workflow)).build();</span>
<span class="nc" id="L498">    } catch (WorkflowException e) {</span>
<span class="nc" id="L499">      throw new WebApplicationException(e);</span>
    }
  }

  @POST
  @Path(&quot;resume&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(name = &quot;resume&quot;, description = &quot;Resumes a suspended workflow instance.&quot;, returnDescription = &quot;An XML representation of the resumed workflow instance&quot;, restParameters = { @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;The workflow instance identifier&quot;, type = STRING) }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;An XML representation of the resumed workflow instance.&quot;),
          @RestResponse(responseCode = SC_CONFLICT, description = &quot;Can not resume workflow not in paused state&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No suspended workflow instance with that identifier exists.&quot;),
          @RestResponse(responseCode = SC_UNAUTHORIZED, description = &quot;You do not have permission to resume. Maybe you need to authenticate.&quot;) })
  public Response resume(@FormParam(&quot;id&quot;) long workflowInstanceId, @FormParam(&quot;properties&quot;) LocalHashMap properties)
          throws NotFoundException, UnauthorizedException {
<span class="nc" id="L513">    return resume(workflowInstanceId, null, properties);</span>
  }

  @POST
  @Path(&quot;replaceAndresume&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(name = &quot;replaceAndresume&quot;, description = &quot;Replaces a suspended workflow instance with an updated version, and resumes the workflow.&quot;, returnDescription = &quot;An XML representation of the updated and resumed workflow instance&quot;, restParameters = {
          @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;The workflow instance identifier&quot;, type = STRING),
          @RestParameter(name = &quot;mediapackage&quot;, isRequired = false, description = &quot;The new Mediapackage&quot;, type = TEXT),
          @RestParameter(name = &quot;properties&quot;, isRequired = false, description = &quot;Properties&quot;, type = TEXT) }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;An XML representation of the updated and resumed workflow instance.&quot;),
          @RestResponse(responseCode = SC_CONFLICT, description = &quot;Can not resume workflow not in paused state&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No suspended workflow instance with that identifier exists.&quot;),
          @RestResponse(responseCode = SC_UNAUTHORIZED, description = &quot;You do not have permission to resume. Maybe you need to authenticate.&quot;) })
  public Response resume(@FormParam(&quot;id&quot;) long workflowInstanceId,
          @FormParam(&quot;mediapackage&quot;) final String mediaPackage, @FormParam(&quot;properties&quot;) LocalHashMap properties)
          throws NotFoundException, UnauthorizedException {
    final Map&lt;String, String&gt; map;
<span class="nc bnc" id="L531" title="All 2 branches missed.">    if (properties == null) {</span>
<span class="nc" id="L532">      map = new HashMap&lt;String, String&gt;();</span>
    } else {
<span class="nc" id="L534">      map = properties.getMap();</span>
    }
<span class="nc" id="L536">    final Lock lock = this.lock.get(workflowInstanceId);</span>
<span class="nc" id="L537">    lock.lock();</span>
    try {
<span class="nc" id="L539">      WorkflowInstance workflow = service.getWorkflowById(workflowInstanceId);</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">      if (!WorkflowState.PAUSED.equals(workflow.getState())) {</span>
<span class="nc" id="L541">        logger.warn(&quot;Can not resume workflow '{}', not in state paused but {}&quot;, workflow, workflow.getState());</span>
<span class="nc" id="L542">        return Response.status(Status.CONFLICT).build();</span>
      }

<span class="nc bnc" id="L545" title="All 2 branches missed.">      if (mediaPackage != null) {</span>
<span class="nc" id="L546">        MediaPackage newMp = MediaPackageParser.getFromXml(mediaPackage);</span>
<span class="nc" id="L547">        MediaPackage oldMp = workflow.getMediaPackage();</span>

        // Delete removed elements from workspace
<span class="nc bnc" id="L550" title="All 2 branches missed.">        for (MediaPackageElement elem : oldMp.getElements()) {</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">          if (MediaPackageSupport.contains(elem.getIdentifier(), newMp))</span>
<span class="nc" id="L552">            continue;</span>
          try {
<span class="nc" id="L554">            workspace.delete(elem.getURI());</span>
<span class="nc" id="L555">            logger.info(&quot;Deleted removed mediapackge element {}&quot;, elem);</span>
<span class="nc" id="L556">          } catch (NotFoundException e) {</span>
<span class="nc" id="L557">            logger.info(&quot;Removed mediapackage element {} is already deleted&quot;, elem);</span>
<span class="nc" id="L558">          }</span>
        }

<span class="nc" id="L561">        workflow.setMediaPackage(newMp);</span>
<span class="nc" id="L562">        service.update(workflow);</span>
      }
<span class="nc" id="L564">      workflow = service.resume(workflowInstanceId, map);</span>
<span class="nc" id="L565">      return Response.ok(new JaxbWorkflowInstance(workflow)).build();</span>
<span class="nc" id="L566">    } catch (NotFoundException e) {</span>
<span class="nc" id="L567">      return Response.status(Status.NOT_FOUND).build();</span>
<span class="nc" id="L568">    } catch (UnauthorizedException e) {</span>
<span class="nc" id="L569">      return Response.status(Status.UNAUTHORIZED).build();</span>
<span class="nc" id="L570">    } catch (IllegalStateException e) {</span>
<span class="nc" id="L571">      logger.warn(ExceptionUtils.getMessage(e));</span>
<span class="nc" id="L572">      return Response.status(Status.CONFLICT).build();</span>
<span class="nc" id="L573">    } catch (WorkflowException e) {</span>
<span class="nc" id="L574">      logger.error(ExceptionUtils.getMessage(e), e);</span>
<span class="nc" id="L575">      return Response.serverError().build();</span>
<span class="nc" id="L576">    } catch (Exception e) {</span>
<span class="nc" id="L577">      logger.error(ExceptionUtils.getMessage(e), e);</span>
<span class="nc" id="L578">      return Response.serverError().build();</span>
    }
    finally {
<span class="nc" id="L581">      lock.unlock();</span>
    }
  }

  @POST
  @Path(&quot;update&quot;)
  @RestQuery(name = &quot;update&quot;, description = &quot;Updates a workflow instance.&quot;, returnDescription = &quot;No content.&quot;, restParameters = { @RestParameter(name = &quot;workflow&quot;, isRequired = true, description = &quot;The XML representation of the workflow instance.&quot;, type = TEXT) }, responses = { @RestResponse(responseCode = SC_NO_CONTENT, description = &quot;Workflow instance updated.&quot;) })
  public Response update(@FormParam(&quot;workflow&quot;) String workflowInstance) throws NotFoundException,
          UnauthorizedException {
    try {
<span class="nc" id="L591">      WorkflowInstance instance = XmlWorkflowParser.parseWorkflowInstance(workflowInstance);</span>
<span class="nc" id="L592">      service.update(instance);</span>
<span class="nc" id="L593">      return Response.noContent().build();</span>
<span class="nc" id="L594">    } catch (WorkflowException e) {</span>
<span class="nc" id="L595">      throw new WebApplicationException(e);</span>
    }
  }

  @GET
  @Path(&quot;handlers.json&quot;)
  @SuppressWarnings(&quot;unchecked&quot;)
  @RestQuery(name = &quot;handlers&quot;, description = &quot;List all registered workflow operation handlers (implementations).&quot;, returnDescription = &quot;A JSON representation of the registered workflow operation handlers.&quot;, responses = { @RestResponse(responseCode = SC_OK, description = &quot;A JSON representation of the registered workflow operation handlers&quot;) })
  public Response getOperationHandlers() {
<span class="nc" id="L604">    JSONArray jsonArray = new JSONArray();</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">    for (HandlerRegistration reg : ((WorkflowServiceImpl) service).getRegisteredHandlers()) {</span>
<span class="nc" id="L606">      WorkflowOperationHandler handler = reg.getHandler();</span>
<span class="nc" id="L607">      JSONObject jsonHandler = new JSONObject();</span>
<span class="nc" id="L608">      jsonHandler.put(&quot;id&quot;, handler.getId());</span>
<span class="nc" id="L609">      jsonHandler.put(&quot;description&quot;, handler.getDescription());</span>
<span class="nc" id="L610">      jsonArray.add(jsonHandler);</span>
<span class="nc" id="L611">    }</span>
<span class="nc" id="L612">    return Response.ok(jsonArray.toJSONString()).header(&quot;Content-Type&quot;, MediaType.APPLICATION_JSON).build();</span>
  }

  @GET
  @Path(&quot;statemappings.json&quot;)
  @SuppressWarnings(&quot;unchecked&quot;)
  @RestQuery(name = &quot;statemappings&quot;, description = &quot;Get all workflow state mappings&quot;,
      returnDescription = &quot;A JSON representation of the workflow state mappings.&quot;,
      responses = { @RestResponse(responseCode = SC_OK, description = &quot;A JSON representation of the workflow state mappings&quot;) })
  public Response getStateMappings() {
<span class="nc" id="L622">    return Response.ok(new JSONObject(service.getWorkflowStateMappings()).toJSONString())</span>
<span class="nc" id="L623">        .header(&quot;Content-Type&quot;, MediaType.APPLICATION_JSON).build();</span>
  }

  @Path(&quot;/cleanup&quot;)
  @RestQuery(name = &quot;cleanup&quot;, description = &quot;Cleans up workflow instances&quot;, returnDescription = &quot;No return value&quot;, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Cleanup OK&quot;),
          @RestResponse(responseCode = SC_BAD_REQUEST, description = &quot;Couldn't parse given state&quot;),
          @RestResponse(responseCode = SC_UNAUTHORIZED, description = &quot;You do not have permission to cleanup. Maybe you need to authenticate.&quot;),
          @RestResponse(responseCode = SC_FORBIDDEN, description = &quot;It's not allowed to delete other workflow instance statues than STOPPED, SUCCEEDED and FAILED&quot;) }, restParameters = {
          @RestParameter(name = &quot;buffer&quot;, type = Type.INTEGER, defaultValue = &quot;30&quot;, isRequired = true, description = &quot;Lifetime (buffer) in days a workflow instance should live&quot;),
          @RestParameter(name = &quot;state&quot;, type = Type.STRING, isRequired = true, description = &quot;Workflow instance state, only STOPPED, SUCCEEDED and FAILED are allowed values here&quot;) })
  public Response cleanup(@FormParam(&quot;buffer&quot;) int buffer, @FormParam(&quot;state&quot;) String stateParam)
          throws UnauthorizedException {

    WorkflowInstance.WorkflowState state;
    try {
<span class="nc" id="L639">      state = WorkflowInstance.WorkflowState.valueOf(stateParam);</span>
<span class="nc" id="L640">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L641">      return Response.status(Status.BAD_REQUEST).build();</span>
<span class="nc" id="L642">    }</span>

<span class="nc bnc" id="L644" title="All 6 branches missed.">    if (state != WorkflowInstance.WorkflowState.SUCCEEDED &amp;&amp; state != WorkflowInstance.WorkflowState.FAILED</span>
            &amp;&amp; state != WorkflowInstance.WorkflowState.STOPPED)
<span class="nc" id="L646">      return Response.status(Status.FORBIDDEN).build();</span>

    try {
<span class="nc" id="L649">      service.cleanupWorkflowInstances(buffer, state);</span>
<span class="nc" id="L650">      return Response.ok().build();</span>
<span class="nc" id="L651">    } catch (WorkflowDatabaseException e) {</span>
<span class="nc" id="L652">      throw new WebApplicationException(e);</span>
    }
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.rest.AbstractJobProducerEndpoint#getService()
   */
  @Override
  public JobProducer getService() {
<span class="nc bnc" id="L663" title="All 2 branches missed.">    if (service instanceof JobProducer) {</span>
<span class="nc" id="L664">      return (JobProducer) service;</span>
    } else {
<span class="nc" id="L666">      return null;</span>
    }
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.rest.AbstractJobProducerEndpoint#getServiceRegistry()
   */
  @Override
  public ServiceRegistry getServiceRegistry() {
<span class="nc" id="L677">    return serviceRegistry;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>