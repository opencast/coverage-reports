<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>Activator.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-db</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.db</a> &gt; <span class="el_source">Activator.java</span></div><h1>Activator.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.db;

import com.mchange.v2.c3p0.ComboPooledDataSource;
import com.mchange.v2.c3p0.DataSources;

import org.osgi.framework.BundleActivator;
import org.osgi.framework.BundleContext;
import org.osgi.framework.ServiceRegistration;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;
import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.Hashtable;

import javax.sql.DataSource;

/** Registers {@link DataSource}. */
<span class="nc" id="L43">public class Activator implements BundleActivator {</span>

  /** The logging facility */
<span class="nc" id="L46">  private static final Logger logger = LoggerFactory.getLogger(Activator.class);</span>

  /** The default max idle time for the connection pool */
  private static final int DEFAULT_MAX_IDLE_TIME = 3600;

  private String rootDir;
  private ServiceRegistration&lt;?&gt; datasourceRegistration;
  private ComboPooledDataSource pooledDataSource;

  @Override
  public void start(BundleContext bundleContext) throws Exception {
    // Use the configured storage directory
<span class="nc" id="L58">    rootDir = bundleContext.getProperty(&quot;org.opencastproject.storage.dir&quot;) + File.separator + &quot;db&quot;;</span>

    // Register the data source, defaulting to an embedded H2 database if DB configurations are not specified
<span class="nc" id="L61">    String jdbcDriver = getConfigProperty(bundleContext.getProperty(&quot;org.opencastproject.db.jdbc.driver&quot;),</span>
        &quot;org.h2.Driver&quot;);
<span class="nc" id="L63">    String jdbcUrl = getConfigProperty(bundleContext.getProperty(&quot;org.opencastproject.db.jdbc.url&quot;),</span>
        &quot;jdbc:h2:&quot; + rootDir);
<span class="nc bnc" id="L65" title="All 2 branches missed.">    if (&quot;org.h2.Driver&quot;.equals(jdbcDriver)) {</span>
<span class="nc" id="L66">      logger.warn(&quot;\n&quot;</span>
          + &quot;######################################################\n&quot;
          + &quot;#                                                    #\n&quot;
          + &quot;# WARNING: Opencast is using an H2 database.         #\n&quot;
          + &quot;#          Never do this in production.              #\n&quot;
          + &quot;#                                                    #\n&quot;
          + &quot;#          For more information about database       #\n&quot;
          + &quot;#          configuration, see:                       #\n&quot;
          + &quot;#                                                    #\n&quot;
          + &quot;#          https://docs.opencast.org                 #\n&quot;
          + &quot;#                                                    #\n&quot;
          + &quot;######################################################&quot;);
    }
<span class="nc" id="L79">    String jdbcUser = getConfigProperty(bundleContext.getProperty(&quot;org.opencastproject.db.jdbc.user&quot;), &quot;sa&quot;);</span>
<span class="nc" id="L80">    String jdbcPass = getConfigProperty(bundleContext.getProperty(&quot;org.opencastproject.db.jdbc.pass&quot;), &quot;sa&quot;);</span>

<span class="nc" id="L82">    Integer maxPoolSize = getConfigProperty(bundleContext.getProperty(&quot;org.opencastproject.db.jdbc.pool.max.size&quot;));</span>
<span class="nc" id="L83">    Integer minPoolSize = getConfigProperty(bundleContext.getProperty(&quot;org.opencastproject.db.jdbc.pool.min.size&quot;));</span>
<span class="nc" id="L84">    Integer acquireIncrement = getConfigProperty(</span>
<span class="nc" id="L85">        bundleContext.getProperty(&quot;org.opencastproject.db.jdbc.pool.acquire.increment&quot;));</span>
<span class="nc" id="L86">    Integer maxStatements = getConfigProperty(</span>
<span class="nc" id="L87">        bundleContext.getProperty(&quot;org.opencastproject.db.jdbc.pool.max.statements&quot;));</span>
<span class="nc" id="L88">    Integer loginTimeout = getConfigProperty(</span>
<span class="nc" id="L89">        bundleContext.getProperty(&quot;org.opencastproject.db.jdbc.pool.login.timeout&quot;));</span>
<span class="nc" id="L90">    Integer maxIdleTime = getConfigProperty(</span>
<span class="nc" id="L91">        bundleContext.getProperty(&quot;org.opencastproject.db.jdbc.pool.max.idle.time&quot;));</span>
<span class="nc" id="L92">    Integer maxConnectionAge = getConfigProperty(</span>
<span class="nc" id="L93">        bundleContext.getProperty(&quot;org.opencastproject.db.jdbc.pool.max.connection.age&quot;));</span>
<span class="nc" id="L94">    Boolean testConnectionOnCheckin = getConfigBooleanProperty(</span>
<span class="nc" id="L95">        bundleContext.getProperty(&quot;org.opencastproject.db.jdbc.pool.test.connection.on.checkin&quot;));</span>
<span class="nc" id="L96">    Boolean testConnectionOnCheckout = getConfigBooleanProperty(</span>
<span class="nc" id="L97">        bundleContext.getProperty(&quot;org.opencastproject.db.jdbc.pool.test.connection.on.checkout&quot;));</span>
<span class="nc" id="L98">    Integer idleConnectionTestPeriod = getConfigProperty(</span>
<span class="nc" id="L99">        bundleContext.getProperty(&quot;org.opencastproject.db.jdbc.pool.idle.connection.test.period&quot;));</span>

<span class="nc" id="L101">    pooledDataSource = new ComboPooledDataSource();</span>
<span class="nc" id="L102">    pooledDataSource.setDriverClass(jdbcDriver);</span>
<span class="nc" id="L103">    pooledDataSource.setJdbcUrl(jdbcUrl);</span>
<span class="nc" id="L104">    pooledDataSource.setUser(jdbcUser);</span>
<span class="nc" id="L105">    pooledDataSource.setPassword(jdbcPass);</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">    if (minPoolSize != null) {</span>
<span class="nc" id="L107">      pooledDataSource.setMinPoolSize(minPoolSize);</span>
      // initial pool size should be at least the min value
<span class="nc bnc" id="L109" title="All 2 branches missed.">      if (pooledDataSource.getInitialPoolSize() &lt; minPoolSize) {</span>
<span class="nc" id="L110">        pooledDataSource.setInitialPoolSize(minPoolSize);</span>
      }
    }
<span class="nc bnc" id="L113" title="All 2 branches missed.">    if (maxPoolSize != null) {</span>
<span class="nc" id="L114">      pooledDataSource.setMaxPoolSize(maxPoolSize);</span>
      // initial pool size should be at most the max value
<span class="nc bnc" id="L116" title="All 2 branches missed.">      if (pooledDataSource.getInitialPoolSize() &gt; maxPoolSize) {</span>
<span class="nc" id="L117">        pooledDataSource.setInitialPoolSize(maxPoolSize);</span>
      }
    }
<span class="nc bnc" id="L120" title="All 2 branches missed.">    if (acquireIncrement != null) {</span>
<span class="nc" id="L121">      pooledDataSource.setAcquireIncrement(acquireIncrement);</span>
    }
<span class="nc bnc" id="L123" title="All 2 branches missed.">    if (maxStatements != null) {</span>
<span class="nc" id="L124">      pooledDataSource.setMaxStatements(maxStatements);</span>
    }
<span class="nc bnc" id="L126" title="All 2 branches missed.">    if (loginTimeout != null) {</span>
<span class="nc" id="L127">      pooledDataSource.setLoginTimeout(loginTimeout);</span>
    }

    // maxIdleTime should not be zero, otherwise the connection pool will hold on to stale connections
    // that have been closed by the database.
<span class="nc bnc" id="L132" title="All 2 branches missed.">    if (maxIdleTime != null) {</span>
<span class="nc" id="L133">      pooledDataSource.setMaxIdleTime(maxIdleTime);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">    } else if (pooledDataSource.getMaxIdleTime() == 0) {</span>
<span class="nc" id="L135">      logger.debug(&quot;Setting database connection pool max.idle.time to default of {}&quot;, DEFAULT_MAX_IDLE_TIME);</span>
<span class="nc" id="L136">      pooledDataSource.setMaxIdleTime(DEFAULT_MAX_IDLE_TIME);</span>
    }

<span class="nc bnc" id="L139" title="All 2 branches missed.">    if (maxConnectionAge != null) {</span>
<span class="nc" id="L140">      pooledDataSource.setMaxConnectionAge(maxConnectionAge);</span>
    }
<span class="nc bnc" id="L142" title="All 2 branches missed.">    if (testConnectionOnCheckin != null) {</span>
<span class="nc" id="L143">      pooledDataSource.setTestConnectionOnCheckin(testConnectionOnCheckin);</span>
    }
<span class="nc bnc" id="L145" title="All 2 branches missed.">    if (testConnectionOnCheckout != null) {</span>
<span class="nc" id="L146">      pooledDataSource.setTestConnectionOnCheckout(testConnectionOnCheckout);</span>
    }
<span class="nc bnc" id="L148" title="All 2 branches missed.">    if (idleConnectionTestPeriod != null) {</span>
<span class="nc" id="L149">      pooledDataSource.setIdleConnectionTestPeriod(idleConnectionTestPeriod);</span>
    }

<span class="nc" id="L152">    Connection connection = null;</span>
    try {
<span class="nc" id="L154">      logger.info(&quot;Testing connectivity to database at {}&quot;, jdbcUrl);</span>
<span class="nc" id="L155">      connection = pooledDataSource.getConnection();</span>
<span class="nc" id="L156">      Hashtable&lt;String, String&gt; dsProps = new Hashtable&lt;&gt;();</span>
<span class="nc" id="L157">      dsProps.put(&quot;osgi.jndi.service.name&quot;, &quot;jdbc/opencast&quot;);</span>
<span class="nc" id="L158">      datasourceRegistration = bundleContext.registerService(DataSource.class.getName(), pooledDataSource, dsProps);</span>
<span class="nc" id="L159">    } catch (SQLException e) {</span>
<span class="nc" id="L160">      logger.error(&quot;Connection attempt to {} failed&quot;, jdbcUrl, e);</span>
<span class="nc" id="L161">      throw e;</span>
    } finally {
<span class="nc bnc" id="L163" title="All 2 branches missed.">      if (connection != null) {</span>
<span class="nc" id="L164">        connection.close();</span>
      }
    }

<span class="nc" id="L168">    logger.info(&quot;Database connection pool established at {}&quot;, jdbcUrl);</span>
<span class="nc" id="L169">    logger.info(&quot;Database connection pool parameters: max.size={}, min.size={}, max.idle.time={}&quot;,</span>
<span class="nc" id="L170">        pooledDataSource.getMaxPoolSize(), pooledDataSource.getMinPoolSize(), pooledDataSource.getMaxIdleTime());</span>
<span class="nc" id="L171">    Statement statement = pooledDataSource.getConnection().createStatement();</span>

<span class="nc" id="L173">    long random = Math.round(Math.random() * 1000000);</span>
<span class="nc" id="L174">    String tableName = &quot;oc_temp_&quot; + random;</span>
    try {
<span class="nc" id="L176">      statement.executeUpdate(&quot;CREATE TABLE &quot; + tableName + &quot; ( id BIGINT NOT NULL, test BIGINT, PRIMARY KEY (id) );&quot;);</span>
<span class="nc" id="L177">      runUpdate(statement, &quot;INSERT INTO &quot; + tableName + &quot; VALUES (&quot; + random + &quot;, 0);&quot;);</span>
<span class="nc" id="L178">      runUpdate(statement, &quot;UPDATE &quot; + tableName + &quot; SET test = &quot; + random + &quot;;&quot;);</span>
<span class="nc" id="L179">      ResultSet rs = statement.executeQuery(&quot;SELECT * FROM &quot; + tableName + &quot;;&quot;);</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">      while (rs.next()) {</span>
<span class="nc" id="L181">        long id = rs.getLong(&quot;id&quot;);</span>
<span class="nc" id="L182">        long test = rs.getLong(&quot;test&quot;);</span>
<span class="nc bnc" id="L183" title="All 4 branches missed.">        if (id != random || test != random) {</span>
<span class="nc" id="L184">          throw new RuntimeException(&quot;Unable to verify updating a table functions correctly&quot;);</span>
        }
<span class="nc" id="L186">      }</span>
<span class="nc" id="L187">      runUpdate(statement, &quot;DELETE FROM &quot; + tableName + &quot; WHERE id = &quot; + random + &quot;;&quot;);</span>
<span class="nc" id="L188">      logger.info(&quot;Database credentials passed basic tests!&quot;);</span>
<span class="nc" id="L189">    } catch (Exception e) {</span>
<span class="nc" id="L190">      throw new RuntimeException(&quot;Unable to verify SQL credentials have required permissions!&quot;, e);</span>
    } finally {
      try {
<span class="nc" id="L193">        statement.executeUpdate(&quot;DROP TABLE &quot; + tableName + &quot;;&quot;);</span>
<span class="nc" id="L194">      } catch (Exception e) {</span>
<span class="nc" id="L195">        logger.warn(&quot;Unable to delete temp table {}, please remove this yourself!&quot;, tableName, e);</span>
<span class="nc" id="L196">      }</span>
    }

<span class="nc" id="L199">  }</span>

  private void runUpdate(Statement statement, String sql) throws RuntimeException, SQLException {
<span class="nc" id="L202">    int affected = statement.executeUpdate(sql);</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">    if (affected != 1) {</span>
<span class="nc" id="L204">      throw new RuntimeException(</span>
          &quot;Unable to update on a testing table, check that your database user has the right permissions!&quot;);
    }
<span class="nc" id="L207">  }</span>

  @Override
  public void stop(BundleContext context) throws Exception {
<span class="nc" id="L211">    logger.info(&quot;Shutting down database&quot;);</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">    if (datasourceRegistration != null) {</span>
<span class="nc" id="L213">      datasourceRegistration.unregister();</span>
    }
<span class="nc" id="L215">    logger.info(&quot;Shutting down connection pool&quot;);</span>
<span class="nc" id="L216">    DataSources.destroy(pooledDataSource);</span>
<span class="nc" id="L217">  }</span>

  private String getConfigProperty(String config, String defaultValue) {
<span class="nc bnc" id="L220" title="All 2 branches missed.">    return config == null ? defaultValue : config;</span>
  }

  private Integer getConfigProperty(String config) {
<span class="nc bnc" id="L224" title="All 2 branches missed.">    return config == null ? null : Integer.parseInt(config);</span>
  }

  private Boolean getConfigBooleanProperty(String config) {
<span class="nc bnc" id="L228" title="All 2 branches missed.">    return config == null ? null : Boolean.parseBoolean(config);</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>