<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CropWorkflowOperationHandler.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-crop-workflowoperation</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.workflow.handler.crop</a> &gt; <span class="el_source">CropWorkflowOperationHandler.java</span></div><h1>CropWorkflowOperationHandler.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.workflow.handler.crop;

import org.opencastproject.crop.api.CropException;
import org.opencastproject.crop.api.CropService;
import org.opencastproject.job.api.Job;
import org.opencastproject.job.api.JobContext;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.mediapackage.MediaPackageElementFlavor;
import org.opencastproject.mediapackage.MediaPackageElementParser;
import org.opencastproject.mediapackage.MediaPackageException;
import org.opencastproject.mediapackage.Track;
import org.opencastproject.mediapackage.identifier.IdImpl;
import org.opencastproject.serviceregistry.api.ServiceRegistry;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.workflow.api.AbstractWorkflowOperationHandler;
import org.opencastproject.workflow.api.ConfiguredTagsAndFlavors;
import org.opencastproject.workflow.api.WorkflowInstance;
import org.opencastproject.workflow.api.WorkflowOperationException;
import org.opencastproject.workflow.api.WorkflowOperationHandler;
import org.opencastproject.workflow.api.WorkflowOperationInstance;
import org.opencastproject.workflow.api.WorkflowOperationResult;
import org.opencastproject.workspace.api.Workspace;

import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * The workflow definition will run recordings to crop them from 4:3 to 16:9.
 */
@Component(
    immediate = true,
    service = WorkflowOperationHandler.class,
    property = {
        &quot;service.description=Videosegmentation Workflow Operation Handler&quot;,
        &quot;workflow.operation=crop-video&quot;
    }
)
<span class="fc" id="L67">public class CropWorkflowOperationHandler extends AbstractWorkflowOperationHandler {</span>

  /** The logging facility */
<span class="fc" id="L70">  private static final Logger logger = LoggerFactory.getLogger(CropWorkflowOperationHandler.class);</span>

  /** Name of the configuration key that specifies the flavor of the track to analyze */
  private static final String PROP_SOURCE_FLAVOR = &quot;source-flavor&quot;;

  private static final String PROP_TARGET_FLAVOR = &quot;target-flavor&quot;;

  /** Name of the configuration key that specifies the flavor of the track to analyze */
  private static final String PROP_TARGET_TAGS = &quot;target-tags&quot;;

  /** The composer service */
<span class="fc" id="L81">  private CropService cropService = null;</span>

  /** The local workspace */
<span class="fc" id="L84">  private Workspace workspace = null;</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowOperationHandler#start(
   *        org.opencastproject.workflow.api.WorkflowInstance, JobContext)
   */
  @Override
  public WorkflowOperationResult start(WorkflowInstance workflowInstance, JobContext jobContext)
          throws WorkflowOperationException {

<span class="fc" id="L96">    WorkflowOperationInstance operation = workflowInstance.getCurrentOperation();</span>
<span class="fc" id="L97">    MediaPackage mediaPackage = workflowInstance.getMediaPackage();</span>

<span class="fc" id="L99">    logger.info(&quot;Start cropping workflow operation for mediapackage {}&quot;, mediaPackage.getIdentifier().toString());</span>

    // Check which tags have been configured
<span class="fc" id="L102">    ConfiguredTagsAndFlavors tagsAndFlavors = getTagsAndFlavors(workflowInstance,</span>
        Configuration.none, Configuration.one, Configuration.many, Configuration.many);
<span class="fc" id="L104">    List&lt;String&gt; targetTags = tagsAndFlavors.getTargetTags();</span>
<span class="fc" id="L105">    List&lt;MediaPackageElementFlavor&gt; targetFlavorOption = tagsAndFlavors.getTargetFlavors();</span>

<span class="fc" id="L107">    MediaPackageElementFlavor targetFlavor = null;</span>
<span class="fc bfc" id="L108" title="All 2 branches covered.">    if (!targetFlavorOption.isEmpty()) {</span>
<span class="fc" id="L109">      targetFlavor = targetFlavorOption.get(0);</span>
    }
<span class="fc" id="L111">    MediaPackageElementFlavor trackFlavor = tagsAndFlavors.getSingleSrcFlavor();</span>

<span class="fc" id="L113">    List&lt;Track&gt; candidates = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L114">    candidates.addAll(Arrays.asList(mediaPackage.getTracks(trackFlavor)));</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">    candidates.removeIf(t -&gt; !t.hasVideo());</span>

<span class="fc bfc" id="L117" title="All 2 branches covered.">    if (candidates.size() == 0) {</span>
<span class="fc" id="L118">      logger.info(&quot;No matching tracks available for cropping in workflow {}&quot;, workflowInstance);</span>
<span class="fc" id="L119">      return createResult(WorkflowOperationResult.Action.CONTINUE);</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">    } else if (candidates.size() &gt; 1) {</span>
<span class="nc" id="L121">      logger.info(&quot;Found more than one track to crop&quot;);</span>
    }

    // start cropping all candidates in parallel
<span class="fc" id="L125">    Map&lt;Job, Track&gt; jobs = new HashMap&lt;Job, Track&gt;();</span>
<span class="fc bfc" id="L126" title="All 2 branches covered.">    for (Track candidate : candidates) {</span>
      try {
<span class="fc" id="L128">        jobs.put(cropService.crop(candidate), candidate);</span>
<span class="nc" id="L129">      } catch (MediaPackageException | CropException e) {</span>
<span class="nc" id="L130">        throw new WorkflowOperationException(&quot;Failed starting crop job&quot;, e);</span>
<span class="fc" id="L131">      }</span>
<span class="fc" id="L132">    }</span>

    // wait for all crop jobs to be finished
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">    if (!waitForStatus(jobs.keySet().toArray(new Job[0])).isSuccess()) {</span>
<span class="nc" id="L136">      throw new WorkflowOperationException(&quot;Crop operation failed&quot;);</span>
    }

<span class="fc" id="L139">    long totalTimeInQueue = 0;</span>
    // add new tracks to media package

<span class="fc bfc" id="L142" title="All 2 branches covered.">    for (Map.Entry&lt;Job, Track&gt; entry : jobs.entrySet()) {</span>
<span class="fc" id="L143">      Job job = entry.getKey();</span>
<span class="fc" id="L144">      Track track = entry.getValue();</span>
      // deserialize track
      Track croppedTrack;
      try {
<span class="fc" id="L148">        croppedTrack = (Track) MediaPackageElementParser.getFromXml(job.getPayload());</span>
<span class="nc" id="L149">      } catch (MediaPackageException e) {</span>
<span class="nc" id="L150">        throw new WorkflowOperationException(String.format(&quot;Crop service yielded invalid track: %s&quot;, job.getPayload()));</span>
<span class="fc" id="L151">      }</span>

      // update identifier
<span class="fc" id="L154">      croppedTrack.setIdentifier(IdImpl.fromUUID().toString());</span>

      // move into space for media package in ws/wfr
      try {
<span class="fc" id="L158">        String filename = &quot;cropped_&quot; + croppedTrack.getURI().toString();</span>
<span class="fc" id="L159">        croppedTrack.setURI(workspace</span>
<span class="fc" id="L160">                .moveTo(croppedTrack.getURI(), mediaPackage.getIdentifier().toString(), croppedTrack.getIdentifier(),</span>
                        filename));
<span class="nc" id="L162">      } catch (NotFoundException | IOException e) {</span>
<span class="nc" id="L163">        throw new WorkflowOperationException(</span>
<span class="nc" id="L164">                String.format(&quot;Could not move %s to media package %s&quot;, croppedTrack.getURI(),</span>
<span class="nc" id="L165">                        mediaPackage.getIdentifier()));</span>
<span class="fc" id="L166">      }</span>

      // Add target tags
<span class="fc" id="L169">      targetTags.forEach(croppedTrack::addTag);</span>
<span class="fc" id="L170">      croppedTrack.setFlavor(targetFlavor);</span>

      // add new track to mediapackage
<span class="fc" id="L173">      mediaPackage.addDerived(croppedTrack, track);</span>

<span class="pc bpc" id="L175" title="1 of 2 branches missed.">      totalTimeInQueue += job.getQueueTime() == null ? 0 : job.getQueueTime();</span>
<span class="fc" id="L176">    }</span>
<span class="fc" id="L177">    logger.info(&quot;Video cropping completed&quot;);</span>
<span class="fc" id="L178">    return createResult(mediaPackage, WorkflowOperationResult.Action.CONTINUE, totalTimeInQueue);</span>
  }

  /**
   * Callback for declarative services configuration that will introduce us to the crop service.
   * Implementation assumes that the reference is configured as being static.
   *
   * @param cropService
   *          the crop service
   */
  @Reference
  protected void setCropService(CropService cropService) {
<span class="fc" id="L190">    this.cropService = cropService;</span>
<span class="fc" id="L191">  }</span>

  /**
   * Callback for declarative services configuration that will introduce us to the local workspace service.
   * Implementation assumes that the reference is configured as being static.
   *
   * @param workspace
   *          an instance of the workspace
   */
  @Reference
  protected void setWorkspace(Workspace workspace) {
<span class="fc" id="L202">    this.workspace = workspace;</span>
<span class="fc" id="L203">  }</span>

  @Reference
  @Override
  public void setServiceRegistry(ServiceRegistry serviceRegistry) {
<span class="fc" id="L208">    super.setServiceRegistry(serviceRegistry);</span>
<span class="fc" id="L209">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>