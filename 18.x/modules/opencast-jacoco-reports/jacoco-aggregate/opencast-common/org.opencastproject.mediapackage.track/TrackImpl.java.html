<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>TrackImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-common</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.mediapackage.track</a> &gt; <span class="el_source">TrackImpl.java</span></div><h1>TrackImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */


package org.opencastproject.mediapackage.track;

import org.opencastproject.mediapackage.AbstractMediaPackageElement;
import org.opencastproject.mediapackage.AudioStream;
import org.opencastproject.mediapackage.MediaPackageElementFlavor;
import org.opencastproject.mediapackage.MediaPackageException;
import org.opencastproject.mediapackage.MediaPackageSerializer;
import org.opencastproject.mediapackage.Stream;
import org.opencastproject.mediapackage.SubtitleStream;
import org.opencastproject.mediapackage.Track;
import org.opencastproject.mediapackage.VideoStream;
import org.opencastproject.util.Checksum;
import org.opencastproject.util.MimeType;
import org.opencastproject.util.MimeTypes;
import org.opencastproject.util.UnknownFileTypeException;

import org.w3c.dom.Document;
import org.w3c.dom.Node;

import java.net.URI;
import java.util.ArrayList;
import java.util.List;

import javax.xml.bind.annotation.XmlAccessType;
import javax.xml.bind.annotation.XmlAccessorType;
import javax.xml.bind.annotation.XmlAttribute;
import javax.xml.bind.annotation.XmlElement;
import javax.xml.bind.annotation.XmlRootElement;
import javax.xml.bind.annotation.XmlType;
import javax.xml.bind.annotation.adapters.XmlAdapter;

/**
 * This class is the base implementation for a media track, which itself is part of a media package, representing e. g.
 * the speaker video or the slide presentation movie.
 */
@XmlAccessorType(XmlAccessType.NONE)
@XmlType(name = &quot;track&quot;, namespace = &quot;http://mediapackage.opencastproject.org&quot;)
@XmlRootElement(name = &quot;track&quot;, namespace = &quot;http://mediapackage.opencastproject.org&quot;)
public class TrackImpl extends AbstractMediaPackageElement implements Track {

  /** Serial version UID */
  private static final long serialVersionUID = -1092781733885994038L;

<span class="fc" id="L66">  public enum StreamingProtocol {</span>
<span class="fc" id="L67">    DOWNLOAD,HLS,DASH,HDS,SMOOTH,MMS,RTP,RTSP,RTMP,RTMPE,PNM,PNA,ICY,BITTORENTLIVE,FILE,UNKNOWN</span>
  }

  /** The duration in milliseconds */
<span class="fc" id="L71">  @XmlElement(name = &quot;duration&quot;)</span>
  protected Long duration = null;

<span class="fc" id="L74">  @XmlElement(name = &quot;audio&quot;)</span>
  protected List&lt;AudioStream&gt; audio = new ArrayList&lt;&gt;();

<span class="fc" id="L77">  @XmlElement(name = &quot;video&quot;)</span>
  protected List&lt;VideoStream&gt; video = new ArrayList&lt;&gt;();

<span class="fc" id="L80">  @XmlElement(name = &quot;subtitle&quot;)</span>
  protected List&lt;SubtitleStream&gt; subtitle = new ArrayList&lt;&gt;();

<span class="fc" id="L83">  @XmlAttribute(name = &quot;transport&quot;)</span>
  protected StreamingProtocol transport = null;

  @XmlElement(name = &quot;live&quot;)
  protected boolean live;

<span class="fc" id="L89">  @XmlElement(name = &quot;master&quot;, required = false)</span>
  protected Boolean master = null;

<span class="fc" id="L92">  @XmlElement(name = &quot;logicalname&quot;, required = false) // used to maintain referential integrity for playlists</span>
  protected String logicalname = null;

  /** Needed by JAXB */
<span class="fc" id="L96">  public TrackImpl() {</span>
<span class="fc" id="L97">    this.elementType = Track.TYPE;</span>
<span class="fc" id="L98">  }</span>

  /**
   * Creates a new track object.
   *
   * @param flavor
   *          the track flavor
   * @param uri
   *          the track location
   * @param checksum
   *          the track checksum
   * @param mimeType
   *          the track mime type
   */
  TrackImpl(MediaPackageElementFlavor flavor, MimeType mimeType, URI uri, long size, Checksum checksum) {
<span class="fc" id="L113">    super(Type.Track, flavor, uri, size, checksum, mimeType);</span>
<span class="fc" id="L114">  }</span>

  /**
   * Creates a new track object for the given file and track type.
   *
   * @param flavor
   *          the track flavor
   * @param uri
   *          the track location
   */
  TrackImpl(MediaPackageElementFlavor flavor, URI uri) {
<span class="fc" id="L125">    super(Type.Track, flavor, uri);</span>
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">    if (uri != null) {</span>
      try {
<span class="fc" id="L128">        this.setMimeType(MimeTypes.fromURI(uri));</span>
<span class="fc" id="L129">      } catch (UnknownFileTypeException e) { }</span>
    }
<span class="fc" id="L131">  }</span>

  /**
   * Creates a new track from the given url.
   *
   * @param uri
   *          the track location
   * @return the track
   */
  public static TrackImpl fromURI(URI uri) {
<span class="fc" id="L141">    return new TrackImpl(null, uri);</span>
  }

  /**
   * Sets the track's duration in milliseconds.
   *
   * @param duration
   *          the duration
   */
  public void setDuration(Long duration) {
<span class="fc" id="L151">    this.duration = duration;</span>
<span class="fc" id="L152">  }</span>

  /**
   * @see org.opencastproject.mediapackage.Track#getDuration()
   */
  @Override
  public Long getDuration() {
<span class="fc" id="L159">    return duration;</span>
  }

  @Override
  public Stream[] getStreams() {
<span class="fc" id="L164">    List&lt;Stream&gt; streams = new ArrayList&lt;&gt;(audio.size() + video.size() + subtitle.size());</span>
<span class="fc" id="L165">    streams.addAll(audio);</span>
<span class="fc" id="L166">    streams.addAll(video);</span>
<span class="fc" id="L167">    streams.addAll(subtitle);</span>
<span class="fc" id="L168">    return streams.toArray(new Stream[0]);</span>
  }

  /**
   * Add a stream to the track.
   */
  public void addStream(AbstractStreamImpl stream) {
<span class="fc bfc" id="L175" title="All 2 branches covered.">    if (stream instanceof AudioStreamImpl) {</span>
<span class="fc" id="L176">      audio.add((AudioStreamImpl) stream);</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">    } else if (stream instanceof VideoStreamImpl) {</span>
<span class="fc" id="L178">      video.add((VideoStreamImpl) stream);</span>
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">    } else if (stream instanceof SubtitleStreamImpl) {</span>
<span class="fc" id="L180">      subtitle.add((SubtitleStreamImpl) stream);</span>
    } else {
<span class="nc" id="L182">      throw new IllegalArgumentException(&quot;stream must be either audio or video&quot;);</span>
    }
<span class="fc" id="L184">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.Track#hasAudio()
   */
  @Override
  public boolean hasAudio() {
<span class="pc bpc" id="L193" title="1 of 4 branches missed.">    return audio != null &amp;&amp; audio.size() &gt; 0;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.Track#hasVideo()
   */
  @Override
  public boolean hasVideo() {
<span class="pc bpc" id="L203" title="1 of 4 branches missed.">    return video != null &amp;&amp; video.size() &gt; 0;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.Track#hasSubtitle()
   */
  @Override
  public boolean hasSubtitle() {
<span class="pc bpc" id="L213" title="1 of 4 branches missed.">    return subtitle != null &amp;&amp; subtitle.size() &gt; 0;</span>
  }

  public List&lt;AudioStream&gt; getAudio() {
<span class="nc" id="L217">    return audio;</span>
  }

  public void setAudio(List&lt;AudioStream&gt; audio) {
<span class="fc" id="L221">    this.audio = audio;</span>
<span class="fc" id="L222">  }</span>

  public List&lt;VideoStream&gt; getVideo() {
<span class="fc" id="L225">    return video;</span>
  }

  public void setVideo(List&lt;VideoStream&gt; video) {
<span class="fc" id="L229">    this.video = video;</span>
<span class="fc" id="L230">  }</span>

  public List&lt;SubtitleStream&gt; getSubtitle() {
<span class="nc" id="L233">    return subtitle;</span>
  }

  public void setSubtitle(List&lt;SubtitleStream&gt; subtitle) {
<span class="nc" id="L237">    this.subtitle = subtitle;</span>
<span class="nc" id="L238">  }</span>

  public void setLive(boolean isLive) {
<span class="fc" id="L241">    this.live = isLive;</span>
<span class="fc" id="L242">  }</span>

  /**
   * @see org.opencastproject.mediapackage.Track#isLive()
   */
  @Override
  public boolean isLive() {
<span class="fc" id="L249">    return this.live;</span>
  }

  /**
   *  @return true if it is a master adaptive playlist/manifest
   */
  @Override
  public Boolean isMaster() {
<span class="fc bfc" id="L257" title="All 4 branches covered.">    return hasMaster() &amp;&amp; master;</span>
  }

  @Override
  public void setMaster(Boolean master) {
<span class="fc" id="L262">    this.master = master;</span>
<span class="fc" id="L263">  }</span>

  @Override
  public boolean hasMaster() {
<span class="fc bfc" id="L267" title="All 2 branches covered.">    return master != null;</span>
  }

  /**
   * @see org.opencastproject.mediapackage.AbstractMediaPackageElement#toManifest(org.w3c.dom.Document,
   *      MediaPackageSerializer)
   */
  @Override
  public Node toManifest(Document document, MediaPackageSerializer serializer) throws MediaPackageException {
<span class="nc" id="L276">    Node node = super.toManifest(document, serializer);</span>

    // duration
<span class="nc bnc" id="L279" title="All 4 branches missed.">    if (duration != null &amp;&amp; duration &gt;= 0) {</span>
<span class="nc" id="L280">      Node durationNode = document.createElement(&quot;duration&quot;);</span>
<span class="nc" id="L281">      durationNode.appendChild(document.createTextNode(Long.toString(duration)));</span>
<span class="nc" id="L282">      node.appendChild(durationNode);</span>
    }

<span class="nc" id="L285">    Node liveNode = document.createElement(&quot;live&quot;);</span>
<span class="nc" id="L286">    liveNode.appendChild(document.createTextNode(Boolean.toString(live)));</span>
<span class="nc" id="L287">    node.appendChild(liveNode);</span>

<span class="nc bnc" id="L289" title="All 2 branches missed.">    if (hasMaster()) { // optional - if it is a master adaptive playlist/manifest</span>
<span class="nc" id="L290">      Node masterNode = document.createElement(&quot;master&quot;);</span>
<span class="nc" id="L291">      masterNode.appendChild(document.createTextNode(Boolean.toString(isMaster())));</span>
<span class="nc" id="L292">      node.appendChild(masterNode);</span>
    }

<span class="nc bnc" id="L295" title="All 4 branches missed.">    if (logicalname != null &amp;&amp; !logicalname.isEmpty()) { // optional</span>
<span class="nc" id="L296">      Node nameNode = document.createElement(&quot;logicalname&quot;);</span>
<span class="nc" id="L297">      liveNode.appendChild(document.createTextNode(logicalname));</span>
<span class="nc" id="L298">      node.appendChild(nameNode);</span>
    }

<span class="nc bnc" id="L301" title="All 2 branches missed.">    for (Stream s : audio)</span>
<span class="nc" id="L302">      node.appendChild(s.toManifest(document, serializer));</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">    for (Stream s : video)</span>
<span class="nc" id="L304">      node.appendChild(s.toManifest(document, serializer));</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">    for (Stream s : subtitle)</span>
<span class="nc" id="L306">      node.appendChild(s.toManifest(document, serializer));</span>
<span class="nc" id="L307">    return node;</span>
  }

  /**
   * This implementation returns the track's mime type.
   *
   * @see org.opencastproject.mediapackage.Track#getDescription()
   */
  @Override
  public String getDescription() {
<span class="fc" id="L317">    StringBuffer buf = new StringBuffer(&quot;&quot;);</span>
    /*
     * todo boolean details = false; if (hasVideo()) { details = true; buf.append(videoSettings); } if (hasAudio()) {
     * String audioCodec = audioSettings.toString(); if (!hasVideo() || !audioCodec.equals(videoSettings.toString())) {
     * if (details) buf.append(&quot; / &quot;); details = true; buf.append(audioCodec); } } if (!details) {
     * buf.append(getMimeType()); }
     */
<span class="fc" id="L324">    return buf.toString().toLowerCase();</span>
  }

  public void setTransport(StreamingProtocol transport) {
<span class="nc" id="L328">    this.transport = transport;</span>
<span class="nc" id="L329">  }</span>

  public StreamingProtocol getTransport() {
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">    if (transport == null) return autodetectTransport(getURI());</span>
<span class="nc" id="L333">    return transport;</span>
  }

  /**
   * @see java.lang.Object#clone() todo
   */
  // @Override
  // public Object clone() throws CloneNotSupportedException {
  // TrackImpl t = null;
  // try {
  // t = new TrackImpl(flavor, mimeType, new File(path, fileName), checksum);
  // t.duration = duration;
  // // todo
  // //t.audioSettings = (AudioSettings)audioSettings.clone();
  // //t.videoSettings = (VideoSettings)videoSettings.clone();
  // } catch (Exception e) {
  // throw new IllegalStateException(&quot;Illegal state while cloning track: &quot; + t);
  // }
  // return super.clone();
  // }

<span class="fc" id="L354">  public static class Adapter extends XmlAdapter&lt;TrackImpl, Track&gt; {</span>
    @Override
    public TrackImpl marshal(Track mp) throws Exception {
<span class="fc" id="L357">      return (TrackImpl) mp;</span>
    }

    @Override
    public Track unmarshal(TrackImpl mp) throws Exception {
<span class="fc" id="L362">      return mp;</span>
    }
  }

  private StreamingProtocol autodetectTransport(URI uri) {
<span class="pc bpc" id="L367" title="2 of 4 branches missed.">    if (uri == null || uri.getScheme() == null) return null;</span>
<span class="pc bpc" id="L368" title="1 of 2 branches missed.">    if (uri.getScheme().toLowerCase().startsWith(&quot;http&quot;)) {</span>
<span class="pc bpc" id="L369" title="1 of 2 branches missed.">        if (uri.getFragment() == null) return StreamingProtocol.DOWNLOAD;</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">        else if (uri.getFragment().toLowerCase().endsWith(&quot;.m3u8&quot;)) return StreamingProtocol.HLS;</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">        else if (uri.getFragment().toLowerCase().endsWith(&quot;.mpd&quot;)) return StreamingProtocol.DASH;</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">        else if (uri.getFragment().toLowerCase().endsWith(&quot;.f4m&quot;)) return StreamingProtocol.HDS;</span>
<span class="nc" id="L373">        else setTransport(StreamingProtocol.DOWNLOAD);</span>
    }
<span class="nc bnc" id="L375" title="All 2 branches missed.">    else if (uri.getScheme().toLowerCase().startsWith(&quot;rtmp&quot;)) return StreamingProtocol.RTMP;</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">    else if (uri.getScheme().toLowerCase().startsWith(&quot;rtmpe&quot;)) return StreamingProtocol.RTMPE;</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">    else if (uri.getScheme().toLowerCase().startsWith(&quot;file&quot;)) return StreamingProtocol.FILE;</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">    else if (uri.getScheme().toLowerCase().startsWith(&quot;rtp&quot;)) return StreamingProtocol.RTP;</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">    else if (uri.getScheme().toLowerCase().startsWith(&quot;rtsp&quot;)) return StreamingProtocol.RTSP;</span>
<span class="nc" id="L380">    return StreamingProtocol.UNKNOWN;</span>
  }

  @Override
  public String getLogicalName() {
<span class="fc bfc" id="L385" title="All 2 branches covered.">    if (logicalname == null) // default to it's own path</span>
<span class="fc" id="L386">      return uri.getPath();</span>
<span class="fc" id="L387">    return logicalname;</span>
  }

  @Override
  public void setLogicalName(String name) {
<span class="fc" id="L392">    logicalname = name;</span>
<span class="fc" id="L393">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>