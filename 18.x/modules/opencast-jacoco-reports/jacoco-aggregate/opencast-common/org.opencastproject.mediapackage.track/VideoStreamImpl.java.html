<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>VideoStreamImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-common</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.mediapackage.track</a> &gt; <span class="el_source">VideoStreamImpl.java</span></div><h1>VideoStreamImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */


package org.opencastproject.mediapackage.track;

import org.opencastproject.mediapackage.MediaPackageSerializer;
import org.opencastproject.mediapackage.VideoStream;

import org.apache.commons.lang3.StringUtils;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;

import java.util.UUID;

import javax.xml.bind.annotation.XmlAccessType;
import javax.xml.bind.annotation.XmlAccessorType;
import javax.xml.bind.annotation.XmlAttribute;
import javax.xml.bind.annotation.XmlElement;
import javax.xml.bind.annotation.XmlType;
import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathConstants;
import javax.xml.xpath.XPathException;

/**
 * Implementation of {@link org.opencastproject.mediapackage.VideoStream}.
 */
@XmlAccessorType(XmlAccessType.NONE)
@XmlType(name = &quot;video&quot;, namespace = &quot;http://mediapackage.opencastproject.org&quot;)
public class VideoStreamImpl extends AbstractStreamImpl implements VideoStream {

  @XmlElement(name = &quot;bitrate&quot;)
  protected Float bitRate;

  @XmlElement(name = &quot;framerate&quot;)
  protected Float frameRate;

  @XmlElement(name = &quot;resolution&quot;)
  protected String resolution;

  protected Integer frameWidth;
  protected Integer frameHeight;

<span class="fc" id="L63">  @XmlElement(name = &quot;scantype&quot;)</span>
  protected Scan scanType = null;

  @XmlType(name = &quot;scantype&quot;)
<span class="fc" id="L67">  static class Scan {</span>
    @XmlAttribute(name = &quot;type&quot;)
    protected ScanType type;
    @XmlAttribute(name = &quot;order&quot;)
    protected ScanOrder order;

    @Override
    public String toString() {
<span class="nc" id="L75">      return type.toString();</span>
    }
  }

  public VideoStreamImpl() {
<span class="fc" id="L80">    this(UUID.randomUUID().toString());</span>
<span class="fc" id="L81">  }</span>

  public VideoStreamImpl(String identifier) {
<span class="fc" id="L84">    super(identifier);</span>
<span class="fc" id="L85">  }</span>

  /**
   * Create a video stream from the XML manifest.
   *
   * @param streamIdHint
   *          stream ID that has to be used if the manifest does not provide one. This is the case when reading an old
   *          manifest.
   */
  public static VideoStreamImpl fromManifest(String streamIdHint, Node node, XPath xpath) throws IllegalStateException,
          XPathException {
    // Create stream
<span class="nc" id="L97">    String sid = (String) xpath.evaluate(&quot;@id&quot;, node, XPathConstants.STRING);</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">    if (StringUtils.isEmpty(sid)) {</span>
<span class="nc" id="L99">      sid = streamIdHint;</span>
    }
<span class="nc" id="L101">    VideoStreamImpl vs = new VideoStreamImpl(sid);</span>
<span class="nc" id="L102">    partialFromManifest(vs, node, xpath);</span>

    // bit rate
    try {
<span class="nc" id="L106">      String strBitrate = (String) xpath.evaluate(&quot;bitrate/text()&quot;, node, XPathConstants.STRING);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">      if (StringUtils.isNotEmpty(strBitrate))</span>
<span class="nc" id="L108">        vs.bitRate = Float.valueOf(strBitrate.trim());</span>
<span class="nc" id="L109">    } catch (NumberFormatException e) {</span>
<span class="nc" id="L110">      throw new IllegalStateException(&quot;Bit rate was malformatted: &quot; + e.getMessage());</span>
<span class="nc" id="L111">    }</span>

    // frame rate
    try {
<span class="nc" id="L115">      String strFrameRate = (String) xpath.evaluate(&quot;framerate/text()&quot;, node, XPathConstants.STRING);</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">      if (StringUtils.isNotEmpty(strFrameRate))</span>
<span class="nc" id="L117">        vs.frameRate = Float.valueOf(strFrameRate.trim());</span>
<span class="nc" id="L118">    } catch (NumberFormatException e) {</span>
<span class="nc" id="L119">      throw new IllegalStateException(&quot;Frame rate was malformatted: &quot; + e.getMessage());</span>
<span class="nc" id="L120">    }</span>

    // resolution
<span class="nc" id="L123">    String res = (String) xpath.evaluate(&quot;resolution/text()&quot;, node, XPathConstants.STRING);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">    if (StringUtils.isNotEmpty(res)) {</span>
<span class="nc" id="L125">      vs.resolution = res;</span>
    }

    // interlacing
<span class="nc" id="L129">    String scanType = (String) xpath.evaluate(&quot;scantype/@type&quot;, node, XPathConstants.STRING);</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">    if (StringUtils.isNotEmpty(scanType)) {</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">      if (vs.scanType == null)</span>
<span class="nc" id="L132">        vs.scanType = new Scan();</span>
<span class="nc" id="L133">      vs.scanType.type = ScanType.fromString(scanType);</span>
    }

<span class="nc" id="L136">    String scanOrder = (String) xpath.evaluate(&quot;interlacing/@order&quot;, node, XPathConstants.STRING);</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">    if (StringUtils.isNotEmpty(scanOrder)) {</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">      if (vs.scanType == null)</span>
<span class="nc" id="L139">        vs.scanType = new Scan();</span>
<span class="nc" id="L140">      vs.scanType.order = ScanOrder.fromString(scanOrder);</span>
    }

<span class="nc" id="L143">    return vs;</span>
  }

  /**
   * @see org.opencastproject.mediapackage.ManifestContributor#toManifest(org.w3c.dom.Document,
   *      org.opencastproject.mediapackage.MediaPackageSerializer)
   */
  @Override
  public Node toManifest(Document document, MediaPackageSerializer serializer) {
<span class="nc" id="L152">    Element node = document.createElement(&quot;video&quot;);</span>
<span class="nc" id="L153">    addCommonManifestElements(node, document, serializer);</span>

    // Resolution
<span class="nc" id="L156">    Element resolutionNode = document.createElement(&quot;resolution&quot;);</span>
<span class="nc" id="L157">    resolutionNode.appendChild(document.createTextNode(resolution));</span>
<span class="nc" id="L158">    node.appendChild(resolutionNode);</span>

    // Interlacing
<span class="nc bnc" id="L161" title="All 2 branches missed.">    if (scanType != null) {</span>
<span class="nc" id="L162">      Element interlacingNode = document.createElement(&quot;scantype&quot;);</span>
<span class="nc" id="L163">      interlacingNode.setAttribute(&quot;type&quot;, scanType.toString());</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">      if (scanType.order != null)</span>
<span class="nc" id="L165">        interlacingNode.setAttribute(&quot;order&quot;, scanType.order.toString());</span>
<span class="nc" id="L166">      node.appendChild(interlacingNode);</span>
    }

    // Bit rate
<span class="nc bnc" id="L170" title="All 2 branches missed.">    if (bitRate != null) {</span>
<span class="nc" id="L171">      Element bitrateNode = document.createElement(&quot;bitrate&quot;);</span>
<span class="nc" id="L172">      bitrateNode.appendChild(document.createTextNode(bitRate.toString()));</span>
<span class="nc" id="L173">      node.appendChild(bitrateNode);</span>
    }

    // Frame rate
<span class="nc bnc" id="L177" title="All 2 branches missed.">    if (frameRate != null) {</span>
<span class="nc" id="L178">      Element framerateNode = document.createElement(&quot;framerate&quot;);</span>
<span class="nc" id="L179">      framerateNode.appendChild(document.createTextNode(frameRate.toString()));</span>
<span class="nc" id="L180">      node.appendChild(framerateNode);</span>
    }

<span class="nc" id="L183">    return node;</span>
  }

  @Override
  public Float getBitRate() {
<span class="fc" id="L188">    return bitRate;</span>
  }

  @Override
  public Float getFrameRate() {
<span class="fc" id="L193">    return frameRate;</span>
  }

  @Override
  public Integer getFrameWidth() {
    try {
<span class="fc" id="L199">      String[] s = resolution.trim().split(&quot;x&quot;);</span>
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">      if (s.length != 2)</span>
<span class="nc" id="L201">        throw new IllegalStateException(&quot;video size must be of the form &lt;hsize&gt;x&lt;vsize&gt;, found &quot; + resolution);</span>
<span class="fc" id="L202">      return Integer.valueOf(s[0].trim());</span>
<span class="nc" id="L203">    } catch (NumberFormatException e) {</span>
<span class="nc" id="L204">      throw new IllegalStateException(&quot;Resolution was malformatted: &quot; + e.getMessage());</span>
    }
  }

  @Override
  public Integer getFrameHeight() {
    try {
<span class="fc" id="L211">      String[] s = resolution.trim().split(&quot;x&quot;);</span>
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">      if (s.length != 2)</span>
<span class="nc" id="L213">        throw new IllegalStateException(&quot;video size must be of the form &lt;hsize&gt;x&lt;vsize&gt;, found &quot; + resolution);</span>
<span class="fc" id="L214">      return Integer.valueOf(s[1].trim());</span>
<span class="nc" id="L215">    } catch (NumberFormatException e) {</span>
<span class="nc" id="L216">      throw new IllegalStateException(&quot;Resolution was malformatted: &quot; + e.getMessage());</span>
    }
  }

  @Override
  public ScanType getScanType() {
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">    return scanType != null ? scanType.type : null;</span>
  }

  @Override
  public ScanOrder getScanOrder() {
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">    return scanType != null ? scanType.order : null;</span>
  }

  // Setter

  public void setBitRate(Float bitRate) {
<span class="fc" id="L233">    this.bitRate = bitRate;</span>
<span class="fc" id="L234">  }</span>

  public void setFrameRate(Float frameRate) {
<span class="fc" id="L237">    this.frameRate = frameRate;</span>
<span class="fc" id="L238">  }</span>

  public void setFrameWidth(Integer frameWidth) {
<span class="fc" id="L241">    this.frameWidth = frameWidth;</span>
<span class="pc bpc" id="L242" title="1 of 4 branches missed.">    if (frameWidth != null &amp;&amp; frameHeight != null)</span>
<span class="fc" id="L243">      updateResolution();</span>
<span class="fc" id="L244">  }</span>

  public void setFrameHeight(Integer frameHeight) {
<span class="fc" id="L247">    this.frameHeight = frameHeight;</span>
<span class="pc bpc" id="L248" title="1 of 4 branches missed.">    if (frameWidth != null &amp;&amp; frameHeight != null)</span>
<span class="fc" id="L249">      updateResolution();</span>
<span class="fc" id="L250">  }</span>

  private void updateResolution() {
<span class="fc" id="L253">    resolution = frameWidth.toString() + &quot;x&quot; + frameHeight.toString();</span>
<span class="fc" id="L254">  }</span>

  public void setScanType(ScanType scanType) {
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">    if (scanType == null)</span>
<span class="fc" id="L258">      return;</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">    if (this.scanType == null)</span>
<span class="nc" id="L260">      this.scanType = new Scan();</span>
<span class="nc" id="L261">    this.scanType.type = scanType;</span>
<span class="nc" id="L262">  }</span>

  public void setScanOrder(ScanOrder scanOrder) {
<span class="pc bpc" id="L265" title="1 of 2 branches missed.">    if (scanOrder == null)</span>
<span class="fc" id="L266">      return;</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">    if (this.scanType == null)</span>
<span class="nc" id="L268">      this.scanType = new Scan();</span>
<span class="nc" id="L269">    this.scanType.order = scanOrder;</span>
<span class="nc" id="L270">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>