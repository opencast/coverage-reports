<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>MediaPackageElementBuilderImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-common</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.mediapackage</a> &gt; <span class="el_source">MediaPackageElementBuilderImpl.java</span></div><h1>MediaPackageElementBuilderImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */


package org.opencastproject.mediapackage;

import org.opencastproject.mediapackage.elementbuilder.AttachmentBuilderPlugin;
import org.opencastproject.mediapackage.elementbuilder.CatalogBuilderPlugin;
import org.opencastproject.mediapackage.elementbuilder.MediaPackageElementBuilderPlugin;
import org.opencastproject.mediapackage.elementbuilder.PublicationBuilderPlugin;
import org.opencastproject.mediapackage.elementbuilder.TrackBuilderPlugin;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.w3c.dom.Node;

import java.net.URI;
import java.util.ArrayList;
import java.util.List;

import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathExpressionException;
import javax.xml.xpath.XPathFactory;

/**
 * Default implementation for a media package element builder.
 */
public class MediaPackageElementBuilderImpl implements MediaPackageElementBuilder {

  /** The list of plugins */
<span class="fc" id="L49">  private List&lt;Class&lt;? extends MediaPackageElementBuilderPlugin&gt;&gt; plugins = null;</span>

  /** the logging facility provided by log4j */
<span class="fc" id="L52">  private static final Logger logger = LoggerFactory.getLogger(MediaPackageElementBuilderImpl.class.getName());</span>

  // Create the list of available element builder pugins
<span class="fc" id="L55">  public MediaPackageElementBuilderImpl() {</span>
<span class="fc" id="L56">    plugins = new ArrayList&lt;Class&lt;? extends MediaPackageElementBuilderPlugin&gt;&gt;();</span>
<span class="fc" id="L57">    plugins.add(AttachmentBuilderPlugin.class);</span>
<span class="fc" id="L58">    plugins.add(CatalogBuilderPlugin.class);</span>
<span class="fc" id="L59">    plugins.add(TrackBuilderPlugin.class);</span>
<span class="fc" id="L60">    plugins.add(PublicationBuilderPlugin.class);</span>
<span class="fc" id="L61">  }</span>

  /**
   * @see org.opencastproject.mediapackage.MediaPackageElementBuilder#elementFromURI(URI)
   */
  public MediaPackageElement elementFromURI(URI uri) throws UnsupportedElementException {
<span class="fc" id="L67">    return elementFromURI(uri, null, null);</span>
  }

  /**
   * @see org.opencastproject.mediapackage.MediaPackageElementBuilder#elementFromURI(URI,
   *      org.opencastproject.mediapackage.MediaPackageElement.Type ,
   *      org.opencastproject.mediapackage.MediaPackageElementFlavor)
   */
  public MediaPackageElement elementFromURI(URI uri, MediaPackageElement.Type type, MediaPackageElementFlavor flavor)
          throws UnsupportedElementException {

    // Feed the file to the element builder plugins
<span class="fc" id="L79">    List&lt;MediaPackageElementBuilderPlugin&gt; candidates = new ArrayList&lt;MediaPackageElementBuilderPlugin&gt;();</span>
    {
<span class="fc" id="L81">      MediaPackageElementBuilderPlugin plugin = null;</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">      for (Class&lt;? extends MediaPackageElementBuilderPlugin&gt; pluginClass : plugins) {</span>
<span class="fc" id="L83">        plugin = createPlugin(pluginClass);</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">        if (plugin.accept(uri, type, flavor))</span>
<span class="fc" id="L85">          candidates.add(plugin);</span>
<span class="fc" id="L86">      }</span>
    }

    // Check the plugins
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">    if (candidates.size() == 0) {</span>
<span class="nc" id="L91">      throw new UnsupportedElementException(&quot;No suitable element builder plugin found for &quot; + uri);</span>
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">    } else if (candidates.size() &gt; 1) {</span>
<span class="nc" id="L93">      StringBuffer buf = new StringBuffer();</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">      for (MediaPackageElementBuilderPlugin plugin : candidates) {</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (buf.length() &gt; 0)</span>
<span class="nc" id="L96">          buf.append(&quot;, &quot;);</span>
<span class="nc" id="L97">        buf.append(plugin.toString());</span>
<span class="nc" id="L98">      }</span>
<span class="nc" id="L99">      logger.debug(&quot;More than one element builder plugin with the same priority claims responsibilty for &quot; + uri + &quot;: &quot;</span>
<span class="nc" id="L100">              + buf.toString());</span>
    }

    // Create media package element depending on mime type flavor
<span class="fc" id="L104">    MediaPackageElementBuilderPlugin builderPlugin = candidates.get(0);</span>
<span class="fc" id="L105">    MediaPackageElement element = builderPlugin.elementFromURI(uri);</span>
<span class="fc" id="L106">    element.setFlavor(flavor);</span>
<span class="fc" id="L107">    builderPlugin.destroy();</span>
<span class="fc" id="L108">    return element;</span>
  }

  /**
   * @see org.opencastproject.mediapackage.MediaPackageElementBuilder#elementFromManifest(org.w3c.dom.Node,
   *      org.opencastproject.mediapackage.MediaPackageSerializer)
   */
  public MediaPackageElement elementFromManifest(Node node, MediaPackageSerializer serializer)
          throws UnsupportedElementException {
<span class="fc" id="L117">    List&lt;MediaPackageElementBuilderPlugin&gt; candidates = new ArrayList&lt;MediaPackageElementBuilderPlugin&gt;();</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">    for (Class&lt;? extends MediaPackageElementBuilderPlugin&gt; pluginClass : plugins) {</span>
<span class="fc" id="L119">      MediaPackageElementBuilderPlugin plugin = createPlugin(pluginClass);</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">      if (plugin.accept(node)) {</span>
<span class="fc" id="L121">        candidates.add(plugin);</span>
      }
<span class="fc" id="L123">    }</span>

    // Check the plugins
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">    if (candidates.size() == 0) {</span>
<span class="nc" id="L127">      throw new UnsupportedElementException(&quot;No suitable element builder plugin found for node &quot; + node.getNodeName());</span>
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">    } else if (candidates.size() &gt; 1) {</span>
<span class="nc" id="L129">      StringBuffer buf = new StringBuffer();</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">      for (MediaPackageElementBuilderPlugin plugin : candidates) {</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (buf.length() &gt; 0)</span>
<span class="nc" id="L132">          buf.append(&quot;, &quot;);</span>
<span class="nc" id="L133">        buf.append(plugin.toString());</span>
<span class="nc" id="L134">      }</span>
<span class="nc" id="L135">      XPath xpath = XPathFactory.newInstance().newXPath();</span>
<span class="nc" id="L136">      String name = node.getNodeName();</span>
<span class="nc" id="L137">      String elementFlavor = null;</span>
      try {
<span class="nc" id="L139">        elementFlavor = xpath.evaluate(&quot;@type&quot;, node);</span>
<span class="nc" id="L140">      } catch (XPathExpressionException e) {</span>
<span class="nc" id="L141">        elementFlavor = &quot;(unknown)&quot;;</span>
<span class="nc" id="L142">      }</span>
<span class="nc" id="L143">      logger.debug(&quot;More than one element builder plugin claims responsability for &quot; + name + &quot; of flavor &quot;</span>
<span class="nc" id="L144">              + elementFlavor + &quot;: &quot; + buf.toString());</span>
    }

    // Create a new media package element
<span class="fc" id="L148">    MediaPackageElementBuilderPlugin builderPlugin = candidates.get(0);</span>
<span class="fc" id="L149">    MediaPackageElement element = builderPlugin.elementFromManifest(node, serializer);</span>
<span class="fc" id="L150">    builderPlugin.destroy();</span>
<span class="fc" id="L151">    return element;</span>
  }

  /**
   * @see org.opencastproject.mediapackage.MediaPackageElementBuilder#newElement(org.opencastproject.mediapackage.MediaPackageElement.Type
   *      , org.opencastproject.mediapackage.MediaPackageElementFlavor)
   */
  public MediaPackageElement newElement(MediaPackageElement.Type type, MediaPackageElementFlavor flavor) {
<span class="fc" id="L159">    List&lt;MediaPackageElementBuilderPlugin&gt; candidates = new ArrayList&lt;MediaPackageElementBuilderPlugin&gt;();</span>
<span class="fc bfc" id="L160" title="All 2 branches covered.">    for (Class&lt;? extends MediaPackageElementBuilderPlugin&gt; pluginClass : plugins) {</span>
<span class="fc" id="L161">      MediaPackageElementBuilderPlugin plugin = createPlugin(pluginClass);</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">      if (plugin.accept(type, flavor)) {</span>
<span class="fc" id="L163">        candidates.add(plugin);</span>
      }
<span class="fc" id="L165">    }</span>

    // Check the plugins
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">    if (candidates.size() == 0)</span>
<span class="nc" id="L169">      return null;</span>
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">    else if (candidates.size() &gt; 1) {</span>
<span class="nc" id="L171">      StringBuffer buf = new StringBuffer();</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">      for (MediaPackageElementBuilderPlugin plugin : candidates) {</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">        if (buf.length() &gt; 0)</span>
<span class="nc" id="L174">          buf.append(&quot;, &quot;);</span>
<span class="nc" id="L175">        buf.append(plugin.toString());</span>
<span class="nc" id="L176">      }</span>
<span class="nc" id="L177">      logger.debug(&quot;More than one element builder plugin claims responsibilty for &quot; + flavor + &quot;: &quot; + buf.toString());</span>
    }

    // Create a new media package element
<span class="fc" id="L181">    MediaPackageElementBuilderPlugin builderPlugin = candidates.get(0);</span>
<span class="fc" id="L182">    MediaPackageElement element = builderPlugin.newElement(type, flavor);</span>
<span class="fc" id="L183">    builderPlugin.destroy();</span>
<span class="fc" id="L184">    return element;</span>
  }

  /**
   * Creates and initializes a new builder plugin.
   */
  private MediaPackageElementBuilderPlugin createPlugin(Class&lt;? extends MediaPackageElementBuilderPlugin&gt; clazz) {
<span class="fc" id="L191">    MediaPackageElementBuilderPlugin plugin = null;</span>
    try {
<span class="fc" id="L193">      plugin = clazz.newInstance();</span>
<span class="nc" id="L194">    } catch (InstantiationException e) {</span>
<span class="nc" id="L195">      throw new RuntimeException(&quot;Cannot instantiate media package element builder plugin of type &quot; + clazz.getName()</span>
              + &quot;. Did you provide a parameterless constructor?&quot;, e);
<span class="nc" id="L197">    } catch (IllegalAccessException e) {</span>
<span class="nc" id="L198">      throw new RuntimeException(e);</span>
<span class="fc" id="L199">    }</span>
    try {
<span class="fc" id="L201">      plugin.init();</span>
<span class="nc" id="L202">    } catch (Exception e) {</span>
<span class="nc" id="L203">      throw new RuntimeException(&quot;An error occured while setting up media package element builder plugin &quot; + plugin);</span>
<span class="fc" id="L204">    }</span>
<span class="fc" id="L205">    return plugin;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>