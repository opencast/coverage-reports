<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>MediaPackageParser.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-common</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.mediapackage</a> &gt; <span class="el_source">MediaPackageParser.java</span></div><h1>MediaPackageParser.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.mediapackage;

import static org.opencastproject.util.data.functions.Misc.chuck;

import org.opencastproject.util.DateTimeSupport;
import org.opencastproject.util.XmlSafeParser;

import org.apache.commons.lang3.StringUtils;
import org.codehaus.jettison.mapped.Configuration;
import org.codehaus.jettison.mapped.MappedNamespaceConvention;
import org.codehaus.jettison.mapped.MappedXMLStreamWriter;
import org.w3c.dom.Document;
import org.w3c.dom.Element;

import java.io.StringWriter;
import java.util.ArrayList;
import java.util.Collections;
import java.util.LinkedList;
import java.util.List;

import javax.xml.bind.JAXBException;
import javax.xml.bind.Marshaller;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.stream.XMLStreamException;
import javax.xml.stream.XMLStreamWriter;

/**
 * Convenience implementation that supports serializing and deserializing media packages.
 */
public final class MediaPackageParser {

  /**
   * Private constructor to prohibit instances of this static utility class.
   */
  private MediaPackageParser() {
    // Nothing to do
  }

  /**
   * Serializes the media package to a string.
   *
   * @param mediaPackage
   *          the media package
   * @return the serialized media package
   */
  public static String getAsXml(MediaPackage mediaPackage) {
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">    if (mediaPackage == null)</span>
<span class="nc" id="L71">      throw new IllegalArgumentException(&quot;Mediapackage must not be null&quot;);</span>
    try {
<span class="fc" id="L73">      Marshaller marshaller = MediaPackageImpl.context.createMarshaller();</span>
<span class="fc" id="L74">      marshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, false);</span>
<span class="fc" id="L75">      StringWriter writer = new StringWriter();</span>
<span class="fc" id="L76">      marshaller.marshal(mediaPackage, writer);</span>
<span class="fc" id="L77">      return writer.toString();</span>
<span class="nc" id="L78">    } catch (JAXBException e) {</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">      throw new IllegalStateException(e.getLinkedException() != null ? e.getLinkedException() : e);</span>
    }
  }

  /**
   * Serializes the media package to a JSON string.
   *
   * @param mediaPackage
   *          the media package
   * @return the serialized media package
   */
  public static String getAsJSON(MediaPackage mediaPackage) {
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">    if (mediaPackage == null) {</span>
<span class="nc" id="L92">      throw new IllegalArgumentException(&quot;Mediapackage must not be null&quot;);</span>
    }
    try {
<span class="fc" id="L95">      Marshaller marshaller = MediaPackageImpl.context.createMarshaller();</span>

<span class="fc" id="L97">      Configuration config = new Configuration();</span>
<span class="fc" id="L98">      config.setSupressAtAttributes(true);</span>
<span class="fc" id="L99">      MappedNamespaceConvention con = new MappedNamespaceConvention(config);</span>
<span class="fc" id="L100">      StringWriter writer = new StringWriter();</span>
<span class="fc" id="L101">      XMLStreamWriter xmlStreamWriter = new MappedXMLStreamWriter(con, writer) {</span>
        @Override
        public void writeStartElement(String prefix, String local, String uri) throws XMLStreamException {
<span class="fc" id="L104">          super.writeStartElement(&quot;&quot;, local, &quot;&quot;);</span>
<span class="fc" id="L105">        }</span>

        @Override
        public void writeStartElement(String uri, String local) throws XMLStreamException {
<span class="nc" id="L109">          super.writeStartElement(&quot;&quot;, local, &quot;&quot;);</span>
<span class="nc" id="L110">        }</span>

        @Override
        public void setPrefix(String pfx, String uri) throws XMLStreamException {
<span class="nc" id="L114">        }</span>

        @Override
        public void setDefaultNamespace(String uri) throws XMLStreamException {
<span class="nc" id="L118">        }</span>
      };

<span class="fc" id="L121">      marshaller.marshal(mediaPackage, xmlStreamWriter);</span>
<span class="fc" id="L122">      return writer.toString();</span>
<span class="nc" id="L123">    } catch (JAXBException e) {</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">      throw new IllegalStateException(e.getLinkedException() != null ? e.getLinkedException() : e);</span>
    }
  }

  /** Serializes a media package to a {@link Document} without any further processing. */
  public static Document getAsXmlDocument(MediaPackage mp) {
    try {
<span class="nc" id="L131">      final Marshaller marshaller = MediaPackageImpl.context.createMarshaller();</span>
<span class="nc" id="L132">      final Document doc = newDocument();</span>
<span class="nc" id="L133">      marshaller.marshal(mp, doc);</span>
<span class="nc" id="L134">      return doc;</span>
<span class="nc" id="L135">    } catch (JAXBException e) {</span>
<span class="nc" id="L136">      return chuck(e);</span>
    }
  }

  /** Create a new DOM document. */
  private static Document newDocument() {
<span class="nc" id="L142">    final DocumentBuilderFactory docBuilderFactory = XmlSafeParser.newDocumentBuilderFactory();</span>
<span class="nc" id="L143">    docBuilderFactory.setNamespaceAware(true);</span>
    try {
<span class="nc" id="L145">      return docBuilderFactory.newDocumentBuilder().newDocument();</span>
<span class="nc" id="L146">    } catch (ParserConfigurationException e) {</span>
<span class="nc" id="L147">      return chuck(e);</span>
    }
  }

  /**
   * Serializes the media package to a {@link org.w3c.dom.Document}.
   * &lt;p&gt;
   * todo Implementation is currently defective since it misses various properties. See
   * http://opencast.jira.com/browse/MH-9489 Use {@link #getAsXmlDocument(MediaPackage)} instead if you do not need a
   * serializer.
   *
   * @param mediaPackage
   *          the mediapackage
   * @param serializer
   *          the serializer
   * @return the serialized media package
   * @throws MediaPackageException
   *           if serializing fails
   */
  public static Document getAsXml(MediaPackage mediaPackage, MediaPackageSerializer serializer)
          throws MediaPackageException {
<span class="nc" id="L168">    DocumentBuilderFactory docBuilderFactory = XmlSafeParser.newDocumentBuilderFactory();</span>
<span class="nc" id="L169">    docBuilderFactory.setNamespaceAware(true);</span>

<span class="nc" id="L171">    DocumentBuilder docBuilder = null;</span>
    try {
<span class="nc" id="L173">      docBuilder = docBuilderFactory.newDocumentBuilder();</span>
<span class="nc" id="L174">    } catch (ParserConfigurationException e1) {</span>
<span class="nc" id="L175">      throw new MediaPackageException(e1);</span>
<span class="nc" id="L176">    }</span>

<span class="nc" id="L178">    Document doc = docBuilder.newDocument();</span>

    // Root element &quot;mediapackage&quot;
<span class="nc" id="L181">    Element mpXml = doc.createElement(&quot;mediapackage&quot;);</span>
<span class="nc" id="L182">    doc.appendChild(mpXml);</span>

    // Handle
<span class="nc bnc" id="L185" title="All 2 branches missed.">    if (mediaPackage.getIdentifier() != null)</span>
<span class="nc" id="L186">      mpXml.setAttribute(&quot;id&quot;, mediaPackage.getIdentifier().toString());</span>

    // Start time
<span class="nc bnc" id="L189" title="All 4 branches missed.">    if (mediaPackage.getDate() != null &amp;&amp; mediaPackage.getDate().getTime() &gt; 0)</span>
<span class="nc" id="L190">      mpXml.setAttribute(&quot;start&quot;, DateTimeSupport.toUTC(mediaPackage.getDate().getTime()));</span>

    // Duration
<span class="nc bnc" id="L193" title="All 2 branches missed.">    if (mediaPackage.getDuration() != null)</span>
<span class="nc" id="L194">      mpXml.setAttribute(&quot;duration&quot;, Long.toString(mediaPackage.getDuration()));</span>

    // Separate the media package members
<span class="nc" id="L197">    List&lt;Track&gt; tracks = new ArrayList&lt;Track&gt;();</span>
<span class="nc" id="L198">    List&lt;Attachment&gt; attachments = new ArrayList&lt;Attachment&gt;();</span>
<span class="nc" id="L199">    List&lt;Catalog&gt; metadata = new ArrayList&lt;Catalog&gt;();</span>
<span class="nc" id="L200">    List&lt;MediaPackageElement&gt; others = new ArrayList&lt;MediaPackageElement&gt;();</span>

    // Sort media package elements
<span class="nc bnc" id="L203" title="All 2 branches missed.">    for (MediaPackageElement e : mediaPackage.elements()) {</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">      if (e instanceof Track)</span>
<span class="nc" id="L205">        tracks.add((Track) e);</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">      else if (e instanceof Attachment)</span>
<span class="nc" id="L207">        attachments.add((Attachment) e);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">      else if (e instanceof Catalog)</span>
<span class="nc" id="L209">        metadata.add((Catalog) e);</span>
      else
<span class="nc" id="L211">        others.add(e);</span>
<span class="nc" id="L212">    }</span>

    // Tracks
<span class="nc bnc" id="L215" title="All 2 branches missed.">    if (tracks.size() &gt; 0) {</span>
<span class="nc" id="L216">      Element tracksNode = doc.createElement(&quot;media&quot;);</span>
<span class="nc" id="L217">      Collections.sort(tracks);</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">      for (Track t : tracks) {</span>
<span class="nc" id="L219">        tracksNode.appendChild(t.toManifest(doc, serializer));</span>
<span class="nc" id="L220">      }</span>
<span class="nc" id="L221">      mpXml.appendChild(tracksNode);</span>
    }

    // Metadata
<span class="nc bnc" id="L225" title="All 2 branches missed.">    if (metadata.size() &gt; 0) {</span>
<span class="nc" id="L226">      Element metadataNode = doc.createElement(&quot;metadata&quot;);</span>
<span class="nc" id="L227">      Collections.sort(metadata);</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">      for (Catalog m : metadata) {</span>
<span class="nc" id="L229">        metadataNode.appendChild(m.toManifest(doc, serializer));</span>
<span class="nc" id="L230">      }</span>
<span class="nc" id="L231">      mpXml.appendChild(metadataNode);</span>
    }

    // Attachments
<span class="nc bnc" id="L235" title="All 2 branches missed.">    if (attachments.size() &gt; 0) {</span>
<span class="nc" id="L236">      Element attachmentsNode = doc.createElement(&quot;attachments&quot;);</span>
<span class="nc" id="L237">      Collections.sort(attachments);</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">      for (Attachment a : attachments) {</span>
<span class="nc" id="L239">        attachmentsNode.appendChild(a.toManifest(doc, serializer));</span>
<span class="nc" id="L240">      }</span>
<span class="nc" id="L241">      mpXml.appendChild(attachmentsNode);</span>
    }

    // Unclassified
<span class="nc bnc" id="L245" title="All 2 branches missed.">    if (others.size() &gt; 0) {</span>
<span class="nc" id="L246">      Element othersNode = doc.createElement(&quot;unclassified&quot;);</span>
<span class="nc" id="L247">      Collections.sort(others);</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">      for (MediaPackageElement e : others) {</span>
<span class="nc" id="L249">        othersNode.appendChild(e.toManifest(doc, serializer));</span>
<span class="nc" id="L250">      }</span>
<span class="nc" id="L251">      mpXml.appendChild(othersNode);</span>
    }

<span class="nc" id="L254">    return mpXml.getOwnerDocument();</span>
  }

  /**
   * Parses the media package and returns its object representation.
   *
   * @param xml
   *          the serialized media package
   * @return the media package instance
   * @throws MediaPackageException
   *           if de-serializing the media package fails
   */
  public static MediaPackage getFromXml(String xml) throws MediaPackageException {
<span class="fc" id="L267">    MediaPackageBuilder builder = MediaPackageBuilderFactory.newInstance().newMediaPackageBuilder();</span>
<span class="fc" id="L268">    return builder.loadFromXml(xml);</span>
  }

  /**
   * Serializes media package list to a string.
   *
   * @param mediaPackages
   *          media package list to be serialized
   * @return serialized media package list
   * @throws MediaPackageException
   *           if serialization fails
   */
  public static String getArrayAsXml(List&lt;MediaPackage&gt; mediaPackages) throws MediaPackageException {
    try {
<span class="nc" id="L282">      StringBuilder builder = new StringBuilder();</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">      if (mediaPackages.isEmpty())</span>
<span class="nc" id="L284">        return builder.toString();</span>
<span class="nc" id="L285">      builder.append(getAsXml(mediaPackages.get(0)));</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">      for (int i = 1; i &lt; mediaPackages.size(); i++) {</span>
<span class="nc" id="L287">        builder.append(&quot;###&quot;);</span>
<span class="nc" id="L288">        builder.append(getAsXml(mediaPackages.get(i)));</span>
      }
<span class="nc" id="L290">      return builder.toString();</span>
<span class="nc" id="L291">    } catch (Exception e) {</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">      if (e instanceof MediaPackageException) {</span>
<span class="nc" id="L293">        throw (MediaPackageException) e;</span>
      } else {
<span class="nc" id="L295">        throw new MediaPackageException(e);</span>
      }
    }
  }

  /**
   * Parses the serialized media package list.
   *
   * @param xml
   *          String to be parsed
   * @return parsed media package list
   * @throws MediaPackageException
   *           if de-serialization fails
   */
  public static List&lt;MediaPackage&gt; getArrayFromXml(String xml) throws MediaPackageException {
    try {
<span class="nc" id="L311">      List&lt;MediaPackage&gt; mediaPackages = new LinkedList&lt;MediaPackage&gt;();</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">      if (StringUtils.isBlank(xml))</span>
<span class="nc" id="L313">        return mediaPackages;</span>
<span class="nc" id="L314">      String[] xmlArray = xml.split(&quot;###&quot;);</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">      for (String xmlElement : xmlArray) {</span>
<span class="nc" id="L316">        mediaPackages.add(getFromXml(xmlElement.trim()));</span>
      }
<span class="nc" id="L318">      return mediaPackages;</span>
<span class="nc" id="L319">    } catch (Exception e) {</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">      if (e instanceof MediaPackageException) {</span>
<span class="nc" id="L321">        throw (MediaPackageException) e;</span>
      } else {
<span class="nc" id="L323">        throw new MediaPackageException(e);</span>
      }
    }
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>