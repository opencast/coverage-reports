<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="" lang="">
<head><meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<title>AbstractEventEndpoint xref</title>
<link type="text/css" rel="stylesheet" href="../../../../stylesheet.css" />
</head>
<body>
<div id="overview"><a href="../../../../../apidocs/org/opencastproject/adminui/endpoint/AbstractEventEndpoint.html">View Javadoc</a></div><pre>
<a class="jxr_linenumber" name="L1" href="#L1">1</a>   <em class="jxr_comment">/*</em>
<a class="jxr_linenumber" name="L2" href="#L2">2</a>   <em class="jxr_comment"> * Licensed to The Apereo Foundation under one or more contributor license</em>
<a class="jxr_linenumber" name="L3" href="#L3">3</a>   <em class="jxr_comment"> * agreements. See the NOTICE file distributed with this work for additional</em>
<a class="jxr_linenumber" name="L4" href="#L4">4</a>   <em class="jxr_comment"> * information regarding copyright ownership.</em>
<a class="jxr_linenumber" name="L5" href="#L5">5</a>   <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="L6" href="#L6">6</a>   <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="L7" href="#L7">7</a>   <em class="jxr_comment"> * The Apereo Foundation licenses this file to you under the Educational</em>
<a class="jxr_linenumber" name="L8" href="#L8">8</a>   <em class="jxr_comment"> * Community License, Version 2.0 (the "License"); you may not use this file</em>
<a class="jxr_linenumber" name="L9" href="#L9">9</a>   <em class="jxr_comment"> * except in compliance with the License. You may obtain a copy of the License</em>
<a class="jxr_linenumber" name="L10" href="#L10">10</a>  <em class="jxr_comment"> * at:</em>
<a class="jxr_linenumber" name="L11" href="#L11">11</a>  <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="L12" href="#L12">12</a>  <em class="jxr_comment"> *   <a href="http://opensource.org/licenses/ecl2.txt" target="alexandria_uri">http://opensource.org/licenses/ecl2.txt</a></em>
<a class="jxr_linenumber" name="L13" href="#L13">13</a>  <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="L14" href="#L14">14</a>  <em class="jxr_comment"> * Unless required by applicable law or agreed to in writing, software</em>
<a class="jxr_linenumber" name="L15" href="#L15">15</a>  <em class="jxr_comment"> * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT</em>
<a class="jxr_linenumber" name="L16" href="#L16">16</a>  <em class="jxr_comment"> * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the</em>
<a class="jxr_linenumber" name="L17" href="#L17">17</a>  <em class="jxr_comment"> * License for the specific language governing permissions and limitations under</em>
<a class="jxr_linenumber" name="L18" href="#L18">18</a>  <em class="jxr_comment"> * the License.</em>
<a class="jxr_linenumber" name="L19" href="#L19">19</a>  <em class="jxr_comment"> *</em>
<a class="jxr_linenumber" name="L20" href="#L20">20</a>  <em class="jxr_comment"> */</em>
<a class="jxr_linenumber" name="L21" href="#L21">21</a>  
<a class="jxr_linenumber" name="L22" href="#L22">22</a>  <strong class="jxr_keyword">package</strong> org.opencastproject.adminui.endpoint;
<a class="jxr_linenumber" name="L23" href="#L23">23</a>  
<a class="jxr_linenumber" name="L24" href="#L24">24</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> com.entwinemedia.fn.Stream.$;
<a class="jxr_linenumber" name="L25" href="#L25">25</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> com.entwinemedia.fn.data.Opt.nul;
<a class="jxr_linenumber" name="L26" href="#L26">26</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> com.entwinemedia.fn.data.json.Jsons.BLANK;
<a class="jxr_linenumber" name="L27" href="#L27">27</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> com.entwinemedia.fn.data.json.Jsons.NULL;
<a class="jxr_linenumber" name="L28" href="#L28">28</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> com.entwinemedia.fn.data.json.Jsons.arr;
<a class="jxr_linenumber" name="L29" href="#L29">29</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> com.entwinemedia.fn.data.json.Jsons.f;
<a class="jxr_linenumber" name="L30" href="#L30">30</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> com.entwinemedia.fn.data.json.Jsons.obj;
<a class="jxr_linenumber" name="L31" href="#L31">31</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> com.entwinemedia.fn.data.json.Jsons.v;
<a class="jxr_linenumber" name="L32" href="#L32">32</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> java.lang.String.format;
<a class="jxr_linenumber" name="L33" href="#L33">33</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> javax.servlet.http.HttpServletResponse.SC_ACCEPTED;
<a class="jxr_linenumber" name="L34" href="#L34">34</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;
<a class="jxr_linenumber" name="L35" href="#L35">35</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> javax.servlet.http.HttpServletResponse.SC_INTERNAL_SERVER_ERROR;
<a class="jxr_linenumber" name="L36" href="#L36">36</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> javax.servlet.http.HttpServletResponse.SC_NOT_FOUND;
<a class="jxr_linenumber" name="L37" href="#L37">37</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> javax.servlet.http.HttpServletResponse.SC_NO_CONTENT;
<a class="jxr_linenumber" name="L38" href="#L38">38</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> javax.servlet.http.HttpServletResponse.SC_OK;
<a class="jxr_linenumber" name="L39" href="#L39">39</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> javax.servlet.http.HttpServletResponse.SC_SERVICE_UNAVAILABLE;
<a class="jxr_linenumber" name="L40" href="#L40">40</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> javax.servlet.http.HttpServletResponse.SC_UNAUTHORIZED;
<a class="jxr_linenumber" name="L41" href="#L41">41</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> javax.ws.rs.core.Response.Status.NOT_FOUND;
<a class="jxr_linenumber" name="L42" href="#L42">42</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> org.apache.commons.lang3.StringUtils.trimToNull;
<a class="jxr_linenumber" name="L43" href="#L43">43</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> org.opencastproject.adminui.endpoint.EndpointUtil.transformAccessControList;
<a class="jxr_linenumber" name="L44" href="#L44">44</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> org.opencastproject.index.service.util.RestUtils.conflictJson;
<a class="jxr_linenumber" name="L45" href="#L45">45</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> org.opencastproject.index.service.util.RestUtils.notFound;
<a class="jxr_linenumber" name="L46" href="#L46">46</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> org.opencastproject.index.service.util.RestUtils.notFoundJson;
<a class="jxr_linenumber" name="L47" href="#L47">47</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> org.opencastproject.index.service.util.RestUtils.okJson;
<a class="jxr_linenumber" name="L48" href="#L48">48</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> org.opencastproject.index.service.util.RestUtils.okJsonList;
<a class="jxr_linenumber" name="L49" href="#L49">49</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> org.opencastproject.index.service.util.RestUtils.serverErrorJson;
<a class="jxr_linenumber" name="L50" href="#L50">50</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> org.opencastproject.util.DateTimeSupport.toUTC;
<a class="jxr_linenumber" name="L51" href="#L51">51</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> org.opencastproject.util.RestUtil.R.badRequest;
<a class="jxr_linenumber" name="L52" href="#L52">52</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> org.opencastproject.util.RestUtil.R.conflict;
<a class="jxr_linenumber" name="L53" href="#L53">53</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> org.opencastproject.util.RestUtil.R.forbidden;
<a class="jxr_linenumber" name="L54" href="#L54">54</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> org.opencastproject.util.RestUtil.R.noContent;
<a class="jxr_linenumber" name="L55" href="#L55">55</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> org.opencastproject.util.RestUtil.R.notFound;
<a class="jxr_linenumber" name="L56" href="#L56">56</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> org.opencastproject.util.RestUtil.R.ok;
<a class="jxr_linenumber" name="L57" href="#L57">57</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> org.opencastproject.util.RestUtil.R.serverError;
<a class="jxr_linenumber" name="L58" href="#L58">58</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> org.opencastproject.util.doc.<strong class="jxr_keyword">rest</strong>.RestParameter.Type.BOOLEAN;
<a class="jxr_linenumber" name="L59" href="#L59">59</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> org.opencastproject.util.doc.<strong class="jxr_keyword">rest</strong>.RestParameter.Type.STRING;
<a class="jxr_linenumber" name="L60" href="#L60">60</a>  <strong class="jxr_keyword">import</strong> <strong class="jxr_keyword">static</strong> org.opencastproject.util.doc.<strong class="jxr_keyword">rest</strong>.RestParameter.Type.TEXT;
<a class="jxr_linenumber" name="L61" href="#L61">61</a>  
<a class="jxr_linenumber" name="L62" href="#L62">62</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.adminui.exception.JobEndpointException;
<a class="jxr_linenumber" name="L63" href="#L63">63</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.adminui.impl.AdminUIConfiguration;
<a class="jxr_linenumber" name="L64" href="#L64">64</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.adminui.tobira.TobiraException;
<a class="jxr_linenumber" name="L65" href="#L65">65</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.adminui.tobira.TobiraService;
<a class="jxr_linenumber" name="L66" href="#L66">66</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.adminui.util.BulkUpdateUtil;
<a class="jxr_linenumber" name="L67" href="#L67">67</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.assetmanager.api.AssetManager;
<a class="jxr_linenumber" name="L68" href="#L68">68</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.authorization.xacml.manager.api.AclService;
<a class="jxr_linenumber" name="L69" href="#L69">69</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.authorization.xacml.manager.api.ManagedAcl;
<a class="jxr_linenumber" name="L70" href="#L70">70</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.authorization.xacml.manager.util.AccessInformationUtil;
<a class="jxr_linenumber" name="L71" href="#L71">71</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.capture.CaptureParameters;
<a class="jxr_linenumber" name="L72" href="#L72">72</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.capture.admin.api.Agent;
<a class="jxr_linenumber" name="L73" href="#L73">73</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.capture.admin.api.CaptureAgentStateService;
<a class="jxr_linenumber" name="L74" href="#L74">74</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.elasticsearch.api.SearchIndexException;
<a class="jxr_linenumber" name="L75" href="#L75">75</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.elasticsearch.api.SearchResult;
<a class="jxr_linenumber" name="L76" href="#L76">76</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.elasticsearch.api.SearchResultItem;
<a class="jxr_linenumber" name="L77" href="#L77">77</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.elasticsearch.index.ElasticsearchIndex;
<a class="jxr_linenumber" name="L78" href="#L78">78</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.elasticsearch.index.objects.event.Event;
<a class="jxr_linenumber" name="L79" href="#L79">79</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.elasticsearch.index.objects.event.EventIndexSchema;
<a class="jxr_linenumber" name="L80" href="#L80">80</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.elasticsearch.index.objects.event.EventSearchQuery;
<a class="jxr_linenumber" name="L81" href="#L81">81</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.event.comment.EventComment;
<a class="jxr_linenumber" name="L82" href="#L82">82</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.event.comment.EventCommentException;
<a class="jxr_linenumber" name="L83" href="#L83">83</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.event.comment.EventCommentReply;
<a class="jxr_linenumber" name="L84" href="#L84">84</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.event.comment.EventCommentService;
<a class="jxr_linenumber" name="L85" href="#L85">85</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.index.service.api.IndexService;
<a class="jxr_linenumber" name="L86" href="#L86">86</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.index.service.api.IndexService.Source;
<a class="jxr_linenumber" name="L87" href="#L87">87</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.index.service.exception.IndexServiceException;
<a class="jxr_linenumber" name="L88" href="#L88">88</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.index.service.exception.UnsupportedAssetException;
<a class="jxr_linenumber" name="L89" href="#L89">89</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.index.service.impl.util.EventUtils;
<a class="jxr_linenumber" name="L90" href="#L90">90</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.index.service.resources.list.provider.EventsListProvider.Comments;
<a class="jxr_linenumber" name="L91" href="#L91">91</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.index.service.resources.list.provider.EventsListProvider.IsPublished;
<a class="jxr_linenumber" name="L92" href="#L92">92</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.index.service.resources.list.query.EventListQuery;
<a class="jxr_linenumber" name="L93" href="#L93">93</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.index.service.resources.list.query.SeriesListQuery;
<a class="jxr_linenumber" name="L94" href="#L94">94</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.index.service.util.JSONUtils;
<a class="jxr_linenumber" name="L95" href="#L95">95</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.index.service.util.RestUtils;
<a class="jxr_linenumber" name="L96" href="#L96">96</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.list.api.ResourceListQuery;
<a class="jxr_linenumber" name="L97" href="#L97">97</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.mediapackage.Attachment;
<a class="jxr_linenumber" name="L98" href="#L98">98</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.mediapackage.AudioStream;
<a class="jxr_linenumber" name="L99" href="#L99">99</a>  <strong class="jxr_keyword">import</strong> org.opencastproject.mediapackage.Catalog;
<a class="jxr_linenumber" name="L100" href="#L100">100</a> <strong class="jxr_keyword">import</strong> org.opencastproject.mediapackage.MediaPackage;
<a class="jxr_linenumber" name="L101" href="#L101">101</a> <strong class="jxr_keyword">import</strong> org.opencastproject.mediapackage.MediaPackageElement;
<a class="jxr_linenumber" name="L102" href="#L102">102</a> <strong class="jxr_keyword">import</strong> org.opencastproject.mediapackage.MediaPackageException;
<a class="jxr_linenumber" name="L103" href="#L103">103</a> <strong class="jxr_keyword">import</strong> org.opencastproject.mediapackage.Publication;
<a class="jxr_linenumber" name="L104" href="#L104">104</a> <strong class="jxr_keyword">import</strong> org.opencastproject.mediapackage.Track;
<a class="jxr_linenumber" name="L105" href="#L105">105</a> <strong class="jxr_keyword">import</strong> org.opencastproject.mediapackage.VideoStream;
<a class="jxr_linenumber" name="L106" href="#L106">106</a> <strong class="jxr_keyword">import</strong> org.opencastproject.mediapackage.track.AudioStreamImpl;
<a class="jxr_linenumber" name="L107" href="#L107">107</a> <strong class="jxr_keyword">import</strong> org.opencastproject.mediapackage.track.SubtitleStreamImpl;
<a class="jxr_linenumber" name="L108" href="#L108">108</a> <strong class="jxr_keyword">import</strong> org.opencastproject.mediapackage.track.VideoStreamImpl;
<a class="jxr_linenumber" name="L109" href="#L109">109</a> <strong class="jxr_keyword">import</strong> org.opencastproject.metadata.dublincore.DublinCore;
<a class="jxr_linenumber" name="L110" href="#L110">110</a> <strong class="jxr_keyword">import</strong> org.opencastproject.metadata.dublincore.DublinCoreMetadataCollection;
<a class="jxr_linenumber" name="L111" href="#L111">111</a> <strong class="jxr_keyword">import</strong> org.opencastproject.metadata.dublincore.EventCatalogUIAdapter;
<a class="jxr_linenumber" name="L112" href="#L112">112</a> <strong class="jxr_keyword">import</strong> org.opencastproject.metadata.dublincore.MetadataField;
<a class="jxr_linenumber" name="L113" href="#L113">113</a> <strong class="jxr_keyword">import</strong> org.opencastproject.metadata.dublincore.MetadataJson;
<a class="jxr_linenumber" name="L114" href="#L114">114</a> <strong class="jxr_keyword">import</strong> org.opencastproject.metadata.dublincore.MetadataList;
<a class="jxr_linenumber" name="L115" href="#L115">115</a> <strong class="jxr_keyword">import</strong> org.opencastproject.metadata.dublincore.MetadataList.Locked;
<a class="jxr_linenumber" name="L116" href="#L116">116</a> <strong class="jxr_keyword">import</strong> org.opencastproject.<strong class="jxr_keyword">rest</strong>.BulkOperationResult;
<a class="jxr_linenumber" name="L117" href="#L117">117</a> <strong class="jxr_keyword">import</strong> org.opencastproject.<strong class="jxr_keyword">rest</strong>.RestConstants;
<a class="jxr_linenumber" name="L118" href="#L118">118</a> <strong class="jxr_keyword">import</strong> org.opencastproject.scheduler.api.Recording;
<a class="jxr_linenumber" name="L119" href="#L119">119</a> <strong class="jxr_keyword">import</strong> org.opencastproject.scheduler.api.SchedulerException;
<a class="jxr_linenumber" name="L120" href="#L120">120</a> <strong class="jxr_keyword">import</strong> org.opencastproject.scheduler.api.SchedulerService;
<a class="jxr_linenumber" name="L121" href="#L121">121</a> <strong class="jxr_keyword">import</strong> org.opencastproject.scheduler.api.TechnicalMetadata;
<a class="jxr_linenumber" name="L122" href="#L122">122</a> <strong class="jxr_keyword">import</strong> org.opencastproject.scheduler.api.Util;
<a class="jxr_linenumber" name="L123" href="#L123">123</a> <strong class="jxr_keyword">import</strong> org.opencastproject.security.api.AccessControlList;
<a class="jxr_linenumber" name="L124" href="#L124">124</a> <strong class="jxr_keyword">import</strong> org.opencastproject.security.api.AccessControlParser;
<a class="jxr_linenumber" name="L125" href="#L125">125</a> <strong class="jxr_keyword">import</strong> org.opencastproject.security.api.AclScope;
<a class="jxr_linenumber" name="L126" href="#L126">126</a> <strong class="jxr_keyword">import</strong> org.opencastproject.security.api.AuthorizationService;
<a class="jxr_linenumber" name="L127" href="#L127">127</a> <strong class="jxr_keyword">import</strong> org.opencastproject.security.api.Organization;
<a class="jxr_linenumber" name="L128" href="#L128">128</a> <strong class="jxr_keyword">import</strong> org.opencastproject.security.api.Permissions;
<a class="jxr_linenumber" name="L129" href="#L129">129</a> <strong class="jxr_keyword">import</strong> org.opencastproject.security.api.SecurityService;
<a class="jxr_linenumber" name="L130" href="#L130">130</a> <strong class="jxr_keyword">import</strong> org.opencastproject.security.api.UnauthorizedException;
<a class="jxr_linenumber" name="L131" href="#L131">131</a> <strong class="jxr_keyword">import</strong> org.opencastproject.security.api.User;
<a class="jxr_linenumber" name="L132" href="#L132">132</a> <strong class="jxr_keyword">import</strong> org.opencastproject.security.api.UserDirectoryService;
<a class="jxr_linenumber" name="L133" href="#L133">133</a> <strong class="jxr_keyword">import</strong> org.opencastproject.security.urlsigning.exception.UrlSigningException;
<a class="jxr_linenumber" name="L134" href="#L134">134</a> <strong class="jxr_keyword">import</strong> org.opencastproject.security.urlsigning.service.UrlSigningService;
<a class="jxr_linenumber" name="L135" href="#L135">135</a> <strong class="jxr_keyword">import</strong> org.opencastproject.security.util.SecurityUtil;
<a class="jxr_linenumber" name="L136" href="#L136">136</a> <strong class="jxr_keyword">import</strong> org.opencastproject.systems.OpencastConstants;
<a class="jxr_linenumber" name="L137" href="#L137">137</a> <strong class="jxr_keyword">import</strong> org.opencastproject.util.DateTimeSupport;
<a class="jxr_linenumber" name="L138" href="#L138">138</a> <strong class="jxr_keyword">import</strong> org.opencastproject.util.Jsons.Val;
<a class="jxr_linenumber" name="L139" href="#L139">139</a> <strong class="jxr_keyword">import</strong> org.opencastproject.util.NotFoundException;
<a class="jxr_linenumber" name="L140" href="#L140">140</a> <strong class="jxr_keyword">import</strong> org.opencastproject.util.RestUtil;
<a class="jxr_linenumber" name="L141" href="#L141">141</a> <strong class="jxr_keyword">import</strong> org.opencastproject.util.UrlSupport;
<a class="jxr_linenumber" name="L142" href="#L142">142</a> <strong class="jxr_keyword">import</strong> org.opencastproject.util.data.Option;
<a class="jxr_linenumber" name="L143" href="#L143">143</a> <strong class="jxr_keyword">import</strong> org.opencastproject.util.data.Tuple;
<a class="jxr_linenumber" name="L144" href="#L144">144</a> <strong class="jxr_keyword">import</strong> org.opencastproject.util.data.Tuple3;
<a class="jxr_linenumber" name="L145" href="#L145">145</a> <strong class="jxr_keyword">import</strong> org.opencastproject.util.doc.<strong class="jxr_keyword">rest</strong>.RestParameter;
<a class="jxr_linenumber" name="L146" href="#L146">146</a> <strong class="jxr_keyword">import</strong> org.opencastproject.util.doc.<strong class="jxr_keyword">rest</strong>.RestQuery;
<a class="jxr_linenumber" name="L147" href="#L147">147</a> <strong class="jxr_keyword">import</strong> org.opencastproject.util.doc.<strong class="jxr_keyword">rest</strong>.RestResponse;
<a class="jxr_linenumber" name="L148" href="#L148">148</a> <strong class="jxr_keyword">import</strong> org.opencastproject.util.requests.SortCriterion;
<a class="jxr_linenumber" name="L149" href="#L149">149</a> <strong class="jxr_keyword">import</strong> org.opencastproject.workflow.api.RetryStrategy;
<a class="jxr_linenumber" name="L150" href="#L150">150</a> <strong class="jxr_keyword">import</strong> org.opencastproject.workflow.api.WorkflowDatabaseException;
<a class="jxr_linenumber" name="L151" href="#L151">151</a> <strong class="jxr_keyword">import</strong> org.opencastproject.workflow.api.WorkflowDefinition;
<a class="jxr_linenumber" name="L152" href="#L152">152</a> <strong class="jxr_keyword">import</strong> org.opencastproject.workflow.api.WorkflowInstance;
<a class="jxr_linenumber" name="L153" href="#L153">153</a> <strong class="jxr_keyword">import</strong> org.opencastproject.workflow.api.WorkflowOperationInstance;
<a class="jxr_linenumber" name="L154" href="#L154">154</a> <strong class="jxr_keyword">import</strong> org.opencastproject.workflow.api.WorkflowService;
<a class="jxr_linenumber" name="L155" href="#L155">155</a> <strong class="jxr_keyword">import</strong> org.opencastproject.workflow.api.WorkflowStateException;
<a class="jxr_linenumber" name="L156" href="#L156">156</a> <strong class="jxr_keyword">import</strong> org.opencastproject.workflow.api.WorkflowUtil;
<a class="jxr_linenumber" name="L157" href="#L157">157</a> 
<a class="jxr_linenumber" name="L158" href="#L158">158</a> <strong class="jxr_keyword">import</strong> com.entwinemedia.fn.Fn;
<a class="jxr_linenumber" name="L159" href="#L159">159</a> <strong class="jxr_keyword">import</strong> com.entwinemedia.fn.Stream;
<a class="jxr_linenumber" name="L160" href="#L160">160</a> <strong class="jxr_keyword">import</strong> com.entwinemedia.fn.data.Opt;
<a class="jxr_linenumber" name="L161" href="#L161">161</a> <strong class="jxr_keyword">import</strong> com.entwinemedia.fn.data.json.Field;
<a class="jxr_linenumber" name="L162" href="#L162">162</a> <strong class="jxr_keyword">import</strong> com.entwinemedia.fn.data.json.JObject;
<a class="jxr_linenumber" name="L163" href="#L163">163</a> <strong class="jxr_keyword">import</strong> com.entwinemedia.fn.data.json.JValue;
<a class="jxr_linenumber" name="L164" href="#L164">164</a> <strong class="jxr_keyword">import</strong> com.entwinemedia.fn.data.json.Jsons;
<a class="jxr_linenumber" name="L165" href="#L165">165</a> <strong class="jxr_keyword">import</strong> com.entwinemedia.fn.data.json.Jsons.Functions;
<a class="jxr_linenumber" name="L166" href="#L166">166</a> 
<a class="jxr_linenumber" name="L167" href="#L167">167</a> <strong class="jxr_keyword">import</strong> net.fortuna.ical4j.model.property.RRule;
<a class="jxr_linenumber" name="L168" href="#L168">168</a> 
<a class="jxr_linenumber" name="L169" href="#L169">169</a> <strong class="jxr_keyword">import</strong> org.apache.commons.lang3.BooleanUtils;
<a class="jxr_linenumber" name="L170" href="#L170">170</a> <strong class="jxr_keyword">import</strong> org.apache.commons.lang3.StringUtils;
<a class="jxr_linenumber" name="L171" href="#L171">171</a> <strong class="jxr_keyword">import</strong> org.codehaus.jettison.json.JSONException;
<a class="jxr_linenumber" name="L172" href="#L172">172</a> <strong class="jxr_keyword">import</strong> org.json.simple.JSONArray;
<a class="jxr_linenumber" name="L173" href="#L173">173</a> <strong class="jxr_keyword">import</strong> org.json.simple.JSONObject;
<a class="jxr_linenumber" name="L174" href="#L174">174</a> <strong class="jxr_keyword">import</strong> org.json.simple.parser.JSONParser;
<a class="jxr_linenumber" name="L175" href="#L175">175</a> <strong class="jxr_keyword">import</strong> org.osgi.service.component.ComponentContext;
<a class="jxr_linenumber" name="L176" href="#L176">176</a> <strong class="jxr_keyword">import</strong> org.osgi.service.component.annotations.Activate;
<a class="jxr_linenumber" name="L177" href="#L177">177</a> <strong class="jxr_keyword">import</strong> org.slf4j.Logger;
<a class="jxr_linenumber" name="L178" href="#L178">178</a> <strong class="jxr_keyword">import</strong> org.slf4j.LoggerFactory;
<a class="jxr_linenumber" name="L179" href="#L179">179</a> 
<a class="jxr_linenumber" name="L180" href="#L180">180</a> <strong class="jxr_keyword">import</strong> java.net.URI;
<a class="jxr_linenumber" name="L181" href="#L181">181</a> <strong class="jxr_keyword">import</strong> java.text.ParseException;
<a class="jxr_linenumber" name="L182" href="#L182">182</a> <strong class="jxr_keyword">import</strong> java.time.Instant;
<a class="jxr_linenumber" name="L183" href="#L183">183</a> <strong class="jxr_keyword">import</strong> java.util.ArrayList;
<a class="jxr_linenumber" name="L184" href="#L184">184</a> <strong class="jxr_keyword">import</strong> java.util.Collection;
<a class="jxr_linenumber" name="L185" href="#L185">185</a> <strong class="jxr_keyword">import</strong> java.util.Collections;
<a class="jxr_linenumber" name="L186" href="#L186">186</a> <strong class="jxr_keyword">import</strong> java.util.Date;
<a class="jxr_linenumber" name="L187" href="#L187">187</a> <strong class="jxr_keyword">import</strong> java.util.HashMap;
<a class="jxr_linenumber" name="L188" href="#L188">188</a> <strong class="jxr_keyword">import</strong> java.util.HashSet;
<a class="jxr_linenumber" name="L189" href="#L189">189</a> <strong class="jxr_keyword">import</strong> java.util.List;
<a class="jxr_linenumber" name="L190" href="#L190">190</a> <strong class="jxr_keyword">import</strong> java.util.Map;
<a class="jxr_linenumber" name="L191" href="#L191">191</a> <strong class="jxr_keyword">import</strong> java.util.Map.Entry;
<a class="jxr_linenumber" name="L192" href="#L192">192</a> <strong class="jxr_keyword">import</strong> java.util.Objects;
<a class="jxr_linenumber" name="L193" href="#L193">193</a> <strong class="jxr_keyword">import</strong> java.util.Optional;
<a class="jxr_linenumber" name="L194" href="#L194">194</a> <strong class="jxr_keyword">import</strong> java.util.Set;
<a class="jxr_linenumber" name="L195" href="#L195">195</a> <strong class="jxr_keyword">import</strong> java.util.TimeZone;
<a class="jxr_linenumber" name="L196" href="#L196">196</a> <strong class="jxr_keyword">import</strong> java.util.stream.Collectors;
<a class="jxr_linenumber" name="L197" href="#L197">197</a> 
<a class="jxr_linenumber" name="L198" href="#L198">198</a> <strong class="jxr_keyword">import</strong> javax.servlet.http.HttpServletRequest;
<a class="jxr_linenumber" name="L199" href="#L199">199</a> <strong class="jxr_keyword">import</strong> javax.servlet.http.HttpServletResponse;
<a class="jxr_linenumber" name="L200" href="#L200">200</a> <strong class="jxr_keyword">import</strong> javax.ws.rs.Consumes;
<a class="jxr_linenumber" name="L201" href="#L201">201</a> <strong class="jxr_keyword">import</strong> javax.ws.rs.DELETE;
<a class="jxr_linenumber" name="L202" href="#L202">202</a> <strong class="jxr_keyword">import</strong> javax.ws.rs.FormParam;
<a class="jxr_linenumber" name="L203" href="#L203">203</a> <strong class="jxr_keyword">import</strong> javax.ws.rs.GET;
<a class="jxr_linenumber" name="L204" href="#L204">204</a> <strong class="jxr_keyword">import</strong> javax.ws.rs.POST;
<a class="jxr_linenumber" name="L205" href="#L205">205</a> <strong class="jxr_keyword">import</strong> javax.ws.rs.PUT;
<a class="jxr_linenumber" name="L206" href="#L206">206</a> <strong class="jxr_keyword">import</strong> javax.ws.rs.Path;
<a class="jxr_linenumber" name="L207" href="#L207">207</a> <strong class="jxr_keyword">import</strong> javax.ws.rs.PathParam;
<a class="jxr_linenumber" name="L208" href="#L208">208</a> <strong class="jxr_keyword">import</strong> javax.ws.rs.Produces;
<a class="jxr_linenumber" name="L209" href="#L209">209</a> <strong class="jxr_keyword">import</strong> javax.ws.rs.QueryParam;
<a class="jxr_linenumber" name="L210" href="#L210">210</a> <strong class="jxr_keyword">import</strong> javax.ws.rs.WebApplicationException;
<a class="jxr_linenumber" name="L211" href="#L211">211</a> <strong class="jxr_keyword">import</strong> javax.ws.rs.core.Context;
<a class="jxr_linenumber" name="L212" href="#L212">212</a> <strong class="jxr_keyword">import</strong> javax.ws.rs.core.MediaType;
<a class="jxr_linenumber" name="L213" href="#L213">213</a> <strong class="jxr_keyword">import</strong> javax.ws.rs.core.Response;
<a class="jxr_linenumber" name="L214" href="#L214">214</a> <strong class="jxr_keyword">import</strong> javax.ws.rs.core.Response.Status;
<a class="jxr_linenumber" name="L215" href="#L215">215</a> 
<a class="jxr_linenumber" name="L216" href="#L216">216</a> <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L217" href="#L217">217</a> <em class="jxr_javadoccomment"> * The event endpoint acts as a facade for WorkflowService and Archive providing a unified query interface and result</em>
<a class="jxr_linenumber" name="L218" href="#L218">218</a> <em class="jxr_javadoccomment"> * set.</em>
<a class="jxr_linenumber" name="L219" href="#L219">219</a> <em class="jxr_javadoccomment"> * &lt;p&gt;</em>
<a class="jxr_linenumber" name="L220" href="#L220">220</a> <em class="jxr_javadoccomment"> * This first implementation uses the {@link org.opencastproject.assetmanager.api.AssetManager}. In a later iteration</em>
<a class="jxr_linenumber" name="L221" href="#L221">221</a> <em class="jxr_javadoccomment"> * the endpoint may abstract over the concrete archive.</em>
<a class="jxr_linenumber" name="L222" href="#L222">222</a> <em class="jxr_javadoccomment"> */</em>
<a class="jxr_linenumber" name="L223" href="#L223">223</a> @Path(<span class="jxr_string">"/admin-ng/event"</span>)
<a class="jxr_linenumber" name="L224" href="#L224">224</a> <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> <strong class="jxr_keyword">class</strong> <a name="AbstractEventEndpoint" href="../../../../org/opencastproject/adminui/endpoint/AbstractEventEndpoint.html#AbstractEventEndpoint">AbstractEventEndpoint</a> {
<a class="jxr_linenumber" name="L225" href="#L225">225</a> 
<a class="jxr_linenumber" name="L226" href="#L226">226</a>   <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L227" href="#L227">227</a> <em class="jxr_javadoccomment">   * Scheduling JSON keys</em>
<a class="jxr_linenumber" name="L228" href="#L228">228</a> <em class="jxr_javadoccomment">   */</em>
<a class="jxr_linenumber" name="L229" href="#L229">229</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String SCHEDULING_AGENT_ID_KEY = <span class="jxr_string">"agentId"</span>;
<a class="jxr_linenumber" name="L230" href="#L230">230</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String SCHEDULING_START_KEY = <span class="jxr_string">"start"</span>;
<a class="jxr_linenumber" name="L231" href="#L231">231</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String SCHEDULING_END_KEY = <span class="jxr_string">"end"</span>;
<a class="jxr_linenumber" name="L232" href="#L232">232</a>   <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String SCHEDULING_AGENT_CONFIGURATION_KEY = <span class="jxr_string">"agentConfiguration"</span>;
<a class="jxr_linenumber" name="L233" href="#L233">233</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String SCHEDULING_PREVIOUS_AGENTID = <span class="jxr_string">"previousAgentId"</span>;
<a class="jxr_linenumber" name="L234" href="#L234">234</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String SCHEDULING_PREVIOUS_PREVIOUSENTRIES = <span class="jxr_string">"previousEntries"</span>;
<a class="jxr_linenumber" name="L235" href="#L235">235</a> 
<a class="jxr_linenumber" name="L236" href="#L236">236</a>   <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String WORKFLOW_ACTION_STOP = <span class="jxr_string">"STOP"</span>;
<a class="jxr_linenumber" name="L237" href="#L237">237</a> 
<a class="jxr_linenumber" name="L238" href="#L238">238</a>   <em class="jxr_javadoccomment">/** The logging facility */</em>
<a class="jxr_linenumber" name="L239" href="#L239">239</a>   <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> Logger logger = LoggerFactory.getLogger(AbstractEventEndpoint.<strong class="jxr_keyword">class</strong>);
<a class="jxr_linenumber" name="L240" href="#L240">240</a> 
<a class="jxr_linenumber" name="L241" href="#L241">241</a>   <em class="jxr_javadoccomment">/** The configuration key that defines the default workflow definition */</em>
<a class="jxr_linenumber" name="L242" href="#L242">242</a>   <em class="jxr_comment">//TODO Move to a constants file instead of declaring it at the top of multiple files?</em>
<a class="jxr_linenumber" name="L243" href="#L243">243</a>   <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String WORKFLOW_DEFINITION_DEFAULT = <span class="jxr_string">"org.opencastproject.workflow.default.definition"</span>;
<a class="jxr_linenumber" name="L244" href="#L244">244</a> 
<a class="jxr_linenumber" name="L245" href="#L245">245</a>   <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String WORKFLOW_STATUS_TRANSLATION_PREFIX = <span class="jxr_string">"EVENTS.EVENTS.DETAILS.WORKFLOWS.OPERATION_STATUS."</span>;
<a class="jxr_linenumber" name="L246" href="#L246">246</a> 
<a class="jxr_linenumber" name="L247" href="#L247">247</a>   <em class="jxr_javadoccomment">/** The default time before a piece of signed content expires. 2 Hours. */</em>
<a class="jxr_linenumber" name="L248" href="#L248">248</a>   <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">long</strong> DEFAULT_URL_SIGNING_EXPIRE_DURATION = 2 * 60 * 60;
<a class="jxr_linenumber" name="L249" href="#L249">249</a> 
<a class="jxr_linenumber" name="L250" href="#L250">250</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> AssetManager getAssetManager();
<a class="jxr_linenumber" name="L251" href="#L251">251</a> 
<a class="jxr_linenumber" name="L252" href="#L252">252</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> WorkflowService getWorkflowService();
<a class="jxr_linenumber" name="L253" href="#L253">253</a> 
<a class="jxr_linenumber" name="L254" href="#L254">254</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> ElasticsearchIndex getIndex();
<a class="jxr_linenumber" name="L255" href="#L255">255</a> 
<a class="jxr_linenumber" name="L256" href="#L256">256</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> JobEndpoint getJobService();
<a class="jxr_linenumber" name="L257" href="#L257">257</a> 
<a class="jxr_linenumber" name="L258" href="#L258">258</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> SeriesEndpoint getSeriesEndpoint();
<a class="jxr_linenumber" name="L259" href="#L259">259</a> 
<a class="jxr_linenumber" name="L260" href="#L260">260</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> AclService getAclService();
<a class="jxr_linenumber" name="L261" href="#L261">261</a> 
<a class="jxr_linenumber" name="L262" href="#L262">262</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> EventCommentService getEventCommentService();
<a class="jxr_linenumber" name="L263" href="#L263">263</a> 
<a class="jxr_linenumber" name="L264" href="#L264">264</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> SecurityService getSecurityService();
<a class="jxr_linenumber" name="L265" href="#L265">265</a> 
<a class="jxr_linenumber" name="L266" href="#L266">266</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> IndexService getIndexService();
<a class="jxr_linenumber" name="L267" href="#L267">267</a> 
<a class="jxr_linenumber" name="L268" href="#L268">268</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> AuthorizationService getAuthorizationService();
<a class="jxr_linenumber" name="L269" href="#L269">269</a> 
<a class="jxr_linenumber" name="L270" href="#L270">270</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> SchedulerService getSchedulerService();
<a class="jxr_linenumber" name="L271" href="#L271">271</a> 
<a class="jxr_linenumber" name="L272" href="#L272">272</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> CaptureAgentStateService getCaptureAgentStateService();
<a class="jxr_linenumber" name="L273" href="#L273">273</a> 
<a class="jxr_linenumber" name="L274" href="#L274">274</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> AdminUIConfiguration getAdminUIConfiguration();
<a class="jxr_linenumber" name="L275" href="#L275">275</a> 
<a class="jxr_linenumber" name="L276" href="#L276">276</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> <strong class="jxr_keyword">long</strong> getUrlSigningExpireDuration();
<a class="jxr_linenumber" name="L277" href="#L277">277</a> 
<a class="jxr_linenumber" name="L278" href="#L278">278</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> UrlSigningService getUrlSigningService();
<a class="jxr_linenumber" name="L279" href="#L279">279</a> 
<a class="jxr_linenumber" name="L280" href="#L280">280</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> Boolean signWithClientIP();
<a class="jxr_linenumber" name="L281" href="#L281">281</a> 
<a class="jxr_linenumber" name="L282" href="#L282">282</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> Boolean getOnlySeriesWithWriteAccessEventModal();
<a class="jxr_linenumber" name="L283" href="#L283">283</a> 
<a class="jxr_linenumber" name="L284" href="#L284">284</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> Boolean getOnlyEventsWithWriteAccessEventsTab();
<a class="jxr_linenumber" name="L285" href="#L285">285</a> 
<a class="jxr_linenumber" name="L286" href="#L286">286</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">abstract</strong> UserDirectoryService getUserDirectoryService();
<a class="jxr_linenumber" name="L287" href="#L287">287</a> 
<a class="jxr_linenumber" name="L288" href="#L288">288</a>   <em class="jxr_javadoccomment">/** Default server URL */</em>
<a class="jxr_linenumber" name="L289" href="#L289">289</a>   <strong class="jxr_keyword">protected</strong> String serverUrl = <span class="jxr_string">"http://localhost:8080"</span>;
<a class="jxr_linenumber" name="L290" href="#L290">290</a> 
<a class="jxr_linenumber" name="L291" href="#L291">291</a>   <em class="jxr_javadoccomment">/** Service url */</em>
<a class="jxr_linenumber" name="L292" href="#L292">292</a>   <strong class="jxr_keyword">protected</strong> String serviceUrl = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L293" href="#L293">293</a> 
<a class="jxr_linenumber" name="L294" href="#L294">294</a>   <em class="jxr_javadoccomment">/** The default workflow identifier, if one is configured */</em>
<a class="jxr_linenumber" name="L295" href="#L295">295</a>   <strong class="jxr_keyword">protected</strong> String defaultWorkflowDefinionId = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L296" href="#L296">296</a> 
<a class="jxr_linenumber" name="L297" href="#L297">297</a>   <em class="jxr_javadoccomment">/** The system user name (default set here for unit tests) */</em>
<a class="jxr_linenumber" name="L298" href="#L298">298</a>   <strong class="jxr_keyword">private</strong> String systemUserName = <span class="jxr_string">"opencast_system_account"</span>;
<a class="jxr_linenumber" name="L299" href="#L299">299</a> 
<a class="jxr_linenumber" name="L300" href="#L300">300</a>   <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L301" href="#L301">301</a> <em class="jxr_javadoccomment">   * Activates REST service.</em>
<a class="jxr_linenumber" name="L302" href="#L302">302</a> <em class="jxr_javadoccomment">   *</em>
<a class="jxr_linenumber" name="L303" href="#L303">303</a> <em class="jxr_javadoccomment">   * @param cc</em>
<a class="jxr_linenumber" name="L304" href="#L304">304</a> <em class="jxr_javadoccomment">   *          ComponentContext</em>
<a class="jxr_linenumber" name="L305" href="#L305">305</a> <em class="jxr_javadoccomment">   */</em>
<a class="jxr_linenumber" name="L306" href="#L306">306</a>   @Activate
<a class="jxr_linenumber" name="L307" href="#L307">307</a>   <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> activate(ComponentContext cc) {
<a class="jxr_linenumber" name="L308" href="#L308">308</a>     <strong class="jxr_keyword">if</strong> (cc != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L309" href="#L309">309</a>       String ccServerUrl = cc.getBundleContext().getProperty(OpencastConstants.SERVER_URL_PROPERTY);
<a class="jxr_linenumber" name="L310" href="#L310">310</a>       <strong class="jxr_keyword">if</strong> (StringUtils.isNotBlank(ccServerUrl))
<a class="jxr_linenumber" name="L311" href="#L311">311</a>         <strong class="jxr_keyword">this</strong>.serverUrl = ccServerUrl;
<a class="jxr_linenumber" name="L312" href="#L312">312</a> 
<a class="jxr_linenumber" name="L313" href="#L313">313</a>       <strong class="jxr_keyword">this</strong>.serviceUrl = (String) cc.getProperties().get(RestConstants.SERVICE_PATH_PROPERTY);
<a class="jxr_linenumber" name="L314" href="#L314">314</a> 
<a class="jxr_linenumber" name="L315" href="#L315">315</a>       String ccDefaultWorkflowDefinionId = StringUtils.trimToNull(cc.getBundleContext().getProperty(WORKFLOW_DEFINITION_DEFAULT));
<a class="jxr_linenumber" name="L316" href="#L316">316</a> 
<a class="jxr_linenumber" name="L317" href="#L317">317</a>       <strong class="jxr_keyword">if</strong> (StringUtils.isNotBlank(ccDefaultWorkflowDefinionId))
<a class="jxr_linenumber" name="L318" href="#L318">318</a>         <strong class="jxr_keyword">this</strong>.defaultWorkflowDefinionId = ccDefaultWorkflowDefinionId;
<a class="jxr_linenumber" name="L319" href="#L319">319</a> 
<a class="jxr_linenumber" name="L320" href="#L320">320</a>       systemUserName = SecurityUtil.getSystemUserName(cc);
<a class="jxr_linenumber" name="L321" href="#L321">321</a>     }
<a class="jxr_linenumber" name="L322" href="#L322">322</a>   }
<a class="jxr_linenumber" name="L323" href="#L323">323</a> 
<a class="jxr_linenumber" name="L324" href="#L324">324</a>   <em class="jxr_comment">/* As the list of event ids can grow large, we use a POST request to avoid problems with too large query strings */</em>
<a class="jxr_linenumber" name="L325" href="#L325">325</a>   @POST
<a class="jxr_linenumber" name="L326" href="#L326">326</a>   @Path(<span class="jxr_string">"workflowProperties"</span>)
<a class="jxr_linenumber" name="L327" href="#L327">327</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L328" href="#L328">328</a>   @RestQuery(name = <span class="jxr_string">"workflowProperties"</span>, description = <span class="jxr_string">"Returns workflow properties for the specified events"</span>,
<a class="jxr_linenumber" name="L329" href="#L329">329</a>              returnDescription = <span class="jxr_string">"The workflow properties for every event as JSON"</span>, restParameters = {
<a class="jxr_linenumber" name="L330" href="#L330">330</a>                 @RestParameter(name = <span class="jxr_string">"eventIds"</span>, description = <span class="jxr_string">"A JSON array of ids of the events"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING)},
<a class="jxr_linenumber" name="L331" href="#L331">331</a>              responses = {
<a class="jxr_linenumber" name="L332" href="#L332">332</a>                 @RestResponse(description = <span class="jxr_string">"Returns the workflow properties for the events as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L333" href="#L333">333</a>                 @RestResponse(description = <span class="jxr_string">"The list of ids could not be parsed into a json list."</span>, responseCode = HttpServletResponse.SC_BAD_REQUEST)
<a class="jxr_linenumber" name="L334" href="#L334">334</a>               })
<a class="jxr_linenumber" name="L335" href="#L335">335</a>   <strong class="jxr_keyword">public</strong> Response getEventWorkflowProperties(@FormParam(<span class="jxr_string">"eventIds"</span>) String eventIds) <strong class="jxr_keyword">throws</strong> UnauthorizedException {
<a class="jxr_linenumber" name="L336" href="#L336">336</a>     <strong class="jxr_keyword">if</strong> (StringUtils.isBlank(eventIds)) {
<a class="jxr_linenumber" name="L337" href="#L337">337</a>       <strong class="jxr_keyword">return</strong> Response.status(Response.Status.BAD_REQUEST).build();
<a class="jxr_linenumber" name="L338" href="#L338">338</a>     }
<a class="jxr_linenumber" name="L339" href="#L339">339</a> 
<a class="jxr_linenumber" name="L340" href="#L340">340</a>     JSONParser parser = <strong class="jxr_keyword">new</strong> JSONParser();
<a class="jxr_linenumber" name="L341" href="#L341">341</a>     List&lt;String&gt; ids;
<a class="jxr_linenumber" name="L342" href="#L342">342</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L343" href="#L343">343</a>       ids = (List&lt;String&gt;) parser.parse(eventIds);
<a class="jxr_linenumber" name="L344" href="#L344">344</a>     } <strong class="jxr_keyword">catch</strong> (org.json.simple.parser.ParseException e) {
<a class="jxr_linenumber" name="L345" href="#L345">345</a>       logger.error(<span class="jxr_string">"Unable to parse '{}'"</span>, eventIds, e);
<a class="jxr_linenumber" name="L346" href="#L346">346</a>       <strong class="jxr_keyword">return</strong> Response.status(Response.Status.BAD_REQUEST).build();
<a class="jxr_linenumber" name="L347" href="#L347">347</a>     } <strong class="jxr_keyword">catch</strong> (ClassCastException e) {
<a class="jxr_linenumber" name="L348" href="#L348">348</a>       logger.error(<span class="jxr_string">"Unable to cast '{}'"</span>, eventIds, e);
<a class="jxr_linenumber" name="L349" href="#L349">349</a>       <strong class="jxr_keyword">return</strong> Response.status(Response.Status.BAD_REQUEST).build();
<a class="jxr_linenumber" name="L350" href="#L350">350</a>     }
<a class="jxr_linenumber" name="L351" href="#L351">351</a> 
<a class="jxr_linenumber" name="L352" href="#L352">352</a>     <strong class="jxr_keyword">final</strong> Map&lt;String, Map&lt;String, String&gt;&gt; eventWithProperties = getIndexService().getEventWorkflowProperties(ids);
<a class="jxr_linenumber" name="L353" href="#L353">353</a>     <strong class="jxr_keyword">final</strong> Map&lt;String, Field&gt; jsonEvents = <strong class="jxr_keyword">new</strong> HashMap&lt;&gt;();
<a class="jxr_linenumber" name="L354" href="#L354">354</a>     <strong class="jxr_keyword">for</strong> (Entry&lt;String, Map&lt;String, String&gt;&gt; event : eventWithProperties.entrySet()) {
<a class="jxr_linenumber" name="L355" href="#L355">355</a>       <strong class="jxr_keyword">final</strong> Collection&lt;Field&gt; jsonProperties = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L356" href="#L356">356</a>       <strong class="jxr_keyword">for</strong> (Entry&lt;String, String&gt; property : event.getValue().entrySet()) {
<a class="jxr_linenumber" name="L357" href="#L357">357</a>         jsonProperties.add(f(property.getKey(),property.getValue()));
<a class="jxr_linenumber" name="L358" href="#L358">358</a>       }
<a class="jxr_linenumber" name="L359" href="#L359">359</a>       jsonEvents.put(event.getKey(), f(event.getKey(), obj(jsonProperties)));
<a class="jxr_linenumber" name="L360" href="#L360">360</a>     }
<a class="jxr_linenumber" name="L361" href="#L361">361</a>     <strong class="jxr_keyword">return</strong> okJson(obj(jsonEvents));
<a class="jxr_linenumber" name="L362" href="#L362">362</a>   }
<a class="jxr_linenumber" name="L363" href="#L363">363</a> 
<a class="jxr_linenumber" name="L364" href="#L364">364</a> 
<a class="jxr_linenumber" name="L365" href="#L365">365</a>   @GET
<a class="jxr_linenumber" name="L366" href="#L366">366</a>   @Path(<span class="jxr_string">"catalogAdapters"</span>)
<a class="jxr_linenumber" name="L367" href="#L367">367</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L368" href="#L368">368</a>   @RestQuery(name = <span class="jxr_string">"getcataloguiadapters"</span>, description = <span class="jxr_string">"Returns the available catalog UI adapters as JSON"</span>, returnDescription = <span class="jxr_string">"The catalog UI adapters as JSON"</span>, responses = {
<a class="jxr_linenumber" name="L369" href="#L369">369</a>           @RestResponse(description = <span class="jxr_string">"Returns the available catalog UI adapters as JSON"</span>, responseCode = HttpServletResponse.SC_OK) })
<a class="jxr_linenumber" name="L370" href="#L370">370</a>   <strong class="jxr_keyword">public</strong> Response getCatalogAdapters() {
<a class="jxr_linenumber" name="L371" href="#L371">371</a>     List&lt;JValue&gt; adapters = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L372" href="#L372">372</a>     <strong class="jxr_keyword">for</strong> (EventCatalogUIAdapter adapter : getIndexService().getEventCatalogUIAdapters()) {
<a class="jxr_linenumber" name="L373" href="#L373">373</a>       List&lt;Field&gt; fields = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L374" href="#L374">374</a>       fields.add(f(<span class="jxr_string">"flavor"</span>, v(adapter.getFlavor().toString())));
<a class="jxr_linenumber" name="L375" href="#L375">375</a>       fields.add(f(<span class="jxr_string">"title"</span>, v(adapter.getUITitle())));
<a class="jxr_linenumber" name="L376" href="#L376">376</a>       adapters.add(obj(fields));
<a class="jxr_linenumber" name="L377" href="#L377">377</a>     }
<a class="jxr_linenumber" name="L378" href="#L378">378</a>     <strong class="jxr_keyword">return</strong> okJson(arr(adapters));
<a class="jxr_linenumber" name="L379" href="#L379">379</a>   }
<a class="jxr_linenumber" name="L380" href="#L380">380</a> 
<a class="jxr_linenumber" name="L381" href="#L381">381</a>   @GET
<a class="jxr_linenumber" name="L382" href="#L382">382</a>   @Path(<span class="jxr_string">"{eventId}"</span>)
<a class="jxr_linenumber" name="L383" href="#L383">383</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L384" href="#L384">384</a>   @RestQuery(name = <span class="jxr_string">"getevent"</span>, description = <span class="jxr_string">"Returns the event by the given id as JSON"</span>, returnDescription = <span class="jxr_string">"The event as JSON"</span>, pathParameters = {
<a class="jxr_linenumber" name="L385" href="#L385">385</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L386" href="#L386">386</a>                   @RestResponse(description = <span class="jxr_string">"Returns the event as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L387" href="#L387">387</a>                   @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L388" href="#L388">388</a>   <strong class="jxr_keyword">public</strong> Response getEventResponse(@PathParam(<span class="jxr_string">"eventId"</span>) String id) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L389" href="#L389">389</a>     <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> Event event : getIndexService().getEvent(id, getIndex())) {
<a class="jxr_linenumber" name="L390" href="#L390">390</a>       event.updatePreview(getAdminUIConfiguration().getPreviewSubtype());
<a class="jxr_linenumber" name="L391" href="#L391">391</a>       <strong class="jxr_keyword">return</strong> okJson(eventToJSON(event, Optional.empty()));
<a class="jxr_linenumber" name="L392" href="#L392">392</a>     }
<a class="jxr_linenumber" name="L393" href="#L393">393</a>     <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, id);
<a class="jxr_linenumber" name="L394" href="#L394">394</a>   }
<a class="jxr_linenumber" name="L395" href="#L395">395</a> 
<a class="jxr_linenumber" name="L396" href="#L396">396</a>   @DELETE
<a class="jxr_linenumber" name="L397" href="#L397">397</a>   @Path(<span class="jxr_string">"{eventId}"</span>)
<a class="jxr_linenumber" name="L398" href="#L398">398</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L399" href="#L399">399</a>   @RestQuery(name = <span class="jxr_string">"deleteevent"</span>, description = <span class="jxr_string">"Delete a single event."</span>, returnDescription = <span class="jxr_string">"Ok if the event has been deleted."</span>, pathParameters = {
<a class="jxr_linenumber" name="L400" href="#L400">400</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The id of the event to delete."</span>, type = STRING), }, responses = {
<a class="jxr_linenumber" name="L401" href="#L401">401</a>                   @RestResponse(responseCode = SC_OK, description = <span class="jxr_string">"The event has been deleted."</span>),
<a class="jxr_linenumber" name="L402" href="#L402">402</a>                   @RestResponse(responseCode = SC_ACCEPTED, description = <span class="jxr_string">"The event will be retracted and deleted afterwards."</span>),
<a class="jxr_linenumber" name="L403" href="#L403">403</a>                   @RestResponse(responseCode = HttpServletResponse.SC_UNAUTHORIZED, description = <span class="jxr_string">"If the current user is not authorized to perform this action"</span>) })
<a class="jxr_linenumber" name="L404" href="#L404">404</a>   <strong class="jxr_keyword">public</strong> Response deleteEvent(@PathParam(<span class="jxr_string">"eventId"</span>) String id) <strong class="jxr_keyword">throws</strong> UnauthorizedException, SearchIndexException {
<a class="jxr_linenumber" name="L405" href="#L405">405</a>     <strong class="jxr_keyword">final</strong> Opt&lt;Event&gt; event = checkAgentAccessForEvent(id);
<a class="jxr_linenumber" name="L406" href="#L406">406</a>     <strong class="jxr_keyword">if</strong> (event.isNone()) {
<a class="jxr_linenumber" name="L407" href="#L407">407</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.notFound(id);
<a class="jxr_linenumber" name="L408" href="#L408">408</a>     }
<a class="jxr_linenumber" name="L409" href="#L409">409</a>     <strong class="jxr_keyword">final</strong> IndexService.EventRemovalResult result;
<a class="jxr_linenumber" name="L410" href="#L410">410</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L411" href="#L411">411</a>       result = getIndexService().removeEvent(event.get(), getAdminUIConfiguration().getRetractWorkflowId());
<a class="jxr_linenumber" name="L412" href="#L412">412</a>     } <strong class="jxr_keyword">catch</strong> (WorkflowDatabaseException e) {
<a class="jxr_linenumber" name="L413" href="#L413">413</a>       logger.error(<span class="jxr_string">"Workflow database is not reachable. This may be a temporary problem."</span>);
<a class="jxr_linenumber" name="L414" href="#L414">414</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.serverError();
<a class="jxr_linenumber" name="L415" href="#L415">415</a>     } <strong class="jxr_keyword">catch</strong> (NotFoundException e) {
<a class="jxr_linenumber" name="L416" href="#L416">416</a>       logger.error(<span class="jxr_string">"Configured retract workflow not found. Check your configuration."</span>);
<a class="jxr_linenumber" name="L417" href="#L417">417</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.serverError();
<a class="jxr_linenumber" name="L418" href="#L418">418</a>     }
<a class="jxr_linenumber" name="L419" href="#L419">419</a>     <strong class="jxr_keyword">switch</strong> (result) {
<a class="jxr_linenumber" name="L420" href="#L420">420</a>       <strong class="jxr_keyword">case</strong> SUCCESS:
<a class="jxr_linenumber" name="L421" href="#L421">421</a>         <strong class="jxr_keyword">return</strong> Response.ok().build();
<a class="jxr_linenumber" name="L422" href="#L422">422</a>       <strong class="jxr_keyword">case</strong> RETRACTING:
<a class="jxr_linenumber" name="L423" href="#L423">423</a>         <strong class="jxr_keyword">return</strong> Response.accepted().build();
<a class="jxr_linenumber" name="L424" href="#L424">424</a>       <strong class="jxr_keyword">case</strong> GENERAL_FAILURE:
<a class="jxr_linenumber" name="L425" href="#L425">425</a>         <strong class="jxr_keyword">return</strong> Response.serverError().build();
<a class="jxr_linenumber" name="L426" href="#L426">426</a>       <strong class="jxr_keyword">case</strong> NOT_FOUND:
<a class="jxr_linenumber" name="L427" href="#L427">427</a>         <strong class="jxr_keyword">return</strong> RestUtil.R.notFound(id);
<a class="jxr_linenumber" name="L428" href="#L428">428</a>       <strong class="jxr_keyword">default</strong>:
<a class="jxr_linenumber" name="L429" href="#L429">429</a>         <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> RuntimeException(<span class="jxr_string">"Unknown EventRemovalResult type: "</span> + result.name());
<a class="jxr_linenumber" name="L430" href="#L430">430</a>     }
<a class="jxr_linenumber" name="L431" href="#L431">431</a>   }
<a class="jxr_linenumber" name="L432" href="#L432">432</a> 
<a class="jxr_linenumber" name="L433" href="#L433">433</a>   @POST
<a class="jxr_linenumber" name="L434" href="#L434">434</a>   @Path(<span class="jxr_string">"deleteEvents"</span>)
<a class="jxr_linenumber" name="L435" href="#L435">435</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L436" href="#L436">436</a>   @RestQuery(name = <span class="jxr_string">"deleteevents"</span>, description = <span class="jxr_string">"Deletes a json list of events by their given ids e.g. [\&quot;1dbe7255-e17d-4279-811d-a5c7ced689bf\&quot;, \&quot;04fae22b-0717-4f59-8b72-5f824f76d529\&quot;]"</span>, returnDescription = <span class="jxr_string">"Returns a JSON object containing a list of event ids that were deleted, not found or if there was a server error."</span>, responses = {
<a class="jxr_linenumber" name="L437" href="#L437">437</a>           @RestResponse(description = <span class="jxr_string">"Events have been deleted"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L438" href="#L438">438</a>           @RestResponse(description = <span class="jxr_string">"The list of ids could not be parsed into a json list."</span>, responseCode = HttpServletResponse.SC_BAD_REQUEST),
<a class="jxr_linenumber" name="L439" href="#L439">439</a>           @RestResponse(description = <span class="jxr_string">"If the current user is not authorized to perform this action"</span>, responseCode = HttpServletResponse.SC_UNAUTHORIZED) })
<a class="jxr_linenumber" name="L440" href="#L440">440</a>   <strong class="jxr_keyword">public</strong> Response deleteEvents(String eventIdsContent) <strong class="jxr_keyword">throws</strong> UnauthorizedException, SearchIndexException {
<a class="jxr_linenumber" name="L441" href="#L441">441</a>     <strong class="jxr_keyword">if</strong> (StringUtils.isBlank(eventIdsContent)) {
<a class="jxr_linenumber" name="L442" href="#L442">442</a>       <strong class="jxr_keyword">return</strong> Response.status(Response.Status.BAD_REQUEST).build();
<a class="jxr_linenumber" name="L443" href="#L443">443</a>     }
<a class="jxr_linenumber" name="L444" href="#L444">444</a> 
<a class="jxr_linenumber" name="L445" href="#L445">445</a>     JSONParser parser = <strong class="jxr_keyword">new</strong> JSONParser();
<a class="jxr_linenumber" name="L446" href="#L446">446</a>     JSONArray eventIdsJsonArray;
<a class="jxr_linenumber" name="L447" href="#L447">447</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L448" href="#L448">448</a>       eventIdsJsonArray = (JSONArray) parser.parse(eventIdsContent);
<a class="jxr_linenumber" name="L449" href="#L449">449</a>     } <strong class="jxr_keyword">catch</strong> (org.json.simple.parser.ParseException e) {
<a class="jxr_linenumber" name="L450" href="#L450">450</a>       logger.error(<span class="jxr_string">"Unable to parse '{}'"</span>, eventIdsContent, e);
<a class="jxr_linenumber" name="L451" href="#L451">451</a>       <strong class="jxr_keyword">return</strong> Response.status(Response.Status.BAD_REQUEST).build();
<a class="jxr_linenumber" name="L452" href="#L452">452</a>     } <strong class="jxr_keyword">catch</strong> (ClassCastException e) {
<a class="jxr_linenumber" name="L453" href="#L453">453</a>       logger.error(<span class="jxr_string">"Unable to cast '{}'"</span>, eventIdsContent, e);
<a class="jxr_linenumber" name="L454" href="#L454">454</a>       <strong class="jxr_keyword">return</strong> Response.status(Response.Status.BAD_REQUEST).build();
<a class="jxr_linenumber" name="L455" href="#L455">455</a>     }
<a class="jxr_linenumber" name="L456" href="#L456">456</a> 
<a class="jxr_linenumber" name="L457" href="#L457">457</a>     BulkOperationResult result = <strong class="jxr_keyword">new</strong> BulkOperationResult();
<a class="jxr_linenumber" name="L458" href="#L458">458</a> 
<a class="jxr_linenumber" name="L459" href="#L459">459</a>     <strong class="jxr_keyword">for</strong> (Object eventIdObject : eventIdsJsonArray) {
<a class="jxr_linenumber" name="L460" href="#L460">460</a>       <strong class="jxr_keyword">final</strong> String eventId = eventIdObject.toString();
<a class="jxr_linenumber" name="L461" href="#L461">461</a>       <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L462" href="#L462">462</a>         <strong class="jxr_keyword">final</strong> Opt&lt;Event&gt; event = checkAgentAccessForEvent(eventId);
<a class="jxr_linenumber" name="L463" href="#L463">463</a>         <strong class="jxr_keyword">if</strong> (event.isSome()) {
<a class="jxr_linenumber" name="L464" href="#L464">464</a>           <strong class="jxr_keyword">final</strong> IndexService.EventRemovalResult currentResult = getIndexService().removeEvent(event.get(),
<a class="jxr_linenumber" name="L465" href="#L465">465</a>                   getAdminUIConfiguration().getRetractWorkflowId());
<a class="jxr_linenumber" name="L466" href="#L466">466</a>           <strong class="jxr_keyword">switch</strong> (currentResult) {
<a class="jxr_linenumber" name="L467" href="#L467">467</a>             <strong class="jxr_keyword">case</strong> SUCCESS:
<a class="jxr_linenumber" name="L468" href="#L468">468</a>               result.addOk(eventId);
<a class="jxr_linenumber" name="L469" href="#L469">469</a>               <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L470" href="#L470">470</a>             <strong class="jxr_keyword">case</strong> RETRACTING:
<a class="jxr_linenumber" name="L471" href="#L471">471</a>               result.addAccepted(eventId);
<a class="jxr_linenumber" name="L472" href="#L472">472</a>               <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L473" href="#L473">473</a>             <strong class="jxr_keyword">case</strong> GENERAL_FAILURE:
<a class="jxr_linenumber" name="L474" href="#L474">474</a>               result.addServerError(eventId);
<a class="jxr_linenumber" name="L475" href="#L475">475</a>               <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L476" href="#L476">476</a>             <strong class="jxr_keyword">case</strong> NOT_FOUND:
<a class="jxr_linenumber" name="L477" href="#L477">477</a>               result.addNotFound(eventId);
<a class="jxr_linenumber" name="L478" href="#L478">478</a>               <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L479" href="#L479">479</a>             <strong class="jxr_keyword">default</strong>:
<a class="jxr_linenumber" name="L480" href="#L480">480</a>               <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> RuntimeException(<span class="jxr_string">"Unknown EventRemovalResult type: "</span> + currentResult.name());
<a class="jxr_linenumber" name="L481" href="#L481">481</a>           }
<a class="jxr_linenumber" name="L482" href="#L482">482</a>         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L483" href="#L483">483</a>           result.addNotFound(eventId);
<a class="jxr_linenumber" name="L484" href="#L484">484</a>         }
<a class="jxr_linenumber" name="L485" href="#L485">485</a>       } <strong class="jxr_keyword">catch</strong> (UnauthorizedException e) {
<a class="jxr_linenumber" name="L486" href="#L486">486</a>         result.addUnauthorized(eventId);
<a class="jxr_linenumber" name="L487" href="#L487">487</a>       } <strong class="jxr_keyword">catch</strong> (WorkflowDatabaseException e) {
<a class="jxr_linenumber" name="L488" href="#L488">488</a>         logger.error(<span class="jxr_string">"Workflow database is not reachable. This may be a temporary problem."</span>);
<a class="jxr_linenumber" name="L489" href="#L489">489</a>         <strong class="jxr_keyword">return</strong> RestUtil.R.serverError();
<a class="jxr_linenumber" name="L490" href="#L490">490</a>       } <strong class="jxr_keyword">catch</strong> (NotFoundException e) {
<a class="jxr_linenumber" name="L491" href="#L491">491</a>         logger.error(<span class="jxr_string">"Configured retract workflow not found. Check your configuration."</span>);
<a class="jxr_linenumber" name="L492" href="#L492">492</a>         <strong class="jxr_keyword">return</strong> RestUtil.R.serverError();
<a class="jxr_linenumber" name="L493" href="#L493">493</a>       }
<a class="jxr_linenumber" name="L494" href="#L494">494</a>     }
<a class="jxr_linenumber" name="L495" href="#L495">495</a>     <strong class="jxr_keyword">return</strong> Response.ok(result.toJson()).build();
<a class="jxr_linenumber" name="L496" href="#L496">496</a>   }
<a class="jxr_linenumber" name="L497" href="#L497">497</a> 
<a class="jxr_linenumber" name="L498" href="#L498">498</a>   @GET
<a class="jxr_linenumber" name="L499" href="#L499">499</a>   @Path(<span class="jxr_string">"{eventId}/publications.json"</span>)
<a class="jxr_linenumber" name="L500" href="#L500">500</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L501" href="#L501">501</a>   @RestQuery(name = <span class="jxr_string">"geteventpublications"</span>, description = <span class="jxr_string">"Returns all the data related to the publications tab in the event details modal as JSON"</span>, returnDescription = <span class="jxr_string">"All the data related to the event publications tab as JSON"</span>, pathParameters = {
<a class="jxr_linenumber" name="L502" href="#L502">502</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id (mediapackage id)."</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L503" href="#L503">503</a>                   @RestResponse(description = <span class="jxr_string">"Returns all the data related to the event publications tab as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L504" href="#L504">504</a>                   @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L505" href="#L505">505</a>   <strong class="jxr_keyword">public</strong> Response getEventPublicationsTab(@PathParam(<span class="jxr_string">"eventId"</span>) String id) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L506" href="#L506">506</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(id, getIndex());
<a class="jxr_linenumber" name="L507" href="#L507">507</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L508" href="#L508">508</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, id);
<a class="jxr_linenumber" name="L509" href="#L509">509</a> 
<a class="jxr_linenumber" name="L510" href="#L510">510</a>     <em class="jxr_comment">// Quick actions have been temporally removed from the publications tab</em>
<a class="jxr_linenumber" name="L511" href="#L511">511</a>     <em class="jxr_comment">// ---------------------------------------------------------------</em>
<a class="jxr_linenumber" name="L512" href="#L512">512</a>     <em class="jxr_comment">// List&lt;JValue&gt; actions = new ArrayList&lt;JValue&gt;();</em>
<a class="jxr_linenumber" name="L513" href="#L513">513</a>     <em class="jxr_comment">// List&lt;WorkflowDefinition&gt; workflowsDefinitions = getWorkflowService().listAvailableWorkflowDefinitions();</em>
<a class="jxr_linenumber" name="L514" href="#L514">514</a>     <em class="jxr_comment">// for (WorkflowDefinition wflDef : workflowsDefinitions) {</em>
<a class="jxr_linenumber" name="L515" href="#L515">515</a>     <em class="jxr_comment">// if (wflDef.containsTag(WORKFLOWDEF_TAG)) {</em>
<a class="jxr_linenumber" name="L516" href="#L516">516</a>     <em class="jxr_comment">//</em>
<a class="jxr_linenumber" name="L517" href="#L517">517</a>     <em class="jxr_comment">// actions.add(obj(f("id", v(wflDef.getId())), f("title", v(Opt.nul(wflDef.getTitle()).or(""))),</em>
<a class="jxr_linenumber" name="L518" href="#L518">518</a>     <em class="jxr_comment">// f("description", v(Opt.nul(wflDef.getDescription()).or(""))),</em>
<a class="jxr_linenumber" name="L519" href="#L519">519</a>     <em class="jxr_comment">// f("configuration_panel", v(Opt.nul(wflDef.getConfigurationPanel()).or("")))));</em>
<a class="jxr_linenumber" name="L520" href="#L520">520</a>     <em class="jxr_comment">// }</em>
<a class="jxr_linenumber" name="L521" href="#L521">521</a>     <em class="jxr_comment">// }</em>
<a class="jxr_linenumber" name="L522" href="#L522">522</a> 
<a class="jxr_linenumber" name="L523" href="#L523">523</a>     Event event = optEvent.get();
<a class="jxr_linenumber" name="L524" href="#L524">524</a>     List&lt;JValue&gt; pubJSON = eventPublicationsToJson(event);
<a class="jxr_linenumber" name="L525" href="#L525">525</a> 
<a class="jxr_linenumber" name="L526" href="#L526">526</a>     <strong class="jxr_keyword">return</strong> okJson(obj(f(<span class="jxr_string">"publications"</span>, arr(pubJSON)),
<a class="jxr_linenumber" name="L527" href="#L527">527</a>             f(<span class="jxr_string">"start-date"</span>, v(event.getRecordingStartDate(), Jsons.BLANK)),
<a class="jxr_linenumber" name="L528" href="#L528">528</a>             f(<span class="jxr_string">"end-date"</span>, v(event.getRecordingEndDate(), Jsons.BLANK))));
<a class="jxr_linenumber" name="L529" href="#L529">529</a>   }
<a class="jxr_linenumber" name="L530" href="#L530">530</a> 
<a class="jxr_linenumber" name="L531" href="#L531">531</a>   <strong class="jxr_keyword">private</strong> List&lt;JValue&gt; eventPublicationsToJson(Event event) {
<a class="jxr_linenumber" name="L532" href="#L532">532</a>     List&lt;JValue&gt; pubJSON = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L533" href="#L533">533</a>     <strong class="jxr_keyword">for</strong> (JObject json : Stream.$(event.getPublications()).filter(EventUtils.internalChannelFilter)
<a class="jxr_linenumber" name="L534" href="#L534">534</a>             .map(publicationToJson)) {
<a class="jxr_linenumber" name="L535" href="#L535">535</a>       pubJSON.add(json);
<a class="jxr_linenumber" name="L536" href="#L536">536</a>     }
<a class="jxr_linenumber" name="L537" href="#L537">537</a>     <strong class="jxr_keyword">return</strong> pubJSON;
<a class="jxr_linenumber" name="L538" href="#L538">538</a>   }
<a class="jxr_linenumber" name="L539" href="#L539">539</a> 
<a class="jxr_linenumber" name="L540" href="#L540">540</a>   <strong class="jxr_keyword">private</strong> List&lt;JObject&gt; eventCommentsToJson(List&lt;EventComment&gt; comments) {
<a class="jxr_linenumber" name="L541" href="#L541">541</a>     List&lt;JObject&gt; commentArr = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L542" href="#L542">542</a>     <strong class="jxr_keyword">for</strong> (EventComment c : comments) {
<a class="jxr_linenumber" name="L543" href="#L543">543</a>       JObject thing = obj(
<a class="jxr_linenumber" name="L544" href="#L544">544</a>               f(<span class="jxr_string">"reason"</span>, v(c.getReason())),
<a class="jxr_linenumber" name="L545" href="#L545">545</a>               f(<span class="jxr_string">"resolvedStatus"</span>, v(c.isResolvedStatus())),
<a class="jxr_linenumber" name="L546" href="#L546">546</a>               f(<span class="jxr_string">"modificationDate"</span>, v(c.getModificationDate().toInstant().toString())),
<a class="jxr_linenumber" name="L547" href="#L547">547</a>               f(<span class="jxr_string">"replies"</span>, arr(eventCommentRepliesToJson(c.getReplies()))),
<a class="jxr_linenumber" name="L548" href="#L548">548</a>               f(<span class="jxr_string">"author"</span>, obj(
<a class="jxr_linenumber" name="L549" href="#L549">549</a>                       f(<span class="jxr_string">"name"</span>, c.getAuthor().getName()),
<a class="jxr_linenumber" name="L550" href="#L550">550</a>                       <em class="jxr_comment">// email field of the digest user is always null</em>
<a class="jxr_linenumber" name="L551" href="#L551">551</a>                       f(<span class="jxr_string">"email"</span>, v(c.getAuthor().getEmail(), NULL)),
<a class="jxr_linenumber" name="L552" href="#L552">552</a>                       f(<span class="jxr_string">"username"</span>, c.getAuthor().getUsername())
<a class="jxr_linenumber" name="L553" href="#L553">553</a>               )),
<a class="jxr_linenumber" name="L554" href="#L554">554</a>               f(<span class="jxr_string">"id"</span>, v(c.getId().get())),
<a class="jxr_linenumber" name="L555" href="#L555">555</a>               f(<span class="jxr_string">"text"</span>, v(c.getText())),
<a class="jxr_linenumber" name="L556" href="#L556">556</a>               f(<span class="jxr_string">"creationDate"</span>, v(c.getCreationDate().toInstant().toString()))
<a class="jxr_linenumber" name="L557" href="#L557">557</a>       );
<a class="jxr_linenumber" name="L558" href="#L558">558</a>       commentArr.add(thing);
<a class="jxr_linenumber" name="L559" href="#L559">559</a>     }
<a class="jxr_linenumber" name="L560" href="#L560">560</a> 
<a class="jxr_linenumber" name="L561" href="#L561">561</a>     <strong class="jxr_keyword">return</strong> commentArr;
<a class="jxr_linenumber" name="L562" href="#L562">562</a>   }
<a class="jxr_linenumber" name="L563" href="#L563">563</a> 
<a class="jxr_linenumber" name="L564" href="#L564">564</a>   <strong class="jxr_keyword">private</strong> List&lt;JObject&gt; eventCommentRepliesToJson(List&lt;EventCommentReply&gt; replies) {
<a class="jxr_linenumber" name="L565" href="#L565">565</a>     List&lt;JObject&gt; repliesArr = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L566" href="#L566">566</a>     <strong class="jxr_keyword">for</strong> (EventCommentReply r : replies) {
<a class="jxr_linenumber" name="L567" href="#L567">567</a>       JObject thing = obj(
<a class="jxr_linenumber" name="L568" href="#L568">568</a>               f(<span class="jxr_string">"id"</span>, v(r.getId().get())),
<a class="jxr_linenumber" name="L569" href="#L569">569</a>               f(<span class="jxr_string">"text"</span>, v(r.getText())),
<a class="jxr_linenumber" name="L570" href="#L570">570</a>               f(<span class="jxr_string">"creationDate"</span>, v(r.getCreationDate().toInstant().toString())),
<a class="jxr_linenumber" name="L571" href="#L571">571</a>               f(<span class="jxr_string">"modificationDate"</span>, v(r.getModificationDate().toInstant().toString())),
<a class="jxr_linenumber" name="L572" href="#L572">572</a>               f(<span class="jxr_string">"author"</span>, obj(
<a class="jxr_linenumber" name="L573" href="#L573">573</a>                       f(<span class="jxr_string">"name"</span>, r.getAuthor().getName()),
<a class="jxr_linenumber" name="L574" href="#L574">574</a>                       <em class="jxr_comment">// email field of the digest user is always null</em>
<a class="jxr_linenumber" name="L575" href="#L575">575</a>                       f(<span class="jxr_string">"email"</span>, v(r.getAuthor().getEmail(), NULL)),
<a class="jxr_linenumber" name="L576" href="#L576">576</a>                       f(<span class="jxr_string">"username"</span>, r.getAuthor().getUsername())
<a class="jxr_linenumber" name="L577" href="#L577">577</a>               ))
<a class="jxr_linenumber" name="L578" href="#L578">578</a>       );
<a class="jxr_linenumber" name="L579" href="#L579">579</a>       repliesArr.add(thing);
<a class="jxr_linenumber" name="L580" href="#L580">580</a>     }
<a class="jxr_linenumber" name="L581" href="#L581">581</a> 
<a class="jxr_linenumber" name="L582" href="#L582">582</a>     <strong class="jxr_keyword">return</strong> repliesArr;
<a class="jxr_linenumber" name="L583" href="#L583">583</a>   }
<a class="jxr_linenumber" name="L584" href="#L584">584</a> 
<a class="jxr_linenumber" name="L585" href="#L585">585</a>   @GET
<a class="jxr_linenumber" name="L586" href="#L586">586</a>   @Path(<span class="jxr_string">"{eventId}/scheduling.json"</span>)
<a class="jxr_linenumber" name="L587" href="#L587">587</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L588" href="#L588">588</a>   @RestQuery(name = <span class="jxr_string">"getEventSchedulingMetadata"</span>, description = <span class="jxr_string">"Returns all of the scheduling metadata for an event"</span>, returnDescription = <span class="jxr_string">"All the technical metadata related to scheduling as JSON"</span>, pathParameters = {
<a class="jxr_linenumber" name="L589" href="#L589">589</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id (mediapackage id)."</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L590" href="#L590">590</a>                   @RestResponse(description = <span class="jxr_string">"Returns all the data related to the event scheduling tab as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L591" href="#L591">591</a>                   @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L592" href="#L592">592</a>   <strong class="jxr_keyword">public</strong> Response getEventScheduling(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId)
<a class="jxr_linenumber" name="L593" href="#L593">593</a>           <strong class="jxr_keyword">throws</strong> NotFoundException, UnauthorizedException, SearchIndexException {
<a class="jxr_linenumber" name="L594" href="#L594">594</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L595" href="#L595">595</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L596" href="#L596">596</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId);
<a class="jxr_linenumber" name="L597" href="#L597">597</a> 
<a class="jxr_linenumber" name="L598" href="#L598">598</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L599" href="#L599">599</a>       TechnicalMetadata technicalMetadata = getSchedulerService().getTechnicalMetadata(eventId);
<a class="jxr_linenumber" name="L600" href="#L600">600</a>       <strong class="jxr_keyword">return</strong> okJson(technicalMetadataToJson.apply(technicalMetadata));
<a class="jxr_linenumber" name="L601" href="#L601">601</a>     } <strong class="jxr_keyword">catch</strong> (SchedulerException e) {
<a class="jxr_linenumber" name="L602" href="#L602">602</a>       logger.error(<span class="jxr_string">"Unable to get technical metadata for event with id {}"</span>, eventId);
<a class="jxr_linenumber" name="L603" href="#L603">603</a>       <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> WebApplicationException(e, SC_INTERNAL_SERVER_ERROR);
<a class="jxr_linenumber" name="L604" href="#L604">604</a>     }
<a class="jxr_linenumber" name="L605" href="#L605">605</a>   }
<a class="jxr_linenumber" name="L606" href="#L606">606</a> 
<a class="jxr_linenumber" name="L607" href="#L607">607</a>   @POST
<a class="jxr_linenumber" name="L608" href="#L608">608</a>   @Path(<span class="jxr_string">"scheduling.json"</span>)
<a class="jxr_linenumber" name="L609" href="#L609">609</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L610" href="#L610">610</a>   @RestQuery(name = <span class="jxr_string">"getEventsScheduling"</span>, description = <span class="jxr_string">"Returns all of the scheduling metadata for a list of events"</span>, returnDescription = <span class="jxr_string">"All the technical metadata related to scheduling as JSON"</span>, restParameters = {
<a class="jxr_linenumber" name="L611" href="#L611">611</a>     @RestParameter(name = <span class="jxr_string">"eventIds"</span>, description = <span class="jxr_string">"An array of event IDs (mediapackage id)"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L612" href="#L612">612</a>     @RestParameter(name = <span class="jxr_string">"ignoreNonScheduled"</span>, description = <span class="jxr_string">"Whether events that are not really scheduled events should be ignored or produce an error"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.BOOLEAN) }, responses = {
<a class="jxr_linenumber" name="L613" href="#L613">613</a>     @RestResponse(description = <span class="jxr_string">"Returns all the data related to the event scheduling tab as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L614" href="#L614">614</a>     @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L615" href="#L615">615</a>   <strong class="jxr_keyword">public</strong> Response getEventsScheduling(@FormParam(<span class="jxr_string">"eventIds"</span>) <strong class="jxr_keyword">final</strong> List&lt;String&gt; eventIds, @FormParam(<span class="jxr_string">"ignoreNonScheduled"</span>) <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">boolean</strong> ignoreNonScheduled) {
<a class="jxr_linenumber" name="L616" href="#L616">616</a>     <strong class="jxr_keyword">final</strong> List&lt;JValue&gt; fields = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;(eventIds.size());
<a class="jxr_linenumber" name="L617" href="#L617">617</a>     <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> String eventId : eventIds) {
<a class="jxr_linenumber" name="L618" href="#L618">618</a>       <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L619" href="#L619">619</a>         fields.add(technicalMetadataToJson.apply(getSchedulerService().getTechnicalMetadata(eventId)));
<a class="jxr_linenumber" name="L620" href="#L620">620</a>       } <strong class="jxr_keyword">catch</strong> (<strong class="jxr_keyword">final</strong> NotFoundException e) {
<a class="jxr_linenumber" name="L621" href="#L621">621</a>         <strong class="jxr_keyword">if</strong> (!ignoreNonScheduled) {
<a class="jxr_linenumber" name="L622" href="#L622">622</a>           logger.warn(<span class="jxr_string">"Unable to find id {}"</span>, eventId, e);
<a class="jxr_linenumber" name="L623" href="#L623">623</a>           <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId);
<a class="jxr_linenumber" name="L624" href="#L624">624</a>         }
<a class="jxr_linenumber" name="L625" href="#L625">625</a>       } <strong class="jxr_keyword">catch</strong> (<strong class="jxr_keyword">final</strong> UnauthorizedException e) {
<a class="jxr_linenumber" name="L626" href="#L626">626</a>         logger.warn(<span class="jxr_string">"Unauthorized access to event ID {}"</span>, eventId, e);
<a class="jxr_linenumber" name="L627" href="#L627">627</a>         <strong class="jxr_keyword">return</strong> Response.status(Status.BAD_REQUEST).build();
<a class="jxr_linenumber" name="L628" href="#L628">628</a>       } <strong class="jxr_keyword">catch</strong> (<strong class="jxr_keyword">final</strong> SchedulerException e) {
<a class="jxr_linenumber" name="L629" href="#L629">629</a>         logger.warn(<span class="jxr_string">"Scheduler exception accessing event ID {}"</span>, eventId, e);
<a class="jxr_linenumber" name="L630" href="#L630">630</a>         <strong class="jxr_keyword">return</strong> Response.status(Status.BAD_REQUEST).build();
<a class="jxr_linenumber" name="L631" href="#L631">631</a>       }
<a class="jxr_linenumber" name="L632" href="#L632">632</a>     }
<a class="jxr_linenumber" name="L633" href="#L633">633</a>     <strong class="jxr_keyword">return</strong> okJson(arr(fields));
<a class="jxr_linenumber" name="L634" href="#L634">634</a>   }
<a class="jxr_linenumber" name="L635" href="#L635">635</a> 
<a class="jxr_linenumber" name="L636" href="#L636">636</a>   @PUT
<a class="jxr_linenumber" name="L637" href="#L637">637</a>   @Path(<span class="jxr_string">"{eventId}/scheduling"</span>)
<a class="jxr_linenumber" name="L638" href="#L638">638</a>   @RestQuery(name = <span class="jxr_string">"updateEventScheduling"</span>, description = <span class="jxr_string">"Updates the scheduling information of an event"</span>, returnDescription = <span class="jxr_string">"The method doesn't return any content"</span>, pathParameters = {
<a class="jxr_linenumber" name="L639" href="#L639">639</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The event identifier"</span>, type = RestParameter.Type.STRING) }, restParameters = {
<a class="jxr_linenumber" name="L640" href="#L640">640</a>                   @RestParameter(name = <span class="jxr_string">"scheduling"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The updated scheduling (JSON object)"</span>, type = RestParameter.Type.TEXT) }, responses = {
<a class="jxr_linenumber" name="L641" href="#L641">641</a>                           @RestResponse(responseCode = SC_BAD_REQUEST, description = <span class="jxr_string">"The required params were missing in the request."</span>),
<a class="jxr_linenumber" name="L642" href="#L642">642</a>                           @RestResponse(responseCode = SC_NOT_FOUND, description = <span class="jxr_string">"If the event has not been found."</span>),
<a class="jxr_linenumber" name="L643" href="#L643">643</a>                           @RestResponse(responseCode = SC_NO_CONTENT, description = <span class="jxr_string">"The method doesn't return any content"</span>) })
<a class="jxr_linenumber" name="L644" href="#L644">644</a>   <strong class="jxr_keyword">public</strong> Response updateEventScheduling(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId,
<a class="jxr_linenumber" name="L645" href="#L645">645</a>           @FormParam(<span class="jxr_string">"scheduling"</span>) String scheduling)
<a class="jxr_linenumber" name="L646" href="#L646">646</a>           <strong class="jxr_keyword">throws</strong> NotFoundException, UnauthorizedException, SearchIndexException, IndexServiceException {
<a class="jxr_linenumber" name="L647" href="#L647">647</a>     <strong class="jxr_keyword">if</strong> (StringUtils.isBlank(scheduling))
<a class="jxr_linenumber" name="L648" href="#L648">648</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.badRequest(<span class="jxr_string">"Missing parameters"</span>);
<a class="jxr_linenumber" name="L649" href="#L649">649</a> 
<a class="jxr_linenumber" name="L650" href="#L650">650</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L651" href="#L651">651</a>       <strong class="jxr_keyword">final</strong> Event event = getEventOrThrowNotFoundException(eventId);
<a class="jxr_linenumber" name="L652" href="#L652">652</a>       updateEventScheduling(scheduling, event);
<a class="jxr_linenumber" name="L653" href="#L653">653</a>       <strong class="jxr_keyword">return</strong> Response.noContent().build();
<a class="jxr_linenumber" name="L654" href="#L654">654</a>     } <strong class="jxr_keyword">catch</strong> (JSONException e) {
<a class="jxr_linenumber" name="L655" href="#L655">655</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.badRequest(<span class="jxr_string">"The scheduling object is not valid"</span>);
<a class="jxr_linenumber" name="L656" href="#L656">656</a>     } <strong class="jxr_keyword">catch</strong> (ParseException e) {
<a class="jxr_linenumber" name="L657" href="#L657">657</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.badRequest(<span class="jxr_string">"The UTC dates in the scheduling object is not valid"</span>);
<a class="jxr_linenumber" name="L658" href="#L658">658</a>     } <strong class="jxr_keyword">catch</strong> (SchedulerException e) {
<a class="jxr_linenumber" name="L659" href="#L659">659</a>       logger.error(<span class="jxr_string">"Unable to update scheduling technical metadata of event {}"</span>, eventId, e);
<a class="jxr_linenumber" name="L660" href="#L660">660</a>       <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> WebApplicationException(e, SC_INTERNAL_SERVER_ERROR);
<a class="jxr_linenumber" name="L661" href="#L661">661</a>     } <strong class="jxr_keyword">catch</strong> (IllegalStateException e) {
<a class="jxr_linenumber" name="L662" href="#L662">662</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.badRequest(e.getMessage());
<a class="jxr_linenumber" name="L663" href="#L663">663</a>     }
<a class="jxr_linenumber" name="L664" href="#L664">664</a>   }
<a class="jxr_linenumber" name="L665" href="#L665">665</a> 
<a class="jxr_linenumber" name="L666" href="#L666">666</a>   <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">void</strong> updateEventScheduling(String scheduling, Event event) <strong class="jxr_keyword">throws</strong> NotFoundException, UnauthorizedException,
<a class="jxr_linenumber" name="L667" href="#L667">667</a>     SchedulerException, JSONException, ParseException, SearchIndexException, IndexServiceException {
<a class="jxr_linenumber" name="L668" href="#L668">668</a>     <strong class="jxr_keyword">final</strong> TechnicalMetadata technicalMetadata = getSchedulerService().getTechnicalMetadata(event.getIdentifier());
<a class="jxr_linenumber" name="L669" href="#L669">669</a>     <strong class="jxr_keyword">final</strong> org.codehaus.jettison.json.JSONObject schedulingJson = <strong class="jxr_keyword">new</strong> org.codehaus.jettison.json.JSONObject(
<a class="jxr_linenumber" name="L670" href="#L670">670</a>             scheduling);
<a class="jxr_linenumber" name="L671" href="#L671">671</a>     Optional&lt;String&gt; agentId = Optional.empty();
<a class="jxr_linenumber" name="L672" href="#L672">672</a>     <strong class="jxr_keyword">if</strong> (schedulingJson.has(SCHEDULING_AGENT_ID_KEY)) {
<a class="jxr_linenumber" name="L673" href="#L673">673</a>       agentId = Optional.of(schedulingJson.getString(SCHEDULING_AGENT_ID_KEY));
<a class="jxr_linenumber" name="L674" href="#L674">674</a>       logger.trace(<span class="jxr_string">"Updating agent id of event '{}' from '{}' to '{}'"</span>,
<a class="jxr_linenumber" name="L675" href="#L675">675</a>               event.getIdentifier(), technicalMetadata.getAgentId(), agentId);
<a class="jxr_linenumber" name="L676" href="#L676">676</a>     }
<a class="jxr_linenumber" name="L677" href="#L677">677</a> 
<a class="jxr_linenumber" name="L678" href="#L678">678</a>     Opt&lt;String&gt; previousAgentId = Opt.none();
<a class="jxr_linenumber" name="L679" href="#L679">679</a>     <strong class="jxr_keyword">if</strong> (schedulingJson.has(SCHEDULING_PREVIOUS_AGENTID)) {
<a class="jxr_linenumber" name="L680" href="#L680">680</a>       previousAgentId = Opt.some(schedulingJson.getString(SCHEDULING_PREVIOUS_AGENTID));
<a class="jxr_linenumber" name="L681" href="#L681">681</a>     }
<a class="jxr_linenumber" name="L682" href="#L682">682</a> 
<a class="jxr_linenumber" name="L683" href="#L683">683</a>     Optional&lt;String&gt; previousAgentInputs = Optional.empty();
<a class="jxr_linenumber" name="L684" href="#L684">684</a>     Optional&lt;String&gt; agentInputs = Optional.empty();
<a class="jxr_linenumber" name="L685" href="#L685">685</a>     <strong class="jxr_keyword">if</strong> (agentId.isPresent() &amp;&amp; previousAgentId.isSome()) {
<a class="jxr_linenumber" name="L686" href="#L686">686</a>       Agent previousAgent = getCaptureAgentStateService().getAgent(previousAgentId.get());
<a class="jxr_linenumber" name="L687" href="#L687">687</a>       Agent agent = getCaptureAgentStateService().getAgent(agentId.get());
<a class="jxr_linenumber" name="L688" href="#L688">688</a> 
<a class="jxr_linenumber" name="L689" href="#L689">689</a>       previousAgentInputs = Optional.ofNullable(previousAgent.getCapabilities().getProperty(CaptureParameters.CAPTURE_DEVICE_NAMES));
<a class="jxr_linenumber" name="L690" href="#L690">690</a>       agentInputs = Optional.ofNullable(agent.getCapabilities().getProperty(CaptureParameters.CAPTURE_DEVICE_NAMES));
<a class="jxr_linenumber" name="L691" href="#L691">691</a>     }
<a class="jxr_linenumber" name="L692" href="#L692">692</a> 
<a class="jxr_linenumber" name="L693" href="#L693">693</a>     <em class="jxr_comment">// Check if we are allowed to re-schedule on this agent</em>
<a class="jxr_linenumber" name="L694" href="#L694">694</a>     checkAgentAccessForAgent(technicalMetadata.getAgentId());
<a class="jxr_linenumber" name="L695" href="#L695">695</a>     <strong class="jxr_keyword">if</strong> (agentId.isPresent()) {
<a class="jxr_linenumber" name="L696" href="#L696">696</a>       checkAgentAccessForAgent(agentId.get());
<a class="jxr_linenumber" name="L697" href="#L697">697</a>     }
<a class="jxr_linenumber" name="L698" href="#L698">698</a> 
<a class="jxr_linenumber" name="L699" href="#L699">699</a>     Optional&lt;Date&gt; start = Optional.empty();
<a class="jxr_linenumber" name="L700" href="#L700">700</a>     <strong class="jxr_keyword">if</strong> (schedulingJson.has(SCHEDULING_START_KEY)) {
<a class="jxr_linenumber" name="L701" href="#L701">701</a>       start = Optional.of(<strong class="jxr_keyword">new</strong> Date(DateTimeSupport.fromUTC(schedulingJson.getString(SCHEDULING_START_KEY))));
<a class="jxr_linenumber" name="L702" href="#L702">702</a>       logger.trace(<span class="jxr_string">"Updating start time of event '{}' id from '{}' to '{}'"</span>,
<a class="jxr_linenumber" name="L703" href="#L703">703</a>         event.getIdentifier(), DateTimeSupport.toUTC(technicalMetadata.getStartDate().getTime()),
<a class="jxr_linenumber" name="L704" href="#L704">704</a>                       DateTimeSupport.toUTC(start.get().getTime()));
<a class="jxr_linenumber" name="L705" href="#L705">705</a>     }
<a class="jxr_linenumber" name="L706" href="#L706">706</a> 
<a class="jxr_linenumber" name="L707" href="#L707">707</a>     Optional&lt;Date&gt; end = Optional.empty();
<a class="jxr_linenumber" name="L708" href="#L708">708</a>     <strong class="jxr_keyword">if</strong> (schedulingJson.has(SCHEDULING_END_KEY)) {
<a class="jxr_linenumber" name="L709" href="#L709">709</a>       end = Optional.of(<strong class="jxr_keyword">new</strong> Date(DateTimeSupport.fromUTC(schedulingJson.getString(SCHEDULING_END_KEY))));
<a class="jxr_linenumber" name="L710" href="#L710">710</a>       logger.trace(<span class="jxr_string">"Updating end time of event '{}' id from '{}' to '{}'"</span>,
<a class="jxr_linenumber" name="L711" href="#L711">711</a>         event.getIdentifier(), DateTimeSupport.toUTC(technicalMetadata.getEndDate().getTime()),
<a class="jxr_linenumber" name="L712" href="#L712">712</a>                       DateTimeSupport.toUTC(end.get().getTime()));
<a class="jxr_linenumber" name="L713" href="#L713">713</a>     }
<a class="jxr_linenumber" name="L714" href="#L714">714</a> 
<a class="jxr_linenumber" name="L715" href="#L715">715</a>     Optional&lt;Map&lt;String, String&gt;&gt; agentConfiguration = Optional.empty();
<a class="jxr_linenumber" name="L716" href="#L716">716</a>     <strong class="jxr_keyword">if</strong> (schedulingJson.has(SCHEDULING_AGENT_CONFIGURATION_KEY)) {
<a class="jxr_linenumber" name="L717" href="#L717">717</a>       agentConfiguration = Optional.of(JSONUtils.toMap(schedulingJson.getJSONObject(SCHEDULING_AGENT_CONFIGURATION_KEY)));
<a class="jxr_linenumber" name="L718" href="#L718">718</a>       logger.trace(<span class="jxr_string">"Updating agent configuration of event '{}' id from '{}' to '{}'"</span>,
<a class="jxr_linenumber" name="L719" href="#L719">719</a>         event.getIdentifier(), technicalMetadata.getCaptureAgentConfiguration(), agentConfiguration);
<a class="jxr_linenumber" name="L720" href="#L720">720</a>     }
<a class="jxr_linenumber" name="L721" href="#L721">721</a> 
<a class="jxr_linenumber" name="L722" href="#L722">722</a>     Opt&lt;Map&lt;String, String&gt;&gt; previousAgentInputMethods = Opt.none();
<a class="jxr_linenumber" name="L723" href="#L723">723</a>     <strong class="jxr_keyword">if</strong> (schedulingJson.has(SCHEDULING_PREVIOUS_PREVIOUSENTRIES)) {
<a class="jxr_linenumber" name="L724" href="#L724">724</a>       previousAgentInputMethods = Opt.some(
<a class="jxr_linenumber" name="L725" href="#L725">725</a>               JSONUtils.toMap(schedulingJson.getJSONObject(SCHEDULING_PREVIOUS_PREVIOUSENTRIES)));
<a class="jxr_linenumber" name="L726" href="#L726">726</a>     }
<a class="jxr_linenumber" name="L727" href="#L727">727</a> 
<a class="jxr_linenumber" name="L728" href="#L728">728</a>     <em class="jxr_comment">// If we had previously selected an agent, and both the old and new agent have the same set of input channels,</em>
<a class="jxr_linenumber" name="L729" href="#L729">729</a>     <em class="jxr_comment">// copy which input channels are active to the new agent</em>
<a class="jxr_linenumber" name="L730" href="#L730">730</a>     <strong class="jxr_keyword">if</strong> (previousAgentInputs.isPresent() &amp;&amp; previousAgentInputs.isPresent() &amp;&amp; agentInputs.isPresent()) {
<a class="jxr_linenumber" name="L731" href="#L731">731</a>       Map&lt;String, String&gt; map = previousAgentInputMethods.get();
<a class="jxr_linenumber" name="L732" href="#L732">732</a>       String mapAsString = map.keySet().stream()
<a class="jxr_linenumber" name="L733" href="#L733">733</a>               .collect(Collectors.joining(<span class="jxr_string">","</span>));
<a class="jxr_linenumber" name="L734" href="#L734">734</a>       String previousInputs = mapAsString;
<a class="jxr_linenumber" name="L735" href="#L735">735</a> 
<a class="jxr_linenumber" name="L736" href="#L736">736</a>       <strong class="jxr_keyword">if</strong> (previousAgentInputs.equals(agentInputs)) {
<a class="jxr_linenumber" name="L737" href="#L737">737</a>         <strong class="jxr_keyword">final</strong> Map&lt;String, String&gt; configMap = <strong class="jxr_keyword">new</strong> HashMap&lt;&gt;(agentConfiguration.get());
<a class="jxr_linenumber" name="L738" href="#L738">738</a>         configMap.put(CaptureParameters.CAPTURE_DEVICE_NAMES, previousInputs);
<a class="jxr_linenumber" name="L739" href="#L739">739</a>         agentConfiguration = Optional.of(configMap);
<a class="jxr_linenumber" name="L740" href="#L740">740</a>       }
<a class="jxr_linenumber" name="L741" href="#L741">741</a>     }
<a class="jxr_linenumber" name="L742" href="#L742">742</a> 
<a class="jxr_linenumber" name="L743" href="#L743">743</a>     <strong class="jxr_keyword">if</strong> ((start.isPresent() || end.isPresent())
<a class="jxr_linenumber" name="L744" href="#L744">744</a>             &amp;&amp; end.orElse(technicalMetadata.getEndDate()).before(start.orElse(technicalMetadata.getStartDate()))) {
<a class="jxr_linenumber" name="L745" href="#L745">745</a>       <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> IllegalStateException(<span class="jxr_string">"The end date is before the start date"</span>);
<a class="jxr_linenumber" name="L746" href="#L746">746</a>     }
<a class="jxr_linenumber" name="L747" href="#L747">747</a> 
<a class="jxr_linenumber" name="L748" href="#L748">748</a>     <strong class="jxr_keyword">if</strong> (!start.isEmpty() || !end.isEmpty() || !agentId.isEmpty() || !agentConfiguration.isEmpty()) {
<a class="jxr_linenumber" name="L749" href="#L749">749</a>       getSchedulerService()
<a class="jxr_linenumber" name="L750" href="#L750">750</a>         .updateEvent(event.getIdentifier(), start, end, agentId, Optional.empty(), Optional.empty(), Optional.empty(), agentConfiguration);
<a class="jxr_linenumber" name="L751" href="#L751">751</a>     }
<a class="jxr_linenumber" name="L752" href="#L752">752</a>   }
<a class="jxr_linenumber" name="L753" href="#L753">753</a> 
<a class="jxr_linenumber" name="L754" href="#L754">754</a>   <strong class="jxr_keyword">private</strong> Event getEventOrThrowNotFoundException(<strong class="jxr_keyword">final</strong> String eventId) <strong class="jxr_keyword">throws</strong> NotFoundException, SearchIndexException {
<a class="jxr_linenumber" name="L755" href="#L755">755</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L756" href="#L756">756</a>     <strong class="jxr_keyword">if</strong> (optEvent.isSome()) {
<a class="jxr_linenumber" name="L757" href="#L757">757</a>       <strong class="jxr_keyword">return</strong> optEvent.get();
<a class="jxr_linenumber" name="L758" href="#L758">758</a>     } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L759" href="#L759">759</a>       <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> NotFoundException(format(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId));
<a class="jxr_linenumber" name="L760" href="#L760">760</a>     }
<a class="jxr_linenumber" name="L761" href="#L761">761</a>   }
<a class="jxr_linenumber" name="L762" href="#L762">762</a> 
<a class="jxr_linenumber" name="L763" href="#L763">763</a>   @GET
<a class="jxr_linenumber" name="L764" href="#L764">764</a>   @Path(<span class="jxr_string">"{eventId}/comments"</span>)
<a class="jxr_linenumber" name="L765" href="#L765">765</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L766" href="#L766">766</a>   @RestQuery(name = <span class="jxr_string">"geteventcomments"</span>, description = <span class="jxr_string">"Returns all the data related to the comments tab in the event details modal as JSON"</span>, returnDescription = <span class="jxr_string">"All the data related to the event comments tab as JSON"</span>, pathParameters = {
<a class="jxr_linenumber" name="L767" href="#L767">767</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L768" href="#L768">768</a>                   @RestResponse(description = <span class="jxr_string">"Returns all the data related to the event comments tab as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L769" href="#L769">769</a>                   @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L770" href="#L770">770</a>   <strong class="jxr_keyword">public</strong> Response getEventComments(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L771" href="#L771">771</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L772" href="#L772">772</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L773" href="#L773">773</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId);
<a class="jxr_linenumber" name="L774" href="#L774">774</a> 
<a class="jxr_linenumber" name="L775" href="#L775">775</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L776" href="#L776">776</a>       List&lt;EventComment&gt; comments = getEventCommentService().getComments(eventId);
<a class="jxr_linenumber" name="L777" href="#L777">777</a>       List&lt;Val&gt; commentArr = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L778" href="#L778">778</a>       <strong class="jxr_keyword">for</strong> (EventComment c : comments) {
<a class="jxr_linenumber" name="L779" href="#L779">779</a>         commentArr.add(c.toJson());
<a class="jxr_linenumber" name="L780" href="#L780">780</a>       }
<a class="jxr_linenumber" name="L781" href="#L781">781</a>       <strong class="jxr_keyword">return</strong> Response.ok(org.opencastproject.util.Jsons.arr(commentArr).toJson(), MediaType.APPLICATION_JSON_TYPE)
<a class="jxr_linenumber" name="L782" href="#L782">782</a>               .build();
<a class="jxr_linenumber" name="L783" href="#L783">783</a>     } <strong class="jxr_keyword">catch</strong> (EventCommentException e) {
<a class="jxr_linenumber" name="L784" href="#L784">784</a>       logger.error(<span class="jxr_string">"Unable to get comments from event {}"</span>, eventId, e);
<a class="jxr_linenumber" name="L785" href="#L785">785</a>       <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> WebApplicationException(e);
<a class="jxr_linenumber" name="L786" href="#L786">786</a>     }
<a class="jxr_linenumber" name="L787" href="#L787">787</a>   }
<a class="jxr_linenumber" name="L788" href="#L788">788</a> 
<a class="jxr_linenumber" name="L789" href="#L789">789</a>   @GET
<a class="jxr_linenumber" name="L790" href="#L790">790</a>   @Path(<span class="jxr_string">"{eventId}/hasActiveTransaction"</span>)
<a class="jxr_linenumber" name="L791" href="#L791">791</a>   @Produces(MediaType.TEXT_PLAIN)
<a class="jxr_linenumber" name="L792" href="#L792">792</a>   @RestQuery(name = <span class="jxr_string">"hasactivetransaction"</span>, description = <span class="jxr_string">"Returns whether there is currently a transaction in progress for the given event"</span>, returnDescription = <span class="jxr_string">"Whether there is currently a transaction in progress for the given event"</span>, pathParameters = {
<a class="jxr_linenumber" name="L793" href="#L793">793</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L794" href="#L794">794</a>                   @RestResponse(description = <span class="jxr_string">"Returns whether there is currently a transaction in progress for the given event"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L795" href="#L795">795</a>                   @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L796" href="#L796">796</a>   <strong class="jxr_keyword">public</strong> Response hasActiveTransaction(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L797" href="#L797">797</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L798" href="#L798">798</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L799" href="#L799">799</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId);
<a class="jxr_linenumber" name="L800" href="#L800">800</a> 
<a class="jxr_linenumber" name="L801" href="#L801">801</a>     JSONObject json = <strong class="jxr_keyword">new</strong> JSONObject();
<a class="jxr_linenumber" name="L802" href="#L802">802</a> 
<a class="jxr_linenumber" name="L803" href="#L803">803</a>     <strong class="jxr_keyword">if</strong> (WorkflowUtil.isActive(optEvent.get().getWorkflowState())) {
<a class="jxr_linenumber" name="L804" href="#L804">804</a>       json.put(<span class="jxr_string">"active"</span>, <strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="L805" href="#L805">805</a>     } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L806" href="#L806">806</a>       json.put(<span class="jxr_string">"active"</span>, false);
<a class="jxr_linenumber" name="L807" href="#L807">807</a>     }
<a class="jxr_linenumber" name="L808" href="#L808">808</a> 
<a class="jxr_linenumber" name="L809" href="#L809">809</a>     <strong class="jxr_keyword">return</strong> Response.ok(json.toJSONString()).build();
<a class="jxr_linenumber" name="L810" href="#L810">810</a>   }
<a class="jxr_linenumber" name="L811" href="#L811">811</a> 
<a class="jxr_linenumber" name="L812" href="#L812">812</a>   @GET
<a class="jxr_linenumber" name="L813" href="#L813">813</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L814" href="#L814">814</a>   @Path(<span class="jxr_string">"{eventId}/comment/{commentId}"</span>)
<a class="jxr_linenumber" name="L815" href="#L815">815</a>   @RestQuery(name = <span class="jxr_string">"geteventcomment"</span>, description = <span class="jxr_string">"Returns the comment with the given identifier"</span>, returnDescription = <span class="jxr_string">"Returns the comment as JSON"</span>, pathParameters = {
<a class="jxr_linenumber" name="L816" href="#L816">816</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L817" href="#L817">817</a>           @RestParameter(name = <span class="jxr_string">"commentId"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The comment identifier"</span>, type = STRING) }, responses = {
<a class="jxr_linenumber" name="L818" href="#L818">818</a>                   @RestResponse(responseCode = SC_OK, description = <span class="jxr_string">"The comment as JSON."</span>),
<a class="jxr_linenumber" name="L819" href="#L819">819</a>                   @RestResponse(responseCode = SC_NOT_FOUND, description = <span class="jxr_string">"No event or comment with this identifier was found."</span>) })
<a class="jxr_linenumber" name="L820" href="#L820">820</a>   <strong class="jxr_keyword">public</strong> Response getEventComment(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId, @PathParam(<span class="jxr_string">"commentId"</span>) <strong class="jxr_keyword">long</strong> commentId)
<a class="jxr_linenumber" name="L821" href="#L821">821</a>           <strong class="jxr_keyword">throws</strong> NotFoundException, Exception {
<a class="jxr_linenumber" name="L822" href="#L822">822</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L823" href="#L823">823</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L824" href="#L824">824</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId);
<a class="jxr_linenumber" name="L825" href="#L825">825</a> 
<a class="jxr_linenumber" name="L826" href="#L826">826</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L827" href="#L827">827</a>       EventComment comment = getEventCommentService().getComment(commentId);
<a class="jxr_linenumber" name="L828" href="#L828">828</a>       <strong class="jxr_keyword">return</strong> Response.ok(comment.toJson().toJson()).build();
<a class="jxr_linenumber" name="L829" href="#L829">829</a>     } <strong class="jxr_keyword">catch</strong> (NotFoundException e) {
<a class="jxr_linenumber" name="L830" href="#L830">830</a>       <strong class="jxr_keyword">throw</strong> e;
<a class="jxr_linenumber" name="L831" href="#L831">831</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L832" href="#L832">832</a>       logger.error(<span class="jxr_string">"Could not retrieve comment {}"</span>, commentId, e);
<a class="jxr_linenumber" name="L833" href="#L833">833</a>       <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> WebApplicationException(e);
<a class="jxr_linenumber" name="L834" href="#L834">834</a>     }
<a class="jxr_linenumber" name="L835" href="#L835">835</a>   }
<a class="jxr_linenumber" name="L836" href="#L836">836</a> 
<a class="jxr_linenumber" name="L837" href="#L837">837</a>   @PUT
<a class="jxr_linenumber" name="L838" href="#L838">838</a>   @Path(<span class="jxr_string">"{eventId}/comment/{commentId}"</span>)
<a class="jxr_linenumber" name="L839" href="#L839">839</a>   @RestQuery(name = <span class="jxr_string">"updateeventcomment"</span>, description = <span class="jxr_string">"Updates an event comment"</span>, returnDescription = <span class="jxr_string">"The updated comment as JSON."</span>, pathParameters = {
<a class="jxr_linenumber" name="L840" href="#L840">840</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L841" href="#L841">841</a>           @RestParameter(name = <span class="jxr_string">"commentId"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The comment identifier"</span>, type = STRING) }, restParameters = {
<a class="jxr_linenumber" name="L842" href="#L842">842</a>                   @RestParameter(name = <span class="jxr_string">"text"</span>, isRequired = false, description = <span class="jxr_string">"The comment text"</span>, type = TEXT),
<a class="jxr_linenumber" name="L843" href="#L843">843</a>                   @RestParameter(name = <span class="jxr_string">"reason"</span>, isRequired = false, description = <span class="jxr_string">"The comment reason"</span>, type = STRING),
<a class="jxr_linenumber" name="L844" href="#L844">844</a>                   @RestParameter(name = <span class="jxr_string">"resolved"</span>, isRequired = false, description = <span class="jxr_string">"The comment resolved status"</span>, type = RestParameter.Type.BOOLEAN) }, responses = {
<a class="jxr_linenumber" name="L845" href="#L845">845</a>                           @RestResponse(responseCode = SC_NOT_FOUND, description = <span class="jxr_string">"The event or comment to update has not been found."</span>),
<a class="jxr_linenumber" name="L846" href="#L846">846</a>                           @RestResponse(responseCode = SC_OK, description = <span class="jxr_string">"The updated comment as JSON."</span>) })
<a class="jxr_linenumber" name="L847" href="#L847">847</a>   <strong class="jxr_keyword">public</strong> Response updateEventComment(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId, @PathParam(<span class="jxr_string">"commentId"</span>) <strong class="jxr_keyword">long</strong> commentId,
<a class="jxr_linenumber" name="L848" href="#L848">848</a>           @FormParam(<span class="jxr_string">"text"</span>) String text, @FormParam(<span class="jxr_string">"reason"</span>) String reason, @FormParam(<span class="jxr_string">"resolved"</span>) Boolean resolved)
<a class="jxr_linenumber" name="L849" href="#L849">849</a>                   <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L850" href="#L850">850</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L851" href="#L851">851</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L852" href="#L852">852</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId);
<a class="jxr_linenumber" name="L853" href="#L853">853</a> 
<a class="jxr_linenumber" name="L854" href="#L854">854</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L855" href="#L855">855</a>       EventComment dto = getEventCommentService().getComment(commentId);
<a class="jxr_linenumber" name="L856" href="#L856">856</a> 
<a class="jxr_linenumber" name="L857" href="#L857">857</a>       <strong class="jxr_keyword">if</strong> (StringUtils.isNotBlank(text)) {
<a class="jxr_linenumber" name="L858" href="#L858">858</a>         text = text.trim();
<a class="jxr_linenumber" name="L859" href="#L859">859</a>       } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L860" href="#L860">860</a>         text = dto.getText();
<a class="jxr_linenumber" name="L861" href="#L861">861</a>       }
<a class="jxr_linenumber" name="L862" href="#L862">862</a> 
<a class="jxr_linenumber" name="L863" href="#L863">863</a>       <strong class="jxr_keyword">if</strong> (StringUtils.isNotBlank(reason)) {
<a class="jxr_linenumber" name="L864" href="#L864">864</a>         reason = reason.trim();
<a class="jxr_linenumber" name="L865" href="#L865">865</a>       } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L866" href="#L866">866</a>         reason = dto.getReason();
<a class="jxr_linenumber" name="L867" href="#L867">867</a>       }
<a class="jxr_linenumber" name="L868" href="#L868">868</a> 
<a class="jxr_linenumber" name="L869" href="#L869">869</a>       <strong class="jxr_keyword">if</strong> (resolved == <strong class="jxr_keyword">null</strong>)
<a class="jxr_linenumber" name="L870" href="#L870">870</a>         resolved = dto.isResolvedStatus();
<a class="jxr_linenumber" name="L871" href="#L871">871</a> 
<a class="jxr_linenumber" name="L872" href="#L872">872</a>       EventComment updatedComment = EventComment.create(dto.getId(), eventId,
<a class="jxr_linenumber" name="L873" href="#L873">873</a>               getSecurityService().getOrganization().getId(), text, dto.getAuthor(), reason, resolved,
<a class="jxr_linenumber" name="L874" href="#L874">874</a>               dto.getCreationDate(), <strong class="jxr_keyword">new</strong> Date(), dto.getReplies());
<a class="jxr_linenumber" name="L875" href="#L875">875</a> 
<a class="jxr_linenumber" name="L876" href="#L876">876</a>       updatedComment = getEventCommentService().updateComment(updatedComment);
<a class="jxr_linenumber" name="L877" href="#L877">877</a>       List&lt;EventComment&gt; comments = getEventCommentService().getComments(eventId);
<a class="jxr_linenumber" name="L878" href="#L878">878</a>       getIndexService().updateCommentCatalog(optEvent.get(), comments);
<a class="jxr_linenumber" name="L879" href="#L879">879</a>       <strong class="jxr_keyword">return</strong> Response.ok(updatedComment.toJson().toJson()).build();
<a class="jxr_linenumber" name="L880" href="#L880">880</a>     } <strong class="jxr_keyword">catch</strong> (NotFoundException e) {
<a class="jxr_linenumber" name="L881" href="#L881">881</a>       <strong class="jxr_keyword">throw</strong> e;
<a class="jxr_linenumber" name="L882" href="#L882">882</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L883" href="#L883">883</a>       logger.error(<span class="jxr_string">"Unable to update the comments catalog on event {}"</span>, eventId, e);
<a class="jxr_linenumber" name="L884" href="#L884">884</a>       <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> WebApplicationException(e);
<a class="jxr_linenumber" name="L885" href="#L885">885</a>     }
<a class="jxr_linenumber" name="L886" href="#L886">886</a>   }
<a class="jxr_linenumber" name="L887" href="#L887">887</a> 
<a class="jxr_linenumber" name="L888" href="#L888">888</a>   @POST
<a class="jxr_linenumber" name="L889" href="#L889">889</a>   @Path(<span class="jxr_string">"{eventId}/access"</span>)
<a class="jxr_linenumber" name="L890" href="#L890">890</a>   @RestQuery(name = <span class="jxr_string">"applyAclToEvent"</span>, description = <span class="jxr_string">"Immediate application of an ACL to an event"</span>, returnDescription = <span class="jxr_string">"Status code"</span>, pathParameters = {
<a class="jxr_linenumber" name="L891" href="#L891">891</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The event ID"</span>, type = STRING) }, restParameters = {
<a class="jxr_linenumber" name="L892" href="#L892">892</a>                   @RestParameter(name = <span class="jxr_string">"acl"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The ACL to apply"</span>, type = STRING) }, responses = {
<a class="jxr_linenumber" name="L893" href="#L893">893</a>                           @RestResponse(responseCode = SC_OK, description = <span class="jxr_string">"The ACL has been successfully applied"</span>),
<a class="jxr_linenumber" name="L894" href="#L894">894</a>                           @RestResponse(responseCode = SC_BAD_REQUEST, description = <span class="jxr_string">"Unable to parse the given ACL"</span>),
<a class="jxr_linenumber" name="L895" href="#L895">895</a>                           @RestResponse(responseCode = SC_NOT_FOUND, description = <span class="jxr_string">"The the event has not been found"</span>),
<a class="jxr_linenumber" name="L896" href="#L896">896</a>                           @RestResponse(responseCode = SC_UNAUTHORIZED, description = <span class="jxr_string">"Not authorized to perform this action"</span>),
<a class="jxr_linenumber" name="L897" href="#L897">897</a>                           @RestResponse(responseCode = SC_INTERNAL_SERVER_ERROR, description = <span class="jxr_string">"Internal error"</span>) })
<a class="jxr_linenumber" name="L898" href="#L898">898</a>   <strong class="jxr_keyword">public</strong> Response applyAclToEvent(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId, @FormParam(<span class="jxr_string">"acl"</span>) String acl)
<a class="jxr_linenumber" name="L899" href="#L899">899</a>           <strong class="jxr_keyword">throws</strong> NotFoundException, UnauthorizedException, SearchIndexException, IndexServiceException {
<a class="jxr_linenumber" name="L900" href="#L900">900</a>     <strong class="jxr_keyword">final</strong> AccessControlList accessControlList;
<a class="jxr_linenumber" name="L901" href="#L901">901</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L902" href="#L902">902</a>       accessControlList = AccessControlParser.parseAcl(acl);
<a class="jxr_linenumber" name="L903" href="#L903">903</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L904" href="#L904">904</a>       logger.warn(<span class="jxr_string">"Unable to parse ACL '{}'"</span>, acl);
<a class="jxr_linenumber" name="L905" href="#L905">905</a>       <strong class="jxr_keyword">return</strong> badRequest();
<a class="jxr_linenumber" name="L906" href="#L906">906</a>     }
<a class="jxr_linenumber" name="L907" href="#L907">907</a> 
<a class="jxr_linenumber" name="L908" href="#L908">908</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L909" href="#L909">909</a>       <strong class="jxr_keyword">final</strong> Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L910" href="#L910">910</a>       <strong class="jxr_keyword">if</strong> (optEvent.isNone()) {
<a class="jxr_linenumber" name="L911" href="#L911">911</a>         logger.warn(<span class="jxr_string">"Unable to find the event '{}'"</span>, eventId);
<a class="jxr_linenumber" name="L912" href="#L912">912</a>         <strong class="jxr_keyword">return</strong> notFound();
<a class="jxr_linenumber" name="L913" href="#L913">913</a>       }
<a class="jxr_linenumber" name="L914" href="#L914">914</a> 
<a class="jxr_linenumber" name="L915" href="#L915">915</a>       Source eventSource = getIndexService().getEventSource(optEvent.get());
<a class="jxr_linenumber" name="L916" href="#L916">916</a>       <strong class="jxr_keyword">if</strong> (eventSource == Source.ARCHIVE) {
<a class="jxr_linenumber" name="L917" href="#L917">917</a>         Optional&lt;MediaPackage&gt; mediaPackage = getAssetManager().getMediaPackage(eventId);
<a class="jxr_linenumber" name="L918" href="#L918">918</a>         Option&lt;AccessControlList&gt; aclOpt = Option.option(accessControlList);
<a class="jxr_linenumber" name="L919" href="#L919">919</a>         <em class="jxr_comment">// the episode service is the source of authority for the retrieval of media packages</em>
<a class="jxr_linenumber" name="L920" href="#L920">920</a>         <strong class="jxr_keyword">if</strong> (mediaPackage.isPresent()) {
<a class="jxr_linenumber" name="L921" href="#L921">921</a>           MediaPackage episodeSvcMp = mediaPackage.get();
<a class="jxr_linenumber" name="L922" href="#L922">922</a>           aclOpt.fold(<strong class="jxr_keyword">new</strong> Option.EMatch&lt;AccessControlList&gt;() {
<a class="jxr_linenumber" name="L923" href="#L923">923</a>             <em class="jxr_comment">// set the new episode ACL</em>
<a class="jxr_linenumber" name="L924" href="#L924">924</a>             @Override
<a class="jxr_linenumber" name="L925" href="#L925">925</a>             <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> esome(<strong class="jxr_keyword">final</strong> AccessControlList acl) {
<a class="jxr_linenumber" name="L926" href="#L926">926</a>               <em class="jxr_comment">// update in episode service</em>
<a class="jxr_linenumber" name="L927" href="#L927">927</a>               <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L928" href="#L928">928</a>                 MediaPackage mp = getAuthorizationService().setAcl(episodeSvcMp, AclScope.Episode, acl).getA();
<a class="jxr_linenumber" name="L929" href="#L929">929</a>                 getAssetManager().takeSnapshot(mp);
<a class="jxr_linenumber" name="L930" href="#L930">930</a>               } <strong class="jxr_keyword">catch</strong> (MediaPackageException e) {
<a class="jxr_linenumber" name="L931" href="#L931">931</a>                 logger.error(<span class="jxr_string">"Error getting ACL from media package"</span>, e);
<a class="jxr_linenumber" name="L932" href="#L932">932</a>               }
<a class="jxr_linenumber" name="L933" href="#L933">933</a>             }
<a class="jxr_linenumber" name="L934" href="#L934">934</a> 
<a class="jxr_linenumber" name="L935" href="#L935">935</a>             <em class="jxr_comment">// if none EpisodeACLTransition#isDelete returns true so delete the episode ACL</em>
<a class="jxr_linenumber" name="L936" href="#L936">936</a>             @Override
<a class="jxr_linenumber" name="L937" href="#L937">937</a>             <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> enone() {
<a class="jxr_linenumber" name="L938" href="#L938">938</a>               <em class="jxr_comment">// update in episode service</em>
<a class="jxr_linenumber" name="L939" href="#L939">939</a>               MediaPackage mp = getAuthorizationService().removeAcl(episodeSvcMp, AclScope.Episode);
<a class="jxr_linenumber" name="L940" href="#L940">940</a>               getAssetManager().takeSnapshot(mp);
<a class="jxr_linenumber" name="L941" href="#L941">941</a>             }
<a class="jxr_linenumber" name="L942" href="#L942">942</a> 
<a class="jxr_linenumber" name="L943" href="#L943">943</a>           });
<a class="jxr_linenumber" name="L944" href="#L944">944</a>           <strong class="jxr_keyword">return</strong> ok();
<a class="jxr_linenumber" name="L945" href="#L945">945</a>         }
<a class="jxr_linenumber" name="L946" href="#L946">946</a>         logger.warn(<span class="jxr_string">"Unable to find the event '{}'"</span>, eventId);
<a class="jxr_linenumber" name="L947" href="#L947">947</a>         <strong class="jxr_keyword">return</strong> notFound();
<a class="jxr_linenumber" name="L948" href="#L948">948</a>       } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (eventSource == Source.WORKFLOW) {
<a class="jxr_linenumber" name="L949" href="#L949">949</a>         logger.warn(<span class="jxr_string">"An ACL cannot be edited while an event is part of a current workflow because it might"</span>
<a class="jxr_linenumber" name="L950" href="#L950">950</a>                 + <span class="jxr_string">" lead to inconsistent ACLs i.e. changed after distribution so that the old ACL is still "</span>
<a class="jxr_linenumber" name="L951" href="#L951">951</a>                 + <span class="jxr_string">"being used by the distribution channel."</span>);
<a class="jxr_linenumber" name="L952" href="#L952">952</a>         JSONObject json = <strong class="jxr_keyword">new</strong> JSONObject();
<a class="jxr_linenumber" name="L953" href="#L953">953</a>         json.put(<span class="jxr_string">"Error"</span>, <span class="jxr_string">"Unable to edit an ACL for a current workflow."</span>);
<a class="jxr_linenumber" name="L954" href="#L954">954</a>         <strong class="jxr_keyword">return</strong> conflict(json.toJSONString());
<a class="jxr_linenumber" name="L955" href="#L955">955</a>       } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L956" href="#L956">956</a>         MediaPackage mediaPackage = getIndexService().getEventMediapackage(optEvent.get());
<a class="jxr_linenumber" name="L957" href="#L957">957</a>         mediaPackage = getAuthorizationService().setAcl(mediaPackage, AclScope.Episode, accessControlList).getA();
<a class="jxr_linenumber" name="L958" href="#L958">958</a>         <em class="jxr_comment">// We could check agent access here if we want to forbid updating ACLs for users without access.</em>
<a class="jxr_linenumber" name="L959" href="#L959">959</a>         getSchedulerService().updateEvent(eventId, Optional.empty(), Optional.empty(), Optional.empty(), Optional.empty(),
<a class="jxr_linenumber" name="L960" href="#L960">960</a>                 Optional.of(mediaPackage), Optional.empty(), Optional.empty());
<a class="jxr_linenumber" name="L961" href="#L961">961</a>         <strong class="jxr_keyword">return</strong> ok();
<a class="jxr_linenumber" name="L962" href="#L962">962</a>       }
<a class="jxr_linenumber" name="L963" href="#L963">963</a>     } <strong class="jxr_keyword">catch</strong> (MediaPackageException e) {
<a class="jxr_linenumber" name="L964" href="#L964">964</a>       <strong class="jxr_keyword">if</strong> (e.getCause() instanceof UnauthorizedException) {
<a class="jxr_linenumber" name="L965" href="#L965">965</a>         <strong class="jxr_keyword">return</strong> forbidden();
<a class="jxr_linenumber" name="L966" href="#L966">966</a>       }
<a class="jxr_linenumber" name="L967" href="#L967">967</a>       logger.error(<span class="jxr_string">"Error applying acl '{}' to event '{}'"</span>, accessControlList, eventId, e);
<a class="jxr_linenumber" name="L968" href="#L968">968</a>       <strong class="jxr_keyword">return</strong> serverError();
<a class="jxr_linenumber" name="L969" href="#L969">969</a>     } <strong class="jxr_keyword">catch</strong> (SchedulerException e) {
<a class="jxr_linenumber" name="L970" href="#L970">970</a>       logger.error(<span class="jxr_string">"Error applying ACL to scheduled event {}"</span>, eventId, e);
<a class="jxr_linenumber" name="L971" href="#L971">971</a>       <strong class="jxr_keyword">return</strong> serverError();
<a class="jxr_linenumber" name="L972" href="#L972">972</a>     }
<a class="jxr_linenumber" name="L973" href="#L973">973</a>   }
<a class="jxr_linenumber" name="L974" href="#L974">974</a> 
<a class="jxr_linenumber" name="L975" href="#L975">975</a>   @POST
<a class="jxr_linenumber" name="L976" href="#L976">976</a>   @Path(<span class="jxr_string">"{eventId}/comment"</span>)
<a class="jxr_linenumber" name="L977" href="#L977">977</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L978" href="#L978">978</a>   @RestQuery(name = <span class="jxr_string">"createeventcomment"</span>, description = <span class="jxr_string">"Creates a comment related to the event given by the identifier"</span>, returnDescription = <span class="jxr_string">"The comment related to the event as JSON"</span>, pathParameters = {
<a class="jxr_linenumber" name="L979" href="#L979">979</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, restParameters = {
<a class="jxr_linenumber" name="L980" href="#L980">980</a>                   @RestParameter(name = <span class="jxr_string">"text"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The comment text"</span>, type = TEXT),
<a class="jxr_linenumber" name="L981" href="#L981">981</a>                   @RestParameter(name = <span class="jxr_string">"resolved"</span>, isRequired = false, description = <span class="jxr_string">"The comment resolved status"</span>, type = RestParameter.Type.BOOLEAN),
<a class="jxr_linenumber" name="L982" href="#L982">982</a>                   @RestParameter(name = <span class="jxr_string">"reason"</span>, isRequired = false, description = <span class="jxr_string">"The comment reason"</span>, type = STRING) }, responses = {
<a class="jxr_linenumber" name="L983" href="#L983">983</a>                           @RestResponse(description = <span class="jxr_string">"The comment has been created."</span>, responseCode = HttpServletResponse.SC_CREATED),
<a class="jxr_linenumber" name="L984" href="#L984">984</a>                           @RestResponse(description = <span class="jxr_string">"If no text ist set."</span>, responseCode = HttpServletResponse.SC_BAD_REQUEST),
<a class="jxr_linenumber" name="L985" href="#L985">985</a>                           @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L986" href="#L986">986</a>   <strong class="jxr_keyword">public</strong> Response createEventComment(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId, @FormParam(<span class="jxr_string">"text"</span>) String text,
<a class="jxr_linenumber" name="L987" href="#L987">987</a>           @FormParam(<span class="jxr_string">"reason"</span>) String reason, @FormParam(<span class="jxr_string">"resolved"</span>) Boolean resolved) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L988" href="#L988">988</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L989" href="#L989">989</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L990" href="#L990">990</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId);
<a class="jxr_linenumber" name="L991" href="#L991">991</a> 
<a class="jxr_linenumber" name="L992" href="#L992">992</a>     <strong class="jxr_keyword">if</strong> (StringUtils.isBlank(text))
<a class="jxr_linenumber" name="L993" href="#L993">993</a>       <strong class="jxr_keyword">return</strong> Response.status(Status.BAD_REQUEST).build();
<a class="jxr_linenumber" name="L994" href="#L994">994</a> 
<a class="jxr_linenumber" name="L995" href="#L995">995</a>     User author = getSecurityService().getUser();
<a class="jxr_linenumber" name="L996" href="#L996">996</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L997" href="#L997">997</a>       EventComment createdComment = EventComment.create(Option.&lt;Long&gt; none(), eventId,
<a class="jxr_linenumber" name="L998" href="#L998">998</a>               getSecurityService().getOrganization().getId(), text, author, reason, BooleanUtils.toBoolean(reason));
<a class="jxr_linenumber" name="L999" href="#L999">999</a>       createdComment = getEventCommentService().updateComment(createdComment);
<a class="jxr_linenumber" name="L1000" href="#L1000">1000</a>       List&lt;EventComment&gt; comments = getEventCommentService().getComments(eventId);
<a class="jxr_linenumber" name="L1001" href="#L1001">1001</a>       getIndexService().updateCommentCatalog(optEvent.get(), comments);
<a class="jxr_linenumber" name="L1002" href="#L1002">1002</a>       <strong class="jxr_keyword">return</strong> Response.created(getCommentUrl(eventId, createdComment.getId().get()))
<a class="jxr_linenumber" name="L1003" href="#L1003">1003</a>               .entity(createdComment.toJson().toJson()).build();
<a class="jxr_linenumber" name="L1004" href="#L1004">1004</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L1005" href="#L1005">1005</a>       logger.error(<span class="jxr_string">"Unable to create a comment on the event {}"</span>, eventId, e);
<a class="jxr_linenumber" name="L1006" href="#L1006">1006</a>       <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> WebApplicationException(e);
<a class="jxr_linenumber" name="L1007" href="#L1007">1007</a>     }
<a class="jxr_linenumber" name="L1008" href="#L1008">1008</a>   }
<a class="jxr_linenumber" name="L1009" href="#L1009">1009</a> 
<a class="jxr_linenumber" name="L1010" href="#L1010">1010</a>   @POST
<a class="jxr_linenumber" name="L1011" href="#L1011">1011</a>   @Path(<span class="jxr_string">"{eventId}/comment/{commentId}"</span>)
<a class="jxr_linenumber" name="L1012" href="#L1012">1012</a>   @RestQuery(name = <span class="jxr_string">"resolveeventcomment"</span>, description = <span class="jxr_string">"Resolves an event comment"</span>, returnDescription = <span class="jxr_string">"The resolved comment."</span>, pathParameters = {
<a class="jxr_linenumber" name="L1013" href="#L1013">1013</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L1014" href="#L1014">1014</a>           @RestParameter(name = <span class="jxr_string">"commentId"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The comment identifier"</span>, type = STRING) }, responses = {
<a class="jxr_linenumber" name="L1015" href="#L1015">1015</a>                   @RestResponse(responseCode = SC_NOT_FOUND, description = <span class="jxr_string">"The event or comment to resolve has not been found."</span>),
<a class="jxr_linenumber" name="L1016" href="#L1016">1016</a>                   @RestResponse(responseCode = SC_OK, description = <span class="jxr_string">"The resolved comment as JSON."</span>) })
<a class="jxr_linenumber" name="L1017" href="#L1017">1017</a>   <strong class="jxr_keyword">public</strong> Response resolveEventComment(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId, @PathParam(<span class="jxr_string">"commentId"</span>) <strong class="jxr_keyword">long</strong> commentId)
<a class="jxr_linenumber" name="L1018" href="#L1018">1018</a>           <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1019" href="#L1019">1019</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L1020" href="#L1020">1020</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L1021" href="#L1021">1021</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId);
<a class="jxr_linenumber" name="L1022" href="#L1022">1022</a> 
<a class="jxr_linenumber" name="L1023" href="#L1023">1023</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1024" href="#L1024">1024</a>       EventComment dto = getEventCommentService().getComment(commentId);
<a class="jxr_linenumber" name="L1025" href="#L1025">1025</a>       EventComment updatedComment = EventComment.create(dto.getId(), dto.getEventId(), dto.getOrganization(),
<a class="jxr_linenumber" name="L1026" href="#L1026">1026</a>               dto.getText(), dto.getAuthor(), dto.getReason(), <strong class="jxr_keyword">true</strong>, dto.getCreationDate(), <strong class="jxr_keyword">new</strong> Date(),
<a class="jxr_linenumber" name="L1027" href="#L1027">1027</a>               dto.getReplies());
<a class="jxr_linenumber" name="L1028" href="#L1028">1028</a> 
<a class="jxr_linenumber" name="L1029" href="#L1029">1029</a>       updatedComment = getEventCommentService().updateComment(updatedComment);
<a class="jxr_linenumber" name="L1030" href="#L1030">1030</a>       List&lt;EventComment&gt; comments = getEventCommentService().getComments(eventId);
<a class="jxr_linenumber" name="L1031" href="#L1031">1031</a>       getIndexService().updateCommentCatalog(optEvent.get(), comments);
<a class="jxr_linenumber" name="L1032" href="#L1032">1032</a>       <strong class="jxr_keyword">return</strong> Response.ok(updatedComment.toJson().toJson()).build();
<a class="jxr_linenumber" name="L1033" href="#L1033">1033</a>     } <strong class="jxr_keyword">catch</strong> (NotFoundException e) {
<a class="jxr_linenumber" name="L1034" href="#L1034">1034</a>       <strong class="jxr_keyword">throw</strong> e;
<a class="jxr_linenumber" name="L1035" href="#L1035">1035</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L1036" href="#L1036">1036</a>       logger.error(<span class="jxr_string">"Could not resolve comment {}"</span>, commentId, e);
<a class="jxr_linenumber" name="L1037" href="#L1037">1037</a>       <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> WebApplicationException(e);
<a class="jxr_linenumber" name="L1038" href="#L1038">1038</a>     }
<a class="jxr_linenumber" name="L1039" href="#L1039">1039</a>   }
<a class="jxr_linenumber" name="L1040" href="#L1040">1040</a> 
<a class="jxr_linenumber" name="L1041" href="#L1041">1041</a>   @DELETE
<a class="jxr_linenumber" name="L1042" href="#L1042">1042</a>   @Path(<span class="jxr_string">"{eventId}/comment/{commentId}"</span>)
<a class="jxr_linenumber" name="L1043" href="#L1043">1043</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L1044" href="#L1044">1044</a>   @RestQuery(name = <span class="jxr_string">"deleteeventcomment"</span>, description = <span class="jxr_string">"Deletes a event related comment by its identifier"</span>, returnDescription = <span class="jxr_string">"No content"</span>, pathParameters = {
<a class="jxr_linenumber" name="L1045" href="#L1045">1045</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L1046" href="#L1046">1046</a>           @RestParameter(name = <span class="jxr_string">"commentId"</span>, description = <span class="jxr_string">"The comment id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L1047" href="#L1047">1047</a>                   @RestResponse(description = <span class="jxr_string">"The event related comment has been deleted."</span>, responseCode = HttpServletResponse.SC_NO_CONTENT),
<a class="jxr_linenumber" name="L1048" href="#L1048">1048</a>                   @RestResponse(description = <span class="jxr_string">"No event or comment with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L1049" href="#L1049">1049</a>   <strong class="jxr_keyword">public</strong> Response deleteEventComment(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId, @PathParam(<span class="jxr_string">"commentId"</span>) <strong class="jxr_keyword">long</strong> commentId)
<a class="jxr_linenumber" name="L1050" href="#L1050">1050</a>           <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1051" href="#L1051">1051</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L1052" href="#L1052">1052</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L1053" href="#L1053">1053</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId);
<a class="jxr_linenumber" name="L1054" href="#L1054">1054</a> 
<a class="jxr_linenumber" name="L1055" href="#L1055">1055</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1056" href="#L1056">1056</a>       getEventCommentService().deleteComment(commentId);
<a class="jxr_linenumber" name="L1057" href="#L1057">1057</a>       List&lt;EventComment&gt; comments = getEventCommentService().getComments(eventId);
<a class="jxr_linenumber" name="L1058" href="#L1058">1058</a>       getIndexService().updateCommentCatalog(optEvent.get(), comments);
<a class="jxr_linenumber" name="L1059" href="#L1059">1059</a>       <strong class="jxr_keyword">return</strong> Response.noContent().build();
<a class="jxr_linenumber" name="L1060" href="#L1060">1060</a>     } <strong class="jxr_keyword">catch</strong> (NotFoundException e) {
<a class="jxr_linenumber" name="L1061" href="#L1061">1061</a>       <strong class="jxr_keyword">throw</strong> e;
<a class="jxr_linenumber" name="L1062" href="#L1062">1062</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L1063" href="#L1063">1063</a>       logger.error(<span class="jxr_string">"Unable to delete comment {} on event {}"</span>, commentId, eventId, e);
<a class="jxr_linenumber" name="L1064" href="#L1064">1064</a>       <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> WebApplicationException(e);
<a class="jxr_linenumber" name="L1065" href="#L1065">1065</a>     }
<a class="jxr_linenumber" name="L1066" href="#L1066">1066</a>   }
<a class="jxr_linenumber" name="L1067" href="#L1067">1067</a> 
<a class="jxr_linenumber" name="L1068" href="#L1068">1068</a>   @DELETE
<a class="jxr_linenumber" name="L1069" href="#L1069">1069</a>   @Path(<span class="jxr_string">"{eventId}/comment/{commentId}/{replyId}"</span>)
<a class="jxr_linenumber" name="L1070" href="#L1070">1070</a>   @RestQuery(name = <span class="jxr_string">"deleteeventreply"</span>, description = <span class="jxr_string">"Delete an event comment reply"</span>, returnDescription = <span class="jxr_string">"The updated comment as JSON."</span>, pathParameters = {
<a class="jxr_linenumber" name="L1071" href="#L1071">1071</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L1072" href="#L1072">1072</a>           @RestParameter(name = <span class="jxr_string">"commentId"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The comment identifier"</span>, type = STRING),
<a class="jxr_linenumber" name="L1073" href="#L1073">1073</a>           @RestParameter(name = <span class="jxr_string">"replyId"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The comment reply identifier"</span>, type = STRING) }, responses = {
<a class="jxr_linenumber" name="L1074" href="#L1074">1074</a>                   @RestResponse(responseCode = SC_NOT_FOUND, description = <span class="jxr_string">"No event comment or reply with this identifier was found."</span>),
<a class="jxr_linenumber" name="L1075" href="#L1075">1075</a>                   @RestResponse(responseCode = SC_OK, description = <span class="jxr_string">"The updated comment as JSON."</span>) })
<a class="jxr_linenumber" name="L1076" href="#L1076">1076</a>   <strong class="jxr_keyword">public</strong> Response deleteEventCommentReply(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId, @PathParam(<span class="jxr_string">"commentId"</span>) <strong class="jxr_keyword">long</strong> commentId,
<a class="jxr_linenumber" name="L1077" href="#L1077">1077</a>           @PathParam(<span class="jxr_string">"replyId"</span>) <strong class="jxr_keyword">long</strong> replyId) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1078" href="#L1078">1078</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L1079" href="#L1079">1079</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L1080" href="#L1080">1080</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId);
<a class="jxr_linenumber" name="L1081" href="#L1081">1081</a> 
<a class="jxr_linenumber" name="L1082" href="#L1082">1082</a>     EventComment comment = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1083" href="#L1083">1083</a>     EventCommentReply reply = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1084" href="#L1084">1084</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1085" href="#L1085">1085</a>       comment = getEventCommentService().getComment(commentId);
<a class="jxr_linenumber" name="L1086" href="#L1086">1086</a>       <strong class="jxr_keyword">for</strong> (EventCommentReply r : comment.getReplies()) {
<a class="jxr_linenumber" name="L1087" href="#L1087">1087</a>         <strong class="jxr_keyword">if</strong> (r.getId().isNone() || replyId != r.getId().get().longValue())
<a class="jxr_linenumber" name="L1088" href="#L1088">1088</a>           <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="L1089" href="#L1089">1089</a>         reply = r;
<a class="jxr_linenumber" name="L1090" href="#L1090">1090</a>         <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L1091" href="#L1091">1091</a>       }
<a class="jxr_linenumber" name="L1092" href="#L1092">1092</a> 
<a class="jxr_linenumber" name="L1093" href="#L1093">1093</a>       <strong class="jxr_keyword">if</strong> (reply == <strong class="jxr_keyword">null</strong>)
<a class="jxr_linenumber" name="L1094" href="#L1094">1094</a>         <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> NotFoundException(<span class="jxr_string">"Reply with id "</span> + replyId + <span class="jxr_string">" not found!"</span>);
<a class="jxr_linenumber" name="L1095" href="#L1095">1095</a> 
<a class="jxr_linenumber" name="L1096" href="#L1096">1096</a>       comment.removeReply(reply);
<a class="jxr_linenumber" name="L1097" href="#L1097">1097</a> 
<a class="jxr_linenumber" name="L1098" href="#L1098">1098</a>       EventComment updatedComment = getEventCommentService().updateComment(comment);
<a class="jxr_linenumber" name="L1099" href="#L1099">1099</a>       List&lt;EventComment&gt; comments = getEventCommentService().getComments(eventId);
<a class="jxr_linenumber" name="L1100" href="#L1100">1100</a>       getIndexService().updateCommentCatalog(optEvent.get(), comments);
<a class="jxr_linenumber" name="L1101" href="#L1101">1101</a>       <strong class="jxr_keyword">return</strong> Response.ok(updatedComment.toJson().toJson()).build();
<a class="jxr_linenumber" name="L1102" href="#L1102">1102</a>     } <strong class="jxr_keyword">catch</strong> (NotFoundException e) {
<a class="jxr_linenumber" name="L1103" href="#L1103">1103</a>       <strong class="jxr_keyword">throw</strong> e;
<a class="jxr_linenumber" name="L1104" href="#L1104">1104</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L1105" href="#L1105">1105</a>       logger.warn(<span class="jxr_string">"Could not remove event comment reply {} from comment {}"</span>, replyId, commentId, e);
<a class="jxr_linenumber" name="L1106" href="#L1106">1106</a>       <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> WebApplicationException(e);
<a class="jxr_linenumber" name="L1107" href="#L1107">1107</a>     }
<a class="jxr_linenumber" name="L1108" href="#L1108">1108</a>   }
<a class="jxr_linenumber" name="L1109" href="#L1109">1109</a> 
<a class="jxr_linenumber" name="L1110" href="#L1110">1110</a>   @PUT
<a class="jxr_linenumber" name="L1111" href="#L1111">1111</a>   @Path(<span class="jxr_string">"{eventId}/comment/{commentId}/{replyId}"</span>)
<a class="jxr_linenumber" name="L1112" href="#L1112">1112</a>   @RestQuery(name = <span class="jxr_string">"updateeventcommentreply"</span>, description = <span class="jxr_string">"Updates an event comment reply"</span>, returnDescription = <span class="jxr_string">"The updated comment as JSON."</span>, pathParameters = {
<a class="jxr_linenumber" name="L1113" href="#L1113">1113</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L1114" href="#L1114">1114</a>           @RestParameter(name = <span class="jxr_string">"commentId"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The comment identifier"</span>, type = STRING),
<a class="jxr_linenumber" name="L1115" href="#L1115">1115</a>           @RestParameter(name = <span class="jxr_string">"replyId"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The comment reply identifier"</span>, type = STRING) }, restParameters = {
<a class="jxr_linenumber" name="L1116" href="#L1116">1116</a>                   @RestParameter(name = <span class="jxr_string">"text"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The comment reply text"</span>, type = TEXT) }, responses = {
<a class="jxr_linenumber" name="L1117" href="#L1117">1117</a>                           @RestResponse(responseCode = SC_NOT_FOUND, description = <span class="jxr_string">"The event or comment to extend with a reply or the reply has not been found."</span>),
<a class="jxr_linenumber" name="L1118" href="#L1118">1118</a>                           @RestResponse(responseCode = HttpServletResponse.SC_BAD_REQUEST, description = <span class="jxr_string">"If no text is set."</span>),
<a class="jxr_linenumber" name="L1119" href="#L1119">1119</a>                           @RestResponse(responseCode = SC_OK, description = <span class="jxr_string">"The updated comment as JSON."</span>) })
<a class="jxr_linenumber" name="L1120" href="#L1120">1120</a>   <strong class="jxr_keyword">public</strong> Response updateEventCommentReply(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId, @PathParam(<span class="jxr_string">"commentId"</span>) <strong class="jxr_keyword">long</strong> commentId,
<a class="jxr_linenumber" name="L1121" href="#L1121">1121</a>           @PathParam(<span class="jxr_string">"replyId"</span>) <strong class="jxr_keyword">long</strong> replyId, @FormParam(<span class="jxr_string">"text"</span>) String text) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1122" href="#L1122">1122</a>     <strong class="jxr_keyword">if</strong> (StringUtils.isBlank(text))
<a class="jxr_linenumber" name="L1123" href="#L1123">1123</a>       <strong class="jxr_keyword">return</strong> Response.status(Status.BAD_REQUEST).build();
<a class="jxr_linenumber" name="L1124" href="#L1124">1124</a> 
<a class="jxr_linenumber" name="L1125" href="#L1125">1125</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L1126" href="#L1126">1126</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L1127" href="#L1127">1127</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId);
<a class="jxr_linenumber" name="L1128" href="#L1128">1128</a> 
<a class="jxr_linenumber" name="L1129" href="#L1129">1129</a>     EventComment comment = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1130" href="#L1130">1130</a>     EventCommentReply reply = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1131" href="#L1131">1131</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1132" href="#L1132">1132</a>       comment = getEventCommentService().getComment(commentId);
<a class="jxr_linenumber" name="L1133" href="#L1133">1133</a>       <strong class="jxr_keyword">for</strong> (EventCommentReply r : comment.getReplies()) {
<a class="jxr_linenumber" name="L1134" href="#L1134">1134</a>         <strong class="jxr_keyword">if</strong> (r.getId().isNone() || replyId != r.getId().get().longValue())
<a class="jxr_linenumber" name="L1135" href="#L1135">1135</a>           <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="L1136" href="#L1136">1136</a>         reply = r;
<a class="jxr_linenumber" name="L1137" href="#L1137">1137</a>         <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L1138" href="#L1138">1138</a>       }
<a class="jxr_linenumber" name="L1139" href="#L1139">1139</a> 
<a class="jxr_linenumber" name="L1140" href="#L1140">1140</a>       <strong class="jxr_keyword">if</strong> (reply == <strong class="jxr_keyword">null</strong>)
<a class="jxr_linenumber" name="L1141" href="#L1141">1141</a>         <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> NotFoundException(<span class="jxr_string">"Reply with id "</span> + replyId + <span class="jxr_string">" not found!"</span>);
<a class="jxr_linenumber" name="L1142" href="#L1142">1142</a> 
<a class="jxr_linenumber" name="L1143" href="#L1143">1143</a>       EventCommentReply updatedReply = EventCommentReply.create(reply.getId(), text.trim(), reply.getAuthor(),
<a class="jxr_linenumber" name="L1144" href="#L1144">1144</a>               reply.getCreationDate(), <strong class="jxr_keyword">new</strong> Date());
<a class="jxr_linenumber" name="L1145" href="#L1145">1145</a>       comment.removeReply(reply);
<a class="jxr_linenumber" name="L1146" href="#L1146">1146</a>       comment.addReply(updatedReply);
<a class="jxr_linenumber" name="L1147" href="#L1147">1147</a> 
<a class="jxr_linenumber" name="L1148" href="#L1148">1148</a>       EventComment updatedComment = getEventCommentService().updateComment(comment);
<a class="jxr_linenumber" name="L1149" href="#L1149">1149</a>       List&lt;EventComment&gt; comments = getEventCommentService().getComments(eventId);
<a class="jxr_linenumber" name="L1150" href="#L1150">1150</a>       getIndexService().updateCommentCatalog(optEvent.get(), comments);
<a class="jxr_linenumber" name="L1151" href="#L1151">1151</a>       <strong class="jxr_keyword">return</strong> Response.ok(updatedComment.toJson().toJson()).build();
<a class="jxr_linenumber" name="L1152" href="#L1152">1152</a>     } <strong class="jxr_keyword">catch</strong> (NotFoundException e) {
<a class="jxr_linenumber" name="L1153" href="#L1153">1153</a>       <strong class="jxr_keyword">throw</strong> e;
<a class="jxr_linenumber" name="L1154" href="#L1154">1154</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L1155" href="#L1155">1155</a>       logger.warn(<span class="jxr_string">"Could not update event comment reply {} from comment {}"</span>, replyId, commentId, e);
<a class="jxr_linenumber" name="L1156" href="#L1156">1156</a>       <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> WebApplicationException(e);
<a class="jxr_linenumber" name="L1157" href="#L1157">1157</a>     }
<a class="jxr_linenumber" name="L1158" href="#L1158">1158</a>   }
<a class="jxr_linenumber" name="L1159" href="#L1159">1159</a> 
<a class="jxr_linenumber" name="L1160" href="#L1160">1160</a>   @POST
<a class="jxr_linenumber" name="L1161" href="#L1161">1161</a>   @Path(<span class="jxr_string">"{eventId}/comment/{commentId}/reply"</span>)
<a class="jxr_linenumber" name="L1162" href="#L1162">1162</a>   @RestQuery(name = <span class="jxr_string">"createeventcommentreply"</span>, description = <span class="jxr_string">"Creates an event comment reply"</span>, returnDescription = <span class="jxr_string">"The updated comment as JSON."</span>, pathParameters = {
<a class="jxr_linenumber" name="L1163" href="#L1163">1163</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L1164" href="#L1164">1164</a>           @RestParameter(name = <span class="jxr_string">"commentId"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The comment identifier"</span>, type = STRING) }, restParameters = {
<a class="jxr_linenumber" name="L1165" href="#L1165">1165</a>                   @RestParameter(name = <span class="jxr_string">"text"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The comment reply text"</span>, type = TEXT),
<a class="jxr_linenumber" name="L1166" href="#L1166">1166</a>                   @RestParameter(name = <span class="jxr_string">"resolved"</span>, isRequired = false, description = <span class="jxr_string">"Flag defining if this reply solve or not the comment."</span>, type = BOOLEAN) }, responses = {
<a class="jxr_linenumber" name="L1167" href="#L1167">1167</a>                           @RestResponse(responseCode = SC_NOT_FOUND, description = <span class="jxr_string">"The event or comment to extend with a reply has not been found."</span>),
<a class="jxr_linenumber" name="L1168" href="#L1168">1168</a>                           @RestResponse(responseCode = HttpServletResponse.SC_BAD_REQUEST, description = <span class="jxr_string">"If no text is set."</span>),
<a class="jxr_linenumber" name="L1169" href="#L1169">1169</a>                           @RestResponse(responseCode = SC_OK, description = <span class="jxr_string">"The updated comment as JSON."</span>) })
<a class="jxr_linenumber" name="L1170" href="#L1170">1170</a>   <strong class="jxr_keyword">public</strong> Response createEventCommentReply(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId, @PathParam(<span class="jxr_string">"commentId"</span>) <strong class="jxr_keyword">long</strong> commentId,
<a class="jxr_linenumber" name="L1171" href="#L1171">1171</a>           @FormParam(<span class="jxr_string">"text"</span>) String text, @FormParam(<span class="jxr_string">"resolved"</span>) Boolean resolved) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1172" href="#L1172">1172</a>     <strong class="jxr_keyword">if</strong> (StringUtils.isBlank(text))
<a class="jxr_linenumber" name="L1173" href="#L1173">1173</a>       <strong class="jxr_keyword">return</strong> Response.status(Status.BAD_REQUEST).build();
<a class="jxr_linenumber" name="L1174" href="#L1174">1174</a> 
<a class="jxr_linenumber" name="L1175" href="#L1175">1175</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L1176" href="#L1176">1176</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L1177" href="#L1177">1177</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId);
<a class="jxr_linenumber" name="L1178" href="#L1178">1178</a> 
<a class="jxr_linenumber" name="L1179" href="#L1179">1179</a>     EventComment comment = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1180" href="#L1180">1180</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1181" href="#L1181">1181</a>       comment = getEventCommentService().getComment(commentId);
<a class="jxr_linenumber" name="L1182" href="#L1182">1182</a>       EventComment updatedComment;
<a class="jxr_linenumber" name="L1183" href="#L1183">1183</a> 
<a class="jxr_linenumber" name="L1184" href="#L1184">1184</a>       <strong class="jxr_keyword">if</strong> (resolved != <strong class="jxr_keyword">null</strong> &amp;&amp; resolved) {
<a class="jxr_linenumber" name="L1185" href="#L1185">1185</a>         <em class="jxr_comment">// If the resolve flag is set to true, change to comment to resolved</em>
<a class="jxr_linenumber" name="L1186" href="#L1186">1186</a>         updatedComment = EventComment.create(comment.getId(), comment.getEventId(), comment.getOrganization(),
<a class="jxr_linenumber" name="L1187" href="#L1187">1187</a>                 comment.getText(), comment.getAuthor(), comment.getReason(), <strong class="jxr_keyword">true</strong>, comment.getCreationDate(),
<a class="jxr_linenumber" name="L1188" href="#L1188">1188</a>                 <strong class="jxr_keyword">new</strong> Date(), comment.getReplies());
<a class="jxr_linenumber" name="L1189" href="#L1189">1189</a>       } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L1190" href="#L1190">1190</a>         updatedComment = comment;
<a class="jxr_linenumber" name="L1191" href="#L1191">1191</a>       }
<a class="jxr_linenumber" name="L1192" href="#L1192">1192</a> 
<a class="jxr_linenumber" name="L1193" href="#L1193">1193</a>       User author = getSecurityService().getUser();
<a class="jxr_linenumber" name="L1194" href="#L1194">1194</a>       EventCommentReply reply = EventCommentReply.create(Option.&lt;Long&gt; none(), text, author);
<a class="jxr_linenumber" name="L1195" href="#L1195">1195</a>       updatedComment.addReply(reply);
<a class="jxr_linenumber" name="L1196" href="#L1196">1196</a> 
<a class="jxr_linenumber" name="L1197" href="#L1197">1197</a>       updatedComment = getEventCommentService().updateComment(updatedComment);
<a class="jxr_linenumber" name="L1198" href="#L1198">1198</a>       List&lt;EventComment&gt; comments = getEventCommentService().getComments(eventId);
<a class="jxr_linenumber" name="L1199" href="#L1199">1199</a>       getIndexService().updateCommentCatalog(optEvent.get(), comments);
<a class="jxr_linenumber" name="L1200" href="#L1200">1200</a>       <strong class="jxr_keyword">return</strong> Response.ok(updatedComment.toJson().toJson()).build();
<a class="jxr_linenumber" name="L1201" href="#L1201">1201</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L1202" href="#L1202">1202</a>       logger.warn(<span class="jxr_string">"Could not create event comment reply on comment {}"</span>, comment, e);
<a class="jxr_linenumber" name="L1203" href="#L1203">1203</a>       <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> WebApplicationException(e);
<a class="jxr_linenumber" name="L1204" href="#L1204">1204</a>     }
<a class="jxr_linenumber" name="L1205" href="#L1205">1205</a>   }
<a class="jxr_linenumber" name="L1206" href="#L1206">1206</a> 
<a class="jxr_linenumber" name="L1207" href="#L1207">1207</a>   <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L1208" href="#L1208">1208</a> <em class="jxr_javadoccomment">   * Removes emtpy series titles from the collection of the isPartOf Field</em>
<a class="jxr_linenumber" name="L1209" href="#L1209">1209</a> <em class="jxr_javadoccomment">   * @param ml the list to modify</em>
<a class="jxr_linenumber" name="L1210" href="#L1210">1210</a> <em class="jxr_javadoccomment">   */</em>
<a class="jxr_linenumber" name="L1211" href="#L1211">1211</a>   <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">void</strong> removeSeriesWithNullTitlesFromFieldCollection(MetadataList ml) {
<a class="jxr_linenumber" name="L1212" href="#L1212">1212</a>     <em class="jxr_comment">// get Series MetadataField from MetadataList</em>
<a class="jxr_linenumber" name="L1213" href="#L1213">1213</a>     MetadataField seriesField = Optional.ofNullable(ml.getMetadataList().get(<span class="jxr_string">"dublincore/episode"</span>))
<a class="jxr_linenumber" name="L1214" href="#L1214">1214</a>             .flatMap(titledMetadataCollection -&gt; Optional.ofNullable(titledMetadataCollection.getCollection()))
<a class="jxr_linenumber" name="L1215" href="#L1215">1215</a>             .flatMap(dcMetadataCollection -&gt; Optional.ofNullable(dcMetadataCollection.getOutputFields()))
<a class="jxr_linenumber" name="L1216" href="#L1216">1216</a>             .flatMap(metadataFields -&gt; Optional.ofNullable(metadataFields.get(<span class="jxr_string">"isPartOf"</span>)))
<a class="jxr_linenumber" name="L1217" href="#L1217">1217</a>             .orElse(<strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L1218" href="#L1218">1218</a>     <strong class="jxr_keyword">if</strong> (seriesField == <strong class="jxr_keyword">null</strong> || seriesField.getCollection() == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1219" href="#L1219">1219</a>       <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="L1220" href="#L1220">1220</a>     }
<a class="jxr_linenumber" name="L1221" href="#L1221">1221</a> 
<a class="jxr_linenumber" name="L1222" href="#L1222">1222</a>     <em class="jxr_comment">// Remove null keys</em>
<a class="jxr_linenumber" name="L1223" href="#L1223">1223</a>     Map&lt;String, String&gt; seriesCollection = seriesField.getCollection();
<a class="jxr_linenumber" name="L1224" href="#L1224">1224</a>     seriesCollection.remove(<strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L1225" href="#L1225">1225</a>     seriesField.setCollection(seriesCollection);
<a class="jxr_linenumber" name="L1226" href="#L1226">1226</a> 
<a class="jxr_linenumber" name="L1227" href="#L1227">1227</a>     <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="L1228" href="#L1228">1228</a>   }
<a class="jxr_linenumber" name="L1229" href="#L1229">1229</a> 
<a class="jxr_linenumber" name="L1230" href="#L1230">1230</a>   @GET
<a class="jxr_linenumber" name="L1231" href="#L1231">1231</a>   @Path(<span class="jxr_string">"{eventId}/metadata.json"</span>)
<a class="jxr_linenumber" name="L1232" href="#L1232">1232</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L1233" href="#L1233">1233</a>   @RestQuery(name = <span class="jxr_string">"geteventmetadata"</span>, description = <span class="jxr_string">"Returns all the data related to the metadata tab in the event details modal as JSON"</span>, returnDescription = <span class="jxr_string">"All the data related to the event metadata tab as JSON"</span>, pathParameters = {
<a class="jxr_linenumber" name="L1234" href="#L1234">1234</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L1235" href="#L1235">1235</a>                   @RestResponse(description = <span class="jxr_string">"Returns all the data related to the event metadata tab as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L1236" href="#L1236">1236</a>                   @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L1237" href="#L1237">1237</a>   <strong class="jxr_keyword">public</strong> Response getEventMetadata(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1238" href="#L1238">1238</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L1239" href="#L1239">1239</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L1240" href="#L1240">1240</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId);
<a class="jxr_linenumber" name="L1241" href="#L1241">1241</a>     Event event = optEvent.get();
<a class="jxr_linenumber" name="L1242" href="#L1242">1242</a>     MetadataList metadataList = <strong class="jxr_keyword">new</strong> MetadataList();
<a class="jxr_linenumber" name="L1243" href="#L1243">1243</a> 
<a class="jxr_linenumber" name="L1244" href="#L1244">1244</a>     <em class="jxr_comment">// Load extended metadata</em>
<a class="jxr_linenumber" name="L1245" href="#L1245">1245</a>     List&lt;EventCatalogUIAdapter&gt; extendedCatalogUIAdapters = getIndexService().getExtendedEventCatalogUIAdapters();
<a class="jxr_linenumber" name="L1246" href="#L1246">1246</a>     <strong class="jxr_keyword">if</strong> (!extendedCatalogUIAdapters.isEmpty()) {
<a class="jxr_linenumber" name="L1247" href="#L1247">1247</a>       MediaPackage mediaPackage;
<a class="jxr_linenumber" name="L1248" href="#L1248">1248</a>       <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1249" href="#L1249">1249</a>         mediaPackage = getIndexService().getEventMediapackage(event);
<a class="jxr_linenumber" name="L1250" href="#L1250">1250</a>       } <strong class="jxr_keyword">catch</strong> (IndexServiceException e) {
<a class="jxr_linenumber" name="L1251" href="#L1251">1251</a>         <strong class="jxr_keyword">if</strong> (e.getCause() instanceof NotFoundException) {
<a class="jxr_linenumber" name="L1252" href="#L1252">1252</a>           <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find data for event %s"</span>, eventId);
<a class="jxr_linenumber" name="L1253" href="#L1253">1253</a>         } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (e.getCause() instanceof UnauthorizedException) {
<a class="jxr_linenumber" name="L1254" href="#L1254">1254</a>           <strong class="jxr_keyword">return</strong> Response.status(Status.FORBIDDEN).entity(<span class="jxr_string">"Not authorized to access "</span> + eventId).build();
<a class="jxr_linenumber" name="L1255" href="#L1255">1255</a>         }
<a class="jxr_linenumber" name="L1256" href="#L1256">1256</a>         logger.error(<span class="jxr_string">"Internal error when trying to access metadata for "</span> + eventId, e);
<a class="jxr_linenumber" name="L1257" href="#L1257">1257</a>         <strong class="jxr_keyword">return</strong> serverError();
<a class="jxr_linenumber" name="L1258" href="#L1258">1258</a>       }
<a class="jxr_linenumber" name="L1259" href="#L1259">1259</a> 
<a class="jxr_linenumber" name="L1260" href="#L1260">1260</a>       <strong class="jxr_keyword">for</strong> (EventCatalogUIAdapter extendedCatalogUIAdapter : extendedCatalogUIAdapters) {
<a class="jxr_linenumber" name="L1261" href="#L1261">1261</a>         metadataList.add(extendedCatalogUIAdapter, extendedCatalogUIAdapter.getFields(mediaPackage));
<a class="jxr_linenumber" name="L1262" href="#L1262">1262</a>       }
<a class="jxr_linenumber" name="L1263" href="#L1263">1263</a>     }
<a class="jxr_linenumber" name="L1264" href="#L1264">1264</a> 
<a class="jxr_linenumber" name="L1265" href="#L1265">1265</a>     <em class="jxr_comment">// Load common metadata</em>
<a class="jxr_linenumber" name="L1266" href="#L1266">1266</a>     <em class="jxr_comment">// We do this after extended metadata because we want to overwrite any extended metadata adapters with the same</em>
<a class="jxr_linenumber" name="L1267" href="#L1267">1267</a>     <em class="jxr_comment">// flavor instead of the other way around.</em>
<a class="jxr_linenumber" name="L1268" href="#L1268">1268</a>     EventCatalogUIAdapter eventCatalogUiAdapter = getIndexService().getCommonEventCatalogUIAdapter();
<a class="jxr_linenumber" name="L1269" href="#L1269">1269</a>     DublinCoreMetadataCollection metadataCollection = eventCatalogUiAdapter.getRawFields(getCollectionQueryDisable());
<a class="jxr_linenumber" name="L1270" href="#L1270">1270</a>     EventUtils.setEventMetadataValues(event, metadataCollection);
<a class="jxr_linenumber" name="L1271" href="#L1271">1271</a>     metadataList.add(eventCatalogUiAdapter, metadataCollection);
<a class="jxr_linenumber" name="L1272" href="#L1272">1272</a> 
<a class="jxr_linenumber" name="L1273" href="#L1273">1273</a>     <em class="jxr_comment">// remove series with empty titles from the collection of the isPartOf field as these can't be converted to json</em>
<a class="jxr_linenumber" name="L1274" href="#L1274">1274</a>     removeSeriesWithNullTitlesFromFieldCollection(metadataList);
<a class="jxr_linenumber" name="L1275" href="#L1275">1275</a> 
<a class="jxr_linenumber" name="L1276" href="#L1276">1276</a>     <em class="jxr_comment">// lock metadata?</em>
<a class="jxr_linenumber" name="L1277" href="#L1277">1277</a>     <strong class="jxr_keyword">final</strong> String wfState = event.getWorkflowState();
<a class="jxr_linenumber" name="L1278" href="#L1278">1278</a>     <strong class="jxr_keyword">if</strong> (wfState != <strong class="jxr_keyword">null</strong> &amp;&amp; WorkflowUtil.isActive(WorkflowInstance.WorkflowState.valueOf(wfState)))
<a class="jxr_linenumber" name="L1279" href="#L1279">1279</a>       metadataList.setLocked(Locked.WORKFLOW_RUNNING);
<a class="jxr_linenumber" name="L1280" href="#L1280">1280</a> 
<a class="jxr_linenumber" name="L1281" href="#L1281">1281</a>     <strong class="jxr_keyword">return</strong> okJson(MetadataJson.listToJson(metadataList, <strong class="jxr_keyword">true</strong>));
<a class="jxr_linenumber" name="L1282" href="#L1282">1282</a>   }
<a class="jxr_linenumber" name="L1283" href="#L1283">1283</a> 
<a class="jxr_linenumber" name="L1284" href="#L1284">1284</a>   <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L1285" href="#L1285">1285</a> <em class="jxr_javadoccomment">   * Create a special query that disables filling the collection of a series, for performance reasons.</em>
<a class="jxr_linenumber" name="L1286" href="#L1286">1286</a> <em class="jxr_javadoccomment">   * The collection can still be fetched via the listprovider endpoint.</em>
<a class="jxr_linenumber" name="L1287" href="#L1287">1287</a> <em class="jxr_javadoccomment">   *</em>
<a class="jxr_linenumber" name="L1288" href="#L1288">1288</a> <em class="jxr_javadoccomment">   * @return a map with resource list queries belonging to metadata fields</em>
<a class="jxr_linenumber" name="L1289" href="#L1289">1289</a> <em class="jxr_javadoccomment">   */</em>
<a class="jxr_linenumber" name="L1290" href="#L1290">1290</a>   <strong class="jxr_keyword">private</strong> Map getCollectionQueryDisable() {
<a class="jxr_linenumber" name="L1291" href="#L1291">1291</a>     HashMap&lt;String, ResourceListQuery&gt; collectionQueryOverrides = <strong class="jxr_keyword">new</strong> HashMap();
<a class="jxr_linenumber" name="L1292" href="#L1292">1292</a>     SeriesListQuery seriesListQuery = <strong class="jxr_keyword">new</strong> SeriesListQuery();
<a class="jxr_linenumber" name="L1293" href="#L1293">1293</a>     seriesListQuery.setLimit(0);
<a class="jxr_linenumber" name="L1294" href="#L1294">1294</a>     collectionQueryOverrides.put(DublinCore.PROPERTY_IS_PART_OF.getLocalName(), seriesListQuery);
<a class="jxr_linenumber" name="L1295" href="#L1295">1295</a>     <strong class="jxr_keyword">return</strong> collectionQueryOverrides;
<a class="jxr_linenumber" name="L1296" href="#L1296">1296</a>   }
<a class="jxr_linenumber" name="L1297" href="#L1297">1297</a> 
<a class="jxr_linenumber" name="L1298" href="#L1298">1298</a>   @POST  <em class="jxr_comment">// use POST instead of GET because of a possibly long list of ids</em>
<a class="jxr_linenumber" name="L1299" href="#L1299">1299</a>   @Path(<span class="jxr_string">"events/metadata.json"</span>)
<a class="jxr_linenumber" name="L1300" href="#L1300">1300</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L1301" href="#L1301">1301</a>   @RestQuery(name = <span class="jxr_string">"geteventsmetadata"</span>,
<a class="jxr_linenumber" name="L1302" href="#L1302">1302</a>              description = <span class="jxr_string">"Returns all the data related to the edit events metadata modal as JSON"</span>,
<a class="jxr_linenumber" name="L1303" href="#L1303">1303</a>              returnDescription = <span class="jxr_string">"All the data related to the edit events metadata modal as JSON"</span>,
<a class="jxr_linenumber" name="L1304" href="#L1304">1304</a>              restParameters = {
<a class="jxr_linenumber" name="L1305" href="#L1305">1305</a>                @RestParameter(name = <span class="jxr_string">"eventIds"</span>, description = <span class="jxr_string">"The event ids"</span>, isRequired = <strong class="jxr_keyword">true</strong>,
<a class="jxr_linenumber" name="L1306" href="#L1306">1306</a>                               type = RestParameter.Type.STRING)
<a class="jxr_linenumber" name="L1307" href="#L1307">1307</a>              }, responses = {
<a class="jxr_linenumber" name="L1308" href="#L1308">1308</a>                @RestResponse(description = <span class="jxr_string">"Returns all the data related to the edit events metadata modal as JSON"</span>,
<a class="jxr_linenumber" name="L1309" href="#L1309">1309</a>                              responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L1310" href="#L1310">1310</a>                @RestResponse(description = <span class="jxr_string">"No events to update, either not found or with running workflow, "</span>
<a class="jxr_linenumber" name="L1311" href="#L1311">1311</a>                                          + <span class="jxr_string">"details in response body."</span>,
<a class="jxr_linenumber" name="L1312" href="#L1312">1312</a>                              responseCode = HttpServletResponse.SC_NOT_FOUND)
<a class="jxr_linenumber" name="L1313" href="#L1313">1313</a>              })
<a class="jxr_linenumber" name="L1314" href="#L1314">1314</a>   <strong class="jxr_keyword">public</strong> Response getEventsMetadata(@FormParam(<span class="jxr_string">"eventIds"</span>) String eventIds) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1315" href="#L1315">1315</a>     <strong class="jxr_keyword">if</strong> (StringUtils.isBlank(eventIds)) {
<a class="jxr_linenumber" name="L1316" href="#L1316">1316</a>       <strong class="jxr_keyword">return</strong> badRequest(<span class="jxr_string">"Event ids can't be empty"</span>);
<a class="jxr_linenumber" name="L1317" href="#L1317">1317</a>     }
<a class="jxr_linenumber" name="L1318" href="#L1318">1318</a> 
<a class="jxr_linenumber" name="L1319" href="#L1319">1319</a>     JSONParser parser = <strong class="jxr_keyword">new</strong> JSONParser();
<a class="jxr_linenumber" name="L1320" href="#L1320">1320</a>     List&lt;String&gt; ids;
<a class="jxr_linenumber" name="L1321" href="#L1321">1321</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1322" href="#L1322">1322</a>       ids = (List&lt;String&gt;) parser.parse(eventIds);
<a class="jxr_linenumber" name="L1323" href="#L1323">1323</a>     } <strong class="jxr_keyword">catch</strong> (org.json.simple.parser.ParseException e) {
<a class="jxr_linenumber" name="L1324" href="#L1324">1324</a>       logger.error(<span class="jxr_string">"Unable to parse '{}'"</span>, eventIds, e);
<a class="jxr_linenumber" name="L1325" href="#L1325">1325</a>       <strong class="jxr_keyword">return</strong> badRequest(<span class="jxr_string">"Unable to parse event ids"</span>);
<a class="jxr_linenumber" name="L1326" href="#L1326">1326</a>     } <strong class="jxr_keyword">catch</strong> (ClassCastException e) {
<a class="jxr_linenumber" name="L1327" href="#L1327">1327</a>       logger.error(<span class="jxr_string">"Unable to cast '{}'"</span>, eventIds, e);
<a class="jxr_linenumber" name="L1328" href="#L1328">1328</a>       <strong class="jxr_keyword">return</strong> badRequest(<span class="jxr_string">"Unable to parse event ids"</span>);
<a class="jxr_linenumber" name="L1329" href="#L1329">1329</a>     }
<a class="jxr_linenumber" name="L1330" href="#L1330">1330</a> 
<a class="jxr_linenumber" name="L1331" href="#L1331">1331</a>     Set&lt;String&gt; eventsNotFound = <strong class="jxr_keyword">new</strong> HashSet();
<a class="jxr_linenumber" name="L1332" href="#L1332">1332</a>     Set&lt;String&gt; eventsWithRunningWorkflow = <strong class="jxr_keyword">new</strong> HashSet();
<a class="jxr_linenumber" name="L1333" href="#L1333">1333</a>     Set&lt;String&gt; eventsMerged = <strong class="jxr_keyword">new</strong> HashSet();
<a class="jxr_linenumber" name="L1334" href="#L1334">1334</a> 
<a class="jxr_linenumber" name="L1335" href="#L1335">1335</a>     <em class="jxr_comment">// collect the metadata of all events</em>
<a class="jxr_linenumber" name="L1336" href="#L1336">1336</a>     List&lt;DublinCoreMetadataCollection&gt; collectedMetadata = <strong class="jxr_keyword">new</strong> ArrayList();
<a class="jxr_linenumber" name="L1337" href="#L1337">1337</a>     <strong class="jxr_keyword">for</strong> (String eventId: ids) {
<a class="jxr_linenumber" name="L1338" href="#L1338">1338</a>       Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L1339" href="#L1339">1339</a>       <em class="jxr_comment">// not found?</em>
<a class="jxr_linenumber" name="L1340" href="#L1340">1340</a>       <strong class="jxr_keyword">if</strong> (optEvent.isNone()) {
<a class="jxr_linenumber" name="L1341" href="#L1341">1341</a>         eventsNotFound.add(eventId);
<a class="jxr_linenumber" name="L1342" href="#L1342">1342</a>         <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="L1343" href="#L1343">1343</a>       }
<a class="jxr_linenumber" name="L1344" href="#L1344">1344</a> 
<a class="jxr_linenumber" name="L1345" href="#L1345">1345</a>       Event event = optEvent.get();
<a class="jxr_linenumber" name="L1346" href="#L1346">1346</a> 
<a class="jxr_linenumber" name="L1347" href="#L1347">1347</a>       <em class="jxr_comment">// check if there's a running workflow</em>
<a class="jxr_linenumber" name="L1348" href="#L1348">1348</a>       <strong class="jxr_keyword">final</strong> String wfState = event.getWorkflowState();
<a class="jxr_linenumber" name="L1349" href="#L1349">1349</a>       <strong class="jxr_keyword">if</strong> (wfState != <strong class="jxr_keyword">null</strong> &amp;&amp; WorkflowUtil.isActive(WorkflowInstance.WorkflowState.valueOf(wfState))) {
<a class="jxr_linenumber" name="L1350" href="#L1350">1350</a>         eventsWithRunningWorkflow.add(eventId);
<a class="jxr_linenumber" name="L1351" href="#L1351">1351</a>         <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="L1352" href="#L1352">1352</a>       }
<a class="jxr_linenumber" name="L1353" href="#L1353">1353</a> 
<a class="jxr_linenumber" name="L1354" href="#L1354">1354</a>       <em class="jxr_comment">// collect metadata</em>
<a class="jxr_linenumber" name="L1355" href="#L1355">1355</a>       EventCatalogUIAdapter eventCatalogUiAdapter = getIndexService().getCommonEventCatalogUIAdapter();
<a class="jxr_linenumber" name="L1356" href="#L1356">1356</a>       DublinCoreMetadataCollection metadataCollection = eventCatalogUiAdapter.getRawFields(
<a class="jxr_linenumber" name="L1357" href="#L1357">1357</a>             getCollectionQueryDisable());
<a class="jxr_linenumber" name="L1358" href="#L1358">1358</a>       EventUtils.setEventMetadataValues(event, metadataCollection);
<a class="jxr_linenumber" name="L1359" href="#L1359">1359</a>       collectedMetadata.add(metadataCollection);
<a class="jxr_linenumber" name="L1360" href="#L1360">1360</a> 
<a class="jxr_linenumber" name="L1361" href="#L1361">1361</a>       eventsMerged.add(eventId);
<a class="jxr_linenumber" name="L1362" href="#L1362">1362</a>     }
<a class="jxr_linenumber" name="L1363" href="#L1363">1363</a> 
<a class="jxr_linenumber" name="L1364" href="#L1364">1364</a>     <em class="jxr_comment">// no events found?</em>
<a class="jxr_linenumber" name="L1365" href="#L1365">1365</a>     <strong class="jxr_keyword">if</strong> (collectedMetadata.isEmpty()) {
<a class="jxr_linenumber" name="L1366" href="#L1366">1366</a>       <strong class="jxr_keyword">return</strong> notFoundJson(obj(
<a class="jxr_linenumber" name="L1367" href="#L1367">1367</a>         f(<span class="jxr_string">"notFound"</span>, JSONUtils.setToJSON(eventsNotFound)),
<a class="jxr_linenumber" name="L1368" href="#L1368">1368</a>         f(<span class="jxr_string">"runningWorkflow"</span>, JSONUtils.setToJSON(eventsWithRunningWorkflow))));
<a class="jxr_linenumber" name="L1369" href="#L1369">1369</a>     }
<a class="jxr_linenumber" name="L1370" href="#L1370">1370</a> 
<a class="jxr_linenumber" name="L1371" href="#L1371">1371</a>     <em class="jxr_comment">// merge metadata of events</em>
<a class="jxr_linenumber" name="L1372" href="#L1372">1372</a>     DublinCoreMetadataCollection mergedMetadata;
<a class="jxr_linenumber" name="L1373" href="#L1373">1373</a>     <strong class="jxr_keyword">if</strong> (collectedMetadata.size() == 1) {
<a class="jxr_linenumber" name="L1374" href="#L1374">1374</a>       mergedMetadata = collectedMetadata.get(0);
<a class="jxr_linenumber" name="L1375" href="#L1375">1375</a>     }
<a class="jxr_linenumber" name="L1376" href="#L1376">1376</a>     <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L1377" href="#L1377">1377</a>       <em class="jxr_comment">//use first metadata collection as base</em>
<a class="jxr_linenumber" name="L1378" href="#L1378">1378</a>       mergedMetadata = <strong class="jxr_keyword">new</strong> DublinCoreMetadataCollection(collectedMetadata.get(0));
<a class="jxr_linenumber" name="L1379" href="#L1379">1379</a>       collectedMetadata.remove(0);
<a class="jxr_linenumber" name="L1380" href="#L1380">1380</a> 
<a class="jxr_linenumber" name="L1381" href="#L1381">1381</a>       <strong class="jxr_keyword">for</strong> (MetadataField field : mergedMetadata.getFields()) {
<a class="jxr_linenumber" name="L1382" href="#L1382">1382</a>         <strong class="jxr_keyword">for</strong> (DublinCoreMetadataCollection otherMetadataCollection : collectedMetadata) {
<a class="jxr_linenumber" name="L1383" href="#L1383">1383</a>           MetadataField matchingField = otherMetadataCollection.getOutputFields().get(field.getOutputID());
<a class="jxr_linenumber" name="L1384" href="#L1384">1384</a> 
<a class="jxr_linenumber" name="L1385" href="#L1385">1385</a>           <em class="jxr_comment">// check if fields have the same value</em>
<a class="jxr_linenumber" name="L1386" href="#L1386">1386</a>           <strong class="jxr_keyword">if</strong> (!Objects.equals(field.getValue(), matchingField.getValue())) {
<a class="jxr_linenumber" name="L1387" href="#L1387">1387</a>             field.setDifferentValues();
<a class="jxr_linenumber" name="L1388" href="#L1388">1388</a>             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L1389" href="#L1389">1389</a>           }
<a class="jxr_linenumber" name="L1390" href="#L1390">1390</a>         }
<a class="jxr_linenumber" name="L1391" href="#L1391">1391</a>       }
<a class="jxr_linenumber" name="L1392" href="#L1392">1392</a>     }
<a class="jxr_linenumber" name="L1393" href="#L1393">1393</a> 
<a class="jxr_linenumber" name="L1394" href="#L1394">1394</a>     <strong class="jxr_keyword">return</strong> okJson(obj(
<a class="jxr_linenumber" name="L1395" href="#L1395">1395</a>       f(<span class="jxr_string">"metadata"</span>, MetadataJson.collectionToJson(mergedMetadata, <strong class="jxr_keyword">true</strong>)),
<a class="jxr_linenumber" name="L1396" href="#L1396">1396</a>       f(<span class="jxr_string">"notFound"</span>, JSONUtils.setToJSON(eventsNotFound)),
<a class="jxr_linenumber" name="L1397" href="#L1397">1397</a>       f(<span class="jxr_string">"runningWorkflow"</span>, JSONUtils.setToJSON(eventsWithRunningWorkflow)),
<a class="jxr_linenumber" name="L1398" href="#L1398">1398</a>       f(<span class="jxr_string">"merged"</span>, JSONUtils.setToJSON(eventsMerged))
<a class="jxr_linenumber" name="L1399" href="#L1399">1399</a>     ));
<a class="jxr_linenumber" name="L1400" href="#L1400">1400</a>   }
<a class="jxr_linenumber" name="L1401" href="#L1401">1401</a> 
<a class="jxr_linenumber" name="L1402" href="#L1402">1402</a>   @PUT
<a class="jxr_linenumber" name="L1403" href="#L1403">1403</a>   @Path(<span class="jxr_string">"bulk/update"</span>)
<a class="jxr_linenumber" name="L1404" href="#L1404">1404</a>   @RestQuery(name = <span class="jxr_string">"bulkupdate"</span>, description = <span class="jxr_string">"Update all of the given events at once"</span>, restParameters = {
<a class="jxr_linenumber" name="L1405" href="#L1405">1405</a>     @RestParameter(name = <span class="jxr_string">"update"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.TEXT, description = <span class="jxr_string">"The list of groups with events and fields to update."</span>)}, responses = {
<a class="jxr_linenumber" name="L1406" href="#L1406">1406</a>     @RestResponse(description = <span class="jxr_string">"All events have been updated successfully."</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L1407" href="#L1407">1407</a>     @RestResponse(description = <span class="jxr_string">"Could not parse update instructions."</span>, responseCode = HttpServletResponse.SC_BAD_REQUEST),
<a class="jxr_linenumber" name="L1408" href="#L1408">1408</a>     @RestResponse(description = <span class="jxr_string">"Field updating metadata or scheduling information. Some events may have been updated. Details are available in the response body."</span>, responseCode = HttpServletResponse.SC_INTERNAL_SERVER_ERROR),
<a class="jxr_linenumber" name="L1409" href="#L1409">1409</a>     @RestResponse(description = <span class="jxr_string">"The events in the response body were not found. No events were updated."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND)},
<a class="jxr_linenumber" name="L1410" href="#L1410">1410</a>     returnDescription = <span class="jxr_string">"In case of success, no content is returned. In case of errors while updating the metadata or scheduling information, the errors are returned. In case events were not found, their ids are returned"</span>)
<a class="jxr_linenumber" name="L1411" href="#L1411">1411</a>   <strong class="jxr_keyword">public</strong> Response bulkUpdate(@FormParam(<span class="jxr_string">"update"</span>) String updateJson) {
<a class="jxr_linenumber" name="L1412" href="#L1412">1412</a> 
<a class="jxr_linenumber" name="L1413" href="#L1413">1413</a>     <strong class="jxr_keyword">final</strong> BulkUpdateUtil.BulkUpdateInstructions instructions;
<a class="jxr_linenumber" name="L1414" href="#L1414">1414</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1415" href="#L1415">1415</a>       instructions = <strong class="jxr_keyword">new</strong> BulkUpdateUtil.BulkUpdateInstructions(updateJson);
<a class="jxr_linenumber" name="L1416" href="#L1416">1416</a>     } <strong class="jxr_keyword">catch</strong> (IllegalArgumentException e) {
<a class="jxr_linenumber" name="L1417" href="#L1417">1417</a>       <strong class="jxr_keyword">return</strong> badRequest(<span class="jxr_string">"Cannot parse bulk update instructions"</span>);
<a class="jxr_linenumber" name="L1418" href="#L1418">1418</a>     }
<a class="jxr_linenumber" name="L1419" href="#L1419">1419</a> 
<a class="jxr_linenumber" name="L1420" href="#L1420">1420</a>     <strong class="jxr_keyword">final</strong> Map&lt;String, String&gt; metadataUpdateFailures = <strong class="jxr_keyword">new</strong> HashMap&lt;&gt;();
<a class="jxr_linenumber" name="L1421" href="#L1421">1421</a>     <strong class="jxr_keyword">final</strong> Map&lt;String, String&gt; schedulingUpdateFailures = <strong class="jxr_keyword">new</strong> HashMap&lt;&gt;();
<a class="jxr_linenumber" name="L1422" href="#L1422">1422</a> 
<a class="jxr_linenumber" name="L1423" href="#L1423">1423</a>     <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> BulkUpdateUtil.BulkUpdateInstructionGroup groupInstructions : instructions.getGroups()) {
<a class="jxr_linenumber" name="L1424" href="#L1424">1424</a>       <em class="jxr_comment">// Get all the events to edit</em>
<a class="jxr_linenumber" name="L1425" href="#L1425">1425</a>       <strong class="jxr_keyword">final</strong> Map&lt;String, Optional&lt;Event&gt;&gt; events = groupInstructions.getEventIds().stream()
<a class="jxr_linenumber" name="L1426" href="#L1426">1426</a>         .collect(Collectors.toMap(id -&gt; id, id -&gt; BulkUpdateUtil.getEvent(getIndexService(), getIndex(), id)));
<a class="jxr_linenumber" name="L1427" href="#L1427">1427</a> 
<a class="jxr_linenumber" name="L1428" href="#L1428">1428</a>       <em class="jxr_comment">// Check for invalid (non-existing) event ids</em>
<a class="jxr_linenumber" name="L1429" href="#L1429">1429</a>       <strong class="jxr_keyword">final</strong> Set&lt;String&gt; notFoundIds = events.entrySet().stream().filter(e -&gt; !e.getValue().isPresent()).map(Entry::getKey).collect(Collectors.toSet());
<a class="jxr_linenumber" name="L1430" href="#L1430">1430</a>       <strong class="jxr_keyword">if</strong> (!notFoundIds.isEmpty()) {
<a class="jxr_linenumber" name="L1431" href="#L1431">1431</a>         <strong class="jxr_keyword">return</strong> notFoundJson(JSONUtils.setToJSON(notFoundIds));
<a class="jxr_linenumber" name="L1432" href="#L1432">1432</a>       }
<a class="jxr_linenumber" name="L1433" href="#L1433">1433</a> 
<a class="jxr_linenumber" name="L1434" href="#L1434">1434</a> 
<a class="jxr_linenumber" name="L1435" href="#L1435">1435</a>       events.values().forEach(e -&gt; e.ifPresent(event -&gt; {
<a class="jxr_linenumber" name="L1436" href="#L1436">1436</a> 
<a class="jxr_linenumber" name="L1437" href="#L1437">1437</a>         JSONObject metadata = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1438" href="#L1438">1438</a> 
<a class="jxr_linenumber" name="L1439" href="#L1439">1439</a>         <em class="jxr_comment">// Update the scheduling information</em>
<a class="jxr_linenumber" name="L1440" href="#L1440">1440</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1441" href="#L1441">1441</a>           <strong class="jxr_keyword">if</strong> (groupInstructions.getScheduling() != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1442" href="#L1442">1442</a>             <em class="jxr_comment">// Since we only have the start/end time, we have to add the correct date(s) for this event.</em>
<a class="jxr_linenumber" name="L1443" href="#L1443">1443</a>             <strong class="jxr_keyword">final</strong> JSONObject scheduling = BulkUpdateUtil.addSchedulingDates(event, groupInstructions.getScheduling());
<a class="jxr_linenumber" name="L1444" href="#L1444">1444</a>             updateEventScheduling(scheduling.toJSONString(), event);
<a class="jxr_linenumber" name="L1445" href="#L1445">1445</a>             <em class="jxr_comment">// We have to update the non-technical metadata as well to keep them in sync with the technical ones.</em>
<a class="jxr_linenumber" name="L1446" href="#L1446">1446</a>             metadata = BulkUpdateUtil.toNonTechnicalMetadataJson(scheduling);
<a class="jxr_linenumber" name="L1447" href="#L1447">1447</a>           }
<a class="jxr_linenumber" name="L1448" href="#L1448">1448</a>         } <strong class="jxr_keyword">catch</strong> (Exception exception) {
<a class="jxr_linenumber" name="L1449" href="#L1449">1449</a>           schedulingUpdateFailures.put(event.getIdentifier(), exception.getMessage());
<a class="jxr_linenumber" name="L1450" href="#L1450">1450</a>         }
<a class="jxr_linenumber" name="L1451" href="#L1451">1451</a> 
<a class="jxr_linenumber" name="L1452" href="#L1452">1452</a>         <em class="jxr_comment">// Update the event metadata</em>
<a class="jxr_linenumber" name="L1453" href="#L1453">1453</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1454" href="#L1454">1454</a>           <strong class="jxr_keyword">if</strong> (groupInstructions.getMetadata() != <strong class="jxr_keyword">null</strong> || metadata != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1455" href="#L1455">1455</a>             metadata = BulkUpdateUtil.mergeMetadataFields(metadata, groupInstructions.getMetadata());
<a class="jxr_linenumber" name="L1456" href="#L1456">1456</a>             getIndexService().updateAllEventMetadata(event.getIdentifier(), JSONArray.toJSONString(Collections.singletonList(metadata)), getIndex());
<a class="jxr_linenumber" name="L1457" href="#L1457">1457</a>           }
<a class="jxr_linenumber" name="L1458" href="#L1458">1458</a>         } <strong class="jxr_keyword">catch</strong> (Exception exception) {
<a class="jxr_linenumber" name="L1459" href="#L1459">1459</a>           metadataUpdateFailures.put(event.getIdentifier(), exception.getMessage());
<a class="jxr_linenumber" name="L1460" href="#L1460">1460</a>         }
<a class="jxr_linenumber" name="L1461" href="#L1461">1461</a>       }));
<a class="jxr_linenumber" name="L1462" href="#L1462">1462</a>     }
<a class="jxr_linenumber" name="L1463" href="#L1463">1463</a> 
<a class="jxr_linenumber" name="L1464" href="#L1464">1464</a>     <em class="jxr_comment">// Check if there were any errors updating the metadata or scheduling information</em>
<a class="jxr_linenumber" name="L1465" href="#L1465">1465</a>     <strong class="jxr_keyword">if</strong> (!metadataUpdateFailures.isEmpty() || !schedulingUpdateFailures.isEmpty()) {
<a class="jxr_linenumber" name="L1466" href="#L1466">1466</a>       <strong class="jxr_keyword">return</strong> serverErrorJson(obj(
<a class="jxr_linenumber" name="L1467" href="#L1467">1467</a>         f(<span class="jxr_string">"metadataFailures"</span>, JSONUtils.mapToJSON(metadataUpdateFailures)),
<a class="jxr_linenumber" name="L1468" href="#L1468">1468</a>         f(<span class="jxr_string">"schedulingFailures"</span>, JSONUtils.mapToJSON(schedulingUpdateFailures))
<a class="jxr_linenumber" name="L1469" href="#L1469">1469</a>       ));
<a class="jxr_linenumber" name="L1470" href="#L1470">1470</a>     }
<a class="jxr_linenumber" name="L1471" href="#L1471">1471</a>     <strong class="jxr_keyword">return</strong> ok();
<a class="jxr_linenumber" name="L1472" href="#L1472">1472</a>   }
<a class="jxr_linenumber" name="L1473" href="#L1473">1473</a> 
<a class="jxr_linenumber" name="L1474" href="#L1474">1474</a>   @POST
<a class="jxr_linenumber" name="L1475" href="#L1475">1475</a>   @Path(<span class="jxr_string">"bulk/conflicts"</span>)
<a class="jxr_linenumber" name="L1476" href="#L1476">1476</a>   @RestQuery(name = <span class="jxr_string">"getBulkConflicts"</span>, description = <span class="jxr_string">"Checks if the current bulk update scheduling settings are in a conflict with another event"</span>, returnDescription = <span class="jxr_string">"Returns NO CONTENT if no event are in conflict within specified period or list of conflicting recordings in JSON"</span>, restParameters = {
<a class="jxr_linenumber" name="L1477" href="#L1477">1477</a>     @RestParameter(name = <span class="jxr_string">"update"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.TEXT, description = <span class="jxr_string">"The list of events and fields to update."</span>)}, responses = {
<a class="jxr_linenumber" name="L1478" href="#L1478">1478</a>     @RestResponse(responseCode = HttpServletResponse.SC_NO_CONTENT, description = <span class="jxr_string">"No conflicting events found"</span>),
<a class="jxr_linenumber" name="L1479" href="#L1479">1479</a>     @RestResponse(responseCode = HttpServletResponse.SC_NOT_FOUND, description = <span class="jxr_string">"The events in the response body were not found. No events were updated."</span>),
<a class="jxr_linenumber" name="L1480" href="#L1480">1480</a>     @RestResponse(responseCode = HttpServletResponse.SC_CONFLICT, description = <span class="jxr_string">"There is a conflict"</span>),
<a class="jxr_linenumber" name="L1481" href="#L1481">1481</a>     @RestResponse(responseCode = HttpServletResponse.SC_BAD_REQUEST, description = <span class="jxr_string">"Missing or invalid parameters"</span>)})
<a class="jxr_linenumber" name="L1482" href="#L1482">1482</a>   <strong class="jxr_keyword">public</strong> Response getBulkConflicts(@FormParam(<span class="jxr_string">"update"</span>) <strong class="jxr_keyword">final</strong> String updateJson) <strong class="jxr_keyword">throws</strong> NotFoundException {
<a class="jxr_linenumber" name="L1483" href="#L1483">1483</a>     <strong class="jxr_keyword">final</strong> BulkUpdateUtil.BulkUpdateInstructions instructions;
<a class="jxr_linenumber" name="L1484" href="#L1484">1484</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1485" href="#L1485">1485</a>       instructions = <strong class="jxr_keyword">new</strong> BulkUpdateUtil.BulkUpdateInstructions(updateJson);
<a class="jxr_linenumber" name="L1486" href="#L1486">1486</a>     } <strong class="jxr_keyword">catch</strong> (IllegalArgumentException e) {
<a class="jxr_linenumber" name="L1487" href="#L1487">1487</a>       <strong class="jxr_keyword">return</strong> badRequest(<span class="jxr_string">"Cannot parse bulk update instructions"</span>);
<a class="jxr_linenumber" name="L1488" href="#L1488">1488</a>     }
<a class="jxr_linenumber" name="L1489" href="#L1489">1489</a> 
<a class="jxr_linenumber" name="L1490" href="#L1490">1490</a>     <strong class="jxr_keyword">final</strong> Map&lt;String, List&lt;JValue&gt;&gt; conflicts = <strong class="jxr_keyword">new</strong> HashMap&lt;&gt;();
<a class="jxr_linenumber" name="L1491" href="#L1491">1491</a>     <strong class="jxr_keyword">final</strong> List&lt;Tuple3&lt;String, Optional&lt;Event&gt;, JSONObject&gt;&gt; eventsWithSchedulingOpt = instructions.getGroups().stream()
<a class="jxr_linenumber" name="L1492" href="#L1492">1492</a>       .flatMap(group -&gt; group.getEventIds().stream().map(eventId -&gt; Tuple3
<a class="jxr_linenumber" name="L1493" href="#L1493">1493</a>         .tuple3(eventId, BulkUpdateUtil.getEvent(getIndexService(), getIndex(), eventId), group.getScheduling())))
<a class="jxr_linenumber" name="L1494" href="#L1494">1494</a>       .collect(Collectors.toList());
<a class="jxr_linenumber" name="L1495" href="#L1495">1495</a>     <em class="jxr_comment">// Check for invalid (non-existing) event ids</em>
<a class="jxr_linenumber" name="L1496" href="#L1496">1496</a>     <strong class="jxr_keyword">final</strong> Set&lt;String&gt; notFoundIds = eventsWithSchedulingOpt.stream().filter(e -&gt; !e.getB().isPresent())
<a class="jxr_linenumber" name="L1497" href="#L1497">1497</a>       .map(Tuple3::getA).collect(Collectors.toSet());
<a class="jxr_linenumber" name="L1498" href="#L1498">1498</a>     <strong class="jxr_keyword">if</strong> (!notFoundIds.isEmpty()) {
<a class="jxr_linenumber" name="L1499" href="#L1499">1499</a>       <strong class="jxr_keyword">return</strong> notFoundJson(JSONUtils.setToJSON(notFoundIds));
<a class="jxr_linenumber" name="L1500" href="#L1500">1500</a>     }
<a class="jxr_linenumber" name="L1501" href="#L1501">1501</a>     <strong class="jxr_keyword">final</strong> List&lt;Tuple&lt;Event, JSONObject&gt;&gt; eventsWithScheduling = eventsWithSchedulingOpt.stream()
<a class="jxr_linenumber" name="L1502" href="#L1502">1502</a>       .map(e -&gt; Tuple.tuple(e.getB().get(), e.getC())).collect(Collectors.toList());
<a class="jxr_linenumber" name="L1503" href="#L1503">1503</a>     <strong class="jxr_keyword">final</strong> Set&lt;String&gt; changedIds = eventsWithScheduling.stream().map(e -&gt; e.getA().getIdentifier())
<a class="jxr_linenumber" name="L1504" href="#L1504">1504</a>       .collect(Collectors.toSet());
<a class="jxr_linenumber" name="L1505" href="#L1505">1505</a>     <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> Tuple&lt;Event, JSONObject&gt; eventWithGroup : eventsWithScheduling) {
<a class="jxr_linenumber" name="L1506" href="#L1506">1506</a>       <strong class="jxr_keyword">final</strong> Event event = eventWithGroup.getA();
<a class="jxr_linenumber" name="L1507" href="#L1507">1507</a>       <strong class="jxr_keyword">final</strong> JSONObject groupScheduling = eventWithGroup.getB();
<a class="jxr_linenumber" name="L1508" href="#L1508">1508</a>       <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1509" href="#L1509">1509</a>         <strong class="jxr_keyword">if</strong> (groupScheduling != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1510" href="#L1510">1510</a>           <em class="jxr_comment">// Since we only have the start/end time, we have to add the correct date(s) for this event.</em>
<a class="jxr_linenumber" name="L1511" href="#L1511">1511</a>           <strong class="jxr_keyword">final</strong> JSONObject scheduling = BulkUpdateUtil.addSchedulingDates(event, groupScheduling);
<a class="jxr_linenumber" name="L1512" href="#L1512">1512</a>           <strong class="jxr_keyword">final</strong> Date start = Date.from(Instant.parse((String) scheduling.get(SCHEDULING_START_KEY)));
<a class="jxr_linenumber" name="L1513" href="#L1513">1513</a>           <strong class="jxr_keyword">final</strong> Date end = Date.from(Instant.parse((String) scheduling.get(SCHEDULING_END_KEY)));
<a class="jxr_linenumber" name="L1514" href="#L1514">1514</a>           <strong class="jxr_keyword">final</strong> String agentId = Optional.ofNullable((String) scheduling.get(SCHEDULING_AGENT_ID_KEY))
<a class="jxr_linenumber" name="L1515" href="#L1515">1515</a>             .orElse(event.getAgentId());
<a class="jxr_linenumber" name="L1516" href="#L1516">1516</a> 
<a class="jxr_linenumber" name="L1517" href="#L1517">1517</a>           <strong class="jxr_keyword">final</strong> List&lt;JValue&gt; currentConflicts = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L1518" href="#L1518">1518</a> 
<a class="jxr_linenumber" name="L1519" href="#L1519">1519</a>           <em class="jxr_comment">// Check for conflicts between the events themselves</em>
<a class="jxr_linenumber" name="L1520" href="#L1520">1520</a>           eventsWithScheduling.stream()
<a class="jxr_linenumber" name="L1521" href="#L1521">1521</a>             .filter(otherEvent -&gt; !otherEvent.getA().getIdentifier().equals(event.getIdentifier()))
<a class="jxr_linenumber" name="L1522" href="#L1522">1522</a>             .forEach(otherEvent -&gt; {
<a class="jxr_linenumber" name="L1523" href="#L1523">1523</a>             <strong class="jxr_keyword">final</strong> JSONObject otherScheduling = BulkUpdateUtil.addSchedulingDates(otherEvent.getA(), otherEvent.getB());
<a class="jxr_linenumber" name="L1524" href="#L1524">1524</a>             <strong class="jxr_keyword">final</strong> Date otherStart = Date.from(Instant.parse((String) otherScheduling.get(SCHEDULING_START_KEY)));
<a class="jxr_linenumber" name="L1525" href="#L1525">1525</a>             <strong class="jxr_keyword">final</strong> Date otherEnd = Date.from(Instant.parse((String) otherScheduling.get(SCHEDULING_END_KEY)));
<a class="jxr_linenumber" name="L1526" href="#L1526">1526</a>             <strong class="jxr_keyword">final</strong> String otherAgentId = Optional.ofNullable((String) otherScheduling.get(SCHEDULING_AGENT_ID_KEY))
<a class="jxr_linenumber" name="L1527" href="#L1527">1527</a>               .orElse(otherEvent.getA().getAgentId());
<a class="jxr_linenumber" name="L1528" href="#L1528">1528</a>             <strong class="jxr_keyword">if</strong> (!otherAgentId.equals(agentId)) {
<a class="jxr_linenumber" name="L1529" href="#L1529">1529</a>               <em class="jxr_comment">// different agent -&gt; no conflict</em>
<a class="jxr_linenumber" name="L1530" href="#L1530">1530</a>               <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="L1531" href="#L1531">1531</a>             }
<a class="jxr_linenumber" name="L1532" href="#L1532">1532</a>             <strong class="jxr_keyword">if</strong> (Util.schedulingIntervalsOverlap(start, end, otherStart, otherEnd)) {
<a class="jxr_linenumber" name="L1533" href="#L1533">1533</a>               <em class="jxr_comment">// conflict</em>
<a class="jxr_linenumber" name="L1534" href="#L1534">1534</a>               currentConflicts.add(convertEventToConflictingObject(DateTimeSupport.toUTC(otherStart.getTime()),
<a class="jxr_linenumber" name="L1535" href="#L1535">1535</a>                 DateTimeSupport.toUTC(otherEnd.getTime()), otherEvent.getA().getTitle()));
<a class="jxr_linenumber" name="L1536" href="#L1536">1536</a>             }
<a class="jxr_linenumber" name="L1537" href="#L1537">1537</a>           });
<a class="jxr_linenumber" name="L1538" href="#L1538">1538</a> 
<a class="jxr_linenumber" name="L1539" href="#L1539">1539</a>           <em class="jxr_comment">// Check for conflicts with other events from the database</em>
<a class="jxr_linenumber" name="L1540" href="#L1540">1540</a>           <strong class="jxr_keyword">final</strong> List&lt;MediaPackage&gt; conflicting = getSchedulerService().findConflictingEvents(agentId, start, end)
<a class="jxr_linenumber" name="L1541" href="#L1541">1541</a>             .stream()
<a class="jxr_linenumber" name="L1542" href="#L1542">1542</a>             .filter(mp -&gt; !changedIds.contains(mp.getIdentifier().toString()))
<a class="jxr_linenumber" name="L1543" href="#L1543">1543</a>             .collect(Collectors.toList());
<a class="jxr_linenumber" name="L1544" href="#L1544">1544</a>           <strong class="jxr_keyword">if</strong> (!conflicting.isEmpty()) {
<a class="jxr_linenumber" name="L1545" href="#L1545">1545</a>             currentConflicts.addAll(convertToConflictObjects(event.getIdentifier(), conflicting));
<a class="jxr_linenumber" name="L1546" href="#L1546">1546</a>           }
<a class="jxr_linenumber" name="L1547" href="#L1547">1547</a>           conflicts.put(event.getIdentifier(), currentConflicts);
<a class="jxr_linenumber" name="L1548" href="#L1548">1548</a>         }
<a class="jxr_linenumber" name="L1549" href="#L1549">1549</a>       } <strong class="jxr_keyword">catch</strong> (<strong class="jxr_keyword">final</strong> SchedulerException | UnauthorizedException | SearchIndexException exception) {
<a class="jxr_linenumber" name="L1550" href="#L1550">1550</a>         <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> RuntimeException(exception);
<a class="jxr_linenumber" name="L1551" href="#L1551">1551</a>       }
<a class="jxr_linenumber" name="L1552" href="#L1552">1552</a>     }
<a class="jxr_linenumber" name="L1553" href="#L1553">1553</a> 
<a class="jxr_linenumber" name="L1554" href="#L1554">1554</a>     <strong class="jxr_keyword">if</strong> (!conflicts.isEmpty()) {
<a class="jxr_linenumber" name="L1555" href="#L1555">1555</a>       <strong class="jxr_keyword">final</strong> List&lt;JValue&gt; responseJson = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L1556" href="#L1556">1556</a>       conflicts.forEach((eventId, conflictingEvents) -&gt; {
<a class="jxr_linenumber" name="L1557" href="#L1557">1557</a>         <strong class="jxr_keyword">if</strong> (!conflictingEvents.isEmpty()) {
<a class="jxr_linenumber" name="L1558" href="#L1558">1558</a>           responseJson.add(obj(f(<span class="jxr_string">"eventId"</span>, eventId), f(<span class="jxr_string">"conflicts"</span>, arr(conflictingEvents))));
<a class="jxr_linenumber" name="L1559" href="#L1559">1559</a>         }
<a class="jxr_linenumber" name="L1560" href="#L1560">1560</a>       });
<a class="jxr_linenumber" name="L1561" href="#L1561">1561</a>       <strong class="jxr_keyword">if</strong> (!responseJson.isEmpty()) {
<a class="jxr_linenumber" name="L1562" href="#L1562">1562</a>         <strong class="jxr_keyword">return</strong> conflictJson(arr(responseJson));
<a class="jxr_linenumber" name="L1563" href="#L1563">1563</a>       }
<a class="jxr_linenumber" name="L1564" href="#L1564">1564</a>     }
<a class="jxr_linenumber" name="L1565" href="#L1565">1565</a> 
<a class="jxr_linenumber" name="L1566" href="#L1566">1566</a>     <strong class="jxr_keyword">return</strong> noContent();
<a class="jxr_linenumber" name="L1567" href="#L1567">1567</a>   }
<a class="jxr_linenumber" name="L1568" href="#L1568">1568</a> 
<a class="jxr_linenumber" name="L1569" href="#L1569">1569</a>   @PUT
<a class="jxr_linenumber" name="L1570" href="#L1570">1570</a>   @Path(<span class="jxr_string">"{eventId}/metadata"</span>)
<a class="jxr_linenumber" name="L1571" href="#L1571">1571</a>   @RestQuery(name = <span class="jxr_string">"updateeventmetadata"</span>, description = <span class="jxr_string">"Update the passed metadata for the event with the given Id"</span>, pathParameters = {
<a class="jxr_linenumber" name="L1572" href="#L1572">1572</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, restParameters = {
<a class="jxr_linenumber" name="L1573" href="#L1573">1573</a>                   @RestParameter(name = <span class="jxr_string">"metadata"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.TEXT, description = <span class="jxr_string">"The list of metadata to update"</span>) }, responses = {
<a class="jxr_linenumber" name="L1574" href="#L1574">1574</a>                           @RestResponse(description = <span class="jxr_string">"The metadata have been updated."</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L1575" href="#L1575">1575</a>                           @RestResponse(description = <span class="jxr_string">"Could not parse metadata."</span>, responseCode = HttpServletResponse.SC_BAD_REQUEST),
<a class="jxr_linenumber" name="L1576" href="#L1576">1576</a>                           @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) }, returnDescription = <span class="jxr_string">"No content is returned."</span>)
<a class="jxr_linenumber" name="L1577" href="#L1577">1577</a>   <strong class="jxr_keyword">public</strong> Response updateEventMetadata(@PathParam(<span class="jxr_string">"eventId"</span>) String id, @FormParam(<span class="jxr_string">"metadata"</span>) String metadataJSON)
<a class="jxr_linenumber" name="L1578" href="#L1578">1578</a>           <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1579" href="#L1579">1579</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(id, getIndex());
<a class="jxr_linenumber" name="L1580" href="#L1580">1580</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L1581" href="#L1581">1581</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, id);
<a class="jxr_linenumber" name="L1582" href="#L1582">1582</a> 
<a class="jxr_linenumber" name="L1583" href="#L1583">1583</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1584" href="#L1584">1584</a>       MetadataList metadataList = getIndexService().updateAllEventMetadata(id, metadataJSON, getIndex());
<a class="jxr_linenumber" name="L1585" href="#L1585">1585</a>       <strong class="jxr_keyword">return</strong> okJson(MetadataJson.listToJson(metadataList, <strong class="jxr_keyword">true</strong>));
<a class="jxr_linenumber" name="L1586" href="#L1586">1586</a>     } <strong class="jxr_keyword">catch</strong> (IllegalArgumentException e) {
<a class="jxr_linenumber" name="L1587" href="#L1587">1587</a>       <strong class="jxr_keyword">return</strong> badRequest(String.format(<span class="jxr_string">"Event %s metadata can't be updated.: %s"</span>, id, e.getMessage()));
<a class="jxr_linenumber" name="L1588" href="#L1588">1588</a>     }
<a class="jxr_linenumber" name="L1589" href="#L1589">1589</a>   }
<a class="jxr_linenumber" name="L1590" href="#L1590">1590</a> 
<a class="jxr_linenumber" name="L1591" href="#L1591">1591</a>   @PUT
<a class="jxr_linenumber" name="L1592" href="#L1592">1592</a>   @Path(<span class="jxr_string">"events/metadata"</span>)
<a class="jxr_linenumber" name="L1593" href="#L1593">1593</a>   @RestQuery(name = <span class="jxr_string">"updateeventsmetadata"</span>,
<a class="jxr_linenumber" name="L1594" href="#L1594">1594</a>     description = <span class="jxr_string">"Update the passed metadata for the events with the given ids"</span>,
<a class="jxr_linenumber" name="L1595" href="#L1595">1595</a>     restParameters = {
<a class="jxr_linenumber" name="L1596" href="#L1596">1596</a>       @RestParameter(name = <span class="jxr_string">"eventIds"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING,
<a class="jxr_linenumber" name="L1597" href="#L1597">1597</a>         description = <span class="jxr_string">"The ids of the events to update"</span>),
<a class="jxr_linenumber" name="L1598" href="#L1598">1598</a>       @RestParameter(name = <span class="jxr_string">"metadata"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.TEXT,
<a class="jxr_linenumber" name="L1599" href="#L1599">1599</a>         description = <span class="jxr_string">"The metadata fields to update"</span>),
<a class="jxr_linenumber" name="L1600" href="#L1600">1600</a>     }, responses = {
<a class="jxr_linenumber" name="L1601" href="#L1601">1601</a>     @RestResponse(description = <span class="jxr_string">"All events have been updated successfully."</span>,
<a class="jxr_linenumber" name="L1602" href="#L1602">1602</a>       responseCode = HttpServletResponse.SC_NO_CONTENT),
<a class="jxr_linenumber" name="L1603" href="#L1603">1603</a>     @RestResponse(description = <span class="jxr_string">"One or multiple errors occured while updating event metadata. "</span>
<a class="jxr_linenumber" name="L1604" href="#L1604">1604</a>       + <span class="jxr_string">"Some events may have been updated successfully. "</span>
<a class="jxr_linenumber" name="L1605" href="#L1605">1605</a>       + <span class="jxr_string">"Details are available in the response body."</span>,
<a class="jxr_linenumber" name="L1606" href="#L1606">1606</a>       responseCode = HttpServletResponse.SC_INTERNAL_SERVER_ERROR)},
<a class="jxr_linenumber" name="L1607" href="#L1607">1607</a>     returnDescription = <span class="jxr_string">"In case of complete success, no content is returned. Otherwise, the response content "</span>
<a class="jxr_linenumber" name="L1608" href="#L1608">1608</a>       + <span class="jxr_string">"contains the ids of events that couldn't be found and the ids and errors of events where the update failed "</span>
<a class="jxr_linenumber" name="L1609" href="#L1609">1609</a>       + <span class="jxr_string">"as well as the ids of the events that were updated successfully."</span>)
<a class="jxr_linenumber" name="L1610" href="#L1610">1610</a>   <strong class="jxr_keyword">public</strong> Response updateEventsMetadata(@FormParam(<span class="jxr_string">"eventIds"</span>) String eventIds, @FormParam(<span class="jxr_string">"metadata"</span>) String metadata)
<a class="jxr_linenumber" name="L1611" href="#L1611">1611</a>     <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1612" href="#L1612">1612</a> 
<a class="jxr_linenumber" name="L1613" href="#L1613">1613</a>     <strong class="jxr_keyword">if</strong> (StringUtils.isBlank(eventIds)) {
<a class="jxr_linenumber" name="L1614" href="#L1614">1614</a>       <strong class="jxr_keyword">return</strong> badRequest(<span class="jxr_string">"Event ids can't be empty"</span>);
<a class="jxr_linenumber" name="L1615" href="#L1615">1615</a>     }
<a class="jxr_linenumber" name="L1616" href="#L1616">1616</a> 
<a class="jxr_linenumber" name="L1617" href="#L1617">1617</a>     JSONParser parser = <strong class="jxr_keyword">new</strong> JSONParser();
<a class="jxr_linenumber" name="L1618" href="#L1618">1618</a>     List&lt;String&gt; ids;
<a class="jxr_linenumber" name="L1619" href="#L1619">1619</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1620" href="#L1620">1620</a>       ids = (List&lt;String&gt;) parser.parse(eventIds);
<a class="jxr_linenumber" name="L1621" href="#L1621">1621</a>     } <strong class="jxr_keyword">catch</strong> (org.json.simple.parser.ParseException e) {
<a class="jxr_linenumber" name="L1622" href="#L1622">1622</a>       logger.error(<span class="jxr_string">"Unable to parse '{}'"</span>, eventIds, e);
<a class="jxr_linenumber" name="L1623" href="#L1623">1623</a>       <strong class="jxr_keyword">return</strong> badRequest(<span class="jxr_string">"Unable to parse event ids"</span>);
<a class="jxr_linenumber" name="L1624" href="#L1624">1624</a>     } <strong class="jxr_keyword">catch</strong> (ClassCastException e) {
<a class="jxr_linenumber" name="L1625" href="#L1625">1625</a>       logger.error(<span class="jxr_string">"Unable to cast '{}'"</span>, eventIds, e);
<a class="jxr_linenumber" name="L1626" href="#L1626">1626</a>       <strong class="jxr_keyword">return</strong> badRequest(<span class="jxr_string">"Unable to parse event ids"</span>);
<a class="jxr_linenumber" name="L1627" href="#L1627">1627</a>     }
<a class="jxr_linenumber" name="L1628" href="#L1628">1628</a> 
<a class="jxr_linenumber" name="L1629" href="#L1629">1629</a>     <em class="jxr_comment">// try to update each event</em>
<a class="jxr_linenumber" name="L1630" href="#L1630">1630</a>     Set&lt;String&gt; eventsNotFound = <strong class="jxr_keyword">new</strong> HashSet&lt;&gt;();
<a class="jxr_linenumber" name="L1631" href="#L1631">1631</a>     Set&lt;String&gt; eventsUpdated = <strong class="jxr_keyword">new</strong> HashSet&lt;&gt;();
<a class="jxr_linenumber" name="L1632" href="#L1632">1632</a>     Set&lt;String&gt; eventsUpdateFailure = <strong class="jxr_keyword">new</strong> HashSet();
<a class="jxr_linenumber" name="L1633" href="#L1633">1633</a> 
<a class="jxr_linenumber" name="L1634" href="#L1634">1634</a>     <strong class="jxr_keyword">for</strong> (String eventId : ids) {
<a class="jxr_linenumber" name="L1635" href="#L1635">1635</a>       Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L1636" href="#L1636">1636</a>       <em class="jxr_comment">// not found?</em>
<a class="jxr_linenumber" name="L1637" href="#L1637">1637</a> 
<a class="jxr_linenumber" name="L1638" href="#L1638">1638</a>       <strong class="jxr_keyword">if</strong> (optEvent.isNone()) {
<a class="jxr_linenumber" name="L1639" href="#L1639">1639</a>         eventsNotFound.add(eventId);
<a class="jxr_linenumber" name="L1640" href="#L1640">1640</a>         <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="L1641" href="#L1641">1641</a>       }
<a class="jxr_linenumber" name="L1642" href="#L1642">1642</a> 
<a class="jxr_linenumber" name="L1643" href="#L1643">1643</a>       <em class="jxr_comment">// update</em>
<a class="jxr_linenumber" name="L1644" href="#L1644">1644</a>       <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1645" href="#L1645">1645</a>         getIndexService().updateAllEventMetadata(eventId, metadata, getIndex());
<a class="jxr_linenumber" name="L1646" href="#L1646">1646</a>         eventsUpdated.add(eventId);
<a class="jxr_linenumber" name="L1647" href="#L1647">1647</a>       } <strong class="jxr_keyword">catch</strong> (IllegalArgumentException e) {
<a class="jxr_linenumber" name="L1648" href="#L1648">1648</a>         eventsUpdateFailure.add(eventId);
<a class="jxr_linenumber" name="L1649" href="#L1649">1649</a>       }
<a class="jxr_linenumber" name="L1650" href="#L1650">1650</a>     }
<a class="jxr_linenumber" name="L1651" href="#L1651">1651</a> 
<a class="jxr_linenumber" name="L1652" href="#L1652">1652</a>     <em class="jxr_comment">// errors occurred?</em>
<a class="jxr_linenumber" name="L1653" href="#L1653">1653</a>     <strong class="jxr_keyword">if</strong> (!eventsNotFound.isEmpty() || !eventsUpdateFailure.isEmpty()) {
<a class="jxr_linenumber" name="L1654" href="#L1654">1654</a>       <strong class="jxr_keyword">return</strong> serverErrorJson(obj(
<a class="jxr_linenumber" name="L1655" href="#L1655">1655</a>         f(<span class="jxr_string">"updateFailures"</span>, JSONUtils.setToJSON(eventsUpdateFailure)),
<a class="jxr_linenumber" name="L1656" href="#L1656">1656</a>         f(<span class="jxr_string">"notFound"</span>, JSONUtils.setToJSON(eventsNotFound)),
<a class="jxr_linenumber" name="L1657" href="#L1657">1657</a>         f(<span class="jxr_string">"updated"</span>, JSONUtils.setToJSON(eventsUpdated))
<a class="jxr_linenumber" name="L1658" href="#L1658">1658</a>       ));
<a class="jxr_linenumber" name="L1659" href="#L1659">1659</a>     }
<a class="jxr_linenumber" name="L1660" href="#L1660">1660</a> 
<a class="jxr_linenumber" name="L1661" href="#L1661">1661</a>     <strong class="jxr_keyword">return</strong> noContent();
<a class="jxr_linenumber" name="L1662" href="#L1662">1662</a>   }
<a class="jxr_linenumber" name="L1663" href="#L1663">1663</a> 
<a class="jxr_linenumber" name="L1664" href="#L1664">1664</a>   @GET
<a class="jxr_linenumber" name="L1665" href="#L1665">1665</a>   @Path(<span class="jxr_string">"{eventId}/asset/assets.json"</span>)
<a class="jxr_linenumber" name="L1666" href="#L1666">1666</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L1667" href="#L1667">1667</a>   @RestQuery(name = <span class="jxr_string">"getAssetList"</span>, description = <span class="jxr_string">"Returns the number of assets from each types as JSON"</span>, returnDescription = <span class="jxr_string">"The number of assets from each types as JSON"</span>, pathParameters = { @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L1668" href="#L1668">1668</a>           @RestResponse(description = <span class="jxr_string">"Returns the number of assets from each types as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L1669" href="#L1669">1669</a>           @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L1670" href="#L1670">1670</a>   <strong class="jxr_keyword">public</strong> Response getAssetList(@PathParam(<span class="jxr_string">"eventId"</span>) String id) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1671" href="#L1671">1671</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(id, getIndex());
<a class="jxr_linenumber" name="L1672" href="#L1672">1672</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L1673" href="#L1673">1673</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, id);
<a class="jxr_linenumber" name="L1674" href="#L1674">1674</a>     MediaPackage mp;
<a class="jxr_linenumber" name="L1675" href="#L1675">1675</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1676" href="#L1676">1676</a>       mp = getIndexService().getEventMediapackage(optEvent.get());
<a class="jxr_linenumber" name="L1677" href="#L1677">1677</a>     } <strong class="jxr_keyword">catch</strong> (IndexServiceException e) {
<a class="jxr_linenumber" name="L1678" href="#L1678">1678</a>       <strong class="jxr_keyword">if</strong> (e.getCause() instanceof NotFoundException) {
<a class="jxr_linenumber" name="L1679" href="#L1679">1679</a>         <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find data for event %s"</span>, id);
<a class="jxr_linenumber" name="L1680" href="#L1680">1680</a>       } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (e.getCause() instanceof UnauthorizedException) {
<a class="jxr_linenumber" name="L1681" href="#L1681">1681</a>         <strong class="jxr_keyword">return</strong> Response.status(Status.FORBIDDEN).entity(<span class="jxr_string">"Not authorized to access "</span> + id).build();
<a class="jxr_linenumber" name="L1682" href="#L1682">1682</a>       }
<a class="jxr_linenumber" name="L1683" href="#L1683">1683</a>       logger.error(<span class="jxr_string">"Internal error when trying to access metadata for "</span> + id, e);
<a class="jxr_linenumber" name="L1684" href="#L1684">1684</a>       <strong class="jxr_keyword">return</strong> serverError();
<a class="jxr_linenumber" name="L1685" href="#L1685">1685</a>     }
<a class="jxr_linenumber" name="L1686" href="#L1686">1686</a>     <strong class="jxr_keyword">int</strong> attachments = mp.getAttachments().length;
<a class="jxr_linenumber" name="L1687" href="#L1687">1687</a>     <strong class="jxr_keyword">int</strong> catalogs = mp.getCatalogs().length;
<a class="jxr_linenumber" name="L1688" href="#L1688">1688</a>     <strong class="jxr_keyword">int</strong> media = mp.getTracks().length;
<a class="jxr_linenumber" name="L1689" href="#L1689">1689</a>     <strong class="jxr_keyword">int</strong> publications = mp.getPublications().length;
<a class="jxr_linenumber" name="L1690" href="#L1690">1690</a>     <strong class="jxr_keyword">return</strong> okJson(obj(f(<span class="jxr_string">"attachments"</span>, v(attachments)), f(<span class="jxr_string">"catalogs"</span>, v(catalogs)), f(<span class="jxr_string">"media"</span>, v(media)),
<a class="jxr_linenumber" name="L1691" href="#L1691">1691</a>             f(<span class="jxr_string">"publications"</span>, v(publications))));
<a class="jxr_linenumber" name="L1692" href="#L1692">1692</a>   }
<a class="jxr_linenumber" name="L1693" href="#L1693">1693</a> 
<a class="jxr_linenumber" name="L1694" href="#L1694">1694</a>   @GET
<a class="jxr_linenumber" name="L1695" href="#L1695">1695</a>   @Path(<span class="jxr_string">"{eventId}/asset/attachment/attachments.json"</span>)
<a class="jxr_linenumber" name="L1696" href="#L1696">1696</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L1697" href="#L1697">1697</a>   @RestQuery(name = <span class="jxr_string">"getAttachmentsList"</span>, description = <span class="jxr_string">"Returns a list of attachments from the given event as JSON"</span>, returnDescription = <span class="jxr_string">"The list of attachments from the given event as JSON"</span>, pathParameters = { @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L1698" href="#L1698">1698</a>           @RestResponse(description = <span class="jxr_string">"Returns a list of attachments from the given event as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L1699" href="#L1699">1699</a>           @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L1700" href="#L1700">1700</a>   <strong class="jxr_keyword">public</strong> Response getAttachmentsList(@PathParam(<span class="jxr_string">"eventId"</span>) String id) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1701" href="#L1701">1701</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(id, getIndex());
<a class="jxr_linenumber" name="L1702" href="#L1702">1702</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L1703" href="#L1703">1703</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, id);
<a class="jxr_linenumber" name="L1704" href="#L1704">1704</a>     MediaPackage mp = getIndexService().getEventMediapackage(optEvent.get());
<a class="jxr_linenumber" name="L1705" href="#L1705">1705</a>     <strong class="jxr_keyword">return</strong> okJson(arr(getEventMediaPackageElements(mp.getAttachments())));
<a class="jxr_linenumber" name="L1706" href="#L1706">1706</a>   }
<a class="jxr_linenumber" name="L1707" href="#L1707">1707</a> 
<a class="jxr_linenumber" name="L1708" href="#L1708">1708</a>   @GET
<a class="jxr_linenumber" name="L1709" href="#L1709">1709</a>   @Path(<span class="jxr_string">"{eventId}/asset/attachment/{id}.json"</span>)
<a class="jxr_linenumber" name="L1710" href="#L1710">1710</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L1711" href="#L1711">1711</a>   @RestQuery(name = <span class="jxr_string">"getAttachment"</span>, description = <span class="jxr_string">"Returns the details of an attachment from the given event and attachment id as JSON"</span>, returnDescription = <span class="jxr_string">"The details of an attachment from the given event and attachment id as JSON"</span>, pathParameters = {
<a class="jxr_linenumber" name="L1712" href="#L1712">1712</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L1713" href="#L1713">1713</a>           @RestParameter(name = <span class="jxr_string">"id"</span>, description = <span class="jxr_string">"The attachment id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L1714" href="#L1714">1714</a>           @RestResponse(description = <span class="jxr_string">"Returns the details of an attachment from the given event and attachment id as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L1715" href="#L1715">1715</a>           @RestResponse(description = <span class="jxr_string">"No event or attachment with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L1716" href="#L1716">1716</a>   <strong class="jxr_keyword">public</strong> Response getAttachment(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId, @PathParam(<span class="jxr_string">"id"</span>) String id)
<a class="jxr_linenumber" name="L1717" href="#L1717">1717</a>           <strong class="jxr_keyword">throws</strong> NotFoundException, SearchIndexException, IndexServiceException {
<a class="jxr_linenumber" name="L1718" href="#L1718">1718</a>     MediaPackage mp = getMediaPackageByEventId(eventId);
<a class="jxr_linenumber" name="L1719" href="#L1719">1719</a> 
<a class="jxr_linenumber" name="L1720" href="#L1720">1720</a>     Attachment attachment = mp.getAttachment(id);
<a class="jxr_linenumber" name="L1721" href="#L1721">1721</a>     <strong class="jxr_keyword">if</strong> (attachment == <strong class="jxr_keyword">null</strong>)
<a class="jxr_linenumber" name="L1722" href="#L1722">1722</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an attachment with id '%s'."</span>, id);
<a class="jxr_linenumber" name="L1723" href="#L1723">1723</a>     <strong class="jxr_keyword">return</strong> okJson(attachmentToJSON(attachment));
<a class="jxr_linenumber" name="L1724" href="#L1724">1724</a>   }
<a class="jxr_linenumber" name="L1725" href="#L1725">1725</a> 
<a class="jxr_linenumber" name="L1726" href="#L1726">1726</a>   @GET
<a class="jxr_linenumber" name="L1727" href="#L1727">1727</a>   @Path(<span class="jxr_string">"{eventId}/asset/catalog/catalogs.json"</span>)
<a class="jxr_linenumber" name="L1728" href="#L1728">1728</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L1729" href="#L1729">1729</a>   @RestQuery(name = <span class="jxr_string">"getCatalogList"</span>, description = <span class="jxr_string">"Returns a list of catalogs from the given event as JSON"</span>, returnDescription = <span class="jxr_string">"The list of catalogs from the given event as JSON"</span>, pathParameters = { @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L1730" href="#L1730">1730</a>           @RestResponse(description = <span class="jxr_string">"Returns a list of catalogs from the given event as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L1731" href="#L1731">1731</a>           @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L1732" href="#L1732">1732</a>   <strong class="jxr_keyword">public</strong> Response getCatalogList(@PathParam(<span class="jxr_string">"eventId"</span>) String id) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1733" href="#L1733">1733</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(id, getIndex());
<a class="jxr_linenumber" name="L1734" href="#L1734">1734</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L1735" href="#L1735">1735</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, id);
<a class="jxr_linenumber" name="L1736" href="#L1736">1736</a>     MediaPackage mp = getIndexService().getEventMediapackage(optEvent.get());
<a class="jxr_linenumber" name="L1737" href="#L1737">1737</a>     <strong class="jxr_keyword">return</strong> okJson(arr(getEventMediaPackageElements(mp.getCatalogs())));
<a class="jxr_linenumber" name="L1738" href="#L1738">1738</a>   }
<a class="jxr_linenumber" name="L1739" href="#L1739">1739</a> 
<a class="jxr_linenumber" name="L1740" href="#L1740">1740</a>   @GET
<a class="jxr_linenumber" name="L1741" href="#L1741">1741</a>   @Path(<span class="jxr_string">"{eventId}/asset/catalog/{id}.json"</span>)
<a class="jxr_linenumber" name="L1742" href="#L1742">1742</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L1743" href="#L1743">1743</a>   @RestQuery(name = <span class="jxr_string">"getCatalog"</span>, description = <span class="jxr_string">"Returns the details of a catalog from the given event and catalog id as JSON"</span>, returnDescription = <span class="jxr_string">"The details of a catalog from the given event and catalog id as JSON"</span>, pathParameters = {
<a class="jxr_linenumber" name="L1744" href="#L1744">1744</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L1745" href="#L1745">1745</a>           @RestParameter(name = <span class="jxr_string">"id"</span>, description = <span class="jxr_string">"The catalog id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L1746" href="#L1746">1746</a>           @RestResponse(description = <span class="jxr_string">"Returns the details of a catalog from the given event and catalog id as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L1747" href="#L1747">1747</a>           @RestResponse(description = <span class="jxr_string">"No event or catalog with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L1748" href="#L1748">1748</a>   <strong class="jxr_keyword">public</strong> Response getCatalog(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId, @PathParam(<span class="jxr_string">"id"</span>) String id)
<a class="jxr_linenumber" name="L1749" href="#L1749">1749</a>           <strong class="jxr_keyword">throws</strong> NotFoundException, SearchIndexException, IndexServiceException {
<a class="jxr_linenumber" name="L1750" href="#L1750">1750</a>     MediaPackage mp = getMediaPackageByEventId(eventId);
<a class="jxr_linenumber" name="L1751" href="#L1751">1751</a> 
<a class="jxr_linenumber" name="L1752" href="#L1752">1752</a>     Catalog catalog = mp.getCatalog(id);
<a class="jxr_linenumber" name="L1753" href="#L1753">1753</a>     <strong class="jxr_keyword">if</strong> (catalog == <strong class="jxr_keyword">null</strong>)
<a class="jxr_linenumber" name="L1754" href="#L1754">1754</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find a catalog with id '%s'."</span>, id);
<a class="jxr_linenumber" name="L1755" href="#L1755">1755</a>     <strong class="jxr_keyword">return</strong> okJson(catalogToJSON(catalog));
<a class="jxr_linenumber" name="L1756" href="#L1756">1756</a>   }
<a class="jxr_linenumber" name="L1757" href="#L1757">1757</a> 
<a class="jxr_linenumber" name="L1758" href="#L1758">1758</a>   @GET
<a class="jxr_linenumber" name="L1759" href="#L1759">1759</a>   @Path(<span class="jxr_string">"{eventId}/asset/media/media.json"</span>)
<a class="jxr_linenumber" name="L1760" href="#L1760">1760</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L1761" href="#L1761">1761</a>   @RestQuery(name = <span class="jxr_string">"getMediaList"</span>, description = <span class="jxr_string">"Returns a list of media from the given event as JSON"</span>, returnDescription = <span class="jxr_string">"The list of media from the given event as JSON"</span>, pathParameters = { @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L1762" href="#L1762">1762</a>           @RestResponse(description = <span class="jxr_string">"Returns a list of media from the given event as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L1763" href="#L1763">1763</a>           @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L1764" href="#L1764">1764</a>   <strong class="jxr_keyword">public</strong> Response getMediaList(@PathParam(<span class="jxr_string">"eventId"</span>) String id) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1765" href="#L1765">1765</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(id, getIndex());
<a class="jxr_linenumber" name="L1766" href="#L1766">1766</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L1767" href="#L1767">1767</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, id);
<a class="jxr_linenumber" name="L1768" href="#L1768">1768</a>     MediaPackage mp = getIndexService().getEventMediapackage(optEvent.get());
<a class="jxr_linenumber" name="L1769" href="#L1769">1769</a>     <strong class="jxr_keyword">return</strong> okJson(arr(getEventMediaPackageElements(mp.getTracks())));
<a class="jxr_linenumber" name="L1770" href="#L1770">1770</a>   }
<a class="jxr_linenumber" name="L1771" href="#L1771">1771</a> 
<a class="jxr_linenumber" name="L1772" href="#L1772">1772</a>   @GET
<a class="jxr_linenumber" name="L1773" href="#L1773">1773</a>   @Path(<span class="jxr_string">"{eventId}/asset/media/{id}.json"</span>)
<a class="jxr_linenumber" name="L1774" href="#L1774">1774</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L1775" href="#L1775">1775</a>   @RestQuery(name = <span class="jxr_string">"getMedia"</span>, description = <span class="jxr_string">"Returns the details of a media from the given event and media id as JSON"</span>, returnDescription = <span class="jxr_string">"The details of a media from the given event and media id as JSON"</span>, pathParameters = {
<a class="jxr_linenumber" name="L1776" href="#L1776">1776</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L1777" href="#L1777">1777</a>           @RestParameter(name = <span class="jxr_string">"id"</span>, description = <span class="jxr_string">"The media id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L1778" href="#L1778">1778</a>                   @RestResponse(description = <span class="jxr_string">"Returns the media of a catalog from the given event and media id as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L1779" href="#L1779">1779</a>                   @RestResponse(description = <span class="jxr_string">"No event or media with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L1780" href="#L1780">1780</a>   <strong class="jxr_keyword">public</strong> Response getMedia(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId, @PathParam(<span class="jxr_string">"id"</span>) String id)
<a class="jxr_linenumber" name="L1781" href="#L1781">1781</a>           <strong class="jxr_keyword">throws</strong> NotFoundException, SearchIndexException, IndexServiceException {
<a class="jxr_linenumber" name="L1782" href="#L1782">1782</a>     MediaPackage mp = getMediaPackageByEventId(eventId);
<a class="jxr_linenumber" name="L1783" href="#L1783">1783</a> 
<a class="jxr_linenumber" name="L1784" href="#L1784">1784</a>     Track track = mp.getTrack(id);
<a class="jxr_linenumber" name="L1785" href="#L1785">1785</a>     <strong class="jxr_keyword">if</strong> (track == <strong class="jxr_keyword">null</strong>)
<a class="jxr_linenumber" name="L1786" href="#L1786">1786</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find media with id '%s'."</span>, id);
<a class="jxr_linenumber" name="L1787" href="#L1787">1787</a>     <strong class="jxr_keyword">return</strong> okJson(trackToJSON(track));
<a class="jxr_linenumber" name="L1788" href="#L1788">1788</a>   }
<a class="jxr_linenumber" name="L1789" href="#L1789">1789</a> 
<a class="jxr_linenumber" name="L1790" href="#L1790">1790</a>   @GET
<a class="jxr_linenumber" name="L1791" href="#L1791">1791</a>   @Path(<span class="jxr_string">"{eventId}/asset/publication/publications.json"</span>)
<a class="jxr_linenumber" name="L1792" href="#L1792">1792</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L1793" href="#L1793">1793</a>   @RestQuery(name = <span class="jxr_string">"getPublicationList"</span>, description = <span class="jxr_string">"Returns a list of publications from the given event as JSON"</span>, returnDescription = <span class="jxr_string">"The list of publications from the given event as JSON"</span>, pathParameters = { @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L1794" href="#L1794">1794</a>           @RestResponse(description = <span class="jxr_string">"Returns a list of publications from the given event as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L1795" href="#L1795">1795</a>           @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L1796" href="#L1796">1796</a>   <strong class="jxr_keyword">public</strong> Response getPublicationList(@PathParam(<span class="jxr_string">"eventId"</span>) String id) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L1797" href="#L1797">1797</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(id, getIndex());
<a class="jxr_linenumber" name="L1798" href="#L1798">1798</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L1799" href="#L1799">1799</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, id);
<a class="jxr_linenumber" name="L1800" href="#L1800">1800</a>     MediaPackage mp = getIndexService().getEventMediapackage(optEvent.get());
<a class="jxr_linenumber" name="L1801" href="#L1801">1801</a>     <strong class="jxr_keyword">return</strong> okJson(arr(getEventPublications(mp.getPublications())));
<a class="jxr_linenumber" name="L1802" href="#L1802">1802</a>   }
<a class="jxr_linenumber" name="L1803" href="#L1803">1803</a> 
<a class="jxr_linenumber" name="L1804" href="#L1804">1804</a>   @GET
<a class="jxr_linenumber" name="L1805" href="#L1805">1805</a>   @Path(<span class="jxr_string">"{eventId}/asset/publication/{id}.json"</span>)
<a class="jxr_linenumber" name="L1806" href="#L1806">1806</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L1807" href="#L1807">1807</a>   @RestQuery(name = <span class="jxr_string">"getPublication"</span>, description = <span class="jxr_string">"Returns the details of a publication from the given event and publication id as JSON"</span>, returnDescription = <span class="jxr_string">"The details of a publication from the given event and publication id as JSON"</span>, pathParameters = {
<a class="jxr_linenumber" name="L1808" href="#L1808">1808</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L1809" href="#L1809">1809</a>           @RestParameter(name = <span class="jxr_string">"id"</span>, description = <span class="jxr_string">"The publication id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L1810" href="#L1810">1810</a>           @RestResponse(description = <span class="jxr_string">"Returns the publication of a catalog from the given event and publication id as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L1811" href="#L1811">1811</a>           @RestResponse(description = <span class="jxr_string">"No event or publication with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L1812" href="#L1812">1812</a>   <strong class="jxr_keyword">public</strong> Response getPublication(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId, @PathParam(<span class="jxr_string">"id"</span>) String id)
<a class="jxr_linenumber" name="L1813" href="#L1813">1813</a>           <strong class="jxr_keyword">throws</strong> NotFoundException, SearchIndexException, IndexServiceException {
<a class="jxr_linenumber" name="L1814" href="#L1814">1814</a>     MediaPackage mp = getMediaPackageByEventId(eventId);
<a class="jxr_linenumber" name="L1815" href="#L1815">1815</a> 
<a class="jxr_linenumber" name="L1816" href="#L1816">1816</a>     Publication publication = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1817" href="#L1817">1817</a>     <strong class="jxr_keyword">for</strong> (Publication p : mp.getPublications()) {
<a class="jxr_linenumber" name="L1818" href="#L1818">1818</a>       <strong class="jxr_keyword">if</strong> (id.equals(p.getIdentifier())) {
<a class="jxr_linenumber" name="L1819" href="#L1819">1819</a>         publication = p;
<a class="jxr_linenumber" name="L1820" href="#L1820">1820</a>         <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L1821" href="#L1821">1821</a>       }
<a class="jxr_linenumber" name="L1822" href="#L1822">1822</a>     }
<a class="jxr_linenumber" name="L1823" href="#L1823">1823</a> 
<a class="jxr_linenumber" name="L1824" href="#L1824">1824</a>     <strong class="jxr_keyword">if</strong> (publication == <strong class="jxr_keyword">null</strong>)
<a class="jxr_linenumber" name="L1825" href="#L1825">1825</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find publication with id '%s'."</span>, id);
<a class="jxr_linenumber" name="L1826" href="#L1826">1826</a>     <strong class="jxr_keyword">return</strong> okJson(publicationToJSON(publication));
<a class="jxr_linenumber" name="L1827" href="#L1827">1827</a>   }
<a class="jxr_linenumber" name="L1828" href="#L1828">1828</a> 
<a class="jxr_linenumber" name="L1829" href="#L1829">1829</a>   @GET
<a class="jxr_linenumber" name="L1830" href="#L1830">1830</a>   @Path(<span class="jxr_string">"{eventId}/tobira/pages"</span>)
<a class="jxr_linenumber" name="L1831" href="#L1831">1831</a>   @RestQuery(
<a class="jxr_linenumber" name="L1832" href="#L1832">1832</a>           name = <span class="jxr_string">"getEventHostPages"</span>,
<a class="jxr_linenumber" name="L1833" href="#L1833">1833</a>           description = <span class="jxr_string">"Returns the pages of a connected Tobira instance that contain the given event"</span>,
<a class="jxr_linenumber" name="L1834" href="#L1834">1834</a>           returnDescription = <span class="jxr_string">"The Tobira pages that contain the given event"</span>,
<a class="jxr_linenumber" name="L1835" href="#L1835">1835</a>           pathParameters = {
<a class="jxr_linenumber" name="L1836" href="#L1836">1836</a>                   @RestParameter(
<a class="jxr_linenumber" name="L1837" href="#L1837">1837</a>                           name = <span class="jxr_string">"eventId"</span>,
<a class="jxr_linenumber" name="L1838" href="#L1838">1838</a>                           isRequired = <strong class="jxr_keyword">true</strong>,
<a class="jxr_linenumber" name="L1839" href="#L1839">1839</a>                           description = <span class="jxr_string">"The event identifier"</span>,
<a class="jxr_linenumber" name="L1840" href="#L1840">1840</a>                           type = STRING
<a class="jxr_linenumber" name="L1841" href="#L1841">1841</a>                   ),
<a class="jxr_linenumber" name="L1842" href="#L1842">1842</a>           },
<a class="jxr_linenumber" name="L1843" href="#L1843">1843</a>           responses = {
<a class="jxr_linenumber" name="L1844" href="#L1844">1844</a>                   @RestResponse(
<a class="jxr_linenumber" name="L1845" href="#L1845">1845</a>                           responseCode = SC_OK,
<a class="jxr_linenumber" name="L1846" href="#L1846">1846</a>                           description = <span class="jxr_string">"The Tobira pages containing the given event"</span>
<a class="jxr_linenumber" name="L1847" href="#L1847">1847</a>                   ),
<a class="jxr_linenumber" name="L1848" href="#L1848">1848</a>                   @RestResponse(
<a class="jxr_linenumber" name="L1849" href="#L1849">1849</a>                           responseCode = SC_NOT_FOUND,
<a class="jxr_linenumber" name="L1850" href="#L1850">1850</a>                           description = <span class="jxr_string">"Tobira doesn't know about the given event"</span>
<a class="jxr_linenumber" name="L1851" href="#L1851">1851</a>                   ),
<a class="jxr_linenumber" name="L1852" href="#L1852">1852</a>                   @RestResponse(
<a class="jxr_linenumber" name="L1853" href="#L1853">1853</a>                           responseCode = SC_SERVICE_UNAVAILABLE,
<a class="jxr_linenumber" name="L1854" href="#L1854">1854</a>                           description = <span class="jxr_string">"Tobira is not configured (correctly)"</span>
<a class="jxr_linenumber" name="L1855" href="#L1855">1855</a>                   ),
<a class="jxr_linenumber" name="L1856" href="#L1856">1856</a>           }
<a class="jxr_linenumber" name="L1857" href="#L1857">1857</a>   )
<a class="jxr_linenumber" name="L1858" href="#L1858">1858</a>   <strong class="jxr_keyword">public</strong> Response getEventHostPages(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId) {
<a class="jxr_linenumber" name="L1859" href="#L1859">1859</a>     <strong class="jxr_keyword">var</strong> tobira = TobiraService.getTobira(getSecurityService().getOrganization().getId());
<a class="jxr_linenumber" name="L1860" href="#L1860">1860</a>     <strong class="jxr_keyword">if</strong> (!tobira.ready()) {
<a class="jxr_linenumber" name="L1861" href="#L1861">1861</a>       <strong class="jxr_keyword">return</strong> Response.status(Status.SERVICE_UNAVAILABLE)
<a class="jxr_linenumber" name="L1862" href="#L1862">1862</a>               .entity(<span class="jxr_string">"Tobira is not configured (correctly)"</span>)
<a class="jxr_linenumber" name="L1863" href="#L1863">1863</a>               .build();
<a class="jxr_linenumber" name="L1864" href="#L1864">1864</a>     }
<a class="jxr_linenumber" name="L1865" href="#L1865">1865</a> 
<a class="jxr_linenumber" name="L1866" href="#L1866">1866</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1867" href="#L1867">1867</a>       <strong class="jxr_keyword">var</strong> eventData = tobira.getEventHostPages(eventId);
<a class="jxr_linenumber" name="L1868" href="#L1868">1868</a>       <strong class="jxr_keyword">if</strong> (eventData == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1869" href="#L1869">1869</a>         <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> WebApplicationException(NOT_FOUND);
<a class="jxr_linenumber" name="L1870" href="#L1870">1870</a>       }
<a class="jxr_linenumber" name="L1871" href="#L1871">1871</a>       eventData.put(<span class="jxr_string">"baseURL"</span>, tobira.getOrigin());
<a class="jxr_linenumber" name="L1872" href="#L1872">1872</a>       <strong class="jxr_keyword">return</strong> Response.ok(eventData.toJSONString()).build();
<a class="jxr_linenumber" name="L1873" href="#L1873">1873</a>     } <strong class="jxr_keyword">catch</strong> (<a name="TobiraException" href="../../../../org/opencastproject/adminui/tobira/TobiraException.html#TobiraException">TobiraException</a> e) {
<a class="jxr_linenumber" name="L1874" href="#L1874">1874</a>       <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> WebApplicationException(e, Status.INTERNAL_SERVER_ERROR);
<a class="jxr_linenumber" name="L1875" href="#L1875">1875</a>     }
<a class="jxr_linenumber" name="L1876" href="#L1876">1876</a>   }
<a class="jxr_linenumber" name="L1877" href="#L1877">1877</a> 
<a class="jxr_linenumber" name="L1878" href="#L1878">1878</a>   @GET
<a class="jxr_linenumber" name="L1879" href="#L1879">1879</a>   @Path(<span class="jxr_string">"{eventId}/workflows.json"</span>)
<a class="jxr_linenumber" name="L1880" href="#L1880">1880</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L1881" href="#L1881">1881</a>   @RestQuery(name = <span class="jxr_string">"geteventworkflows"</span>, description = <span class="jxr_string">"Returns all the data related to the workflows tab in the event details modal as JSON"</span>, returnDescription = <span class="jxr_string">"All the data related to the event workflows tab as JSON"</span>, pathParameters = {
<a class="jxr_linenumber" name="L1882" href="#L1882">1882</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L1883" href="#L1883">1883</a>                   @RestResponse(description = <span class="jxr_string">"Returns all the data related to the event workflows tab as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L1884" href="#L1884">1884</a>                   @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L1885" href="#L1885">1885</a>   <strong class="jxr_keyword">public</strong> Response getEventWorkflows(@PathParam(<span class="jxr_string">"eventId"</span>) String id)
<a class="jxr_linenumber" name="L1886" href="#L1886">1886</a>           <strong class="jxr_keyword">throws</strong> UnauthorizedException, SearchIndexException, <a name="JobEndpointException" href="../../../../org/opencastproject/adminui/exception/JobEndpointException.html#JobEndpointException">JobEndpointException</a> {
<a class="jxr_linenumber" name="L1887" href="#L1887">1887</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(id, getIndex());
<a class="jxr_linenumber" name="L1888" href="#L1888">1888</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L1889" href="#L1889">1889</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, id);
<a class="jxr_linenumber" name="L1890" href="#L1890">1890</a> 
<a class="jxr_linenumber" name="L1891" href="#L1891">1891</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1892" href="#L1892">1892</a>       <strong class="jxr_keyword">if</strong> (optEvent.get().getEventStatus().equals(<span class="jxr_string">"EVENTS.EVENTS.STATUS.SCHEDULED"</span>)) {
<a class="jxr_linenumber" name="L1893" href="#L1893">1893</a>         List&lt;Field&gt; fields = <strong class="jxr_keyword">new</strong> ArrayList&lt;Field&gt;();
<a class="jxr_linenumber" name="L1894" href="#L1894">1894</a>         Map&lt;String, String&gt; workflowConfig = getSchedulerService().getWorkflowConfig(id);
<a class="jxr_linenumber" name="L1895" href="#L1895">1895</a>         <strong class="jxr_keyword">for</strong> (Entry&lt;String, String&gt; entry : workflowConfig.entrySet()) {
<a class="jxr_linenumber" name="L1896" href="#L1896">1896</a>           fields.add(f(entry.getKey(), v(entry.getValue(), Jsons.BLANK)));
<a class="jxr_linenumber" name="L1897" href="#L1897">1897</a>         }
<a class="jxr_linenumber" name="L1898" href="#L1898">1898</a> 
<a class="jxr_linenumber" name="L1899" href="#L1899">1899</a>         Map&lt;String, String&gt; agentConfiguration = getSchedulerService().getCaptureAgentConfiguration(id);
<a class="jxr_linenumber" name="L1900" href="#L1900">1900</a>         <strong class="jxr_keyword">return</strong> okJson(obj(f(<span class="jxr_string">"workflowId"</span>, v(agentConfiguration.get(CaptureParameters.INGEST_WORKFLOW_DEFINITION), Jsons.BLANK)),
<a class="jxr_linenumber" name="L1901" href="#L1901">1901</a>                 f(<span class="jxr_string">"configuration"</span>, obj(fields))));
<a class="jxr_linenumber" name="L1902" href="#L1902">1902</a>       } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L1903" href="#L1903">1903</a>         List&lt;WorkflowInstance&gt; workflowInstances = getWorkflowService().getWorkflowInstancesByMediaPackage(id);
<a class="jxr_linenumber" name="L1904" href="#L1904">1904</a>         List&lt;JValue&gt; jsonList = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L1905" href="#L1905">1905</a> 
<a class="jxr_linenumber" name="L1906" href="#L1906">1906</a>         <strong class="jxr_keyword">for</strong> (WorkflowInstance instance : workflowInstances) {
<a class="jxr_linenumber" name="L1907" href="#L1907">1907</a>           <strong class="jxr_keyword">long</strong> instanceId = instance.getId();
<a class="jxr_linenumber" name="L1908" href="#L1908">1908</a>           Date created = instance.getDateCreated();
<a class="jxr_linenumber" name="L1909" href="#L1909">1909</a>           String submitter = instance.getCreatorName();
<a class="jxr_linenumber" name="L1910" href="#L1910">1910</a> 
<a class="jxr_linenumber" name="L1911" href="#L1911">1911</a>           User user = submitter == <strong class="jxr_keyword">null</strong> ? <strong class="jxr_keyword">null</strong> : getUserDirectoryService().loadUser(submitter);
<a class="jxr_linenumber" name="L1912" href="#L1912">1912</a>           String submitterName = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1913" href="#L1913">1913</a>           String submitterEmail = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1914" href="#L1914">1914</a>           <strong class="jxr_keyword">if</strong> (user != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1915" href="#L1915">1915</a>             submitterName = user.getName();
<a class="jxr_linenumber" name="L1916" href="#L1916">1916</a>             submitterEmail = user.getEmail();
<a class="jxr_linenumber" name="L1917" href="#L1917">1917</a>           }
<a class="jxr_linenumber" name="L1918" href="#L1918">1918</a> 
<a class="jxr_linenumber" name="L1919" href="#L1919">1919</a>           jsonList.add(obj(f(<span class="jxr_string">"id"</span>, v(instanceId)), f(<span class="jxr_string">"title"</span>, v(instance.getTitle(), Jsons.BLANK)),
<a class="jxr_linenumber" name="L1920" href="#L1920">1920</a>                   f(<span class="jxr_string">"status"</span>, v(WORKFLOW_STATUS_TRANSLATION_PREFIX + instance.getState().toString())),
<a class="jxr_linenumber" name="L1921" href="#L1921">1921</a>                   f(<span class="jxr_string">"submitted"</span>, v(created != <strong class="jxr_keyword">null</strong> ? DateTimeSupport.toUTC(created.getTime()) : <span class="jxr_string">""</span>, Jsons.BLANK)),
<a class="jxr_linenumber" name="L1922" href="#L1922">1922</a>                   f(<span class="jxr_string">"submitter"</span>, v(submitter, Jsons.BLANK)),
<a class="jxr_linenumber" name="L1923" href="#L1923">1923</a>                   f(<span class="jxr_string">"submitterName"</span>, v(submitterName, Jsons.BLANK)),
<a class="jxr_linenumber" name="L1924" href="#L1924">1924</a>                   f(<span class="jxr_string">"submitterEmail"</span>, v(submitterEmail, Jsons.BLANK))));
<a class="jxr_linenumber" name="L1925" href="#L1925">1925</a>         }
<a class="jxr_linenumber" name="L1926" href="#L1926">1926</a>         JObject json = obj(f(<span class="jxr_string">"results"</span>, arr(jsonList)), f(<span class="jxr_string">"count"</span>, v(workflowInstances.size())));
<a class="jxr_linenumber" name="L1927" href="#L1927">1927</a>         <strong class="jxr_keyword">return</strong> okJson(json);
<a class="jxr_linenumber" name="L1928" href="#L1928">1928</a>       }
<a class="jxr_linenumber" name="L1929" href="#L1929">1929</a>     } <strong class="jxr_keyword">catch</strong> (NotFoundException e) {
<a class="jxr_linenumber" name="L1930" href="#L1930">1930</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find workflows for event %s"</span>, id);
<a class="jxr_linenumber" name="L1931" href="#L1931">1931</a>     } <strong class="jxr_keyword">catch</strong> (SchedulerException e) {
<a class="jxr_linenumber" name="L1932" href="#L1932">1932</a>       logger.error(<span class="jxr_string">"Unable to get workflow data for event with id {}"</span>, id);
<a class="jxr_linenumber" name="L1933" href="#L1933">1933</a>       <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> WebApplicationException(e, SC_INTERNAL_SERVER_ERROR);
<a class="jxr_linenumber" name="L1934" href="#L1934">1934</a>     } <strong class="jxr_keyword">catch</strong> (WorkflowDatabaseException e) {
<a class="jxr_linenumber" name="L1935" href="#L1935">1935</a>       <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> <a name="JobEndpointException" href="../../../../org/opencastproject/adminui/exception/JobEndpointException.html#JobEndpointException">JobEndpointException</a>(String.format(<span class="jxr_string">"Not able to get the list of job from the database: %s"</span>, e),
<a class="jxr_linenumber" name="L1936" href="#L1936">1936</a>               e.getCause());
<a class="jxr_linenumber" name="L1937" href="#L1937">1937</a>     }
<a class="jxr_linenumber" name="L1938" href="#L1938">1938</a>   }
<a class="jxr_linenumber" name="L1939" href="#L1939">1939</a> 
<a class="jxr_linenumber" name="L1940" href="#L1940">1940</a>   @PUT
<a class="jxr_linenumber" name="L1941" href="#L1941">1941</a>   @Path(<span class="jxr_string">"{eventId}/workflows"</span>)
<a class="jxr_linenumber" name="L1942" href="#L1942">1942</a>   @RestQuery(name = <span class="jxr_string">"updateEventWorkflow"</span>, description = <span class="jxr_string">"Update the workflow configuration for the scheduled event with the given id"</span>, pathParameters = {
<a class="jxr_linenumber" name="L1943" href="#L1943">1943</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, restParameters = {
<a class="jxr_linenumber" name="L1944" href="#L1944">1944</a>                   @RestParameter(name = <span class="jxr_string">"configuration"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The workflow configuration as JSON"</span>, type = RestParameter.Type.TEXT) }, responses = {
<a class="jxr_linenumber" name="L1945" href="#L1945">1945</a>                           @RestResponse(description = <span class="jxr_string">"Request executed succesfully"</span>, responseCode = HttpServletResponse.SC_NO_CONTENT),
<a class="jxr_linenumber" name="L1946" href="#L1946">1946</a>                           @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) }, returnDescription = <span class="jxr_string">"The method does not retrun any content."</span>)
<a class="jxr_linenumber" name="L1947" href="#L1947">1947</a>   <strong class="jxr_keyword">public</strong> Response updateEventWorkflow(@PathParam(<span class="jxr_string">"eventId"</span>) String id, @FormParam(<span class="jxr_string">"configuration"</span>) String configuration)
<a class="jxr_linenumber" name="L1948" href="#L1948">1948</a>           <strong class="jxr_keyword">throws</strong> SearchIndexException, UnauthorizedException {
<a class="jxr_linenumber" name="L1949" href="#L1949">1949</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(id, getIndex());
<a class="jxr_linenumber" name="L1950" href="#L1950">1950</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L1951" href="#L1951">1951</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, id);
<a class="jxr_linenumber" name="L1952" href="#L1952">1952</a> 
<a class="jxr_linenumber" name="L1953" href="#L1953">1953</a>     <strong class="jxr_keyword">if</strong> (optEvent.get().isScheduledEvent() &amp;&amp; !optEvent.get().hasRecordingStarted()) {
<a class="jxr_linenumber" name="L1954" href="#L1954">1954</a>       <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1955" href="#L1955">1955</a> 
<a class="jxr_linenumber" name="L1956" href="#L1956">1956</a>         JSONObject configJSON;
<a class="jxr_linenumber" name="L1957" href="#L1957">1957</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1958" href="#L1958">1958</a>           configJSON = (JSONObject) <strong class="jxr_keyword">new</strong> JSONParser().parse(configuration);
<a class="jxr_linenumber" name="L1959" href="#L1959">1959</a>         } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L1960" href="#L1960">1960</a>           logger.warn(<span class="jxr_string">"Unable to parse the workflow configuration {}"</span>, configuration);
<a class="jxr_linenumber" name="L1961" href="#L1961">1961</a>           <strong class="jxr_keyword">return</strong> badRequest();
<a class="jxr_linenumber" name="L1962" href="#L1962">1962</a>         }
<a class="jxr_linenumber" name="L1963" href="#L1963">1963</a> 
<a class="jxr_linenumber" name="L1964" href="#L1964">1964</a>         Optional&lt;Map&lt;String, String&gt;&gt; caMetadataOpt = Optional.empty();
<a class="jxr_linenumber" name="L1965" href="#L1965">1965</a>         Optional&lt;Map&lt;String, String&gt;&gt; workflowConfigOpt = Optional.empty();
<a class="jxr_linenumber" name="L1966" href="#L1966">1966</a> 
<a class="jxr_linenumber" name="L1967" href="#L1967">1967</a>         String workflowId = (String) configJSON.get(<span class="jxr_string">"id"</span>);
<a class="jxr_linenumber" name="L1968" href="#L1968">1968</a>         Map&lt;String, String&gt; caMetadata = <strong class="jxr_keyword">new</strong> HashMap&lt;&gt;(getSchedulerService().getCaptureAgentConfiguration(id));
<a class="jxr_linenumber" name="L1969" href="#L1969">1969</a>         <strong class="jxr_keyword">if</strong> (!workflowId.equals(caMetadata.get(CaptureParameters.INGEST_WORKFLOW_DEFINITION))) {
<a class="jxr_linenumber" name="L1970" href="#L1970">1970</a>           caMetadata.put(CaptureParameters.INGEST_WORKFLOW_DEFINITION, workflowId);
<a class="jxr_linenumber" name="L1971" href="#L1971">1971</a>           caMetadataOpt = Optional.of(caMetadata);
<a class="jxr_linenumber" name="L1972" href="#L1972">1972</a>         }
<a class="jxr_linenumber" name="L1973" href="#L1973">1973</a> 
<a class="jxr_linenumber" name="L1974" href="#L1974">1974</a>         Map&lt;String, String&gt; workflowConfig = <strong class="jxr_keyword">new</strong> HashMap&lt;&gt;((JSONObject) configJSON.get(<span class="jxr_string">"configuration"</span>));
<a class="jxr_linenumber" name="L1975" href="#L1975">1975</a>         Map&lt;String, String&gt; oldWorkflowConfig = <strong class="jxr_keyword">new</strong> HashMap&lt;&gt;(getSchedulerService().getWorkflowConfig(id));
<a class="jxr_linenumber" name="L1976" href="#L1976">1976</a>         <strong class="jxr_keyword">if</strong> (!oldWorkflowConfig.equals(workflowConfig))
<a class="jxr_linenumber" name="L1977" href="#L1977">1977</a>           workflowConfigOpt = Optional.of(workflowConfig);
<a class="jxr_linenumber" name="L1978" href="#L1978">1978</a> 
<a class="jxr_linenumber" name="L1979" href="#L1979">1979</a>         <strong class="jxr_keyword">if</strong> (caMetadataOpt.isEmpty() &amp;&amp; workflowConfigOpt.isEmpty())
<a class="jxr_linenumber" name="L1980" href="#L1980">1980</a>           <strong class="jxr_keyword">return</strong> Response.noContent().build();
<a class="jxr_linenumber" name="L1981" href="#L1981">1981</a> 
<a class="jxr_linenumber" name="L1982" href="#L1982">1982</a>         checkAgentAccessForAgent(optEvent.get().getAgentId());
<a class="jxr_linenumber" name="L1983" href="#L1983">1983</a> 
<a class="jxr_linenumber" name="L1984" href="#L1984">1984</a>         getSchedulerService().updateEvent(id, Optional.empty(), Optional.empty(), Optional.empty(),
<a class="jxr_linenumber" name="L1985" href="#L1985">1985</a>             Optional.empty(), Optional.empty(), workflowConfigOpt, caMetadataOpt);
<a class="jxr_linenumber" name="L1986" href="#L1986">1986</a>         <strong class="jxr_keyword">return</strong> Response.noContent().build();
<a class="jxr_linenumber" name="L1987" href="#L1987">1987</a>       } <strong class="jxr_keyword">catch</strong> (NotFoundException e) {
<a class="jxr_linenumber" name="L1988" href="#L1988">1988</a>         <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find event %s in scheduler service"</span>, id);
<a class="jxr_linenumber" name="L1989" href="#L1989">1989</a>       } <strong class="jxr_keyword">catch</strong> (SchedulerException e) {
<a class="jxr_linenumber" name="L1990" href="#L1990">1990</a>         logger.error(<span class="jxr_string">"Unable to update scheduling workflow data for event with id {}"</span>, id);
<a class="jxr_linenumber" name="L1991" href="#L1991">1991</a>         <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> WebApplicationException(e, SC_INTERNAL_SERVER_ERROR);
<a class="jxr_linenumber" name="L1992" href="#L1992">1992</a>       }
<a class="jxr_linenumber" name="L1993" href="#L1993">1993</a>     } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L1994" href="#L1994">1994</a>       <strong class="jxr_keyword">return</strong> badRequest(String.format(<span class="jxr_string">"Event %s workflow can not be updated as the recording already started."</span>, id));
<a class="jxr_linenumber" name="L1995" href="#L1995">1995</a>     }
<a class="jxr_linenumber" name="L1996" href="#L1996">1996</a>   }
<a class="jxr_linenumber" name="L1997" href="#L1997">1997</a> 
<a class="jxr_linenumber" name="L1998" href="#L1998">1998</a>   @GET
<a class="jxr_linenumber" name="L1999" href="#L1999">1999</a>   @Path(<span class="jxr_string">"{eventId}/workflows/{workflowId}"</span>)
<a class="jxr_linenumber" name="L2000" href="#L2000">2000</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L2001" href="#L2001">2001</a>   @RestQuery(name = <span class="jxr_string">"geteventworkflow"</span>, description = <span class="jxr_string">"Returns all the data related to the single workflow tab in the event details modal as JSON"</span>, returnDescription = <span class="jxr_string">"All the data related to the event singe workflow tab as JSON"</span>, pathParameters = {
<a class="jxr_linenumber" name="L2002" href="#L2002">2002</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L2003" href="#L2003">2003</a>           @RestParameter(name = <span class="jxr_string">"workflowId"</span>, description = <span class="jxr_string">"The workflow id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L2004" href="#L2004">2004</a>                   @RestResponse(description = <span class="jxr_string">"Returns all the data related to the event single workflow tab as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L2005" href="#L2005">2005</a>                   @RestResponse(description = <span class="jxr_string">"Unable to parse workflowId"</span>, responseCode = HttpServletResponse.SC_BAD_REQUEST),
<a class="jxr_linenumber" name="L2006" href="#L2006">2006</a>                   @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L2007" href="#L2007">2007</a>   <strong class="jxr_keyword">public</strong> Response getEventWorkflow(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId, @PathParam(<span class="jxr_string">"workflowId"</span>) String workflowId)
<a class="jxr_linenumber" name="L2008" href="#L2008">2008</a>           <strong class="jxr_keyword">throws</strong> SearchIndexException {
<a class="jxr_linenumber" name="L2009" href="#L2009">2009</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L2010" href="#L2010">2010</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L2011" href="#L2011">2011</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId);
<a class="jxr_linenumber" name="L2012" href="#L2012">2012</a> 
<a class="jxr_linenumber" name="L2013" href="#L2013">2013</a>     <strong class="jxr_keyword">long</strong> workflowInstanceId;
<a class="jxr_linenumber" name="L2014" href="#L2014">2014</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2015" href="#L2015">2015</a>       workflowId = StringUtils.remove(workflowId, <span class="jxr_string">".json"</span>);
<a class="jxr_linenumber" name="L2016" href="#L2016">2016</a>       workflowInstanceId = Long.parseLong(workflowId);
<a class="jxr_linenumber" name="L2017" href="#L2017">2017</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L2018" href="#L2018">2018</a>       logger.warn(<span class="jxr_string">"Unable to parse workflow id {}"</span>, workflowId);
<a class="jxr_linenumber" name="L2019" href="#L2019">2019</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.badRequest();
<a class="jxr_linenumber" name="L2020" href="#L2020">2020</a>     }
<a class="jxr_linenumber" name="L2021" href="#L2021">2021</a> 
<a class="jxr_linenumber" name="L2022" href="#L2022">2022</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2023" href="#L2023">2023</a>       WorkflowInstance instance = getWorkflowService().getWorkflowById(workflowInstanceId);
<a class="jxr_linenumber" name="L2024" href="#L2024">2024</a> 
<a class="jxr_linenumber" name="L2025" href="#L2025">2025</a>       <em class="jxr_comment">// Retrieve submission date with the workflow instance main job</em>
<a class="jxr_linenumber" name="L2026" href="#L2026">2026</a>       Date created = instance.getDateCreated();
<a class="jxr_linenumber" name="L2027" href="#L2027">2027</a> 
<a class="jxr_linenumber" name="L2028" href="#L2028">2028</a>       Date completed = instance.getDateCompleted();
<a class="jxr_linenumber" name="L2029" href="#L2029">2029</a>       <strong class="jxr_keyword">if</strong> (completed == <strong class="jxr_keyword">null</strong>)
<a class="jxr_linenumber" name="L2030" href="#L2030">2030</a>         completed = <strong class="jxr_keyword">new</strong> Date();
<a class="jxr_linenumber" name="L2031" href="#L2031">2031</a> 
<a class="jxr_linenumber" name="L2032" href="#L2032">2032</a>       <strong class="jxr_keyword">long</strong> executionTime = completed.getTime() - created.getTime();
<a class="jxr_linenumber" name="L2033" href="#L2033">2033</a> 
<a class="jxr_linenumber" name="L2034" href="#L2034">2034</a>       <strong class="jxr_keyword">var</strong> fields = instance.getConfigurations()
<a class="jxr_linenumber" name="L2035" href="#L2035">2035</a>           .entrySet()
<a class="jxr_linenumber" name="L2036" href="#L2036">2036</a>           .stream()
<a class="jxr_linenumber" name="L2037" href="#L2037">2037</a>           .map(e -&gt; f(e.getKey(), v(e.getValue(), Jsons.BLANK)))
<a class="jxr_linenumber" name="L2038" href="#L2038">2038</a>           .collect(Collectors.toList());
<a class="jxr_linenumber" name="L2039" href="#L2039">2039</a> 
<a class="jxr_linenumber" name="L2040" href="#L2040">2040</a>       <strong class="jxr_keyword">return</strong> okJson(obj(
<a class="jxr_linenumber" name="L2041" href="#L2041">2041</a>               f(<span class="jxr_string">"status"</span>, v(WORKFLOW_STATUS_TRANSLATION_PREFIX + instance.getState(), Jsons.BLANK)),
<a class="jxr_linenumber" name="L2042" href="#L2042">2042</a>               f(<span class="jxr_string">"description"</span>, v(instance.getDescription(), Jsons.BLANK)),
<a class="jxr_linenumber" name="L2043" href="#L2043">2043</a>               f(<span class="jxr_string">"executionTime"</span>, v(executionTime, Jsons.BLANK)),
<a class="jxr_linenumber" name="L2044" href="#L2044">2044</a>               f(<span class="jxr_string">"wiid"</span>, v(instance.getId(), Jsons.BLANK)), f(<span class="jxr_string">"title"</span>, v(instance.getTitle(), Jsons.BLANK)),
<a class="jxr_linenumber" name="L2045" href="#L2045">2045</a>               f(<span class="jxr_string">"wdid"</span>, v(instance.getTemplate(), Jsons.BLANK)),
<a class="jxr_linenumber" name="L2046" href="#L2046">2046</a>               f(<span class="jxr_string">"configuration"</span>, obj(fields)),
<a class="jxr_linenumber" name="L2047" href="#L2047">2047</a>               f(<span class="jxr_string">"submittedAt"</span>, v(toUTC(created.getTime()), Jsons.BLANK)),
<a class="jxr_linenumber" name="L2048" href="#L2048">2048</a>               f(<span class="jxr_string">"creator"</span>, v(instance.getCreatorName(), Jsons.BLANK))));
<a class="jxr_linenumber" name="L2049" href="#L2049">2049</a>     } <strong class="jxr_keyword">catch</strong> (NotFoundException e) {
<a class="jxr_linenumber" name="L2050" href="#L2050">2050</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find workflow  %s"</span>, workflowId);
<a class="jxr_linenumber" name="L2051" href="#L2051">2051</a>     } <strong class="jxr_keyword">catch</strong> (WorkflowDatabaseException e) {
<a class="jxr_linenumber" name="L2052" href="#L2052">2052</a>       logger.error(<span class="jxr_string">"Unable to get workflow {} of event {}"</span>, workflowId, eventId, e);
<a class="jxr_linenumber" name="L2053" href="#L2053">2053</a>       <strong class="jxr_keyword">return</strong> serverError();
<a class="jxr_linenumber" name="L2054" href="#L2054">2054</a>     } <strong class="jxr_keyword">catch</strong> (UnauthorizedException e) {
<a class="jxr_linenumber" name="L2055" href="#L2055">2055</a>       <strong class="jxr_keyword">return</strong> forbidden();
<a class="jxr_linenumber" name="L2056" href="#L2056">2056</a>     }
<a class="jxr_linenumber" name="L2057" href="#L2057">2057</a>   }
<a class="jxr_linenumber" name="L2058" href="#L2058">2058</a> 
<a class="jxr_linenumber" name="L2059" href="#L2059">2059</a>   @GET
<a class="jxr_linenumber" name="L2060" href="#L2060">2060</a>   @Path(<span class="jxr_string">"{eventId}/workflows/{workflowId}/operations.json"</span>)
<a class="jxr_linenumber" name="L2061" href="#L2061">2061</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L2062" href="#L2062">2062</a>   @RestQuery(name = <span class="jxr_string">"geteventoperations"</span>, description = <span class="jxr_string">"Returns all the data related to the workflow/operations tab in the event details modal as JSON"</span>, returnDescription = <span class="jxr_string">"All the data related to the event workflow/opertations tab as JSON"</span>, pathParameters = {
<a class="jxr_linenumber" name="L2063" href="#L2063">2063</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L2064" href="#L2064">2064</a>           @RestParameter(name = <span class="jxr_string">"workflowId"</span>, description = <span class="jxr_string">"The workflow id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L2065" href="#L2065">2065</a>                   @RestResponse(description = <span class="jxr_string">"Returns all the data related to the event workflow/operations tab as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L2066" href="#L2066">2066</a>                   @RestResponse(description = <span class="jxr_string">"Unable to parse workflowId"</span>, responseCode = HttpServletResponse.SC_BAD_REQUEST),
<a class="jxr_linenumber" name="L2067" href="#L2067">2067</a>                   @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L2068" href="#L2068">2068</a>   <strong class="jxr_keyword">public</strong> Response getEventOperations(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId, @PathParam(<span class="jxr_string">"workflowId"</span>) String workflowId)
<a class="jxr_linenumber" name="L2069" href="#L2069">2069</a>           <strong class="jxr_keyword">throws</strong> SearchIndexException {
<a class="jxr_linenumber" name="L2070" href="#L2070">2070</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L2071" href="#L2071">2071</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L2072" href="#L2072">2072</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId);
<a class="jxr_linenumber" name="L2073" href="#L2073">2073</a> 
<a class="jxr_linenumber" name="L2074" href="#L2074">2074</a>     <strong class="jxr_keyword">long</strong> workflowInstanceId;
<a class="jxr_linenumber" name="L2075" href="#L2075">2075</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2076" href="#L2076">2076</a>       workflowInstanceId = Long.parseLong(workflowId);
<a class="jxr_linenumber" name="L2077" href="#L2077">2077</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L2078" href="#L2078">2078</a>       logger.warn(<span class="jxr_string">"Unable to parse workflow id {}"</span>, workflowId);
<a class="jxr_linenumber" name="L2079" href="#L2079">2079</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.badRequest();
<a class="jxr_linenumber" name="L2080" href="#L2080">2080</a>     }
<a class="jxr_linenumber" name="L2081" href="#L2081">2081</a> 
<a class="jxr_linenumber" name="L2082" href="#L2082">2082</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2083" href="#L2083">2083</a>       WorkflowInstance instance = getWorkflowService().getWorkflowById(workflowInstanceId);
<a class="jxr_linenumber" name="L2084" href="#L2084">2084</a> 
<a class="jxr_linenumber" name="L2085" href="#L2085">2085</a>       List&lt;WorkflowOperationInstance&gt; operations = instance.getOperations();
<a class="jxr_linenumber" name="L2086" href="#L2086">2086</a>       List&lt;JValue&gt; operationsJSON = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2087" href="#L2087">2087</a> 
<a class="jxr_linenumber" name="L2088" href="#L2088">2088</a>       <strong class="jxr_keyword">for</strong> (WorkflowOperationInstance wflOp : operations) {
<a class="jxr_linenumber" name="L2089" href="#L2089">2089</a>         List&lt;Field&gt; fields = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2090" href="#L2090">2090</a>         <strong class="jxr_keyword">for</strong> (String key : wflOp.getConfigurationKeys()) {
<a class="jxr_linenumber" name="L2091" href="#L2091">2091</a>           fields.add(f(key, v(wflOp.getConfiguration(key), Jsons.BLANK)));
<a class="jxr_linenumber" name="L2092" href="#L2092">2092</a>         }
<a class="jxr_linenumber" name="L2093" href="#L2093">2093</a>         operationsJSON.add(obj(
<a class="jxr_linenumber" name="L2094" href="#L2094">2094</a>                 f(<span class="jxr_string">"status"</span>,
<a class="jxr_linenumber" name="L2095" href="#L2095">2095</a>                 v(WORKFLOW_STATUS_TRANSLATION_PREFIX + wflOp.getState(), Jsons.BLANK)),
<a class="jxr_linenumber" name="L2096" href="#L2096">2096</a>                 f(<span class="jxr_string">"title"</span>, v(wflOp.getTemplate(), Jsons.BLANK)),
<a class="jxr_linenumber" name="L2097" href="#L2097">2097</a>                 f(<span class="jxr_string">"description"</span>, v(wflOp.getDescription(), Jsons.BLANK)),
<a class="jxr_linenumber" name="L2098" href="#L2098">2098</a>                 f(<span class="jxr_string">"id"</span>, v(wflOp.getId(), Jsons.BLANK)),
<a class="jxr_linenumber" name="L2099" href="#L2099">2099</a>                 f(<span class="jxr_string">"configuration"</span>, obj(fields))
<a class="jxr_linenumber" name="L2100" href="#L2100">2100</a>         ));
<a class="jxr_linenumber" name="L2101" href="#L2101">2101</a>       }
<a class="jxr_linenumber" name="L2102" href="#L2102">2102</a> 
<a class="jxr_linenumber" name="L2103" href="#L2103">2103</a>       <strong class="jxr_keyword">return</strong> okJson(arr(operationsJSON));
<a class="jxr_linenumber" name="L2104" href="#L2104">2104</a>     } <strong class="jxr_keyword">catch</strong> (NotFoundException e) {
<a class="jxr_linenumber" name="L2105" href="#L2105">2105</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find workflow %s"</span>, workflowId);
<a class="jxr_linenumber" name="L2106" href="#L2106">2106</a>     } <strong class="jxr_keyword">catch</strong> (WorkflowDatabaseException e) {
<a class="jxr_linenumber" name="L2107" href="#L2107">2107</a>       logger.error(<span class="jxr_string">"Unable to get workflow operations of event {} and workflow {}"</span>, eventId, workflowId, e);
<a class="jxr_linenumber" name="L2108" href="#L2108">2108</a>       <strong class="jxr_keyword">return</strong> serverError();
<a class="jxr_linenumber" name="L2109" href="#L2109">2109</a>     } <strong class="jxr_keyword">catch</strong> (UnauthorizedException e) {
<a class="jxr_linenumber" name="L2110" href="#L2110">2110</a>       <strong class="jxr_keyword">return</strong> forbidden();
<a class="jxr_linenumber" name="L2111" href="#L2111">2111</a>     }
<a class="jxr_linenumber" name="L2112" href="#L2112">2112</a>   }
<a class="jxr_linenumber" name="L2113" href="#L2113">2113</a> 
<a class="jxr_linenumber" name="L2114" href="#L2114">2114</a>   @GET
<a class="jxr_linenumber" name="L2115" href="#L2115">2115</a>   @Path(<span class="jxr_string">"{eventId}/workflows/{workflowId}/operations/{operationPosition}"</span>)
<a class="jxr_linenumber" name="L2116" href="#L2116">2116</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L2117" href="#L2117">2117</a>   @RestQuery(name = <span class="jxr_string">"geteventoperation"</span>, description = <span class="jxr_string">"Returns all the data related to the workflow/operation tab in the event details modal as JSON"</span>, returnDescription = <span class="jxr_string">"All the data related to the event workflow/opertation tab as JSON"</span>, pathParameters = {
<a class="jxr_linenumber" name="L2118" href="#L2118">2118</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L2119" href="#L2119">2119</a>           @RestParameter(name = <span class="jxr_string">"workflowId"</span>, description = <span class="jxr_string">"The workflow id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L2120" href="#L2120">2120</a>           @RestParameter(name = <span class="jxr_string">"operationPosition"</span>, description = <span class="jxr_string">"The operation position"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.INTEGER) }, responses = {
<a class="jxr_linenumber" name="L2121" href="#L2121">2121</a>                   @RestResponse(description = <span class="jxr_string">"Returns all the data related to the event workflow/operation tab as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L2122" href="#L2122">2122</a>                   @RestResponse(description = <span class="jxr_string">"Unable to parse workflowId or operationPosition"</span>, responseCode = HttpServletResponse.SC_BAD_REQUEST),
<a class="jxr_linenumber" name="L2123" href="#L2123">2123</a>                   @RestResponse(description = <span class="jxr_string">"No operation with these identifiers was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L2124" href="#L2124">2124</a>   <strong class="jxr_keyword">public</strong> Response getEventOperation(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId, @PathParam(<span class="jxr_string">"workflowId"</span>) String workflowId,
<a class="jxr_linenumber" name="L2125" href="#L2125">2125</a>           @PathParam(<span class="jxr_string">"operationPosition"</span>) Integer operationPosition) <strong class="jxr_keyword">throws</strong> SearchIndexException {
<a class="jxr_linenumber" name="L2126" href="#L2126">2126</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L2127" href="#L2127">2127</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L2128" href="#L2128">2128</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId);
<a class="jxr_linenumber" name="L2129" href="#L2129">2129</a> 
<a class="jxr_linenumber" name="L2130" href="#L2130">2130</a>     <strong class="jxr_keyword">long</strong> workflowInstanceId;
<a class="jxr_linenumber" name="L2131" href="#L2131">2131</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2132" href="#L2132">2132</a>       workflowInstanceId = Long.parseLong(workflowId);
<a class="jxr_linenumber" name="L2133" href="#L2133">2133</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L2134" href="#L2134">2134</a>       logger.warn(<span class="jxr_string">"Unable to parse workflow id {}"</span>, workflowId);
<a class="jxr_linenumber" name="L2135" href="#L2135">2135</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.badRequest();
<a class="jxr_linenumber" name="L2136" href="#L2136">2136</a>     }
<a class="jxr_linenumber" name="L2137" href="#L2137">2137</a> 
<a class="jxr_linenumber" name="L2138" href="#L2138">2138</a>     WorkflowInstance instance;
<a class="jxr_linenumber" name="L2139" href="#L2139">2139</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2140" href="#L2140">2140</a>       instance = getWorkflowService().getWorkflowById(workflowInstanceId);
<a class="jxr_linenumber" name="L2141" href="#L2141">2141</a>     } <strong class="jxr_keyword">catch</strong> (NotFoundException e) {
<a class="jxr_linenumber" name="L2142" href="#L2142">2142</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find workflow %s"</span>, workflowId);
<a class="jxr_linenumber" name="L2143" href="#L2143">2143</a>     } <strong class="jxr_keyword">catch</strong> (WorkflowDatabaseException e) {
<a class="jxr_linenumber" name="L2144" href="#L2144">2144</a>       logger.error(<span class="jxr_string">"Unable to get workflow operation of event {} and workflow {} at position {}"</span>, eventId, workflowId,
<a class="jxr_linenumber" name="L2145" href="#L2145">2145</a>               operationPosition, e);
<a class="jxr_linenumber" name="L2146" href="#L2146">2146</a>       <strong class="jxr_keyword">return</strong> serverError();
<a class="jxr_linenumber" name="L2147" href="#L2147">2147</a>     } <strong class="jxr_keyword">catch</strong> (UnauthorizedException e) {
<a class="jxr_linenumber" name="L2148" href="#L2148">2148</a>       <strong class="jxr_keyword">return</strong> forbidden();
<a class="jxr_linenumber" name="L2149" href="#L2149">2149</a>     }
<a class="jxr_linenumber" name="L2150" href="#L2150">2150</a> 
<a class="jxr_linenumber" name="L2151" href="#L2151">2151</a>     List&lt;WorkflowOperationInstance&gt; operations = instance.getOperations();
<a class="jxr_linenumber" name="L2152" href="#L2152">2152</a> 
<a class="jxr_linenumber" name="L2153" href="#L2153">2153</a>     <strong class="jxr_keyword">if</strong> (operations.size() &gt; operationPosition) {
<a class="jxr_linenumber" name="L2154" href="#L2154">2154</a>       WorkflowOperationInstance wflOp = operations.get(operationPosition);
<a class="jxr_linenumber" name="L2155" href="#L2155">2155</a>       <strong class="jxr_keyword">return</strong> okJson(obj(f(<span class="jxr_string">"retry_strategy"</span>, v(wflOp.getRetryStrategy(), Jsons.BLANK)),
<a class="jxr_linenumber" name="L2156" href="#L2156">2156</a>               f(<span class="jxr_string">"execution_host"</span>, v(wflOp.getExecutionHost(), Jsons.BLANK)),
<a class="jxr_linenumber" name="L2157" href="#L2157">2157</a>               f(<span class="jxr_string">"failed_attempts"</span>, v(wflOp.getFailedAttempts())),
<a class="jxr_linenumber" name="L2158" href="#L2158">2158</a>               f(<span class="jxr_string">"max_attempts"</span>, v(wflOp.getMaxAttempts())),
<a class="jxr_linenumber" name="L2159" href="#L2159">2159</a>               f(<span class="jxr_string">"exception_handler_workflow"</span>, v(wflOp.getExceptionHandlingWorkflow(), Jsons.BLANK)),
<a class="jxr_linenumber" name="L2160" href="#L2160">2160</a>               f(<span class="jxr_string">"fail_on_error"</span>, v(wflOp.isFailOnError())),
<a class="jxr_linenumber" name="L2161" href="#L2161">2161</a>               f(<span class="jxr_string">"description"</span>, v(wflOp.getDescription(), Jsons.BLANK)),
<a class="jxr_linenumber" name="L2162" href="#L2162">2162</a>               f(<span class="jxr_string">"state"</span>, v(WORKFLOW_STATUS_TRANSLATION_PREFIX + wflOp.getState(), Jsons.BLANK)),
<a class="jxr_linenumber" name="L2163" href="#L2163">2163</a>               f(<span class="jxr_string">"job"</span>, v(wflOp.getId(), Jsons.BLANK)),
<a class="jxr_linenumber" name="L2164" href="#L2164">2164</a>               f(<span class="jxr_string">"name"</span>, v(wflOp.getTemplate(), Jsons.BLANK)),
<a class="jxr_linenumber" name="L2165" href="#L2165">2165</a>               f(<span class="jxr_string">"time_in_queue"</span>, v(wflOp.getTimeInQueue(), v(0))),
<a class="jxr_linenumber" name="L2166" href="#L2166">2166</a>               f(<span class="jxr_string">"started"</span>, wflOp.getDateStarted() != <strong class="jxr_keyword">null</strong> ? v(toUTC(wflOp.getDateStarted().getTime())) : Jsons.BLANK),
<a class="jxr_linenumber" name="L2167" href="#L2167">2167</a>               f(<span class="jxr_string">"completed"</span>, wflOp.getDateCompleted() != <strong class="jxr_keyword">null</strong> ? v(toUTC(wflOp.getDateCompleted().getTime())) : Jsons.BLANK))
<a class="jxr_linenumber" name="L2168" href="#L2168">2168</a>       );
<a class="jxr_linenumber" name="L2169" href="#L2169">2169</a>     }
<a class="jxr_linenumber" name="L2170" href="#L2170">2170</a>     <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find workflow operation of workflow %s at position %s"</span>, workflowId, operationPosition);
<a class="jxr_linenumber" name="L2171" href="#L2171">2171</a>   }
<a class="jxr_linenumber" name="L2172" href="#L2172">2172</a> 
<a class="jxr_linenumber" name="L2173" href="#L2173">2173</a>   @GET
<a class="jxr_linenumber" name="L2174" href="#L2174">2174</a>   @Path(<span class="jxr_string">"{eventId}/workflows/{workflowId}/errors.json"</span>)
<a class="jxr_linenumber" name="L2175" href="#L2175">2175</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L2176" href="#L2176">2176</a>   @RestQuery(name = <span class="jxr_string">"geteventerrors"</span>, description = <span class="jxr_string">"Returns all the data related to the workflow/errors tab in the event details modal as JSON"</span>, returnDescription = <span class="jxr_string">"All the data related to the event workflow/errors tab as JSON"</span>, pathParameters = {
<a class="jxr_linenumber" name="L2177" href="#L2177">2177</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L2178" href="#L2178">2178</a>           @RestParameter(name = <span class="jxr_string">"workflowId"</span>, description = <span class="jxr_string">"The workflow id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L2179" href="#L2179">2179</a>                   @RestResponse(description = <span class="jxr_string">"Returns all the data related to the event workflow/errors tab as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L2180" href="#L2180">2180</a>                   @RestResponse(description = <span class="jxr_string">"Unable to parse workflowId"</span>, responseCode = HttpServletResponse.SC_BAD_REQUEST),
<a class="jxr_linenumber" name="L2181" href="#L2181">2181</a>                   @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L2182" href="#L2182">2182</a>   <strong class="jxr_keyword">public</strong> Response getEventErrors(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId, @PathParam(<span class="jxr_string">"workflowId"</span>) String workflowId,
<a class="jxr_linenumber" name="L2183" href="#L2183">2183</a>           @Context HttpServletRequest req) <strong class="jxr_keyword">throws</strong> JobEndpointException, SearchIndexException {
<a class="jxr_linenumber" name="L2184" href="#L2184">2184</a>     <em class="jxr_comment">// the call to #getEvent should make sure that the calling user has access rights to the workflow</em>
<a class="jxr_linenumber" name="L2185" href="#L2185">2185</a>     <em class="jxr_comment">// FIXME since there is no dependency between the event and the workflow (the fetched event is</em>
<a class="jxr_linenumber" name="L2186" href="#L2186">2186</a>     <em class="jxr_comment">// simply ignored) an attacker can get access by using an event he owns and a workflow ID of</em>
<a class="jxr_linenumber" name="L2187" href="#L2187">2187</a>     <em class="jxr_comment">// someone else.</em>
<a class="jxr_linenumber" name="L2188" href="#L2188">2188</a>     <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> Event ignore : getIndexService().getEvent(eventId, getIndex())) {
<a class="jxr_linenumber" name="L2189" href="#L2189">2189</a>       <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">long</strong> workflowIdLong;
<a class="jxr_linenumber" name="L2190" href="#L2190">2190</a>       <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2191" href="#L2191">2191</a>         workflowIdLong = Long.parseLong(workflowId);
<a class="jxr_linenumber" name="L2192" href="#L2192">2192</a>       } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L2193" href="#L2193">2193</a>         logger.warn(<span class="jxr_string">"Unable to parse workflow id {}"</span>, workflowId);
<a class="jxr_linenumber" name="L2194" href="#L2194">2194</a>         <strong class="jxr_keyword">return</strong> RestUtil.R.badRequest();
<a class="jxr_linenumber" name="L2195" href="#L2195">2195</a>       }
<a class="jxr_linenumber" name="L2196" href="#L2196">2196</a>       <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2197" href="#L2197">2197</a>         <strong class="jxr_keyword">return</strong> okJson(getJobService().getIncidentsAsJSON(workflowIdLong, req.getLocale(), <strong class="jxr_keyword">true</strong>));
<a class="jxr_linenumber" name="L2198" href="#L2198">2198</a>       } <strong class="jxr_keyword">catch</strong> (NotFoundException e) {
<a class="jxr_linenumber" name="L2199" href="#L2199">2199</a>         <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find the incident for the workflow %s"</span>, workflowId);
<a class="jxr_linenumber" name="L2200" href="#L2200">2200</a>       }
<a class="jxr_linenumber" name="L2201" href="#L2201">2201</a>     }
<a class="jxr_linenumber" name="L2202" href="#L2202">2202</a>     <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId);
<a class="jxr_linenumber" name="L2203" href="#L2203">2203</a>   }
<a class="jxr_linenumber" name="L2204" href="#L2204">2204</a> 
<a class="jxr_linenumber" name="L2205" href="#L2205">2205</a>   @GET
<a class="jxr_linenumber" name="L2206" href="#L2206">2206</a>   @Path(<span class="jxr_string">"{eventId}/workflows/{workflowId}/errors/{errorId}.json"</span>)
<a class="jxr_linenumber" name="L2207" href="#L2207">2207</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L2208" href="#L2208">2208</a>   @RestQuery(name = <span class="jxr_string">"geteventerror"</span>, description = <span class="jxr_string">"Returns all the data related to the workflow/error tab in the event details modal as JSON"</span>, returnDescription = <span class="jxr_string">"All the data related to the event workflow/error tab as JSON"</span>, pathParameters = {
<a class="jxr_linenumber" name="L2209" href="#L2209">2209</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L2210" href="#L2210">2210</a>           @RestParameter(name = <span class="jxr_string">"workflowId"</span>, description = <span class="jxr_string">"The workflow id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L2211" href="#L2211">2211</a>           @RestParameter(name = <span class="jxr_string">"errorId"</span>, description = <span class="jxr_string">"The error id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L2212" href="#L2212">2212</a>                   @RestResponse(description = <span class="jxr_string">"Returns all the data related to the event workflow/error tab as JSON"</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L2213" href="#L2213">2213</a>                   @RestResponse(description = <span class="jxr_string">"Unable to parse workflowId"</span>, responseCode = HttpServletResponse.SC_BAD_REQUEST),
<a class="jxr_linenumber" name="L2214" href="#L2214">2214</a>                   @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) })
<a class="jxr_linenumber" name="L2215" href="#L2215">2215</a>   <strong class="jxr_keyword">public</strong> Response getEventError(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId, @PathParam(<span class="jxr_string">"workflowId"</span>) String workflowId,
<a class="jxr_linenumber" name="L2216" href="#L2216">2216</a>           @PathParam(<span class="jxr_string">"errorId"</span>) String errorId, @Context HttpServletRequest req)
<a class="jxr_linenumber" name="L2217" href="#L2217">2217</a>                   <strong class="jxr_keyword">throws</strong> JobEndpointException, SearchIndexException {
<a class="jxr_linenumber" name="L2218" href="#L2218">2218</a>     <em class="jxr_comment">// the call to #getEvent should make sure that the calling user has access rights to the workflow</em>
<a class="jxr_linenumber" name="L2219" href="#L2219">2219</a>     <em class="jxr_comment">// FIXME since there is no dependency between the event and the workflow (the fetched event is</em>
<a class="jxr_linenumber" name="L2220" href="#L2220">2220</a>     <em class="jxr_comment">// simply ignored) an attacker can get access by using an event he owns and a workflow ID of</em>
<a class="jxr_linenumber" name="L2221" href="#L2221">2221</a>     <em class="jxr_comment">// someone else.</em>
<a class="jxr_linenumber" name="L2222" href="#L2222">2222</a>     <strong class="jxr_keyword">for</strong> (Event ignore : getIndexService().getEvent(eventId, getIndex())) {
<a class="jxr_linenumber" name="L2223" href="#L2223">2223</a>       <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">long</strong> errorIdLong;
<a class="jxr_linenumber" name="L2224" href="#L2224">2224</a>       <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2225" href="#L2225">2225</a>         errorIdLong = Long.parseLong(errorId);
<a class="jxr_linenumber" name="L2226" href="#L2226">2226</a>       } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L2227" href="#L2227">2227</a>         logger.warn(<span class="jxr_string">"Unable to parse error id {}"</span>, errorId);
<a class="jxr_linenumber" name="L2228" href="#L2228">2228</a>         <strong class="jxr_keyword">return</strong> RestUtil.R.badRequest();
<a class="jxr_linenumber" name="L2229" href="#L2229">2229</a>       }
<a class="jxr_linenumber" name="L2230" href="#L2230">2230</a>       <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2231" href="#L2231">2231</a>         <strong class="jxr_keyword">return</strong> okJson(getJobService().getIncidentAsJSON(errorIdLong, req.getLocale()));
<a class="jxr_linenumber" name="L2232" href="#L2232">2232</a>       } <strong class="jxr_keyword">catch</strong> (NotFoundException e) {
<a class="jxr_linenumber" name="L2233" href="#L2233">2233</a>         <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find the incident %s"</span>, errorId);
<a class="jxr_linenumber" name="L2234" href="#L2234">2234</a>       }
<a class="jxr_linenumber" name="L2235" href="#L2235">2235</a>     }
<a class="jxr_linenumber" name="L2236" href="#L2236">2236</a>     <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId);
<a class="jxr_linenumber" name="L2237" href="#L2237">2237</a>   }
<a class="jxr_linenumber" name="L2238" href="#L2238">2238</a> 
<a class="jxr_linenumber" name="L2239" href="#L2239">2239</a>   @GET
<a class="jxr_linenumber" name="L2240" href="#L2240">2240</a>   @Path(<span class="jxr_string">"{eventId}/access.json"</span>)
<a class="jxr_linenumber" name="L2241" href="#L2241">2241</a>   @SuppressWarnings(<span class="jxr_string">"unchecked"</span>)
<a class="jxr_linenumber" name="L2242" href="#L2242">2242</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L2243" href="#L2243">2243</a>   @RestQuery(name = <span class="jxr_string">"getEventAccessInformation"</span>, description = <span class="jxr_string">"Get the access information of an event"</span>, returnDescription = <span class="jxr_string">"The access information"</span>, pathParameters = {
<a class="jxr_linenumber" name="L2244" href="#L2244">2244</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The event identifier"</span>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L2245" href="#L2245">2245</a>                   @RestResponse(responseCode = SC_BAD_REQUEST, description = <span class="jxr_string">"The required form params were missing in the request."</span>),
<a class="jxr_linenumber" name="L2246" href="#L2246">2246</a>                   @RestResponse(responseCode = SC_NOT_FOUND, description = <span class="jxr_string">"If the event has not been found."</span>),
<a class="jxr_linenumber" name="L2247" href="#L2247">2247</a>                   @RestResponse(responseCode = SC_OK, description = <span class="jxr_string">"The access information "</span>) })
<a class="jxr_linenumber" name="L2248" href="#L2248">2248</a>   <strong class="jxr_keyword">public</strong> Response getEventAccessInformation(@PathParam(<span class="jxr_string">"eventId"</span>) String eventId) <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L2249" href="#L2249">2249</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L2250" href="#L2250">2250</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L2251" href="#L2251">2251</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId);
<a class="jxr_linenumber" name="L2252" href="#L2252">2252</a> 
<a class="jxr_linenumber" name="L2253" href="#L2253">2253</a>     <em class="jxr_comment">// Add all available ACLs to the response</em>
<a class="jxr_linenumber" name="L2254" href="#L2254">2254</a>     JSONArray systemAclsJson = <strong class="jxr_keyword">new</strong> JSONArray();
<a class="jxr_linenumber" name="L2255" href="#L2255">2255</a>     List&lt;ManagedAcl&gt; acls = getAclService().getAcls();
<a class="jxr_linenumber" name="L2256" href="#L2256">2256</a>     <strong class="jxr_keyword">for</strong> (ManagedAcl acl : acls) {
<a class="jxr_linenumber" name="L2257" href="#L2257">2257</a>       systemAclsJson.add(AccessInformationUtil.serializeManagedAcl(acl));
<a class="jxr_linenumber" name="L2258" href="#L2258">2258</a>     }
<a class="jxr_linenumber" name="L2259" href="#L2259">2259</a> 
<a class="jxr_linenumber" name="L2260" href="#L2260">2260</a>     AccessControlList activeAcl = <strong class="jxr_keyword">new</strong> AccessControlList();
<a class="jxr_linenumber" name="L2261" href="#L2261">2261</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2262" href="#L2262">2262</a>       <strong class="jxr_keyword">if</strong> (optEvent.get().getAccessPolicy() != <strong class="jxr_keyword">null</strong>)
<a class="jxr_linenumber" name="L2263" href="#L2263">2263</a>         activeAcl = AccessControlParser.parseAcl(optEvent.get().getAccessPolicy());
<a class="jxr_linenumber" name="L2264" href="#L2264">2264</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L2265" href="#L2265">2265</a>       logger.error(<span class="jxr_string">"Unable to parse access policy"</span>, e);
<a class="jxr_linenumber" name="L2266" href="#L2266">2266</a>     }
<a class="jxr_linenumber" name="L2267" href="#L2267">2267</a>     Option&lt;ManagedAcl&gt; currentAcl = AccessInformationUtil.matchAclsLenient(acls, activeAcl,
<a class="jxr_linenumber" name="L2268" href="#L2268">2268</a>             getAdminUIConfiguration().getMatchManagedAclRolePrefixes());
<a class="jxr_linenumber" name="L2269" href="#L2269">2269</a> 
<a class="jxr_linenumber" name="L2270" href="#L2270">2270</a>     JSONObject episodeAccessJson = <strong class="jxr_keyword">new</strong> JSONObject();
<a class="jxr_linenumber" name="L2271" href="#L2271">2271</a>     episodeAccessJson.put(<span class="jxr_string">"current_acl"</span>, currentAcl.isSome() ? currentAcl.get().getId() : 0L);
<a class="jxr_linenumber" name="L2272" href="#L2272">2272</a>     episodeAccessJson.put(<span class="jxr_string">"acl"</span>, transformAccessControList(activeAcl, getUserDirectoryService()));
<a class="jxr_linenumber" name="L2273" href="#L2273">2273</a>     episodeAccessJson.put(<span class="jxr_string">"privileges"</span>, AccessInformationUtil.serializePrivilegesByRole(activeAcl));
<a class="jxr_linenumber" name="L2274" href="#L2274">2274</a>     <strong class="jxr_keyword">if</strong> (StringUtils.isNotBlank(optEvent.get().getWorkflowState())
<a class="jxr_linenumber" name="L2275" href="#L2275">2275</a>             &amp;&amp; WorkflowUtil.isActive(WorkflowInstance.WorkflowState.valueOf(optEvent.get().getWorkflowState())))
<a class="jxr_linenumber" name="L2276" href="#L2276">2276</a>       episodeAccessJson.put(<span class="jxr_string">"locked"</span>, <strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="L2277" href="#L2277">2277</a> 
<a class="jxr_linenumber" name="L2278" href="#L2278">2278</a>     JSONObject jsonReturnObj = <strong class="jxr_keyword">new</strong> JSONObject();
<a class="jxr_linenumber" name="L2279" href="#L2279">2279</a>     jsonReturnObj.put(<span class="jxr_string">"episode_access"</span>, episodeAccessJson);
<a class="jxr_linenumber" name="L2280" href="#L2280">2280</a>     jsonReturnObj.put(<span class="jxr_string">"system_acls"</span>, systemAclsJson);
<a class="jxr_linenumber" name="L2281" href="#L2281">2281</a> 
<a class="jxr_linenumber" name="L2282" href="#L2282">2282</a>     <strong class="jxr_keyword">return</strong> Response.ok(jsonReturnObj.toString()).build();
<a class="jxr_linenumber" name="L2283" href="#L2283">2283</a>   }
<a class="jxr_linenumber" name="L2284" href="#L2284">2284</a> 
<a class="jxr_linenumber" name="L2285" href="#L2285">2285</a>   <em class="jxr_comment">// MH-12085 Add manually uploaded assets, multipart file upload has to be a POST</em>
<a class="jxr_linenumber" name="L2286" href="#L2286">2286</a>   @POST
<a class="jxr_linenumber" name="L2287" href="#L2287">2287</a>   @Path(<span class="jxr_string">"{eventId}/assets"</span>)
<a class="jxr_linenumber" name="L2288" href="#L2288">2288</a>   @Consumes(MediaType.MULTIPART_FORM_DATA)
<a class="jxr_linenumber" name="L2289" href="#L2289">2289</a>   @RestQuery(name = <span class="jxr_string">"updateAssets"</span>, description = <span class="jxr_string">"Update or create an asset for the eventId by the given metadata as JSON and files in the body"</span>,
<a class="jxr_linenumber" name="L2290" href="#L2290">2290</a>   pathParameters = {
<a class="jxr_linenumber" name="L2291" href="#L2291">2291</a>   @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The event id"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) },
<a class="jxr_linenumber" name="L2292" href="#L2292">2292</a>   restParameters = {
<a class="jxr_linenumber" name="L2293" href="#L2293">2293</a>   @RestParameter(name = <span class="jxr_string">"metadata"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.TEXT, description = <span class="jxr_string">"The list of asset metadata"</span>) },
<a class="jxr_linenumber" name="L2294" href="#L2294">2294</a>   responses = {
<a class="jxr_linenumber" name="L2295" href="#L2295">2295</a>   @RestResponse(description = <span class="jxr_string">"The asset has been added."</span>, responseCode = HttpServletResponse.SC_OK),
<a class="jxr_linenumber" name="L2296" href="#L2296">2296</a>   @RestResponse(description = <span class="jxr_string">"Could not add asset, problem with the metadata or files."</span>, responseCode = HttpServletResponse.SC_BAD_REQUEST),
<a class="jxr_linenumber" name="L2297" href="#L2297">2297</a>   @RestResponse(description = <span class="jxr_string">"No event with this identifier was found."</span>, responseCode = HttpServletResponse.SC_NOT_FOUND) },
<a class="jxr_linenumber" name="L2298" href="#L2298">2298</a>   returnDescription = <span class="jxr_string">"The workflow identifier"</span>)
<a class="jxr_linenumber" name="L2299" href="#L2299">2299</a>   <strong class="jxr_keyword">public</strong> Response updateAssets(@PathParam(<span class="jxr_string">"eventId"</span>) <strong class="jxr_keyword">final</strong> String eventId,
<a class="jxr_linenumber" name="L2300" href="#L2300">2300</a>           @Context HttpServletRequest request)  <strong class="jxr_keyword">throws</strong> Exception {
<a class="jxr_linenumber" name="L2301" href="#L2301">2301</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2302" href="#L2302">2302</a>       MediaPackage mp = getMediaPackageByEventId(eventId);
<a class="jxr_linenumber" name="L2303" href="#L2303">2303</a>       String result = getIndexService().updateEventAssets(mp, request);
<a class="jxr_linenumber" name="L2304" href="#L2304">2304</a>       <strong class="jxr_keyword">return</strong> Response.status(Status.CREATED).entity(result).build();
<a class="jxr_linenumber" name="L2305" href="#L2305">2305</a>     }  <strong class="jxr_keyword">catch</strong> (NotFoundException e) {
<a class="jxr_linenumber" name="L2306" href="#L2306">2306</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId);
<a class="jxr_linenumber" name="L2307" href="#L2307">2307</a>     } <strong class="jxr_keyword">catch</strong> (IllegalArgumentException | UnsupportedAssetException e) {
<a class="jxr_linenumber" name="L2308" href="#L2308">2308</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.badRequest(e.getMessage());
<a class="jxr_linenumber" name="L2309" href="#L2309">2309</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L2310" href="#L2310">2310</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.serverError();
<a class="jxr_linenumber" name="L2311" href="#L2311">2311</a>     }
<a class="jxr_linenumber" name="L2312" href="#L2312">2312</a>   }
<a class="jxr_linenumber" name="L2313" href="#L2313">2313</a> 
<a class="jxr_linenumber" name="L2314" href="#L2314">2314</a>   @GET
<a class="jxr_linenumber" name="L2315" href="#L2315">2315</a>   @Path(<span class="jxr_string">"new/metadata"</span>)
<a class="jxr_linenumber" name="L2316" href="#L2316">2316</a>   @RestQuery(name = <span class="jxr_string">"getNewMetadata"</span>, description = <span class="jxr_string">"Returns all the data related to the metadata tab in the new event modal as JSON"</span>, returnDescription = <span class="jxr_string">"All the data related to the event metadata tab as JSON"</span>, responses = {
<a class="jxr_linenumber" name="L2317" href="#L2317">2317</a>           @RestResponse(responseCode = SC_OK, description = <span class="jxr_string">"Returns all the data related to the event metadata tab as JSON"</span>) })
<a class="jxr_linenumber" name="L2318" href="#L2318">2318</a>   <strong class="jxr_keyword">public</strong> Response getNewMetadata() {
<a class="jxr_linenumber" name="L2319" href="#L2319">2319</a>     MetadataList metadataList = <strong class="jxr_keyword">new</strong> MetadataList();
<a class="jxr_linenumber" name="L2320" href="#L2320">2320</a> 
<a class="jxr_linenumber" name="L2321" href="#L2321">2321</a>     <em class="jxr_comment">// Extended metadata</em>
<a class="jxr_linenumber" name="L2322" href="#L2322">2322</a>     List&lt;EventCatalogUIAdapter&gt; extendedCatalogUIAdapters = getIndexService().getExtendedEventCatalogUIAdapters();
<a class="jxr_linenumber" name="L2323" href="#L2323">2323</a>     <strong class="jxr_keyword">for</strong> (EventCatalogUIAdapter extendedCatalogUIAdapter : extendedCatalogUIAdapters) {
<a class="jxr_linenumber" name="L2324" href="#L2324">2324</a>       metadataList.add(extendedCatalogUIAdapter, extendedCatalogUIAdapter.getRawFields());
<a class="jxr_linenumber" name="L2325" href="#L2325">2325</a>     }
<a class="jxr_linenumber" name="L2326" href="#L2326">2326</a> 
<a class="jxr_linenumber" name="L2327" href="#L2327">2327</a>     <em class="jxr_comment">// Common metadata</em>
<a class="jxr_linenumber" name="L2328" href="#L2328">2328</a>     <em class="jxr_comment">// We do this after extended metadata because we want to overwrite any extended metadata adapters with the same</em>
<a class="jxr_linenumber" name="L2329" href="#L2329">2329</a>     <em class="jxr_comment">// flavor instead of the other way around.</em>
<a class="jxr_linenumber" name="L2330" href="#L2330">2330</a>     EventCatalogUIAdapter commonCatalogUiAdapter = getIndexService().getCommonEventCatalogUIAdapter();
<a class="jxr_linenumber" name="L2331" href="#L2331">2331</a>     DublinCoreMetadataCollection commonMetadata = commonCatalogUiAdapter.getRawFields(getCollectionQueryDisable());
<a class="jxr_linenumber" name="L2332" href="#L2332">2332</a> 
<a class="jxr_linenumber" name="L2333" href="#L2333">2333</a>     <strong class="jxr_keyword">if</strong> (commonMetadata.getOutputFields().containsKey(DublinCore.PROPERTY_CREATED.getLocalName()))
<a class="jxr_linenumber" name="L2334" href="#L2334">2334</a>       commonMetadata.removeField(commonMetadata.getOutputFields().get(DublinCore.PROPERTY_CREATED.getLocalName()));
<a class="jxr_linenumber" name="L2335" href="#L2335">2335</a>     <strong class="jxr_keyword">if</strong> (commonMetadata.getOutputFields().containsKey(<span class="jxr_string">"duration"</span>))
<a class="jxr_linenumber" name="L2336" href="#L2336">2336</a>       commonMetadata.removeField(commonMetadata.getOutputFields().get(<span class="jxr_string">"duration"</span>));
<a class="jxr_linenumber" name="L2337" href="#L2337">2337</a>     <strong class="jxr_keyword">if</strong> (commonMetadata.getOutputFields().containsKey(DublinCore.PROPERTY_IDENTIFIER.getLocalName()))
<a class="jxr_linenumber" name="L2338" href="#L2338">2338</a>       commonMetadata.removeField(commonMetadata.getOutputFields().get(DublinCore.PROPERTY_IDENTIFIER.getLocalName()));
<a class="jxr_linenumber" name="L2339" href="#L2339">2339</a>     <strong class="jxr_keyword">if</strong> (commonMetadata.getOutputFields().containsKey(DublinCore.PROPERTY_SOURCE.getLocalName()))
<a class="jxr_linenumber" name="L2340" href="#L2340">2340</a>       commonMetadata.removeField(commonMetadata.getOutputFields().get(DublinCore.PROPERTY_SOURCE.getLocalName()));
<a class="jxr_linenumber" name="L2341" href="#L2341">2341</a>     <strong class="jxr_keyword">if</strong> (commonMetadata.getOutputFields().containsKey(<span class="jxr_string">"startDate"</span>))
<a class="jxr_linenumber" name="L2342" href="#L2342">2342</a>       commonMetadata.removeField(commonMetadata.getOutputFields().get(<span class="jxr_string">"startDate"</span>));
<a class="jxr_linenumber" name="L2343" href="#L2343">2343</a>     <strong class="jxr_keyword">if</strong> (commonMetadata.getOutputFields().containsKey(<span class="jxr_string">"startTime"</span>))
<a class="jxr_linenumber" name="L2344" href="#L2344">2344</a>       commonMetadata.removeField(commonMetadata.getOutputFields().get(<span class="jxr_string">"startTime"</span>));
<a class="jxr_linenumber" name="L2345" href="#L2345">2345</a>     <strong class="jxr_keyword">if</strong> (commonMetadata.getOutputFields().containsKey(<span class="jxr_string">"location"</span>))
<a class="jxr_linenumber" name="L2346" href="#L2346">2346</a>       commonMetadata.removeField(commonMetadata.getOutputFields().get(<span class="jxr_string">"location"</span>));
<a class="jxr_linenumber" name="L2347" href="#L2347">2347</a> 
<a class="jxr_linenumber" name="L2348" href="#L2348">2348</a>     <em class="jxr_comment">// Set publisher to user</em>
<a class="jxr_linenumber" name="L2349" href="#L2349">2349</a>     <strong class="jxr_keyword">if</strong> (commonMetadata.getOutputFields().containsKey(DublinCore.PROPERTY_PUBLISHER.getLocalName())) {
<a class="jxr_linenumber" name="L2350" href="#L2350">2350</a>       MetadataField publisher = commonMetadata.getOutputFields().get(DublinCore.PROPERTY_PUBLISHER.getLocalName());
<a class="jxr_linenumber" name="L2351" href="#L2351">2351</a>       Map&lt;String, String&gt; users = <strong class="jxr_keyword">new</strong> HashMap&lt;&gt;();
<a class="jxr_linenumber" name="L2352" href="#L2352">2352</a>       <strong class="jxr_keyword">if</strong> (publisher.getCollection() != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L2353" href="#L2353">2353</a>         users = publisher.getCollection();
<a class="jxr_linenumber" name="L2354" href="#L2354">2354</a>       }
<a class="jxr_linenumber" name="L2355" href="#L2355">2355</a>       String loggedInUser = getSecurityService().getUser().getName();
<a class="jxr_linenumber" name="L2356" href="#L2356">2356</a>       <strong class="jxr_keyword">if</strong> (!users.containsKey(loggedInUser)) {
<a class="jxr_linenumber" name="L2357" href="#L2357">2357</a>         users.put(loggedInUser, loggedInUser);
<a class="jxr_linenumber" name="L2358" href="#L2358">2358</a>       }
<a class="jxr_linenumber" name="L2359" href="#L2359">2359</a>       publisher.setValue(loggedInUser);
<a class="jxr_linenumber" name="L2360" href="#L2360">2360</a>     }
<a class="jxr_linenumber" name="L2361" href="#L2361">2361</a> 
<a class="jxr_linenumber" name="L2362" href="#L2362">2362</a>     metadataList.add(commonCatalogUiAdapter, commonMetadata);
<a class="jxr_linenumber" name="L2363" href="#L2363">2363</a> 
<a class="jxr_linenumber" name="L2364" href="#L2364">2364</a>     <em class="jxr_comment">// remove series with empty titles from the collection of the isPartOf field as these can't be converted to json</em>
<a class="jxr_linenumber" name="L2365" href="#L2365">2365</a>     removeSeriesWithNullTitlesFromFieldCollection(metadataList);
<a class="jxr_linenumber" name="L2366" href="#L2366">2366</a> 
<a class="jxr_linenumber" name="L2367" href="#L2367">2367</a>     <strong class="jxr_keyword">return</strong> okJson(MetadataJson.listToJson(metadataList, <strong class="jxr_keyword">true</strong>));
<a class="jxr_linenumber" name="L2368" href="#L2368">2368</a>   }
<a class="jxr_linenumber" name="L2369" href="#L2369">2369</a> 
<a class="jxr_linenumber" name="L2370" href="#L2370">2370</a>   @GET
<a class="jxr_linenumber" name="L2371" href="#L2371">2371</a>   @Path(<span class="jxr_string">"new/processing"</span>)
<a class="jxr_linenumber" name="L2372" href="#L2372">2372</a>   @RestQuery(name = <span class="jxr_string">"getNewProcessing"</span>, description = <span class="jxr_string">"Returns all the data related to the processing tab in the new event modal as JSON"</span>, returnDescription = <span class="jxr_string">"All the data related to the event processing tab as JSON"</span>, restParameters = {
<a class="jxr_linenumber" name="L2373" href="#L2373">2373</a>           @RestParameter(name = <span class="jxr_string">"tags"</span>, isRequired = false, description = <span class="jxr_string">"A comma separated list of tags to filter the workflow definitions"</span>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L2374" href="#L2374">2374</a>                   @RestResponse(responseCode = SC_OK, description = <span class="jxr_string">"Returns all the data related to the event processing tab as JSON"</span>) })
<a class="jxr_linenumber" name="L2375" href="#L2375">2375</a>   <strong class="jxr_keyword">public</strong> Response getNewProcessing(@QueryParam(<span class="jxr_string">"tags"</span>) String tagsString) {
<a class="jxr_linenumber" name="L2376" href="#L2376">2376</a>     List&lt;String&gt; tags = RestUtil.splitCommaSeparatedParam(Option.option(tagsString)).value();
<a class="jxr_linenumber" name="L2377" href="#L2377">2377</a> 
<a class="jxr_linenumber" name="L2378" href="#L2378">2378</a>     List&lt;JValue&gt; workflows = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2379" href="#L2379">2379</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2380" href="#L2380">2380</a>       List&lt;WorkflowDefinition&gt; workflowsDefinitions = getWorkflowService().listAvailableWorkflowDefinitions();
<a class="jxr_linenumber" name="L2381" href="#L2381">2381</a>       <strong class="jxr_keyword">for</strong> (WorkflowDefinition wflDef : workflowsDefinitions) {
<a class="jxr_linenumber" name="L2382" href="#L2382">2382</a>         <strong class="jxr_keyword">if</strong> (wflDef.containsTag(tags)) {
<a class="jxr_linenumber" name="L2383" href="#L2383">2383</a> 
<a class="jxr_linenumber" name="L2384" href="#L2384">2384</a>           workflows.add(obj(f(<span class="jxr_string">"id"</span>, v(wflDef.getId())), f(<span class="jxr_string">"tags"</span>, arr(wflDef.getTags())),
<a class="jxr_linenumber" name="L2385" href="#L2385">2385</a>                   f(<span class="jxr_string">"title"</span>, v(nul(wflDef.getTitle()).getOr(<span class="jxr_string">""</span>))),
<a class="jxr_linenumber" name="L2386" href="#L2386">2386</a>                   f(<span class="jxr_string">"description"</span>, v(nul(wflDef.getDescription()).getOr(<span class="jxr_string">""</span>))),
<a class="jxr_linenumber" name="L2387" href="#L2387">2387</a>                   f(<span class="jxr_string">"displayOrder"</span>, v(wflDef.getDisplayOrder())),
<a class="jxr_linenumber" name="L2388" href="#L2388">2388</a>                   f(<span class="jxr_string">"configuration_panel"</span>, v(nul(wflDef.getConfigurationPanel()).getOr(<span class="jxr_string">""</span>))),
<a class="jxr_linenumber" name="L2389" href="#L2389">2389</a>                   f(<span class="jxr_string">"configuration_panel_json"</span>, v(nul(wflDef.getConfigurationPanelJson()).getOr(<span class="jxr_string">""</span>)))));
<a class="jxr_linenumber" name="L2390" href="#L2390">2390</a>         }
<a class="jxr_linenumber" name="L2391" href="#L2391">2391</a>       }
<a class="jxr_linenumber" name="L2392" href="#L2392">2392</a>     } <strong class="jxr_keyword">catch</strong> (WorkflowDatabaseException e) {
<a class="jxr_linenumber" name="L2393" href="#L2393">2393</a>       logger.error(<span class="jxr_string">"Unable to get available workflow definitions"</span>, e);
<a class="jxr_linenumber" name="L2394" href="#L2394">2394</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.serverError();
<a class="jxr_linenumber" name="L2395" href="#L2395">2395</a>     }
<a class="jxr_linenumber" name="L2396" href="#L2396">2396</a> 
<a class="jxr_linenumber" name="L2397" href="#L2397">2397</a>     JValue data = obj(f(<span class="jxr_string">"workflows"</span>,arr(workflows)), f(<span class="jxr_string">"default_workflow_id"</span>,v(defaultWorkflowDefinionId,Jsons.NULL)));
<a class="jxr_linenumber" name="L2398" href="#L2398">2398</a> 
<a class="jxr_linenumber" name="L2399" href="#L2399">2399</a>     <strong class="jxr_keyword">return</strong> okJson(data);
<a class="jxr_linenumber" name="L2400" href="#L2400">2400</a>   }
<a class="jxr_linenumber" name="L2401" href="#L2401">2401</a> 
<a class="jxr_linenumber" name="L2402" href="#L2402">2402</a>   @POST
<a class="jxr_linenumber" name="L2403" href="#L2403">2403</a>   @Path(<span class="jxr_string">"new/conflicts"</span>)
<a class="jxr_linenumber" name="L2404" href="#L2404">2404</a>   @RestQuery(name = <span class="jxr_string">"checkNewConflicts"</span>, description = <span class="jxr_string">"Checks if the current scheduler parameters are in a conflict with another event"</span>, returnDescription = <span class="jxr_string">"Returns NO CONTENT if no event are in conflict within specified period or list of conflicting recordings in JSON"</span>, restParameters = {
<a class="jxr_linenumber" name="L2405" href="#L2405">2405</a>           @RestParameter(name = <span class="jxr_string">"metadata"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The metadata as JSON"</span>, type = RestParameter.Type.TEXT) }, responses = {
<a class="jxr_linenumber" name="L2406" href="#L2406">2406</a>                   @RestResponse(responseCode = HttpServletResponse.SC_NO_CONTENT, description = <span class="jxr_string">"No conflicting events found"</span>),
<a class="jxr_linenumber" name="L2407" href="#L2407">2407</a>                   @RestResponse(responseCode = HttpServletResponse.SC_CONFLICT, description = <span class="jxr_string">"There is a conflict"</span>),
<a class="jxr_linenumber" name="L2408" href="#L2408">2408</a>                   @RestResponse(responseCode = HttpServletResponse.SC_BAD_REQUEST, description = <span class="jxr_string">"Missing or invalid parameters"</span>) })
<a class="jxr_linenumber" name="L2409" href="#L2409">2409</a>   <strong class="jxr_keyword">public</strong> Response getNewConflicts(@FormParam(<span class="jxr_string">"metadata"</span>) String metadata) <strong class="jxr_keyword">throws</strong> NotFoundException {
<a class="jxr_linenumber" name="L2410" href="#L2410">2410</a>     <strong class="jxr_keyword">if</strong> (StringUtils.isBlank(metadata)) {
<a class="jxr_linenumber" name="L2411" href="#L2411">2411</a>       logger.warn(<span class="jxr_string">"Metadata is not specified"</span>);
<a class="jxr_linenumber" name="L2412" href="#L2412">2412</a>       <strong class="jxr_keyword">return</strong> Response.status(Status.BAD_REQUEST).build();
<a class="jxr_linenumber" name="L2413" href="#L2413">2413</a>     }
<a class="jxr_linenumber" name="L2414" href="#L2414">2414</a> 
<a class="jxr_linenumber" name="L2415" href="#L2415">2415</a>     JSONParser parser = <strong class="jxr_keyword">new</strong> JSONParser();
<a class="jxr_linenumber" name="L2416" href="#L2416">2416</a>     JSONObject metadataJson;
<a class="jxr_linenumber" name="L2417" href="#L2417">2417</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2418" href="#L2418">2418</a>       metadataJson = (JSONObject) parser.parse(metadata);
<a class="jxr_linenumber" name="L2419" href="#L2419">2419</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L2420" href="#L2420">2420</a>       logger.warn(<span class="jxr_string">"Unable to parse metadata {}"</span>, metadata);
<a class="jxr_linenumber" name="L2421" href="#L2421">2421</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.badRequest(<span class="jxr_string">"Unable to parse metadata"</span>);
<a class="jxr_linenumber" name="L2422" href="#L2422">2422</a>     }
<a class="jxr_linenumber" name="L2423" href="#L2423">2423</a> 
<a class="jxr_linenumber" name="L2424" href="#L2424">2424</a>     String device;
<a class="jxr_linenumber" name="L2425" href="#L2425">2425</a>     String startDate;
<a class="jxr_linenumber" name="L2426" href="#L2426">2426</a>     String endDate;
<a class="jxr_linenumber" name="L2427" href="#L2427">2427</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2428" href="#L2428">2428</a>       device = (String) metadataJson.get(<span class="jxr_string">"device"</span>);
<a class="jxr_linenumber" name="L2429" href="#L2429">2429</a>       startDate = (String) metadataJson.get(<span class="jxr_string">"start"</span>);
<a class="jxr_linenumber" name="L2430" href="#L2430">2430</a>       endDate = (String) metadataJson.get(<span class="jxr_string">"end"</span>);
<a class="jxr_linenumber" name="L2431" href="#L2431">2431</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L2432" href="#L2432">2432</a>       logger.warn(<span class="jxr_string">"Unable to parse metadata {}"</span>, metadata);
<a class="jxr_linenumber" name="L2433" href="#L2433">2433</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.badRequest(<span class="jxr_string">"Unable to parse metadata"</span>);
<a class="jxr_linenumber" name="L2434" href="#L2434">2434</a>     }
<a class="jxr_linenumber" name="L2435" href="#L2435">2435</a> 
<a class="jxr_linenumber" name="L2436" href="#L2436">2436</a>     <strong class="jxr_keyword">if</strong> (StringUtils.isBlank(device) || StringUtils.isBlank(startDate) || StringUtils.isBlank(endDate)) {
<a class="jxr_linenumber" name="L2437" href="#L2437">2437</a>       logger.warn(<span class="jxr_string">"Either device, start date or end date were not specified"</span>);
<a class="jxr_linenumber" name="L2438" href="#L2438">2438</a>       <strong class="jxr_keyword">return</strong> Response.status(Status.BAD_REQUEST).build();
<a class="jxr_linenumber" name="L2439" href="#L2439">2439</a>     }
<a class="jxr_linenumber" name="L2440" href="#L2440">2440</a> 
<a class="jxr_linenumber" name="L2441" href="#L2441">2441</a>     Date start;
<a class="jxr_linenumber" name="L2442" href="#L2442">2442</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2443" href="#L2443">2443</a>       start = <strong class="jxr_keyword">new</strong> Date(DateTimeSupport.fromUTC(startDate));
<a class="jxr_linenumber" name="L2444" href="#L2444">2444</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L2445" href="#L2445">2445</a>       logger.warn(<span class="jxr_string">"Unable to parse start date {}"</span>, startDate);
<a class="jxr_linenumber" name="L2446" href="#L2446">2446</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.badRequest(<span class="jxr_string">"Unable to parse start date"</span>);
<a class="jxr_linenumber" name="L2447" href="#L2447">2447</a>     }
<a class="jxr_linenumber" name="L2448" href="#L2448">2448</a> 
<a class="jxr_linenumber" name="L2449" href="#L2449">2449</a>     Date end;
<a class="jxr_linenumber" name="L2450" href="#L2450">2450</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2451" href="#L2451">2451</a>       end = <strong class="jxr_keyword">new</strong> Date(DateTimeSupport.fromUTC(endDate));
<a class="jxr_linenumber" name="L2452" href="#L2452">2452</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L2453" href="#L2453">2453</a>       logger.warn(<span class="jxr_string">"Unable to parse end date {}"</span>, endDate);
<a class="jxr_linenumber" name="L2454" href="#L2454">2454</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.badRequest(<span class="jxr_string">"Unable to parse end date"</span>);
<a class="jxr_linenumber" name="L2455" href="#L2455">2455</a>     }
<a class="jxr_linenumber" name="L2456" href="#L2456">2456</a> 
<a class="jxr_linenumber" name="L2457" href="#L2457">2457</a>     String rruleString = (String) metadataJson.get(<span class="jxr_string">"rrule"</span>);
<a class="jxr_linenumber" name="L2458" href="#L2458">2458</a> 
<a class="jxr_linenumber" name="L2459" href="#L2459">2459</a>     RRule rrule = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L2460" href="#L2460">2460</a>     TimeZone timeZone = TimeZone.getDefault();
<a class="jxr_linenumber" name="L2461" href="#L2461">2461</a>     String durationString = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L2462" href="#L2462">2462</a>     <strong class="jxr_keyword">if</strong> (StringUtils.isNotEmpty(rruleString)) {
<a class="jxr_linenumber" name="L2463" href="#L2463">2463</a>       <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2464" href="#L2464">2464</a>         rrule = <strong class="jxr_keyword">new</strong> RRule(rruleString);
<a class="jxr_linenumber" name="L2465" href="#L2465">2465</a>         rrule.validate();
<a class="jxr_linenumber" name="L2466" href="#L2466">2466</a>       } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L2467" href="#L2467">2467</a>         logger.warn(<span class="jxr_string">"Unable to parse rrule {}: {}"</span>, rruleString, e.getMessage());
<a class="jxr_linenumber" name="L2468" href="#L2468">2468</a>         <strong class="jxr_keyword">return</strong> Response.status(Status.BAD_REQUEST).build();
<a class="jxr_linenumber" name="L2469" href="#L2469">2469</a>       }
<a class="jxr_linenumber" name="L2470" href="#L2470">2470</a> 
<a class="jxr_linenumber" name="L2471" href="#L2471">2471</a>       durationString = (String) metadataJson.get(<span class="jxr_string">"duration"</span>);
<a class="jxr_linenumber" name="L2472" href="#L2472">2472</a>       <strong class="jxr_keyword">if</strong> (StringUtils.isBlank(durationString)) {
<a class="jxr_linenumber" name="L2473" href="#L2473">2473</a>         logger.warn(<span class="jxr_string">"If checking recurrence, must include duration."</span>);
<a class="jxr_linenumber" name="L2474" href="#L2474">2474</a>         <strong class="jxr_keyword">return</strong> Response.status(Status.BAD_REQUEST).build();
<a class="jxr_linenumber" name="L2475" href="#L2475">2475</a>       }
<a class="jxr_linenumber" name="L2476" href="#L2476">2476</a> 
<a class="jxr_linenumber" name="L2477" href="#L2477">2477</a>       Agent agent = getCaptureAgentStateService().getAgent(device);
<a class="jxr_linenumber" name="L2478" href="#L2478">2478</a>       String timezone = agent.getConfiguration().getProperty(<span class="jxr_string">"capture.device.timezone"</span>);
<a class="jxr_linenumber" name="L2479" href="#L2479">2479</a>       <strong class="jxr_keyword">if</strong> (StringUtils.isBlank(timezone)) {
<a class="jxr_linenumber" name="L2480" href="#L2480">2480</a>         timezone = TimeZone.getDefault().getID();
<a class="jxr_linenumber" name="L2481" href="#L2481">2481</a>         logger.warn(<span class="jxr_string">"No 'capture.device.timezone' set on agent {}. The default server timezone {} will be used."</span>,
<a class="jxr_linenumber" name="L2482" href="#L2482">2482</a>                 device, timezone);
<a class="jxr_linenumber" name="L2483" href="#L2483">2483</a>       }
<a class="jxr_linenumber" name="L2484" href="#L2484">2484</a>       timeZone = TimeZone.getTimeZone(timezone);
<a class="jxr_linenumber" name="L2485" href="#L2485">2485</a>     }
<a class="jxr_linenumber" name="L2486" href="#L2486">2486</a> 
<a class="jxr_linenumber" name="L2487" href="#L2487">2487</a>     String eventId = (String) metadataJson.get(<span class="jxr_string">"id"</span>);
<a class="jxr_linenumber" name="L2488" href="#L2488">2488</a> 
<a class="jxr_linenumber" name="L2489" href="#L2489">2489</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2490" href="#L2490">2490</a>       List&lt;MediaPackage&gt; events = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L2491" href="#L2491">2491</a>       <strong class="jxr_keyword">if</strong> (StringUtils.isNotEmpty(rruleString)) {
<a class="jxr_linenumber" name="L2492" href="#L2492">2492</a>         events = getSchedulerService().findConflictingEvents(device, rrule, start, end, Long.parseLong(durationString),
<a class="jxr_linenumber" name="L2493" href="#L2493">2493</a>                 timeZone);
<a class="jxr_linenumber" name="L2494" href="#L2494">2494</a>       } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L2495" href="#L2495">2495</a>         events = getSchedulerService().findConflictingEvents(device, start, end);
<a class="jxr_linenumber" name="L2496" href="#L2496">2496</a>       }
<a class="jxr_linenumber" name="L2497" href="#L2497">2497</a>       <strong class="jxr_keyword">if</strong> (!events.isEmpty()) {
<a class="jxr_linenumber" name="L2498" href="#L2498">2498</a>         <strong class="jxr_keyword">final</strong> List&lt;JValue&gt; eventsJSON = convertToConflictObjects(eventId, events);
<a class="jxr_linenumber" name="L2499" href="#L2499">2499</a>         <strong class="jxr_keyword">if</strong> (!eventsJSON.isEmpty())
<a class="jxr_linenumber" name="L2500" href="#L2500">2500</a>           <strong class="jxr_keyword">return</strong> conflictJson(arr(eventsJSON));
<a class="jxr_linenumber" name="L2501" href="#L2501">2501</a>       }
<a class="jxr_linenumber" name="L2502" href="#L2502">2502</a>       <strong class="jxr_keyword">return</strong> Response.noContent().build();
<a class="jxr_linenumber" name="L2503" href="#L2503">2503</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L2504" href="#L2504">2504</a>       logger.error(<span class="jxr_string">"Unable to find conflicting events for {}, {}, {}"</span>,
<a class="jxr_linenumber" name="L2505" href="#L2505">2505</a>               device, startDate, endDate, e);
<a class="jxr_linenumber" name="L2506" href="#L2506">2506</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.serverError();
<a class="jxr_linenumber" name="L2507" href="#L2507">2507</a>     }
<a class="jxr_linenumber" name="L2508" href="#L2508">2508</a>   }
<a class="jxr_linenumber" name="L2509" href="#L2509">2509</a> 
<a class="jxr_linenumber" name="L2510" href="#L2510">2510</a>   <strong class="jxr_keyword">private</strong> List&lt;JValue&gt; convertToConflictObjects(<strong class="jxr_keyword">final</strong> String eventId, <strong class="jxr_keyword">final</strong> List&lt;MediaPackage&gt; events) <strong class="jxr_keyword">throws</strong> SearchIndexException {
<a class="jxr_linenumber" name="L2511" href="#L2511">2511</a>     <strong class="jxr_keyword">final</strong> List&lt;JValue&gt; eventsJSON = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2512" href="#L2512">2512</a>     <strong class="jxr_keyword">final</strong> Organization organization = getSecurityService().getOrganization();
<a class="jxr_linenumber" name="L2513" href="#L2513">2513</a>     <strong class="jxr_keyword">final</strong> User user = SecurityUtil.createSystemUser(systemUserName, organization);
<a class="jxr_linenumber" name="L2514" href="#L2514">2514</a> 
<a class="jxr_linenumber" name="L2515" href="#L2515">2515</a>     SecurityUtil.runAs(getSecurityService(), organization, user, () -&gt; {
<a class="jxr_linenumber" name="L2516" href="#L2516">2516</a>       <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2517" href="#L2517">2517</a>         <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> MediaPackage event : events) {
<a class="jxr_linenumber" name="L2518" href="#L2518">2518</a>           <strong class="jxr_keyword">final</strong> Opt&lt;Event&gt; eventOpt = getIndexService().getEvent(event.getIdentifier().toString(), getIndex());
<a class="jxr_linenumber" name="L2519" href="#L2519">2519</a>           <strong class="jxr_keyword">if</strong> (eventOpt.isSome()) {
<a class="jxr_linenumber" name="L2520" href="#L2520">2520</a>             <strong class="jxr_keyword">final</strong> Event e = eventOpt.get();
<a class="jxr_linenumber" name="L2521" href="#L2521">2521</a>             <strong class="jxr_keyword">if</strong> (StringUtils.isNotEmpty(eventId) &amp;&amp; eventId.equals(e.getIdentifier())) {
<a class="jxr_linenumber" name="L2522" href="#L2522">2522</a>               <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="L2523" href="#L2523">2523</a>             }
<a class="jxr_linenumber" name="L2524" href="#L2524">2524</a>             eventsJSON.add(convertEventToConflictingObject(e.getTechnicalStartTime(), e.getTechnicalEndTime(), e.getTitle()));
<a class="jxr_linenumber" name="L2525" href="#L2525">2525</a>           } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L2526" href="#L2526">2526</a>             logger.warn(<span class="jxr_string">"Index out of sync! Conflicting event catalog {} not found on event index!"</span>,
<a class="jxr_linenumber" name="L2527" href="#L2527">2527</a>               event.getIdentifier().toString());
<a class="jxr_linenumber" name="L2528" href="#L2528">2528</a>           }
<a class="jxr_linenumber" name="L2529" href="#L2529">2529</a>         }
<a class="jxr_linenumber" name="L2530" href="#L2530">2530</a>       } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L2531" href="#L2531">2531</a>          logger.error(<span class="jxr_string">"Failed to get conflicting events"</span>, e);
<a class="jxr_linenumber" name="L2532" href="#L2532">2532</a>       }
<a class="jxr_linenumber" name="L2533" href="#L2533">2533</a>     });
<a class="jxr_linenumber" name="L2534" href="#L2534">2534</a> 
<a class="jxr_linenumber" name="L2535" href="#L2535">2535</a>     <strong class="jxr_keyword">return</strong> eventsJSON;
<a class="jxr_linenumber" name="L2536" href="#L2536">2536</a>   }
<a class="jxr_linenumber" name="L2537" href="#L2537">2537</a> 
<a class="jxr_linenumber" name="L2538" href="#L2538">2538</a>   <strong class="jxr_keyword">private</strong> JValue convertEventToConflictingObject(<strong class="jxr_keyword">final</strong> String start, <strong class="jxr_keyword">final</strong> String end, <strong class="jxr_keyword">final</strong> String title) {
<a class="jxr_linenumber" name="L2539" href="#L2539">2539</a>     <strong class="jxr_keyword">return</strong> obj(
<a class="jxr_linenumber" name="L2540" href="#L2540">2540</a>       f(<span class="jxr_string">"start"</span>, v(start)),
<a class="jxr_linenumber" name="L2541" href="#L2541">2541</a>       f(<span class="jxr_string">"end"</span>, v(end)),
<a class="jxr_linenumber" name="L2542" href="#L2542">2542</a>       f(<span class="jxr_string">"title"</span>, v(title))
<a class="jxr_linenumber" name="L2543" href="#L2543">2543</a>     );
<a class="jxr_linenumber" name="L2544" href="#L2544">2544</a>   }
<a class="jxr_linenumber" name="L2545" href="#L2545">2545</a> 
<a class="jxr_linenumber" name="L2546" href="#L2546">2546</a>   @POST
<a class="jxr_linenumber" name="L2547" href="#L2547">2547</a>   @Path(<span class="jxr_string">"/new"</span>)
<a class="jxr_linenumber" name="L2548" href="#L2548">2548</a>   @Consumes(MediaType.MULTIPART_FORM_DATA)
<a class="jxr_linenumber" name="L2549" href="#L2549">2549</a>   @RestQuery(name = <span class="jxr_string">"createNewEvent"</span>, description = <span class="jxr_string">"Creates a new event by the given metadata as JSON and the files in the body"</span>, returnDescription = <span class="jxr_string">"The workflow identifier"</span>, restParameters = {
<a class="jxr_linenumber" name="L2550" href="#L2550">2550</a>           @RestParameter(name = <span class="jxr_string">"metadata"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The metadata as JSON"</span>, type = RestParameter.Type.TEXT) }, responses = {
<a class="jxr_linenumber" name="L2551" href="#L2551">2551</a>                   @RestResponse(responseCode = HttpServletResponse.SC_CREATED, description = <span class="jxr_string">"Event sucessfully added"</span>),
<a class="jxr_linenumber" name="L2552" href="#L2552">2552</a>                   @RestResponse(responseCode = SC_BAD_REQUEST, description = <span class="jxr_string">"If the metadata is not set or couldn't be parsed"</span>) })
<a class="jxr_linenumber" name="L2553" href="#L2553">2553</a>   <strong class="jxr_keyword">public</strong> Response createNewEvent(@Context HttpServletRequest request) {
<a class="jxr_linenumber" name="L2554" href="#L2554">2554</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2555" href="#L2555">2555</a>       String result = getIndexService().createEvent(request);
<a class="jxr_linenumber" name="L2556" href="#L2556">2556</a>       <strong class="jxr_keyword">if</strong> (StringUtils.isEmpty(result)) {
<a class="jxr_linenumber" name="L2557" href="#L2557">2557</a>         <strong class="jxr_keyword">return</strong> RestUtil.R.badRequest(<span class="jxr_string">"The date range provided did not include any events"</span>);
<a class="jxr_linenumber" name="L2558" href="#L2558">2558</a>       }
<a class="jxr_linenumber" name="L2559" href="#L2559">2559</a>       <strong class="jxr_keyword">return</strong> Response.status(Status.CREATED).entity(result).build();
<a class="jxr_linenumber" name="L2560" href="#L2560">2560</a>     } <strong class="jxr_keyword">catch</strong> (IllegalArgumentException | UnsupportedAssetException e) {
<a class="jxr_linenumber" name="L2561" href="#L2561">2561</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.badRequest(e.getMessage());
<a class="jxr_linenumber" name="L2562" href="#L2562">2562</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L2563" href="#L2563">2563</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.serverError();
<a class="jxr_linenumber" name="L2564" href="#L2564">2564</a>     }
<a class="jxr_linenumber" name="L2565" href="#L2565">2565</a>   }
<a class="jxr_linenumber" name="L2566" href="#L2566">2566</a> 
<a class="jxr_linenumber" name="L2567" href="#L2567">2567</a>   @GET
<a class="jxr_linenumber" name="L2568" href="#L2568">2568</a>   @Path(<span class="jxr_string">"events.json"</span>)
<a class="jxr_linenumber" name="L2569" href="#L2569">2569</a>   @Produces(MediaType.APPLICATION_JSON)
<a class="jxr_linenumber" name="L2570" href="#L2570">2570</a>   @RestQuery(name = <span class="jxr_string">"getevents"</span>, description = <span class="jxr_string">"Returns all the events as JSON"</span>, returnDescription = <span class="jxr_string">"All the events as JSON"</span>, restParameters = {
<a class="jxr_linenumber" name="L2571" href="#L2571">2571</a>           @RestParameter(name = <span class="jxr_string">"filter"</span>, isRequired = false, description = <span class="jxr_string">"The filter used for the query. They should be formated like that: 'filter1:value1,filter2:value2'"</span>, type = STRING),
<a class="jxr_linenumber" name="L2572" href="#L2572">2572</a>           @RestParameter(name = <span class="jxr_string">"sort"</span>, description = <span class="jxr_string">"The order instructions used to sort the query result. Must be in the form '&lt;field name&gt;:(ASC|DESC)'"</span>, isRequired = false, type = STRING),
<a class="jxr_linenumber" name="L2573" href="#L2573">2573</a>           @RestParameter(name = <span class="jxr_string">"limit"</span>, description = <span class="jxr_string">"The maximum number of items to return per page."</span>, isRequired = false, type = RestParameter.Type.INTEGER),
<a class="jxr_linenumber" name="L2574" href="#L2574">2574</a>           @RestParameter(name = <span class="jxr_string">"offset"</span>, description = <span class="jxr_string">"The page number."</span>, isRequired = false, type = RestParameter.Type.INTEGER),
<a class="jxr_linenumber" name="L2575" href="#L2575">2575</a>           @RestParameter(name = <span class="jxr_string">"getComments"</span>, description = <span class="jxr_string">"If comments should be fetched"</span>, isRequired = false, type = RestParameter.Type.BOOLEAN) }, responses = {
<a class="jxr_linenumber" name="L2576" href="#L2576">2576</a>                   @RestResponse(description = <span class="jxr_string">"Returns all events as JSON"</span>, responseCode = HttpServletResponse.SC_OK) })
<a class="jxr_linenumber" name="L2577" href="#L2577">2577</a>   <strong class="jxr_keyword">public</strong> Response getEvents(@QueryParam(<span class="jxr_string">"id"</span>) String id, @QueryParam(<span class="jxr_string">"commentReason"</span>) String reasonFilter,
<a class="jxr_linenumber" name="L2578" href="#L2578">2578</a>           @QueryParam(<span class="jxr_string">"commentResolution"</span>) String resolutionFilter, @QueryParam(<span class="jxr_string">"filter"</span>) String filter,
<a class="jxr_linenumber" name="L2579" href="#L2579">2579</a>           @QueryParam(<span class="jxr_string">"sort"</span>) String sort, @QueryParam(<span class="jxr_string">"offset"</span>) Integer offset, @QueryParam(<span class="jxr_string">"limit"</span>) Integer limit,
<a class="jxr_linenumber" name="L2580" href="#L2580">2580</a>           @QueryParam(<span class="jxr_string">"getComments"</span>) Boolean getComments) {
<a class="jxr_linenumber" name="L2581" href="#L2581">2581</a> 
<a class="jxr_linenumber" name="L2582" href="#L2582">2582</a>     Option&lt;Integer&gt; optLimit = Option.option(limit);
<a class="jxr_linenumber" name="L2583" href="#L2583">2583</a>     Option&lt;Integer&gt; optOffset = Option.option(offset);
<a class="jxr_linenumber" name="L2584" href="#L2584">2584</a>     Option&lt;String&gt; optSort = Option.option(trimToNull(sort));
<a class="jxr_linenumber" name="L2585" href="#L2585">2585</a>     Option&lt;Boolean&gt; optGetComments = Option.option(getComments);
<a class="jxr_linenumber" name="L2586" href="#L2586">2586</a>     ArrayList&lt;JValue&gt; eventsList = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2587" href="#L2587">2587</a>     <strong class="jxr_keyword">final</strong> Organization organization = getSecurityService().getOrganization();
<a class="jxr_linenumber" name="L2588" href="#L2588">2588</a>     <strong class="jxr_keyword">final</strong> User user = getSecurityService().getUser();
<a class="jxr_linenumber" name="L2589" href="#L2589">2589</a>     <strong class="jxr_keyword">if</strong> (organization == <strong class="jxr_keyword">null</strong> || user == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L2590" href="#L2590">2590</a>       <strong class="jxr_keyword">return</strong> Response.status(SC_SERVICE_UNAVAILABLE).build();
<a class="jxr_linenumber" name="L2591" href="#L2591">2591</a>     }
<a class="jxr_linenumber" name="L2592" href="#L2592">2592</a>     EventSearchQuery query = <strong class="jxr_keyword">new</strong> EventSearchQuery(organization.getId(), user);
<a class="jxr_linenumber" name="L2593" href="#L2593">2593</a> 
<a class="jxr_linenumber" name="L2594" href="#L2594">2594</a>     <em class="jxr_comment">// If the limit is set to 0, this is not taken into account</em>
<a class="jxr_linenumber" name="L2595" href="#L2595">2595</a>     <strong class="jxr_keyword">if</strong> (optLimit.isSome() &amp;&amp; limit == 0) {
<a class="jxr_linenumber" name="L2596" href="#L2596">2596</a>       optLimit = Option.none();
<a class="jxr_linenumber" name="L2597" href="#L2597">2597</a>     }
<a class="jxr_linenumber" name="L2598" href="#L2598">2598</a> 
<a class="jxr_linenumber" name="L2599" href="#L2599">2599</a>     Map&lt;String, String&gt; filters = RestUtils.parseFilter(filter);
<a class="jxr_linenumber" name="L2600" href="#L2600">2600</a>     <strong class="jxr_keyword">for</strong> (String name : filters.keySet()) {
<a class="jxr_linenumber" name="L2601" href="#L2601">2601</a>       <strong class="jxr_keyword">if</strong> (EventListQuery.FILTER_PRESENTERS_BIBLIOGRAPHIC_NAME.equals(name))
<a class="jxr_linenumber" name="L2602" href="#L2602">2602</a>         query.withPresenter(filters.get(name));
<a class="jxr_linenumber" name="L2603" href="#L2603">2603</a>       <strong class="jxr_keyword">if</strong> (EventListQuery.FILTER_PRESENTERS_TECHNICAL_NAME.equals(name))
<a class="jxr_linenumber" name="L2604" href="#L2604">2604</a>         query.withTechnicalPresenters(filters.get(name));
<a class="jxr_linenumber" name="L2605" href="#L2605">2605</a>       <strong class="jxr_keyword">if</strong> (EventListQuery.FILTER_CONTRIBUTORS_NAME.equals(name))
<a class="jxr_linenumber" name="L2606" href="#L2606">2606</a>         query.withContributor(filters.get(name));
<a class="jxr_linenumber" name="L2607" href="#L2607">2607</a>       <strong class="jxr_keyword">if</strong> (EventListQuery.FILTER_LOCATION_NAME.equals(name))
<a class="jxr_linenumber" name="L2608" href="#L2608">2608</a>         query.withLocation(filters.get(name));
<a class="jxr_linenumber" name="L2609" href="#L2609">2609</a>       <strong class="jxr_keyword">if</strong> (EventListQuery.FILTER_AGENT_NAME.equals(name))
<a class="jxr_linenumber" name="L2610" href="#L2610">2610</a>         query.withAgentId(filters.get(name));
<a class="jxr_linenumber" name="L2611" href="#L2611">2611</a>       <strong class="jxr_keyword">if</strong> (EventListQuery.FILTER_TEXT_NAME.equals(name))
<a class="jxr_linenumber" name="L2612" href="#L2612">2612</a>         query.withText(filters.get(name));
<a class="jxr_linenumber" name="L2613" href="#L2613">2613</a>       <strong class="jxr_keyword">if</strong> (EventListQuery.FILTER_SERIES_NAME.equals(name))
<a class="jxr_linenumber" name="L2614" href="#L2614">2614</a>         query.withSeriesId(filters.get(name));
<a class="jxr_linenumber" name="L2615" href="#L2615">2615</a>       <strong class="jxr_keyword">if</strong> (EventListQuery.FILTER_STATUS_NAME.equals(name))
<a class="jxr_linenumber" name="L2616" href="#L2616">2616</a>         query.withEventStatus(filters.get(name));
<a class="jxr_linenumber" name="L2617" href="#L2617">2617</a>       <strong class="jxr_keyword">if</strong> (EventListQuery.FILTER_PUBLISHER_NAME.equals(name))
<a class="jxr_linenumber" name="L2618" href="#L2618">2618</a>         query.withPublisher(filters.get(name));
<a class="jxr_linenumber" name="L2619" href="#L2619">2619</a>       <strong class="jxr_keyword">if</strong> (EventListQuery.FILTER_COMMENTS_NAME.equals(name)) {
<a class="jxr_linenumber" name="L2620" href="#L2620">2620</a>         <strong class="jxr_keyword">switch</strong> (Comments.valueOf(filters.get(name))) {
<a class="jxr_linenumber" name="L2621" href="#L2621">2621</a>           <strong class="jxr_keyword">case</strong> NONE:
<a class="jxr_linenumber" name="L2622" href="#L2622">2622</a>             query.withComments(false);
<a class="jxr_linenumber" name="L2623" href="#L2623">2623</a>             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L2624" href="#L2624">2624</a>           <strong class="jxr_keyword">case</strong> OPEN:
<a class="jxr_linenumber" name="L2625" href="#L2625">2625</a>             query.withOpenComments(<strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="L2626" href="#L2626">2626</a>             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L2627" href="#L2627">2627</a>           <strong class="jxr_keyword">case</strong> RESOLVED:
<a class="jxr_linenumber" name="L2628" href="#L2628">2628</a>             query.withComments(<strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="L2629" href="#L2629">2629</a>             query.withOpenComments(false);
<a class="jxr_linenumber" name="L2630" href="#L2630">2630</a>             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L2631" href="#L2631">2631</a>           <strong class="jxr_keyword">default</strong>:
<a class="jxr_linenumber" name="L2632" href="#L2632">2632</a>             logger.info(<span class="jxr_string">"Unknown comment {}"</span>, filters.get(name));
<a class="jxr_linenumber" name="L2633" href="#L2633">2633</a>             <strong class="jxr_keyword">return</strong> Response.status(SC_BAD_REQUEST).build();
<a class="jxr_linenumber" name="L2634" href="#L2634">2634</a>         }
<a class="jxr_linenumber" name="L2635" href="#L2635">2635</a>       }
<a class="jxr_linenumber" name="L2636" href="#L2636">2636</a>       <strong class="jxr_keyword">if</strong> (EventListQuery.FILTER_IS_PUBLISHED_NAME.equals(name)) {
<a class="jxr_linenumber" name="L2637" href="#L2637">2637</a>         <strong class="jxr_keyword">if</strong> (filters.containsKey(name)) {
<a class="jxr_linenumber" name="L2638" href="#L2638">2638</a>           <strong class="jxr_keyword">switch</strong> (IsPublished.valueOf(filters.get(name))) {
<a class="jxr_linenumber" name="L2639" href="#L2639">2639</a>             <strong class="jxr_keyword">case</strong> YES:
<a class="jxr_linenumber" name="L2640" href="#L2640">2640</a>               query.withIsPublished(<strong class="jxr_keyword">true</strong>);
<a class="jxr_linenumber" name="L2641" href="#L2641">2641</a>               <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L2642" href="#L2642">2642</a>             <strong class="jxr_keyword">case</strong> NO:
<a class="jxr_linenumber" name="L2643" href="#L2643">2643</a>               query.withIsPublished(false);
<a class="jxr_linenumber" name="L2644" href="#L2644">2644</a>               <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L2645" href="#L2645">2645</a>             <strong class="jxr_keyword">default</strong>:
<a class="jxr_linenumber" name="L2646" href="#L2646">2646</a>               <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L2647" href="#L2647">2647</a>           }
<a class="jxr_linenumber" name="L2648" href="#L2648">2648</a>         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L2649" href="#L2649">2649</a>           logger.info(<span class="jxr_string">"Query for invalid published status: {}"</span>, filters.get(name));
<a class="jxr_linenumber" name="L2650" href="#L2650">2650</a>           <strong class="jxr_keyword">return</strong> Response.status(SC_BAD_REQUEST).build();
<a class="jxr_linenumber" name="L2651" href="#L2651">2651</a>         }
<a class="jxr_linenumber" name="L2652" href="#L2652">2652</a>       }
<a class="jxr_linenumber" name="L2653" href="#L2653">2653</a>       <strong class="jxr_keyword">if</strong> (EventListQuery.FILTER_STARTDATE_NAME.equals(name)) {
<a class="jxr_linenumber" name="L2654" href="#L2654">2654</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2655" href="#L2655">2655</a>           Tuple&lt;Date, Date&gt; fromAndToCreationRange = RestUtils.getFromAndToDateRange(filters.get(name));
<a class="jxr_linenumber" name="L2656" href="#L2656">2656</a>           query.withStartFrom(fromAndToCreationRange.getA());
<a class="jxr_linenumber" name="L2657" href="#L2657">2657</a>           query.withStartTo(fromAndToCreationRange.getB());
<a class="jxr_linenumber" name="L2658" href="#L2658">2658</a>         } <strong class="jxr_keyword">catch</strong> (IllegalArgumentException e) {
<a class="jxr_linenumber" name="L2659" href="#L2659">2659</a>           <strong class="jxr_keyword">return</strong> RestUtil.R.badRequest(e.getMessage());
<a class="jxr_linenumber" name="L2660" href="#L2660">2660</a>         }
<a class="jxr_linenumber" name="L2661" href="#L2661">2661</a>       }
<a class="jxr_linenumber" name="L2662" href="#L2662">2662</a>     }
<a class="jxr_linenumber" name="L2663" href="#L2663">2663</a> 
<a class="jxr_linenumber" name="L2664" href="#L2664">2664</a>     <strong class="jxr_keyword">if</strong> (optSort.isSome()) {
<a class="jxr_linenumber" name="L2665" href="#L2665">2665</a>       ArrayList&lt;SortCriterion&gt; sortCriteria = RestUtils.parseSortQueryParameter(optSort.get());
<a class="jxr_linenumber" name="L2666" href="#L2666">2666</a>       <strong class="jxr_keyword">for</strong> (SortCriterion criterion : sortCriteria) {
<a class="jxr_linenumber" name="L2667" href="#L2667">2667</a>         <strong class="jxr_keyword">switch</strong> (criterion.getFieldName()) {
<a class="jxr_linenumber" name="L2668" href="#L2668">2668</a>           <strong class="jxr_keyword">case</strong> EventIndexSchema.UID:
<a class="jxr_linenumber" name="L2669" href="#L2669">2669</a>             query.sortByUID(criterion.getOrder());
<a class="jxr_linenumber" name="L2670" href="#L2670">2670</a>             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L2671" href="#L2671">2671</a>           <strong class="jxr_keyword">case</strong> EventIndexSchema.TITLE:
<a class="jxr_linenumber" name="L2672" href="#L2672">2672</a>             query.sortByTitle(criterion.getOrder());
<a class="jxr_linenumber" name="L2673" href="#L2673">2673</a>             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L2674" href="#L2674">2674</a>           <strong class="jxr_keyword">case</strong> EventIndexSchema.PRESENTER:
<a class="jxr_linenumber" name="L2675" href="#L2675">2675</a>             query.sortByPresenter(criterion.getOrder());
<a class="jxr_linenumber" name="L2676" href="#L2676">2676</a>             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L2677" href="#L2677">2677</a>           <strong class="jxr_keyword">case</strong> EventIndexSchema.TECHNICAL_START:
<a class="jxr_linenumber" name="L2678" href="#L2678">2678</a>           <strong class="jxr_keyword">case</strong> <span class="jxr_string">"technical_date"</span>:
<a class="jxr_linenumber" name="L2679" href="#L2679">2679</a>             query.sortByTechnicalStartDate(criterion.getOrder());
<a class="jxr_linenumber" name="L2680" href="#L2680">2680</a>             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L2681" href="#L2681">2681</a>           <strong class="jxr_keyword">case</strong> EventIndexSchema.TECHNICAL_END:
<a class="jxr_linenumber" name="L2682" href="#L2682">2682</a>             query.sortByTechnicalEndDate(criterion.getOrder());
<a class="jxr_linenumber" name="L2683" href="#L2683">2683</a>             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L2684" href="#L2684">2684</a>           <strong class="jxr_keyword">case</strong> EventIndexSchema.PUBLICATION:
<a class="jxr_linenumber" name="L2685" href="#L2685">2685</a>             query.sortByPublicationIgnoringInternal(criterion.getOrder());
<a class="jxr_linenumber" name="L2686" href="#L2686">2686</a>             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L2687" href="#L2687">2687</a>           <strong class="jxr_keyword">case</strong> EventIndexSchema.START_DATE:
<a class="jxr_linenumber" name="L2688" href="#L2688">2688</a>           <strong class="jxr_keyword">case</strong> <span class="jxr_string">"date"</span>:
<a class="jxr_linenumber" name="L2689" href="#L2689">2689</a>             query.sortByStartDate(criterion.getOrder());
<a class="jxr_linenumber" name="L2690" href="#L2690">2690</a>             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L2691" href="#L2691">2691</a>           <strong class="jxr_keyword">case</strong> EventIndexSchema.END_DATE:
<a class="jxr_linenumber" name="L2692" href="#L2692">2692</a>             query.sortByEndDate(criterion.getOrder());
<a class="jxr_linenumber" name="L2693" href="#L2693">2693</a>             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L2694" href="#L2694">2694</a>           <strong class="jxr_keyword">case</strong> EventIndexSchema.SERIES_NAME:
<a class="jxr_linenumber" name="L2695" href="#L2695">2695</a>             query.sortBySeriesName(criterion.getOrder());
<a class="jxr_linenumber" name="L2696" href="#L2696">2696</a>             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L2697" href="#L2697">2697</a>           <strong class="jxr_keyword">case</strong> EventIndexSchema.LOCATION:
<a class="jxr_linenumber" name="L2698" href="#L2698">2698</a>             query.sortByLocation(criterion.getOrder());
<a class="jxr_linenumber" name="L2699" href="#L2699">2699</a>             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L2700" href="#L2700">2700</a>           <strong class="jxr_keyword">case</strong> EventIndexSchema.EVENT_STATUS:
<a class="jxr_linenumber" name="L2701" href="#L2701">2701</a>             query.sortByEventStatus(criterion.getOrder());
<a class="jxr_linenumber" name="L2702" href="#L2702">2702</a>             <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L2703" href="#L2703">2703</a>           <strong class="jxr_keyword">default</strong>:
<a class="jxr_linenumber" name="L2704" href="#L2704">2704</a>             <strong class="jxr_keyword">final</strong> String msg = String.format(<span class="jxr_string">"Unknown sort criteria field %s"</span>, criterion.getFieldName());
<a class="jxr_linenumber" name="L2705" href="#L2705">2705</a>             logger.debug(msg);
<a class="jxr_linenumber" name="L2706" href="#L2706">2706</a>             <strong class="jxr_keyword">return</strong> RestUtil.R.badRequest(msg);
<a class="jxr_linenumber" name="L2707" href="#L2707">2707</a>         }
<a class="jxr_linenumber" name="L2708" href="#L2708">2708</a>       }
<a class="jxr_linenumber" name="L2709" href="#L2709">2709</a>     }
<a class="jxr_linenumber" name="L2710" href="#L2710">2710</a> 
<a class="jxr_linenumber" name="L2711" href="#L2711">2711</a>     <em class="jxr_comment">// We search for write actions</em>
<a class="jxr_linenumber" name="L2712" href="#L2712">2712</a>     <strong class="jxr_keyword">if</strong> (getOnlyEventsWithWriteAccessEventsTab()) {
<a class="jxr_linenumber" name="L2713" href="#L2713">2713</a>       query.withoutActions();
<a class="jxr_linenumber" name="L2714" href="#L2714">2714</a>       query.withAction(Permissions.Action.WRITE);
<a class="jxr_linenumber" name="L2715" href="#L2715">2715</a>       query.withAction(Permissions.Action.READ);
<a class="jxr_linenumber" name="L2716" href="#L2716">2716</a>     }
<a class="jxr_linenumber" name="L2717" href="#L2717">2717</a> 
<a class="jxr_linenumber" name="L2718" href="#L2718">2718</a>     <strong class="jxr_keyword">if</strong> (optLimit.isSome())
<a class="jxr_linenumber" name="L2719" href="#L2719">2719</a>       query.withLimit(optLimit.get());
<a class="jxr_linenumber" name="L2720" href="#L2720">2720</a>     <strong class="jxr_keyword">if</strong> (optOffset.isSome())
<a class="jxr_linenumber" name="L2721" href="#L2721">2721</a>       query.withOffset(offset);
<a class="jxr_linenumber" name="L2722" href="#L2722">2722</a>     <em class="jxr_comment">// TODO: Add other filters to the query</em>
<a class="jxr_linenumber" name="L2723" href="#L2723">2723</a> 
<a class="jxr_linenumber" name="L2724" href="#L2724">2724</a>     SearchResult&lt;Event&gt; results = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L2725" href="#L2725">2725</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2726" href="#L2726">2726</a>       results = getIndex().getByQuery(query);
<a class="jxr_linenumber" name="L2727" href="#L2727">2727</a>     } <strong class="jxr_keyword">catch</strong> (SearchIndexException e) {
<a class="jxr_linenumber" name="L2728" href="#L2728">2728</a>       logger.error(<span class="jxr_string">"The admin UI Search Index was not able to get the events list:"</span>, e);
<a class="jxr_linenumber" name="L2729" href="#L2729">2729</a>       <strong class="jxr_keyword">return</strong> RestUtil.R.serverError();
<a class="jxr_linenumber" name="L2730" href="#L2730">2730</a>     }
<a class="jxr_linenumber" name="L2731" href="#L2731">2731</a> 
<a class="jxr_linenumber" name="L2732" href="#L2732">2732</a>     <em class="jxr_comment">// If the results list if empty, we return already a response.</em>
<a class="jxr_linenumber" name="L2733" href="#L2733">2733</a>     <strong class="jxr_keyword">if</strong> (results.getPageSize() == 0) {
<a class="jxr_linenumber" name="L2734" href="#L2734">2734</a>       logger.debug(<span class="jxr_string">"No events match the given filters."</span>);
<a class="jxr_linenumber" name="L2735" href="#L2735">2735</a>       <strong class="jxr_keyword">return</strong> okJsonList(eventsList, nul(offset).getOr(0), nul(limit).getOr(0), 0);
<a class="jxr_linenumber" name="L2736" href="#L2736">2736</a>     }
<a class="jxr_linenumber" name="L2737" href="#L2737">2737</a> 
<a class="jxr_linenumber" name="L2738" href="#L2738">2738</a>     <strong class="jxr_keyword">for</strong> (SearchResultItem&lt;Event&gt; item : results.getItems()) {
<a class="jxr_linenumber" name="L2739" href="#L2739">2739</a>       Event source = item.getSource();
<a class="jxr_linenumber" name="L2740" href="#L2740">2740</a>       source.updatePreview(getAdminUIConfiguration().getPreviewSubtype());
<a class="jxr_linenumber" name="L2741" href="#L2741">2741</a>       List&lt;EventComment&gt; comments = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L2742" href="#L2742">2742</a>       <strong class="jxr_keyword">if</strong> (optGetComments.isSome() &amp;&amp; optGetComments.get()) {
<a class="jxr_linenumber" name="L2743" href="#L2743">2743</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2744" href="#L2744">2744</a>           comments = getEventCommentService().getComments(source.getIdentifier());
<a class="jxr_linenumber" name="L2745" href="#L2745">2745</a>         } <strong class="jxr_keyword">catch</strong> (EventCommentException e) {
<a class="jxr_linenumber" name="L2746" href="#L2746">2746</a>           logger.error(<span class="jxr_string">"Unable to get comments from event {}"</span>, source.getIdentifier(), e);
<a class="jxr_linenumber" name="L2747" href="#L2747">2747</a>           <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> WebApplicationException(e);
<a class="jxr_linenumber" name="L2748" href="#L2748">2748</a>         }
<a class="jxr_linenumber" name="L2749" href="#L2749">2749</a>       }
<a class="jxr_linenumber" name="L2750" href="#L2750">2750</a>       eventsList.add(eventToJSON(source, Optional.ofNullable(comments)));
<a class="jxr_linenumber" name="L2751" href="#L2751">2751</a>     }
<a class="jxr_linenumber" name="L2752" href="#L2752">2752</a> 
<a class="jxr_linenumber" name="L2753" href="#L2753">2753</a>     <strong class="jxr_keyword">return</strong> okJsonList(eventsList, nul(offset).getOr(0), nul(limit).getOr(0), results.getHitCount());
<a class="jxr_linenumber" name="L2754" href="#L2754">2754</a>   }
<a class="jxr_linenumber" name="L2755" href="#L2755">2755</a> 
<a class="jxr_linenumber" name="L2756" href="#L2756">2756</a>   <em class="jxr_comment">// --</em>
<a class="jxr_linenumber" name="L2757" href="#L2757">2757</a> 
<a class="jxr_linenumber" name="L2758" href="#L2758">2758</a>   <strong class="jxr_keyword">private</strong> MediaPackage getMediaPackageByEventId(String eventId)
<a class="jxr_linenumber" name="L2759" href="#L2759">2759</a>           <strong class="jxr_keyword">throws</strong> SearchIndexException, NotFoundException, IndexServiceException {
<a class="jxr_linenumber" name="L2760" href="#L2760">2760</a>     Opt&lt;Event&gt; optEvent = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L2761" href="#L2761">2761</a>     <strong class="jxr_keyword">if</strong> (optEvent.isNone())
<a class="jxr_linenumber" name="L2762" href="#L2762">2762</a>       <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> NotFoundException(format(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, eventId));
<a class="jxr_linenumber" name="L2763" href="#L2763">2763</a>     <strong class="jxr_keyword">return</strong> getIndexService().getEventMediapackage(optEvent.get());
<a class="jxr_linenumber" name="L2764" href="#L2764">2764</a>   }
<a class="jxr_linenumber" name="L2765" href="#L2765">2765</a> 
<a class="jxr_linenumber" name="L2766" href="#L2766">2766</a>   <strong class="jxr_keyword">private</strong> URI getCommentUrl(String eventId, <strong class="jxr_keyword">long</strong> commentId) {
<a class="jxr_linenumber" name="L2767" href="#L2767">2767</a>     <strong class="jxr_keyword">return</strong> UrlSupport.uri(serverUrl, eventId, <span class="jxr_string">"comment"</span>, Long.toString(commentId));
<a class="jxr_linenumber" name="L2768" href="#L2768">2768</a>   }
<a class="jxr_linenumber" name="L2769" href="#L2769">2769</a> 
<a class="jxr_linenumber" name="L2770" href="#L2770">2770</a>   <strong class="jxr_keyword">private</strong> JValue eventToJSON(Event event, Optional&lt;List&lt;EventComment&gt;&gt; comments) {
<a class="jxr_linenumber" name="L2771" href="#L2771">2771</a>     List&lt;Field&gt; fields = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2772" href="#L2772">2772</a> 
<a class="jxr_linenumber" name="L2773" href="#L2773">2773</a>     fields.add(f(<span class="jxr_string">"id"</span>, v(event.getIdentifier())));
<a class="jxr_linenumber" name="L2774" href="#L2774">2774</a>     fields.add(f(<span class="jxr_string">"title"</span>, v(event.getTitle(), BLANK)));
<a class="jxr_linenumber" name="L2775" href="#L2775">2775</a>     fields.add(f(<span class="jxr_string">"source"</span>, v(event.getSource(), BLANK)));
<a class="jxr_linenumber" name="L2776" href="#L2776">2776</a>     fields.add(f(<span class="jxr_string">"presenters"</span>, arr($(event.getPresenters()).map(Functions.stringToJValue))));
<a class="jxr_linenumber" name="L2777" href="#L2777">2777</a>     <strong class="jxr_keyword">if</strong> (StringUtils.isNotBlank(event.getSeriesId())) {
<a class="jxr_linenumber" name="L2778" href="#L2778">2778</a>       String seriesTitle = event.getSeriesName();
<a class="jxr_linenumber" name="L2779" href="#L2779">2779</a>       String seriesID = event.getSeriesId();
<a class="jxr_linenumber" name="L2780" href="#L2780">2780</a> 
<a class="jxr_linenumber" name="L2781" href="#L2781">2781</a>       fields.add(f(<span class="jxr_string">"series"</span>, obj(f(<span class="jxr_string">"id"</span>, v(seriesID, BLANK)), f(<span class="jxr_string">"title"</span>, v(seriesTitle, BLANK)))));
<a class="jxr_linenumber" name="L2782" href="#L2782">2782</a>     }
<a class="jxr_linenumber" name="L2783" href="#L2783">2783</a>     fields.add(f(<span class="jxr_string">"location"</span>, v(event.getLocation(), BLANK)));
<a class="jxr_linenumber" name="L2784" href="#L2784">2784</a>     fields.add(f(<span class="jxr_string">"start_date"</span>, v(event.getRecordingStartDate(), BLANK)));
<a class="jxr_linenumber" name="L2785" href="#L2785">2785</a>     fields.add(f(<span class="jxr_string">"end_date"</span>, v(event.getRecordingEndDate(), BLANK)));
<a class="jxr_linenumber" name="L2786" href="#L2786">2786</a>     fields.add(f(<span class="jxr_string">"managedAcl"</span>, v(event.getManagedAcl(), BLANK)));
<a class="jxr_linenumber" name="L2787" href="#L2787">2787</a>     fields.add(f(<span class="jxr_string">"workflow_state"</span>, v(event.getWorkflowState(), BLANK)));
<a class="jxr_linenumber" name="L2788" href="#L2788">2788</a>     fields.add(f(<span class="jxr_string">"event_status"</span>, v(event.getEventStatus())));
<a class="jxr_linenumber" name="L2789" href="#L2789">2789</a>     fields.add(f(<span class="jxr_string">"displayable_status"</span>, v(event.getDisplayableStatus(getWorkflowService().getWorkflowStateMappings()))));
<a class="jxr_linenumber" name="L2790" href="#L2790">2790</a>     fields.add(f(<span class="jxr_string">"source"</span>, v(getIndexService().getEventSource(event).toString())));
<a class="jxr_linenumber" name="L2791" href="#L2791">2791</a>     fields.add(f(<span class="jxr_string">"has_comments"</span>, v(event.hasComments())));
<a class="jxr_linenumber" name="L2792" href="#L2792">2792</a>     fields.add(f(<span class="jxr_string">"has_open_comments"</span>, v(event.hasOpenComments())));
<a class="jxr_linenumber" name="L2793" href="#L2793">2793</a>     fields.add(f(<span class="jxr_string">"needs_cutting"</span>, v(event.needsCutting())));
<a class="jxr_linenumber" name="L2794" href="#L2794">2794</a>     fields.add(f(<span class="jxr_string">"has_preview"</span>, v(event.hasPreview())));
<a class="jxr_linenumber" name="L2795" href="#L2795">2795</a>     fields.add(f(<span class="jxr_string">"agent_id"</span>, v(event.getAgentId(), BLANK)));
<a class="jxr_linenumber" name="L2796" href="#L2796">2796</a>     fields.add(f(<span class="jxr_string">"technical_start"</span>, v(event.getTechnicalStartTime(), BLANK)));
<a class="jxr_linenumber" name="L2797" href="#L2797">2797</a>     fields.add(f(<span class="jxr_string">"technical_end"</span>, v(event.getTechnicalEndTime(), BLANK)));
<a class="jxr_linenumber" name="L2798" href="#L2798">2798</a>     fields.add(f(<span class="jxr_string">"technical_presenters"</span>, arr($(event.getTechnicalPresenters()).map(Functions.stringToJValue))));
<a class="jxr_linenumber" name="L2799" href="#L2799">2799</a>     fields.add(f(<span class="jxr_string">"publications"</span>, arr(eventPublicationsToJson(event))));
<a class="jxr_linenumber" name="L2800" href="#L2800">2800</a>     <strong class="jxr_keyword">if</strong> (comments.isPresent()) {
<a class="jxr_linenumber" name="L2801" href="#L2801">2801</a>       fields.add(f(<span class="jxr_string">"comments"</span>, arr(eventCommentsToJson(comments.get()))));
<a class="jxr_linenumber" name="L2802" href="#L2802">2802</a>     }
<a class="jxr_linenumber" name="L2803" href="#L2803">2803</a>     <strong class="jxr_keyword">return</strong> obj(fields);
<a class="jxr_linenumber" name="L2804" href="#L2804">2804</a>   }
<a class="jxr_linenumber" name="L2805" href="#L2805">2805</a> 
<a class="jxr_linenumber" name="L2806" href="#L2806">2806</a>   <strong class="jxr_keyword">private</strong> JValue attachmentToJSON(Attachment attachment) {
<a class="jxr_linenumber" name="L2807" href="#L2807">2807</a>     List&lt;Field&gt; fields = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2808" href="#L2808">2808</a>     fields.addAll(getEventMediaPackageElementFields(attachment));
<a class="jxr_linenumber" name="L2809" href="#L2809">2809</a>     fields.addAll(getCommonElementFields(attachment));
<a class="jxr_linenumber" name="L2810" href="#L2810">2810</a>     <strong class="jxr_keyword">return</strong> obj(fields);
<a class="jxr_linenumber" name="L2811" href="#L2811">2811</a>   }
<a class="jxr_linenumber" name="L2812" href="#L2812">2812</a> 
<a class="jxr_linenumber" name="L2813" href="#L2813">2813</a>   <strong class="jxr_keyword">private</strong> JValue catalogToJSON(Catalog catalog) {
<a class="jxr_linenumber" name="L2814" href="#L2814">2814</a>     List&lt;Field&gt; fields = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2815" href="#L2815">2815</a>     fields.addAll(getEventMediaPackageElementFields(catalog));
<a class="jxr_linenumber" name="L2816" href="#L2816">2816</a>     fields.addAll(getCommonElementFields(catalog));
<a class="jxr_linenumber" name="L2817" href="#L2817">2817</a>     <strong class="jxr_keyword">return</strong> obj(fields);
<a class="jxr_linenumber" name="L2818" href="#L2818">2818</a>   }
<a class="jxr_linenumber" name="L2819" href="#L2819">2819</a> 
<a class="jxr_linenumber" name="L2820" href="#L2820">2820</a>   <strong class="jxr_keyword">private</strong> JValue trackToJSON(Track track) {
<a class="jxr_linenumber" name="L2821" href="#L2821">2821</a>     List&lt;Field&gt; fields = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2822" href="#L2822">2822</a>     fields.addAll(getEventMediaPackageElementFields(track));
<a class="jxr_linenumber" name="L2823" href="#L2823">2823</a>     fields.addAll(getCommonElementFields(track));
<a class="jxr_linenumber" name="L2824" href="#L2824">2824</a>     fields.add(f(<span class="jxr_string">"duration"</span>, v(track.getDuration(), BLANK)));
<a class="jxr_linenumber" name="L2825" href="#L2825">2825</a>     fields.add(f(<span class="jxr_string">"has_audio"</span>, v(track.hasAudio())));
<a class="jxr_linenumber" name="L2826" href="#L2826">2826</a>     fields.add(f(<span class="jxr_string">"has_video"</span>, v(track.hasVideo())));
<a class="jxr_linenumber" name="L2827" href="#L2827">2827</a>     fields.add(f(<span class="jxr_string">"has_subtitle"</span>, v(track.hasSubtitle())));
<a class="jxr_linenumber" name="L2828" href="#L2828">2828</a>     fields.add(f(<span class="jxr_string">"streams"</span>, obj(streamsToJSON(track.getStreams()))));
<a class="jxr_linenumber" name="L2829" href="#L2829">2829</a>     <strong class="jxr_keyword">return</strong> obj(fields);
<a class="jxr_linenumber" name="L2830" href="#L2830">2830</a>   }
<a class="jxr_linenumber" name="L2831" href="#L2831">2831</a> 
<a class="jxr_linenumber" name="L2832" href="#L2832">2832</a>   <strong class="jxr_keyword">private</strong> List&lt;Field&gt; streamsToJSON(org.opencastproject.mediapackage.Stream[] streams) {
<a class="jxr_linenumber" name="L2833" href="#L2833">2833</a>     List&lt;Field&gt; fields = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2834" href="#L2834">2834</a>     List&lt;JValue&gt; audioList = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2835" href="#L2835">2835</a>     List&lt;JValue&gt; videoList = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2836" href="#L2836">2836</a>     List&lt;JValue&gt; subtitleList = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2837" href="#L2837">2837</a>     <strong class="jxr_keyword">for</strong> (org.opencastproject.mediapackage.Stream stream : streams) {
<a class="jxr_linenumber" name="L2838" href="#L2838">2838</a>       <em class="jxr_comment">// TODO There is a bug with the stream ids, see MH-10325</em>
<a class="jxr_linenumber" name="L2839" href="#L2839">2839</a>       <strong class="jxr_keyword">if</strong> (stream instanceof AudioStreamImpl) {
<a class="jxr_linenumber" name="L2840" href="#L2840">2840</a>         List&lt;Field&gt; audio = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2841" href="#L2841">2841</a>         AudioStream audioStream = (AudioStream) stream;
<a class="jxr_linenumber" name="L2842" href="#L2842">2842</a>         audio.add(f(<span class="jxr_string">"id"</span>, v(audioStream.getIdentifier(), BLANK)));
<a class="jxr_linenumber" name="L2843" href="#L2843">2843</a>         audio.add(f(<span class="jxr_string">"type"</span>, v(audioStream.getFormat(), BLANK)));
<a class="jxr_linenumber" name="L2844" href="#L2844">2844</a>         audio.add(f(<span class="jxr_string">"channels"</span>, v(audioStream.getChannels(), BLANK)));
<a class="jxr_linenumber" name="L2845" href="#L2845">2845</a>         audio.add(f(<span class="jxr_string">"bitrate"</span>, v(audioStream.getBitRate(), BLANK)));
<a class="jxr_linenumber" name="L2846" href="#L2846">2846</a>         audio.add(f(<span class="jxr_string">"bitdepth"</span>, v(audioStream.getBitDepth(), BLANK)));
<a class="jxr_linenumber" name="L2847" href="#L2847">2847</a>         audio.add(f(<span class="jxr_string">"samplingrate"</span>, v(audioStream.getSamplingRate(), BLANK)));
<a class="jxr_linenumber" name="L2848" href="#L2848">2848</a>         audio.add(f(<span class="jxr_string">"framecount"</span>, v(audioStream.getFrameCount(), BLANK)));
<a class="jxr_linenumber" name="L2849" href="#L2849">2849</a>         audio.add(f(<span class="jxr_string">"peakleveldb"</span>, v(audioStream.getPkLevDb(), BLANK)));
<a class="jxr_linenumber" name="L2850" href="#L2850">2850</a>         audio.add(f(<span class="jxr_string">"rmsleveldb"</span>, v(audioStream.getRmsLevDb(), BLANK)));
<a class="jxr_linenumber" name="L2851" href="#L2851">2851</a>         audio.add(f(<span class="jxr_string">"rmspeakdb"</span>, v(audioStream.getRmsPkDb(), BLANK)));
<a class="jxr_linenumber" name="L2852" href="#L2852">2852</a>         audioList.add(obj(audio));
<a class="jxr_linenumber" name="L2853" href="#L2853">2853</a>       } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (stream instanceof VideoStreamImpl) {
<a class="jxr_linenumber" name="L2854" href="#L2854">2854</a>         List&lt;Field&gt; video = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2855" href="#L2855">2855</a>         VideoStream videoStream = (VideoStream) stream;
<a class="jxr_linenumber" name="L2856" href="#L2856">2856</a>         video.add(f(<span class="jxr_string">"id"</span>, v(videoStream.getIdentifier(), BLANK)));
<a class="jxr_linenumber" name="L2857" href="#L2857">2857</a>         video.add(f(<span class="jxr_string">"type"</span>, v(videoStream.getFormat(), BLANK)));
<a class="jxr_linenumber" name="L2858" href="#L2858">2858</a>         video.add(f(<span class="jxr_string">"bitrate"</span>, v(videoStream.getBitRate(), BLANK)));
<a class="jxr_linenumber" name="L2859" href="#L2859">2859</a>         video.add(f(<span class="jxr_string">"framerate"</span>, v(videoStream.getFrameRate(), BLANK)));
<a class="jxr_linenumber" name="L2860" href="#L2860">2860</a>         video.add(f(<span class="jxr_string">"resolution"</span>, v(videoStream.getFrameWidth() + <span class="jxr_string">"x"</span> + videoStream.getFrameHeight(), BLANK)));
<a class="jxr_linenumber" name="L2861" href="#L2861">2861</a>         video.add(f(<span class="jxr_string">"framecount"</span>, v(videoStream.getFrameCount(), BLANK)));
<a class="jxr_linenumber" name="L2862" href="#L2862">2862</a>         video.add(f(<span class="jxr_string">"scantype"</span>, v(videoStream.getScanType(), BLANK)));
<a class="jxr_linenumber" name="L2863" href="#L2863">2863</a>         video.add(f(<span class="jxr_string">"scanorder"</span>, v(videoStream.getScanOrder(), BLANK)));
<a class="jxr_linenumber" name="L2864" href="#L2864">2864</a>         videoList.add(obj(video));
<a class="jxr_linenumber" name="L2865" href="#L2865">2865</a>       } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (stream instanceof SubtitleStreamImpl) {
<a class="jxr_linenumber" name="L2866" href="#L2866">2866</a>         List&lt;Field&gt; subtitle = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2867" href="#L2867">2867</a>         SubtitleStreamImpl subtitleStream = (SubtitleStreamImpl) stream;
<a class="jxr_linenumber" name="L2868" href="#L2868">2868</a>         subtitle.add(f(<span class="jxr_string">"id"</span>, v(subtitleStream.getIdentifier(), BLANK)));
<a class="jxr_linenumber" name="L2869" href="#L2869">2869</a>         subtitle.add(f(<span class="jxr_string">"type"</span>, v(subtitleStream.getFormat(), BLANK)));
<a class="jxr_linenumber" name="L2870" href="#L2870">2870</a>         subtitleList.add(obj(subtitle));
<a class="jxr_linenumber" name="L2871" href="#L2871">2871</a>       } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L2872" href="#L2872">2872</a>         <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> IllegalArgumentException(<span class="jxr_string">"Stream must be either audio, video or subtitle"</span>);
<a class="jxr_linenumber" name="L2873" href="#L2873">2873</a>       }
<a class="jxr_linenumber" name="L2874" href="#L2874">2874</a>     }
<a class="jxr_linenumber" name="L2875" href="#L2875">2875</a>     fields.add(f(<span class="jxr_string">"audio"</span>, arr(audioList)));
<a class="jxr_linenumber" name="L2876" href="#L2876">2876</a>     fields.add(f(<span class="jxr_string">"video"</span>, arr(videoList)));
<a class="jxr_linenumber" name="L2877" href="#L2877">2877</a>     fields.add(f(<span class="jxr_string">"subtitle"</span>, arr(subtitleList)));
<a class="jxr_linenumber" name="L2878" href="#L2878">2878</a>     <strong class="jxr_keyword">return</strong> fields;
<a class="jxr_linenumber" name="L2879" href="#L2879">2879</a>   }
<a class="jxr_linenumber" name="L2880" href="#L2880">2880</a> 
<a class="jxr_linenumber" name="L2881" href="#L2881">2881</a>   <strong class="jxr_keyword">private</strong> JValue publicationToJSON(Publication publication) {
<a class="jxr_linenumber" name="L2882" href="#L2882">2882</a>     List&lt;Field&gt; fields = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2883" href="#L2883">2883</a>     fields.add(f(<span class="jxr_string">"id"</span>, v(publication.getIdentifier(), BLANK)));
<a class="jxr_linenumber" name="L2884" href="#L2884">2884</a>     fields.add(f(<span class="jxr_string">"channel"</span>, v(publication.getChannel(), BLANK)));
<a class="jxr_linenumber" name="L2885" href="#L2885">2885</a>     fields.add(f(<span class="jxr_string">"mimetype"</span>, v(publication.getMimeType(), BLANK)));
<a class="jxr_linenumber" name="L2886" href="#L2886">2886</a>     fields.add(f(<span class="jxr_string">"tags"</span>, arr($(publication.getTags()).map(toStringJValue))));
<a class="jxr_linenumber" name="L2887" href="#L2887">2887</a>     fields.add(f(<span class="jxr_string">"url"</span>, v(signUrl(publication.getURI()), BLANK)));
<a class="jxr_linenumber" name="L2888" href="#L2888">2888</a>     fields.addAll(getCommonElementFields(publication));
<a class="jxr_linenumber" name="L2889" href="#L2889">2889</a>     <strong class="jxr_keyword">return</strong> obj(fields);
<a class="jxr_linenumber" name="L2890" href="#L2890">2890</a>   }
<a class="jxr_linenumber" name="L2891" href="#L2891">2891</a> 
<a class="jxr_linenumber" name="L2892" href="#L2892">2892</a>   <strong class="jxr_keyword">private</strong> List&lt;Field&gt; getCommonElementFields(MediaPackageElement element) {
<a class="jxr_linenumber" name="L2893" href="#L2893">2893</a>     List&lt;Field&gt; fields = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2894" href="#L2894">2894</a>     fields.add(f(<span class="jxr_string">"size"</span>, v(element.getSize(), BLANK)));
<a class="jxr_linenumber" name="L2895" href="#L2895">2895</a>     fields.add(f(<span class="jxr_string">"checksum"</span>, v(element.getChecksum() != <strong class="jxr_keyword">null</strong> ? element.getChecksum().getValue() : <strong class="jxr_keyword">null</strong>, BLANK)));
<a class="jxr_linenumber" name="L2896" href="#L2896">2896</a>     fields.add(f(<span class="jxr_string">"reference"</span>, v(element.getReference() != <strong class="jxr_keyword">null</strong> ? element.getReference().getIdentifier() : <strong class="jxr_keyword">null</strong>, BLANK)));
<a class="jxr_linenumber" name="L2897" href="#L2897">2897</a>     <strong class="jxr_keyword">return</strong> fields;
<a class="jxr_linenumber" name="L2898" href="#L2898">2898</a>   }
<a class="jxr_linenumber" name="L2899" href="#L2899">2899</a> 
<a class="jxr_linenumber" name="L2900" href="#L2900">2900</a>   <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L2901" href="#L2901">2901</a> <em class="jxr_javadoccomment">   * Render an array of {@link Publication}s into a list of JSON values.</em>
<a class="jxr_linenumber" name="L2902" href="#L2902">2902</a> <em class="jxr_javadoccomment">   *</em>
<a class="jxr_linenumber" name="L2903" href="#L2903">2903</a> <em class="jxr_javadoccomment">   * @param publications</em>
<a class="jxr_linenumber" name="L2904" href="#L2904">2904</a> <em class="jxr_javadoccomment">   *          The elements to pull the data from to create the list of {@link JValue}s</em>
<a class="jxr_linenumber" name="L2905" href="#L2905">2905</a> <em class="jxr_javadoccomment">   * @return {@link List} of {@link JValue}s that represent the {@link Publication}</em>
<a class="jxr_linenumber" name="L2906" href="#L2906">2906</a> <em class="jxr_javadoccomment">   */</em>
<a class="jxr_linenumber" name="L2907" href="#L2907">2907</a>   <strong class="jxr_keyword">private</strong> List&lt;JValue&gt; getEventPublications(Publication[] publications) {
<a class="jxr_linenumber" name="L2908" href="#L2908">2908</a>     List&lt;JValue&gt; publicationJSON = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2909" href="#L2909">2909</a>     <strong class="jxr_keyword">for</strong> (Publication publication : publications) {
<a class="jxr_linenumber" name="L2910" href="#L2910">2910</a>       publicationJSON.add(obj(f(<span class="jxr_string">"id"</span>, v(publication.getIdentifier(), BLANK)),
<a class="jxr_linenumber" name="L2911" href="#L2911">2911</a>               f(<span class="jxr_string">"channel"</span>, v(publication.getChannel(), BLANK)), f(<span class="jxr_string">"mimetype"</span>, v(publication.getMimeType(), BLANK)),
<a class="jxr_linenumber" name="L2912" href="#L2912">2912</a>               f(<span class="jxr_string">"tags"</span>, arr($(publication.getTags()).map(toStringJValue))),
<a class="jxr_linenumber" name="L2913" href="#L2913">2913</a>               f(<span class="jxr_string">"url"</span>, v(signUrl(publication.getURI()), BLANK))));
<a class="jxr_linenumber" name="L2914" href="#L2914">2914</a>     }
<a class="jxr_linenumber" name="L2915" href="#L2915">2915</a>     <strong class="jxr_keyword">return</strong> publicationJSON;
<a class="jxr_linenumber" name="L2916" href="#L2916">2916</a>   }
<a class="jxr_linenumber" name="L2917" href="#L2917">2917</a> 
<a class="jxr_linenumber" name="L2918" href="#L2918">2918</a>   <strong class="jxr_keyword">private</strong> URI signUrl(URI url) {
<a class="jxr_linenumber" name="L2919" href="#L2919">2919</a>     <strong class="jxr_keyword">if</strong> (url == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L2920" href="#L2920">2920</a>       <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L2921" href="#L2921">2921</a>     }
<a class="jxr_linenumber" name="L2922" href="#L2922">2922</a>     <strong class="jxr_keyword">if</strong> (getUrlSigningService().accepts(url.toString())) {
<a class="jxr_linenumber" name="L2923" href="#L2923">2923</a>       <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L2924" href="#L2924">2924</a>         String clientIP = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L2925" href="#L2925">2925</a>         <strong class="jxr_keyword">if</strong> (signWithClientIP()) {
<a class="jxr_linenumber" name="L2926" href="#L2926">2926</a>           clientIP = getSecurityService().getUserIP();
<a class="jxr_linenumber" name="L2927" href="#L2927">2927</a>         }
<a class="jxr_linenumber" name="L2928" href="#L2928">2928</a>         <strong class="jxr_keyword">return</strong> URI.create(getUrlSigningService().sign(url.toString(), getUrlSigningExpireDuration(), <strong class="jxr_keyword">null</strong>, clientIP));
<a class="jxr_linenumber" name="L2929" href="#L2929">2929</a>       } <strong class="jxr_keyword">catch</strong> (UrlSigningException e) {
<a class="jxr_linenumber" name="L2930" href="#L2930">2930</a>         logger.warn(<span class="jxr_string">"Unable to sign url '{}'"</span>, url, e);
<a class="jxr_linenumber" name="L2931" href="#L2931">2931</a>       }
<a class="jxr_linenumber" name="L2932" href="#L2932">2932</a>     }
<a class="jxr_linenumber" name="L2933" href="#L2933">2933</a>     <strong class="jxr_keyword">return</strong> url;
<a class="jxr_linenumber" name="L2934" href="#L2934">2934</a>   }
<a class="jxr_linenumber" name="L2935" href="#L2935">2935</a> 
<a class="jxr_linenumber" name="L2936" href="#L2936">2936</a>   <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L2937" href="#L2937">2937</a> <em class="jxr_javadoccomment">   * Render an array of {@link MediaPackageElement}s into a list of JSON values.</em>
<a class="jxr_linenumber" name="L2938" href="#L2938">2938</a> <em class="jxr_javadoccomment">   *</em>
<a class="jxr_linenumber" name="L2939" href="#L2939">2939</a> <em class="jxr_javadoccomment">   * @param elements</em>
<a class="jxr_linenumber" name="L2940" href="#L2940">2940</a> <em class="jxr_javadoccomment">   *          The elements to pull the data from to create the list of {@link JValue}s</em>
<a class="jxr_linenumber" name="L2941" href="#L2941">2941</a> <em class="jxr_javadoccomment">   * @return {@link List} of {@link JValue}s that represent the {@link MediaPackageElement}</em>
<a class="jxr_linenumber" name="L2942" href="#L2942">2942</a> <em class="jxr_javadoccomment">   */</em>
<a class="jxr_linenumber" name="L2943" href="#L2943">2943</a>   <strong class="jxr_keyword">private</strong> List&lt;JValue&gt; getEventMediaPackageElements(MediaPackageElement[] elements) {
<a class="jxr_linenumber" name="L2944" href="#L2944">2944</a>     List&lt;JValue&gt; elementJSON = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2945" href="#L2945">2945</a>     <strong class="jxr_keyword">for</strong> (MediaPackageElement element : elements) {
<a class="jxr_linenumber" name="L2946" href="#L2946">2946</a>       elementJSON.add(obj(getEventMediaPackageElementFields(element)));
<a class="jxr_linenumber" name="L2947" href="#L2947">2947</a>     }
<a class="jxr_linenumber" name="L2948" href="#L2948">2948</a>     <strong class="jxr_keyword">return</strong> elementJSON;
<a class="jxr_linenumber" name="L2949" href="#L2949">2949</a>   }
<a class="jxr_linenumber" name="L2950" href="#L2950">2950</a> 
<a class="jxr_linenumber" name="L2951" href="#L2951">2951</a>   <strong class="jxr_keyword">private</strong> List&lt;Field&gt; getEventMediaPackageElementFields(MediaPackageElement element) {
<a class="jxr_linenumber" name="L2952" href="#L2952">2952</a>     List&lt;Field&gt; fields = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L2953" href="#L2953">2953</a>     fields.add(f(<span class="jxr_string">"id"</span>, v(element.getIdentifier(), BLANK)));
<a class="jxr_linenumber" name="L2954" href="#L2954">2954</a>     fields.add(f(<span class="jxr_string">"type"</span>, v(element.getFlavor(), BLANK)));
<a class="jxr_linenumber" name="L2955" href="#L2955">2955</a>     fields.add(f(<span class="jxr_string">"mimetype"</span>, v(element.getMimeType(), BLANK)));
<a class="jxr_linenumber" name="L2956" href="#L2956">2956</a>     List&lt;JValue&gt; tags = Stream.$(element.getTags()).map(toStringJValue).toList();
<a class="jxr_linenumber" name="L2957" href="#L2957">2957</a>     fields.add(f(<span class="jxr_string">"tags"</span>, arr(tags)));
<a class="jxr_linenumber" name="L2958" href="#L2958">2958</a>     fields.add(f(<span class="jxr_string">"url"</span>, v(signUrl(element.getURI()), BLANK)));
<a class="jxr_linenumber" name="L2959" href="#L2959">2959</a>     <strong class="jxr_keyword">return</strong> fields;
<a class="jxr_linenumber" name="L2960" href="#L2960">2960</a>   }
<a class="jxr_linenumber" name="L2961" href="#L2961">2961</a> 
<a class="jxr_linenumber" name="L2962" href="#L2962">2962</a>   <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> Fn&lt;String, JValue&gt; toStringJValue = <strong class="jxr_keyword">new</strong> Fn&lt;String, JValue&gt;() {
<a class="jxr_linenumber" name="L2963" href="#L2963">2963</a>     @Override
<a class="jxr_linenumber" name="L2964" href="#L2964">2964</a>     <strong class="jxr_keyword">public</strong> JValue apply(String stringValue) {
<a class="jxr_linenumber" name="L2965" href="#L2965">2965</a>       <strong class="jxr_keyword">return</strong> v(stringValue, BLANK);
<a class="jxr_linenumber" name="L2966" href="#L2966">2966</a>     }
<a class="jxr_linenumber" name="L2967" href="#L2967">2967</a>   };
<a class="jxr_linenumber" name="L2968" href="#L2968">2968</a> 
<a class="jxr_linenumber" name="L2969" href="#L2969">2969</a>   <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">final</strong> Fn&lt;Publication, JObject&gt; publicationToJson = <strong class="jxr_keyword">new</strong> Fn&lt;Publication, JObject&gt;() {
<a class="jxr_linenumber" name="L2970" href="#L2970">2970</a>     @Override
<a class="jxr_linenumber" name="L2971" href="#L2971">2971</a>     <strong class="jxr_keyword">public</strong> JObject apply(Publication publication) {
<a class="jxr_linenumber" name="L2972" href="#L2972">2972</a>       <strong class="jxr_keyword">final</strong> Opt&lt;String&gt; channel = Opt.nul(EventUtils.PUBLICATION_CHANNELS.get(publication.getChannel()));
<a class="jxr_linenumber" name="L2973" href="#L2973">2973</a>       String url = publication.getURI() == <strong class="jxr_keyword">null</strong> ? <span class="jxr_string">""</span> : signUrl(publication.getURI()).toString();
<a class="jxr_linenumber" name="L2974" href="#L2974">2974</a>       <strong class="jxr_keyword">return</strong> obj(f(<span class="jxr_string">"id"</span>, v(publication.getChannel())),
<a class="jxr_linenumber" name="L2975" href="#L2975">2975</a>               f(<span class="jxr_string">"name"</span>, v(channel.getOr(<span class="jxr_string">"EVENTS.EVENTS.DETAILS.PUBLICATIONS.CUSTOM"</span>))), f(<span class="jxr_string">"url"</span>, v(url, NULL)));
<a class="jxr_linenumber" name="L2976" href="#L2976">2976</a>     }
<a class="jxr_linenumber" name="L2977" href="#L2977">2977</a>   };
<a class="jxr_linenumber" name="L2978" href="#L2978">2978</a> 
<a class="jxr_linenumber" name="L2979" href="#L2979">2979</a>   <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> Fn&lt;TechnicalMetadata, JObject&gt; technicalMetadataToJson = <strong class="jxr_keyword">new</strong> Fn&lt;TechnicalMetadata, JObject&gt;() {
<a class="jxr_linenumber" name="L2980" href="#L2980">2980</a>     @Override
<a class="jxr_linenumber" name="L2981" href="#L2981">2981</a>     <strong class="jxr_keyword">public</strong> JObject apply(TechnicalMetadata technicalMetadata) {
<a class="jxr_linenumber" name="L2982" href="#L2982">2982</a>       JValue agentConfig = technicalMetadata.getCaptureAgentConfiguration() == <strong class="jxr_keyword">null</strong> ? v(<span class="jxr_string">""</span>)
<a class="jxr_linenumber" name="L2983" href="#L2983">2983</a>               : JSONUtils.mapToJSON(technicalMetadata.getCaptureAgentConfiguration());
<a class="jxr_linenumber" name="L2984" href="#L2984">2984</a>       JValue start = technicalMetadata.getStartDate() == <strong class="jxr_keyword">null</strong> ? v(<span class="jxr_string">""</span>)
<a class="jxr_linenumber" name="L2985" href="#L2985">2985</a>               : v(DateTimeSupport.toUTC(technicalMetadata.getStartDate().getTime()));
<a class="jxr_linenumber" name="L2986" href="#L2986">2986</a>       JValue end = technicalMetadata.getEndDate() == <strong class="jxr_keyword">null</strong> ? v(<span class="jxr_string">""</span>)
<a class="jxr_linenumber" name="L2987" href="#L2987">2987</a>               : v(DateTimeSupport.toUTC(technicalMetadata.getEndDate().getTime()));
<a class="jxr_linenumber" name="L2988" href="#L2988">2988</a>       <strong class="jxr_keyword">return</strong> obj(f(<span class="jxr_string">"agentId"</span>, v(technicalMetadata.getAgentId(), BLANK)), f(<span class="jxr_string">"agentConfiguration"</span>, agentConfig),
<a class="jxr_linenumber" name="L2989" href="#L2989">2989</a>               f(<span class="jxr_string">"start"</span>, start), f(<span class="jxr_string">"end"</span>, end), f(<span class="jxr_string">"eventId"</span>, v(technicalMetadata.getEventId(), BLANK)),
<a class="jxr_linenumber" name="L2990" href="#L2990">2990</a>               f(<span class="jxr_string">"presenters"</span>, JSONUtils.setToJSON(technicalMetadata.getPresenters())),
<a class="jxr_linenumber" name="L2991" href="#L2991">2991</a>               f(<span class="jxr_string">"recording"</span>, recordingToJson.apply(technicalMetadata.getRecording())));
<a class="jxr_linenumber" name="L2992" href="#L2992">2992</a>     }
<a class="jxr_linenumber" name="L2993" href="#L2993">2993</a>   };
<a class="jxr_linenumber" name="L2994" href="#L2994">2994</a> 
<a class="jxr_linenumber" name="L2995" href="#L2995">2995</a>   <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> Fn&lt;Optional&lt;Recording&gt;, JObject&gt; recordingToJson = <strong class="jxr_keyword">new</strong> Fn&lt;Optional&lt;Recording&gt;, JObject&gt;() {
<a class="jxr_linenumber" name="L2996" href="#L2996">2996</a>     @Override
<a class="jxr_linenumber" name="L2997" href="#L2997">2997</a>     <strong class="jxr_keyword">public</strong> JObject apply(Optional&lt;Recording&gt; recording) {
<a class="jxr_linenumber" name="L2998" href="#L2998">2998</a>       <strong class="jxr_keyword">if</strong> (recording.isEmpty()) {
<a class="jxr_linenumber" name="L2999" href="#L2999">2999</a>         <strong class="jxr_keyword">return</strong> obj();
<a class="jxr_linenumber" name="L3000" href="#L3000">3000</a>       }
<a class="jxr_linenumber" name="L3001" href="#L3001">3001</a>       <strong class="jxr_keyword">return</strong> obj(f(<span class="jxr_string">"id"</span>, v(recording.get().getID(), BLANK)),
<a class="jxr_linenumber" name="L3002" href="#L3002">3002</a>               f(<span class="jxr_string">"lastCheckInTime"</span>, v(recording.get().getLastCheckinTime(), BLANK)),
<a class="jxr_linenumber" name="L3003" href="#L3003">3003</a>               f(<span class="jxr_string">"lastCheckInTimeUTC"</span>, v(toUTC(recording.get().getLastCheckinTime()), BLANK)),
<a class="jxr_linenumber" name="L3004" href="#L3004">3004</a>               f(<span class="jxr_string">"state"</span>, v(recording.get().getState(), BLANK)));
<a class="jxr_linenumber" name="L3005" href="#L3005">3005</a>     }
<a class="jxr_linenumber" name="L3006" href="#L3006">3006</a>   };
<a class="jxr_linenumber" name="L3007" href="#L3007">3007</a> 
<a class="jxr_linenumber" name="L3008" href="#L3008">3008</a>   @PUT
<a class="jxr_linenumber" name="L3009" href="#L3009">3009</a>   @Path(<span class="jxr_string">"{eventId}/workflows/{workflowId}/action/{action}"</span>)
<a class="jxr_linenumber" name="L3010" href="#L3010">3010</a>   @RestQuery(name = <span class="jxr_string">"workflowAction"</span>, description = <span class="jxr_string">"Performs the given action for the given workflow."</span>, returnDescription = <span class="jxr_string">""</span>, pathParameters = {
<a class="jxr_linenumber" name="L3011" href="#L3011">3011</a>           @RestParameter(name = <span class="jxr_string">"eventId"</span>, description = <span class="jxr_string">"The id of the media package"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L3012" href="#L3012">3012</a>           @RestParameter(name = <span class="jxr_string">"workflowId"</span>, description = <span class="jxr_string">"The id of the workflow"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L3013" href="#L3013">3013</a>           @RestParameter(name = <span class="jxr_string">"action"</span>, description = <span class="jxr_string">"The action to take: STOP, RETRY or NONE (abort processing)"</span>, isRequired = <strong class="jxr_keyword">true</strong>, type = RestParameter.Type.STRING) }, responses = {
<a class="jxr_linenumber" name="L3014" href="#L3014">3014</a>                   @RestResponse(responseCode = SC_OK, description = <span class="jxr_string">"Workflow resumed."</span>),
<a class="jxr_linenumber" name="L3015" href="#L3015">3015</a>                   @RestResponse(responseCode = SC_NOT_FOUND, description = <span class="jxr_string">"Event or workflow instance not found."</span>),
<a class="jxr_linenumber" name="L3016" href="#L3016">3016</a>                   @RestResponse(responseCode = SC_BAD_REQUEST, description = <span class="jxr_string">"Invalid action entered."</span>),
<a class="jxr_linenumber" name="L3017" href="#L3017">3017</a>                   @RestResponse(responseCode = SC_UNAUTHORIZED, description = <span class="jxr_string">"You do not have permission to perform the action. Maybe you need to authenticate."</span>),
<a class="jxr_linenumber" name="L3018" href="#L3018">3018</a>                   @RestResponse(responseCode = SC_INTERNAL_SERVER_ERROR, description = <span class="jxr_string">"An exception occurred."</span>) })
<a class="jxr_linenumber" name="L3019" href="#L3019">3019</a>   <strong class="jxr_keyword">public</strong> Response workflowAction(@PathParam(<span class="jxr_string">"eventId"</span>) String id, @PathParam(<span class="jxr_string">"workflowId"</span>) <strong class="jxr_keyword">long</strong> wfId,
<a class="jxr_linenumber" name="L3020" href="#L3020">3020</a>           @PathParam(<span class="jxr_string">"action"</span>) String action) {
<a class="jxr_linenumber" name="L3021" href="#L3021">3021</a>     <strong class="jxr_keyword">if</strong> (StringUtils.isEmpty(id) || StringUtils.isEmpty(action)) {
<a class="jxr_linenumber" name="L3022" href="#L3022">3022</a>       <strong class="jxr_keyword">return</strong> badRequest();
<a class="jxr_linenumber" name="L3023" href="#L3023">3023</a>     }
<a class="jxr_linenumber" name="L3024" href="#L3024">3024</a> 
<a class="jxr_linenumber" name="L3025" href="#L3025">3025</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L3026" href="#L3026">3026</a>       <strong class="jxr_keyword">final</strong> Opt&lt;Event&gt; optEvent = getIndexService().getEvent(id, getIndex());
<a class="jxr_linenumber" name="L3027" href="#L3027">3027</a>       <strong class="jxr_keyword">if</strong> (optEvent.isNone()) {
<a class="jxr_linenumber" name="L3028" href="#L3028">3028</a>         <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, id);
<a class="jxr_linenumber" name="L3029" href="#L3029">3029</a>       }
<a class="jxr_linenumber" name="L3030" href="#L3030">3030</a> 
<a class="jxr_linenumber" name="L3031" href="#L3031">3031</a>       <strong class="jxr_keyword">final</strong> WorkflowInstance wfInstance = getWorkflowService().getWorkflowById(wfId);
<a class="jxr_linenumber" name="L3032" href="#L3032">3032</a>       <strong class="jxr_keyword">if</strong> (!wfInstance.getMediaPackage().getIdentifier().toString().equals(id)) {
<a class="jxr_linenumber" name="L3033" href="#L3033">3033</a>         <strong class="jxr_keyword">return</strong> badRequest(String.format(<span class="jxr_string">"Workflow %s is not associated to event %s"</span>, wfId, id));
<a class="jxr_linenumber" name="L3034" href="#L3034">3034</a>       }
<a class="jxr_linenumber" name="L3035" href="#L3035">3035</a> 
<a class="jxr_linenumber" name="L3036" href="#L3036">3036</a>       <strong class="jxr_keyword">if</strong> (RetryStrategy.NONE.toString().equalsIgnoreCase(action)
<a class="jxr_linenumber" name="L3037" href="#L3037">3037</a>         || RetryStrategy.RETRY.toString().equalsIgnoreCase(action)) {
<a class="jxr_linenumber" name="L3038" href="#L3038">3038</a>         getWorkflowService().resume(wfId, Collections.singletonMap(<span class="jxr_string">"retryStrategy"</span>, action));
<a class="jxr_linenumber" name="L3039" href="#L3039">3039</a>         <strong class="jxr_keyword">return</strong> ok();
<a class="jxr_linenumber" name="L3040" href="#L3040">3040</a>       }
<a class="jxr_linenumber" name="L3041" href="#L3041">3041</a> 
<a class="jxr_linenumber" name="L3042" href="#L3042">3042</a>       <strong class="jxr_keyword">if</strong> (WORKFLOW_ACTION_STOP.equalsIgnoreCase(action)) {
<a class="jxr_linenumber" name="L3043" href="#L3043">3043</a>         getWorkflowService().stop(wfId);
<a class="jxr_linenumber" name="L3044" href="#L3044">3044</a>         <strong class="jxr_keyword">return</strong> ok();
<a class="jxr_linenumber" name="L3045" href="#L3045">3045</a>       }
<a class="jxr_linenumber" name="L3046" href="#L3046">3046</a> 
<a class="jxr_linenumber" name="L3047" href="#L3047">3047</a>       <strong class="jxr_keyword">return</strong> badRequest(<span class="jxr_string">"Action not supported: "</span> + action);
<a class="jxr_linenumber" name="L3048" href="#L3048">3048</a>     } <strong class="jxr_keyword">catch</strong> (NotFoundException e) {
<a class="jxr_linenumber" name="L3049" href="#L3049">3049</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Workflow not found: '%d'."</span>, wfId);
<a class="jxr_linenumber" name="L3050" href="#L3050">3050</a>     } <strong class="jxr_keyword">catch</strong> (IllegalStateException e) {
<a class="jxr_linenumber" name="L3051" href="#L3051">3051</a>       <strong class="jxr_keyword">return</strong> badRequest(String.format(<span class="jxr_string">"Action %s not allowed for current workflow state. EventId: %s"</span>, action, id));
<a class="jxr_linenumber" name="L3052" href="#L3052">3052</a>     } <strong class="jxr_keyword">catch</strong> (UnauthorizedException e) {
<a class="jxr_linenumber" name="L3053" href="#L3053">3053</a>       <strong class="jxr_keyword">return</strong> forbidden();
<a class="jxr_linenumber" name="L3054" href="#L3054">3054</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L3055" href="#L3055">3055</a>       <strong class="jxr_keyword">return</strong> serverError();
<a class="jxr_linenumber" name="L3056" href="#L3056">3056</a>     }
<a class="jxr_linenumber" name="L3057" href="#L3057">3057</a>   }
<a class="jxr_linenumber" name="L3058" href="#L3058">3058</a> 
<a class="jxr_linenumber" name="L3059" href="#L3059">3059</a>   @DELETE
<a class="jxr_linenumber" name="L3060" href="#L3060">3060</a>   @Path(<span class="jxr_string">"{eventId}/workflows/{workflowId}"</span>)
<a class="jxr_linenumber" name="L3061" href="#L3061">3061</a>   @RestQuery(name = <span class="jxr_string">"deleteWorkflow"</span>, description = <span class="jxr_string">"Deletes a workflow"</span>, returnDescription = <span class="jxr_string">"The method doesn't return any content"</span>, pathParameters = {
<a class="jxr_linenumber" name="L3062" href="#L3062">3062</a>     @RestParameter(name = <span class="jxr_string">"eventId"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The event identifier"</span>, type = RestParameter.Type.STRING),
<a class="jxr_linenumber" name="L3063" href="#L3063">3063</a>     @RestParameter(name = <span class="jxr_string">"workflowId"</span>, isRequired = <strong class="jxr_keyword">true</strong>, description = <span class="jxr_string">"The workflow identifier"</span>, type = RestParameter.Type.INTEGER) }, responses = {
<a class="jxr_linenumber" name="L3064" href="#L3064">3064</a>     @RestResponse(responseCode = SC_BAD_REQUEST, description = <span class="jxr_string">"When trying to delete the latest workflow of the event."</span>),
<a class="jxr_linenumber" name="L3065" href="#L3065">3065</a>     @RestResponse(responseCode = SC_NOT_FOUND, description = <span class="jxr_string">"If the event or the workflow has not been found."</span>),
<a class="jxr_linenumber" name="L3066" href="#L3066">3066</a>     @RestResponse(responseCode = SC_NO_CONTENT, description = <span class="jxr_string">"The method does not return any content"</span>) })
<a class="jxr_linenumber" name="L3067" href="#L3067">3067</a>   <strong class="jxr_keyword">public</strong> Response deleteWorkflow(@PathParam(<span class="jxr_string">"eventId"</span>) String id, @PathParam(<span class="jxr_string">"workflowId"</span>) <strong class="jxr_keyword">long</strong> wfId)
<a class="jxr_linenumber" name="L3068" href="#L3068">3068</a>     <strong class="jxr_keyword">throws</strong> SearchIndexException {
<a class="jxr_linenumber" name="L3069" href="#L3069">3069</a>     <strong class="jxr_keyword">final</strong> Opt&lt;Event&gt; optEvent = getIndexService().getEvent(id, getIndex());
<a class="jxr_linenumber" name="L3070" href="#L3070">3070</a>     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L3071" href="#L3071">3071</a>       <strong class="jxr_keyword">if</strong> (optEvent.isNone()) {
<a class="jxr_linenumber" name="L3072" href="#L3072">3072</a>         <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Cannot find an event with id '%s'."</span>, id);
<a class="jxr_linenumber" name="L3073" href="#L3073">3073</a>       }
<a class="jxr_linenumber" name="L3074" href="#L3074">3074</a> 
<a class="jxr_linenumber" name="L3075" href="#L3075">3075</a>       <strong class="jxr_keyword">final</strong> WorkflowInstance wfInstance = getWorkflowService().getWorkflowById(wfId);
<a class="jxr_linenumber" name="L3076" href="#L3076">3076</a>       <strong class="jxr_keyword">if</strong> (!wfInstance.getMediaPackage().getIdentifier().toString().equals(id)) {
<a class="jxr_linenumber" name="L3077" href="#L3077">3077</a>         <strong class="jxr_keyword">return</strong> badRequest(String.format(<span class="jxr_string">"Workflow %s is not associated to event %s"</span>, wfId, id));
<a class="jxr_linenumber" name="L3078" href="#L3078">3078</a>       }
<a class="jxr_linenumber" name="L3079" href="#L3079">3079</a> 
<a class="jxr_linenumber" name="L3080" href="#L3080">3080</a>       <strong class="jxr_keyword">if</strong> (wfId == optEvent.get().getWorkflowId()) {
<a class="jxr_linenumber" name="L3081" href="#L3081">3081</a>         <strong class="jxr_keyword">return</strong> badRequest(String.format(<span class="jxr_string">"Cannot delete current workflow %s from event %s."</span>
<a class="jxr_linenumber" name="L3082" href="#L3082">3082</a>           + <span class="jxr_string">" Only older workflows can be deleted."</span>, wfId, id));
<a class="jxr_linenumber" name="L3083" href="#L3083">3083</a>       }
<a class="jxr_linenumber" name="L3084" href="#L3084">3084</a> 
<a class="jxr_linenumber" name="L3085" href="#L3085">3085</a>       getWorkflowService().remove(wfId);
<a class="jxr_linenumber" name="L3086" href="#L3086">3086</a> 
<a class="jxr_linenumber" name="L3087" href="#L3087">3087</a>       <strong class="jxr_keyword">return</strong> Response.noContent().build();
<a class="jxr_linenumber" name="L3088" href="#L3088">3088</a>     } <strong class="jxr_keyword">catch</strong> (WorkflowStateException e) {
<a class="jxr_linenumber" name="L3089" href="#L3089">3089</a>       <strong class="jxr_keyword">return</strong> badRequest(<span class="jxr_string">"Deleting is not allowed for current workflow state. EventId: "</span> + id);
<a class="jxr_linenumber" name="L3090" href="#L3090">3090</a>     } <strong class="jxr_keyword">catch</strong> (NotFoundException e) {
<a class="jxr_linenumber" name="L3091" href="#L3091">3091</a>       <strong class="jxr_keyword">return</strong> notFound(<span class="jxr_string">"Workflow not found: '%d'."</span>, wfId);
<a class="jxr_linenumber" name="L3092" href="#L3092">3092</a>     } <strong class="jxr_keyword">catch</strong> (UnauthorizedException e) {
<a class="jxr_linenumber" name="L3093" href="#L3093">3093</a>       <strong class="jxr_keyword">return</strong> forbidden();
<a class="jxr_linenumber" name="L3094" href="#L3094">3094</a>     } <strong class="jxr_keyword">catch</strong> (Exception e) {
<a class="jxr_linenumber" name="L3095" href="#L3095">3095</a>       <strong class="jxr_keyword">return</strong> serverError();
<a class="jxr_linenumber" name="L3096" href="#L3096">3096</a>     }
<a class="jxr_linenumber" name="L3097" href="#L3097">3097</a>   }
<a class="jxr_linenumber" name="L3098" href="#L3098">3098</a> 
<a class="jxr_linenumber" name="L3099" href="#L3099">3099</a>   <strong class="jxr_keyword">private</strong> Opt&lt;Event&gt; checkAgentAccessForEvent(<strong class="jxr_keyword">final</strong> String eventId) <strong class="jxr_keyword">throws</strong> UnauthorizedException, SearchIndexException {
<a class="jxr_linenumber" name="L3100" href="#L3100">3100</a>     <strong class="jxr_keyword">final</strong> Opt&lt;Event&gt; event = getIndexService().getEvent(eventId, getIndex());
<a class="jxr_linenumber" name="L3101" href="#L3101">3101</a>     <strong class="jxr_keyword">if</strong> (event.isNone() || !event.get().getEventStatus().contains(<span class="jxr_string">"SCHEDULE"</span>)) {
<a class="jxr_linenumber" name="L3102" href="#L3102">3102</a>       <strong class="jxr_keyword">return</strong> event;
<a class="jxr_linenumber" name="L3103" href="#L3103">3103</a>     }
<a class="jxr_linenumber" name="L3104" href="#L3104">3104</a>     SecurityUtil.checkAgentAccess(getSecurityService(), event.get().getAgentId());
<a class="jxr_linenumber" name="L3105" href="#L3105">3105</a>     <strong class="jxr_keyword">return</strong> event;
<a class="jxr_linenumber" name="L3106" href="#L3106">3106</a>   }
<a class="jxr_linenumber" name="L3107" href="#L3107">3107</a> 
<a class="jxr_linenumber" name="L3108" href="#L3108">3108</a>   <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">void</strong> checkAgentAccessForAgent(<strong class="jxr_keyword">final</strong> String agentId) <strong class="jxr_keyword">throws</strong> UnauthorizedException {
<a class="jxr_linenumber" name="L3109" href="#L3109">3109</a>     SecurityUtil.checkAgentAccess(getSecurityService(), agentId);
<a class="jxr_linenumber" name="L3110" href="#L3110">3110</a>   }
<a class="jxr_linenumber" name="L3111" href="#L3111">3111</a> 
<a class="jxr_linenumber" name="L3112" href="#L3112">3112</a> }
</pre>
<hr/>
<div id="footer"> 20092025 <a href="http://www.opencast.org/">Opencast Project</a></div>
</body>
</html>
