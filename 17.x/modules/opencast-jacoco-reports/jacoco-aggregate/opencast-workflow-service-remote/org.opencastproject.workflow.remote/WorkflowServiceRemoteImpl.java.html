<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>WorkflowServiceRemoteImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-workflow-service-remote</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.workflow.remote</a> &gt; <span class="el_source">WorkflowServiceRemoteImpl.java</span></div><h1>WorkflowServiceRemoteImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.workflow.remote;

import static org.apache.http.HttpStatus.SC_CONFLICT;
import static org.apache.http.HttpStatus.SC_NOT_FOUND;
import static org.apache.http.HttpStatus.SC_NO_CONTENT;
import static org.apache.http.HttpStatus.SC_OK;
import static org.apache.http.HttpStatus.SC_UNAUTHORIZED;

import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.mediapackage.MediaPackageParser;
import org.opencastproject.security.api.TrustedHttpClient;
import org.opencastproject.security.api.UnauthorizedException;
import org.opencastproject.serviceregistry.api.RemoteBase;
import org.opencastproject.serviceregistry.api.ServiceRegistry;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.workflow.api.WorkflowDatabaseException;
import org.opencastproject.workflow.api.WorkflowDefinition;
import org.opencastproject.workflow.api.WorkflowException;
import org.opencastproject.workflow.api.WorkflowInstance;
import org.opencastproject.workflow.api.WorkflowInstance.WorkflowState;
import org.opencastproject.workflow.api.WorkflowListener;
import org.opencastproject.workflow.api.WorkflowService;
import org.opencastproject.workflow.api.XmlWorkflowParser;

import org.apache.commons.io.IOUtils;
import org.apache.http.HttpResponse;
import org.apache.http.HttpStatus;
import org.apache.http.NameValuePair;
import org.apache.http.ParseException;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.HttpDelete;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.client.utils.URLEncodedUtils;
import org.apache.http.message.BasicNameValuePair;
import org.apache.http.util.EntityUtils;
import org.json.simple.parser.JSONParser;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Optional;

/**
 * An implementation of the workflow service that communicates with a remote workflow service via HTTP.
 */
@Component(
  property = {
    &quot;service.description=Workflow Remote Service Proxy&quot;
  },
  immediate =  true,
  service = { WorkflowService.class }
)
public class WorkflowServiceRemoteImpl extends RemoteBase implements WorkflowService {

  /** The logger */
<span class="nc" id="L88">  private static final Logger logger = LoggerFactory.getLogger(WorkflowServiceRemoteImpl.class);</span>

  public WorkflowServiceRemoteImpl() {
<span class="nc" id="L91">    super(JOB_TYPE);</span>
<span class="nc" id="L92">  }</span>

  /**
   * Sets the trusted http client
   *
   * @param client
   */
  @Override
  @Reference
  public void setTrustedHttpClient(TrustedHttpClient client) {
<span class="nc" id="L102">    super.setTrustedHttpClient(client);</span>
<span class="nc" id="L103">  }</span>

  /**
   * Sets the remote service manager.
   *
   * @param remoteServiceManager
   */
  @Override
  @Reference
  public void setRemoteServiceManager(ServiceRegistry remoteServiceManager) {
<span class="nc" id="L113">    this.remoteServiceManager = remoteServiceManager;</span>
<span class="nc" id="L114">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowService#getWorkflowDefinitionById(java.lang.String)
   */
  @Override
  public WorkflowDefinition getWorkflowDefinitionById(String id) throws WorkflowDatabaseException, NotFoundException {
<span class="nc" id="L123">    HttpGet get = new HttpGet(&quot;/definition/&quot; + id + &quot;.xml&quot;);</span>
<span class="nc" id="L124">    HttpResponse response = getResponse(get, SC_NOT_FOUND, SC_OK);</span>
    try {
<span class="nc bnc" id="L126" title="All 2 branches missed.">      if (response != null) {</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (SC_NOT_FOUND == response.getStatusLine().getStatusCode()) {</span>
<span class="nc" id="L128">          throw new NotFoundException(&quot;Workflow definition &quot; + id + &quot; does not exist.&quot;);</span>
        } else {
<span class="nc" id="L130">          return XmlWorkflowParser.parseWorkflowDefinition(response.getEntity().getContent());</span>
        }
      }
<span class="nc" id="L133">    } catch (NotFoundException e) {</span>
<span class="nc" id="L134">      throw e;</span>
<span class="nc" id="L135">    } catch (Exception e) {</span>
<span class="nc" id="L136">      throw new WorkflowDatabaseException(e);</span>
    } finally {
<span class="nc" id="L138">      closeConnection(response);</span>
    }
<span class="nc" id="L140">    throw new WorkflowDatabaseException(&quot;Unable to connect to a remote workflow service&quot;);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowService#getWorkflowById(long)
   */
  @Override
  public WorkflowInstance getWorkflowById(long id) throws WorkflowDatabaseException, NotFoundException {
<span class="nc" id="L150">    HttpGet get = new HttpGet(&quot;/instance/&quot; + id + &quot;.xml&quot;);</span>
<span class="nc" id="L151">    HttpResponse response = getResponse(get, SC_NOT_FOUND, SC_OK);</span>
    try {
<span class="nc bnc" id="L153" title="All 2 branches missed.">      if (response != null) {</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">        if (SC_NOT_FOUND == response.getStatusLine().getStatusCode()) {</span>
<span class="nc" id="L155">          throw new NotFoundException(&quot;Workflow instance &quot; + id + &quot; does not exist.&quot;);</span>
        } else {
<span class="nc" id="L157">          return XmlWorkflowParser.parseWorkflowInstance(response.getEntity().getContent());</span>
        }
      }
<span class="nc" id="L160">    } catch (NotFoundException e) {</span>
<span class="nc" id="L161">      throw e;</span>
<span class="nc" id="L162">    } catch (Exception e) {</span>
<span class="nc" id="L163">      throw new WorkflowDatabaseException(e);</span>
    } finally {
<span class="nc" id="L165">      closeConnection(response);</span>
    }
<span class="nc" id="L167">    throw new WorkflowDatabaseException(&quot;Unable to connect to a remote workflow service&quot;);</span>
  }

  @Override
  public List&lt;WorkflowInstance&gt; getWorkflowInstancesByMediaPackage(String mediaPackageId)
          throws WorkflowDatabaseException {
<span class="nc" id="L173">    HttpGet get = new HttpGet(&quot;/mediaPackage/&quot; + mediaPackageId + &quot;/instances.xml&quot;);</span>
<span class="nc" id="L174">    HttpResponse response = getResponse(get);</span>
    try {
<span class="nc bnc" id="L176" title="All 2 branches missed.">      if (response != null)</span>
<span class="nc" id="L177">        return XmlWorkflowParser.parseWorkflowSet(response.getEntity().getContent()).getItems();</span>
<span class="nc" id="L178">    } catch (Exception e) {</span>
<span class="nc" id="L179">      throw new WorkflowDatabaseException(e);</span>
    } finally {
<span class="nc" id="L181">      closeConnection(response);</span>
    }
<span class="nc" id="L183">    throw new WorkflowDatabaseException(&quot;Workflow instances can not be loaded from a remote workflow service&quot;);</span>
  }

  @Override
  public Optional&lt;WorkflowInstance&gt; getRunningWorkflowInstanceByMediaPackage(String mediaPackageId, String action)
          throws WorkflowException {

<span class="nc" id="L190">    HttpGet get = new HttpGet(&quot;/mediaPackage/&quot; + mediaPackageId + &quot;/instances.xml&quot;);</span>
<span class="nc" id="L191">    HttpResponse response = getResponse(get, SC_NOT_FOUND, SC_OK);</span>
    try {
<span class="nc bnc" id="L193" title="All 2 branches missed.">      if (response != null) {</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">        if (SC_NOT_FOUND == response.getStatusLine().getStatusCode()) {</span>
<span class="nc" id="L195">          return Optional.empty();</span>
        }
<span class="nc" id="L197">        return Optional.ofNullable(</span>
<span class="nc" id="L198">                XmlWorkflowParser.parseWorkflowInstance(response.getEntity().getContent())</span>
        );
      }
<span class="nc" id="L201">    } catch (Exception e) {</span>
<span class="nc" id="L202">      throw new WorkflowDatabaseException(e);</span>
    } finally {
<span class="nc" id="L204">      closeConnection(response);</span>
    }
<span class="nc" id="L206">    throw new WorkflowDatabaseException(&quot;Workflow instances can not be loaded from a remote workflow service&quot;);</span>
  }

  @Override
  public boolean mediaPackageHasActiveWorkflows(String mediaPackageId) throws WorkflowDatabaseException {
<span class="nc" id="L211">    HttpGet get = new HttpGet(&quot;/mediaPackage/&quot; + mediaPackageId + &quot;/hasActiveWorkflows&quot;);</span>
<span class="nc" id="L212">    HttpResponse response = getResponse(get);</span>
    try {
<span class="nc bnc" id="L214" title="All 2 branches missed.">      if (response != null)</span>
<span class="nc" id="L215">        return Boolean.parseBoolean(response.getEntity().getContent().toString());</span>
<span class="nc" id="L216">    } catch (Exception e) {</span>
<span class="nc" id="L217">      throw new WorkflowDatabaseException(e);</span>
    } finally {
<span class="nc" id="L219">      closeConnection(response);</span>
    }
<span class="nc" id="L221">    throw new WorkflowDatabaseException(&quot;Workflow instances can not be loaded from a remote workflow service&quot;);</span>
  }

  @Override
  public boolean userHasActiveWorkflows(String userId) throws WorkflowDatabaseException {
<span class="nc" id="L226">    HttpGet get = new HttpGet(&quot;/user/&quot; + userId + &quot;/hasActiveWorkflows&quot;);</span>
<span class="nc" id="L227">    HttpResponse response = getResponse(get);</span>
    try {
<span class="nc bnc" id="L229" title="All 2 branches missed.">      if (response != null)</span>
<span class="nc" id="L230">        return Boolean.parseBoolean(response.getEntity().getContent().toString());</span>
<span class="nc" id="L231">    } catch (Exception e) {</span>
<span class="nc" id="L232">      throw new WorkflowDatabaseException(e);</span>
    } finally {
<span class="nc" id="L234">      closeConnection(response);</span>
    }
<span class="nc" id="L236">    throw new WorkflowDatabaseException(&quot;Workflow instances can not be loaded from a remote workflow service&quot;);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowService#start(org.opencastproject.workflow.api.WorkflowDefinition,
   *      org.opencastproject.mediapackage.MediaPackage, java.util.Map)
   */
  @Override
  public WorkflowInstance start(WorkflowDefinition workflowDefinition, MediaPackage mediaPackage,
          Map&lt;String, String&gt; properties) throws WorkflowDatabaseException {
    try {
<span class="nc" id="L249">      return start(workflowDefinition, mediaPackage, null, properties);</span>
<span class="nc" id="L250">    } catch (NotFoundException e) {</span>
<span class="nc" id="L251">      throw new IllegalStateException(&quot;A null parent workflow id should never result in a not found exception &quot;, e);</span>
    }
  }

  /**
   * Converts a Map&lt;String, String&gt; to s key=value\n string, suitable for the properties form parameter expected by the
   * workflow rest endpoint.
   *
   * @param props
   *          The map of strings
   * @return the string representation
   */
  private String mapToString(Map&lt;String, String&gt; props) {
<span class="nc" id="L264">    StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">    for (Entry&lt;String, String&gt; entry : props.entrySet()) {</span>
<span class="nc" id="L266">      sb.append(entry.getKey());</span>
<span class="nc" id="L267">      sb.append(&quot;=&quot;);</span>
<span class="nc" id="L268">      sb.append(entry.getValue());</span>
<span class="nc" id="L269">      sb.append(&quot;\n&quot;);</span>
<span class="nc" id="L270">    }</span>
<span class="nc" id="L271">    return sb.toString();</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowService#start(org.opencastproject.workflow.api.WorkflowDefinition,
   *      org.opencastproject.mediapackage.MediaPackage, Long, java.util.Map)
   */
  @Override
  public WorkflowInstance start(WorkflowDefinition workflowDefinition, MediaPackage mediaPackage,
          Long parentWorkflowId, Map&lt;String, String&gt; properties) throws WorkflowDatabaseException, NotFoundException {
<span class="nc" id="L283">    HttpPost post = new HttpPost(&quot;/start&quot;);</span>
    try {
<span class="nc" id="L285">      List&lt;BasicNameValuePair&gt; params = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">      if (workflowDefinition != null)</span>
<span class="nc" id="L287">        params.add(new BasicNameValuePair(&quot;definition&quot;, XmlWorkflowParser.toXml(workflowDefinition)));</span>
<span class="nc" id="L288">      params.add(new BasicNameValuePair(&quot;mediapackage&quot;, MediaPackageParser.getAsXml(mediaPackage)));</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">      if (parentWorkflowId != null)</span>
<span class="nc" id="L290">        params.add(new BasicNameValuePair(&quot;parent&quot;, parentWorkflowId.toString()));</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">      if (properties != null)</span>
<span class="nc" id="L292">        params.add(new BasicNameValuePair(&quot;properties&quot;, mapToString(properties)));</span>
<span class="nc" id="L293">      post.setEntity(new UrlEncodedFormEntity(params, &quot;UTF-8&quot;));</span>
<span class="nc" id="L294">    } catch (Exception e) {</span>
<span class="nc" id="L295">      throw new IllegalStateException(&quot;Unable to assemble a remote workflow request&quot;, e);</span>
<span class="nc" id="L296">    }</span>
<span class="nc" id="L297">    HttpResponse response = getResponse(post, SC_NOT_FOUND, SC_OK);</span>
    try {
<span class="nc bnc" id="L299" title="All 2 branches missed.">      if (response != null) {</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">        if (SC_NOT_FOUND == response.getStatusLine().getStatusCode()) {</span>
<span class="nc" id="L301">          throw new NotFoundException(&quot;Workflow instance &quot; + parentWorkflowId + &quot; does not exist.&quot;);</span>
        } else {
<span class="nc" id="L303">          return XmlWorkflowParser.parseWorkflowInstance(response.getEntity().getContent());</span>
        }
      }
<span class="nc" id="L306">    } catch (NotFoundException e) {</span>
<span class="nc" id="L307">      throw e;</span>
<span class="nc" id="L308">    } catch (Exception e) {</span>
<span class="nc" id="L309">      throw new WorkflowDatabaseException(&quot;Unable to build a workflow from xml&quot;, e);</span>
    } finally {
<span class="nc" id="L311">      closeConnection(response);</span>
    }
<span class="nc" id="L313">    throw new WorkflowDatabaseException(&quot;Unable to start a remote workflow. The http response code was unexpected.&quot;);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowService#start(org.opencastproject.workflow.api.WorkflowDefinition,
   *      org.opencastproject.mediapackage.MediaPackage)
   */
  @Override
  public WorkflowInstance start(WorkflowDefinition workflowDefinition, MediaPackage mediaPackage)
          throws WorkflowDatabaseException {
    try {
<span class="nc" id="L326">      return start(workflowDefinition, mediaPackage, null, null);</span>
<span class="nc" id="L327">    } catch (NotFoundException e) {</span>
<span class="nc" id="L328">      throw new IllegalStateException(&quot;A null parent workflow id should never result in a not found exception &quot;, e);</span>
    }
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowService#countWorkflowInstances()
   */
  @Override
  public long countWorkflowInstances() throws WorkflowDatabaseException {
<span class="nc" id="L339">    return countWorkflowInstances(null);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowService#countWorkflowInstances(org.opencastproject.workflow.api.WorkflowInstance.WorkflowState)
   */
  @Override
  public long countWorkflowInstances(WorkflowState state) throws WorkflowDatabaseException {
<span class="nc" id="L349">    List&lt;NameValuePair&gt; queryStringParams = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">    if (state != null)</span>
<span class="nc" id="L351">      queryStringParams.add(new BasicNameValuePair(&quot;state&quot;, state.toString()));</span>

<span class="nc" id="L353">    StringBuilder url = new StringBuilder(&quot;/count&quot;);</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">    if (queryStringParams.size() &gt; 0) {</span>
<span class="nc" id="L355">      url.append(&quot;?&quot;);</span>
<span class="nc" id="L356">      url.append(URLEncodedUtils.format(queryStringParams, &quot;UTF-8&quot;));</span>
    }

<span class="nc" id="L359">    HttpGet get = new HttpGet(url.toString());</span>
<span class="nc" id="L360">    HttpResponse response = getResponse(get);</span>
    try {
<span class="nc bnc" id="L362" title="All 2 branches missed.">      if (response != null) {</span>
<span class="nc" id="L363">        String body = null;</span>
        try {
<span class="nc" id="L365">          body = EntityUtils.toString(response.getEntity());</span>
<span class="nc" id="L366">          return Long.parseLong(body);</span>
<span class="nc" id="L367">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L368">          throw new WorkflowDatabaseException(&quot;Unable to parse the response body as a long: &quot; + body);</span>
        }
      }
<span class="nc" id="L371">    } catch (ParseException | IOException e) {</span>
<span class="nc" id="L372">      throw new WorkflowDatabaseException(&quot;Unable to parse the response body&quot;);</span>
    } finally {
<span class="nc" id="L374">      closeConnection(response);</span>
    }

<span class="nc" id="L377">    throw new WorkflowDatabaseException(&quot;Unable to count workflow instances&quot;);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowService#stop(long)
   */
  @Override
  public WorkflowInstance stop(long workflowInstanceId) throws WorkflowDatabaseException, NotFoundException {
<span class="nc" id="L387">    HttpPost post = new HttpPost(&quot;/stop&quot;);</span>
<span class="nc" id="L388">    List&lt;BasicNameValuePair&gt; params = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L389">    params.add(new BasicNameValuePair(&quot;id&quot;, Long.toString(workflowInstanceId)));</span>
    try {
<span class="nc" id="L391">      post.setEntity(new UrlEncodedFormEntity(params, &quot;UTF-8&quot;));</span>
<span class="nc" id="L392">    } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L393">      throw new IllegalStateException(&quot;Unable to assemble a remote workflow service request&quot;, e);</span>
<span class="nc" id="L394">    }</span>
<span class="nc" id="L395">    HttpResponse response = getResponse(post, SC_OK, SC_NOT_FOUND);</span>
    try {
<span class="nc bnc" id="L397" title="All 2 branches missed.">      if (response != null) {</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">        if (response.getStatusLine().getStatusCode() == SC_NOT_FOUND) {</span>
<span class="nc" id="L399">          throw new NotFoundException(&quot;Workflow instance with id='&quot; + workflowInstanceId + &quot;' not found&quot;);</span>
        } else {
<span class="nc" id="L401">          logger.info(&quot;Workflow '{}' stopped&quot;, workflowInstanceId);</span>
<span class="nc" id="L402">          return XmlWorkflowParser.parseWorkflowInstance(response.getEntity().getContent());</span>
        }
      }
<span class="nc" id="L405">    } catch (NotFoundException e) {</span>
<span class="nc" id="L406">      throw e;</span>
<span class="nc" id="L407">    } catch (Exception e) {</span>
<span class="nc" id="L408">      throw new WorkflowDatabaseException(e);</span>
    } finally {
<span class="nc" id="L410">      closeConnection(response);</span>
    }
<span class="nc" id="L412">    throw new WorkflowDatabaseException(&quot;Unable to stop workflow instance &quot; + workflowInstanceId);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowService#suspend(long)
   */
  @Override
  public WorkflowInstance suspend(long workflowInstanceId) throws WorkflowDatabaseException, NotFoundException {
<span class="nc" id="L422">    HttpPost post = new HttpPost(&quot;/suspend&quot;);</span>
<span class="nc" id="L423">    List&lt;BasicNameValuePair&gt; params = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L424">    params.add(new BasicNameValuePair(&quot;id&quot;, Long.toString(workflowInstanceId)));</span>
    try {
<span class="nc" id="L426">      post.setEntity(new UrlEncodedFormEntity(params, &quot;UTF-8&quot;));</span>
<span class="nc" id="L427">    } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L428">      throw new IllegalStateException(&quot;Unable to assemble a remote workflow service request&quot;, e);</span>
<span class="nc" id="L429">    }</span>
<span class="nc" id="L430">    HttpResponse response = getResponse(post, SC_OK, SC_NOT_FOUND);</span>
    try {
<span class="nc bnc" id="L432" title="All 2 branches missed.">      if (response != null) {</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">        if (response.getStatusLine().getStatusCode() == SC_NOT_FOUND) {</span>
<span class="nc" id="L434">          throw new NotFoundException(&quot;Workflow instance with id='&quot; + workflowInstanceId + &quot;' not found&quot;);</span>
        } else {
<span class="nc" id="L436">          logger.info(&quot;Workflow '{}' suspended&quot;, workflowInstanceId);</span>
<span class="nc" id="L437">          return XmlWorkflowParser.parseWorkflowInstance(response.getEntity().getContent());</span>
        }
      }
<span class="nc" id="L440">    } catch (NotFoundException e) {</span>
<span class="nc" id="L441">      throw e;</span>
<span class="nc" id="L442">    } catch (Exception e) {</span>
<span class="nc" id="L443">      throw new WorkflowDatabaseException(e);</span>
    } finally {
<span class="nc" id="L445">      closeConnection(response);</span>
    }
<span class="nc" id="L447">    throw new WorkflowDatabaseException(&quot;Unable to suspend workflow instance &quot; + workflowInstanceId);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowService#resume(long)
   */
  @Override
  public WorkflowInstance resume(long workflowInstanceId) throws NotFoundException, UnauthorizedException,
          WorkflowException, IllegalStateException {
<span class="nc" id="L458">    return resume(workflowInstanceId, null);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowService#resume(long, java.util.Map)
   */
  @Override
  public WorkflowInstance resume(long workflowInstanceId, Map&lt;String, String&gt; properties) throws NotFoundException,
          UnauthorizedException, WorkflowException, IllegalStateException {
<span class="nc" id="L469">    HttpPost post = new HttpPost(&quot;/resume&quot;);</span>
<span class="nc" id="L470">    List&lt;BasicNameValuePair&gt; params = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L471">    params.add(new BasicNameValuePair(&quot;id&quot;, Long.toString(workflowInstanceId)));</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">    if (properties != null)</span>
<span class="nc" id="L473">      params.add(new BasicNameValuePair(&quot;properties&quot;, mapToString(properties)));</span>
<span class="nc" id="L474">    post.setEntity(new UrlEncodedFormEntity(params, StandardCharsets.UTF_8));</span>
<span class="nc" id="L475">    HttpResponse response = getResponse(post, SC_OK, SC_NOT_FOUND, SC_UNAUTHORIZED, SC_CONFLICT);</span>
    try {
<span class="nc bnc" id="L477" title="All 2 branches missed.">      if (response != null) {</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">        if (response.getStatusLine().getStatusCode() == SC_NOT_FOUND) {</span>
<span class="nc" id="L479">          throw new NotFoundException(&quot;Workflow instance with id='&quot; + workflowInstanceId + &quot;' not found&quot;);</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">        } else if (response.getStatusLine().getStatusCode() == SC_UNAUTHORIZED) {</span>
<span class="nc" id="L481">          throw new UnauthorizedException(&quot;You do not have permission to resume&quot;);</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">        } else if (response.getStatusLine().getStatusCode() == SC_CONFLICT) {</span>
<span class="nc" id="L483">          throw new IllegalStateException(&quot;Can not resume a workflow where the current state is not in paused&quot;);</span>
        } else {
<span class="nc" id="L485">          logger.info(&quot;Workflow '{}' resumed&quot;, workflowInstanceId);</span>
<span class="nc" id="L486">          return XmlWorkflowParser.parseWorkflowInstance(response.getEntity().getContent());</span>
        }
      }
<span class="nc" id="L489">    } catch (NotFoundException | UnauthorizedException | IllegalStateException e) {</span>
<span class="nc" id="L490">      throw e;</span>
<span class="nc" id="L491">    } catch (Exception e) {</span>
<span class="nc" id="L492">      throw new WorkflowException(e);</span>
    } finally {
<span class="nc" id="L494">      closeConnection(response);</span>
    }
<span class="nc" id="L496">    throw new WorkflowException(&quot;Unable to resume workflow instance &quot; + workflowInstanceId);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowService#update(org.opencastproject.workflow.api.WorkflowInstance)
   */
  @Override
  public void update(WorkflowInstance workflowInstance) throws WorkflowDatabaseException {
<span class="nc" id="L506">    HttpPost post = new HttpPost(&quot;/update&quot;);</span>
    try {
<span class="nc" id="L508">      List&lt;BasicNameValuePair&gt; params = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L509">      params.add(new BasicNameValuePair(&quot;workflow&quot;, XmlWorkflowParser.toXml(workflowInstance)));</span>
<span class="nc" id="L510">      post.setEntity(new UrlEncodedFormEntity(params, &quot;UTF-8&quot;));</span>
<span class="nc" id="L511">    } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L512">      throw new IllegalStateException(&quot;Unable to assemble a remote workflow service request&quot;, e);</span>
<span class="nc" id="L513">    } catch (Exception e) {</span>
<span class="nc" id="L514">      throw new IllegalStateException(&quot;unable to serialize workflow instance to xml&quot;);</span>
<span class="nc" id="L515">    }</span>

<span class="nc" id="L517">    HttpResponse response = getResponse(post, SC_NO_CONTENT);</span>
    try {
<span class="nc bnc" id="L519" title="All 2 branches missed.">      if (response != null) {</span>
<span class="nc" id="L520">        logger.info(&quot;Workflow '{}' updated&quot;, workflowInstance);</span>
<span class="nc" id="L521">        return;</span>
      }
    } finally {
<span class="nc" id="L524">      closeConnection(response);</span>
    }
<span class="nc" id="L526">    throw new WorkflowDatabaseException(&quot;Unable to update workflow instance &quot; + workflowInstance.getId());</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowService#remove(long)
   */
  @Override
  public void remove(long workflowInstanceId) throws WorkflowDatabaseException, NotFoundException {
<span class="nc" id="L536">    remove(workflowInstanceId, false);</span>
<span class="nc" id="L537">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowService#remove(long, boolean)
   */
  @Override
  public void remove(long workflowInstanceId, boolean force) throws WorkflowDatabaseException, NotFoundException {
<span class="nc" id="L546">    String deleteString = &quot;/remove/&quot; + Long.toString(workflowInstanceId);</span>

<span class="nc bnc" id="L548" title="All 2 branches missed.">    if (force) {</span>
<span class="nc" id="L549">      List&lt;NameValuePair&gt; queryStringParams = new ArrayList&lt;NameValuePair&gt;();</span>
<span class="nc" id="L550">      queryStringParams.add(new BasicNameValuePair(&quot;force&quot;, &quot;true&quot;));</span>
<span class="nc" id="L551">      deleteString = deleteString + &quot;?&quot; + URLEncodedUtils.format(queryStringParams, &quot;UTF_8&quot;);</span>
    }

<span class="nc" id="L554">    HttpDelete delete = new HttpDelete(deleteString);</span>

<span class="nc" id="L556">    HttpResponse response = getResponse(delete, SC_NO_CONTENT, SC_NOT_FOUND);</span>
    try {
<span class="nc bnc" id="L558" title="All 2 branches missed.">      if (response != null) {</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">        if (SC_NOT_FOUND == response.getStatusLine().getStatusCode()) {</span>
<span class="nc" id="L560">          throw new NotFoundException(&quot;Workflow id not found: &quot; + workflowInstanceId);</span>
        } else {
<span class="nc" id="L562">          logger.info(&quot;Workflow '{}' removed&quot;, workflowInstanceId);</span>
<span class="nc" id="L563">          return;</span>
        }
      }
    } finally {
<span class="nc" id="L567">      closeConnection(response);</span>
    }
<span class="nc" id="L569">    throw new WorkflowDatabaseException(&quot;Unable to remove workflow instance &quot; + workflowInstanceId);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowService#listAvailableWorkflowDefinitions()
   */
  @Override
  public List&lt;WorkflowDefinition&gt; listAvailableWorkflowDefinitions() throws WorkflowDatabaseException {
<span class="nc" id="L579">    HttpGet get = new HttpGet(&quot;/definitions.xml&quot;);</span>
<span class="nc" id="L580">    HttpResponse response = getResponse(get);</span>
    try {
<span class="nc bnc" id="L582" title="All 2 branches missed.">      if (response != null) {</span>
<span class="nc" id="L583">        List&lt;WorkflowDefinition&gt; list = XmlWorkflowParser.parseWorkflowDefinitions(response.getEntity().getContent());</span>
<span class="nc" id="L584">        Collections.sort(list); //sorts by title</span>
<span class="nc" id="L585">        return list;</span>
      }
<span class="nc" id="L587">    } catch (Exception e) {</span>
<span class="nc" id="L588">      throw new IllegalStateException(&quot;Unable to parse workflow definitions&quot;);</span>
    } finally {
<span class="nc" id="L590">      closeConnection(response);</span>
    }
<span class="nc" id="L592">    throw new WorkflowDatabaseException(</span>
            &quot;Unable to read the registered workflow definitions from the remote workflow service&quot;);
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowService#addWorkflowListener(org.opencastproject.workflow.api.WorkflowListener)
   */
  @Override
  public void addWorkflowListener(WorkflowListener listener) {
<span class="nc" id="L603">    throw new UnsupportedOperationException(&quot;Adding workflow listeners to a remote workflow service is not supported&quot;);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowService#removeWorkflowListener(org.opencastproject.workflow.api.WorkflowListener)
   */
  @Override
  public void removeWorkflowListener(WorkflowListener listener) {
<span class="nc" id="L613">    throw new UnsupportedOperationException(</span>
            &quot;Removing workflow listeners from a remote workflow service is not supported&quot;);
  }

  @Override
  public void cleanupWorkflowInstances(int lifetime, WorkflowState state) throws WorkflowDatabaseException,
          UnauthorizedException {
<span class="nc" id="L620">    HttpPost post = new HttpPost(&quot;/cleanup&quot;);</span>

<span class="nc" id="L622">    List&lt;BasicNameValuePair&gt; params = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L623">    params.add(new BasicNameValuePair(&quot;lifetime&quot;, String.valueOf(lifetime)));</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">    if (state != null)</span>
<span class="nc" id="L625">      params.add(new BasicNameValuePair(&quot;state&quot;, state.toString()));</span>
    try {
<span class="nc" id="L627">      post.setEntity(new UrlEncodedFormEntity(params, &quot;UTF-8&quot;));</span>
<span class="nc" id="L628">    } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L629">      throw new IllegalStateException(&quot;Unable to assemble a remote workflow service request&quot;, e);</span>
<span class="nc" id="L630">    }</span>

<span class="nc" id="L632">    HttpResponse response = getResponse(post, SC_OK, HttpStatus.SC_UNAUTHORIZED);</span>
    try {
<span class="nc bnc" id="L634" title="All 2 branches missed.">      if (response != null) {</span>
<span class="nc bnc" id="L635" title="All 2 branches missed.">        if (HttpStatus.SC_UNAUTHORIZED == response.getStatusLine().getStatusCode()) {</span>
<span class="nc" id="L636">          throw new UnauthorizedException(&quot;You do not have permission to cleanup&quot;);</span>
        } else {
<span class="nc" id="L638">          logger.info(&quot;Successful request to workflow cleanup endpoint&quot;);</span>
<span class="nc" id="L639">          return;</span>
        }
      }
    } finally {
<span class="nc" id="L643">      closeConnection(response);</span>
    }
<span class="nc" id="L645">    throw new WorkflowDatabaseException(&quot;Unable to successfully request the workflow cleanup endpoint&quot;);</span>
  }

  @Override
  public Map&lt;String, Map&lt;String, String&gt;&gt; getWorkflowStateMappings() {
<span class="nc" id="L650">    HttpGet get = new HttpGet(&quot;/statemappings.json&quot;);</span>
<span class="nc" id="L651">    HttpResponse response = getResponse(get);</span>
    try {
<span class="nc bnc" id="L653" title="All 2 branches missed.">      if (response != null) {</span>
<span class="nc" id="L654">        return (Map&lt;String, Map&lt;String, String&gt;&gt;) new JSONParser().parse(IOUtils.toString(response.getEntity().getContent(), &quot;utf-8&quot;));</span>
      }
<span class="nc" id="L656">    } catch (Exception e) {</span>
<span class="nc" id="L657">      throw new IllegalStateException(&quot;Unable to parse workflow state mappings&quot;);</span>
    } finally {
<span class="nc" id="L659">      closeConnection(response);</span>
    }
<span class="nc" id="L661">    return new HashMap&lt;&gt;();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>