<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>PlaylistService.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-playlists</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.playlists</a> &gt; <span class="el_source">PlaylistService.java</span></div><h1>PlaylistService.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.playlists;

import static org.opencastproject.security.api.SecurityConstants.GLOBAL_ADMIN_ROLE;

import org.opencastproject.elasticsearch.api.SearchIndexException;
import org.opencastproject.elasticsearch.api.SearchResult;
import org.opencastproject.elasticsearch.index.ElasticsearchIndex;
import org.opencastproject.elasticsearch.index.objects.event.Event;
import org.opencastproject.elasticsearch.index.objects.event.EventSearchQuery;
import org.opencastproject.playlists.persistence.PlaylistDatabaseException;
import org.opencastproject.playlists.persistence.PlaylistDatabaseService;
import org.opencastproject.playlists.serialization.JaxbPlaylist;
import org.opencastproject.playlists.serialization.JaxbPlaylistEntry;
import org.opencastproject.security.api.AccessControlEntry;
import org.opencastproject.security.api.AccessControlList;
import org.opencastproject.security.api.AuthorizationService;
import org.opencastproject.security.api.Organization;
import org.opencastproject.security.api.Permissions;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.UnauthorizedException;
import org.opencastproject.security.api.User;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.requests.SortCriterion;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.ObjectReader;
import com.fasterxml.jackson.module.jaxb.JaxbAnnotationModule;

import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;

@Component(
    property = {
        &quot;service.description=Playlist Service&quot;,
        &quot;service.pid=org.opencastproject.playlists.PlaylistService&quot;
    },
    immediate = true,
    service = { PlaylistService.class }
)
<span class="fc" id="L70">public class PlaylistService {</span>
  /** Logging facility */
<span class="fc" id="L72">  private static final Logger logger = LoggerFactory.getLogger(PlaylistService.class);</span>

  /** Persistent storage */
  protected PlaylistDatabaseService persistence;

  /** The security service */
  protected SecurityService securityService;

  /** The authorization service */
<span class="fc" id="L81">  protected AuthorizationService authorizationService = null;</span>

  private ElasticsearchIndex elasticsearchIndex;

  /**
   * Callback to set the playlist database
   *
   * @param persistence
   *          the playlist database
   */
  @Reference(name = &quot;playlist-persistence&quot;)
  public void setPersistence(PlaylistDatabaseService persistence) {
<span class="fc" id="L93">    this.persistence = persistence;</span>
<span class="fc" id="L94">  }</span>

  /**
   * OSGi callback to set the security service.
   *
   * @param securityService
   *          the securityService to set
   */
  @Reference(name = &quot;security-service&quot;)
  public void setSecurityService(SecurityService securityService) {
<span class="fc" id="L104">    this.securityService = securityService;</span>
<span class="fc" id="L105">  }</span>

  /**
   * Callback for setting the authorization service.
   *
   * @param authorizationService
   *          the authorizationService to set
   */
  @Reference
  public void setAuthorizationService(AuthorizationService authorizationService) {
<span class="fc" id="L115">    this.authorizationService = authorizationService;</span>
<span class="fc" id="L116">  }</span>

  @Reference
  void setElasticsearchIndex(ElasticsearchIndex elasticsearchIndex) {
<span class="nc" id="L120">    this.elasticsearchIndex = elasticsearchIndex;</span>
<span class="nc" id="L121">  }</span>

  @Activate
  public void activate(ComponentContext cc) throws Exception {
<span class="fc" id="L125">    logger.info(&quot;Activating Playlist Service&quot;);</span>
<span class="fc" id="L126">  }</span>

  /**
   * Returns a playlist from the database by its id
   * @param id playlist id
   * @return The {@link Playlist} belonging to the id
   * @throws NotFoundException If no playlist with the given id could be found
   * @throws IllegalStateException If something went wrong in the database service
   * @throws UnauthorizedException If the user does not have read access for the playlist
   */
  public Playlist getPlaylistById(String id) throws NotFoundException, IllegalStateException, UnauthorizedException {
    try {
<span class="fc" id="L138">      Playlist playlist = persistence.getPlaylist(id);</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">      if (!checkPermission(playlist, Permissions.Action.READ)) {</span>
<span class="nc" id="L140">        throw new UnauthorizedException(&quot;User does not have read permissions&quot;);</span>
      }
<span class="fc" id="L142">      return playlist;</span>
<span class="nc" id="L143">    } catch (PlaylistDatabaseException e) {</span>
<span class="nc" id="L144">      throw new IllegalStateException(&quot;Could not get playlist from database with id &quot;);</span>
    }
  }

  /**
   * Get multiple playlists from the database
   * @param limit The maximum amount of playlists to get with one request.
   * @param offset The index of the first result to return.
   * @return A list of {@link Playlist}s
   * @throws IllegalStateException If something went wrong in the database service
   */
  public List&lt;Playlist&gt; getPlaylists(int limit, int offset) throws IllegalStateException {
<span class="nc" id="L156">    return getPlaylists(limit, offset, new SortCriterion(&quot;&quot;, SortCriterion.Order.None));</span>
  }

  public List&lt;Playlist&gt; getPlaylists(int limit, int offset, SortCriterion sortCriterion)
          throws IllegalStateException {
    try {
<span class="nc" id="L162">      List&lt;Playlist&gt; playlists = persistence.getPlaylists(limit, offset, sortCriterion);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">      playlists.removeIf(playlist -&gt; !checkPermission(playlist, Permissions.Action.READ));</span>
<span class="nc" id="L164">      return playlists;</span>
<span class="nc" id="L165">    } catch (PlaylistDatabaseException e) {</span>
<span class="nc" id="L166">      throw new IllegalStateException(&quot;Could not get playlist from database with id &quot;);</span>
    }
  }

  public List&lt;Playlist&gt; getAllForAdministrativeRead(Date from, Date to, int limit)
          throws IllegalStateException, UnauthorizedException {
<span class="nc" id="L172">    final var user = securityService.getUser();</span>
<span class="nc" id="L173">    final var orgAdminRole = securityService.getOrganization().getAdminRole();</span>
<span class="nc bnc" id="L174" title="All 4 branches missed.">    if (!user.hasRole(GLOBAL_ADMIN_ROLE) &amp;&amp; !user.hasRole(orgAdminRole)) {</span>
<span class="nc" id="L175">      throw new UnauthorizedException(&quot;Only (org-)admins can call this method&quot;);</span>
    }

    try {
<span class="nc" id="L179">      return persistence.getAllForAdministrativeRead(from, to, limit);</span>
<span class="nc" id="L180">    } catch (PlaylistDatabaseException e) {</span>
<span class="nc" id="L181">      throw new IllegalStateException(&quot;Could not get playlist from database&quot;, e);</span>
    }
  }

  /**
   * Persist a new playlist in the database or update an existing one
   * @param playlist The {@link Playlist} to create or update with
   * @return The updated {@link Playlist}
   * @throws IllegalStateException If something went wrong in the database service
   * @throws UnauthorizedException If the user does not have write access for an existing playlist
   */
  public Playlist update(Playlist playlist)
          throws IllegalStateException, UnauthorizedException, IllegalArgumentException {
    try {
<span class="fc" id="L195">      Playlist existingPlaylist = persistence.getPlaylist(playlist.getId());</span>
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">      if (!checkPermission(existingPlaylist, Permissions.Action.WRITE)) {</span>
<span class="nc" id="L197">        throw new UnauthorizedException(&quot;User does not have write permissions&quot;);</span>
      }

      // Validate entry IDs
<span class="fc bfc" id="L201" title="All 2 branches covered.">      for (PlaylistEntry entry : playlist.getEntries()) {</span>
<span class="pc bpc" id="L202" title="1 of 4 branches missed.">        if (existingPlaylist.getEntries().stream().noneMatch(e -&gt; entry.getId() == e.getId())) {</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">          if (entry.getId() != 0) {</span>
<span class="nc" id="L204">            throw new IllegalArgumentException(&quot;When updating a playlist, entries should either have the id of an &quot;</span>
                + &quot;existing entry, or no id at all.&quot;);
          }
        }
<span class="fc" id="L208">      }</span>
<span class="fc bfc" id="L209" title="All 2 branches covered.">      for (PlaylistAccessControlEntry entry : playlist.getAccessControlEntries()) {</span>
<span class="pc bpc" id="L210" title="2 of 4 branches missed.">        if (existingPlaylist.getAccessControlEntries().stream().noneMatch(e -&gt; entry.getId() == e.getId())) {</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">          if (entry.getId() != 0) {</span>
<span class="nc" id="L212">            throw new IllegalArgumentException(&quot;When updating a playlist, ACL entries should either have the id of an &quot;</span>
                + &quot;existing entry, or no id at all.&quot;);
          }
        }
<span class="fc" id="L216">      }</span>
<span class="fc" id="L217">    } catch (NotFoundException e) {</span>
      // This means we are creating a new playlist
<span class="fc bfc" id="L219" title="All 2 branches covered.">      for (PlaylistEntry entry : playlist.getEntries()) {</span>
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">        if (entry.getId() != 0) {</span>
<span class="nc" id="L221">          throw new IllegalArgumentException(&quot;Entries for new playlists should not have identifiers set&quot;);</span>
        }
<span class="fc" id="L223">      }</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">      for (PlaylistAccessControlEntry entry : playlist.getAccessControlEntries()) {</span>
<span class="pc bpc" id="L225" title="1 of 2 branches missed.">        if (entry.getId() != 0) {</span>
<span class="nc" id="L226">          throw new IllegalArgumentException(&quot;ACL Entries for new playlists should not have identifiers set&quot;);</span>
        }
<span class="fc" id="L228">      }</span>
<span class="nc" id="L229">    } catch (PlaylistDatabaseException e) {</span>
<span class="nc" id="L230">      throw new IllegalStateException(&quot;Could not get playlist from database with id &quot;);</span>
<span class="fc" id="L231">    }</span>

<span class="pc bpc" id="L233" title="1 of 2 branches missed.">    if (playlist.getOrganization() == null) {</span>
<span class="nc" id="L234">      playlist.setOrganization(securityService.getOrganization().getId());</span>
    }
<span class="fc bfc" id="L236" title="All 2 branches covered.">    for (PlaylistEntry entry : playlist.getEntries()) {</span>
<span class="fc" id="L237">      entry.setPlaylist(playlist);</span>
<span class="fc" id="L238">    }</span>
<span class="fc bfc" id="L239" title="All 2 branches covered.">    for (PlaylistAccessControlEntry entry : playlist.getAccessControlEntries()) {</span>
<span class="fc" id="L240">      entry.setPlaylist(playlist);</span>
<span class="fc" id="L241">    }</span>

    try {
<span class="fc" id="L244">      playlist = persistence.updatePlaylist(playlist, securityService.getOrganization().getId());</span>
<span class="fc" id="L245">      return playlist;</span>
<span class="nc" id="L246">    } catch (PlaylistDatabaseException e) {</span>
<span class="nc" id="L247">      throw new IllegalStateException(&quot;Could not update playlist from database with id &quot;);</span>
    }
  }

  /**
   * Overwrite an existing playlist with a playlist in JSON format.
   * Only fields present in the JSON will be overwritten! Conversely, if a field is not present in the JSON,
   * the field in the existing playlist will not change.
   * @param id Identifier of the playlist to update.
   * @param json JSON containing data to update the playlist with.
   * @return The updated {@link Playlist}
   */
  public Playlist updateWithJson(String id, String json) throws JsonProcessingException, UnauthorizedException {
    try {
<span class="nc" id="L261">      Playlist existingPlaylist = persistence.getPlaylist(id);</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">      if (!checkPermission(existingPlaylist, Permissions.Action.WRITE)) {</span>
<span class="nc" id="L263">        throw new UnauthorizedException(&quot;User does not have write permissions&quot;);</span>
      }

<span class="nc" id="L266">      JaxbAnnotationModule module = new JaxbAnnotationModule();</span>
<span class="nc" id="L267">      ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="nc" id="L268">      objectMapper.registerModule(module);</span>
<span class="nc" id="L269">      objectMapper.enable(DeserializationFeature.ACCEPT_SINGLE_VALUE_AS_ARRAY);</span>

<span class="nc" id="L271">      ObjectReader updater = objectMapper.readerForUpdating(new JaxbPlaylist(existingPlaylist));</span>
<span class="nc" id="L272">      JaxbPlaylist merged = updater.readValue(json);</span>

<span class="nc" id="L274">      return update(merged.toPlaylist());</span>
<span class="nc" id="L275">    } catch (NotFoundException | PlaylistDatabaseException e) {</span>
<span class="nc" id="L276">      throw new IllegalStateException(&quot;Could not get playlist from database with id &quot; + id);</span>
    }
  }

  /**
   * Deletes a playlist from the database
   * @param playlistId The playlist identifier
   * @return The removed {@link Playlist}
   * @throws NotFoundException If no playlist with the given id could be found
   * @throws IllegalStateException If something went wrong in the database service
   * @throws UnauthorizedException If the user does not have write access for the playlist
   */
  public Playlist remove(String playlistId)
          throws NotFoundException, IllegalStateException, UnauthorizedException {
    try {
<span class="fc" id="L291">      Playlist playlist = persistence.getPlaylist(playlistId);</span>
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">      if (!checkPermission(playlist, Permissions.Action.WRITE)) {</span>
<span class="nc" id="L293">        throw new UnauthorizedException(&quot;User does not have write permissions&quot;);</span>
      }
<span class="fc" id="L295">      playlist = persistence.deletePlaylist(playlist, securityService.getOrganization().getId());</span>
<span class="fc" id="L296">      return playlist;</span>
<span class="nc" id="L297">    } catch (PlaylistDatabaseException e) {</span>
<span class="nc" id="L298">      throw new IllegalStateException(&quot;Could not delete playlist from database with id &quot; + playlistId);</span>
    }
  }

  /**
   * Replaces the entries in the playlist with the given entries
   * @param playlistId identifier of the playlist to modify
   * @param playlistEntries the new playlist entries
   * @return {@link Playlist} with the new entries
   * @throws NotFoundException If no playlist with the given id could be found
   * @throws IllegalStateException If something went wrong in the database service
   * @throws UnauthorizedException If the user does not have write access for the playlist
   */
  public Playlist updateEntries(String playlistId, List&lt;PlaylistEntry&gt; playlistEntries)
          throws NotFoundException, IllegalStateException, UnauthorizedException {
    Playlist playlist;
    try {
<span class="nc" id="L315">      playlist = persistence.getPlaylist(playlistId);</span>
<span class="nc" id="L316">    } catch (PlaylistDatabaseException e) {</span>
<span class="nc" id="L317">      throw new IllegalStateException(e);</span>
<span class="nc" id="L318">    }</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">    if (!checkPermission(playlist, Permissions.Action.WRITE)) {</span>
<span class="nc" id="L320">      throw new UnauthorizedException(&quot;User does not have write permissions&quot;);</span>
    }
<span class="nc" id="L322">    playlist.setEntries(playlistEntries);</span>

    try {
<span class="nc" id="L325">      playlist = persistence.updatePlaylist(playlist, securityService.getOrganization().getId());</span>

<span class="nc" id="L327">      return playlist;</span>
<span class="nc" id="L328">    } catch (PlaylistDatabaseException e) {</span>
<span class="nc" id="L329">      throw new IllegalStateException(&quot;Could not delete playlist from database with id &quot; + playlistId);</span>
    }
  }

  /**
   * Adds a new entry at the end of a playlist and persists it
   * @param playlistId The playlist identifier
   * @param contentId content (e.g. mediapacakge) identifier
   * @param type arbitrary string
   * @return {@link Playlist} with the new entry
   * @throws NotFoundException If no playlist with the given id could be found
   * @throws IllegalStateException If something went wrong in the database service
   * @throws UnauthorizedException If the user does not have write access for the playlist
   */
  public Playlist addEntry(String playlistId, String contentId, PlaylistEntryType type)
          throws NotFoundException, IllegalStateException, UnauthorizedException {
    Playlist playlist;
    try {
<span class="nc" id="L347">      playlist = persistence.getPlaylist(playlistId);</span>
<span class="nc" id="L348">    } catch (PlaylistDatabaseException e) {</span>
<span class="nc" id="L349">      throw new IllegalStateException(e);</span>
<span class="nc" id="L350">    }</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">    if (!checkPermission(playlist, Permissions.Action.WRITE)) {</span>
<span class="nc" id="L352">      throw new UnauthorizedException(&quot;User does not have write permissions&quot;);</span>
    }
<span class="nc" id="L354">    PlaylistEntry playlistEntry = new PlaylistEntry();</span>
<span class="nc" id="L355">    playlistEntry.setContentId(contentId);</span>
<span class="nc" id="L356">    playlistEntry.setType(type);</span>
<span class="nc" id="L357">    playlist.addEntry(playlistEntry);</span>

    try {
<span class="nc" id="L360">      playlist = persistence.updatePlaylist(playlist, securityService.getOrganization().getId());</span>

<span class="nc" id="L362">      return playlist;</span>
<span class="nc" id="L363">    } catch (PlaylistDatabaseException e) {</span>
<span class="nc" id="L364">      throw new IllegalStateException(&quot;Could not delete playlist from database with id &quot; + playlistId);</span>
    }
  }

  /**
   * Removes an entry with the given id from the playlist and persists it
   * @param playlistId The playlist identifier
   * @param entryId The entry identifier
   * @return {@link Playlist} without the entry
   * @throws NotFoundException If no playlist with the given id could be found
   * @throws IllegalStateException If something went wrong in the database service
   * @throws UnauthorizedException If the user does not have write access for the playlist
   */
  public Playlist removeEntry(String playlistId, long entryId)
          throws NotFoundException, IllegalStateException, UnauthorizedException {
    Playlist playlist;
    try {
<span class="nc" id="L381">      playlist = persistence.getPlaylist(playlistId);</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">      if (!checkPermission(playlist, Permissions.Action.WRITE)) {</span>
<span class="nc" id="L383">        throw new UnauthorizedException(&quot;User does not have write permissions&quot;);</span>
      }
<span class="nc" id="L385">    } catch (PlaylistDatabaseException e) {</span>
<span class="nc" id="L386">      throw new IllegalStateException(e);</span>
<span class="nc" id="L387">    }</span>

<span class="nc" id="L389">    playlist.removeEntry(</span>
<span class="nc" id="L390">        playlist.getEntries()</span>
<span class="nc" id="L391">            .stream()</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">            .filter(e -&gt; e.getId() == entryId)</span>
<span class="nc" id="L393">            .findFirst()</span>
<span class="nc" id="L394">            .get()</span>
    );

    try {
<span class="nc" id="L398">      playlist = persistence.updatePlaylist(playlist, securityService.getOrganization().getId());</span>
<span class="nc" id="L399">      return playlist;</span>
<span class="nc" id="L400">    } catch (PlaylistDatabaseException e) {</span>
<span class="nc" id="L401">      throw new IllegalStateException(&quot;Could not delete playlist from database with id &quot; + playlistId);</span>
    }
  }

  /**
   * Enrich each entry of a playlist with information about the content. Intended to be used by endpoints when
   * returning information about a playlist. Currently only adds publication information for entries of type EVENT.
   * @param playlist The playlist to enrich
   * @return The serialization class of the playlist, since the added information does not belong to the playlist
   * itself.
   */
  public JaxbPlaylist enrich(Playlist playlist) {
<span class="nc" id="L413">    var jaxbPlaylist = new JaxbPlaylist(playlist);</span>
<span class="nc" id="L414">    var org = securityService.getOrganization().getId();</span>
<span class="nc" id="L415">    var user = securityService.getUser();</span>

    // Add additional infos about events
<span class="nc" id="L418">    List&lt;JaxbPlaylistEntry&gt; jaxbPlaylistEntries = jaxbPlaylist.getEntries();</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">    for (JaxbPlaylistEntry entry : jaxbPlaylistEntries) {</span>
<span class="nc" id="L420">      String contentId = entry.getContentId();</span>

<span class="nc bnc" id="L422" title="All 4 branches missed.">      if (contentId == null || contentId.isEmpty()) {</span>
<span class="nc" id="L423">        entry.setType(PlaylistEntryType.INACCESSIBLE);</span>
<span class="nc" id="L424">        logger.warn(&quot;Entry {} has no content, marking as inaccessible&quot;, entry.getId());</span>
<span class="nc" id="L425">        continue;</span>
      }

      try {
<span class="nc bnc" id="L429" title="All 2 branches missed.">        if (entry.getType() == PlaylistEntryType.EVENT) {</span>

          // We only get an event from the index if we have permission to do so (and if it exists ofc)
<span class="nc" id="L432">          SearchResult&lt;Event&gt; result = elasticsearchIndex.getByQuery(</span>
<span class="nc" id="L433">              new EventSearchQuery(org, user).withIdentifier(contentId));</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">          if (result.getPageSize() != 0) {</span>
<span class="nc" id="L435">            Event event = result.getItems()[0].getSource();</span>
<span class="nc" id="L436">            entry.setPublications(event.getPublications());</span>
<span class="nc" id="L437">          } else {</span>
<span class="nc" id="L438">            entry.setType(PlaylistEntryType.INACCESSIBLE);</span>
          }
        }
<span class="nc" id="L441">      } catch (SearchIndexException e) {</span>
<span class="nc" id="L442">        throw new RuntimeException(e);</span>
<span class="nc" id="L443">      }</span>
<span class="nc" id="L444">    }</span>
<span class="nc" id="L445">    jaxbPlaylist.setEntries(jaxbPlaylistEntries);</span>

<span class="nc" id="L447">    return jaxbPlaylist;</span>
  }

  /**
   * Runs a permission check on the given playlist for the given action
   * @param playlist {@link Playlist} to check permission for
   * @param action Action to check permission for
   * @return True if action is permitted on the {@link Playlist}, else false
   */
  private boolean checkPermission(Playlist playlist, Permissions.Action action) {
<span class="fc" id="L457">    User currentUser = securityService.getUser();</span>
<span class="fc" id="L458">    Organization currentOrg = securityService.getOrganization();</span>
<span class="fc" id="L459">    String currentOrgAdminRole = currentOrg.getAdminRole();</span>
<span class="fc" id="L460">    String currentOrgId = currentOrg.getId();</span>

<span class="pc bpc" id="L462" title="1 of 2 branches missed.">    return currentUser.hasRole(GLOBAL_ADMIN_ROLE)</span>
<span class="nc bnc" id="L463" title="All 4 branches missed.">        || (currentUser.hasRole(currentOrgAdminRole) &amp;&amp; currentOrgId.equals(playlist.getOrganization()))</span>
<span class="pc bnc" id="L464" title="All 2 branches missed.">        || authorizationService.hasPermission(getAccessControlList(playlist), action.toString());</span>
  }

  /**
   * Parse the access information for a playlist from its database format into an {@link AccessControlList}
   * @param playlist The {@link Playlist} to get the {@link AccessControlList} for
   * @return The {@link AccessControlList} for the given {@link Playlist}
   */
  private AccessControlList getAccessControlList(Playlist playlist) {
<span class="nc" id="L473">    List&lt;AccessControlEntry&gt; accessControlEntries = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">    for (PlaylistAccessControlEntry entry : playlist.getAccessControlEntries()) {</span>
<span class="nc" id="L475">      accessControlEntries.add(entry.toAccessControlEntry());</span>
<span class="nc" id="L476">    }</span>
<span class="nc" id="L477">    return new AccessControlList(accessControlEntries);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>