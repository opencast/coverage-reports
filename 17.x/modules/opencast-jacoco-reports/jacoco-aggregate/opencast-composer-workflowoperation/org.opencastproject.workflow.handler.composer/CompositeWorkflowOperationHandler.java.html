<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CompositeWorkflowOperationHandler.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-composer-workflowoperation</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.workflow.handler.composer</a> &gt; <span class="el_source">CompositeWorkflowOperationHandler.java</span></div><h1>CompositeWorkflowOperationHandler.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.workflow.handler.composer;

import static org.opencastproject.util.data.Collections.list;

import org.opencastproject.composer.api.ComposerService;
import org.opencastproject.composer.api.EncoderException;
import org.opencastproject.composer.api.EncodingProfile;
import org.opencastproject.composer.api.LaidOutElement;
import org.opencastproject.composer.layout.AbsolutePositionLayoutSpec;
import org.opencastproject.composer.layout.Dimension;
import org.opencastproject.composer.layout.HorizontalCoverageLayoutSpec;
import org.opencastproject.composer.layout.LayoutManager;
import org.opencastproject.composer.layout.MultiShapeLayout;
import org.opencastproject.composer.layout.Serializer;
import org.opencastproject.job.api.Job;
import org.opencastproject.job.api.JobContext;
import org.opencastproject.mediapackage.Attachment;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.mediapackage.MediaPackageElementFlavor;
import org.opencastproject.mediapackage.MediaPackageElementParser;
import org.opencastproject.mediapackage.MediaPackageException;
import org.opencastproject.mediapackage.Track;
import org.opencastproject.mediapackage.TrackSupport;
import org.opencastproject.mediapackage.VideoStream;
import org.opencastproject.mediapackage.attachment.AttachmentImpl;
import org.opencastproject.mediapackage.selector.AbstractMediaPackageElementSelector;
import org.opencastproject.mediapackage.selector.AttachmentSelector;
import org.opencastproject.mediapackage.selector.TrackSelector;
import org.opencastproject.serviceregistry.api.ServiceRegistry;
import org.opencastproject.util.JsonObj;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.UrlSupport;
import org.opencastproject.util.data.Option;
import org.opencastproject.util.data.Tuple;
import org.opencastproject.workflow.api.AbstractWorkflowOperationHandler;
import org.opencastproject.workflow.api.ConfiguredTagsAndFlavors;
import org.opencastproject.workflow.api.WorkflowInstance;
import org.opencastproject.workflow.api.WorkflowOperationException;
import org.opencastproject.workflow.api.WorkflowOperationHandler;
import org.opencastproject.workflow.api.WorkflowOperationInstance;
import org.opencastproject.workflow.api.WorkflowOperationResult;
import org.opencastproject.workflow.api.WorkflowOperationResult.Action;
import org.opencastproject.workspace.api.Workspace;

import org.apache.commons.io.FilenameUtils;
import org.apache.commons.io.IOUtils;
import org.apache.commons.lang3.StringUtils;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.awt.image.BufferedImage;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.net.URI;
import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.UUID;
import java.util.regex.Pattern;

import javax.imageio.ImageIO;

/**
 * The workflow definition for handling &quot;composite&quot; operations
 */
@Component(
    immediate = true,
    service = WorkflowOperationHandler.class,
    property = {
        &quot;service.description=Composite Workflow Operation Handler&quot;,
        &quot;workflow.operation=composite&quot;
    }
)
<span class="fc" id="L98">public class CompositeWorkflowOperationHandler extends AbstractWorkflowOperationHandler {</span>

  private static final String COLLECTION = &quot;composite&quot;;

  private static final String SOURCE_AUDIO_NAME = &quot;source-audio-name&quot;;
  private static final String SOURCE_TAGS_UPPER = &quot;source-tags-upper&quot;;
  private static final String SOURCE_FLAVOR_UPPER = &quot;source-flavor-upper&quot;;
  private static final String SOURCE_TAGS_LOWER = &quot;source-tags-lower&quot;;
  private static final String SOURCE_FLAVOR_LOWER = &quot;source-flavor-lower&quot;;
  private static final String SOURCE_TAGS_WATERMARK = &quot;source-tags-watermark&quot;;
  private static final String SOURCE_FLAVOR_WATERMARK = &quot;source-flavor-watermark&quot;;
  private static final String SOURCE_URL_WATERMARK = &quot;source-url-watermark&quot;;

  private static final String ENCODING_PROFILE = &quot;encoding-profile&quot;;

  private static final String LAYOUT = &quot;layout&quot;;
  private static final String LAYOUT_MULTIPLE = &quot;layout-multiple&quot;;
  private static final String LAYOUT_SINGLE = &quot;layout-single&quot;;
  private static final String LAYOUT_PREFIX = &quot;layout-&quot;;

  private static final String OUTPUT_RESOLUTION = &quot;output-resolution&quot;;
  private static final String OUTPUT_BACKGROUND = &quot;output-background&quot;;
  private static final String DEFAULT_BG_COLOR = &quot;black&quot;;

  /** The logging facility */
<span class="fc" id="L123">  private static final Logger logger = LoggerFactory.getLogger(CompositeWorkflowOperationHandler.class);</span>

  /** The legal options for SOURCE_AUDIO_NAME */
<span class="fc" id="L126">  private static final Pattern sourceAudioOption = Pattern.compile(</span>
          ComposerService.LOWER + &quot;|&quot; + ComposerService.UPPER + &quot;|&quot; + ComposerService.BOTH, Pattern.CASE_INSENSITIVE);

  /** The composer service */
<span class="fc" id="L130">  private ComposerService composerService = null;</span>

  /** The local workspace */
<span class="fc" id="L133">  private Workspace workspace = null;</span>

  /**
   * Callback for the OSGi declarative services configuration.
   *
   * @param composerService
   *          the local composer service
   */
  @Reference
  public void setComposerService(ComposerService composerService) {
<span class="fc" id="L143">    this.composerService = composerService;</span>
<span class="fc" id="L144">  }</span>

  /**
   * Callback for declarative services configuration that will introduce us to the local workspace service.
   * Implementation assumes that the reference is configured as being static.
   *
   * @param workspace
   *          an instance of the workspace
   */
  @Reference
  public void setWorkspace(Workspace workspace) {
<span class="fc" id="L155">    this.workspace = workspace;</span>
<span class="fc" id="L156">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowOperationHandler#start(org.opencastproject.workflow.api.WorkflowInstance,
   *      JobContext)
   */
  @Override
  public WorkflowOperationResult start(final WorkflowInstance workflowInstance, JobContext context)
          throws WorkflowOperationException {
<span class="fc" id="L167">    logger.debug(&quot;Running composite workflow operation on workflow {}&quot;, workflowInstance.getId());</span>

    try {
<span class="fc" id="L170">      return composite(workflowInstance);</span>
<span class="fc" id="L171">    } catch (Exception e) {</span>
<span class="fc" id="L172">      throw new WorkflowOperationException(e);</span>
    }
  }

  private WorkflowOperationResult composite(WorkflowInstance wi)
          throws EncoderException, IOException, NotFoundException, MediaPackageException, WorkflowOperationException {
<span class="fc" id="L178">    MediaPackage src = wi.getMediaPackage();</span>
<span class="fc" id="L179">    MediaPackage mediaPackage = (MediaPackage) src.clone();</span>
    CompositeSettings compositeSettings;
    try {
<span class="fc" id="L182">      compositeSettings = new CompositeSettings(wi);</span>
<span class="nc" id="L183">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L184">      logger.warn(&quot;Unable to parse composite settings because&quot;, e);</span>
<span class="nc" id="L185">      return createResult(mediaPackage, Action.SKIP);</span>
<span class="fc" id="L186">    }</span>
<span class="fc" id="L187">    Option&lt;Attachment&gt; watermarkAttachment = Option.&lt;Attachment&gt; none();</span>
<span class="fc" id="L188">    Collection&lt;Attachment&gt; watermarkElements = compositeSettings.getWatermarkSelector().select(mediaPackage, false);</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">    if (watermarkElements.size() &gt; 1) {</span>
<span class="nc" id="L190">      logger.warn(&quot;More than one watermark attachment has been found for compositing, skipping compositing!: {}&quot;,</span>
              watermarkElements);
<span class="nc" id="L192">      return createResult(mediaPackage, Action.SKIP);</span>
<span class="pc bpc" id="L193" title="1 of 4 branches missed.">    } else if (watermarkElements.size() == 0 &amp;&amp; compositeSettings.getSourceUrlWatermark() != null) {</span>
<span class="fc" id="L194">      logger.info(&quot;No watermark found from flavor and tags, take watermark from URL {}&quot;,</span>
<span class="fc" id="L195">              compositeSettings.getSourceUrlWatermark());</span>
<span class="fc" id="L196">      Attachment urlAttachment = new AttachmentImpl();</span>
<span class="fc" id="L197">      urlAttachment.setIdentifier(compositeSettings.getWatermarkIdentifier());</span>

<span class="pc bpc" id="L199" title="1 of 2 branches missed.">      if (compositeSettings.getSourceUrlWatermark().startsWith(&quot;http&quot;)) {</span>
<span class="nc" id="L200">        urlAttachment.setURI(UrlSupport.uri(compositeSettings.getSourceUrlWatermark()));</span>
      } else {
<span class="fc" id="L202">        InputStream in = null;</span>
        try {
<span class="fc" id="L204">          in = UrlSupport.url(compositeSettings.getSourceUrlWatermark()).openStream();</span>
<span class="fc" id="L205">          URI imageUrl = workspace.putInCollection(COLLECTION, compositeSettings.getWatermarkIdentifier() + &quot;.&quot;</span>
<span class="fc" id="L206">                  + FilenameUtils.getExtension(compositeSettings.getSourceUrlWatermark()), in);</span>
<span class="fc" id="L207">          urlAttachment.setURI(imageUrl);</span>
<span class="nc" id="L208">        } catch (Exception e) {</span>
<span class="nc" id="L209">          logger.warn(&quot;Unable to read watermark source url {}&quot;, compositeSettings.getSourceUrlWatermark(), e);</span>
<span class="nc" id="L210">          throw new WorkflowOperationException(&quot;Unable to read watermark source url &quot;</span>
<span class="nc" id="L211">                  + compositeSettings.getSourceUrlWatermark(), e);</span>
        } finally {
<span class="fc" id="L213">          IOUtils.closeQuietly(in);</span>
        }
      }
<span class="fc" id="L216">      watermarkAttachment = Option.option(urlAttachment);</span>
<span class="pc bpc" id="L217" title="2 of 4 branches missed.">    } else if (watermarkElements.size() == 0 &amp;&amp; compositeSettings.getSourceUrlWatermark() == null) {</span>
<span class="fc" id="L218">      logger.info(&quot;No watermark to composite&quot;);</span>
    } else {
<span class="nc bnc" id="L220" title="All 2 branches missed.">      for (Attachment a : watermarkElements)</span>
<span class="nc" id="L221">        watermarkAttachment = Option.option(a);</span>
    }

<span class="fc" id="L224">    Collection&lt;Track&gt; upperElements = compositeSettings.getUpperTrackSelector().select(mediaPackage, false);</span>
<span class="fc" id="L225">    Collection&lt;Track&gt; lowerElements = compositeSettings.getLowerTrackSelector().select(mediaPackage, false);</span>

    // There is only a single track to work with.
<span class="pc bpc" id="L228" title="2 of 4 branches missed.">    if ((upperElements.size() == 1 &amp;&amp; lowerElements.size() == 0)</span>
<span class="pc bpc" id="L229" title="3 of 4 branches missed.">            || (upperElements.size() == 0 &amp;&amp; lowerElements.size() == 1)) {</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">      for (Track t : upperElements)</span>
<span class="nc" id="L231">        compositeSettings.setSingleTrack(t);</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">      for (Track t : lowerElements)</span>
<span class="nc" id="L233">        compositeSettings.setSingleTrack(t);</span>
<span class="nc" id="L234">      return handleSingleTrack(mediaPackage, compositeSettings, watermarkAttachment);</span>
    } else {
      // Look for upper elements matching the tags and flavor
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">      if (upperElements.size() &gt; 1) {</span>
<span class="nc" id="L238">        logger.warn(&quot;More than one upper track has been found for compositing, skipping compositing!: {}&quot;,</span>
                upperElements);
<span class="nc" id="L240">        return createResult(mediaPackage, Action.SKIP);</span>
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">      } else if (upperElements.size() == 0) {</span>
<span class="nc" id="L242">        logger.warn(&quot;No upper track has been found for compositing, skipping compositing!&quot;);</span>
<span class="nc" id="L243">        return createResult(mediaPackage, Action.SKIP);</span>
      }

<span class="fc bfc" id="L246" title="All 2 branches covered.">      for (Track t : upperElements) {</span>
<span class="fc" id="L247">        compositeSettings.setUpperTrack(t);</span>
<span class="fc" id="L248">      }</span>

      // Look for lower elements matching the tags and flavor
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">      if (lowerElements.size() &gt; 1) {</span>
<span class="nc" id="L252">        logger.warn(&quot;More than one lower track has been found for compositing, skipping compositing!: {}&quot;,</span>
                lowerElements);
<span class="nc" id="L254">        return createResult(mediaPackage, Action.SKIP);</span>
<span class="pc bpc" id="L255" title="1 of 2 branches missed.">      } else if (lowerElements.size() == 0) {</span>
<span class="nc" id="L256">        logger.warn(&quot;No lower track has been found for compositing, skipping compositing!&quot;);</span>
<span class="nc" id="L257">        return createResult(mediaPackage, Action.SKIP);</span>
      }

<span class="fc bfc" id="L260" title="All 2 branches covered.">      for (Track t : lowerElements) {</span>
<span class="fc" id="L261">        compositeSettings.setLowerTrack(t);</span>
<span class="fc" id="L262">      }</span>

<span class="fc" id="L264">      return handleMultipleTracks(mediaPackage, compositeSettings, watermarkAttachment);</span>
    }
  }

  /**
   * This class collects and calculates all of the relevant data for doing a composite whether there is a single or two
   * video tracks.
   */
  private class CompositeSettings {

    /** Use a fixed output resolution */
    public static final String OUTPUT_RESOLUTION_FIXED = &quot;fixed&quot;;

    /** Use resolution of lower part as output resolution */
    public static final String OUTPUT_RESOLUTION_LOWER =  &quot;lower&quot;;

    /** Use resolution of upper part as output resolution */
    public static final String OUTPUT_RESOLUTION_UPPER = &quot;upper&quot;;

    private String sourceAudioName;
    private String sourceTagsUpper;
    private String sourceFlavorUpper;
    private String sourceTagsLower;
    private String sourceFlavorLower;
    private String sourceTagsWatermark;
    private String sourceFlavorWatermark;
    private String sourceUrlWatermark;
    private String encodingProfile;
    private String layoutMultipleString;
    private String layoutSingleString;
    private String outputResolution;
    private String outputBackground;

<span class="fc" id="L297">    private AbstractMediaPackageElementSelector&lt;Track&gt; upperTrackSelector = new TrackSelector();</span>
<span class="fc" id="L298">    private AbstractMediaPackageElementSelector&lt;Track&gt; lowerTrackSelector = new TrackSelector();</span>
<span class="fc" id="L299">    private AbstractMediaPackageElementSelector&lt;Attachment&gt; watermarkSelector = new AttachmentSelector();</span>

    private String watermarkIdentifier;
<span class="fc" id="L302">    private Option&lt;AbsolutePositionLayoutSpec&gt; watermarkLayout = Option.none();</span>

<span class="fc" id="L304">    private List&lt;HorizontalCoverageLayoutSpec&gt; multiSourceLayouts = new ArrayList&lt;HorizontalCoverageLayoutSpec&gt;();</span>
    private HorizontalCoverageLayoutSpec singleSourceLayout;

    private Track upperTrack;
    private Track lowerTrack;
    private Track singleTrack;

    private String outputResolutionSource;
    private Dimension outputDimension;

    private EncodingProfile profile;

    private List&lt;String&gt; targetTags;

<span class="fc" id="L318">    private MediaPackageElementFlavor targetFlavor = null;</span>

<span class="fc" id="L320">    CompositeSettings(WorkflowInstance wi) throws WorkflowOperationException {</span>
<span class="fc" id="L321">      WorkflowOperationInstance operation = wi.getCurrentOperation();</span>
<span class="fc" id="L322">      ConfiguredTagsAndFlavors tagsAndFlavors = getTagsAndFlavors(wi,</span>
          Configuration.none, Configuration.none, Configuration.many, Configuration.one);
<span class="fc" id="L324">      sourceAudioName = StringUtils.trimToNull(operation.getConfiguration(SOURCE_AUDIO_NAME));</span>
<span class="fc bfc" id="L325" title="All 2 branches covered.">      if (sourceAudioName == null) {</span>
<span class="fc" id="L326">        sourceAudioName = ComposerService.BOTH; // default</span>
<span class="pc bpc" id="L327" title="1 of 2 branches missed.">      } else if (!sourceAudioOption.matcher(sourceAudioName).matches()) {</span>
<span class="nc" id="L328">        throw new WorkflowOperationException(&quot;sourceAudioName if used, must be either upper, lower or both!&quot;);</span>
      }

<span class="fc" id="L331">      sourceTagsUpper = StringUtils.trimToNull(operation.getConfiguration(SOURCE_TAGS_UPPER));</span>
<span class="fc" id="L332">      sourceFlavorUpper = StringUtils.trimToNull(operation.getConfiguration(SOURCE_FLAVOR_UPPER));</span>
<span class="fc" id="L333">      sourceTagsLower = StringUtils.trimToNull(operation.getConfiguration(SOURCE_TAGS_LOWER));</span>
<span class="fc" id="L334">      sourceFlavorLower = StringUtils.trimToNull(operation.getConfiguration(SOURCE_FLAVOR_LOWER));</span>
<span class="fc" id="L335">      sourceTagsWatermark = StringUtils.trimToNull(operation.getConfiguration(SOURCE_TAGS_WATERMARK));</span>
<span class="fc" id="L336">      sourceFlavorWatermark = StringUtils.trimToNull(operation.getConfiguration(SOURCE_FLAVOR_WATERMARK));</span>
<span class="fc" id="L337">      sourceUrlWatermark = StringUtils.trimToNull(operation.getConfiguration(SOURCE_URL_WATERMARK));</span>

<span class="fc" id="L339">      targetTags = tagsAndFlavors.getTargetTags();</span>
<span class="fc" id="L340">      targetFlavor = tagsAndFlavors.getSingleTargetFlavor();</span>

<span class="fc" id="L342">      encodingProfile = StringUtils.trimToNull(operation.getConfiguration(ENCODING_PROFILE));</span>

<span class="fc" id="L344">      layoutMultipleString = StringUtils.trimToNull(operation.getConfiguration(LAYOUT_MULTIPLE));</span>
<span class="pc bpc" id="L345" title="1 of 2 branches missed.">      if (layoutMultipleString == null) {</span>
<span class="fc" id="L346">        layoutMultipleString = StringUtils.trimToNull(operation.getConfiguration(LAYOUT));</span>
      }

<span class="pc bpc" id="L349" title="1 of 4 branches missed.">      if (layoutMultipleString != null &amp;&amp; !layoutMultipleString.contains(&quot;;&quot;)) {</span>
<span class="fc" id="L350">        layoutMultipleString = StringUtils.trimToNull(operation.getConfiguration(LAYOUT_PREFIX + layoutMultipleString));</span>
      }

<span class="fc" id="L353">      layoutSingleString = StringUtils.trimToNull(operation.getConfiguration(LAYOUT_SINGLE));</span>

<span class="fc" id="L355">      outputResolution = StringUtils.trimToNull(operation.getConfiguration(OUTPUT_RESOLUTION));</span>
<span class="fc" id="L356">      outputBackground = StringUtils.trimToNull(operation.getConfiguration(OUTPUT_BACKGROUND));</span>

<span class="fc" id="L358">      watermarkIdentifier = UUID.randomUUID().toString();</span>

<span class="pc bpc" id="L360" title="1 of 2 branches missed.">      if (outputBackground == null) {</span>
<span class="nc" id="L361">        outputBackground = DEFAULT_BG_COLOR;</span>
      }

<span class="fc bfc" id="L364" title="All 2 branches covered.">      if (layoutMultipleString != null) {</span>
<span class="fc" id="L365">        Tuple&lt;List&lt;HorizontalCoverageLayoutSpec&gt;, Option&lt;AbsolutePositionLayoutSpec&gt;&gt; multipleLayouts = parseMultipleLayouts(layoutMultipleString);</span>
<span class="fc" id="L366">        multiSourceLayouts.addAll(multipleLayouts.getA());</span>
<span class="fc" id="L367">        watermarkLayout = multipleLayouts.getB();</span>
      }

<span class="pc bpc" id="L370" title="1 of 2 branches missed.">      if (layoutSingleString != null) {</span>
<span class="fc" id="L371">        Tuple&lt;HorizontalCoverageLayoutSpec, Option&lt;AbsolutePositionLayoutSpec&gt;&gt; singleLayouts = parseSingleLayouts(layoutSingleString);</span>
<span class="fc" id="L372">        singleSourceLayout = singleLayouts.getA();</span>
<span class="fc" id="L373">        watermarkLayout = singleLayouts.getB();</span>
      }

      // Find the encoding profile
<span class="pc bpc" id="L377" title="1 of 2 branches missed.">      if (encodingProfile == null)</span>
<span class="nc" id="L378">        throw new WorkflowOperationException(&quot;Encoding profile must be set!&quot;);</span>

<span class="fc" id="L380">      profile = composerService.getProfile(encodingProfile);</span>
<span class="pc bpc" id="L381" title="1 of 2 branches missed.">      if (profile == null)</span>
<span class="nc" id="L382">        throw new WorkflowOperationException(&quot;Encoding profile '&quot; + encodingProfile + &quot;' was not found&quot;);</span>

      // Output resolution
<span class="pc bpc" id="L385" title="1 of 2 branches missed.">      if (outputResolution == null)</span>
<span class="nc" id="L386">        throw new WorkflowOperationException(&quot;Output resolution must be set!&quot;);</span>

<span class="pc bpc" id="L388" title="2 of 4 branches missed.">      if (outputResolution.equals(OUTPUT_RESOLUTION_LOWER) || outputResolution.equals(OUTPUT_RESOLUTION_UPPER)) {</span>
<span class="nc" id="L389">        outputResolutionSource = outputResolution;</span>
      } else {
<span class="fc" id="L391">        outputResolutionSource = OUTPUT_RESOLUTION_FIXED;</span>
        try {
<span class="fc" id="L393">          String[] outputResolutionArray = StringUtils.split(outputResolution, &quot;x&quot;);</span>
<span class="pc bpc" id="L394" title="1 of 2 branches missed.">          if (outputResolutionArray.length != 2) {</span>
<span class="nc" id="L395">            throw new WorkflowOperationException(&quot;Invalid format of output resolution!&quot;);</span>
          }
<span class="fc" id="L397">          outputDimension = Dimension.dimension(Integer.parseInt(outputResolutionArray[0]),</span>
<span class="fc" id="L398">                  Integer.parseInt(outputResolutionArray[1]));</span>
<span class="nc" id="L399">        } catch (Exception e) {</span>
<span class="nc" id="L400">          throw new WorkflowOperationException(&quot;Unable to parse output resolution!&quot;, e);</span>
<span class="fc" id="L401">        }</span>
      }

      // Make sure either one of tags or flavor for the upper source are provided
<span class="pc bpc" id="L405" title="2 of 4 branches missed.">      if (sourceTagsUpper == null &amp;&amp; sourceFlavorUpper == null) {</span>
<span class="nc" id="L406">        throw new IllegalArgumentException(</span>
                &quot;No source tags or flavor for the upper video have been specified, not matching anything&quot;);
      }

      // Make sure either one of tags or flavor for the lower source are provided
<span class="pc bpc" id="L411" title="2 of 4 branches missed.">      if (sourceTagsLower == null &amp;&amp; sourceFlavorLower == null) {</span>
<span class="nc" id="L412">        throw new IllegalArgumentException(</span>
                &quot;No source tags or flavor for the lower video have been specified, not matching anything&quot;);
      }

      try {
<span class="pc bpc" id="L417" title="2 of 4 branches missed.">        if (&quot;*&quot;.equals(targetFlavor.getType()) || &quot;*&quot;.equals(targetFlavor.getSubtype()))</span>
<span class="nc" id="L418">          throw new WorkflowOperationException(&quot;Target flavor must have a type and a subtype, '*' are not allowed!&quot;);</span>
<span class="nc" id="L419">      } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L420">        throw new WorkflowOperationException(&quot;Target flavor '&quot; + targetFlavor + &quot;' is malformed&quot;);</span>
<span class="fc" id="L421">      }</span>

      // Support legacy &quot;source-flavor-upper&quot; option
<span class="pc bpc" id="L424" title="1 of 2 branches missed.">      if (sourceFlavorUpper != null) {</span>
        try {
<span class="fc" id="L426">          upperTrackSelector.addFlavor(MediaPackageElementFlavor.parseFlavor(sourceFlavorUpper));</span>
<span class="nc" id="L427">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L428">          throw new WorkflowOperationException(&quot;Source upper flavor '&quot; + sourceFlavorUpper + &quot;' is malformed&quot;);</span>
<span class="fc" id="L429">        }</span>
      }

      // Support legacy &quot;source-flavor-lower&quot; option
<span class="pc bpc" id="L433" title="1 of 2 branches missed.">      if (sourceFlavorLower != null) {</span>
        try {
<span class="fc" id="L435">          lowerTrackSelector.addFlavor(MediaPackageElementFlavor.parseFlavor(sourceFlavorLower));</span>
<span class="nc" id="L436">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L437">          throw new WorkflowOperationException(&quot;Source lower flavor '&quot; + sourceFlavorLower + &quot;' is malformed&quot;);</span>
<span class="fc" id="L438">        }</span>
      }

      // Support legacy &quot;source-flavor-watermark&quot; option
<span class="fc bfc" id="L442" title="All 2 branches covered.">      if (sourceFlavorWatermark != null) {</span>
        try {
<span class="fc" id="L444">          watermarkSelector.addFlavor(MediaPackageElementFlavor.parseFlavor(sourceFlavorWatermark));</span>
<span class="nc" id="L445">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L446">          throw new WorkflowOperationException(&quot;Source watermark flavor '&quot; + sourceFlavorWatermark + &quot;' is malformed&quot;);</span>
<span class="fc" id="L447">        }</span>
      }

      // Select the source tags upper
<span class="pc bpc" id="L451" title="1 of 2 branches missed.">      for (String tag : asList(sourceTagsUpper)) {</span>
<span class="nc" id="L452">        upperTrackSelector.addTag(tag);</span>
<span class="nc" id="L453">      }</span>

      // Select the source tags lower
<span class="pc bpc" id="L456" title="1 of 2 branches missed.">      for (String tag : asList(sourceTagsLower)) {</span>
<span class="nc" id="L457">        lowerTrackSelector.addTag(tag);</span>
<span class="nc" id="L458">      }</span>

      // Select the watermark source tags
<span class="pc bpc" id="L461" title="1 of 2 branches missed.">      for (String tag : asList(sourceTagsWatermark)) {</span>
<span class="nc" id="L462">        watermarkSelector.addTag(tag);</span>
<span class="nc" id="L463">      }</span>
<span class="fc" id="L464">    }</span>

    private Tuple&lt;List&lt;HorizontalCoverageLayoutSpec&gt;, Option&lt;AbsolutePositionLayoutSpec&gt;&gt; parseMultipleLayouts(
            String layoutString) throws WorkflowOperationException {
      try {
<span class="fc" id="L469">        String[] layouts = StringUtils.split(layoutString, &quot;;&quot;);</span>
<span class="pc bpc" id="L470" title="1 of 2 branches missed.">        if (layouts.length &lt; 2)</span>
<span class="nc" id="L471">          throw new WorkflowOperationException(</span>
                  &quot;Multiple layout doesn't contain the required layouts for (lower, upper, optional watermark)&quot;);

<span class="fc" id="L474">        List&lt;HorizontalCoverageLayoutSpec&gt; multipleLayouts = list(</span>
<span class="fc" id="L475">                Serializer.horizontalCoverageLayoutSpec(JsonObj.jsonObj(layouts[0])),</span>
<span class="fc" id="L476">                Serializer.horizontalCoverageLayoutSpec(JsonObj.jsonObj(layouts[1])));</span>

<span class="fc" id="L478">        AbsolutePositionLayoutSpec watermarkLayout = null;</span>
<span class="pc bpc" id="L479" title="1 of 2 branches missed.">        if (layouts.length &gt; 2)</span>
<span class="fc" id="L480">          watermarkLayout = Serializer.absolutePositionLayoutSpec(JsonObj.jsonObj(layouts[2]));</span>

<span class="fc" id="L482">        return Tuple.tuple(multipleLayouts, Option.option(watermarkLayout));</span>
<span class="nc" id="L483">      } catch (Exception e) {</span>
<span class="nc" id="L484">        throw new WorkflowOperationException(&quot;Unable to parse layout!&quot;, e);</span>
      }
    }

    private Tuple&lt;HorizontalCoverageLayoutSpec, Option&lt;AbsolutePositionLayoutSpec&gt;&gt; parseSingleLayouts(
            String layoutString) throws WorkflowOperationException {
      try {
<span class="fc" id="L491">        String[] layouts = StringUtils.split(layoutString, &quot;;&quot;);</span>
<span class="pc bpc" id="L492" title="1 of 2 branches missed.">        if (layouts.length &lt; 1)</span>
<span class="nc" id="L493">          throw new WorkflowOperationException(</span>
                  &quot;Single layout doesn't contain the required layouts for (video, optional watermark)&quot;);

<span class="fc" id="L496">        HorizontalCoverageLayoutSpec singleLayout = Serializer</span>
<span class="fc" id="L497">                .horizontalCoverageLayoutSpec(JsonObj.jsonObj(layouts[0]));</span>

<span class="fc" id="L499">        AbsolutePositionLayoutSpec watermarkLayout = null;</span>
<span class="pc bpc" id="L500" title="1 of 2 branches missed.">        if (layouts.length &gt; 1)</span>
<span class="fc" id="L501">          watermarkLayout = Serializer.absolutePositionLayoutSpec(JsonObj.jsonObj(layouts[1]));</span>

<span class="fc" id="L503">        return Tuple.tuple(singleLayout, Option.option(watermarkLayout));</span>
<span class="nc" id="L504">      } catch (Exception e) {</span>
<span class="nc" id="L505">        throw new WorkflowOperationException(&quot;Unable to parse layout!&quot;, e);</span>
      }
    }

    public String getSourceUrlWatermark() {
<span class="fc" id="L510">      return sourceUrlWatermark;</span>
    }

    public MediaPackageElementFlavor getTargetFlavor() {
<span class="fc" id="L514">      return targetFlavor;</span>
    }

    public List&lt;String&gt; getTargetTags() {
<span class="fc" id="L518">      return targetTags;</span>
    }

    public String getSourceAudioName() {
<span class="fc" id="L522">      return sourceAudioName;</span>
    }

    public String getOutputBackground() {
<span class="fc" id="L526">      return outputBackground;</span>
    }

    public AbstractMediaPackageElementSelector&lt;Track&gt; getUpperTrackSelector() {
<span class="fc" id="L530">      return upperTrackSelector;</span>
    }

    public AbstractMediaPackageElementSelector&lt;Track&gt; getLowerTrackSelector() {
<span class="fc" id="L534">      return lowerTrackSelector;</span>
    }

    public AbstractMediaPackageElementSelector&lt;Attachment&gt; getWatermarkSelector() {
<span class="fc" id="L538">      return watermarkSelector;</span>
    }

    public String getWatermarkIdentifier() {
<span class="fc" id="L542">      return watermarkIdentifier;</span>
    }

    public Option&lt;AbsolutePositionLayoutSpec&gt; getWatermarkLayout() {
<span class="fc" id="L546">      return watermarkLayout;</span>
    }

    public List&lt;HorizontalCoverageLayoutSpec&gt; getMultiSourceLayouts() {
<span class="fc" id="L550">      return multiSourceLayouts;</span>
    }

    public HorizontalCoverageLayoutSpec getSingleSourceLayout() {
<span class="nc" id="L554">      return singleSourceLayout;</span>
    }

    public Track getUpperTrack() {
<span class="fc" id="L558">      return upperTrack;</span>
    }

    public void setUpperTrack(Track upperTrack) {
<span class="fc" id="L562">      this.upperTrack = upperTrack;</span>
<span class="fc" id="L563">    }</span>

    public Track getLowerTrack() {
<span class="fc" id="L566">      return lowerTrack;</span>
    }

    public void setLowerTrack(Track lowerTrack) {
<span class="fc" id="L570">      this.lowerTrack = lowerTrack;</span>
<span class="fc" id="L571">    }</span>

    public Track getSingleTrack() {
<span class="nc" id="L574">      return singleTrack;</span>
    }

    public void setSingleTrack(Track singleTrack) {
<span class="nc" id="L578">      this.singleTrack = singleTrack;</span>
<span class="nc" id="L579">    }</span>

    public String getOutputResolutionSource() {
<span class="fc" id="L582">      return outputResolutionSource;</span>
    }

    public Dimension getOutputDimension() {
<span class="fc" id="L586">      return outputDimension;</span>
    }

    public EncodingProfile getProfile() {
<span class="fc" id="L590">      return profile;</span>
    }
  }

  private WorkflowOperationResult handleSingleTrack(MediaPackage mediaPackage,
          CompositeSettings compositeSettings, Option&lt;Attachment&gt; watermarkAttachment) throws EncoderException,
          IOException, NotFoundException, MediaPackageException, WorkflowOperationException {

<span class="nc bnc" id="L598" title="All 2 branches missed.">    if (compositeSettings.getSingleSourceLayout() == null) {</span>
<span class="nc" id="L599">      throw new WorkflowOperationException(&quot;Single video layout must be set! Please verify that you have a &quot;</span>
              + LAYOUT_SINGLE + &quot; property in your composite operation in your workflow definition.&quot;);
    }

    try {
<span class="nc" id="L604">      VideoStream[] videoStreams = TrackSupport.byType(compositeSettings.getSingleTrack().getStreams(),</span>
              VideoStream.class);
<span class="nc bnc" id="L606" title="All 2 branches missed.">      if (videoStreams.length == 0) {</span>
<span class="nc" id="L607">        logger.warn(&quot;No video stream available to compose! {}&quot;, compositeSettings.getSingleTrack());</span>
<span class="nc" id="L608">        return createResult(mediaPackage, Action.SKIP);</span>
      }

      // Read the video dimensions from the mediapackage stream information
<span class="nc" id="L612">      Dimension videoDimension = Dimension.dimension(videoStreams[0].getFrameWidth(), videoStreams[0].getFrameHeight());</span>

      // Create the video layout definitions
<span class="nc" id="L615">      List&lt;Tuple&lt;Dimension, HorizontalCoverageLayoutSpec&gt;&gt; shapes = new ArrayList&lt;Tuple&lt;Dimension, HorizontalCoverageLayoutSpec&gt;&gt;();</span>
<span class="nc" id="L616">      shapes.add(0, Tuple.tuple(videoDimension, compositeSettings.getSingleSourceLayout()));</span>

      // Determine dimension of output
<span class="nc" id="L619">      Dimension outputDimension = null;</span>
<span class="nc" id="L620">      String outputResolutionSource = compositeSettings.getOutputResolutionSource();</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">      if (outputResolutionSource.equals(CompositeSettings.OUTPUT_RESOLUTION_FIXED)) {</span>
<span class="nc" id="L622">        outputDimension = compositeSettings.getOutputDimension();</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">      } else if (outputResolutionSource.equals(CompositeSettings.OUTPUT_RESOLUTION_LOWER)) {</span>
<span class="nc" id="L624">        outputDimension = videoDimension;</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">      } else if (outputResolutionSource.equals(CompositeSettings.OUTPUT_RESOLUTION_UPPER)) {</span>
<span class="nc" id="L626">        outputDimension = videoDimension;</span>
      }

      // Calculate the single layout
<span class="nc" id="L630">      MultiShapeLayout multiShapeLayout = LayoutManager</span>
<span class="nc" id="L631">              .multiShapeLayout(outputDimension, shapes);</span>

      // Create the laid out element for the videos
<span class="nc" id="L634">      LaidOutElement&lt;Track&gt; lowerLaidOutElement = new LaidOutElement&lt;Track&gt;(compositeSettings.getSingleTrack(),</span>
<span class="nc" id="L635">              multiShapeLayout.getShapes().get(0));</span>

      // Create the optionally laid out element for the watermark
<span class="nc" id="L638">      Option&lt;LaidOutElement&lt;Attachment&gt;&gt; watermarkOption = createWatermarkLaidOutElement(compositeSettings,</span>
              outputDimension, watermarkAttachment);

<span class="nc" id="L641">      Job compositeJob = composerService.composite(outputDimension, Option</span>
<span class="nc" id="L642">              .&lt;LaidOutElement&lt;Track&gt;&gt; none(), lowerLaidOutElement, watermarkOption, compositeSettings.getProfile()</span>
<span class="nc" id="L643">              .getIdentifier(), compositeSettings.getOutputBackground(), compositeSettings.getSourceAudioName());</span>

      // Wait for the jobs to return
<span class="nc bnc" id="L646" title="All 2 branches missed.">      if (!waitForStatus(compositeJob).isSuccess())</span>
<span class="nc" id="L647">        throw new WorkflowOperationException(&quot;The composite job did not complete successfully&quot;);</span>

<span class="nc bnc" id="L649" title="All 2 branches missed.">      if (compositeJob.getPayload().length() &gt; 0) {</span>

<span class="nc" id="L651">        Track compoundTrack = (Track) MediaPackageElementParser.getFromXml(compositeJob.getPayload());</span>

<span class="nc" id="L653">        compoundTrack.setURI(workspace.moveTo(compoundTrack.getURI(), mediaPackage.getIdentifier().toString(),</span>
<span class="nc" id="L654">                compoundTrack.getIdentifier(),</span>
<span class="nc" id="L655">                &quot;composite.&quot; + FilenameUtils.getExtension(compoundTrack.getURI().toString())));</span>

        // Adjust the target tags
<span class="nc bnc" id="L658" title="All 2 branches missed.">        for (String tag : compositeSettings.getTargetTags()) {</span>
<span class="nc" id="L659">          logger.trace(&quot;Tagging compound track with '{}'&quot;, tag);</span>
<span class="nc" id="L660">          compoundTrack.addTag(tag);</span>
<span class="nc" id="L661">        }</span>

        // Adjust the target flavor.
<span class="nc" id="L664">        compoundTrack.setFlavor(compositeSettings.getTargetFlavor());</span>
<span class="nc" id="L665">        logger.debug(&quot;Compound track has flavor '{}'&quot;, compoundTrack.getFlavor());</span>

        // store new tracks to mediaPackage
<span class="nc" id="L668">        mediaPackage.add(compoundTrack);</span>
<span class="nc" id="L669">        WorkflowOperationResult result = createResult(mediaPackage, Action.CONTINUE, compositeJob.getQueueTime());</span>
<span class="nc" id="L670">        logger.debug(&quot;Composite operation completed&quot;);</span>
<span class="nc" id="L671">        return result;</span>
      } else {
<span class="nc" id="L673">        logger.info(&quot;Composite operation unsuccessful, no payload returned: {}&quot;, compositeJob);</span>
<span class="nc" id="L674">        return createResult(mediaPackage, Action.SKIP);</span>
      }
    } finally {
<span class="nc bnc" id="L677" title="All 2 branches missed.">      if (compositeSettings.getSourceUrlWatermark() != null)</span>
<span class="nc" id="L678">        workspace.deleteFromCollection(</span>
                COLLECTION,
<span class="nc" id="L680">                compositeSettings.getWatermarkIdentifier() + &quot;.&quot;</span>
<span class="nc" id="L681">                        + FilenameUtils.getExtension(compositeSettings.getSourceUrlWatermark()));</span>
    }
  }

  private Option&lt;LaidOutElement&lt;Attachment&gt;&gt; createWatermarkLaidOutElement(CompositeSettings compositeSettings,
          Dimension outputDimension, Option&lt;Attachment&gt; watermarkAttachment) throws WorkflowOperationException {
<span class="fc" id="L687">    Option&lt;LaidOutElement&lt;Attachment&gt;&gt; watermarkOption = Option.&lt;LaidOutElement&lt;Attachment&gt;&gt; none();</span>
<span class="pc bpc" id="L688" title="1 of 4 branches missed.">    if (watermarkAttachment.isSome() &amp;&amp; compositeSettings.getWatermarkLayout().isSome()) {</span>
      BufferedImage image;
      try {
<span class="fc" id="L691">        File watermarkFile = workspace.get(watermarkAttachment.get().getURI());</span>
<span class="fc" id="L692">        image = ImageIO.read(watermarkFile);</span>
<span class="nc" id="L693">      } catch (Exception e) {</span>
<span class="nc" id="L694">        logger.warn(&quot;Unable to read the watermark image attachment {}&quot;, watermarkAttachment.get().getURI(), e);</span>
<span class="nc" id="L695">        throw new WorkflowOperationException(&quot;Unable to read the watermark image attachment&quot;, e);</span>
<span class="fc" id="L696">      }</span>
      //Such excellent documentation Orcale, much fun.  Because returning null is a totally sane thing to do here
      //https://docs.oracle.com/javase/tutorial/2d/images/loadimage.html
<span class="pc bpc" id="L699" title="1 of 2 branches missed.">      if (null == image) {</span>
<span class="nc" id="L700">        logger.error(&quot;Unable to parse watermark file.  File must be gif, png, jp(e)g, or bmp&quot;);</span>
<span class="nc" id="L701">        throw new WorkflowOperationException(&quot;Unable to parse watermark file.  File must be gif, png, jp(e)g, or bmp&quot;);</span>
      }
<span class="fc" id="L703">      Dimension imageDimension = Dimension.dimension(image.getWidth(), image.getHeight());</span>
<span class="fc" id="L704">      List&lt;Tuple&lt;Dimension, AbsolutePositionLayoutSpec&gt;&gt; watermarkShapes = new ArrayList&lt;Tuple&lt;Dimension, AbsolutePositionLayoutSpec&gt;&gt;();</span>
<span class="fc" id="L705">      watermarkShapes.add(0, Tuple.tuple(imageDimension, compositeSettings.getWatermarkLayout().get()));</span>
<span class="fc" id="L706">      MultiShapeLayout watermarkLayout = LayoutManager.absoluteMultiShapeLayout(outputDimension,</span>
              watermarkShapes);
<span class="fc" id="L708">      watermarkOption = Option.some(new LaidOutElement&lt;Attachment&gt;(watermarkAttachment.get(), watermarkLayout</span>
<span class="fc" id="L709">              .getShapes().get(0)));</span>
    }
<span class="fc" id="L711">    return watermarkOption;</span>
  }

  private WorkflowOperationResult handleMultipleTracks(MediaPackage mediaPackage,
          CompositeSettings compositeSettings, Option&lt;Attachment&gt; watermarkAttachment) throws EncoderException,
          IOException, NotFoundException, MediaPackageException, WorkflowOperationException {
<span class="pc bpc" id="L717" title="1 of 4 branches missed.">    if (compositeSettings.getMultiSourceLayouts() == null || compositeSettings.getMultiSourceLayouts().size() == 0) {</span>
<span class="fc" id="L718">      throw new WorkflowOperationException(</span>
              &quot;Multi video layout must be set! Please verify that you have a &quot;
                      + LAYOUT_MULTIPLE
                      + &quot; or &quot;
                      + LAYOUT
                      + &quot; property in your composite operation in your workflow definition to be able to handle multiple videos&quot;);
    }

    try {
<span class="fc" id="L727">      Track upperTrack = compositeSettings.getUpperTrack();</span>
<span class="fc" id="L728">      Track lowerTrack = compositeSettings.getLowerTrack();</span>
<span class="fc" id="L729">      List&lt;HorizontalCoverageLayoutSpec&gt; layouts = compositeSettings.getMultiSourceLayouts();</span>

<span class="fc" id="L731">      VideoStream[] upperVideoStreams = TrackSupport.byType(upperTrack.getStreams(), VideoStream.class);</span>
<span class="pc bpc" id="L732" title="1 of 2 branches missed.">      if (upperVideoStreams.length == 0) {</span>
<span class="nc" id="L733">        logger.warn(&quot;No video stream available in the upper track! {}&quot;, upperTrack);</span>
<span class="nc" id="L734">        return createResult(mediaPackage, Action.SKIP);</span>
      }

<span class="fc" id="L737">      VideoStream[] lowerVideoStreams = TrackSupport.byType(lowerTrack.getStreams(), VideoStream.class);</span>
<span class="pc bpc" id="L738" title="1 of 2 branches missed.">      if (lowerVideoStreams.length == 0) {</span>
<span class="nc" id="L739">        logger.warn(&quot;No video stream available in the lower track! {}&quot;, lowerTrack);</span>
<span class="nc" id="L740">        return createResult(mediaPackage, Action.SKIP);</span>
      }

      // Read the video dimensions from the mediapackage stream information
<span class="fc" id="L744">      Dimension upperDimensions = Dimension.dimension(upperVideoStreams[0].getFrameWidth(),</span>
<span class="fc" id="L745">              upperVideoStreams[0].getFrameHeight());</span>
<span class="fc" id="L746">      Dimension lowerDimensions = Dimension.dimension(lowerVideoStreams[0].getFrameWidth(),</span>
<span class="fc" id="L747">              lowerVideoStreams[0].getFrameHeight());</span>

      // Determine dimension of output
<span class="fc" id="L750">      Dimension outputDimension = null;</span>
<span class="fc" id="L751">      String outputResolutionSource = compositeSettings.getOutputResolutionSource();</span>
<span class="pc bpc" id="L752" title="1 of 2 branches missed.">      if (outputResolutionSource.equals(CompositeSettings.OUTPUT_RESOLUTION_FIXED)) {</span>
<span class="fc" id="L753">        outputDimension = compositeSettings.getOutputDimension();</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">      } else if (outputResolutionSource.equals(CompositeSettings.OUTPUT_RESOLUTION_LOWER)) {</span>
<span class="nc" id="L755">        outputDimension = lowerDimensions;</span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">      } else if (outputResolutionSource.equals(CompositeSettings.OUTPUT_RESOLUTION_UPPER)) {</span>
<span class="nc" id="L757">        outputDimension = upperDimensions;</span>
      }

      // Create the video layout definitions
<span class="fc" id="L761">      List&lt;Tuple&lt;Dimension, HorizontalCoverageLayoutSpec&gt;&gt; shapes = new ArrayList&lt;Tuple&lt;Dimension, HorizontalCoverageLayoutSpec&gt;&gt;();</span>
<span class="fc" id="L762">      shapes.add(0, Tuple.tuple(lowerDimensions, layouts.get(0)));</span>
<span class="fc" id="L763">      shapes.add(1, Tuple.tuple(upperDimensions, layouts.get(1)));</span>

      // Calculate the layout
<span class="fc" id="L766">      MultiShapeLayout multiShapeLayout = LayoutManager</span>
<span class="fc" id="L767">              .multiShapeLayout(outputDimension, shapes);</span>

      // Create the laid out element for the videos
<span class="fc" id="L770">      LaidOutElement&lt;Track&gt; lowerLaidOutElement = new LaidOutElement&lt;Track&gt;(lowerTrack, multiShapeLayout.getShapes()</span>
<span class="fc" id="L771">              .get(0));</span>
<span class="fc" id="L772">      LaidOutElement&lt;Track&gt; upperLaidOutElement = new LaidOutElement&lt;Track&gt;(upperTrack, multiShapeLayout.getShapes()</span>
<span class="fc" id="L773">              .get(1));</span>

      // Create the optionally laid out element for the watermark
<span class="fc" id="L776">      Option&lt;LaidOutElement&lt;Attachment&gt;&gt; watermarkOption = createWatermarkLaidOutElement(compositeSettings,</span>
              outputDimension, watermarkAttachment);

<span class="fc" id="L779">      Job compositeJob = composerService.composite(outputDimension, Option</span>
<span class="fc" id="L780">              .option(upperLaidOutElement), lowerLaidOutElement, watermarkOption, compositeSettings.getProfile()</span>
<span class="fc" id="L781">              .getIdentifier(), compositeSettings.getOutputBackground(), compositeSettings.getSourceAudioName());</span>

      // Wait for the jobs to return
<span class="pc bpc" id="L784" title="1 of 2 branches missed.">      if (!waitForStatus(compositeJob).isSuccess())</span>
<span class="nc" id="L785">        throw new WorkflowOperationException(&quot;The composite job did not complete successfully&quot;);</span>

<span class="pc bpc" id="L787" title="1 of 2 branches missed.">      if (compositeJob.getPayload().length() &gt; 0) {</span>

<span class="fc" id="L789">        Track compoundTrack = (Track) MediaPackageElementParser.getFromXml(compositeJob.getPayload());</span>

<span class="fc" id="L791">        compoundTrack.setURI(workspace.moveTo(compoundTrack.getURI(), mediaPackage.getIdentifier().toString(),</span>
<span class="fc" id="L792">                compoundTrack.getIdentifier(),</span>
<span class="fc" id="L793">                &quot;composite.&quot; + FilenameUtils.getExtension(compoundTrack.getURI().toString())));</span>

        // Adjust the target tags
<span class="fc bfc" id="L796" title="All 2 branches covered.">        for (String tag : compositeSettings.getTargetTags()) {</span>
<span class="fc" id="L797">          logger.trace(&quot;Tagging compound track with '{}'&quot;, tag);</span>
<span class="fc" id="L798">          compoundTrack.addTag(tag);</span>
<span class="fc" id="L799">        }</span>

        // Adjust the target flavor.
<span class="fc" id="L802">        compoundTrack.setFlavor(compositeSettings.getTargetFlavor());</span>
<span class="fc" id="L803">        logger.debug(&quot;Compound track has flavor '{}'&quot;, compoundTrack.getFlavor());</span>

        // store new tracks to mediaPackage
<span class="fc" id="L806">        mediaPackage.add(compoundTrack);</span>
<span class="fc" id="L807">        WorkflowOperationResult result = createResult(mediaPackage, Action.CONTINUE, compositeJob.getQueueTime());</span>
<span class="fc" id="L808">        logger.debug(&quot;Composite operation completed&quot;);</span>
<span class="fc" id="L809">        return result;</span>
      } else {
<span class="nc" id="L811">        logger.info(&quot;Composite operation unsuccessful, no payload returned: {}&quot;, compositeJob);</span>
<span class="nc" id="L812">        return createResult(mediaPackage, Action.SKIP);</span>
      }
    } finally {
<span class="fc bfc" id="L815" title="All 2 branches covered.">      if (compositeSettings.getSourceUrlWatermark() != null)</span>
<span class="fc" id="L816">        workspace.deleteFromCollection(</span>
                COLLECTION,
<span class="fc" id="L818">                compositeSettings.getWatermarkIdentifier() + &quot;.&quot;</span>
<span class="fc" id="L819">                        + FilenameUtils.getExtension(compositeSettings.getSourceUrlWatermark()));</span>
    }
  }

  @Reference
  @Override
  public void setServiceRegistry(ServiceRegistry serviceRegistry) {
<span class="fc" id="L826">    super.setServiceRegistry(serviceRegistry);</span>
<span class="fc" id="L827">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>