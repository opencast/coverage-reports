<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>LdapUserProviderFactory.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-userdirectory-ldap</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.userdirectory.ldap</a> &gt; <span class="el_source">LdapUserProviderFactory.java</span></div><h1>LdapUserProviderFactory.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.userdirectory.ldap;

import org.opencastproject.security.api.Organization;
import org.opencastproject.security.api.OrganizationDirectoryService;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.UserProvider;
import org.opencastproject.userdirectory.JpaGroupRoleProvider;
import org.opencastproject.util.NotFoundException;

import org.apache.commons.lang3.ArrayUtils;
import org.apache.commons.lang3.BooleanUtils;
import org.apache.commons.lang3.StringUtils;
import org.apache.commons.lang3.math.NumberUtils;
import org.osgi.framework.BundleContext;
import org.osgi.framework.ServiceRegistration;
import org.osgi.service.cm.ConfigurationException;
import org.osgi.service.cm.ManagedServiceFactory;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.security.ldap.userdetails.LdapAuthoritiesPopulator;

import java.lang.management.ManagementFactory;
import java.util.Arrays;
import java.util.Dictionary;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Hashtable;
import java.util.Map;
import java.util.Objects;
import java.util.Set;
import java.util.concurrent.ConcurrentHashMap;

import javax.management.MalformedObjectNameException;
import javax.management.ObjectName;

/**
 * LDAP implementation of the spring UserDetailsService, taking configuration information from the component context.
 */
@Component(
    immediate = true,
    service = ManagedServiceFactory.class,
    property = {
        &quot;service.pid=org.opencastproject.userdirectory.ldap&quot;,
        &quot;service.description=Provides ldap user directory instances&quot;
    }
)
<span class="nc" id="L73">public class LdapUserProviderFactory implements ManagedServiceFactory {</span>

  /** The logger */
<span class="nc" id="L76">  private static final Logger logger = LoggerFactory.getLogger(LdapUserProviderFactory.class);</span>

  /** This service factory's PID */
  private static final String PID = &quot;org.opencastproject.userdirectory.ldap&quot;;

  /** The key to look up the ldap search filter in the service configuration properties */
  private static final String SEARCH_FILTER_KEY = &quot;org.opencastproject.userdirectory.ldap.searchfilter&quot;;

  /** The key to look up the ldap search base in the service configuration properties */
  private static final String SEARCH_BASE_KEY = &quot;org.opencastproject.userdirectory.ldap.searchbase&quot;;

  /** The key to look up the ldap server URL in the service configuration properties */
  private static final String LDAP_URL_KEY = &quot;org.opencastproject.userdirectory.ldap.url&quot;;

  /** The key to look up the role attributes in the service configuration properties */
  private static final String ROLE_ATTRIBUTES_KEY = &quot;org.opencastproject.userdirectory.ldap.roleattributes&quot;;

  /** The key to look up the users name attributes **/
  private static final String USER_NAME_ATTRIBUTES_KEY = &quot;org.opencastproject.userdirectory.ldap.userattributes.name&quot;;

  /** The key to look up the users attribute to set its mail address**/
  private static final String USER_MAIL_ATTRIBUTE_KEY = &quot;org.opencastproject.userdirectory.ldap.userattributes.mail&quot;;

  /** The key to look up the organization identifier in the service configuration properties */
  private static final String ORGANIZATION_KEY = &quot;org.opencastproject.userdirectory.ldap.org&quot;;

  /** The key to look up the user DN to use for performing searches. */
  private static final String SEARCH_USER_DN = &quot;org.opencastproject.userdirectory.ldap.userDn&quot;;

  /** The key to look up the password to use for performing searches */
  private static final String SEARCH_PASSWORD = &quot;org.opencastproject.userdirectory.ldap.password&quot;;

  /** The key to look up the number of user records to cache */
  private static final String CACHE_SIZE = &quot;org.opencastproject.userdirectory.ldap.cache.size&quot;;

  /** The key to look up the number of minutes to cache users */
  private static final String CACHE_EXPIRATION = &quot;org.opencastproject.userdirectory.ldap.cache.expiration&quot;;

  /** The key to indicate a prefix that will be added to every role read from the LDAP */
  private static final String ROLE_PREFIX_KEY = &quot;org.opencastproject.userdirectory.ldap.roleprefix&quot;;

  /**
   * The key to indicate a comma-separated list of prefixes.
   * The &quot;role prefix&quot; defined with the ROLE_PREFIX_KEY will not be prepended to the roles starting with any of these
   */
  private static final String EXCLUDE_PREFIXES_KEY = &quot;org.opencastproject.userdirectory.ldap.exclude.prefixes&quot;;

  /**
   * The key to indicate a prefix,
   * which is used to check whether a roleattribute value shall be added as a group to the user
   */
  private static final String GROUP_CHECK_PREFIX_KEY = &quot;org.opencastproject.userdirectory.ldap.groupcheckprefix&quot;;

  /** Specifies, whether the roleattributes should be added as a role */
  private static final String APPLY_ROLEATTRIBUTES_AS_ROLES_KEY
      = &quot;org.opencastproject.userdirectory.ldap.roleattributes.applyasroles&quot;;

  /** Specifies, whether the roleattributes should be added as a group */
  private static final String APPLY_ROLEATTRIBUTES_AS_GROUPS_KEY
      = &quot;org.opencastproject.userdirectory.ldap.roleattributes.applyasgroups&quot;;

  /** The prefix of the keys, which map a ldap attribute to opencast roles */
  private static final String ATTRIBUTE_MAPPING_KEY_PREFIX = &quot;org.opencastproject.userdirectory.ldap.map.&quot;;

  /** The postfix of the attribute maps, which specifiy the value to map */
  private static final String ATTRIBUTE_MAPPING_KEY_POSTFIX_VALUE = &quot;value&quot;;

  /** The postfix of the attribute maps, which map a ldap attribute to opencast roles */
  private static final String ATTRIBUTE_MAPPING_KEY_POSTFIX_ROLES = &quot;roles&quot;;

  /** The postfix of the attribute maps, which map a ldap attribute to opencast groups */
  private static final String ATTRIBUTE_MAPPING_KEY_POSTFIX_GROUPS = &quot;groups&quot;;

  /** The key to indicate whether or not the roles should be converted to uppercase */
  private static final String UPPERCASE_KEY = &quot;org.opencastproject.userdirectory.ldap.uppercase&quot;;

  /** The key to indicate a unique identifier for each LDAP connection */
  private static final String INSTANCE_ID_KEY = &quot;org.opencastproject.userdirectory.ldap.id&quot;;

  /** The key to indicate a comma-separated list of extra roles to add to the authenticated user */
  private static final String EXTRA_ROLES_KEY = &quot;org.opencastproject.userdirectory.ldap.extra.roles&quot;;

  /** The key to setup an LDAP connection ID as an OSGI service property */
  private static final String INSTANCE_ID_SERVICE_PROPERTY_KEY = &quot;instanceId&quot;;

  /** A map of pid to ldap user provider instance */
<span class="nc" id="L162">  private Map&lt;String, ServiceRegistration&gt; providerRegistrations = new ConcurrentHashMap&lt;&gt;();</span>

  /** A map of pid to ldap authorities populator instance */
<span class="nc" id="L165">  private Map&lt;String, ServiceRegistration&gt; authoritiesPopulatorRegistrations = new ConcurrentHashMap&lt;&gt;();</span>

  /** The OSGI bundle context */
<span class="nc" id="L168">  private BundleContext bundleContext = null;</span>

  /** The organization directory service */
  private OrganizationDirectoryService orgDirectory;

  /** The group role provider service */
  private JpaGroupRoleProvider groupRoleProvider;

  /** A reference to Opencast's security service */
  private SecurityService securityService;

  /** OSGi callback for setting the organization directory service. */
  @Reference
  public void setOrgDirectory(OrganizationDirectoryService orgDirectory) {
<span class="nc" id="L182">    this.orgDirectory = orgDirectory;</span>
<span class="nc" id="L183">  }</span>

  /** OSGi callback for setting the role group service. */
  @Reference
  public void setGroupRoleProvider(JpaGroupRoleProvider groupRoleProvider) {
<span class="nc" id="L188">    this.groupRoleProvider = groupRoleProvider;</span>
<span class="nc" id="L189">  }</span>

  /** OSGi callback for setting the security service. */
  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="nc" id="L194">    this.securityService = securityService;</span>
<span class="nc" id="L195">  }</span>

  /**
   * Callback for activation of this component.
   *
   * @param cc
   *          the component context
   */
  @Activate
  public void activate(ComponentContext cc) {
<span class="nc" id="L205">    logger.debug(&quot;Activate LdapUserProviderFactory&quot;);</span>
<span class="nc" id="L206">    bundleContext = cc.getBundleContext();</span>
<span class="nc" id="L207">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.osgi.service.cm.ManagedServiceFactory#getName()
   */
  @Override
  public String getName() {
<span class="nc" id="L216">    return PID;</span>
  }

  /**
   * Retrieve configuration values and check for a proper value.
   *
   * @param properties
   *      Configuration dictionary
   * @param key
   *      Configuration key to check for
   * @return
   *      The configuration value
   * @throws ConfigurationException
   *      Thrown if the configuration value is blank
   */
  private String getRequiredProperty(final Dictionary properties, final String key) throws ConfigurationException {
<span class="nc" id="L232">    final String value = (String) properties.get(key);</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">    if (StringUtils.isBlank(value)) {</span>
<span class="nc" id="L234">      throw new ConfigurationException(key, &quot;missing configuration value&quot;);</span>
    }
<span class="nc" id="L236">    return value;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.osgi.service.cm.ManagedServiceFactory#updated(java.lang.String, java.util.Dictionary)
   */
  @Override
  public void updated(String pid, Dictionary properties) throws ConfigurationException {
<span class="nc" id="L246">    logger.debug(&quot;Updating LdapUserProviderFactory&quot;);</span>

    // required settings
<span class="nc" id="L249">    String searchBase = getRequiredProperty(properties, SEARCH_BASE_KEY);</span>
<span class="nc" id="L250">    String searchFilter = getRequiredProperty(properties, SEARCH_FILTER_KEY);</span>
<span class="nc" id="L251">    String url = getRequiredProperty(properties, LDAP_URL_KEY);</span>
<span class="nc" id="L252">    String instanceId = getRequiredProperty(properties, INSTANCE_ID_KEY);</span>
<span class="nc" id="L253">    String roleAttributes = getRequiredProperty(properties, ROLE_ATTRIBUTES_KEY);</span>

    // optional settings
<span class="nc" id="L256">    String organization = (String) properties.get(ORGANIZATION_KEY);</span>
<span class="nc" id="L257">    String userDn = (String) properties.get(SEARCH_USER_DN);</span>
<span class="nc" id="L258">    String password = (String) properties.get(SEARCH_PASSWORD);</span>
<span class="nc" id="L259">    String[] userAttributeName = StringUtils.split((String) properties.get(USER_NAME_ATTRIBUTES_KEY),',');</span>
<span class="nc" id="L260">    String userAttributeMail = (String) properties.get(USER_MAIL_ATTRIBUTE_KEY);</span>

    // optional with default values
<span class="nc" id="L263">    String rolePrefix = Objects.toString(properties.get(ROLE_PREFIX_KEY), &quot;ROLE_&quot;);</span>
<span class="nc" id="L264">    String[] excludePrefixes = StringUtils.split((String) properties.get(EXCLUDE_PREFIXES_KEY), &quot;,&quot;);</span>
<span class="nc" id="L265">    String groupCheckPrefix = Objects.toString(properties.get(GROUP_CHECK_PREFIX_KEY), &quot;ROLE_GROUP_&quot;);</span>
<span class="nc" id="L266">    boolean convertToUppercase = BooleanUtils.toBoolean(Objects.toString(properties.get(UPPERCASE_KEY), &quot;true&quot;));</span>
<span class="nc" id="L267">    int cacheSize = NumberUtils.toInt((String) properties.get(CACHE_SIZE), 1000);</span>
<span class="nc" id="L268">    int cacheExpiration = NumberUtils.toInt((String) properties.get(CACHE_EXPIRATION), 5);</span>
<span class="nc" id="L269">    boolean applyRoleattributesAsRoles = BooleanUtils.toBoolean(Objects.toString(</span>
<span class="nc" id="L270">            properties.get(APPLY_ROLEATTRIBUTES_AS_ROLES_KEY), &quot;true&quot;));</span>
<span class="nc" id="L271">    boolean applyRoleattributesAsGroups = BooleanUtils.toBoolean(Objects.toString(</span>
<span class="nc" id="L272">            properties.get(APPLY_ROLEATTRIBUTES_AS_GROUPS_KEY), &quot;true&quot;));</span>
<span class="nc bnc" id="L273" title="All 4 branches missed.">    if (applyRoleattributesAsGroups &amp;&amp; !applyRoleattributesAsRoles) {</span>
<span class="nc" id="L274">      throw new ConfigurationException(APPLY_ROLEATTRIBUTES_AS_GROUPS_KEY,</span>
              &quot;'&quot; + APPLY_ROLEATTRIBUTES_AS_ROLES_KEY + &quot;' needs to be 'true' to enable this option&quot;);
    }

    // extra roles
<span class="nc" id="L279">    String[] extraRoles =  StringUtils.split(Objects.toString(properties.get(EXTRA_ROLES_KEY), &quot;&quot;), &quot;,&quot;);</span>
<span class="nc" id="L280">    Set&lt;String&gt; extraRoleSet = new HashSet&lt;&gt;(Arrays.asList(extraRoles));</span>
<span class="nc" id="L281">    extraRoleSet.addAll(Arrays.asList(&quot;ROLE_ANONYMOUS&quot;, &quot;ROLE_USER&quot;));</span>
<span class="nc" id="L282">    extraRoles = extraRoleSet.toArray(new String[extraRoles.length]);</span>

    // maps
<span class="nc" id="L285">    HashMap&lt;String, HashMap&lt;String, String&gt;&gt; ldapAssignmentMappingsPreparation = new HashMap();</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">    for (Enumeration&lt;String&gt; e = properties.keys(); e.hasMoreElements();) {</span>
<span class="nc" id="L287">      String key = e.nextElement();</span>

<span class="nc bnc" id="L289" title="All 2 branches missed.">      if (key.startsWith(ATTRIBUTE_MAPPING_KEY_PREFIX)) {</span>
<span class="nc" id="L290">        final String[] postfix = key.substring(ATTRIBUTE_MAPPING_KEY_PREFIX.length()).split(&quot;\\.&quot;);</span>

<span class="nc bnc" id="L292" title="All 2 branches missed.">        if (postfix.length != 2) {</span>
<span class="nc" id="L293">          throw new ConfigurationException(key,</span>
                  &quot;Invalid Configkey format, the following format is needed: &quot;
                  + ATTRIBUTE_MAPPING_KEY_PREFIX + &quot;&lt;identifier&gt;.&lt;key&gt;&quot;);
        }

<span class="nc" id="L298">        final String mappingIdentifier = postfix[0];</span>
<span class="nc" id="L299">        final String mappingKey = postfix[1];</span>

<span class="nc" id="L301">        HashMap keyValueMap = ldapAssignmentMappingsPreparation.getOrDefault(mappingIdentifier, new HashMap());</span>

<span class="nc" id="L303">        keyValueMap.put(mappingKey, (String) properties.get(key));</span>

<span class="nc" id="L305">        ldapAssignmentMappingsPreparation.put(mappingIdentifier, keyValueMap);</span>
      }
<span class="nc" id="L307">    }</span>
<span class="nc" id="L308">    HashMap&lt;String, String[]&gt; ldapAssignmentRoleMap = new HashMap();</span>
<span class="nc" id="L309">    HashMap&lt;String, String[]&gt; ldapAssignmentGroupMap = new HashMap();</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">    for (HashMap.Entry&lt;String, HashMap&lt;String, String&gt;&gt; entry : ldapAssignmentMappingsPreparation.entrySet()) {</span>
<span class="nc" id="L311">      HashMap&lt;String, String&gt; mappingConf = entry.getValue();</span>
<span class="nc" id="L312">      String value = StringUtils.trimToNull(mappingConf.get(ATTRIBUTE_MAPPING_KEY_POSTFIX_VALUE));</span>
<span class="nc" id="L313">      String roles = StringUtils.trimToNull(mappingConf.get(ATTRIBUTE_MAPPING_KEY_POSTFIX_ROLES));</span>
<span class="nc" id="L314">      String groups = StringUtils.trimToNull(mappingConf.get(ATTRIBUTE_MAPPING_KEY_POSTFIX_GROUPS));</span>

<span class="nc bnc" id="L316" title="All 2 branches missed.">      if (value == null) {</span>
<span class="nc" id="L317">        throw new ConfigurationException(ATTRIBUTE_MAPPING_KEY_PREFIX + entry.getKey() + &quot;.*&quot;,</span>
                &quot;LDAP mapping incomplete, the key 'value' is needed&quot;);
      }
<span class="nc bnc" id="L320" title="All 4 branches missed.">      if (roles == null &amp;&amp; groups == null) {</span>
<span class="nc" id="L321">        throw new ConfigurationException(ATTRIBUTE_MAPPING_KEY_PREFIX + entry.getKey() + &quot;.*&quot;,</span>
                &quot;LDAP mapping incomplete, one of the keys 'roles' or 'groups' is needed&quot;);
      }

<span class="nc bnc" id="L325" title="All 2 branches missed.">      if (convertToUppercase) {</span>
<span class="nc" id="L326">        value = value.toUpperCase();</span>
      }

<span class="nc bnc" id="L329" title="All 2 branches missed.">      if (roles != null) {</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">        if (convertToUppercase) {</span>
<span class="nc" id="L331">          roles = roles.toUpperCase();</span>
        }
<span class="nc" id="L333">        ldapAssignmentRoleMap.put(value,</span>
<span class="nc" id="L334">                ArrayUtils.addAll(</span>
<span class="nc" id="L335">                        ldapAssignmentRoleMap.getOrDefault(value, new String[0]),</span>
<span class="nc" id="L336">                        Arrays.stream(roles.split(&quot;,&quot;))</span>
<span class="nc" id="L337">                                .map(r -&gt; StringUtils.trimToNull(r))</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">                                .filter(r -&gt; r != null)</span>
<span class="nc" id="L339">                                .toArray(String[]::new)</span>
                )
        );
      }

<span class="nc bnc" id="L344" title="All 2 branches missed.">      if (groups != null) {</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">        if (convertToUppercase) {</span>
<span class="nc" id="L346">          groups = groups.toUpperCase();</span>
        }
<span class="nc" id="L348">        ldapAssignmentGroupMap.put(value,</span>
<span class="nc" id="L349">                ArrayUtils.addAll(</span>
<span class="nc" id="L350">                        ldapAssignmentGroupMap.getOrDefault(value, new String[0]),</span>
<span class="nc" id="L351">                        Arrays.stream(groups.split(&quot;,&quot;))</span>
<span class="nc" id="L352">                                .map(r -&gt; StringUtils.trimToNull(r))</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">                                .filter(r -&gt; r != null)</span>
<span class="nc" id="L354">                                .toArray(String[]::new)</span>
                )
        );
      }
<span class="nc" id="L358">    }</span>

    // Now that we have everything we need, go ahead and activate a new provider, removing an old one if necessary
<span class="nc" id="L361">    ServiceRegistration existingRegistration = providerRegistrations.remove(pid);</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">    if (existingRegistration != null) {</span>
<span class="nc" id="L363">      existingRegistration.unregister();</span>
    }

    // Defaults to first available organization
    Organization org;
    try {
<span class="nc bnc" id="L369" title="All 2 branches missed.">      if (StringUtils.isNoneBlank(organization)) {</span>
<span class="nc" id="L370">        org = orgDirectory.getOrganization(organization);</span>
      } else {
<span class="nc bnc" id="L372" title="All 2 branches missed.">        if (orgDirectory.getOrganizations().size() != 1) {</span>
<span class="nc" id="L373">          throw new NotFoundException(&quot;Multiple organizations exist but none is specified&quot;);</span>
        }
<span class="nc" id="L375">        org = orgDirectory.getOrganizations().get(0);</span>
      }
<span class="nc" id="L377">    } catch (NotFoundException e) {</span>
<span class="nc" id="L378">      throw new ConfigurationException(ORGANIZATION_KEY, &quot;no organization with configured id&quot;, e);</span>
<span class="nc" id="L379">    }</span>

    // Dictionary to include a property to identify this LDAP instance in the security.xml file
<span class="nc" id="L382">    Hashtable&lt;String, String&gt; dict = new Hashtable&lt;&gt;();</span>
<span class="nc" id="L383">    dict.put(INSTANCE_ID_SERVICE_PROPERTY_KEY, instanceId);</span>

    // Instantiate this LDAP instance and register it as such

<span class="nc" id="L387">    OpencastLdapAuthoritiesPopulator authoritiesPopulator = new OpencastLdapAuthoritiesPopulator(roleAttributes,</span>
            rolePrefix, excludePrefixes, groupCheckPrefix, applyRoleattributesAsRoles, applyRoleattributesAsGroups,
            ldapAssignmentRoleMap, ldapAssignmentGroupMap, convertToUppercase, org, securityService,
            groupRoleProvider, extraRoles);

    // Also, register this instance as LdapAuthoritiesPopulator so that it can be used within the security.xml file
<span class="nc" id="L393">    authoritiesPopulatorRegistrations.put(pid,</span>
<span class="nc" id="L394">            bundleContext.registerService(LdapAuthoritiesPopulator.class.getName(), authoritiesPopulator, dict));</span>

<span class="nc" id="L396">    OpencastUserDetailsContextMapper mapper = null;</span>
<span class="nc bnc" id="L397" title="All 4 branches missed.">    if (userAttributeName != null &amp;&amp; userAttributeMail != null) {</span>
<span class="nc" id="L398">      mapper = new OpencastUserDetailsContextMapper(userAttributeName, userAttributeMail);</span>
    }

<span class="nc" id="L401">    LdapUserProviderInstance provider = new LdapUserProviderInstance(pid, org, searchBase, searchFilter, url, userDn,</span>
        password, roleAttributes, cacheSize,
        cacheExpiration, securityService, authoritiesPopulator, mapper);

<span class="nc" id="L405">    providerRegistrations.put(pid, bundleContext.registerService(UserProvider.class.getName(), provider, null));</span>

<span class="nc" id="L407">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.osgi.service.cm.ManagedServiceFactory#deleted(java.lang.String)
   */
  @Override
  public void deleted(String pid) {
<span class="nc" id="L416">    ServiceRegistration providerRegistration = null;</span>
<span class="nc" id="L417">    ServiceRegistration authoritiesPopulatorRegistration = null;</span>

    try {
<span class="nc" id="L420">      providerRegistration = providerRegistrations.remove(pid);</span>
<span class="nc" id="L421">      authoritiesPopulatorRegistration = authoritiesPopulatorRegistrations.remove(pid);</span>
<span class="nc bnc" id="L422" title="All 4 branches missed.">      if ((providerRegistration != null) || (authoritiesPopulatorRegistration != null)) {</span>
        try {
<span class="nc" id="L424">          ManagementFactory.getPlatformMBeanServer().unregisterMBean(LdapUserProviderFactory.getObjectName(pid));</span>
<span class="nc" id="L425">        } catch (Exception e) {</span>
<span class="nc" id="L426">          logger.warn(&quot;Unable to unregister mbean for pid='{}': {}&quot;, pid, e.getMessage());</span>
<span class="nc" id="L427">        }</span>
      }
    } finally {
<span class="nc bnc" id="L430" title="All 2 branches missed.">      if (providerRegistration != null) {</span>
<span class="nc" id="L431">        providerRegistration.unregister();</span>
      }
<span class="nc bnc" id="L433" title="All 2 branches missed.">      if (authoritiesPopulatorRegistration != null) {</span>
<span class="nc" id="L434">        authoritiesPopulatorRegistration.unregister();</span>
      }
    }
<span class="nc" id="L437">  }</span>

  /**
   * Builds a JMX object name for a given PID
   *
   * @param pid
   *          the PID
   * @return the object name
   * @throws NullPointerException
   * @throws MalformedObjectNameException
   */
  public static final ObjectName getObjectName(String pid) throws MalformedObjectNameException, NullPointerException {
<span class="nc" id="L449">    return new ObjectName(pid + &quot;:type=LDAPRequests&quot;);</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>