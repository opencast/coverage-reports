<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>LdapUserProviderInstance.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-userdirectory-ldap</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.userdirectory.ldap</a> &gt; <span class="el_source">LdapUserProviderInstance.java</span></div><h1>LdapUserProviderInstance.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.userdirectory.ldap;

import org.opencastproject.security.api.CachingUserProviderMXBean;
import org.opencastproject.security.api.JaxbOrganization;
import org.opencastproject.security.api.JaxbRole;
import org.opencastproject.security.api.JaxbUser;
import org.opencastproject.security.api.Organization;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.User;
import org.opencastproject.security.api.UserProvider;

import com.google.common.cache.CacheBuilder;
import com.google.common.cache.CacheLoader;
import com.google.common.cache.LoadingCache;
import com.google.common.util.concurrent.UncheckedExecutionException;

import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.ldap.DefaultSpringSecurityContextSource;
import org.springframework.security.ldap.search.FilterBasedLdapUserSearch;
import org.springframework.security.ldap.userdetails.LdapUserDetailsService;

import java.lang.management.ManagementFactory;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;
import java.util.Set;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.AtomicLong;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import javax.management.InstanceNotFoundException;
import javax.management.MBeanServer;
import javax.management.ObjectName;

/**
 * A UserProvider that reads user roles from LDAP entries.
 */
public class LdapUserProviderInstance implements UserProvider, CachingUserProviderMXBean {

  /** The logger */
<span class="nc" id="L68">  private static final Logger logger = LoggerFactory.getLogger(LdapUserProviderInstance.class);</span>

  public static final String PROVIDER_NAME = &quot;ldap&quot;;

  /** The spring ldap userdetails service delegate */
  private final LdapUserDetailsService delegate;

  /** The organization id */
<span class="nc" id="L76">  private Organization organization = null;</span>

  /** Total number of requests made to load users */
<span class="nc" id="L79">  private AtomicLong requests = null;</span>

  /** The number of requests made to ldap */
<span class="nc" id="L82">  private AtomicLong ldapLoads = null;</span>

  /** A cache of users, which lightens the load on the LDAP server */
<span class="nc" id="L85">  private LoadingCache&lt;String, Object&gt; cache = null;</span>

  /** A token to store in the miss cache */
<span class="nc" id="L88">  protected Object nullToken = new Object();</span>

  /** Opencast's security service */
  private final SecurityService securityService;

  /**
   * Constructs an ldap user provider with the needed settings.
   *
   * @param pid
   *          the pid of this service
   * @param organization
   *          the organization
   * @param searchBase
   *          the ldap search base
   * @param searchFilter
   *          the ldap search filter
   * @param url
   *          the url of the ldap server
   * @param userDn
   *          the user to authenticate as
   * @param password
   *          the user credentials
   * @param roleAttributesGlob
   *          the comma separate list of ldap attributes to treat as roles or to consider for the ldapAssignmentRoleMap
   * @param cacheSize
   *          the number of users to cache
   * @param cacheExpiration
   *          the number of minutes to cache users
   * @param securityService
   *          a reference to Opencast's security service
   * @param authoritiesPopulator
   *          a reference to Opencast's authorities populator
   * @param userDetailsContextMapper
   *          a reference to Opencast's user details mapper
   */
  // CHECKSTYLE:OFF
  LdapUserProviderInstance(
      String pid,
      Organization organization,
      String searchBase,
      String searchFilter,
      String url,
      String userDn,
      String password,
      String roleAttributesGlob,
      int cacheSize,
      int cacheExpiration,
      SecurityService securityService,
      OpencastLdapAuthoritiesPopulator authoritiesPopulator,
      OpencastUserDetailsContextMapper userDetailsContextMapper
<span class="nc" id="L138">  ) {</span>
    // CHECKSTYLE:ON
<span class="nc" id="L140">    this.organization = organization;</span>
<span class="nc" id="L141">    this.securityService = securityService;</span>
<span class="nc" id="L142">    logger.debug(&quot;Creating LdapUserProvider instance with pid=&quot; + pid + &quot;, and organization=&quot; + organization</span>
            + &quot;, to LDAP server at url:  &quot; + url);

<span class="nc" id="L145">    DefaultSpringSecurityContextSource contextSource = new DefaultSpringSecurityContextSource(url);</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">    if (StringUtils.isNotBlank(userDn)) {</span>
<span class="nc" id="L147">      contextSource.setPassword(password);</span>
<span class="nc" id="L148">      contextSource.setUserDn(userDn);</span>
      // Required so that authentication will actually be used
<span class="nc" id="L150">      contextSource.setAnonymousReadOnly(false);</span>
    } else {
      // No password set so try to connect anonymously.
<span class="nc" id="L153">      contextSource.setAnonymousReadOnly(true);</span>
    }

    try {
<span class="nc" id="L157">      contextSource.afterPropertiesSet();</span>
<span class="nc" id="L158">    } catch (Exception e) {</span>
<span class="nc" id="L159">      throw new org.opencastproject.util.ConfigurationException(&quot;Unable to create a spring context source&quot;, e);</span>
<span class="nc" id="L160">    }</span>
<span class="nc" id="L161">    FilterBasedLdapUserSearch userSearch = new FilterBasedLdapUserSearch(searchBase, searchFilter, contextSource);</span>
<span class="nc" id="L162">    userSearch.setReturningAttributes(roleAttributesGlob.split(&quot;,&quot;));</span>

<span class="nc" id="L164">    delegate = new LdapUserDetailsService(userSearch, authoritiesPopulator);</span>

<span class="nc bnc" id="L166" title="All 2 branches missed.">    if (userDetailsContextMapper != null) {</span>
<span class="nc" id="L167">      userSearch.setReturningAttributes(</span>
<span class="nc" id="L168">          Stream.of(roleAttributesGlob.split(&quot;,&quot;), userDetailsContextMapper.getAttributes())</span>
<span class="nc" id="L169">              .flatMap(Stream::of)</span>
<span class="nc" id="L170">              .collect(Collectors.toList()).toArray(new String[] { })</span>
      );
<span class="nc" id="L172">      delegate.setUserDetailsMapper(userDetailsContextMapper);</span>
    }

    // Setup the caches
<span class="nc" id="L176">    cache = CacheBuilder.newBuilder().maximumSize(cacheSize).expireAfterWrite(cacheExpiration, TimeUnit.MINUTES)</span>
<span class="nc" id="L177">            .build(new CacheLoader&lt;String, Object&gt;() {</span>
              @Override
              public Object load(String id) throws Exception {
<span class="nc" id="L180">                User user = loadUserFromLdap(id);</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">                return user == null ? nullToken : user;</span>
              }
            });

<span class="nc" id="L185">    registerMBean(pid);</span>
<span class="nc" id="L186">  }</span>

  @Override
  public String getName() {
<span class="nc" id="L190">    return PROVIDER_NAME;</span>
  }

  /**
   * Registers an MXBean.
   */
  protected void registerMBean(String pid) {
    // register with jmx
<span class="nc" id="L198">    requests = new AtomicLong();</span>
<span class="nc" id="L199">    ldapLoads = new AtomicLong();</span>
    try {
      ObjectName name;
<span class="nc" id="L202">      name = LdapUserProviderFactory.getObjectName(pid);</span>
<span class="nc" id="L203">      Object mbean = this;</span>
<span class="nc" id="L204">      MBeanServer mbs = ManagementFactory.getPlatformMBeanServer();</span>
      try {
<span class="nc" id="L206">        mbs.unregisterMBean(name);</span>
<span class="nc" id="L207">      } catch (InstanceNotFoundException e) {</span>
<span class="nc" id="L208">        logger.debug(name + &quot; was not registered&quot;);</span>
<span class="nc" id="L209">      }</span>
<span class="nc" id="L210">      mbs.registerMBean(mbean, name);</span>
<span class="nc" id="L211">    } catch (Exception e) {</span>
<span class="nc" id="L212">      logger.warn(&quot;Unable to register {} as an mbean&quot;, this, e);</span>
<span class="nc" id="L213">    }</span>
<span class="nc" id="L214">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.security.api.UserProvider#getOrganization()
   */
  @Override
  public String getOrganization() {
<span class="nc" id="L223">    return organization.getId();</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.security.api.UserProvider#loadUser(java.lang.String)
   */
  @Override
  public User loadUser(String userName) {
<span class="nc" id="L233">    logger.debug(&quot;LdapUserProvider is loading user &quot; + userName);</span>
<span class="nc" id="L234">    requests.incrementAndGet();</span>
    try {
      // use #getUnchecked since the loader does not throw any checked exceptions
<span class="nc" id="L237">      Object user = cache.getUnchecked(userName);</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">      if (user == nullToken) {</span>
<span class="nc" id="L239">        return null;</span>
      } else {
<span class="nc" id="L241">        return (JaxbUser) user;</span>
      }
<span class="nc" id="L243">    } catch (UncheckedExecutionException e) {</span>
<span class="nc" id="L244">      logger.warn(&quot;Exception while loading user &quot; + userName, e);</span>
<span class="nc" id="L245">      return null;</span>
    }
  }

  /**
   * Loads a user from LDAP.
   *
   * @param userName
   *          the username
   * @return the user
   */
  protected User loadUserFromLdap(String userName) {
<span class="nc bnc" id="L257" title="All 4 branches missed.">    if (delegate == null || cache == null) {</span>
<span class="nc" id="L258">      throw new IllegalStateException(&quot;The LDAP user detail service has not yet been configured&quot;);</span>
    }
<span class="nc" id="L260">    ldapLoads.incrementAndGet();</span>
<span class="nc" id="L261">    UserDetails userDetails = null;</span>

<span class="nc" id="L263">    Thread currentThread = Thread.currentThread();</span>
<span class="nc" id="L264">    ClassLoader originalClassloader = currentThread.getContextClassLoader();</span>
    try {
<span class="nc" id="L266">      currentThread.setContextClassLoader(LdapUserProviderFactory.class.getClassLoader());</span>
      try {
<span class="nc" id="L268">        userDetails = delegate.loadUserByUsername(userName);</span>
<span class="nc" id="L269">      } catch (UsernameNotFoundException e) {</span>
<span class="nc" id="L270">        cache.put(userName, nullToken);</span>
<span class="nc" id="L271">        return null;</span>
<span class="nc" id="L272">      }</span>
<span class="nc" id="L273">      JaxbOrganization jaxbOrganization = JaxbOrganization.fromOrganization(organization);</span>

<span class="nc" id="L275">      Set&lt;JaxbRole&gt; roles = userDetails.getAuthorities()</span>
<span class="nc" id="L276">          .stream()</span>
<span class="nc" id="L277">          .map(a -&gt; new JaxbRole(a.getAuthority(), jaxbOrganization))</span>
<span class="nc" id="L278">          .collect(Collectors.toUnmodifiableSet());</span>

      User user;
<span class="nc bnc" id="L281" title="All 2 branches missed.">      if (userDetails instanceof OpencastUserDetails) {</span>
<span class="nc" id="L282">        user = new JaxbUser(userDetails.getUsername(),null,</span>
<span class="nc" id="L283">            ((OpencastUserDetails) userDetails).getName(),</span>
<span class="nc" id="L284">            ((OpencastUserDetails) userDetails).getMail(), PROVIDER_NAME, jaxbOrganization, roles);</span>
      } else {
<span class="nc" id="L286">        user = new JaxbUser(userDetails.getUsername(), PROVIDER_NAME, jaxbOrganization, roles);</span>
      }

<span class="nc" id="L289">      cache.put(userName, user);</span>
<span class="nc" id="L290">      return user;</span>
    } finally {
<span class="nc" id="L292">      currentThread.setContextClassLoader(originalClassloader);</span>
    }
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.security.api.CachingUserProviderMXBean#getCacheHitRatio()
   */
  @Override
  public float getCacheHitRatio() {
<span class="nc bnc" id="L303" title="All 2 branches missed.">    if (requests.get() == 0) {</span>
<span class="nc" id="L304">      return 0;</span>
    }
<span class="nc" id="L306">    return (float) (requests.get() - ldapLoads.get()) / requests.get();</span>
  }

  @Override
  public Iterator&lt;User&gt; findUsers(String query, int offset, int limit) {
<span class="nc bnc" id="L311" title="All 2 branches missed.">    if (query == null) {</span>
<span class="nc" id="L312">      throw new IllegalArgumentException(&quot;Query must be set&quot;);</span>
    }
    // TODO implement a LDAP wildcard search
    // FIXME We return the current user, rather than an empty list, to make sure the current user's role is displayed in
    // the admin UI (MH-12526).
<span class="nc" id="L317">    User currentUser = securityService.getUser();</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">    if (loadUser(currentUser.getUsername()) != null) {</span>
<span class="nc" id="L319">      List&lt;User&gt; retVal = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L320">      retVal.add(securityService.getUser());</span>
<span class="nc" id="L321">      return retVal.iterator();</span>
    }
<span class="nc" id="L323">    return Collections.emptyIterator();</span>
  }

  @Override
  public Iterator&lt;User&gt; getUsers() {
    // TODO implement LDAP get all users
    // FIXME We return the current user, rather than an empty list,
    // to make sure the current user's role is displayed in
    // the admin UI (MH-12526).
<span class="nc" id="L332">    User currentUser = securityService.getUser();</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">    if (loadUser(currentUser.getUsername()) != null) {</span>
<span class="nc" id="L334">      List&lt;User&gt; retVal = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L335">      retVal.add(securityService.getUser());</span>
<span class="nc" id="L336">      return retVal.iterator();</span>
    }
<span class="nc" id="L338">    return Collections.emptyIterator();</span>
  }

  @Override
  public long countUsers() {
    // TODO implement LDAP count users
    // FIXME Because of MH-12526, we return conditionally 1 when the previous methods return the current user
<span class="nc bnc" id="L345" title="All 2 branches missed.">    if (loadUser(securityService.getUser().getUsername()) != null) {</span>
<span class="nc" id="L346">      return 1;</span>
    }
<span class="nc" id="L348">    return 0;</span>
  }

  @Override
  public void invalidate(String userName) {
<span class="nc" id="L353">    cache.invalidate(userName);</span>
<span class="nc" id="L354">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>