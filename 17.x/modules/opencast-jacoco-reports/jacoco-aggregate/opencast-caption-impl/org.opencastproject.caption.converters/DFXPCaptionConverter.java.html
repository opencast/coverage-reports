<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>DFXPCaptionConverter.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-caption-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.caption.converters</a> &gt; <span class="el_source">DFXPCaptionConverter.java</span></div><h1>DFXPCaptionConverter.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.caption.converters;

import org.opencastproject.caption.api.Caption;
import org.opencastproject.caption.api.CaptionConverter;
import org.opencastproject.caption.api.CaptionConverterException;
import org.opencastproject.caption.api.IllegalTimeFormatException;
import org.opencastproject.caption.api.Time;
import org.opencastproject.caption.impl.CaptionImpl;
import org.opencastproject.caption.impl.TimeImpl;
import org.opencastproject.caption.util.TimeUtil;
import org.opencastproject.mediapackage.MediaPackageElement;
import org.opencastproject.mediapackage.MediaPackageElement.Type;
import org.opencastproject.util.XmlSafeParser;

import org.apache.commons.io.IOUtils;
import org.osgi.service.component.annotations.Component;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.xml.sax.Attributes;
import org.xml.sax.SAXException;
import org.xml.sax.helpers.DefaultHandler;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.OutputStreamWriter;
import java.util.ArrayList;
import java.util.LinkedList;
import java.util.List;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.parsers.SAXParser;
import javax.xml.parsers.SAXParserFactory;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerConfigurationException;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;

/**
 * This is converter for DFXP, XML based caption format. DOM parser is used for both caption importing and exporting,
 * while SAX parser is used for determining which languages are present (DFXP can contain multiple languages).
 */
@Component(
    immediate = true,
    service = { CaptionConverter.class },
    property = {
        &quot;service.description=DFXP caption converter&quot;,
        &quot;caption.format=dfxp&quot;
    }
)
<span class="fc" id="L79">public class DFXPCaptionConverter implements CaptionConverter {</span>

  /** logging utility */
<span class="fc" id="L82">  private static final Logger logger = LoggerFactory.getLogger(DFXPCaptionConverter.class);</span>

  private static final String EXTENSION = &quot;dfxp.xml&quot;;

  /**
   * {@inheritDoc} Parser used for parsing XML document is DOM parser. Language parameter will determine which language
   * is searched for and parsed. If there is no matching language, empty collection is returned. If language parameter
   * is &lt;code&gt;null&lt;/code&gt; first language found is parsed.
   *
   * @see org.opencastproject.caption.api.CaptionConverter#importCaption(java.io.InputStream, java.lang.String)
   */
  @Override
  public List&lt;Caption&gt; importCaption(InputStream in, String language) throws CaptionConverterException {

    // create new collection
<span class="fc" id="L97">    List&lt;Caption&gt; collection = new ArrayList&lt;Caption&gt;();</span>

    Document doc;
    try {
<span class="fc" id="L101">      DocumentBuilder builder = XmlSafeParser.newDocumentBuilderFactory().newDocumentBuilder();</span>
<span class="fc" id="L102">      doc = builder.parse(in);</span>
<span class="fc" id="L103">      doc.getDocumentElement().normalize();</span>
<span class="nc" id="L104">    } catch (ParserConfigurationException e) {</span>
<span class="nc" id="L105">      throw new CaptionConverterException(&quot;Could not parse captions&quot;, e);</span>
<span class="nc" id="L106">    } catch (SAXException e) {</span>
<span class="nc" id="L107">      throw new CaptionConverterException(&quot;Could not parse captions&quot;, e);</span>
<span class="nc" id="L108">    } catch (IOException e) {</span>
<span class="nc" id="L109">      throw new CaptionConverterException(&quot;Could not parse captions&quot;, e);</span>
<span class="fc" id="L110">    }</span>

    // get all &lt;div&gt; elements since they contain information about language
<span class="fc" id="L113">    NodeList divElements = doc.getElementsByTagName(&quot;div&quot;);</span>

<span class="fc" id="L115">    Element targetDiv = null;</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">    if (language != null) {</span>
      // find first &lt;div&gt; element with matching language
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">      for (int i = 0; i &lt; divElements.getLength(); i++) {</span>
<span class="fc" id="L119">        Element n = (Element) divElements.item(i);</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">        if (n.getAttribute(&quot;xml:lang&quot;).equals(language)) {</span>
<span class="fc" id="L121">          targetDiv = n;</span>
<span class="fc" id="L122">          break;</span>
        }
      }
    } else {
<span class="nc bnc" id="L126" title="All 2 branches missed.">      if (divElements.getLength() &gt; 1) {</span>
        // more than one existing &lt;div&gt; element, no language specified
<span class="nc" id="L128">        logger.warn(&quot;More than one &lt;div&gt; element available. Parsing first one...&quot;);</span>
      }
<span class="nc bnc" id="L130" title="All 2 branches missed.">      if (divElements.getLength() != 0) {</span>
<span class="nc" id="L131">        targetDiv = (Element) divElements.item(0);</span>
      }
    }

    // check if we found node
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">    if (targetDiv == null) {</span>
<span class="nc" id="L137">      logger.warn(&quot;No suitable &lt;div&gt; element found for language {}&quot;, language);</span>
    } else {
<span class="fc" id="L139">      NodeList pElements = targetDiv.getElementsByTagName(&quot;p&quot;);</span>

      // initialize start time
<span class="fc" id="L142">      Time time = null;</span>
      try {
<span class="fc" id="L144">        time = new TimeImpl(0, 0, 0, 0);</span>
<span class="nc" id="L145">      } catch (IllegalTimeFormatException e1) {</span>
<span class="fc" id="L146">      }</span>

<span class="fc bfc" id="L148" title="All 2 branches covered.">      for (int i = 0; i &lt; pElements.getLength(); i++) {</span>
        try {
<span class="fc" id="L150">          Caption caption = parsePElement((Element) pElements.item(i));</span>
          // check time
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">          if (caption.getStartTime().compareTo(time) &lt; 0</span>
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">                  || caption.getStopTime().compareTo(caption.getStartTime()) &lt;= 0) {</span>
<span class="nc" id="L154">            logger.warn(&quot;Caption with invalid time encountered. Skipping...&quot;);</span>
<span class="nc" id="L155">            continue;</span>
          }
<span class="fc" id="L157">          collection.add(caption);</span>
<span class="nc" id="L158">        } catch (IllegalTimeFormatException e) {</span>
<span class="nc" id="L159">          logger.warn(&quot;Caption with invalid time format encountered. Skipping...&quot;);</span>
<span class="fc" id="L160">        }</span>
      }
    }

    // return collection
<span class="fc" id="L165">    return collection;</span>
  }

  /**
   * Parse &amp;lt;p&amp;gt; element which contains one caption.
   *
   * @param p
   *          &amp;lt;p&amp;gt; element to be parsed
   * @return new {@link Caption} object
   * @throws IllegalTimeFormatException
   *           if time format does not match with expected format for DFXP
   */
  private Caption parsePElement(Element p) throws IllegalTimeFormatException {
<span class="fc" id="L178">    Time begin = TimeUtil.importDFXP(p.getAttribute(&quot;begin&quot;).trim());</span>
<span class="fc" id="L179">    Time end = TimeUtil.importDFXP(p.getAttribute(&quot;end&quot;).trim());</span>
    // FIXME add logic for duration if end is absent

    // get text inside p
<span class="fc" id="L183">    String[] textArray = getTextCore(p).split(&quot;\n&quot;);</span>

<span class="fc" id="L185">    return new CaptionImpl(begin, end, textArray);</span>
  }

  /**
   * Returns caption text stripped of all tags.
   *
   * @param p
   *          &amp;lt;p&amp;gt; element to be parsed
   * @return Caption text with \n as new line character
   */
  private String getTextCore(Node p) {
<span class="fc" id="L196">    StringBuffer captionText = new StringBuffer();</span>
    // get children
<span class="fc" id="L198">    NodeList list = p.getChildNodes();</span>
<span class="fc bfc" id="L199" title="All 2 branches covered.">    for (int i = 0; i &lt; list.getLength(); i++) {</span>
<span class="fc bfc" id="L200" title="All 2 branches covered.">      if (list.item(i).getNodeType() == Node.TEXT_NODE) {</span>
<span class="fc" id="L201">        captionText.append(list.item(i).getTextContent());</span>
<span class="fc bfc" id="L202" title="All 2 branches covered.">      } else if (&quot;br&quot;.equals(list.item(i).getNodeName())) {</span>
<span class="fc" id="L203">        captionText.append(&quot;\n&quot;);</span>
      } else {
<span class="fc" id="L205">        captionText.append(getTextCore(list.item(i)));</span>
      }
    }
<span class="fc" id="L208">    return captionText.toString().trim();</span>
  }

  /**
   * {@inheritDoc} DOM parser is used to parse template from which whole document is then constructed.
   */
  @Override
  public void exportCaption(OutputStream outputStream, List&lt;Caption&gt; captions, String language) throws IOException {
    // get document builder factory and parse template
<span class="fc" id="L217">    Document doc = null;</span>
<span class="fc" id="L218">    InputStream is = null;</span>
    try {
<span class="fc" id="L220">      DocumentBuilder builder = XmlSafeParser.newDocumentBuilderFactory().newDocumentBuilder();</span>
      // load dfxp template from file
<span class="fc" id="L222">      is = DFXPCaptionConverter.class.getResourceAsStream(&quot;/templates/template.dfxp.xml&quot;);</span>
<span class="fc" id="L223">      doc = builder.parse(is);</span>
<span class="nc" id="L224">    } catch (ParserConfigurationException e) {</span>
      // should not happen
<span class="nc" id="L226">      throw new RuntimeException(e);</span>
<span class="nc" id="L227">    } catch (SAXException e) {</span>
      // should not happen unless template is invalid
<span class="nc" id="L229">      throw new RuntimeException(e);</span>
<span class="nc" id="L230">    } catch (IOException e) {</span>
      // should not happen
<span class="nc" id="L232">      throw new RuntimeException(e);</span>
    } finally {
<span class="fc" id="L234">      IOUtils.closeQuietly(is);</span>
    }

    // retrieve body element
<span class="fc" id="L238">    Node bodyNode = doc.getElementsByTagName(&quot;body&quot;).item(0);</span>

    // create new div element with specified language
<span class="fc" id="L241">    Element divNode = doc.createElement(&quot;div&quot;);</span>
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">    divNode.setAttribute(&quot;xml:lang&quot;, language != null ? language : &quot;und&quot;);</span>
<span class="fc" id="L243">    bodyNode.appendChild(divNode);</span>

    // update document
<span class="fc bfc" id="L246" title="All 2 branches covered.">    for (Caption caption : captions) {</span>
<span class="fc" id="L247">      Element newNode = doc.createElement(&quot;p&quot;);</span>
<span class="fc" id="L248">      newNode.setAttribute(&quot;begin&quot;, TimeUtil.exportToDFXP(caption.getStartTime()));</span>
<span class="fc" id="L249">      newNode.setAttribute(&quot;end&quot;, TimeUtil.exportToDFXP(caption.getStopTime()));</span>
<span class="fc" id="L250">      String[] captionText = caption.getCaption();</span>
      // text part
<span class="fc" id="L252">      newNode.appendChild(doc.createTextNode(captionText[0]));</span>
<span class="fc bfc" id="L253" title="All 2 branches covered.">      for (int i = 1; i &lt; captionText.length; i++) {</span>
<span class="fc" id="L254">        newNode.appendChild(doc.createElement(&quot;br&quot;));</span>
<span class="fc" id="L255">        newNode.appendChild(doc.createTextNode(captionText[i]));</span>
      }
<span class="fc" id="L257">      divNode.appendChild(newNode);</span>
<span class="fc" id="L258">    }</span>

    // initialize stream writer
<span class="fc" id="L261">    OutputStreamWriter osw = new OutputStreamWriter(outputStream, &quot;UTF-8&quot;);</span>
<span class="fc" id="L262">    StreamResult result = new StreamResult(osw);</span>
<span class="fc" id="L263">    DOMSource source = new DOMSource(doc);</span>
<span class="fc" id="L264">    TransformerFactory tfactory = XmlSafeParser.newTransformerFactory();</span>
    Transformer transformer;
    try {
<span class="fc" id="L267">      transformer = tfactory.newTransformer();</span>
<span class="fc" id="L268">      transformer.transform(source, result);</span>
<span class="fc" id="L269">      osw.flush();</span>
<span class="nc" id="L270">    } catch (TransformerConfigurationException e) {</span>
      // should not happen
<span class="nc" id="L272">      throw new RuntimeException(e);</span>
<span class="nc" id="L273">    } catch (TransformerException e) {</span>
      // should not happen
<span class="nc" id="L275">      throw new RuntimeException(e);</span>
    } finally {
<span class="fc" id="L277">      IOUtils.closeQuietly(osw);</span>
    }
<span class="fc" id="L279">  }</span>

  /**
   * {@inheritDoc} Uses SAX parser to quickly read the document and retrieve available languages.
   *
   * @see org.opencastproject.caption.api.CaptionConverter#getLanguageList(java.io.InputStream)
   */
  @Override
  public String[] getLanguageList(InputStream input) throws CaptionConverterException {

    // create lang list
<span class="nc" id="L290">    final List&lt;String&gt; langList = new LinkedList&lt;String&gt;();</span>

    // get SAX parser
<span class="nc" id="L293">    SAXParserFactory factory = XmlSafeParser.newSAXParserFactory();</span>
    try {
<span class="nc" id="L295">      SAXParser parser = factory.newSAXParser();</span>
      // create handler
<span class="nc" id="L297">      DefaultHandler handler = new DefaultHandler() {</span>
        @Override
        public void startElement(String uri, String localName, String qName, Attributes attributes) throws SAXException {
<span class="nc bnc" id="L300" title="All 2 branches missed.">          if (&quot;div&quot;.equals(qName)) {</span>
            // we found div tag - let's make a lookup for language
<span class="nc" id="L302">            String lang = attributes.getValue(&quot;xml:lang&quot;);</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">            if (lang == null) {</span>
              // should never happen
<span class="nc" id="L305">              logger.warn(&quot;Missing xml:lang attribute for div element.&quot;);</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">            } else if (langList.contains(lang)) {</span>
<span class="nc" id="L307">              logger.warn(&quot;Multiple div elements with same language.&quot;);</span>
            } else {
<span class="nc" id="L309">              langList.add(lang);</span>
            }
          }
<span class="nc" id="L312">        }</span>
      };

      // parse stream
<span class="nc" id="L316">      parser.parse(input, handler);</span>
<span class="nc" id="L317">    } catch (ParserConfigurationException e) {</span>
      // should not happen
<span class="nc" id="L319">      throw new RuntimeException(e);</span>
<span class="nc" id="L320">    } catch (SAXException e) {</span>
<span class="nc" id="L321">      throw new CaptionConverterException(&quot;Could not parse captions&quot;, e);</span>
<span class="nc" id="L322">    } catch (IOException e) {</span>
<span class="nc" id="L323">      throw new RuntimeException(e);</span>
<span class="nc" id="L324">    }</span>

<span class="nc" id="L326">    return langList.toArray(new String[0]);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.caption.api.CaptionConverter#getExtension()
   */
  @Override
  public String getExtension() {
<span class="nc" id="L336">    return EXTENSION;</span>
  }

  @Override
  public Type getElementType() {
<span class="nc" id="L341">    return MediaPackageElement.Type.Attachment;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>