<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>RestDocsServlet.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-runtime-info</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.runtimeinfo</a> &gt; <span class="el_source">RestDocsServlet.java</span></div><h1>RestDocsServlet.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.runtimeinfo;

import static org.opencastproject.rest.RestConstants.SERVICES_FILTER;
import static org.opencastproject.rest.RestConstants.SERVICE_PATH_PROPERTY;
import static org.opencastproject.util.data.Option.none;
import static org.opencastproject.util.data.Option.some;

import org.opencastproject.runtimeinfo.rest.RestDocData;
import org.opencastproject.systems.OpencastConstants;
import org.opencastproject.util.data.Option;
import org.opencastproject.util.doc.DocUtil;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestService;

import org.apache.commons.lang3.StringUtils;
import org.osgi.framework.BundleContext;
import org.osgi.framework.InvalidSyntaxException;
import org.osgi.framework.ServiceReference;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.http.whiteboard.propertytypes.HttpWhiteboardContextSelect;
import org.osgi.service.http.whiteboard.propertytypes.HttpWhiteboardServletName;
import org.osgi.service.http.whiteboard.propertytypes.HttpWhiteboardServletPattern;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.lang.annotation.Annotation;
import java.lang.reflect.Method;
import java.util.HashMap;
import java.util.Map;

import javax.servlet.Servlet;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.HttpMethod;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;

/** A bundle activator that registers the REST documentation servlet. */
@Component(service = Servlet.class)
@HttpWhiteboardServletName(RestDocsServlet.SERVLET_PATH)
@HttpWhiteboardServletPattern(RestDocsServlet.SERVLET_PATH)
@HttpWhiteboardContextSelect(&quot;(osgi.http.whiteboard.context.name=opencast)&quot;)
<span class="nc" id="L68">public class RestDocsServlet extends HttpServlet {</span>

  /** The logger */
<span class="nc" id="L71">  private static final Logger logger = LoggerFactory.getLogger(RestDocsServlet.class);</span>

  /** The servlet path */
  public static final String SERVLET_PATH = &quot;/docs.html&quot;;

  /** The query string parameter used to specify a specific service */
  private static final String PATH_PARAM = &quot;path&quot;;

  /** java.io serialization UID */
  private static final long serialVersionUID = 6930336096831297329L;

  /** The OSGI bundle context */
  protected BundleContext bundleContext;

  /** A map of global macro values for REST documentation. */
  private Map&lt;String, String&gt; globalMacro;

  @Activate
  public void start(BundleContext bundleContext) throws Exception {
<span class="nc" id="L90">    this.bundleContext = bundleContext;</span>
<span class="nc" id="L91">    prepareMacros();</span>
<span class="nc" id="L92">  }</span>

  /** Add a list of global information, such as the server URL, to the globalMacro map. */
  private void prepareMacros() {
<span class="nc" id="L96">    globalMacro = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L97">    globalMacro.put(&quot;PING_BACK_URL&quot;, bundleContext.getProperty(&quot;org.opencastproject.anonymous.feedback.url&quot;));</span>
<span class="nc" id="L98">    globalMacro.put(&quot;HOST_URL&quot;, bundleContext.getProperty(OpencastConstants.SERVER_URL_PROPERTY));</span>
<span class="nc" id="L99">    globalMacro.put(&quot;LOCAL_STORAGE_DIRECTORY&quot;, bundleContext.getProperty(&quot;org.opencastproject.storage.dir&quot;));</span>
<span class="nc" id="L100">  }</span>

  public void stop(BundleContext bundleContext) throws Exception {
<span class="nc" id="L103">  }</span>

  @Override
  protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
<span class="nc" id="L107">    String docPath = req.getParameter(PATH_PARAM);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">    if (StringUtils.isBlank(docPath)) {</span>
<span class="nc" id="L109">      resp.sendRedirect(&quot;rest_docs.html&quot;);</span>
    } else {
      // write the details for this service
<span class="nc" id="L112">      writeServiceDocumentation(docPath, resp);</span>
    }
<span class="nc" id="L114">  }</span>

  private void writeServiceDocumentation(final String docPath, HttpServletResponse resp)
          throws IOException {
<span class="nc" id="L118">    ServiceReference reference = null;</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">    for (ServiceReference ref : getRestEndpointServices()) {</span>
<span class="nc" id="L120">      String alias = (String) ref.getProperty(SERVICE_PATH_PROPERTY);</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">      if (docPath.equalsIgnoreCase(alias)) {</span>
<span class="nc" id="L122">        reference = ref;</span>
<span class="nc" id="L123">        break;</span>
      }
    }

<span class="nc" id="L127">    final StringBuilder docs = new StringBuilder();</span>

<span class="nc bnc" id="L129" title="All 2 branches missed.">    if (reference == null) {</span>
<span class="nc" id="L130">      docs.append(&quot;REST docs unavailable for &quot;);</span>
<span class="nc" id="L131">      docs.append(docPath);</span>
    } else {
<span class="nc" id="L133">      final Object restService = bundleContext.getService(reference);</span>
<span class="nc" id="L134">      findRestAnnotation(restService.getClass()).fold(new Option.Match&lt;RestService, Void&gt;() {</span>
        @Override
        public Void some(RestService annotation) {
<span class="nc" id="L137">          globalMacro.put(&quot;SERVICE_CLASS_SIMPLE_NAME&quot;, restService.getClass().getSimpleName());</span>
<span class="nc" id="L138">          RestDocData data = new RestDocData(annotation.name(), annotation.title(), docPath, annotation.notes());</span>
<span class="nc" id="L139">          data.setAbstract(annotation.abstractText());</span>

<span class="nc" id="L141">          Produces producesClass = (Produces) restService.getClass().getAnnotation(Produces.class);</span>

<span class="nc bnc" id="L143" title="All 2 branches missed.">          for (Method m : restService.getClass().getMethods()) {</span>
<span class="nc" id="L144">            RestQuery rq = (RestQuery) m.getAnnotation(RestQuery.class);</span>
<span class="nc" id="L145">            String httpMethodString = null;</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">            for (Annotation a : m.getAnnotations()) {</span>
<span class="nc" id="L147">              HttpMethod httpMethod = (HttpMethod) a.annotationType().getAnnotation(HttpMethod.class);</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">              if (httpMethod != null) {</span>
<span class="nc" id="L149">                httpMethodString = httpMethod.value();</span>
              }
            }
<span class="nc" id="L152">            Produces produces = (Produces) m.getAnnotation(Produces.class);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">            if (produces == null) {</span>
<span class="nc" id="L154">              produces = producesClass;</span>
            }
<span class="nc" id="L156">            Path path = (Path) m.getAnnotation(Path.class);</span>
<span class="nc" id="L157">            Class&lt;?&gt; returnType = m.getReturnType();</span>
<span class="nc bnc" id="L158" title="All 6 branches missed.">            if ((rq != null) &amp;&amp; (httpMethodString != null) &amp;&amp; (path != null)) {</span>
<span class="nc" id="L159">              data.addEndpoint(rq, returnType, produces, httpMethodString, path);</span>
            }
          }
<span class="nc" id="L162">          String template = DocUtil.loadTemplate(&quot;/ui/restdocs/template.xhtml&quot;);</span>
<span class="nc" id="L163">          docs.append(DocUtil.generate(data, template));</span>
<span class="nc" id="L164">          return null;</span>
        }

        @Override
        public Void none() {
<span class="nc" id="L169">          docs.append(&quot;No documentation has been found for &quot;).append(restService.getClass().getSimpleName());</span>
<span class="nc" id="L170">          return null;</span>
        }
      });
    }

<span class="nc" id="L175">    resp.setContentType(&quot;text/html&quot;);</span>
<span class="nc" id="L176">    resp.getWriter().write(docs.toString());</span>
<span class="nc" id="L177">  }</span>

  private ServiceReference[] getRestEndpointServices() {
    try {
<span class="nc" id="L181">      return bundleContext.getAllServiceReferences(null, SERVICES_FILTER);</span>
<span class="nc" id="L182">    } catch (InvalidSyntaxException e) {</span>
<span class="nc" id="L183">      logger.warn(&quot;Unable to query the OSGI service registry for all registered rest endpoints&quot;);</span>
<span class="nc" id="L184">      return new ServiceReference[0];</span>
    }
  }

  /** Try to find the RestService annotation starting at &lt;code&gt;endpointClass&lt;/code&gt;. */
  public static Option&lt;RestService&gt; findRestAnnotation(Class&lt;?&gt; endpointClass) {
<span class="nc bnc" id="L190" title="All 2 branches missed.">    if (endpointClass == null) {</span>
<span class="nc" id="L191">      return none();</span>
    }
<span class="nc" id="L193">    final RestService rs = endpointClass.getAnnotation(RestService.class);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">    if (rs == null) {</span>
<span class="nc" id="L195">      return findRestAnnotation(endpointClass.getSuperclass());</span>
    } else {
<span class="nc" id="L197">      return some(rs);</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>