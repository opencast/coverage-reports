<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AclScanner.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-authorization-manager</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.authorization.xacml.manager.impl</a> &gt; <span class="el_source">AclScanner.java</span></div><h1>AclScanner.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.authorization.xacml.manager.impl;

import org.opencastproject.authorization.xacml.manager.api.AclService;
import org.opencastproject.authorization.xacml.manager.api.AclServiceException;
import org.opencastproject.authorization.xacml.manager.api.AclServiceFactory;
import org.opencastproject.authorization.xacml.manager.api.ManagedAcl;
import org.opencastproject.security.api.AccessControlList;
import org.opencastproject.security.api.AccessControlParser;
import org.opencastproject.security.api.AccessControlParsingException;
import org.opencastproject.security.api.Organization;
import org.opencastproject.security.api.OrganizationDirectoryService;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.util.NotFoundException;

import org.apache.commons.io.FilenameUtils;
import org.apache.felix.fileinstall.ArtifactInstaller;
import org.osgi.framework.BundleContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Deactivate;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;

@Component(
    immediate = true,
    service = { ArtifactInstaller.class, AclScanner.class },
    property = {
        &quot;service.description=Acl Scanner&quot;
    }
)
<span class="fc" id="L61">public class AclScanner implements ArtifactInstaller {</span>

  /** The directory name that holds the ACL files **/
  public static final String ACL_DIRECTORY = &quot;acl&quot;;

  /** The logging instance */
<span class="fc" id="L67">  private static final Logger logger = LoggerFactory.getLogger(AclScanner.class);</span>

  /** The organization directory service */
  private OrganizationDirectoryService organizationDirectoryService;

  /** The Access Control service */
  private AclServiceFactory aclServiceFactory;

  private SecurityService securityService;

  /**
   * A map linking the Acl file name concatenate with the organization id {@code filename_organizationId} to the related
   * managed Acl Id
   */
<span class="fc" id="L81">  private final Map&lt;String, Long&gt; managedAcls = new HashMap&lt;&gt;();</span>

  /**
   * OSGI service activation method
   */
  @Activate
  void activate(BundleContext ctx) {
<span class="nc" id="L88">    logger.info(&quot;Activated Acl scanner&quot;);</span>
<span class="nc" id="L89">  }</span>

  /**
   * OSGI deactivation method
   */
  @Deactivate
  void deactivate(BundleContext ctx) {
<span class="nc" id="L96">    logger.info(&quot;Deactivated Acl scanner&quot;);</span>
<span class="nc" id="L97">  }</span>

  /** OSGi DI. */
  @Reference
  void setOrganizationDirectoryService(OrganizationDirectoryService organizationDirectoryService) {
<span class="fc" id="L102">    this.organizationDirectoryService = organizationDirectoryService;</span>
<span class="fc" id="L103">  }</span>

  /** OSGi callback for setting persistence. */
  @Reference
  void setAclServiceFactory(AclServiceFactory aclServiceFactory) {
<span class="fc" id="L108">    this.aclServiceFactory = aclServiceFactory;</span>
<span class="fc" id="L109">  }</span>

  /** OSGi DI */
  @Reference
  void setSecurityService(SecurityService securityService) {
<span class="fc" id="L114">    this.securityService = securityService;</span>
<span class="fc" id="L115">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.apache.felix.fileinstall.ArtifactListener#canHandle(java.io.File)
   */
  @Override
  public boolean canHandle(File artifact) {
<span class="nc bnc" id="L124" title="All 4 branches missed.">    return ACL_DIRECTORY.equals(artifact.getParentFile().getName()) &amp;&amp; artifact.getName().endsWith(&quot;.json&quot;);</span>
  }

  /**
   * Add ACL from configuration directory to all organizations.
   *
   * @param artifact
   *          The File representing the ACL.
   * @throws IOException
   * @throws AccessControlParsingException
   */
  private void addAcl(File artifact) throws IOException, AccessControlParsingException {
<span class="fc" id="L136">    List&lt;Organization&gt; organizations = organizationDirectoryService.getOrganizations();</span>

<span class="fc" id="L138">    logger.debug(&quot;Adding Acl {}&quot;, artifact.getAbsolutePath());</span>

<span class="fc" id="L140">    String fileName = FilenameUtils.removeExtension(artifact.getName());</span>
<span class="fc" id="L141">    AccessControlList acl = parseToAcl(artifact);</span>
    Optional&lt;ManagedAcl&gt; managedAcl;

    // Add the Acl to all the organizations
<span class="fc bfc" id="L145" title="All 2 branches covered.">    for (Organization org : organizations) {</span>
<span class="fc" id="L146">      securityService.setOrganization(org);</span>
      // If there are already (not-default) Acl defined for this organization, we skip this one.
<span class="fc" id="L148">      boolean skip = false;</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">      for (ManagedAcl a : getAclService(org).getAcls()) {</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (managedAcls.get(generateAclId(a.getName(), org)) == null) {</span>
<span class="nc" id="L151">          logger.debug(</span>
                  &quot;The Acl {} will be not added to the organisation {} as it already contains other not-default Acls.&quot;,
<span class="nc" id="L153">                  fileName, org.getName());</span>
<span class="nc" id="L154">          skip = true;</span>
<span class="nc" id="L155">          continue;</span>
        }
<span class="nc" id="L157">      }</span>
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">      if (!skip) {</span>
<span class="fc" id="L159">        managedAcl = getAclService(org).createAcl(acl, fileName);</span>
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">        if (managedAcl.isPresent()) {</span>
<span class="fc" id="L161">          managedAcls.put(generateAclId(fileName, org), managedAcl.get().getId());</span>
<span class="fc" id="L162">          logger.debug(&quot;Acl from '{}' has been added for the organisation {}&quot;, fileName, org.getName());</span>
        } else {
<span class="nc" id="L164">          logger.debug(&quot;Acl from '{}' has already been added to the organisation {}.&quot;, fileName, org.getName());</span>
        }
      }
<span class="fc" id="L167">    }</span>
<span class="fc" id="L168">  }</span>

  /**
   * Update ACL from configuration directory in all organizations.
   *
   * @param artifact
   *          The File representing the ACL.
   * @throws IOException
   * @throws AccessControlParser
   */
  private void updateAcl(File artifact) throws IOException, AccessControlParsingException {
<span class="fc" id="L179">    List&lt;Organization&gt; organizations = organizationDirectoryService.getOrganizations();</span>

<span class="fc" id="L181">    logger.debug(&quot;Updating Acl {}&quot;, artifact.getAbsolutePath());</span>

<span class="fc" id="L183">    String fileName = FilenameUtils.removeExtension(artifact.getName());</span>
<span class="fc" id="L184">    AccessControlList acl = parseToAcl(artifact);</span>

    // Update the Acl on all the organizations
<span class="fc bfc" id="L187" title="All 2 branches covered.">    for (Organization org : organizations) {</span>
<span class="fc" id="L188">      securityService.setOrganization(org);</span>
<span class="fc" id="L189">      Long id = managedAcls.get(generateAclId(fileName, org));</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">      if (id != null) {</span>
        // If the Acl Id is in the managedAcls map, we update the Acl
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">        if (!getAclService(org).updateAcl(new ManagedAclImpl(id, fileName, org.getId(), acl))) {</span>
<span class="nc" id="L193">          logger.warn(&quot;No Acl found with the id {} for the organisation {}.&quot;, id, org.getName());</span>
        } else {
<span class="fc" id="L195">          logger.debug(&quot;Acl from file {} has been updated for the organisation {}&quot;, fileName, org.getName());</span>
        }
      } else {
<span class="fc" id="L198">        logger.info(&quot;The ACL file {} has not been added to the organisation {} and will therefore not be updated&quot;,</span>
<span class="fc" id="L199">                fileName, org.getName());</span>
      }
<span class="fc" id="L201">    }</span>
<span class="fc" id="L202">  }</span>

  /**
   * Remove ACL from configuration directory from all the organizations.
   *
   * @param artifact
   *          The File representing the ACL.
   */
  private void removeAcl(File artifact) {
<span class="fc" id="L211">    List&lt;Organization&gt; organizations = organizationDirectoryService.getOrganizations();</span>

<span class="fc" id="L213">    logger.debug(&quot;Removing Acl {}&quot;, artifact.getAbsolutePath());</span>

<span class="fc" id="L215">    String fileName = FilenameUtils.removeExtension(artifact.getName());</span>

    // Remove the Acl on all the organizations
<span class="fc bfc" id="L218" title="All 2 branches covered.">    for (Organization org : organizations) {</span>
<span class="fc" id="L219">      securityService.setOrganization(org);</span>
<span class="fc" id="L220">      Long id = managedAcls.get(generateAclId(fileName, org));</span>
<span class="fc bfc" id="L221" title="All 2 branches covered.">      if (id != null) {</span>
        try {
<span class="fc" id="L223">          getAclService(org).deleteAcl(id);</span>
<span class="nc" id="L224">        } catch (NotFoundException e) {</span>
<span class="nc" id="L225">          logger.debug(&quot;Unable to delete managed acl {}. Managed acl already deleted!&quot;, id);</span>
<span class="nc" id="L226">        } catch (AclServiceException e) {</span>
<span class="nc" id="L227">          logger.error(&quot;Unable to delete managed acl {}&quot;, id, e);</span>
<span class="pc" id="L228">        }</span>
      } else {
<span class="fc" id="L230">        logger.debug(&quot;No Acl matching file {} found.&quot;, fileName);</span>
      }
<span class="fc" id="L232">    }</span>
<span class="fc" id="L233">  }</span>

  /**
   * Generate an Acl Id from ACL filename and organization id
   *
   * @param fileName
   *          the ACL file
   * @param org
   *          the organization
   * @return the generated Acl Id
   */
  private String generateAclId(String fileName, Organization org) {
<span class="fc" id="L245">    return fileName + &quot;_&quot; + org.getId();</span>
  }

  /**
   * Parse the given ACL JSON file into an Access Control List
   *
   * @param artifact JSON file
   * @return Parsed access control list
   * @throws IOException Error accessing the ACL file
   * @throws AccessControlParsingException Error parsing the ACL files
   */
  private AccessControlList parseToAcl(File artifact)
          throws IOException, AccessControlParsingException {
<span class="fc" id="L258">    try (FileInputStream in = new FileInputStream(artifact)) {</span>
<span class="fc" id="L259">      return AccessControlParser.parseAcl(in);</span>
    }
  }

  private AclService getAclService(Organization organization) {
<span class="fc" id="L264">    return aclServiceFactory.serviceFor(organization);</span>
  }

  @Override
  public void install(File artifact) throws Exception {
<span class="fc" id="L269">    logger.info(&quot;Installing Acl {}&quot;, artifact.getAbsolutePath());</span>
<span class="fc" id="L270">    addAcl(artifact);</span>
<span class="fc" id="L271">  }</span>

  @Override
  public void update(File artifact) throws Exception {
<span class="fc" id="L275">    logger.info(&quot;Updating Acl {}&quot;, artifact.getAbsolutePath());</span>
<span class="fc" id="L276">    updateAcl(artifact);</span>
<span class="fc" id="L277">  }</span>

  @Override
  public void uninstall(File artifact) throws Exception {
<span class="fc" id="L281">    logger.info(&quot;Removing Acl {}&quot;, artifact.getAbsolutePath());</span>
<span class="fc" id="L282">    removeAcl(artifact);</span>
<span class="fc" id="L283">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>