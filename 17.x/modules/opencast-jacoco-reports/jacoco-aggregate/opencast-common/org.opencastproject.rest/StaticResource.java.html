<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>StaticResource.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-common</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.rest</a> &gt; <span class="el_source">StaticResource.java</span></div><h1>StaticResource.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.rest;

import org.opencastproject.util.MimeTypes;

import org.apache.commons.codec.digest.DigestUtils;
import org.apache.commons.io.IOUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.io.InputStream;
import java.net.URL;
import java.util.Map;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/**
 * A static resource for registration with the http service.
 */
public class StaticResource extends HttpServlet {
  /** The java.io.serialization uid */
  private static final long serialVersionUID = 1L;

  /** The logger */
<span class="nc" id="L49">  private static final Logger logger = LoggerFactory.getLogger(StaticResource.class);</span>

  /** The classpath to search for the static resources */
<span class="nc" id="L52">  protected String classpath = null;</span>

  /** The base URL for these static resources */
<span class="nc" id="L55">  protected String alias = null;</span>

  /** The welcome file to redirect to, if only the alias is specified in the request */
<span class="nc" id="L58">  protected String welcomeFile = null;</span>

  /** The enable spa redirect flag */
<span class="nc" id="L61">  protected boolean spaRedirect = false;</span>

  /** The classloader to use to search for the static resources. */
<span class="nc" id="L64">  protected ClassLoader classloader = null;</span>

  /**
   * Constructs a static resources.
   *
   * @param classpath
   *          the classpath to the static resources
   * @param alias
   *          the URL alias
   * @param welcomeFile
   *          the default welcome file
   */
  public StaticResource(ClassLoader classloader, String classpath, String alias, String welcomeFile) {
<span class="nc" id="L77">    this(classloader, classpath, alias, welcomeFile, false);</span>
<span class="nc" id="L78">  }</span>

  /**
   * Constructs a static resources.
   *
   * @param classpath
   *          the classpath to the static resources
   * @param alias
   *          the URL alias
   * @param welcomeFile
   *          the default welcome file
   * @param spaRedirect
   *          enable spa redirects
   */
<span class="nc" id="L92">  public StaticResource(ClassLoader classloader, String classpath, String alias, String welcomeFile, boolean spaRedirect) {</span>
<span class="nc" id="L93">    this.classpath = classpath;</span>
<span class="nc" id="L94">    this.alias = alias;</span>
<span class="nc" id="L95">    this.welcomeFile = welcomeFile;</span>
<span class="nc" id="L96">    this.classloader = classloader;</span>
<span class="nc" id="L97">    this.spaRedirect = spaRedirect;</span>
<span class="nc" id="L98">  }</span>

  /**
   * Activates the static resource when it is instantiated using Declarative Services.
   *
   * @param componentProperties
   *          the DS component context
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  public void activate(Map componentProperties) {
<span class="nc bnc" id="L108" title="All 2 branches missed.">    if (welcomeFile == null)</span>
<span class="nc" id="L109">      welcomeFile = (String) componentProperties.get(&quot;welcome.file&quot;);</span>
<span class="nc" id="L110">    boolean welcomeFileSpecified = true;</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">    if (welcomeFile == null) {</span>
<span class="nc" id="L112">      welcomeFileSpecified = false;</span>
<span class="nc" id="L113">      welcomeFile = &quot;index.html&quot;;</span>
    }
<span class="nc bnc" id="L115" title="All 2 branches missed.">    if (alias == null)</span>
<span class="nc" id="L116">      alias = (String) componentProperties.get(&quot;alias&quot;);</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">    if (classpath == null)</span>
<span class="nc" id="L118">      classpath = (String) componentProperties.get(&quot;classpath&quot;);</span>
<span class="nc" id="L119">    logger.info(&quot;registering classpath:{} at {} with welcome file {} {}&quot;, classpath, alias, welcomeFile,</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">            welcomeFileSpecified ? &quot;&quot; : &quot;(via default)&quot;);</span>
<span class="nc" id="L121">  }</span>

  public String getDefaultUrl() {
<span class="nc" id="L124">    return alias;</span>
  }

  @Override
  public String toString() {
<span class="nc" id="L129">    return &quot;StaticResource [alias=&quot; + alias + &quot;, classpath=&quot; + classpath + &quot;, welcome file=&quot; + welcomeFile + &quot;]&quot;;</span>
  }

  @Override
  public void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
<span class="nc" id="L134">    String pathInfo = req.getPathInfo();</span>
<span class="nc" id="L135">    String servletPath = req.getServletPath();</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">    String path = pathInfo == null ? servletPath : servletPath + pathInfo;</span>
<span class="nc" id="L137">    logger.debug(&quot;handling path {}, pathInfo={}, servletPath={}&quot;, path, pathInfo, servletPath);</span>

    // If the URL points to a &quot;directory&quot;, redirect to the welcome file
<span class="nc bnc" id="L140" title="All 6 branches missed.">    if (&quot;/&quot;.equals(path) || alias.equals(path) || (alias + &quot;/&quot;).equals(path)) {</span>
      String redirectPath;
<span class="nc bnc" id="L142" title="All 2 branches missed.">      if (&quot;/&quot;.equals(alias)) {</span>
<span class="nc" id="L143">        redirectPath = &quot;/&quot; + welcomeFile;</span>
      } else {
<span class="nc" id="L145">        redirectPath = alias + &quot;/&quot; + welcomeFile;</span>
      }
<span class="nc" id="L147">      String queryString = req.getQueryString();</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">      redirectPath += queryString != null ? &quot;?&quot; + queryString : &quot;&quot;;</span>
<span class="nc" id="L149">      logger.debug(&quot;redirecting {} to {}&quot;, path, redirectPath);</span>
<span class="nc" id="L150">      resp.sendRedirect(redirectPath);</span>
<span class="nc" id="L151">      return;</span>
    }

    // Find and deliver the resource
    String classpathToResource;
<span class="nc bnc" id="L156" title="All 2 branches missed.">    if (pathInfo == null) {</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">      if (!servletPath.equals(alias)) {</span>
<span class="nc" id="L158">        classpathToResource = classpath + servletPath;</span>
      } else {
<span class="nc" id="L160">        classpathToResource = classpath + &quot;/&quot; + welcomeFile;</span>
      }
    } else {
<span class="nc" id="L163">      classpathToResource = classpath + pathInfo;</span>
    }

    // Make sure we are using an absolute path
<span class="nc bnc" id="L167" title="All 2 branches missed.">    if (!classpathToResource.startsWith(&quot;/&quot;))</span>
<span class="nc" id="L168">      classpathToResource = &quot;/&quot; + classpathToResource;</span>

    // Try to load the resource from the classloader
<span class="nc" id="L171">    URL url = classloader.getResource(classpathToResource);</span>

    // Support SPA path locations
<span class="nc bnc" id="L174" title="All 4 branches missed.">    if (spaRedirect &amp;&amp; url == null) {</span>
<span class="nc" id="L175">      String spaRedirect = classpath + &quot;/&quot; + welcomeFile;</span>
<span class="nc" id="L176">      logger.trace(&quot;using fallback {}&quot;, spaRedirect);</span>
<span class="nc" id="L177">      url = classloader.getResource(spaRedirect);</span>
    }

<span class="nc bnc" id="L180" title="All 2 branches missed.">    if (url == null) {</span>
<span class="nc" id="L181">      resp.sendError(404);</span>
<span class="nc" id="L182">      return;</span>
    }

<span class="nc" id="L185">    logger.debug(&quot;opening url {} {}&quot;, classpathToResource, url);</span>
<span class="nc" id="L186">    try (InputStream in = url.openStream()) {</span>
<span class="nc" id="L187">      String md5 = DigestUtils.md5Hex(in);</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">      if (md5.equals(req.getHeader(&quot;If-None-Match&quot;))) {</span>
<span class="nc" id="L189">        resp.setStatus(304);</span>
<span class="nc" id="L190">        return;</span>
      }
<span class="nc" id="L192">      resp.setHeader(&quot;ETag&quot;, md5);</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">    }</span>

<span class="nc" id="L195">    String contentType = MimeTypes.getMimeType(url.getPath());</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">    if (!MimeTypes.DEFAULT_TYPE.equals(contentType)) {</span>
<span class="nc" id="L197">      resp.setHeader(&quot;Content-Type&quot;, contentType);</span>
    }

<span class="nc" id="L200">    try (InputStream in = url.openStream()) {</span>
<span class="nc" id="L201">      IOUtils.copy(in, resp.getOutputStream());</span>
    }
<span class="nc" id="L203">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>