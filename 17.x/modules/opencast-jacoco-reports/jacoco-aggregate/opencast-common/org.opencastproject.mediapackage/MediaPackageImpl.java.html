<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>MediaPackageImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-common</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.mediapackage</a> &gt; <span class="el_source">MediaPackageImpl.java</span></div><h1>MediaPackageImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */


package org.opencastproject.mediapackage;

import static org.opencastproject.mediapackage.MediaPackageSupport.Filters.presentations;
import static org.opencastproject.util.data.Monadics.mlist;

import org.opencastproject.mediapackage.MediaPackageElement.Type;
import org.opencastproject.mediapackage.identifier.Id;
import org.opencastproject.mediapackage.identifier.IdImpl;
import org.opencastproject.util.DateTimeSupport;
import org.opencastproject.util.IoSupport;
import org.opencastproject.util.XmlSafeParser;

import org.apache.commons.io.IOUtils;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.w3c.dom.Node;
import org.w3c.dom.bootstrap.DOMImplementationRegistry;
import org.w3c.dom.ls.DOMImplementationLS;
import org.w3c.dom.ls.LSOutput;
import org.w3c.dom.ls.LSSerializer;
import org.xml.sax.SAXException;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.URI;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Date;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeSet;
import java.util.UUID;

import javax.xml.bind.JAXBContext;
import javax.xml.bind.JAXBException;
import javax.xml.bind.Unmarshaller;
import javax.xml.bind.annotation.XmlAccessType;
import javax.xml.bind.annotation.XmlAccessorType;
import javax.xml.bind.annotation.XmlAttribute;
import javax.xml.bind.annotation.XmlElement;
import javax.xml.bind.annotation.XmlElementWrapper;
import javax.xml.bind.annotation.XmlRootElement;
import javax.xml.bind.annotation.XmlType;
import javax.xml.bind.annotation.adapters.XmlAdapter;
import javax.xml.transform.stream.StreamSource;

/**
 * Default implementation for a media media package.
 */
@XmlType(name = &quot;mediapackage&quot;, namespace = &quot;http://mediapackage.opencastproject.org&quot;, propOrder = { &quot;title&quot;, &quot;series&quot;,
        &quot;seriesTitle&quot;, &quot;creators&quot;, &quot;contributors&quot;, &quot;subjects&quot;, &quot;license&quot;, &quot;language&quot;, &quot;tracks&quot;, &quot;catalogs&quot;,
        &quot;attachments&quot;, &quot;publications&quot; })
@XmlRootElement(name = &quot;mediapackage&quot;, namespace = &quot;http://mediapackage.opencastproject.org&quot;)
@XmlAccessorType(XmlAccessType.NONE)
public final class MediaPackageImpl implements MediaPackage {

  /** the logging facility provided by log4j */
<span class="fc" id="L86">  private static final Logger logger = LoggerFactory.getLogger(MediaPackageImpl.class.getName());</span>

  /**
   * The prefix indicating that a tag should be excluded from a search for elements using
   * {@link #getElementsByTags(Collection)}
   */
  public static final String NEGATE_TAG_PREFIX = &quot;-&quot;;

  /** Context for serializing and deserializing */
  static final JAXBContext context;

  /** The media package element builder, may remain &lt;code&gt;null&lt;/code&gt; */
<span class="fc" id="L98">  private MediaPackageElementBuilder mediaPackageElementBuilder = null;</span>

<span class="fc" id="L100">  @XmlElement(name = &quot;title&quot;)</span>
  private String title = null;

<span class="fc" id="L103">  @XmlElement(name = &quot;seriestitle&quot;)</span>
  private String seriesTitle = null;

<span class="fc" id="L106">  @XmlElement(name = &quot;language&quot;)</span>
  private String language = null;

<span class="fc" id="L109">  @XmlElement(name = &quot;series&quot;)</span>
  private String series = null;

<span class="fc" id="L112">  @XmlElement(name = &quot;license&quot;)</span>
  private String license = null;

<span class="fc" id="L115">  @XmlElementWrapper(name = &quot;creators&quot;)</span>
  @XmlElement(name = &quot;creator&quot;)
  private Set&lt;String&gt; creators = null;

<span class="fc" id="L119">  @XmlElementWrapper(name = &quot;contributors&quot;)</span>
  @XmlElement(name = &quot;contributor&quot;)
  private Set&lt;String&gt; contributors = null;

<span class="fc" id="L123">  @XmlElementWrapper(name = &quot;subjects&quot;)</span>
  @XmlElement(name = &quot;subject&quot;)
  private Set&lt;String&gt; subjects = null;

  /** The media package's identifier */
<span class="fc" id="L128">  private Id identifier = null;</span>

  /** The start date and time */
<span class="fc" id="L131">  private long startTime = 0L;</span>

  /** The media package duration */
<span class="fc" id="L134">  private Long duration = null;</span>

  /** The media package's other (uncategorized) files */
<span class="fc" id="L137">  private final List&lt;MediaPackageElement&gt; elements = new ArrayList&lt;MediaPackageElement&gt;();</span>

  /** Number of tracks */
<span class="fc" id="L140">  private int tracks = 0;</span>

  /** Number of metadata catalogs */
<span class="fc" id="L143">  private int catalogs = 0;</span>

  /** Number of attachments */
<span class="fc" id="L146">  private int attachments = 0;</span>

  /** Numer of unclassified elements */
<span class="fc" id="L149">  private int others = 0;</span>

  static {
    try {
<span class="fc" id="L153">      context = JAXBContext.newInstance(&quot;org.opencastproject.mediapackage&quot;, MediaPackageImpl.class.getClassLoader());</span>
<span class="nc" id="L154">    } catch (JAXBException e) {</span>
<span class="nc" id="L155">      throw new RuntimeException(e);</span>
<span class="fc" id="L156">    }</span>
<span class="fc" id="L157">  }</span>

  /**
   * Creates a media package object.
   */
  MediaPackageImpl() {
<span class="fc" id="L163">    this(IdImpl.fromUUID());</span>
<span class="fc" id="L164">  }</span>

  /**
   * Creates a media package object with the media package identifier.
   *
   * @param id
   *          the media package identifier
   */
<span class="fc" id="L172">  MediaPackageImpl(Id id) {</span>
<span class="fc" id="L173">    this.identifier = id;</span>
<span class="fc" id="L174">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getIdentifier()
   */
  @XmlAttribute(name = &quot;id&quot;)
  @Override
  public Id getIdentifier() {
<span class="fc" id="L184">    return identifier;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#setIdentifier(org.opencastproject.mediapackage.identifier.Id)
   */
  @Override
  public void setIdentifier(Id identifier) {
<span class="fc" id="L194">    this.identifier = identifier;</span>
<span class="fc" id="L195">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getDuration()
   */
  @XmlAttribute(name = &quot;duration&quot;)
  @Override
  public Long getDuration() {
<span class="fc bfc" id="L205" title="All 4 branches covered.">    if (duration == null &amp;&amp; hasTracks()) {</span>
<span class="fc" id="L206">      recalculateDuration();</span>
    }
<span class="fc" id="L208">    return duration;</span>
  }

  /**
   * The duration of the media package is the duration of the longest track
   */
  private void recalculateDuration() {

<span class="fc" id="L216">    duration = null;</span>
<span class="fc bfc" id="L217" title="All 2 branches covered.">    for (Track t : getTracks()) {</span>
<span class="fc bfc" id="L218" title="All 2 branches covered.">      if (t.getDuration() != null) {</span>
<span class="fc bfc" id="L219" title="All 4 branches covered.">        if (duration == null || duration &lt; t.getDuration())</span>
<span class="fc" id="L220">          duration = t.getDuration();</span>
      }
    }
<span class="fc" id="L223">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#setDuration(Long)
   */
  @Override
  public void setDuration(Long duration) throws IllegalStateException {
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">    if (hasTracks())</span>
<span class="nc" id="L233">      throw new IllegalStateException(</span>
              &quot;The duration is determined by the length of the tracks and cannot be set manually&quot;);
<span class="fc" id="L235">    this.duration = duration;</span>
<span class="fc" id="L236">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getDate()
   */
  @Override
  public Date getDate() {
<span class="fc" id="L245">    return new Date(startTime);</span>
  }

  /**
   * Returns the recording time in utc format.
   *
   * @return the recording time
   */
  @XmlAttribute(name = &quot;start&quot;)
  public String getStartDateAsString() {
<span class="fc bfc" id="L255" title="All 2 branches covered.">    if (startTime == 0)</span>
<span class="fc" id="L256">      return null;</span>
<span class="fc" id="L257">    return DateTimeSupport.toUTC(startTime);</span>
  }

  /**
   * Sets the date and time of recording in utc format.
   *
   * @param startTime
   *          the start time
   */
  public void setStartDateAsString(String startTime) {
<span class="pc bpc" id="L267" title="2 of 6 branches missed.">    if (startTime != null &amp;&amp; !&quot;0&quot;.equals(startTime) &amp;&amp; !startTime.isEmpty()) {</span>
      try {
<span class="fc" id="L269">        this.startTime = DateTimeSupport.fromUTC(startTime);</span>
<span class="nc" id="L270">      } catch (Exception e) {</span>
<span class="nc" id="L271">        logger.info(&quot;Unable to parse start time {}&quot;, startTime);</span>
<span class="pc" id="L272">      }</span>
    } else {
<span class="fc" id="L274">      this.startTime = 0;</span>
    }
<span class="fc" id="L276">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#elements()
   */
  @Override
  public Iterable&lt;MediaPackageElement&gt; elements() {
<span class="fc" id="L285">    return Arrays.asList(getElements());</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getElements()
   */
  @Override
  public MediaPackageElement[] getElements() {
<span class="fc" id="L295">    return elements.toArray(new MediaPackageElement[elements.size()]);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getElementByReference(org.opencastproject.mediapackage.MediaPackageReference)
   */
  @Override
  public MediaPackageElement getElementByReference(MediaPackageReference reference) {
<span class="nc bnc" id="L305" title="All 2 branches missed.">    for (MediaPackageElement e : this.elements) {</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">      if (!reference.getType().equalsIgnoreCase(e.getElementType().toString()))</span>
<span class="nc" id="L307">        continue;</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">      if (reference.getIdentifier().equals(e.getIdentifier()))</span>
<span class="nc" id="L309">        return e;</span>
<span class="nc" id="L310">    }</span>
<span class="nc" id="L311">    return null;</span>
  }

  /**
   * @see org.opencastproject.mediapackage.MediaPackage#getElementById(java.lang.String)
   */
  @Override
  public MediaPackageElement getElementById(String id) {
<span class="fc bfc" id="L319" title="All 2 branches covered.">    for (MediaPackageElement element : getElements()) {</span>
<span class="fc bfc" id="L320" title="All 2 branches covered.">      if (id.equals(element.getIdentifier()))</span>
<span class="fc" id="L321">        return element;</span>
    }
<span class="fc" id="L323">    return null;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getElementsByTags(java.util.Collection)
   */
  @Override
  public MediaPackageElement[] getElementsByTags(Collection&lt;String&gt; tags) {
<span class="pc bpc" id="L333" title="2 of 4 branches missed.">    if (tags == null || tags.isEmpty())</span>
<span class="nc" id="L334">      return getElements();</span>
<span class="fc" id="L335">    Set&lt;String&gt; keep = new HashSet&lt;String&gt;();</span>
<span class="fc" id="L336">    Set&lt;String&gt; lose = new HashSet&lt;String&gt;();</span>
<span class="fc bfc" id="L337" title="All 2 branches covered.">    for (String tag : tags) {</span>
<span class="pc bpc" id="L338" title="1 of 2 branches missed.">      if (StringUtils.isBlank(tag))</span>
<span class="nc" id="L339">        continue;</span>
<span class="pc bpc" id="L340" title="1 of 2 branches missed.">      if (tag.startsWith(NEGATE_TAG_PREFIX)) {</span>
<span class="nc" id="L341">        lose.add(tag.substring(NEGATE_TAG_PREFIX.length()));</span>
      } else {
<span class="fc" id="L343">        keep.add(tag);</span>
      }
<span class="fc" id="L345">    }</span>
<span class="fc" id="L346">    List&lt;MediaPackageElement&gt; result = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L347" title="All 2 branches covered.">    for (MediaPackageElement element : getElements()) {</span>
<span class="fc" id="L348">      boolean add = false;</span>
<span class="fc bfc" id="L349" title="All 2 branches covered.">      for (String elementTag : element.getTags()) {</span>
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">        if (lose.contains(elementTag)) {</span>
<span class="nc" id="L351">          add = false;</span>
<span class="nc" id="L352">          break;</span>
<span class="fc bfc" id="L353" title="All 2 branches covered.">        } else if (keep.contains(elementTag)) {</span>
<span class="fc" id="L354">          add = true;</span>
        }
      }
<span class="fc bfc" id="L357" title="All 2 branches covered.">      if (add) {</span>
<span class="fc" id="L358">        result.add(element);</span>
      }
    }
<span class="fc" id="L361">    return result.toArray(new MediaPackageElement[result.size()]);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getCatalogsByTags(java.util.Collection)
   */
  @Override
  public Catalog[] getCatalogsByTags(Collection&lt;String&gt; tags) {
<span class="nc" id="L371">    MediaPackageElement[] matchingElements = getElementsByTags(tags);</span>
<span class="nc" id="L372">    List&lt;Catalog&gt; catalogs = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">    for (MediaPackageElement element : matchingElements) {</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">      if (Catalog.TYPE.equals(element.getElementType())) {</span>
<span class="nc" id="L375">        catalogs.add((Catalog) element);</span>
      }
    }
<span class="nc" id="L378">    return catalogs.toArray(new Catalog[catalogs.size()]);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getTracksByTags(java.util.Collection)
   */
  @Override
  public Track[] getTracksByTags(Collection&lt;String&gt; tags) {
<span class="nc" id="L388">    MediaPackageElement[] matchingElements = getElementsByTags(tags);</span>
<span class="nc" id="L389">    List&lt;Track&gt; tracks = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">    for (MediaPackageElement element : matchingElements) {</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">      if (Track.TYPE.equals(element.getElementType())) {</span>
<span class="nc" id="L392">        tracks.add((Track) element);</span>
      }
    }
<span class="nc" id="L395">    return tracks.toArray(new Track[tracks.size()]);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getElementsByFlavor(org.opencastproject.mediapackage.MediaPackageElementFlavor)
   */
  @Override
  public MediaPackageElement[] getElementsByFlavor(MediaPackageElementFlavor flavor) {
<span class="pc bpc" id="L405" title="1 of 2 branches missed.">    if (flavor == null)</span>
<span class="nc" id="L406">      throw new IllegalArgumentException(&quot;Flavor cannot be null&quot;);</span>

<span class="fc" id="L408">    List&lt;MediaPackageElement&gt; elements = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L409" title="All 2 branches covered.">    for (MediaPackageElement element : getElements()) {</span>
<span class="fc bfc" id="L410" title="All 2 branches covered.">      if (flavor.matches(element.getFlavor()))</span>
<span class="fc" id="L411">        elements.add(element);</span>
    }
<span class="fc" id="L413">    return elements.toArray(new MediaPackageElement[elements.size()]);</span>
  }

  /**
   * @see org.opencastproject.mediapackage.MediaPackage#contains(org.opencastproject.mediapackage.MediaPackageElement)
   */
  @Override
  public boolean contains(MediaPackageElement element) {
<span class="pc bpc" id="L421" title="1 of 2 branches missed.">    if (element == null)</span>
<span class="nc" id="L422">      throw new IllegalArgumentException(&quot;Media package element must not be null&quot;);</span>
<span class="fc" id="L423">    return (elements.contains(element));</span>
  }

  /**
   * Returns &lt;code&gt;true&lt;/code&gt; if the media package contains an element with the specified identifier.
   *
   * @param identifier
   *          the identifier
   * @return &lt;code&gt;true&lt;/code&gt; if the media package contains an element with this identifier
   */
  boolean contains(String identifier) {
<span class="fc bfc" id="L434" title="All 2 branches covered.">    for (MediaPackageElement element : getElements()) {</span>
<span class="fc bfc" id="L435" title="All 2 branches covered.">      if (element.getIdentifier().equals(identifier))</span>
<span class="fc" id="L436">        return true;</span>
    }
<span class="fc" id="L438">    return false;</span>
  }

  /**
   * @see org.opencastproject.mediapackage.MediaPackage#add(org.opencastproject.mediapackage.Catalog)
   */
  @Override
  public void add(Catalog catalog) {
<span class="fc" id="L446">    integrateCatalog(catalog);</span>
<span class="fc" id="L447">    addInternal(catalog);</span>
<span class="fc" id="L448">  }</span>

  /**
   * @see org.opencastproject.mediapackage.MediaPackage#add(org.opencastproject.mediapackage.Track)
   */
  @Override
  public void add(Track track) {
<span class="fc" id="L455">    integrateTrack(track);</span>
<span class="fc" id="L456">    addInternal(track);</span>
<span class="fc" id="L457">  }</span>

  /**
   * @see org.opencastproject.mediapackage.MediaPackage#add(org.opencastproject.mediapackage.Attachment)
   */
  @Override
  public void add(Attachment attachment) {
<span class="fc" id="L464">    integrateAttachment(attachment);</span>
<span class="fc" id="L465">    addInternal(attachment);</span>
<span class="fc" id="L466">  }</span>

  /**
   * @see org.opencastproject.mediapackage.MediaPackage#getCatalog(java.lang.String)
   */
  @Override
  public Catalog getCatalog(String catalogId) {
<span class="fc" id="L473">    synchronized (elements) {</span>
<span class="fc bfc" id="L474" title="All 2 branches covered.">      for (MediaPackageElement e : elements) {</span>
<span class="pc bpc" id="L475" title="1 of 4 branches missed.">        if (e.getIdentifier().equals(catalogId) &amp;&amp; e instanceof Catalog)</span>
<span class="fc" id="L476">          return (Catalog) e;</span>
<span class="fc" id="L477">      }</span>
<span class="fc" id="L478">    }</span>
<span class="fc" id="L479">    return null;</span>
  }

  /**
   * @see org.opencastproject.mediapackage.MediaPackage#getCatalogs()
   */
  @XmlElementWrapper(name = &quot;metadata&quot;)
  @XmlElement(name = &quot;catalog&quot;)
  @Override
  public Catalog[] getCatalogs() {
<span class="fc" id="L489">    Collection&lt;Catalog&gt; catalogs = loadCatalogs();</span>
<span class="fc" id="L490">    return catalogs.toArray(new Catalog[catalogs.size()]);</span>
  }

  void setCatalogs(Catalog[] catalogs) {
<span class="fc" id="L494">    List&lt;Catalog&gt; newCatalogs = Arrays.asList(catalogs);</span>
<span class="fc" id="L495">    List&lt;Catalog&gt; oldCatalogs = Arrays.asList(getCatalogs());</span>
    // remove any catalogs not in this array
<span class="pc bpc" id="L497" title="1 of 2 branches missed.">    for (Catalog existing : oldCatalogs) {</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">      if (!newCatalogs.contains(existing)) {</span>
<span class="nc" id="L499">        remove(existing);</span>
      }
<span class="nc" id="L501">    }</span>
<span class="fc bfc" id="L502" title="All 2 branches covered.">    for (Catalog newCatalog : newCatalogs) {</span>
<span class="pc bpc" id="L503" title="1 of 2 branches missed.">      if (!oldCatalogs.contains(newCatalog)) {</span>
<span class="fc" id="L504">        add(newCatalog);</span>
      }
<span class="fc" id="L506">    }</span>
<span class="fc" id="L507">  }</span>

  /**
   * @see org.opencastproject.mediapackage.MediaPackage#getCatalogs(MediaPackageElementFlavor)
   */
  @Override
  public Catalog[] getCatalogs(MediaPackageElementFlavor flavor) {
<span class="pc bpc" id="L514" title="1 of 2 branches missed.">    if (flavor == null)</span>
<span class="nc" id="L515">      throw new IllegalArgumentException(&quot;Unable to filter by null criterion&quot;);</span>

    // Go through catalogs and remove those that don't match
<span class="fc" id="L518">    Collection&lt;Catalog&gt; catalogs = loadCatalogs();</span>
<span class="fc" id="L519">    List&lt;Catalog&gt; candidates = new ArrayList&lt;&gt;(catalogs);</span>
<span class="fc bfc" id="L520" title="All 2 branches covered.">    for (Catalog c : catalogs) {</span>
<span class="pc bpc" id="L521" title="1 of 4 branches missed.">      if (c.getFlavor() == null || !c.getFlavor().matches(flavor)) {</span>
<span class="fc" id="L522">        candidates.remove(c);</span>
      }
<span class="fc" id="L524">    }</span>
<span class="fc" id="L525">    return candidates.toArray(new Catalog[0]);</span>
  }

  /**
   * @see org.opencastproject.mediapackage.MediaPackage#getCatalogs(org.opencastproject.mediapackage.MediaPackageReference)
   */
  @Override
  public Catalog[] getCatalogs(MediaPackageReference reference) {
<span class="fc" id="L533">    return getCatalogs(reference, false);</span>
  }

  private Catalog[] getCatalogs(MediaPackageReference reference, boolean includeDerived) {
<span class="pc bpc" id="L537" title="1 of 2 branches missed.">    if (reference == null)</span>
<span class="nc" id="L538">      throw new IllegalArgumentException(&quot;Unable to filter by null reference&quot;);</span>

    // Go through catalogs and remove those that don't match
<span class="fc" id="L541">    Collection&lt;Catalog&gt; catalogs = loadCatalogs();</span>
<span class="fc" id="L542">    List&lt;Catalog&gt; candidates = new ArrayList&lt;&gt;(catalogs);</span>
<span class="fc bfc" id="L543" title="All 2 branches covered.">    for (Catalog c : catalogs) {</span>
<span class="fc" id="L544">      MediaPackageReference r = c.getReference();</span>
<span class="fc bfc" id="L545" title="All 2 branches covered.">      if (!reference.matches(r)) {</span>
<span class="fc" id="L546">        boolean indirectHit = false;</span>

        // Create a reference that will match regardless of properties
<span class="fc" id="L549">        MediaPackageReference elementRef = new MediaPackageReferenceImpl(reference.getType(), reference.getIdentifier());</span>

        // Try to find a derived match if possible
<span class="pc bpc" id="L552" title="3 of 4 branches missed.">        while (includeDerived &amp;&amp; r != null) {</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">          if (r.matches(elementRef)) {</span>
<span class="nc" id="L554">            indirectHit = true;</span>
<span class="nc" id="L555">            break;</span>
          }
<span class="nc" id="L557">          r = getElement(r).getReference();</span>
        }

<span class="pc bpc" id="L560" title="1 of 2 branches missed.">        if (!indirectHit)</span>
<span class="fc" id="L561">          candidates.remove(c);</span>
      }
<span class="fc" id="L563">    }</span>

<span class="fc" id="L565">    return candidates.toArray(new Catalog[candidates.size()]);</span>
  }

  /**
   * @see org.opencastproject.mediapackage.MediaPackage#getCatalogs(org.opencastproject.mediapackage.MediaPackageElementFlavor,
   *      org.opencastproject.mediapackage.MediaPackageReference)
   */
  @Override
  public Catalog[] getCatalogs(MediaPackageElementFlavor flavor, MediaPackageReference reference) {
<span class="pc bpc" id="L574" title="1 of 2 branches missed.">    if (flavor == null)</span>
<span class="nc" id="L575">      throw new IllegalArgumentException(&quot;Unable to filter by null criterion&quot;);</span>
<span class="pc bpc" id="L576" title="1 of 2 branches missed.">    if (reference == null)</span>
<span class="nc" id="L577">      throw new IllegalArgumentException(&quot;Unable to filter by null reference&quot;);</span>

    // Go through catalogs and remove those that don't match
<span class="fc" id="L580">    Collection&lt;Catalog&gt; catalogs = loadCatalogs();</span>
<span class="fc" id="L581">    List&lt;Catalog&gt; candidates = new ArrayList&lt;&gt;(catalogs);</span>
<span class="fc bfc" id="L582" title="All 2 branches covered.">    for (Catalog c : catalogs) {</span>
<span class="pc bpc" id="L583" title="4 of 6 branches missed.">      if (!flavor.equals(c.getFlavor()) || (c.getReference() != null &amp;&amp; !c.getReference().matches(reference))) {</span>
<span class="nc" id="L584">        candidates.remove(c);</span>
      }
<span class="fc" id="L586">    }</span>
<span class="fc" id="L587">    return candidates.toArray(new Catalog[candidates.size()]);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getTrack(java.lang.String)
   */
  @Override
  public Track getTrack(String trackId) {
<span class="fc" id="L597">    synchronized (elements) {</span>
<span class="fc bfc" id="L598" title="All 2 branches covered.">      for (MediaPackageElement e : elements) {</span>
<span class="pc bpc" id="L599" title="1 of 4 branches missed.">        if (e.getIdentifier().equals(trackId) &amp;&amp; e instanceof Track)</span>
<span class="fc" id="L600">          return (Track) e;</span>
<span class="fc" id="L601">      }</span>
<span class="fc" id="L602">    }</span>
<span class="fc" id="L603">    return null;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getTracks()
   */
  @XmlElementWrapper(name = &quot;media&quot;)
  @XmlElement(name = &quot;track&quot;)
  @Override
  public Track[] getTracks() {
<span class="fc" id="L615">    Collection&lt;Track&gt; tracks = loadTracks();</span>
<span class="fc" id="L616">    return tracks.toArray(new Track[tracks.size()]);</span>
  }

  void setTracks(Track[] tracks) {
<span class="fc" id="L620">    List&lt;Track&gt; newTracks = Arrays.asList(tracks);</span>
<span class="fc" id="L621">    List&lt;Track&gt; oldTracks = Arrays.asList(getTracks());</span>
    // remove any catalogs not in this array
<span class="pc bpc" id="L623" title="1 of 2 branches missed.">    for (Track existing : oldTracks) {</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">      if (!newTracks.contains(existing)) {</span>
<span class="nc" id="L625">        remove(existing);</span>
      }
<span class="nc" id="L627">    }</span>
<span class="fc bfc" id="L628" title="All 2 branches covered.">    for (Track newTrack : newTracks) {</span>
<span class="pc bpc" id="L629" title="1 of 2 branches missed.">      if (!oldTracks.contains(newTrack)) {</span>
<span class="fc" id="L630">        add(newTrack);</span>
      }
<span class="fc" id="L632">    }</span>
<span class="fc" id="L633">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getTracksByTag(java.lang.String)
   */
  @Override
  public Track[] getTracksByTag(String tag) {
<span class="fc" id="L642">    List&lt;Track&gt; result = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L643">    synchronized (elements) {</span>
<span class="fc bfc" id="L644" title="All 2 branches covered.">      for (MediaPackageElement e : elements) {</span>
<span class="fc bfc" id="L645" title="All 4 branches covered.">        if (e instanceof Track &amp;&amp; e.containsTag(tag))</span>
<span class="fc" id="L646">          result.add((Track) e);</span>
<span class="fc" id="L647">      }</span>
<span class="fc" id="L648">    }</span>
<span class="fc" id="L649">    return result.toArray(new Track[result.size()]);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getTracks(org.opencastproject.mediapackage.MediaPackageElementFlavor)
   */
  @Override
  public Track[] getTracks(MediaPackageElementFlavor flavor) {
<span class="pc bpc" id="L659" title="1 of 2 branches missed.">    if (flavor == null)</span>
<span class="nc" id="L660">      throw new IllegalArgumentException(&quot;Unable to filter by null criterion&quot;);</span>

    // Go through tracks and remove those that don't match
<span class="fc" id="L663">    Collection&lt;Track&gt; tracks = loadTracks();</span>
<span class="fc" id="L664">    List&lt;Track&gt; candidates = new ArrayList&lt;&gt;(tracks);</span>
<span class="fc bfc" id="L665" title="All 2 branches covered.">    for (Track a : tracks) {</span>
<span class="pc bpc" id="L666" title="1 of 4 branches missed.">      if (a.getFlavor() == null || !a.getFlavor().matches(flavor)) {</span>
<span class="fc" id="L667">        candidates.remove(a);</span>
      }
<span class="fc" id="L669">    }</span>
<span class="fc" id="L670">    return candidates.toArray(new Track[candidates.size()]);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#hasTracks()
   */
  @Override
  public boolean hasTracks() {
<span class="fc" id="L680">    synchronized (elements) {</span>
<span class="fc bfc" id="L681" title="All 2 branches covered.">      for (MediaPackageElement e : elements) {</span>
<span class="fc bfc" id="L682" title="All 2 branches covered.">        if (e instanceof Track)</span>
<span class="fc" id="L683">          return true;</span>
<span class="fc" id="L684">      }</span>
<span class="fc" id="L685">    }</span>
<span class="fc" id="L686">    return false;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getUnclassifiedElements()
   */
  @Override
  public MediaPackageElement[] getUnclassifiedElements() {
<span class="nc" id="L696">    return getUnclassifiedElements(null);</span>
  }

  private MediaPackageElement[] getUnclassifiedElements(MediaPackageElementFlavor flavor) {
<span class="nc" id="L700">    List&lt;MediaPackageElement&gt; unclassifieds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L701">    synchronized (elements) {</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">      for (MediaPackageElement e : elements) {</span>
<span class="nc bnc" id="L703" title="All 6 branches missed.">        if (!(e instanceof Attachment) &amp;&amp; !(e instanceof Catalog) &amp;&amp; !(e instanceof Track)) {</span>
<span class="nc bnc" id="L704" title="All 4 branches missed.">          if (flavor == null || flavor.equals(e.getFlavor())) {</span>
<span class="nc" id="L705">            unclassifieds.add(e);</span>
          }
        }
<span class="nc" id="L708">      }</span>
<span class="nc" id="L709">    }</span>
<span class="nc" id="L710">    return unclassifieds.toArray(new MediaPackageElement[unclassifieds.size()]);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getAttachment(java.lang.String)
   */
  @Override
  public Attachment getAttachment(String attachmentId) {
<span class="fc" id="L720">    synchronized (elements) {</span>
<span class="pc bpc" id="L721" title="1 of 2 branches missed.">      for (MediaPackageElement e : elements) {</span>
<span class="pc bpc" id="L722" title="1 of 4 branches missed.">        if (e.getIdentifier().equals(attachmentId) &amp;&amp; e instanceof Attachment)</span>
<span class="fc" id="L723">          return (Attachment) e;</span>
<span class="fc" id="L724">      }</span>
<span class="nc" id="L725">    }</span>
<span class="nc" id="L726">    return null;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getAttachments()
   */
  @XmlElementWrapper(name = &quot;attachments&quot;)
  @XmlElement(name = &quot;attachment&quot;)
  @Override
  public Attachment[] getAttachments() {
<span class="fc" id="L738">    Collection&lt;Attachment&gt; attachments = loadAttachments();</span>
<span class="fc" id="L739">    return attachments.toArray(new Attachment[attachments.size()]);</span>
  }

  void setAttachments(Attachment[] catalogs) {
<span class="fc" id="L743">    List&lt;Attachment&gt; newAttachments = Arrays.asList(catalogs);</span>
<span class="fc" id="L744">    List&lt;Attachment&gt; oldAttachments = Arrays.asList(getAttachments());</span>
    // remove any catalogs not in this array
<span class="pc bpc" id="L746" title="1 of 2 branches missed.">    for (Attachment existing : oldAttachments) {</span>
<span class="nc bnc" id="L747" title="All 2 branches missed.">      if (!newAttachments.contains(existing)) {</span>
<span class="nc" id="L748">        remove(existing);</span>
      }
<span class="nc" id="L750">    }</span>
<span class="fc bfc" id="L751" title="All 2 branches covered.">    for (Attachment newAttachment : newAttachments) {</span>
<span class="pc bpc" id="L752" title="1 of 2 branches missed.">      if (!oldAttachments.contains(newAttachment)) {</span>
<span class="fc" id="L753">        add(newAttachment);</span>
      }
<span class="fc" id="L755">    }</span>
<span class="fc" id="L756">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getAttachments(org.opencastproject.mediapackage.MediaPackageElementFlavor)
   */
  @Override
  public Attachment[] getAttachments(MediaPackageElementFlavor flavor) {
<span class="pc bpc" id="L765" title="1 of 2 branches missed.">    if (flavor == null)</span>
<span class="nc" id="L766">      throw new IllegalArgumentException(&quot;Unable to filter by null criterion&quot;);</span>

    // Go through attachments and remove those that don't match
<span class="fc" id="L769">    Collection&lt;Attachment&gt; attachments = loadAttachments();</span>
<span class="fc" id="L770">    List&lt;Attachment&gt; candidates = new ArrayList&lt;&gt;(attachments);</span>
<span class="fc bfc" id="L771" title="All 2 branches covered.">    for (Attachment a : attachments) {</span>
<span class="pc bpc" id="L772" title="1 of 4 branches missed.">      if (a.getFlavor() == null || !a.getFlavor().matches(flavor)) {</span>
<span class="fc" id="L773">        candidates.remove(a);</span>
      }
<span class="fc" id="L775">    }</span>
<span class="fc" id="L776">    return candidates.toArray(new Attachment[candidates.size()]);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getAttachments()
   */
  @XmlElementWrapper(name = &quot;publications&quot;)
  @XmlElement(name = &quot;publication&quot;)
  @Override
  public Publication[] getPublications() {
<span class="fc" id="L788">    return mlist(elements).bind(presentations).value().toArray(new Publication[0]);</span>
  }

  void setPublications(Publication[] publications) {
<span class="fc" id="L792">    List&lt;Publication&gt; newPublications = Arrays.asList(publications);</span>
<span class="fc" id="L793">    List&lt;Publication&gt; oldPublications = Arrays.asList(getPublications());</span>
<span class="pc bpc" id="L794" title="1 of 2 branches missed.">    for (Publication oldp : oldPublications) {</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">      if (!newPublications.contains(oldp)) {</span>
<span class="nc" id="L796">        remove(oldp);</span>
      }
<span class="nc" id="L798">    }</span>
<span class="fc bfc" id="L799" title="All 2 branches covered.">    for (Publication newp : newPublications) {</span>
<span class="pc bpc" id="L800" title="1 of 2 branches missed.">      if (!oldPublications.contains(newp)) {</span>
<span class="fc" id="L801">        add(newp);</span>
      }
<span class="fc" id="L803">    }</span>
<span class="fc" id="L804">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#removeElementById(java.lang.String)
   */
  @Override
  public MediaPackageElement removeElementById(String id) {
<span class="fc" id="L813">    MediaPackageElement element = getElementById(id);</span>
<span class="pc bpc" id="L814" title="1 of 2 branches missed.">    if (element == null)</span>
<span class="nc" id="L815">      return null;</span>
<span class="fc" id="L816">    remove(element);</span>
<span class="fc" id="L817">    return element;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#remove(org.opencastproject.mediapackage.MediaPackageElement)
   */
  @Override
  public void remove(MediaPackageElement element) {
<span class="fc" id="L827">    removeElement(element);</span>
<span class="fc" id="L828">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#remove(org.opencastproject.mediapackage.Attachment)
   */
  @Override
  public void remove(Attachment attachment) {
<span class="fc" id="L837">    removeElement(attachment);</span>
<span class="fc" id="L838">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#remove(org.opencastproject.mediapackage.Catalog)
   */
  @Override
  public void remove(Catalog catalog) {
<span class="fc" id="L847">    removeElement(catalog);</span>
<span class="fc" id="L848">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#remove(org.opencastproject.mediapackage.Track)
   */
  @Override
  public void remove(Track track) {
<span class="fc" id="L857">    removeElement(track);</span>
<span class="fc" id="L858">    recalculateDuration();</span>
<span class="fc" id="L859">  }</span>

  /**
   * Removes an element from the media package
   *
   * @param element
   *          the media package element
   */
  void removeElement(MediaPackageElement element) {
<span class="fc" id="L868">    removeInternal(element);</span>
<span class="pc bpc" id="L869" title="1 of 2 branches missed.">    if (element instanceof AbstractMediaPackageElement) {</span>
<span class="fc" id="L870">      ((AbstractMediaPackageElement) element).setMediaPackage(null);</span>
    }
<span class="fc" id="L872">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#add(java.net.URI)
   */
  @Override
  public MediaPackageElement add(URI url) {
<span class="pc bpc" id="L881" title="1 of 2 branches missed.">    if (url == null)</span>
<span class="nc" id="L882">      throw new IllegalArgumentException(&quot;Argument 'url' may not be null&quot;);</span>

<span class="fc bfc" id="L884" title="All 2 branches covered.">    if (mediaPackageElementBuilder == null) {</span>
<span class="fc" id="L885">      mediaPackageElementBuilder = MediaPackageElementBuilderFactory.newInstance().newElementBuilder();</span>
    }
<span class="fc" id="L887">    MediaPackageElement element = mediaPackageElementBuilder.elementFromURI(url);</span>
<span class="fc" id="L888">    integrate(element);</span>
<span class="fc" id="L889">    addInternal(element);</span>
<span class="fc" id="L890">    return element;</span>
  }

  /**
   * @see org.opencastproject.mediapackage.MediaPackage#add(URI,
   *      org.opencastproject.mediapackage.MediaPackageElement.Type,
   *      org.opencastproject.mediapackage.MediaPackageElementFlavor)
   */
  @Override
  public MediaPackageElement add(URI uri, Type type, MediaPackageElementFlavor flavor) {
<span class="pc bpc" id="L900" title="1 of 2 branches missed.">    if (uri == null)</span>
<span class="nc" id="L901">      throw new IllegalArgumentException(&quot;Argument 'url' may not be null&quot;);</span>
<span class="pc bpc" id="L902" title="1 of 2 branches missed.">    if (type == null)</span>
<span class="nc" id="L903">      throw new IllegalArgumentException(&quot;Argument 'type' may not be null&quot;);</span>

<span class="fc bfc" id="L905" title="All 2 branches covered.">    if (mediaPackageElementBuilder == null) {</span>
<span class="fc" id="L906">      mediaPackageElementBuilder = MediaPackageElementBuilderFactory.newInstance().newElementBuilder();</span>
    }
<span class="fc" id="L908">    MediaPackageElement element = mediaPackageElementBuilder.elementFromURI(uri, type, flavor);</span>
<span class="fc" id="L909">    integrate(element);</span>
<span class="fc" id="L910">    addInternal(element);</span>
<span class="fc" id="L911">    return element;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#add(org.opencastproject.mediapackage.MediaPackageElement)
   */
  @Override
  public void add(MediaPackageElement element) {
<span class="pc bpc" id="L921" title="1 of 4 branches missed.">    if (element.getElementType().equals(MediaPackageElement.Type.Track) &amp;&amp; element instanceof Track) {</span>
<span class="fc" id="L922">      integrateTrack((Track) element);</span>
<span class="pc bpc" id="L923" title="1 of 4 branches missed.">    } else if (element.getElementType().equals(MediaPackageElement.Type.Catalog) &amp;&amp; element instanceof Catalog) {</span>
<span class="fc" id="L924">      integrateCatalog((Catalog) element);</span>
<span class="pc bpc" id="L925" title="1 of 4 branches missed.">    } else if (element.getElementType().equals(MediaPackageElement.Type.Attachment) &amp;&amp; element instanceof Attachment) {</span>
<span class="fc" id="L926">      integrateAttachment((Attachment) element);</span>
    } else {
<span class="fc" id="L928">      integrate(element);</span>
    }
<span class="fc" id="L930">    addInternal(element);</span>
<span class="fc" id="L931">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#addDerived(org.opencastproject.mediapackage.MediaPackageElement,
   *      org.opencastproject.mediapackage.MediaPackageElement)
   */
  @Override
  public void addDerived(MediaPackageElement derivedElement, MediaPackageElement sourceElement) {
<span class="fc" id="L941">    addDerived(derivedElement, sourceElement, null);</span>
<span class="fc" id="L942">  }</span>

  private void addDerived(
          MediaPackageElement derivedElement, MediaPackageElement sourceElement, Map&lt;String, String&gt; properties) {
<span class="pc bpc" id="L946" title="1 of 2 branches missed.">    if (derivedElement == null)</span>
<span class="nc" id="L947">      throw new IllegalArgumentException(&quot;The derived element is null&quot;);</span>
<span class="pc bpc" id="L948" title="1 of 2 branches missed.">    if (sourceElement == null)</span>
<span class="nc" id="L949">      throw new IllegalArgumentException(&quot;The source element is null&quot;);</span>
<span class="pc bpc" id="L950" title="1 of 2 branches missed.">    if (!contains(sourceElement))</span>
<span class="nc" id="L951">      throw new IllegalStateException(&quot;The sourceElement needs to be part of the media package&quot;);</span>

<span class="fc" id="L953">    derivedElement.referTo(sourceElement);</span>
<span class="fc" id="L954">    addInternal(derivedElement);</span>

<span class="pc bpc" id="L956" title="1 of 2 branches missed.">    if (properties != null) {</span>
<span class="nc" id="L957">      MediaPackageReference ref = derivedElement.getReference();</span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">      for (Map.Entry&lt;String, String&gt; entry : properties.entrySet()) {</span>
<span class="nc" id="L959">        ref.setProperty(entry.getKey(), entry.getValue());</span>
<span class="nc" id="L960">      }</span>
    }
<span class="fc" id="L962">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getDerived(org.opencastproject.mediapackage.MediaPackageElement,
   *      org.opencastproject.mediapackage.MediaPackageElementFlavor)
   */
  @Override
  public MediaPackageElement[] getDerived(MediaPackageElement sourceElement, MediaPackageElementFlavor derivateFlavor) {
<span class="pc bpc" id="L972" title="1 of 2 branches missed.">    if (sourceElement == null)</span>
<span class="nc" id="L973">      throw new IllegalArgumentException(&quot;Source element cannot be null&quot;);</span>
<span class="pc bpc" id="L974" title="1 of 2 branches missed.">    if (derivateFlavor == null)</span>
<span class="nc" id="L975">      throw new IllegalArgumentException(&quot;Derivate flavor cannot be null&quot;);</span>

<span class="fc" id="L977">    MediaPackageReference reference = new MediaPackageReferenceImpl(sourceElement);</span>
<span class="fc" id="L978">    List&lt;MediaPackageElement&gt; elements = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L979" title="All 2 branches covered.">    for (MediaPackageElement element : getElements()) {</span>
<span class="pc bpc" id="L980" title="1 of 4 branches missed.">      if (derivateFlavor.equals(element.getFlavor()) &amp;&amp; reference.equals(element.getReference()))</span>
<span class="fc" id="L981">        elements.add(element);</span>
    }
<span class="fc" id="L983">    return elements.toArray(new MediaPackageElement[elements.size()]);</span>
  }

  /**
   * Integrates the element into the media package. This mainly involves moving the element into the media package file
   * structure.
   *
   * @param element
   *          the element to integrate
   */
  private void integrate(MediaPackageElement element) {
<span class="pc bpc" id="L994" title="1 of 2 branches missed.">    if (element instanceof AbstractMediaPackageElement)</span>
<span class="fc" id="L995">      ((AbstractMediaPackageElement) element).setMediaPackage(this);</span>
<span class="fc" id="L996">  }</span>

  /**
   * Integrates the catalog into the media package. This mainly involves moving the catalog into the media package file
   * structure.
   *
   * @param catalog
   *          the catalog to integrate
   */
  private void integrateCatalog(Catalog catalog) {
    // Check (uniqueness of) catalog identifier
<span class="fc" id="L1007">    String id = catalog.getIdentifier();</span>
<span class="fc bfc" id="L1008" title="All 4 branches covered.">    if (id == null || contains(id)) {</span>
<span class="fc" id="L1009">      catalog.setIdentifier(createElementIdentifier());</span>
    }
<span class="fc" id="L1011">    integrate(catalog);</span>
<span class="fc" id="L1012">  }</span>

  /**
   * Integrates the track into the media package. This mainly involves moving the track into the media package file
   * structure.
   *
   * @param track
   *          the track to integrate
   */
  private void integrateTrack(Track track) {
    // Check (uniqueness of) track identifier
<span class="fc" id="L1023">    String id = track.getIdentifier();</span>
<span class="fc bfc" id="L1024" title="All 4 branches covered.">    if (id == null || contains(id)) {</span>
<span class="fc" id="L1025">      track.setIdentifier(createElementIdentifier());</span>
    }
<span class="fc" id="L1027">    integrate(track);</span>
<span class="fc" id="L1028">  }</span>

  /**
   * Integrates the attachment into the media package. This mainly involves moving the attachment into the media package
   * file structure.
   *
   * @param attachment
   *          the attachment to integrate
   */
  private void integrateAttachment(Attachment attachment) {
    // Check (uniqueness of) attachment identifier
<span class="fc" id="L1039">    String id = attachment.getIdentifier();</span>
<span class="fc bfc" id="L1040" title="All 4 branches covered.">    if (id == null || contains(id)) {</span>
<span class="fc" id="L1041">      attachment.setIdentifier(createElementIdentifier());</span>
    }
<span class="fc" id="L1043">    integrate(attachment);</span>
<span class="fc" id="L1044">  }</span>

  /**
   * Returns a unique media package element identifier.
   *
   * @return the element identifier
   */
  private String createElementIdentifier() {
<span class="fc" id="L1052">    return UUID.randomUUID().toString();</span>
  }

  /**
   * @see org.opencastproject.mediapackage.MediaPackage#verify()
   */
  @Override
  public void verify() throws MediaPackageException {
<span class="fc bfc" id="L1060" title="All 2 branches covered.">    for (MediaPackageElement e : getElements()) {</span>
<span class="fc" id="L1061">      e.verify();</span>
    }
<span class="fc" id="L1063">  }</span>

  /* NOTE: DO NOT REMOVE THIS METHOD IT WILL BREAK THINGS,
    * SEE https://github.com/opencast/opencast/issues/1860 for an example
    */
  /**
   * Unmarshals XML representation of a MediaPackage via JAXB.
   *
   * @param xml
   *          the serialized xml string
   * @return the deserialized media package
   * @throws MediaPackageException
   */
  public static MediaPackageImpl valueOf(String xml) throws MediaPackageException {
<span class="nc" id="L1077">    return MediaPackageImpl.valueOf(IOUtils.toInputStream(xml, &quot;UTF-8&quot;));</span>
  }


  /**
   * @see java.lang.Object#hashCode()
   */
  @Override
  public int hashCode() {
<span class="fc" id="L1086">    return getIdentifier().hashCode();</span>
  }

  /**
   * @see java.lang.Object#equals(java.lang.Object)
   */
  @Override
  public boolean equals(Object obj) {
<span class="pc bpc" id="L1094" title="1 of 2 branches missed.">    if (obj instanceof MediaPackage) {</span>
<span class="fc" id="L1095">      return getIdentifier().equals(((MediaPackage) obj).getIdentifier());</span>
    }
<span class="nc" id="L1097">    return false;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see java.lang.Object#clone()
   */
  @Override
  public Object clone() {
    try {
<span class="fc" id="L1108">      String xml = MediaPackageParser.getAsXml(this);</span>
<span class="fc" id="L1109">      return MediaPackageBuilderFactory.newInstance().newMediaPackageBuilder().loadFromXml(xml);</span>
<span class="nc" id="L1110">    } catch (Exception e) {</span>
<span class="nc" id="L1111">      throw new RuntimeException(e);</span>
    }
  }

  /**
   * @see java.lang.Object#toString()
   */
  @Override
  public String toString() {
<span class="pc bpc" id="L1120" title="1 of 2 branches missed.">    if (identifier != null)</span>
<span class="fc" id="L1121">      return identifier.toString();</span>
    else
<span class="nc" id="L1123">      return &quot;Unknown media package&quot;;</span>
  }

  /**
   * A JAXB adapter that allows the {@link MediaPackage} interface to be un/marshalled
   */
<span class="fc" id="L1129">  public static class Adapter extends XmlAdapter&lt;MediaPackageImpl, MediaPackage&gt; {</span>
    @Override
    public MediaPackageImpl marshal(MediaPackage mp) throws Exception {
<span class="fc" id="L1132">      return (MediaPackageImpl) mp;</span>
    }

    @Override
    public MediaPackage unmarshal(MediaPackageImpl mp) throws Exception {
<span class="fc" id="L1137">      return mp;</span>
    }
  }

  /**
   * Reads the media package from the input stream.
   *
   * @param xml
   *          the input stream
   * @return the deserialized media package
   */
  public static MediaPackageImpl valueOf(InputStream xml) throws MediaPackageException {
    try {
<span class="nc" id="L1150">      Unmarshaller unmarshaller = context.createUnmarshaller();</span>
<span class="nc" id="L1151">      return unmarshaller.unmarshal(XmlSafeParser.parse(xml), MediaPackageImpl.class).getValue();</span>
<span class="nc" id="L1152">    } catch (JAXBException e) {</span>
<span class="nc bnc" id="L1153" title="All 2 branches missed.">      throw new MediaPackageException(e.getLinkedException() != null ? e.getLinkedException() : e);</span>
<span class="nc" id="L1154">    } catch (IOException | SAXException e) {</span>
<span class="nc" id="L1155">      throw new MediaPackageException(e);</span>
    } finally {
<span class="nc" id="L1157">      IoSupport.closeQuietly(xml);</span>
    }
  }

  /**
   * Reads the media package from an xml node.
   *
   * @param xml
   *          the node
   * @return the deserialized media package
   */
  public static MediaPackageImpl valueOf(Node xml) throws MediaPackageException {
<span class="fc" id="L1169">    try (ByteArrayOutputStream out = new ByteArrayOutputStream()) {</span>
<span class="fc" id="L1170">      Unmarshaller unmarshaller = context.createUnmarshaller();</span>
      // Serialize the media package
<span class="fc" id="L1172">      DOMImplementationRegistry reg = DOMImplementationRegistry.newInstance();</span>
<span class="fc" id="L1173">      DOMImplementationLS impl = (DOMImplementationLS) reg.getDOMImplementation(&quot;LS&quot;);</span>
<span class="fc" id="L1174">      LSSerializer serializer = impl.createLSSerializer();</span>
<span class="fc" id="L1175">      serializer.getDomConfig().setParameter(&quot;comments&quot;, false);</span>
<span class="fc" id="L1176">      serializer.getDomConfig().setParameter(&quot;format-pretty-print&quot;, false);</span>
<span class="fc" id="L1177">      LSOutput output = impl.createLSOutput();</span>
<span class="fc" id="L1178">      output.setEncoding(&quot;UTF-8&quot;);</span>
<span class="fc" id="L1179">      output.setByteStream(out);</span>
      // This is safe because the Node was already parsed
<span class="fc" id="L1181">      serializer.write(xml, output);</span>

<span class="fc" id="L1183">      try (InputStream in = new ByteArrayInputStream(out.toByteArray())) {</span>
        // CHECKSTYLE:OFF
        // in was already parsed, therefore this is save
<span class="fc" id="L1186">        return unmarshaller.unmarshal(new StreamSource(in), MediaPackageImpl.class).getValue();</span>
        // CHECKSTYLE:ON
      }
<span class="nc" id="L1189">    } catch (Exception e) {</span>
<span class="nc" id="L1190">      throw new MediaPackageException(&quot;Error deserializing media package node&quot;, e);</span>
    }
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getContributors()
   */
  @Override
  public String[] getContributors() {
<span class="fc bfc" id="L1201" title="All 2 branches covered.">    if (contributors == null)</span>
<span class="fc" id="L1202">      return new String[] {};</span>
<span class="fc" id="L1203">    return contributors.toArray(new String[contributors.size()]);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getCreators()
   */
  @Override
  public String[] getCreators() {
<span class="fc bfc" id="L1213" title="All 2 branches covered.">    if (creators == null)</span>
<span class="fc" id="L1214">      return new String[] {};</span>
<span class="fc" id="L1215">    return creators.toArray(new String[creators.size()]);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getLanguage()
   */
  @Override
  public String getLanguage() {
<span class="fc" id="L1225">    return language;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getLicense()
   */
  @Override
  public String getLicense() {
<span class="fc" id="L1235">    return license;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getSeries()
   */
  @Override
  public String getSeries() {
<span class="fc" id="L1245">    return series;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getSubjects()
   */
  @Override
  public String[] getSubjects() {
<span class="fc bfc" id="L1255" title="All 2 branches covered.">    if (subjects == null)</span>
<span class="fc" id="L1256">      return new String[] {};</span>
<span class="fc" id="L1257">    return subjects.toArray(new String[subjects.size()]);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getTitle()
   */
  @Override
  public String getTitle() {
<span class="fc" id="L1267">    return title;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#getSeriesTitle()
   */
  @Override
  public String getSeriesTitle() {
<span class="fc" id="L1277">    return seriesTitle;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#setSeriesTitle(java.lang.String)
   */
  @Override
  public void setSeriesTitle(String seriesTitle) {
<span class="fc" id="L1287">    this.seriesTitle = seriesTitle;</span>
<span class="fc" id="L1288">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#addContributor(java.lang.String)
   */
  @Override
  public void addContributor(String contributor) {
<span class="fc bfc" id="L1297" title="All 2 branches covered.">    if (contributors == null)</span>
<span class="fc" id="L1298">      contributors = new TreeSet&lt;String&gt;();</span>
<span class="fc" id="L1299">    contributors.add(contributor);</span>
<span class="fc" id="L1300">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#addCreator(java.lang.String)
   */
  @Override
  public void addCreator(String creator) {
<span class="fc bfc" id="L1309" title="All 2 branches covered.">    if (creators == null)</span>
<span class="fc" id="L1310">      creators = new TreeSet&lt;&gt;();</span>
<span class="fc" id="L1311">    creators.add(creator);</span>
<span class="fc" id="L1312">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#addSubject(java.lang.String)
   */
  @Override
  public void addSubject(String subject) {
<span class="fc bfc" id="L1321" title="All 2 branches covered.">    if (subjects == null)</span>
<span class="fc" id="L1322">      subjects = new TreeSet&lt;&gt;();</span>
<span class="fc" id="L1323">    subjects.add(subject);</span>
<span class="fc" id="L1324">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#removeContributor(java.lang.String)
   */
  @Override
  public void removeContributor(String contributor) {
<span class="pc bpc" id="L1333" title="1 of 2 branches missed.">    if (contributors != null)</span>
<span class="fc" id="L1334">      contributors.remove(contributor);</span>
<span class="fc" id="L1335">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#removeCreator(java.lang.String)
   */
  @Override
  public void removeCreator(String creator) {
<span class="pc bpc" id="L1344" title="1 of 2 branches missed.">    if (creators != null)</span>
<span class="fc" id="L1345">      creators.remove(creator);</span>
<span class="fc" id="L1346">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#removeSubject(java.lang.String)
   */
  @Override
  public void removeSubject(String subject) {
<span class="pc bpc" id="L1355" title="1 of 2 branches missed.">    if (subjects != null)</span>
<span class="fc" id="L1356">      subjects.remove(subject);</span>
<span class="fc" id="L1357">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#setDate(java.util.Date)
   */
  @Override
  public void setDate(Date date) {
<span class="pc bpc" id="L1366" title="1 of 2 branches missed.">    if (date != null)</span>
<span class="fc" id="L1367">      this.startTime = date.getTime();</span>
    else
<span class="nc" id="L1369">      this.startTime = 0;</span>
<span class="fc" id="L1370">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#setLanguage(java.lang.String)
   */
  @Override
  public void setLanguage(String language) {
<span class="fc" id="L1379">    this.language = language;</span>
<span class="fc" id="L1380">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#setLicense(java.lang.String)
   */
  @Override
  public void setLicense(String license) {
<span class="fc" id="L1389">    this.license = license;</span>
<span class="fc" id="L1390">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#setSeries(java.lang.String)
   */
  @Override
  public void setSeries(String identifier) {
<span class="fc" id="L1399">    this.series = identifier;</span>
<span class="fc" id="L1400">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.mediapackage.MediaPackage#setTitle(java.lang.String)
   */
  @Override
  public void setTitle(String title) {
<span class="fc" id="L1409">    this.title = title;</span>
<span class="fc" id="L1410">  }</span>

  @Override
  public boolean isLive() {
<span class="fc" id="L1414">    return Arrays.stream(getTracks()).anyMatch(Track::isLive);</span>
  }

  /**
   * Returns the media package element that matches the given reference.
   *
   * @param reference
   *          the reference
   * @return the element
   */
  MediaPackageElement getElement(MediaPackageReference reference) {
<span class="nc bnc" id="L1425" title="All 2 branches missed.">    if (reference == null)</span>
<span class="nc" id="L1426">      return null;</span>
<span class="nc bnc" id="L1427" title="All 2 branches missed.">    for (MediaPackageElement e : elements) {</span>
<span class="nc bnc" id="L1428" title="All 2 branches missed.">      if (e.getIdentifier().equals(reference.getIdentifier()))</span>
<span class="nc" id="L1429">        return e;</span>
<span class="nc" id="L1430">    }</span>
<span class="nc" id="L1431">    return null;</span>
  }

  /**
   * Registers a new media package element with this manifest.
   *
   * @param element
   *          the new element
   */
  private void addInternal(MediaPackageElement element) {
<span class="pc bpc" id="L1441" title="1 of 2 branches missed.">    if (element == null)</span>
<span class="nc" id="L1442">      throw new IllegalArgumentException(&quot;Media package element must not be null&quot;);</span>

<span class="fc" id="L1444">    elements.add(element);</span>
<span class="fc bfc" id="L1445" title="All 2 branches covered.">    if (element instanceof Track) {</span>
<span class="fc" id="L1446">      recalculateDuration();</span>
    }

    // Check if element has an id
<span class="fc bfc" id="L1450" title="All 2 branches covered.">    if (element.getIdentifier() == null) {</span>
<span class="pc bpc" id="L1451" title="1 of 2 branches missed.">      if (element instanceof AbstractMediaPackageElement) {</span>
<span class="fc" id="L1452">        element.setIdentifier(createElementIdentifier());</span>
      } else
<span class="nc" id="L1454">        throw new UnsupportedElementException(element, &quot;Found unknown element without id&quot;);</span>
    }
<span class="fc" id="L1456">  }</span>

  /**
   * Removes the media package element from the manifest.
   *
   * @param element
   *          the element to remove
   */
  void removeInternal(MediaPackageElement element) {
<span class="pc bpc" id="L1465" title="1 of 2 branches missed.">    if (element == null)</span>
<span class="nc" id="L1466">      throw new IllegalArgumentException(&quot;Media package element must not be null&quot;);</span>

<span class="pc bpc" id="L1468" title="1 of 4 branches missed.">    if (elements.remove(element) &amp;&amp; element instanceof Track) {</span>
<span class="fc" id="L1469">      recalculateDuration();</span>
    }
<span class="fc" id="L1471">  }</span>

  /**
   * Extracts the list of tracks from the media package.
   *
   * @return the tracks
   */
  private Collection&lt;Track&gt; loadTracks() {
<span class="fc" id="L1479">    List&lt;Track&gt; tracks = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1480">    synchronized (elements) {</span>
<span class="fc bfc" id="L1481" title="All 2 branches covered.">      for (MediaPackageElement e : elements) {</span>
<span class="fc bfc" id="L1482" title="All 2 branches covered.">        if (e instanceof Track) {</span>
<span class="fc" id="L1483">          tracks.add((Track) e);</span>
        }
<span class="fc" id="L1485">      }</span>
<span class="fc" id="L1486">    }</span>
<span class="fc" id="L1487">    return tracks;</span>
  }

  /**
   * Extracts the list of catalogs from the media package.
   *
   * @return the catalogs
   */
  private Collection&lt;Catalog&gt; loadCatalogs() {
<span class="fc" id="L1496">    List&lt;Catalog&gt; catalogs = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1497">    synchronized (elements) {</span>
<span class="fc bfc" id="L1498" title="All 2 branches covered.">      for (MediaPackageElement e : elements) {</span>
<span class="fc bfc" id="L1499" title="All 2 branches covered.">        if (e instanceof Catalog) {</span>
<span class="fc" id="L1500">          catalogs.add((Catalog) e);</span>
        }
<span class="fc" id="L1502">      }</span>
<span class="fc" id="L1503">    }</span>
<span class="fc" id="L1504">    return catalogs;</span>
  }

  /**
   * Extracts the list of attachments from the media package.
   *
   * @return the attachments
   */
  private Collection&lt;Attachment&gt; loadAttachments() {
<span class="fc" id="L1513">    List&lt;Attachment&gt; attachments = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1514">    synchronized (elements) {</span>
<span class="fc bfc" id="L1515" title="All 2 branches covered.">      for (MediaPackageElement e : elements) {</span>
<span class="fc bfc" id="L1516" title="All 2 branches covered.">        if (e instanceof Attachment) {</span>
<span class="fc" id="L1517">          attachments.add((Attachment) e);</span>
        }
<span class="fc" id="L1519">      }</span>
<span class="fc" id="L1520">    }</span>
<span class="fc" id="L1521">    return attachments;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>