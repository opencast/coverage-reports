<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>DocUtil.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-common</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.util.doc</a> &gt; <span class="el_source">DocUtil.java</span></div><h1>DocUtil.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.util.doc;

import org.apache.commons.io.IOUtils;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.io.InputStream;
import java.io.StringReader;
import java.io.StringWriter;
import java.io.Writer;
import java.util.Map;

import freemarker.core.ParseException;
import freemarker.template.Configuration;
import freemarker.template.DefaultObjectWrapper;
import freemarker.template.Template;
import freemarker.template.TemplateException;

/**
 * This provides methods for handling documentation generation The is mainly for generating REST documentation but it
 * could be used for other things as well
 *
 * @see DocData
 */
public final class DocUtil {

<span class="fc" id="L50">  private static final Logger logger = LoggerFactory.getLogger(DocUtil.class);</span>

  private static Configuration freemarkerConfig; // reusable template processor

  static {
    // initialize the freemarker template engine
<span class="fc" id="L56">    reset();</span>
<span class="fc" id="L57">  }</span>

  /** Disable construction of this utility class */
  private DocUtil() {
  }

  public static void reset() {
<span class="fc" id="L64">    freemarkerConfig = null;</span>
    // static initializer
<span class="fc" id="L66">    freemarkerConfig = new Configuration();</span>
<span class="fc" id="L67">    freemarkerConfig.setObjectWrapper(new DefaultObjectWrapper());</span>
<span class="fc" id="L68">    freemarkerConfig.clearTemplateCache();</span>
<span class="fc" id="L69">    logger.debug(&quot;Created new freemarker template processor for DocUtils&quot;);</span>
<span class="fc" id="L70">  }</span>

  /**
   * Handles the replacement of the variable strings within textual templates and also allows the setting of variables
   * for the control of logical branching within the text template as well&lt;br&gt;
   * Uses and expects freemarker (http://freemarker.org/) style templates (that is using ${name} as the marker for a
   * replacement)&lt;br&gt;
   * NOTE: These should be compatible with Velocity (http://velocity.apache.org/) templates if you use the formal
   * notation (formal: ${variable}, shorthand: $variable)
   *
   * @param templateName
   *          this is the key to cache the template under
   * @param textTemplate
   *          a freemarker/velocity style text template, cannot be null or empty string
   * @param data
   *          a set of replacement values which are in the map like so:&lt;br&gt;
   *          key =&amp;gt; value (String =&amp;gt; Object)&lt;br&gt;
   *          &quot;username&quot; =&amp;gt; &quot;aaronz&quot;&lt;br&gt;
   * @return the processed template
   */
  public static String processTextTemplate(String templateName, String textTemplate, Map&lt;String, Object&gt; data) {
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">    if (freemarkerConfig == null) {</span>
<span class="nc" id="L92">      throw new IllegalStateException(&quot;freemarkerConfig is not initialized&quot;);</span>
    }
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">    if (StringUtils.isEmpty(templateName)) {</span>
<span class="nc" id="L95">      throw new IllegalArgumentException(&quot;The templateName cannot be null or empty string, &quot;</span>
              + &quot;please specify a key name to use when processing this template (can be anything moderately unique)&quot;);
    }
<span class="pc bpc" id="L98" title="2 of 4 branches missed.">    if (data == null || data.size() == 0) {</span>
<span class="nc" id="L99">      return textTemplate;</span>
    }
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">    if (StringUtils.isEmpty(textTemplate)) {</span>
<span class="nc" id="L102">      throw new IllegalArgumentException(&quot;The textTemplate cannot be null or empty string, &quot;</span>
              + &quot;please pass in at least something in the template or do not call this method&quot;);
    }

    // get the template
    Template template;
    try {
<span class="fc" id="L109">      template = new Template(templateName, new StringReader(textTemplate), freemarkerConfig);</span>
<span class="fc" id="L110">    } catch (ParseException e) {</span>
<span class="fc" id="L111">      String msg = &quot;Failure while parsing the Doc template (&quot; + templateName + &quot;), template is invalid: &quot; + e</span>
              + &quot; :: template=&quot; + textTemplate;
<span class="fc" id="L113">      logger.error(msg);</span>
<span class="fc" id="L114">      throw new RuntimeException(msg, e);</span>
<span class="nc" id="L115">    } catch (IOException e) {</span>
<span class="nc" id="L116">      throw new RuntimeException(&quot;Failure while creating freemarker template&quot;, e);</span>
<span class="fc" id="L117">    }</span>

    // process the template
    String result;
    try {
<span class="fc" id="L122">      Writer output = new StringWriter();</span>
<span class="fc" id="L123">      template.process(data, output);</span>
<span class="fc" id="L124">      result = output.toString();</span>
<span class="fc" id="L125">      logger.debug(&quot;Generated complete document ({} chars) from template ({})&quot;, result.length(), templateName);</span>
<span class="nc" id="L126">    } catch (TemplateException e) {</span>
<span class="nc" id="L127">      logger.error(&quot;Failed while processing the Doc template ({})&quot;, templateName, e);</span>
<span class="nc" id="L128">      result = &quot;ERROR:: Failed while processing the template (&quot; + templateName + &quot;): &quot; + e + &quot;\n Template: &quot;</span>
              + textTemplate + &quot;\n Data: &quot; + data;
<span class="nc" id="L130">    } catch (IOException e) {</span>
<span class="nc" id="L131">      throw new RuntimeException(&quot;Failure while sending freemarker output to stream&quot;, e);</span>
<span class="pc" id="L132">    }</span>

<span class="fc" id="L134">    return result;</span>
  }

  /**
   * Use this method to generate the documentation using passed in document data, allows the user to specify the
   * template that is used
   *
   * @param data
   *          any populated DocData object
   * @param template
   *          any freemarker template which works with the DocData data structure
   * @return the documentation (e.g. REST html) as a string
   * @throws IllegalArgumentException
   *           if the input data is invalid in some way
   * @see DocData
   */
  public static String generate(DocData data, String template) {
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">    if (template == null) {</span>
<span class="nc" id="L152">      throw new IllegalArgumentException(&quot;template must be set&quot;);</span>
    }
<span class="fc" id="L154">    return processTextTemplate(data.getMetaData(&quot;name&quot;), template, data.toMap());</span>
  }

  /**
   * Loads a template based on the given path
   *
   * @param path
   *          the path to load the template from (uses the current classloader)
   * @return the template as a string
   */
  public static String loadTemplate(String path) {
    String textTemplate;
<span class="nc" id="L166">    InputStream in = null;</span>
    try {
<span class="nc" id="L168">      in = DocUtil.class.getResourceAsStream(path);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">      if (in == null) {</span>
<span class="nc" id="L170">        throw new NullPointerException(&quot;No template file could be found at: &quot; + path);</span>
      }
<span class="nc" id="L172">      textTemplate = new String(IOUtils.toByteArray(in));</span>
<span class="nc" id="L173">    } catch (Exception e) {</span>
<span class="nc" id="L174">      logger.error(&quot;failed to load template file from path (&quot; + path + &quot;): &quot; + e, e);</span>
<span class="nc" id="L175">      textTemplate = null;</span>
    } finally {
<span class="nc" id="L177">      IOUtils.closeQuietly(in);</span>
    }
<span class="nc" id="L179">    return textTemplate;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>