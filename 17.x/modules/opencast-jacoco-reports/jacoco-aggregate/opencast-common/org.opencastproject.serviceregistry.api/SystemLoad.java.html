<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SystemLoad.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-common</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.serviceregistry.api</a> &gt; <span class="el_source">SystemLoad.java</span></div><h1>SystemLoad.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.serviceregistry.api;

import org.opencastproject.util.NotFoundException;

import java.util.Collection;
import java.util.LinkedHashMap;
import java.util.Map;

import javax.xml.bind.annotation.XmlAccessType;
import javax.xml.bind.annotation.XmlAccessorType;
import javax.xml.bind.annotation.XmlAttribute;
import javax.xml.bind.annotation.XmlElement;
import javax.xml.bind.annotation.XmlElementWrapper;
import javax.xml.bind.annotation.XmlRootElement;
import javax.xml.bind.annotation.XmlType;

/**
 * Mappings between the registered hosts and their load factors.
 */
@XmlType(name = &quot;load&quot;, namespace = &quot;http://serviceregistry.opencastproject.org&quot;)
@XmlRootElement(name = &quot;load&quot;, namespace = &quot;http://serviceregistry.opencastproject.org&quot;)
@XmlAccessorType(XmlAccessType.NONE)
public class SystemLoad {

  /** No-arg constructor needed by JAXB */
<span class="fc" id="L47">  public SystemLoad() {</span>
<span class="fc" id="L48">    nodeLoads = new LinkedHashMap&lt;String, NodeLoad&gt;();</span>
<span class="fc" id="L49">  }</span>

  /** The list of nodes and their current load */
  protected Map&lt;String, NodeLoad&gt; nodeLoads;

  /**
   * Get the list of nodes and their current loadfactor.
   *
   * @return the nodeLoads
   */
  @XmlElementWrapper(name = &quot;nodes&quot;)
  @XmlElement(name = &quot;node&quot;)
  public Collection&lt;NodeLoad&gt; getNodeLoads() {
<span class="fc" id="L62">    return nodeLoads.values();</span>
  }

  /**
   * Sets the list of nodes and their current loadfactor.
   *
   * @param newLoads
   *          the nodeLoads to set
   */
  public void setNodeLoads(Collection&lt;NodeLoad&gt; newLoads) {
<span class="nc bnc" id="L72" title="All 2 branches missed.">    for (NodeLoad node : newLoads) {</span>
<span class="nc" id="L73">      nodeLoads.put(node.getHost(), node);</span>
<span class="nc" id="L74">    }</span>
<span class="nc" id="L75">  }</span>

  /**
   * Updates the load factor for a node
   * @param host
   *   The host to update
   * @param modifier
   *   The modifier to apply to the load
   */
  public void updateNodeLoad(String host, float modifier) throws NotFoundException {
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">    if (!nodeLoads.containsKey(host)) {</span>
<span class="nc" id="L86">      throw new NotFoundException(&quot;Host &quot; + host + &quot; not in this load object&quot;);</span>
    }
<span class="fc" id="L88">    nodeLoads.get(host).modifyLoad(modifier);</span>
<span class="fc" id="L89">  }</span>

  /**
   * Adds a node to the map of load values, overwriting an existing entry if the node is already present in the map
   * @param load
   *          the nodeLoad to add
   */
  public void addNodeLoad(NodeLoad load) {
<span class="fc" id="L97">    nodeLoads.put(load.getHost(), load);</span>
<span class="fc" id="L98">  }</span>

  /**
   * Gets a specific host from the map, if present.  If the node is not present, or the host value is null, this method returns null.
   * @param host
   *        The hostname of the host you are interested in.
   * @return
   *        The specific host from the map, if present.  If the node is not present, or the host value is null, this method returns null.
   */
  public NodeLoad get(String host) {
<span class="pc bpc" id="L108" title="2 of 4 branches missed.">    if (host != null &amp;&amp; this.containsHost(host))</span>
<span class="fc" id="L109">      return nodeLoads.get(host);</span>
<span class="nc" id="L110">    return null;</span>
  }

  /**
   * Returns true if the load map contains the host in question.
   * @param host
   *          The hostname of the host you are interested in.
   * @return
   *          True if the host is present, false if the host is not, or the host variable is null.
   */
  public boolean containsHost(String host) {
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">    if (host != null)</span>
<span class="fc" id="L122">      return nodeLoads.containsKey(host);</span>
<span class="nc" id="L123">    return false;</span>
  }

  @Override
  public String toString() {
<span class="nc" id="L128">    StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L129">    sb.append(&quot;Current Loads:\n&quot;);</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">    for (NodeLoad n : getNodeLoads()) {</span>
<span class="nc" id="L131">      sb.append(String.format(&quot;  %s: %f / %f\n&quot;, n.getHost(), n.getCurrentLoad(), n.getMaxLoad()));</span>
<span class="nc" id="L132">    }</span>
<span class="nc" id="L133">    return sb.toString();</span>
  }


  /** A record of a node in the cluster and its load factor */
  @XmlType(name = &quot;nodetype&quot;, namespace = &quot;http://serviceregistry.opencastproject.org&quot;)
  @XmlRootElement(name = &quot;nodetype&quot;, namespace = &quot;http://serviceregistry.opencastproject.org&quot;)
  @XmlAccessorType(XmlAccessType.NONE)
  public static class NodeLoad implements Comparable&lt;NodeLoad&gt; {

    /** No-arg constructor needed by JAXB */
<span class="fc" id="L144">    public NodeLoad() {</span>
<span class="fc" id="L145">    }</span>

<span class="fc" id="L147">    public NodeLoad(String host, float currentload, float maxload) {</span>
<span class="fc" id="L148">      this.host = host;</span>
<span class="fc" id="L149">      this.currentLoad = currentload;</span>
<span class="fc" id="L150">      this.maxLoad = maxload;</span>
<span class="fc" id="L151">    }</span>

    /** This node's base URL */
    @XmlAttribute
    protected String host;

    /** This node's current load */
    @XmlAttribute
    protected float currentLoad;

    @XmlAttribute
    protected float maxLoad;

    /**
     * @return the host
     */
    public String getHost() {
<span class="fc" id="L168">      return host;</span>
    }

    /**
     * @param host
     *          the host to set
     */
    public void setHost(String host) {
<span class="fc" id="L176">      this.host = host;</span>
<span class="fc" id="L177">    }</span>

    /**
     * @return the load factor, current / maxload
     */
    public float getLoadFactor() {
<span class="fc" id="L183">      return currentLoad / maxLoad;</span>
    }

    /**
     * Modifies the load for this node
     * @param modifier
     *              the amount to add or subtract from the current load
     */
    public void modifyLoad(float modifier) {
<span class="fc" id="L192">      this.currentLoad = this.currentLoad + modifier;</span>
<span class="fc" id="L193">    }</span>

    public float getCurrentLoad() {
<span class="fc" id="L196">      return currentLoad;</span>
    }

    public void setCurrentLoad(float load) {
<span class="fc" id="L200">      this.currentLoad = load;</span>
<span class="fc" id="L201">    }</span>

    public float getMaxLoad() {
<span class="fc" id="L204">      return maxLoad;</span>
    }

    public void setMaxLoad(float load) {
<span class="fc" id="L208">      this.maxLoad = load;</span>
<span class="fc" id="L209">    }</span>


    @Override
    public int compareTo(NodeLoad other) {
<span class="nc bnc" id="L214" title="All 2 branches missed.">      if (other.getLoadFactor() &gt; this.getLoadFactor()) {</span>
<span class="nc" id="L215">        return 1;</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">      } else if (this.getLoadFactor() &gt; other.getLoadFactor()) {</span>
<span class="nc" id="L217">        return -1;</span>
      } else {
<span class="nc" id="L219">        return 0;</span>
      }
    }

    public boolean exceeds(NodeLoad other) {
<span class="nc bnc" id="L224" title="All 2 branches missed.">      if (this.compareTo(other) &gt; 1) {</span>
<span class="nc" id="L225">        return true;</span>
      }
<span class="nc" id="L227">      return false;</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>