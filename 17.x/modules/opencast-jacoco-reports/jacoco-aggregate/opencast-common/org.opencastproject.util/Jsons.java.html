<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>Jsons.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-common</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.util</a> &gt; <span class="el_source">Jsons.java</span></div><h1>Jsons.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.util;

import static org.opencastproject.util.data.Monadics.mlist;

import org.opencastproject.util.data.Collections;
import org.opencastproject.util.data.Function;
import org.opencastproject.util.data.Function2;
import org.opencastproject.util.data.Monadics;
import org.opencastproject.util.data.Option;
import org.opencastproject.util.data.Prelude;

import org.json.simple.JSONArray;
import org.json.simple.JSONObject;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;

/** JSON builder based on json-simple. */
public final class Jsons {
  private Jsons() {
  }

  /** Check if a value is not {@link #ZERO_VAL}. */
<span class="fc" id="L46">  public static final Function&lt;Val, Boolean&gt; notZero = new Function&lt;Val, Boolean&gt;() {</span>
    @Override public Boolean apply(Val val) {
<span class="fc bfc" id="L48" title="All 2 branches covered.">      return !ZERO_VAL.equals(val);</span>
    }
  };

  /** Get the value from a property. */
<span class="fc" id="L53">  public static final Function&lt;Prop, Val&gt; getVal = new Function&lt;Prop, Val&gt;() {</span>
    @Override public Val apply(Prop prop) {
<span class="fc" id="L55">      return prop.getVal();</span>
    }
  };

  /** JSON null. */
<span class="fc" id="L60">  public static final Val NULL = new Val() {</span>
  };

  /** Identity for {@link Val values}. */
<span class="fc" id="L64">  public static final Val ZERO_VAL = new Val() {</span>
  };

  /** Identity for {@link Obj objects}. */
<span class="fc" id="L68">  public static final Obj ZERO_OBJ = obj();</span>

  /** Identity for {@link Arr arrays}. */
<span class="fc" id="L71">  public static final Arr ZERO_ARR = arr();</span>

  public static final class Prop {
    private final String name;
    private final Val val;

<span class="fc" id="L77">    private Prop(String name, Val val) {</span>
<span class="fc" id="L78">      this.name = name;</span>
<span class="fc" id="L79">      this.val = val;</span>
<span class="fc" id="L80">    }</span>

    public String getName() {
<span class="fc" id="L83">      return name;</span>
    }

    public Val getVal() {
<span class="fc" id="L87">      return val;</span>
    }
  }

  // sum type
<span class="fc" id="L92">  public abstract static class Val {</span>
  }

  private static final class SVal extends Val {
    private final Object val;

<span class="fc" id="L98">    private SVal(Object val) {</span>
<span class="fc" id="L99">      this.val = val;</span>
<span class="fc" id="L100">    }</span>

    public Object getVal() {
<span class="fc" id="L103">      return val;</span>
    }
  }

  public static final class Obj extends Val {
    private final List&lt;Prop&gt; props;

<span class="fc" id="L110">    private Obj(List&lt;Prop&gt; props) {</span>
<span class="fc" id="L111">      this.props = props;</span>
<span class="fc" id="L112">    }</span>

    public List&lt;Prop&gt; getProps() {
<span class="fc" id="L115">      return props;</span>
    }

    public Obj append(Obj o) {
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">      if (!ZERO_OBJ.equals(o))</span>
<span class="fc" id="L120">        return new Obj(Collections.&lt;Prop, List&gt;concat(props, o.getProps()));</span>
      else
<span class="nc" id="L122">        return o;</span>
    }

    public String toJson() {
<span class="fc" id="L126">      return Jsons.toJson(this);</span>
    }
  }

  public static final class Arr extends Val {
    private final List&lt;Val&gt; vals;

<span class="fc" id="L133">    public Arr(List&lt;Val&gt; vals) {</span>
<span class="fc" id="L134">      this.vals = vals;</span>
<span class="fc" id="L135">    }</span>

    public List&lt;Val&gt; getVals() {
<span class="fc" id="L138">      return vals;</span>
    }

    public String toJson() {
<span class="fc" id="L142">      return Jsons.toJson(this);</span>
    }
  }

  //

  public static String toJson(Obj obj) {
<span class="fc" id="L149">    return toJsonSimple(obj).toString();</span>
  }

  public static String toJson(Arr arr) {
<span class="fc" id="L153">    return toJsonSimple(arr).toString();</span>
  }

  private static JSONObject toJsonSimple(Obj obj) {
<span class="fc" id="L157">    return mlist(obj.getProps()).foldl(new JSONObject(), new Function2&lt;JSONObject, Prop, JSONObject&gt;() {</span>
      @Override public JSONObject apply(JSONObject jo, Prop prop) {
<span class="fc" id="L159">        jo.put(prop.getName(), toJsonSimple(prop.getVal()));</span>
<span class="fc" id="L160">        return jo;</span>
      }
    });
  }

  private static JSONArray toJsonSimple(Arr arr) {
<span class="fc" id="L166">    return mlist(arr.getVals()).foldl(new JSONArray(), new Function2&lt;JSONArray, Val, JSONArray&gt;() {</span>
      @Override public JSONArray apply(JSONArray ja, Val val) {
<span class="fc" id="L168">        ja.add(toJsonSimple(val));</span>
<span class="fc" id="L169">        return ja;</span>
      }
    });
  }

  private static Object toJsonSimple(Val val) {
<span class="fc bfc" id="L175" title="All 2 branches covered.">    if (val instanceof SVal) {</span>
<span class="fc" id="L176">      return ((SVal) val).getVal();</span>
    }
<span class="fc bfc" id="L178" title="All 2 branches covered.">    if (val instanceof Obj) {</span>
<span class="fc" id="L179">      return toJsonSimple((Obj) val);</span>
    }
<span class="fc bfc" id="L181" title="All 2 branches covered.">    if (val instanceof Arr) {</span>
<span class="fc" id="L182">      return toJsonSimple((Arr) val);</span>
    }
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">    if (val.equals(NULL)) {</span>
<span class="fc" id="L185">      return null;</span>
    }
<span class="nc" id="L187">    return Prelude.unexhaustiveMatch();</span>
  }

  /** Create an object. */
  public static Obj obj(Prop... ps) {
<span class="fc" id="L192">    return new Obj(mlist(ps).filter(notZero.o(getVal)).value());</span>
  }

  /** Create an array. */
  public static Arr arr(Val... vs) {
<span class="fc" id="L197">    return new Arr(mlist(vs).filter(notZero).value());</span>
  }

  /** Create an array. */
  public static Arr arr(List&lt;Val&gt; vs) {
<span class="fc" id="L202">    return new Arr(mlist(vs).filter(notZero).value());</span>
  }

  /** Create an array. */
  public static Arr arr(Monadics.ListMonadic&lt;Val&gt; vs) {
<span class="fc" id="L207">    return new Arr(vs.filter(notZero).value());</span>
  }

  public static Val v(Number v) {
<span class="fc" id="L211">    return new SVal(v);</span>
  }

  public static Val v(String v) {
<span class="fc" id="L215">    return new SVal(v);</span>
  }

<span class="fc" id="L218">  public static final Function&lt;String, Val&gt; stringVal = new Function&lt;String, Val&gt;() {</span>
    @Override public Val apply(String s) {
<span class="fc" id="L220">      return v(s);</span>
    }
  };

  public static Val v(Boolean v) {
<span class="fc" id="L225">    return new SVal(v);</span>
  }

  public static Val v(Date v) {
<span class="nc" id="L229">    return new SVal(DateTimeSupport.toUTC(v.getTime()));</span>
  }

  /** Create a property. */
  public static Prop p(String key, Val val) {
<span class="fc" id="L234">    return new Prop(key, val);</span>
  }

  /** Create a property. Passing none is like setting {@link #ZERO_VAL} which erases the property. */
  public static Prop p(String key, Option&lt;Val&gt; val) {
<span class="fc" id="L239">    return new Prop(key, val.getOrElse(ZERO_VAL));</span>
  }

  /** Create a property. Convenience. */
  public static Prop p(String key, Number value) {
<span class="fc" id="L244">    return new Prop(key, v(value));</span>
  }

  /** Create a property. Convenience. */
  public static Prop p(String key, String value) {
<span class="fc" id="L249">    return new Prop(key, v(value));</span>
  }

  /** Create a property. Convenience. */
  public static Prop p(String key, Boolean value) {
<span class="fc" id="L254">    return new Prop(key, v(value));</span>
  }

  /** Merge a list of objects into one (last one wins). */
  public static Obj append(Obj... os) {
<span class="fc" id="L259">    final List&lt;Prop&gt; props = mlist(os).foldl(new ArrayList&lt;Prop&gt;(), new Function2&lt;ArrayList&lt;Prop&gt;, Obj, ArrayList&lt;Prop&gt;&gt;() {</span>
      @Override public ArrayList&lt;Prop&gt; apply(ArrayList&lt;Prop&gt; props, Obj obj) {
<span class="fc" id="L261">        props.addAll(obj.getProps());</span>
<span class="fc" id="L262">        return props;</span>
      }
    });
<span class="fc" id="L265">    return new Obj(props);</span>
  }

  /** Append a list of arrays into one. */
  public static Arr append(Arr... as) {
<span class="fc" id="L270">    final List&lt;Val&gt; vals = mlist(as).foldl(new ArrayList&lt;Val&gt;(), new Function2&lt;ArrayList&lt;Val&gt;, Arr, ArrayList&lt;Val&gt;&gt;() {</span>
      @Override public ArrayList&lt;Val&gt; apply(ArrayList&lt;Val&gt; vals, Arr arr) {
<span class="fc" id="L272">        vals.addAll(arr.getVals());</span>
<span class="fc" id="L273">        return vals;</span>
      }
    });
<span class="fc" id="L276">    return new Arr(vals);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>