<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>MimeTypes.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-common</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.util</a> &gt; <span class="el_source">MimeTypes.java</span></div><h1>MimeTypes.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.util;

import static org.opencastproject.util.MimeType.mimeType;
import static org.opencastproject.util.data.Monadics.mlist;
import static org.opencastproject.util.data.Option.none;
import static org.opencastproject.util.data.Option.option;

import org.opencastproject.util.data.Collections;
import org.opencastproject.util.data.functions.Options;
import org.opencastproject.util.data.functions.Strings;

import com.entwinemedia.fn.Fn;
import com.entwinemedia.fn.data.Opt;

import org.apache.commons.io.FilenameUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.xml.sax.SAXException;
import org.xml.sax.SAXParseException;
import org.xml.sax.helpers.DefaultHandler;

import java.io.IOException;
import java.io.InputStream;
import java.net.URI;
import java.util.ArrayList;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import javax.xml.parsers.ParserConfigurationException;
import javax.xml.parsers.SAXParser;

/**
 * This class represents the mime type registry that is responsible for providing resolving mime types through all
 * system components.
 * &lt;p&gt;
 * The registry is initialized from the file &lt;code&gt;org.opencastproject.util.MimeTypes.xml&lt;/code&gt;.
 */
public final class MimeTypes {
  /** Disallow construction of this utility class */
  private MimeTypes() {
  }

<span class="fc" id="L65">  public static final Pattern MIME_TYPE_PATTERN = Pattern.compile(&quot;([a-zA-Z0-9-]+)/([a-zA-Z0-9-+.]+)&quot;);</span>

  /** Name of the mime type files */
  public static final String DEFINITION_FILE = &quot;/org/opencastproject/util/MimeTypes.xml&quot;;

  /** Name of the mime type files */
  public static final String DEFAULT_TYPE = &quot;application/octet-stream&quot;;

  /** The mime types */
<span class="fc" id="L74">  private static final List&lt;MimeType&gt; mimeTypes = new ArrayList&lt;&gt;();</span>

  /** the logging facility provided by log4j */
<span class="fc" id="L77">  private static final Logger logger = LoggerFactory.getLogger(MimeType.class);</span>

  /** Common mime types */
  public static final MimeType XML;
  public static final MimeType TEXT;
  public static final MimeType JSON;
  public static final MimeType JPG;
  public static final MimeType MJPEG;
  public static final MimeType MPEG4;
  public static final MimeType MATROSKA;
  public static final MimeType MPEG4_AAC;
  public static final MimeType DV;
  public static final MimeType MJPEG2000;
  public static final MimeType MP3;
  public static final MimeType AAC;
  public static final MimeType CALENDAR;
  public static final MimeType ZIP;
  public static final MimeType JAR;
  public static final MimeType SMIL;
  public static final MimeType PNG;
  public static final MimeType HLS;
  public static final MimeType DASH;

  // Initialize common mime types
  static {
<span class="fc" id="L102">    XML = MimeTypes.parseMimeType(&quot;text/xml&quot;);</span>
<span class="fc" id="L103">    TEXT = MimeTypes.parseMimeType(&quot;text/plain&quot;);</span>
<span class="fc" id="L104">    JSON = MimeTypes.parseMimeType(&quot;application/json&quot;);</span>
<span class="fc" id="L105">    JPG = MimeTypes.parseMimeType(&quot;image/jpg&quot;);</span>
<span class="fc" id="L106">    MJPEG = MimeTypes.parseMimeType(&quot;video/x-motion-jpeg&quot;);</span>
<span class="fc" id="L107">    MPEG4 = MimeTypes.parseMimeType(&quot;video/mp4&quot;);</span>
<span class="fc" id="L108">    MATROSKA = MimeTypes.parseMimeType(&quot;video/x-matroska&quot;);</span>
<span class="fc" id="L109">    MPEG4_AAC = MimeTypes.parseMimeType(&quot;video/x-m4v&quot;);</span>
<span class="fc" id="L110">    DV = MimeTypes.parseMimeType(&quot;video/x-dv&quot;);</span>
<span class="fc" id="L111">    MJPEG2000 = MimeTypes.parseMimeType(&quot;video/mj2&quot;);</span>
<span class="fc" id="L112">    MP3 = MimeTypes.parseMimeType(&quot;audio/mpeg&quot;);</span>
<span class="fc" id="L113">    AAC = MimeTypes.parseMimeType(&quot;audio/x-m4a&quot;);</span>
<span class="fc" id="L114">    CALENDAR = MimeTypes.parseMimeType(&quot;text/calendar&quot;);</span>
<span class="fc" id="L115">    ZIP = MimeTypes.parseMimeType(&quot;application/zip&quot;);</span>
<span class="fc" id="L116">    JAR = MimeTypes.parseMimeType(&quot;application/java-archive&quot;);</span>
<span class="fc" id="L117">    SMIL = MimeTypes.parseMimeType(&quot;application/smil&quot;);</span>
<span class="fc" id="L118">    PNG = MimeTypes.parseMimeType(&quot;image/png&quot;);</span>
<span class="fc" id="L119">    HLS = MimeTypes.parseMimeType(&quot;application/X-mpegURL&quot;);</span>
<span class="fc" id="L120">    DASH = MimeTypes.parseMimeType(&quot;application/dash+xml&quot;);</span>

    // initialize from file
    try {
<span class="fc" id="L124">      SAXParser parser = XmlSafeParser.newSAXParserFactory().newSAXParser();</span>
<span class="fc" id="L125">      DefaultHandler handler = new MimeTypeParser(mimeTypes);</span>

<span class="fc" id="L127">      try (InputStream inputStream = MimeTypes.class.getResourceAsStream(DEFINITION_FILE)) {</span>
<span class="fc" id="L128">        parser.parse(inputStream, handler);</span>
      }
<span class="nc" id="L130">    } catch (IOException e) {</span>
<span class="nc" id="L131">      logger.error(&quot;Error initializing mime type registry&quot;, e);</span>
<span class="nc" id="L132">    } catch (ParserConfigurationException | SAXException e) {</span>
<span class="nc" id="L133">      logger.error(&quot;Error parsing mime type registry&quot;, e);</span>
<span class="pc" id="L134">    }</span>
  }

<span class="fc" id="L137">  public static final Fn&lt;String, Opt&lt;MimeType&gt;&gt; toMimeType = new Fn&lt;String, Opt&lt;MimeType&gt;&gt;() {</span>
    @Override
    public Opt&lt;MimeType&gt; apply(String name) {
      try {
<span class="nc" id="L141">        return Opt.some(parseMimeType(name));</span>
<span class="nc" id="L142">      } catch (Exception e) {</span>
<span class="nc" id="L143">        return Opt.none();</span>
      }
    }
  };


  /**
   * Returns a mime type for the given type and subtype, e. g. &lt;code&gt;video/mj2&lt;/code&gt;.
   *
   * @param mimeType
   *          the mime type
   * @return the corresponding mime type
   */
  public static MimeType parseMimeType(String mimeType) {
<span class="fc" id="L157">    final Matcher m = MIME_TYPE_PATTERN.matcher(mimeType);</span>
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">    if (!m.matches())</span>
<span class="nc" id="L159">      throw new IllegalArgumentException(&quot;Malformed mime type '&quot; + mimeType + &quot;'&quot;);</span>
<span class="fc" id="L160">    final String type = m.group(1);</span>
<span class="fc" id="L161">    final String subtype = m.group(2);</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">    for (MimeType t : mimeTypes) {</span>
<span class="fc bfc" id="L163" title="All 4 branches covered.">      if (t.getType().equals(type) &amp;&amp; t.getSubtype().equals(subtype))</span>
<span class="fc" id="L164">        return t;</span>
<span class="fc" id="L165">    }</span>
<span class="fc" id="L166">    return mimeType(type, subtype);</span>
  }

  /**
   * Returns a mime type for the provided file suffix.
   * &lt;p&gt;
   * For example, if the suffix is &lt;code&gt;mj2&lt;/code&gt;, the mime type will be that of a ISO Motion JPEG 2000 document.
   * &lt;p&gt;
   * If no mime type is found for the suffix, a &lt;code&gt;UnknownFileTypeException&lt;/code&gt; is thrown.
   *
   * @param suffix
   *          the file suffix
   * @return the corresponding mime type
   * @throws UnknownFileTypeException
   *           if the suffix does not map to a mime type
   */
  public static MimeType fromSuffix(String suffix) throws UnknownFileTypeException {
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">    if (suffix == null)</span>
<span class="nc" id="L184">      throw new IllegalArgumentException(&quot;Argument 'suffix' was null!&quot;);</span>

<span class="fc bfc" id="L186" title="All 2 branches covered.">    for (MimeType m : mimeTypes) {</span>
<span class="fc bfc" id="L187" title="All 2 branches covered.">      if (m.supportsSuffix(suffix))</span>
<span class="fc" id="L188">        return m;</span>
<span class="fc" id="L189">    }</span>
<span class="fc" id="L190">    throw new UnknownFileTypeException(&quot;File suffix '&quot; + suffix + &quot;' cannot be matched to any mime type&quot;);</span>
  }

  /**
   * Returns a mime type for the provided file.
   * &lt;p&gt;
   * This method tries various ways to extract mime type information from the files name or its contents.
   * &lt;p&gt;
   * If no mime type can be derived from either the file name or its contents, a &lt;code&gt;UnknownFileTypeException&lt;/code&gt;
   * is thrown.
   *
   * @param uri
   *          the file
   * @return the corresponding mime type
   * @throws UnknownFileTypeException
   *           if the mime type cannot be derived from the file
   */
  public static MimeType fromURI(URI uri) throws UnknownFileTypeException {
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">    if (uri == null)</span>
<span class="nc" id="L209">      throw new IllegalArgumentException(&quot;Argument 'uri' is null&quot;);</span>
<span class="fc" id="L210">    return fromString(uri.getPath());</span>
  }

  /**
   * Returns a mime type for the provided file name.
   * &lt;p&gt;
   * This method tries to find the mime type from the file name suffix (extension).
   * &lt;p&gt;
   * If no mime type can be derived from the file name, an &lt;code&gt;UnknownFileTypeException&lt;/code&gt;
   * is thrown.
   *
   * @param name
   *          the file
   * @return the corresponding mime type
   * @throws UnknownFileTypeException
   *           if the mime type cannot be derived from the file
   */
  public static MimeType fromString(String name) throws UnknownFileTypeException {
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">    if (name == null)</span>
<span class="nc" id="L229">      throw new IllegalArgumentException(&quot;Argument 'name' is null&quot;);</span>

<span class="fc" id="L231">    return fromSuffix(FilenameUtils.getExtension(name));</span>
  }

  /**
   * Convenience method to get a mime type as String from a filename extension
   *
   * @param name
   *          the filename
   * @return the corresponding mime type or DEFAULT_TYPE if no match
   */
  public static String getMimeType(String name) {
    try {
<span class="fc" id="L243">      return MimeTypes.fromString(name).toString();</span>
<span class="nc" id="L244">    } catch (UnknownFileTypeException e) {</span>
<span class="nc" id="L245">      return DEFAULT_TYPE;</span>
    }
  }

  /**
   * Reads the mime type definitions from the xml file comming with this distribution.
   */
  private static class MimeTypeParser extends DefaultHandler {

    /** The mime types */
<span class="fc" id="L255">    private List&lt;MimeType&gt; registry = null;</span>

    /** Element content */
<span class="fc" id="L258">    private StringBuffer content = new StringBuffer();</span>

    /** Type */
<span class="fc" id="L261">    private String type = null;</span>

    /** Description */
<span class="fc" id="L264">    private String description = null;</span>

    /** Extensions, comma separated */
<span class="fc" id="L267">    private String extensions = null;</span>

    /**
     * Creates a new mime type reader.
     *
     * @param registry
     *          the registry
     */
<span class="fc" id="L275">    MimeTypeParser(List&lt;MimeType&gt; registry) {</span>
<span class="fc" id="L276">      this.registry = registry;</span>
<span class="fc" id="L277">    }</span>

    @Override
    public void characters(char[] ch, int start, int length) throws SAXException {
<span class="fc" id="L281">      super.characters(ch, start, length);</span>
<span class="fc" id="L282">      content.append(ch, start, length);</span>
<span class="fc" id="L283">    }</span>

    /**
     * Returns the element content.
     *
     * @return the element content
     */
    private String getContent() {
<span class="fc" id="L291">      String str = content.toString();</span>
<span class="fc" id="L292">      content = new StringBuffer();</span>
<span class="fc" id="L293">      return str;</span>
    }

    @Override
    public void endElement(final String uri, final String localName, final String name) throws SAXException {
<span class="fc" id="L298">      super.endElement(uri, localName, name);</span>

<span class="fc bfc" id="L300" title="All 2 branches covered.">      if (&quot;Type&quot;.equals(name)) {</span>
<span class="fc" id="L301">        type = getContent();</span>
<span class="fc bfc" id="L302" title="All 2 branches covered.">      } else if (&quot;Description&quot;.equals(name)) {</span>
<span class="fc" id="L303">        description = getContent();</span>
<span class="fc bfc" id="L304" title="All 2 branches covered.">      } else if (&quot;Extensions&quot;.equals(name)) {</span>
<span class="fc" id="L305">        extensions = getContent();</span>
<span class="fc bfc" id="L306" title="All 2 branches covered.">      } else if (&quot;MimeType&quot;.equals(name)) {</span>
<span class="fc" id="L307">        String[] t = type.split(&quot;/&quot;);</span>
<span class="fc" id="L308">        MimeType mimeType = mimeType(t[0].trim(), t[1].trim(),</span>
<span class="fc" id="L309">                mlist(extensions.split(&quot;,&quot;)).bind(Options.&lt;String&gt; asList().o(Strings.trimToNone)).value(),</span>
<span class="fc" id="L310">                Collections.&lt;MimeType&gt; nil(), option(description), none(&quot;&quot;), none(&quot;&quot;));</span>
<span class="fc" id="L311">        registry.add(mimeType);</span>
      }
<span class="fc" id="L313">    }</span>

    @Override
    public void warning(SAXParseException e) throws SAXException {
<span class="nc" id="L317">      super.warning(e);</span>
<span class="nc" id="L318">    }</span>

    @Override
    public void error(SAXParseException e) throws SAXException {
<span class="nc" id="L322">      super.error(e);</span>
<span class="nc" id="L323">    }</span>

    @Override
    public void fatalError(SAXParseException e) throws SAXException {
<span class="nc" id="L327">      super.fatalError(e);</span>
<span class="nc" id="L328">    }</span>

  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>