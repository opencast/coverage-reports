<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>StaticMetadataServiceDublinCoreImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-dublincore</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.metadata.dublincore</a> &gt; <span class="el_source">StaticMetadataServiceDublinCoreImpl.java</span></div><h1>StaticMetadataServiceDublinCoreImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.metadata.dublincore;

import static org.opencastproject.metadata.dublincore.DublinCore.PROPERTY_ACCESS_RIGHTS;
import static org.opencastproject.metadata.dublincore.DublinCore.PROPERTY_AVAILABLE;
import static org.opencastproject.metadata.dublincore.DublinCore.PROPERTY_CONTRIBUTOR;
import static org.opencastproject.metadata.dublincore.DublinCore.PROPERTY_CREATED;
import static org.opencastproject.metadata.dublincore.DublinCore.PROPERTY_CREATOR;
import static org.opencastproject.metadata.dublincore.DublinCore.PROPERTY_DESCRIPTION;
import static org.opencastproject.metadata.dublincore.DublinCore.PROPERTY_EXTENT;
import static org.opencastproject.metadata.dublincore.DublinCore.PROPERTY_IDENTIFIER;
import static org.opencastproject.metadata.dublincore.DublinCore.PROPERTY_IS_PART_OF;
import static org.opencastproject.metadata.dublincore.DublinCore.PROPERTY_LANGUAGE;
import static org.opencastproject.metadata.dublincore.DublinCore.PROPERTY_LICENSE;
import static org.opencastproject.metadata.dublincore.DublinCore.PROPERTY_PUBLISHER;
import static org.opencastproject.metadata.dublincore.DublinCore.PROPERTY_REPLACES;
import static org.opencastproject.metadata.dublincore.DublinCore.PROPERTY_RIGHTS_HOLDER;
import static org.opencastproject.metadata.dublincore.DublinCore.PROPERTY_SPATIAL;
import static org.opencastproject.metadata.dublincore.DublinCore.PROPERTY_SUBJECT;
import static org.opencastproject.metadata.dublincore.DublinCore.PROPERTY_TEMPORAL;
import static org.opencastproject.metadata.dublincore.DublinCore.PROPERTY_TITLE;
import static org.opencastproject.metadata.dublincore.DublinCore.PROPERTY_TYPE;
import static org.opencastproject.util.data.Collections.head;
import static org.opencastproject.util.data.Monadics.mlist;
import static org.opencastproject.util.data.Option.option;
import static org.opencastproject.util.data.Option.some;

import org.opencastproject.mediapackage.Catalog;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.mediapackage.MediaPackageElementFlavor;
import org.opencastproject.mediapackage.MediaPackageElements;
import org.opencastproject.mediapackage.MediaPackageSerializer;
import org.opencastproject.metadata.api.MetadataValue;
import org.opencastproject.metadata.api.StaticMetadata;
import org.opencastproject.metadata.api.StaticMetadataService;
import org.opencastproject.metadata.api.util.Interval;
import org.opencastproject.util.data.Function;
import org.opencastproject.util.data.NonEmptyList;
import org.opencastproject.util.data.Option;
import org.opencastproject.util.data.Predicate;
import org.opencastproject.util.data.functions.Misc;
import org.opencastproject.workspace.api.Workspace;

import org.apache.commons.io.IOUtils;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.component.annotations.ReferenceCardinality;
import org.osgi.service.component.annotations.ReferencePolicy;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.InputStream;
import java.net.URI;
import java.util.Date;
import java.util.List;
import java.util.Map;

/**
 * This service provides {@link org.opencastproject.metadata.api.StaticMetadata} for a given mediapackage,
 * based on a contained dublin core catalog describing the episode.
 */
@Component(
    immediate = true,
    service = StaticMetadataService.class,
    property = {
        &quot;service.description=Static Metadata Service, dublin core based&quot;,
        &quot;metadata.source=dublincore&quot;,
        &quot;priority=1&quot;
    }
)
<span class="fc" id="L92">public class StaticMetadataServiceDublinCoreImpl implements StaticMetadataService {</span>

<span class="fc" id="L94">  private static final Logger logger = LoggerFactory.getLogger(StaticMetadataServiceDublinCoreImpl.class);</span>

  // Catalog loader function
<span class="fc" id="L97">  private Function&lt;Catalog, Option&lt;DublinCoreCatalog&gt;&gt; loader = new Function&lt;Catalog, Option&lt;DublinCoreCatalog&gt;&gt;() {</span>
    @Override
    public Option&lt;DublinCoreCatalog&gt; apply(Catalog catalog) {
<span class="nc" id="L100">      return load(catalog);</span>
    }
  };

<span class="fc" id="L104">  protected int priority = 0;</span>

<span class="fc" id="L106">  protected Workspace workspace = null;</span>

<span class="fc" id="L108">  protected MediaPackageSerializer serializer = null;</span>

  @Reference
  public void setWorkspace(Workspace workspace) {
<span class="fc" id="L112">    this.workspace = workspace;</span>
<span class="fc" id="L113">  }</span>

  @Reference(
      cardinality = ReferenceCardinality.OPTIONAL,
      policy = ReferencePolicy.DYNAMIC,
      target = &quot;(service.pid=org.opencastproject.mediapackage.ChainingMediaPackageSerializer)&quot;,
      unbind = &quot;unsetMediaPackageSerializer&quot;
  )
  public void setMediaPackageSerializer(MediaPackageSerializer serializer) {
<span class="nc" id="L122">    this.serializer = serializer;</span>
<span class="nc" id="L123">  }</span>

  public void unsetMediaPackageSerializer(MediaPackageSerializer serializer) {
<span class="nc bnc" id="L126" title="All 2 branches missed.">    if (this.serializer == serializer) {</span>
<span class="nc" id="L127">      this.serializer = null;</span>
    }
<span class="nc" id="L129">  }</span>

  @Activate
  public void activate(@SuppressWarnings(&quot;rawtypes&quot;) Map properties) {
<span class="nc" id="L133">    logger.debug(&quot;activate()&quot;);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">    if (properties != null) {</span>
<span class="nc" id="L135">      String priorityString = (String) properties.get(PRIORITY_KEY);</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">      if (priorityString != null) {</span>
        try {
<span class="nc" id="L138">          priority = Integer.parseInt(priorityString);</span>
<span class="nc" id="L139">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L140">          logger.warn(&quot;Unable to set priority to {}&quot;, priorityString);</span>
<span class="nc" id="L141">          throw e;</span>
<span class="nc" id="L142">        }</span>
      }
    }
<span class="nc" id="L145">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.metadata.api.MetadataService#getMetadata(org.opencastproject.mediapackage.MediaPackage)
   */
  @Override
  public StaticMetadata getMetadata(final MediaPackage mp) {
<span class="fc" id="L154">    Catalog[] catalogs = mp.getCatalogs(MediaPackageElements.EPISODE);</span>
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">    if (catalogs.length &gt; 0) {</span>
<span class="fc" id="L156">      return newStaticMetadataFromEpisode(DublinCoreUtil.loadDublinCore(workspace, catalogs[0]));</span>
    }
<span class="nc" id="L158">    return null;</span>
  }

  private static StaticMetadata newStaticMetadataFromEpisode(DublinCoreCatalog episode) {
    // Ensure that the mandatory properties are present
<span class="fc" id="L163">    final Option&lt;String&gt; id = option(episode.getFirst(PROPERTY_IDENTIFIER));</span>
<span class="fc" id="L164">    final Option&lt;Date&gt; created = option(episode.getFirst(PROPERTY_CREATED)).map(new Function&lt;String, Date&gt;() {</span>
      @Override
      public Date apply(String a) {
<span class="fc" id="L167">        final Date date = EncodingSchemeUtils.decodeDate(a);</span>
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">        return date != null ? date : Misc.&lt;Date&gt;chuck(new RuntimeException(a + &quot; does not conform to W3C-DTF encoding scheme.&quot;));</span>
      }
    });
<span class="fc" id="L171">    final Option temporalOpt = option(episode.getFirstVal(PROPERTY_TEMPORAL)).map(dc2temporalValueOption());</span>
    final Option&lt;Date&gt; start;
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">    if (episode.getFirst(PROPERTY_TEMPORAL) != null) {</span>
<span class="nc" id="L174">      DCMIPeriod period = EncodingSchemeUtils</span>
<span class="nc" id="L175">                  .decodeMandatoryPeriod(episode.getFirst(PROPERTY_TEMPORAL));</span>
<span class="nc" id="L176">      start = option(period.getStart());</span>
<span class="nc" id="L177">    } else {</span>
<span class="fc" id="L178">      start = created;</span>
    }
<span class="fc" id="L180">    final Option&lt;String&gt; language = option(episode.getFirst(PROPERTY_LANGUAGE));</span>
<span class="fc" id="L181">    final Option&lt;Long&gt; extent = head(episode.get(PROPERTY_EXTENT)).map(new Function&lt;DublinCoreValue, Long&gt;() {</span>
      @Override
      public Long apply(DublinCoreValue a) {
<span class="nc" id="L184">        final Long extent = EncodingSchemeUtils.decodeDuration(a);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">        return extent != null ? extent : Misc.&lt;Long&gt;chuck(new RuntimeException(a + &quot; does not conform to ISO8601 encoding scheme for durations.&quot;));</span>
      }
    });
<span class="fc" id="L188">    final Option&lt;String&gt; type = option(episode.getFirst(PROPERTY_TYPE));</span>

<span class="fc" id="L190">    final Option&lt;String&gt; isPartOf = option(episode.getFirst(PROPERTY_IS_PART_OF));</span>
<span class="fc" id="L191">    final Option&lt;String&gt; replaces = option(episode.getFirst(PROPERTY_REPLACES));</span>
<span class="fc" id="L192">    final Option&lt;Interval&gt; available = head(episode.get(PROPERTY_AVAILABLE)).flatMap(</span>
<span class="fc" id="L193">            new Function&lt;DublinCoreValue, Option&lt;Interval&gt;&gt;() {</span>
              @Override
              public Option&lt;Interval&gt; apply(DublinCoreValue v) {
<span class="nc" id="L196">                final DCMIPeriod p = EncodingSchemeUtils.decodePeriod(v);</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">                return p != null</span>
<span class="nc" id="L198">                        ? some(Interval.fromValues(p.getStart(), p.getEnd()))</span>
<span class="nc" id="L199">                        : Misc.&lt;Option&lt;Interval&gt;&gt;chuck(new RuntimeException(v + &quot; does not conform to W3C-DTF encoding scheme for periods&quot;));</span>
              }
            });
<span class="fc" id="L202">    final NonEmptyList&lt;MetadataValue&lt;String&gt;&gt; titles = new NonEmptyList&lt;MetadataValue&lt;String&gt;&gt;(</span>
<span class="fc" id="L203">            mlist(episode.get(PROPERTY_TITLE)).map(dc2mvString(PROPERTY_TITLE.getLocalName())).value());</span>
<span class="fc" id="L204">    final List&lt;MetadataValue&lt;String&gt;&gt; subjects =</span>
<span class="fc" id="L205">            mlist(episode.get(PROPERTY_SUBJECT)).map(dc2mvString(PROPERTY_SUBJECT.getLocalName())).value();</span>
<span class="fc" id="L206">    final List&lt;MetadataValue&lt;String&gt;&gt; creators =</span>
<span class="fc" id="L207">            mlist(episode.get(PROPERTY_CREATOR)).map(dc2mvString(PROPERTY_CREATOR.getLocalName())).value();</span>
<span class="fc" id="L208">    final List&lt;MetadataValue&lt;String&gt;&gt; publishers =</span>
<span class="fc" id="L209">            mlist(episode.get(PROPERTY_PUBLISHER)).map(dc2mvString(PROPERTY_PUBLISHER.getLocalName())).value();</span>
<span class="fc" id="L210">    final List&lt;MetadataValue&lt;String&gt;&gt; contributors =</span>
<span class="fc" id="L211">            mlist(episode.get(PROPERTY_CONTRIBUTOR)).map(dc2mvString(PROPERTY_CONTRIBUTOR.getLocalName())).value();</span>
<span class="fc" id="L212">    final List&lt;MetadataValue&lt;String&gt;&gt; description =</span>
<span class="fc" id="L213">            mlist(episode.get(PROPERTY_DESCRIPTION)).map(dc2mvString(PROPERTY_DESCRIPTION.getLocalName())).value();</span>
<span class="fc" id="L214">    final List&lt;MetadataValue&lt;String&gt;&gt; rightsHolders =</span>
<span class="fc" id="L215">            mlist(episode.get(PROPERTY_RIGHTS_HOLDER)).map(dc2mvString(PROPERTY_RIGHTS_HOLDER.getLocalName())).value();</span>
<span class="fc" id="L216">    final List&lt;MetadataValue&lt;String&gt;&gt; spatials =</span>
<span class="fc" id="L217">            mlist(episode.get(PROPERTY_SPATIAL)).map(dc2mvString(PROPERTY_SPATIAL.getLocalName())).value();</span>
<span class="fc" id="L218">    final List&lt;MetadataValue&lt;String&gt;&gt; accessRights =</span>
<span class="fc" id="L219">            mlist(episode.get(PROPERTY_ACCESS_RIGHTS)).map(dc2mvString(PROPERTY_ACCESS_RIGHTS.getLocalName())).value();</span>
<span class="fc" id="L220">    final List&lt;MetadataValue&lt;String&gt;&gt; licenses =</span>
<span class="fc" id="L221">            mlist(episode.get(PROPERTY_LICENSE)).map(dc2mvString(PROPERTY_LICENSE.getLocalName())).value();</span>

<span class="fc" id="L223">    return new StaticMetadata() {</span>
      @Override
      public Option&lt;String&gt; getId() {
<span class="nc" id="L226">        return id;</span>
      }

      @Override
      public Option&lt;Date[]&gt; getTemporalPeriod() {
<span class="nc bnc" id="L231" title="All 2 branches missed.">        if (temporalOpt.isSome()) {</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">          if (temporalOpt.get() instanceof DCMIPeriod) {</span>
<span class="nc" id="L233">            DCMIPeriod p = (DCMIPeriod) temporalOpt.get();</span>
<span class="nc" id="L234">            return option(new Date[] { p.getStart(), p.getEnd() });</span>
          }
        }
<span class="nc" id="L237">        return Option.none();</span>
      }

      @Override
      public Option&lt;Date&gt; getTemporalInstant() {
<span class="nc bnc" id="L242" title="All 2 branches missed.">        if (temporalOpt.isSome()) {</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">          if (temporalOpt.get() instanceof Date) {</span>
<span class="nc" id="L244">            return temporalOpt;</span>
          }
        }
<span class="nc" id="L247">        return Option.none();</span>
      }

      @Override
      public Option&lt;Long&gt; getTemporalDuration() {
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if (temporalOpt.isSome()) {</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">          if (temporalOpt.get() instanceof Long) {</span>
<span class="nc" id="L254">            return temporalOpt;</span>
          }
        }
<span class="nc" id="L257">        return Option.none();</span>
      }

      @Override
      public Option&lt;Long&gt; getExtent() {
<span class="nc" id="L262">        return extent;</span>
      }

      @Override
      public Option&lt;String&gt; getLanguage() {
<span class="nc" id="L267">        return language;</span>
      }

      @Override
      public Option&lt;String&gt; getIsPartOf() {
<span class="nc" id="L272">        return isPartOf;</span>
      }

      @Override
      public Option&lt;String&gt; getReplaces() {
<span class="nc" id="L277">        return replaces;</span>
      }

      @Override
      public Option&lt;String&gt; getType() {
<span class="nc" id="L282">        return type;</span>
      }

      @Override
      public Option&lt;Interval&gt; getAvailable() {
<span class="nc" id="L287">        return available;</span>
      }

      @Override
      public NonEmptyList&lt;MetadataValue&lt;String&gt;&gt; getTitles() {
<span class="fc" id="L292">        return titles;</span>
      }

      @Override
      public List&lt;MetadataValue&lt;String&gt;&gt; getSubjects() {
<span class="nc" id="L297">        return subjects;</span>
      }

      @Override
      public List&lt;MetadataValue&lt;String&gt;&gt; getCreators() {
<span class="nc" id="L302">        return creators;</span>
      }

      @Override
      public List&lt;MetadataValue&lt;String&gt;&gt; getPublishers() {
<span class="nc" id="L307">        return publishers;</span>
      }

      @Override
      public List&lt;MetadataValue&lt;String&gt;&gt; getContributors() {
<span class="nc" id="L312">        return contributors;</span>
      }

      @Override
      public List&lt;MetadataValue&lt;String&gt;&gt; getDescription() {
<span class="nc" id="L317">        return description;</span>
      }

      @Override
      public List&lt;MetadataValue&lt;String&gt;&gt; getRightsHolders() {
<span class="nc" id="L322">        return rightsHolders;</span>
      }

      @Override
      public List&lt;MetadataValue&lt;String&gt;&gt; getSpatials() {
<span class="nc" id="L327">        return spatials;</span>
      }

      @Override
      public List&lt;MetadataValue&lt;String&gt;&gt; getAccessRights() {
<span class="nc" id="L332">        return accessRights;</span>
      }

      @Override
      public List&lt;MetadataValue&lt;String&gt;&gt; getLicenses() {
<span class="nc" id="L337">        return licenses;</span>
      }
    };
  }

  /**
   *
   * {@inheritDoc}
   *
   * @see org.opencastproject.metadata.api.MetadataService#getPriority()
   */
  @Override
  public int getPriority() {
<span class="nc" id="L350">    return priority;</span>
  }

  /**
   * Return a function that creates a Option with the value of temporal from a DublinCoreValue.
   */
  private static Function&lt;DublinCoreValue, Object&gt; dc2temporalValueOption() {
<span class="fc" id="L357">    return new Function&lt;DublinCoreValue, Object&gt;() {</span>
      @Override
      public Object apply(DublinCoreValue dcv) {
<span class="nc" id="L360">        Temporal temporal = EncodingSchemeUtils.decodeTemporal(dcv);</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">        if (temporal != null) {</span>
<span class="nc" id="L362">          return temporal.fold(new Temporal.Match&lt;Object&gt;() {</span>
            @Override
            public Object period(DCMIPeriod period) {
<span class="nc" id="L365">              return period;</span>
            }

            @Override
            public Object instant(Date instant) {
<span class="nc" id="L370">              return instant;</span>
            }

            @Override
            public Object duration(long duration) {
<span class="nc" id="L375">              return duration;</span>
            }
          });
        }
<span class="nc" id="L379">        return Misc.&lt;Object&gt;chuck(new RuntimeException(dcv</span>
                + &quot; does not conform to ISO8601 encoding scheme for temporal.&quot;));
      }
    };
  }

  /**
   * Return a function that creates a MetadataValue[String] from a DublinCoreValue setting its name to &lt;code&gt;name&lt;/code&gt;.
   */
  private static Function&lt;DublinCoreValue, MetadataValue&lt;String&gt;&gt; dc2mvString(final String name) {
<span class="fc" id="L389">    return new Function&lt;DublinCoreValue, MetadataValue&lt;String&gt;&gt;() {</span>
      @Override
      public MetadataValue&lt;String&gt; apply(DublinCoreValue dcv) {
<span class="fc" id="L392">        return new MetadataValue&lt;String&gt;(dcv.getValue(), name, dcv.getLanguage());</span>
      }
    };
  }

  private static Predicate&lt;Catalog&gt; flavorPredicate(final MediaPackageElementFlavor flavor) {
<span class="nc" id="L398">    return new Predicate&lt;Catalog&gt;() {</span>
      @Override
      public Boolean apply(Catalog catalog) {
<span class="nc" id="L401">        return flavor.equals(catalog.getFlavor());</span>
      }
    };
  }

  private Option&lt;DublinCoreCatalog&gt; load(Catalog catalog) {
<span class="nc" id="L407">    InputStream in = null;</span>
    try {
<span class="nc" id="L409">      URI uri = catalog.getURI();</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">      if (serializer != null) uri = serializer.decodeURI(uri);</span>
<span class="nc" id="L411">      in = workspace.read(uri);</span>
<span class="nc" id="L412">      return some((DublinCoreCatalog) DublinCores.read(in));</span>
<span class="nc" id="L413">    } catch (Exception e) {</span>
<span class="nc" id="L414">      logger.warn(&quot;Unable to load metadata from catalog '{}'&quot;, catalog);</span>
<span class="nc" id="L415">      return Option.none();</span>
    } finally {
<span class="nc" id="L417">      IOUtils.closeQuietly(in);</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>