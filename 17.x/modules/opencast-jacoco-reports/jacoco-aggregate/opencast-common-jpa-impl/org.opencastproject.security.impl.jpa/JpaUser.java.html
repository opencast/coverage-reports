<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>JpaUser.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-common-jpa-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.security.impl.jpa</a> &gt; <span class="el_source">JpaUser.java</span></div><h1>JpaUser.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.security.impl.jpa;

import org.opencastproject.security.api.Organization;
import org.opencastproject.security.api.Role;
import org.opencastproject.security.api.User;
import org.opencastproject.util.EqualsUtil;

import java.util.HashSet;
import java.util.Objects;
import java.util.Set;

import javax.persistence.Access;
import javax.persistence.AccessType;
import javax.persistence.CascadeType;
import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.FetchType;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;
import javax.persistence.JoinColumn;
import javax.persistence.JoinTable;
import javax.persistence.Lob;
import javax.persistence.ManyToMany;
import javax.persistence.NamedQueries;
import javax.persistence.NamedQuery;
import javax.persistence.OneToOne;
import javax.persistence.Table;
import javax.persistence.Transient;
import javax.persistence.UniqueConstraint;

/**
 * JPA-annotated user object.
 */
@Entity
@Access(AccessType.FIELD)
@Table(
    name = &quot;oc_user&quot;,
    uniqueConstraints = {
        @UniqueConstraint(name = &quot;UNQ_oc_user&quot;, columnNames = { &quot;username&quot;, &quot;organization&quot; }),
    }
)
@NamedQueries({
    @NamedQuery(
        name = &quot;User.findByQuery&quot;,
        query = &quot;select u from JpaUser u where UPPER(u.username) like :query and u.organization.id = :org&quot;
    ),
    @NamedQuery(
        name = &quot;User.findByIdAndOrg&quot;,
        query = &quot;select u from JpaUser u where u.id=:id and u.organization.id = :org&quot;
    ),
    @NamedQuery(
        name = &quot;User.findByUsername&quot;,
        query = &quot;select u from JpaUser u where u.username=:u and u.organization.id = :org&quot;
    ),
    @NamedQuery(
        name = &quot;User.findAll&quot;,
        query = &quot;select u from JpaUser u where u.organization.id = :org&quot;
    ),
    @NamedQuery(
        name = &quot;User.findInsecureHash&quot;,
        query = &quot;select u from JpaUser u where length(u.password) = 32 and u.organization.id = :org&quot;
    ),
    @NamedQuery(
        name = &quot;User.findAllByUserNames&quot;,
        query = &quot;select u from JpaUser u where u.organization.id = :org AND u.username IN :names&quot;
    ),
    @NamedQuery(
        name = &quot;User.countAllByOrg&quot;,
        query = &quot;select COUNT(u) from JpaUser u where u.organization.id = :org&quot;
    ),
    @NamedQuery(
        name = &quot;User.countAll&quot;,
        query = &quot;select COUNT(u) from JpaUser u&quot;
    ),
})
public class JpaUser implements User {

  @Id
  @GeneratedValue
  @Column(name = &quot;id&quot;)
  private Long id;

  @Column(name = &quot;username&quot;, length = 128)
  private String username;

  @Column(name = &quot;name&quot;, length = 256)
  private String name;

  @Column(name = &quot;email&quot;, length = 256)
  private String email;

<span class="fc" id="L112">  @Column(name = &quot;manageable&quot;, nullable = false)</span>
  private boolean manageable = true;

  @Transient
  private String provider;

  @Lob
  @Column(name = &quot;password&quot;, length = 65535)
  private String password;

  @OneToOne()
  @JoinColumn(name = &quot;organization&quot;)
  private JpaOrganization organization;

  @ManyToMany(cascade = { CascadeType.MERGE }, fetch = FetchType.LAZY)
  @JoinTable(
      name = &quot;oc_user_role&quot;,
      joinColumns = { @JoinColumn(name = &quot;user_id&quot;) },
      inverseJoinColumns = { @JoinColumn(name = &quot;role_id&quot;) },
      uniqueConstraints = {
          @UniqueConstraint(name = &quot;UNQ_oc_user_role&quot;, columnNames = { &quot;user_id&quot;, &quot;role_id&quot; })
      }
  )
  private Set&lt;JpaRole&gt; roles;

  /**
   * No-arg constructor needed by JPA
   */
<span class="fc" id="L140">  public JpaUser() {</span>
<span class="fc" id="L141">  }</span>

  /**
   * Constructs a user with the specified username, password, name, email and provider.
   *
   * @param username
   *          the username
   * @param password
   *          the password
   * @param organization
   *          the organization
   * @param name
   *          the name
   * @param email
   *          the email
   * @param provider
   *          the provider
   * @param manageable
   *          whether the user is manageable
   */
  public JpaUser(String username, String password, JpaOrganization organization, String name, String email,
          String provider, boolean manageable) {
<span class="fc" id="L163">    super();</span>
<span class="fc" id="L164">    this.username = username;</span>
<span class="fc" id="L165">    this.password = password;</span>
<span class="fc" id="L166">    this.organization = organization;</span>
<span class="fc" id="L167">    this.name = name;</span>
<span class="fc" id="L168">    this.email = email;</span>
<span class="fc" id="L169">    this.provider = provider;</span>
<span class="fc" id="L170">    this.manageable = manageable;</span>
<span class="fc" id="L171">    this.roles = new HashSet&lt;JpaRole&gt;();</span>
<span class="fc" id="L172">  }</span>

  /**
   * Constructs a user with the specified username, password, provider and roles.
   *
   * @param username
   *          the username
   * @param password
   *          the password
   * @param organization
   *          the organization
   * @param provider
   *          the provider
   * @param manageable
   *          whether the user is manageable
   * @param roles
   *          the roles
   */
  public JpaUser(String username, String password, JpaOrganization organization, String provider, boolean manageable,
          Set&lt;JpaRole&gt; roles) {
<span class="fc" id="L192">    this(username, password, organization, null, null, provider, manageable);</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">    for (Role role : roles) {</span>
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">      if (!Objects.equals(organization.getId(), role.getOrganizationId())) {</span>
<span class="nc" id="L195">        throw new IllegalArgumentException(&quot;Role &quot; + role + &quot; is not from the same organization!&quot;);</span>
      }
<span class="fc" id="L197">    }</span>
<span class="fc" id="L198">    this.roles = roles;</span>
<span class="fc" id="L199">  }</span>

  /**
   * Constructs a user with the specified username, password, name, email, provider and roles.
   *
   * @param username
   *          the username
   * @param password
   *          the password
   * @param organization
   *          the organization
   * @param name
   *          the name
   * @param email
   *          the email
   * @param provider
   *          the provider
   * @param manageable
   *          whether the user is manageable
   * @param roles
   *          the roles
   */
  public JpaUser(String username, String password, JpaOrganization organization, String name, String email,
          String provider, boolean manageable, Set&lt;JpaRole&gt; roles) {
<span class="fc" id="L223">    this(username, password, organization, name, email, provider, manageable);</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">    for (Role role : roles) {</span>
<span class="pc bpc" id="L225" title="1 of 2 branches missed.">      if (!Objects.equals(organization.getId(), role.getOrganizationId())) {</span>
<span class="nc" id="L226">        throw new IllegalArgumentException(&quot;Role &quot; + role + &quot; is not from the same organization (&quot;</span>
<span class="nc" id="L227">                + organization.getId() + &quot;)&quot;);</span>
      }
<span class="fc" id="L229">    }</span>
<span class="fc" id="L230">    this.roles = roles;</span>
<span class="fc" id="L231">  }</span>

  public Long getId() {
<span class="fc" id="L234">    return id;</span>
  }

  public void setId(Long id) {
<span class="fc" id="L238">    this.id = id;</span>
<span class="fc" id="L239">  }</span>

  /**
   * Gets this user's clear text password.
   *
   * @return the user account's password
   */
  @Override
  public String getPassword() {
<span class="fc" id="L248">    return password;</span>
  }

  /**
   * @see org.opencastproject.security.api.User#getUsername()
   */
  @Override
  public String getUsername() {
<span class="fc" id="L256">    return username;</span>
  }

  /**
   * @see org.opencastproject.security.api.User#hasRole(String)
   */
  @Override
  public boolean hasRole(String roleName) {
<span class="fc bfc" id="L264" title="All 2 branches covered.">    for (Role role : roles) {</span>
<span class="fc bfc" id="L265" title="All 2 branches covered.">      if (role.getName().equals(roleName)) {</span>
<span class="fc" id="L266">        return true;</span>
      }
<span class="fc" id="L268">    }</span>
<span class="fc" id="L269">    return false;</span>
  }

  /**
   * @see org.opencastproject.security.api.User#getOrganization()
   */
  @Override
  public Organization getOrganization() {
<span class="fc" id="L277">    return organization;</span>
  }

  /**
   * @see org.opencastproject.security.api.User#getRoles()
   */
  @Override
  public Set&lt;Role&gt; getRoles() {
<span class="fc" id="L285">    return new HashSet&lt;Role&gt;(roles);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see java.lang.Object#equals(java.lang.Object)
   */
  @Override
  public boolean equals(Object obj) {
<span class="pc bpc" id="L295" title="1 of 2 branches missed.">    if (!(obj instanceof User)) {</span>
<span class="nc" id="L296">      return false;</span>
    }
<span class="fc" id="L298">    User other = (User) obj;</span>
<span class="pc bpc" id="L299" title="2 of 4 branches missed.">    return username.equals(other.getUsername()) &amp;&amp; organization.equals(other.getOrganization())</span>
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">            &amp;&amp; EqualsUtil.eq(provider, other.getProvider());</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see java.lang.Object#hashCode()
   */
  @Override
  public int hashCode() {
<span class="nc" id="L310">    return Objects.hash(username, organization, provider);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see java.lang.Object#toString()
   */
  @Override
  public String toString() {
<span class="fc" id="L320">    return new StringBuilder(username).append(&quot;:&quot;).append(organization).append(&quot;:&quot;).append(provider).toString();</span>
  }

  @Override
  public String getName() {
<span class="fc" id="L325">    return name;</span>
  }

  @Override
  public String getEmail() {
<span class="fc" id="L330">    return email;</span>
  }

  @Override
  public String getProvider() {
<span class="fc" id="L335">    return provider;</span>
  }

  public void setProvider(String provider) {
<span class="fc" id="L339">    this.provider = provider;</span>
<span class="fc" id="L340">  }</span>

  @Override
  public boolean isManageable() {
<span class="fc" id="L344">    return manageable;</span>
  }

  public void setManageable(boolean isManageable) {
<span class="nc" id="L348">    this.manageable = isManageable;</span>
<span class="nc" id="L349">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>