<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>GoogleSpeechTranscriptionServiceStorage.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-transcription-service-google-speech-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.transcription.googlespeech</a> &gt; <span class="el_source">GoogleSpeechTranscriptionServiceStorage.java</span></div><h1>GoogleSpeechTranscriptionServiceStorage.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.transcription.googlespeech;

import org.apache.http.HttpHeaders;
import org.apache.http.HttpStatus;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpDelete;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.client.methods.HttpPut;
import org.apache.http.entity.FileEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;
import java.io.IOException;

<span class="fc" id="L37">public class GoogleSpeechTranscriptionServiceStorage {</span>

  /**
   * The logger
   */
<span class="fc" id="L42">  private static final Logger logger = LoggerFactory.getLogger(GoogleSpeechTranscriptionService.class);</span>

  private static final String GOOGLE_STORAGE_LINK = &quot;https://www.googleapis.com/upload/storage/v1/b/&quot;;
  private static final String GOOGLE_STORAGE_MEDIA = &quot;https://www.googleapis.com/storage/v1/b/&quot;;
  private static final int DEFAULT_CODE = 0;

  /**
   * Upload to Google Cloud Storage using Json API.
   * https://cloud.google.com/storage/docs/json_api/v1/how-tos/resumable-upload
   *
   * @param httpClient
   * @param bucket Google storage bucket name
   * @param mpId mediapackage ID
   * @param fileExtension
   * @param file
   * @param byteSize
   * @param contentType
   * @param accessToken
   * @return response code
   * @throws java.io.IOException
   */
  public int startUpload(CloseableHttpClient httpClient, String bucket, String mpId,
          String fileExtension, File file, String byteSize, String contentType, String accessToken) throws IOException {
<span class="fc" id="L65">    CloseableHttpResponse postResponse = null;</span>
<span class="fc" id="L66">    CloseableHttpResponse putResponse = null;</span>
<span class="fc" id="L67">    String location = null;</span>

    try {
<span class="fc" id="L70">      HttpPost httpPost = new HttpPost(GOOGLE_STORAGE_LINK + String.format(</span>
              &quot;%s/o?uploadType=resumable&amp;name=%s.%s&quot;, bucket, mpId, fileExtension));
<span class="fc" id="L72">      logger.debug(&quot;Url to store media file on Google Cloud Storage : {}&quot;, httpPost.getURI().toString());</span>
<span class="fc" id="L73">      httpPost.addHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + accessToken);</span>
<span class="fc" id="L74">      httpPost.addHeader(&quot;X-Upload-Content-Type&quot;, contentType);</span>
<span class="fc" id="L75">      httpPost.addHeader(&quot;X-Upload-Content-Length&quot;, byteSize);</span>
<span class="fc" id="L76">      httpPost.addHeader(HttpHeaders.CONTENT_TYPE, &quot;application/json; charset=utf-8&quot;);</span>
<span class="fc" id="L77">      postResponse = httpClient.execute(httpPost);</span>
<span class="fc" id="L78">      int postCode = postResponse.getStatusLine().getStatusCode();</span>
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">      if (postCode == HttpStatus.SC_OK) { // 200</span>
<span class="fc" id="L80">        logger.info(&quot;Upload session has been successfully created&quot;);</span>
        // Get upload session stored in location
        try {
<span class="nc" id="L83">          location = postResponse.getLastHeader(&quot;Location&quot;).getValue();</span>
<span class="fc" id="L84">        } catch (Exception ex) {</span>
<span class="fc" id="L85">          logger.warn(&quot;Exception when uploading file to Google Storage&quot;, ex);</span>
<span class="fc" id="L86">          return DEFAULT_CODE;</span>
<span class="nc" id="L87">        }</span>
        try {
<span class="nc" id="L89">          HttpPut httpPut = new HttpPut(location);</span>
<span class="nc" id="L90">          httpPut.setHeader(HttpHeaders.CONTENT_TYPE, contentType);</span>
<span class="nc" id="L91">          FileEntity entity = new FileEntity(file);</span>
<span class="nc" id="L92">          httpPut.setEntity(entity);</span>
<span class="nc" id="L93">          putResponse = httpClient.execute(httpPut);</span>
<span class="nc" id="L94">          int putCode = putResponse.getStatusLine().getStatusCode();</span>

<span class="nc bnc" id="L96" title="All 2 branches missed.">          switch (putCode) {</span>
            case HttpStatus.SC_OK: // 200
            case HttpStatus.SC_CREATED: // 201
<span class="nc" id="L99">              logger.info(&quot;File {} uploaded to Google Storage&quot;, mpId + &quot;.&quot; + fileExtension);</span>
<span class="nc" id="L100">              return putCode;</span>
            default:
<span class="nc" id="L102">              logger.warn(&quot;Unable to upload file to Google Storage, returned code: {}.&quot;, putCode);</span>
<span class="nc" id="L103">              return putCode;</span>
          }
<span class="nc" id="L105">        } catch (Exception e) {</span>
<span class="nc" id="L106">          logger.warn(&quot;Exception when uploading file to Google Storage&quot;, e);</span>
<span class="nc" id="L107">        }</span>
      } else {
<span class="nc" id="L109">        logger.warn(&quot;Uploading file to Google Storage failed and returned, status: {}.&quot;, postCode);</span>
<span class="nc" id="L110">        return postCode;</span>
      }
<span class="nc" id="L112">    } catch (Exception e) {</span>
<span class="nc" id="L113">      logger.warn(&quot;Exception when uploading file to Google Storage&quot;, e);</span>
    } finally {
      try {
<span class="fc" id="L116">        httpClient.close();</span>
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">        if (postResponse != null) {</span>
<span class="fc" id="L118">          postResponse.close();</span>
        }
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">        if (putResponse != null) {</span>
<span class="nc" id="L121">          putResponse.close();</span>
        }
<span class="nc" id="L123">      } catch (IOException e) {</span>
<span class="fc" id="L124">      }</span>
    }
<span class="nc" id="L126">    return DEFAULT_CODE;</span>
  }

  /**
   * Delete file from Google Cloud Storage using json API.
   * https://cloud.google.com/storage/docs/deleting-objects
   *
   * @param httpClient
   * @param bucket
   * @param objectName
   * @param accessToken
   * @throws java.io.IOException
   */
  public void deleteGoogleStorageFile(
      CloseableHttpClient httpClient,
      String bucket,
      String objectName,
      String accessToken
  ) throws IOException {
<span class="fc" id="L145">    CloseableHttpResponse response = null;</span>
    try {
<span class="fc" id="L147">      HttpDelete httpdelete = new HttpDelete(GOOGLE_STORAGE_MEDIA + String.format(&quot;%s/o/%s&quot;, bucket, objectName));</span>
<span class="fc" id="L148">      logger.debug(&quot;Url to delete media file from Google Cloud Storage : {}&quot;, httpdelete.getURI().toString());</span>
<span class="fc" id="L149">      httpdelete.addHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + accessToken); // add the authorization header to the request;</span>
<span class="fc" id="L150">      response = httpClient.execute(httpdelete);</span>
<span class="fc" id="L151">      int code = response.getStatusLine().getStatusCode();</span>

<span class="pc bpc" id="L153" title="1 of 2 branches missed.">      switch (code) {</span>
        case HttpStatus.SC_NO_CONTENT: // 204
<span class="fc" id="L155">          logger.info(&quot;Media file: {} deleted from Google storage&quot;, objectName);</span>
<span class="fc" id="L156">          break;</span>
        default:
<span class="nc" id="L158">          logger.warn(&quot;Unable to delete meida file: {} from Google Storage&quot;, objectName);</span>
          break;
      }
<span class="nc" id="L161">    } catch (Exception e) {</span>
<span class="nc" id="L162">      logger.warn(&quot;Unable to delete meida file: {} from Google Storage&quot;, objectName, e);</span>
    } finally {
      try {
<span class="fc" id="L165">        httpClient.close();</span>
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">        if (response != null) {</span>
<span class="fc" id="L167">          response.close();</span>
        }
<span class="nc" id="L169">      } catch (IOException e) {</span>
<span class="fc" id="L170">      }</span>
    }
<span class="fc" id="L172">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>