<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>WhisperEngine.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-speech-to-text-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.speechtotext.impl.engine</a> &gt; <span class="el_source">WhisperEngine.java</span></div><h1>WhisperEngine.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.speechtotext.impl.engine;

import org.opencastproject.speechtotext.api.SpeechToTextEngine;
import org.opencastproject.speechtotext.api.SpeechToTextEngineException;
import org.opencastproject.speechtotext.util.LangCodeUtil;
import org.opencastproject.util.OsgiUtil;
import org.opencastproject.util.data.Option;

import org.apache.commons.io.FilenameUtils;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Modified;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.InputStreamReader;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Objects;
import java.util.regex.Pattern;

/** Whisper implementation of the Speech-to-text engine interface. */
@Component(
    property = {
        &quot;service.description=Whisper implementation of the SpeechToTextEngine interface&quot;,
        &quot;enginetype=whisper&quot;
    }
)

<span class="nc" id="L58">public class WhisperEngine implements SpeechToTextEngine {</span>

<span class="nc" id="L60">  private static final Logger logger = LoggerFactory.getLogger(WhisperEngine.class);</span>

  /** Name of the engine. */
  private static final String engineName = &quot;Whisper&quot;;

  /** Config key for setting the path to Whisper. */
  private static final String WHISPER_EXECUTABLE_PATH_CONFIG_KEY = &quot;whisper.root.path&quot;;

  /** Default path to Whisper. */
  public static final String WHISPER_EXECUTABLE_DEFAULT_PATH = &quot;whisper&quot;;

  /** Currently used path of the Whisper installation. */
<span class="nc" id="L72">  private String whisperExecutable = WHISPER_EXECUTABLE_DEFAULT_PATH;</span>

  /** Config key for setting whisper model */
  private static final String WHISPER_MODEL_CONFIG_KEY = &quot;whisper.model&quot;;

  /** Default whisper model */
  public static final String WHISPER_MODEL_DEFAULT = &quot;base&quot;;

  /** Currently used whisper model */
<span class="nc" id="L81">  private String whisperModel = WHISPER_MODEL_DEFAULT;</span>

  /** Config key for quantization */
  private static final String WHISPER_QUANTIZATION = &quot;whisper.quantization&quot;;

  private String quantization;

  /** Config key for Voice Activity Detection */
  private static final String WHISPER_VAD = &quot;whisper.vad_enabled&quot;;

  /** Enable Voice Activity Detection for whisper-ctranslate2 */
<span class="nc" id="L92">  private Option&lt;Boolean&gt; isVADEnabled = Option.none();</span>

  /** Pattern for whisper output. Searches for timestamps like this for example: [00:00.000 --&gt; 00:06.000] */
<span class="nc" id="L95">  private final Pattern outputPattern = Pattern.compile(&quot;\\[\\d{2}:\\d{2}.\\d{3} --&gt; \\d{2}:\\d{2}.\\d{3}]&quot;);</span>

  /** Config key for additional Whisper args */
  private static final String WHISPER_ARGS_CONFIG_KEY = &quot;whisper.args&quot;;

  /** Currently used Whisper args */
  private String[] whisperArgs;

  @Override
  public String getEngineName() {
<span class="nc" id="L105">    return engineName;</span>
  }

  @Activate
  @Modified
  public void activate(ComponentContext cc) {
<span class="nc" id="L111">    var prop = cc.getProperties();</span>
<span class="nc" id="L112">    logger.debug(&quot;Activated/Modified Whisper engine service&quot;);</span>
<span class="nc" id="L113">    whisperExecutable = Objects.toString(prop.get(WHISPER_EXECUTABLE_PATH_CONFIG_KEY), WHISPER_EXECUTABLE_DEFAULT_PATH);</span>
<span class="nc" id="L114">    logger.debug(&quot;Set Whisper path to {}&quot;, whisperExecutable);</span>

<span class="nc" id="L116">    whisperModel = Objects.toString(prop.get(WHISPER_MODEL_CONFIG_KEY), WHISPER_MODEL_DEFAULT);</span>
<span class="nc" id="L117">    logger.debug(&quot;Whisper model set to {}&quot;, whisperModel);</span>

<span class="nc" id="L119">    quantization = Objects.toString(prop.get(WHISPER_QUANTIZATION), null);</span>
<span class="nc" id="L120">    logger.debug(&quot;Whisper quantization set to {}&quot;, quantization);</span>

<span class="nc" id="L122">    isVADEnabled = OsgiUtil.getOptCfgAsBoolean(prop, WHISPER_VAD);</span>
<span class="nc" id="L123">    logger.debug(&quot;Whisper Voice Activity Detection set to {}&quot;, isVADEnabled.getOrElse(false));</span>

<span class="nc" id="L125">    whisperArgs = Objects.toString(prop.get(WHISPER_ARGS_CONFIG_KEY), &quot;&quot;).trim().split(&quot;\\s+&quot;);</span>
<span class="nc" id="L126">    logger.debug(&quot;Additional args for Whisper: {}&quot;, (Object) whisperArgs);</span>

<span class="nc" id="L128">    logger.debug(&quot;Finished activating/updating speech-to-text service&quot;);</span>
<span class="nc" id="L129">  }</span>

  //TODO: Add method for language detection

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.speechtotext.api.SpeechToTextEngine#generateSubtitlesFile(File, File, String, Boolean)
   */

  @Override
  public Result generateSubtitlesFile(File mediaFile,
      File workingDirectory, String language, Boolean translate)
          throws SpeechToTextEngineException {

<span class="nc" id="L144">    String[] baseCommands = { whisperExecutable,</span>
<span class="nc" id="L145">    mediaFile.getAbsolutePath(),</span>
        &quot;--model&quot;, whisperModel,
<span class="nc" id="L147">        &quot;--output_dir&quot;, workingDirectory.getAbsolutePath()};</span>

<span class="nc" id="L149">    List&lt;String&gt; transcriptionCommand = new ArrayList&lt;&gt;(Arrays.asList(baseCommands));</span>

<span class="nc bnc" id="L151" title="All 2 branches missed.">    if (translate) {</span>
<span class="nc" id="L152">      transcriptionCommand.add(&quot;--task&quot;);</span>
<span class="nc" id="L153">      transcriptionCommand.add(&quot;translate&quot;);</span>
<span class="nc" id="L154">      logger.debug(&quot;Translation enabled&quot;);</span>
<span class="nc" id="L155">      language = &quot;en&quot;;</span>
    }

<span class="nc bnc" id="L158" title="All 4 branches missed.">    if (!language.isBlank() &amp;&amp; !translate) {</span>
      // get 2-letter language code
<span class="nc" id="L160">      language = LangCodeUtil.iso3ToIso2(language, &quot;&quot;);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">      if (language.isBlank()) {</span>
<span class="nc" id="L162">        logger.warn(&quot;No 2-letter language code found, using language auto detection&quot;);</span>
      } else {
<span class="nc" id="L164">        logger.debug(&quot;Using language {} from workflows&quot;, language);</span>
<span class="nc" id="L165">        transcriptionCommand.add(&quot;--language&quot;);</span>
<span class="nc" id="L166">        transcriptionCommand.add(language);</span>
      }
    }

<span class="nc bnc" id="L170" title="All 2 branches missed.">    if (quantization != null) {</span>
<span class="nc" id="L171">      logger.debug(&quot;Using quantization {}&quot;, quantization);</span>
<span class="nc" id="L172">      transcriptionCommand.add(&quot;--compute_type&quot;);</span>
<span class="nc" id="L173">      transcriptionCommand.add(quantization);</span>
    }

<span class="nc bnc" id="L176" title="All 2 branches missed.">    if (isVADEnabled.isSome()) {</span>
<span class="nc" id="L177">      logger.debug(&quot;Setting VAD to {}&quot;, isVADEnabled.get());</span>
<span class="nc" id="L178">      transcriptionCommand.add(&quot;--vad_filter&quot;);</span>
<span class="nc" id="L179">      transcriptionCommand.add(isVADEnabled.get().toString());</span>
    }

<span class="nc" id="L182">    transcriptionCommand.addAll(Arrays.asList(whisperArgs));</span>

<span class="nc" id="L184">    logger.info(&quot;Executing Whisper's transcription command: {}&quot;, transcriptionCommand);</span>

<span class="nc" id="L186">    Process transcriptonProcess = null;</span>
    File output;

    try {
<span class="nc" id="L190">      ProcessBuilder processBuilder = new ProcessBuilder(transcriptionCommand);</span>
<span class="nc" id="L191">      processBuilder.redirectInput(ProcessBuilder.Redirect.PIPE)</span>
<span class="nc" id="L192">          .redirectOutput(ProcessBuilder.Redirect.PIPE)</span>
<span class="nc" id="L193">          .redirectError(ProcessBuilder.Redirect.PIPE);</span>
<span class="nc" id="L194">      processBuilder.redirectErrorStream(true);</span>
<span class="nc" id="L195">      transcriptonProcess = processBuilder.start();</span>

<span class="nc" id="L197">      try (BufferedReader in = new BufferedReader(new InputStreamReader(transcriptonProcess.getInputStream()))) {</span>
        String line;
<span class="nc bnc" id="L199" title="All 2 branches missed.">        while ((line = in.readLine()) != null) { // consume process output</span>
<span class="nc" id="L200">          logger.debug(line);</span>
        }
      }

      // wait until the task is finished
<span class="nc" id="L205">      int exitCode = transcriptonProcess.waitFor();</span>
<span class="nc" id="L206">      logger.debug(&quot;Whisper process finished with exit code {}&quot;, exitCode);</span>

<span class="nc bnc" id="L208" title="All 2 branches missed.">      if (exitCode != 0) {</span>
<span class="nc" id="L209">        throw new SpeechToTextEngineException(</span>
<span class="nc" id="L210">            String.format(&quot;Whisper exited abnormally with status %d (command: %s)&quot;, exitCode, transcriptionCommand));</span>
      }

      // Renaming output whisper filename to the expected output filename
<span class="nc" id="L214">      String outputFileName = FilenameUtils.getBaseName(mediaFile.getAbsolutePath()) + &quot;.vtt&quot;;</span>
<span class="nc" id="L215">      output = new File(workingDirectory, outputFileName);</span>
<span class="nc" id="L216">      logger.debug(&quot;Whisper output file {}&quot;, output);</span>

<span class="nc bnc" id="L218" title="All 2 branches missed.">      if (!output.isFile()) {</span>
<span class="nc" id="L219">        throw new SpeechToTextEngineException(&quot;Whisper produced no output&quot;);</span>
      }
<span class="nc" id="L221">      logger.info(&quot;Subtitles file generated successfully: {}&quot;, output);</span>
<span class="nc" id="L222">    } catch (Exception e) {</span>
<span class="nc" id="L223">      logger.debug(&quot;Transcription failed closing Whisper transcription process for: {}&quot;, mediaFile);</span>
<span class="nc" id="L224">      throw new SpeechToTextEngineException(e);</span>
    } finally {
<span class="nc bnc" id="L226" title="All 2 branches missed.">      if (transcriptonProcess != null) {</span>
<span class="nc" id="L227">        transcriptonProcess.destroy();</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">        if (transcriptonProcess.isAlive()) {</span>
<span class="nc" id="L229">          transcriptonProcess.destroyForcibly();</span>
        }
      }
    }

    // Detect language if not set
<span class="nc bnc" id="L235" title="All 2 branches missed.">    if (language.isBlank()) {</span>
<span class="nc" id="L236">      var jsonFile = FilenameUtils.removeExtension(output.getAbsolutePath()) + &quot;.json&quot;;</span>
<span class="nc" id="L237">      var jsonParser = new JSONParser();</span>
      try {
<span class="nc" id="L239">        FileReader reader = new FileReader(jsonFile);</span>
<span class="nc" id="L240">        Object obj = jsonParser.parse(reader);</span>
<span class="nc" id="L241">        JSONObject jsonObject = (JSONObject) obj;</span>
<span class="nc" id="L242">        language = (String) jsonObject.get(&quot;language&quot;);</span>
        // convert language name to iso3 if necessary or take default
<span class="nc" id="L244">        language = LangCodeUtil.getIso2FromLang(language, language);</span>
<span class="nc" id="L245">        logger.debug(&quot;Language detected by Whisper: {}&quot;, language);</span>
<span class="nc" id="L246">      } catch (Exception e) {</span>
<span class="nc" id="L247">        logger.debug(&quot;Error reading Whisper JSON file for: {}&quot;, mediaFile);</span>
<span class="nc" id="L248">        throw new SpeechToTextEngineException(e);</span>
<span class="nc" id="L249">      }</span>
    }

<span class="nc" id="L252">    return new Result(language, output);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>