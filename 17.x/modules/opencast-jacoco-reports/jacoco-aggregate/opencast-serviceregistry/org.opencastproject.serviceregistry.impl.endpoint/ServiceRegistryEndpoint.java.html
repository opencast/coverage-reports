<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ServiceRegistryEndpoint.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-serviceregistry</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.serviceregistry.impl.endpoint</a> &gt; <span class="el_source">ServiceRegistryEndpoint.java</span></div><h1>ServiceRegistryEndpoint.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.serviceregistry.impl.endpoint;

import static javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;
import static javax.servlet.http.HttpServletResponse.SC_CREATED;
import static javax.servlet.http.HttpServletResponse.SC_NOT_FOUND;
import static javax.servlet.http.HttpServletResponse.SC_NO_CONTENT;
import static javax.servlet.http.HttpServletResponse.SC_OK;
import static javax.servlet.http.HttpServletResponse.SC_SERVICE_UNAVAILABLE;
import static org.apache.commons.lang3.StringUtils.isBlank;
import static org.apache.commons.lang3.StringUtils.isNotBlank;

import org.opencastproject.job.api.JaxbJob;
import org.opencastproject.job.api.JaxbJobList;
import org.opencastproject.job.api.Job;
import org.opencastproject.job.api.JobParser;
import org.opencastproject.rest.RestConstants;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.serviceregistry.api.HostRegistration;
import org.opencastproject.serviceregistry.api.JaxbHostRegistration;
import org.opencastproject.serviceregistry.api.JaxbHostRegistrationList;
import org.opencastproject.serviceregistry.api.JaxbServiceHealth;
import org.opencastproject.serviceregistry.api.JaxbServiceRegistration;
import org.opencastproject.serviceregistry.api.JaxbServiceRegistrationList;
import org.opencastproject.serviceregistry.api.JaxbServiceStatisticsList;
import org.opencastproject.serviceregistry.api.ServiceRegistration;
import org.opencastproject.serviceregistry.api.ServiceRegistry;
import org.opencastproject.serviceregistry.api.ServiceRegistryException;
import org.opencastproject.serviceregistry.api.ServiceState;
import org.opencastproject.serviceregistry.api.SystemLoad;
import org.opencastproject.serviceregistry.impl.ServiceRegistryJpaImpl;
import org.opencastproject.systems.OpencastConstants;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.UrlSupport;
import org.opencastproject.util.doc.rest.RestParameter;
import org.opencastproject.util.doc.rest.RestParameter.Type;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestResponse;
import org.opencastproject.util.doc.rest.RestService;

import org.apache.commons.lang3.StringUtils;
import org.json.simple.JSONArray;
import org.json.simple.JSONValue;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.jaxrs.whiteboard.propertytypes.JaxrsResource;

import java.net.MalformedURLException;
import java.net.URL;
import java.util.Arrays;
import java.util.Collections;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.DELETE;
import javax.ws.rs.FormParam;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.PUT;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.WebApplicationException;
import javax.ws.rs.core.Context;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.Response.Status;

/**
 * Displays hosts and the service IDs they provide.
 */
@Path(&quot;/services&quot;)
@RestService(name = &quot;serviceregistry&quot;, title = &quot;Service Registry&quot;, notes = { &quot;All paths above are relative to the REST endpoint base&quot; }, abstractText = &quot;Provides registration and management functions for servers and services in this Opencast instance or cluster.&quot;)
@Component(
  property = {
    &quot;service.description=Service Registry REST Endpoint&quot;,
    &quot;opencast.service.type=org.opencastproject.serviceregistry&quot;,
    &quot;opencast.service.path=/services&quot;
  },
  immediate = true,
  service = { ServiceRegistryEndpoint.class }
)
@JaxrsResource
<span class="nc" id="L110">public class ServiceRegistryEndpoint {</span>

  /** The remote service maanger */
<span class="nc" id="L113">  protected ServiceRegistry serviceRegistry = null;</span>

<span class="nc" id="L115">  private SecurityService securityService = null;</span>

  /** This server's URL */
<span class="nc" id="L118">  protected String serverUrl = UrlSupport.DEFAULT_BASE_URL;</span>

  /** The service path for this endpoint */
<span class="nc" id="L121">  protected String servicePath = &quot;/&quot;;</span>

  /** Sets the service registry instance for delegation */
  @Reference
  public void setServiceRegistry(ServiceRegistry serviceRegistry) {
<span class="nc" id="L126">    this.serviceRegistry = serviceRegistry;</span>
<span class="nc" id="L127">  }</span>

  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="nc" id="L131">    this.securityService = securityService;</span>
<span class="nc" id="L132">  }</span>

  /**
   * Callback from OSGi that is called when this service is activated.
   *
   * @param cc
   *          OSGi component context
   */
  @Activate
  public void activate(ComponentContext cc) {
<span class="nc" id="L142">    serverUrl = cc.getBundleContext().getProperty(OpencastConstants.SERVER_URL_PROPERTY);</span>
<span class="nc" id="L143">    servicePath = (String) cc.getProperties().get(RestConstants.SERVICE_PATH_PROPERTY);</span>
<span class="nc" id="L144">  }</span>

  @GET
  @Path(&quot;statistics.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;statisticsasjson&quot;, description = &quot;List the service registrations in the cluster, along with some simple statistics&quot;, returnDescription = &quot;The service statistics.&quot;, responses = { @RestResponse(responseCode = SC_OK, description = &quot;A JSON representation of the service statistics&quot;) })
  public Response getStatisticsAsJson() {
    try {
<span class="nc" id="L152">      return Response.ok(new JaxbServiceStatisticsList(serviceRegistry.getServiceStatistics())).build();</span>
<span class="nc" id="L153">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L154">      throw new WebApplicationException(e, Response.Status.INTERNAL_SERVER_ERROR);</span>
    }
  }

  @GET
  @Path(&quot;statistics.xml&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(name = &quot;statisticsasxml&quot;, description = &quot;List the service registrations in the cluster, along with some simple statistics&quot;, returnDescription = &quot;The service statistics.&quot;, responses = { @RestResponse(responseCode = SC_OK, description = &quot;An XML representation of the service statistics&quot;) })
  public Response getStatisticsAsXml() throws ServiceRegistryException {
<span class="nc" id="L163">    return getStatisticsAsJson();</span>
  }

  @POST
  @Path(&quot;sanitize&quot;)
  @RestQuery(name = &quot;sanitize&quot;, description = &quot;Sets the given service to NORMAL state&quot;, returnDescription = &quot;No content&quot;, restParameters = {
          @RestParameter(name = &quot;serviceType&quot;, isRequired = true, description = &quot;The service type identifier&quot;, type = Type.STRING, defaultValue = &quot;&quot;),
          @RestParameter(name = &quot;host&quot;, isRequired = true, description = &quot;The host providing the service, including the http(s) protocol&quot;, type = Type.STRING, defaultValue = &quot;&quot;) }, responses = {
          @RestResponse(responseCode = SC_NO_CONTENT, description = &quot;The service was successfully sanitized&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No service of that type on that host is registered.&quot;) })
  public Response sanitize(@FormParam(&quot;serviceType&quot;) String serviceType, @FormParam(&quot;host&quot;) String host)
          throws NotFoundException {
<span class="nc" id="L175">    serviceRegistry.sanitize(serviceType, host);</span>
<span class="nc" id="L176">    return Response.status(Status.NO_CONTENT).build();</span>
  }

  @POST
  @Path(&quot;register&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(name = &quot;register&quot;, description = &quot;Add a new service registration to the cluster.&quot;, returnDescription = &quot;The service registration.&quot;, restParameters = {
          @RestParameter(name = &quot;serviceType&quot;, isRequired = true, description = &quot;The service type identifier&quot;, type = Type.STRING, defaultValue = &quot;&quot;),
          @RestParameter(name = &quot;host&quot;, isRequired = true, description = &quot;The host providing the service, including the http(s) protocol&quot;, type = Type.STRING, defaultValue = &quot;&quot;),
          @RestParameter(name = &quot;path&quot;, isRequired = true, description = &quot;The service path on the host&quot;, type = Type.STRING, defaultValue = &quot;&quot;),
          @RestParameter(name = &quot;jobProducer&quot;, isRequired = true, description = &quot;Whether this service is a producer of long running jobs requiring dispatch&quot;, type = Type.STRING, defaultValue = &quot;false&quot;) }, responses = { @RestResponse(responseCode = SC_OK, description = &quot;An XML representation of the new service registration&quot;) })
  public JaxbServiceRegistration register(@FormParam(&quot;serviceType&quot;) String serviceType, @FormParam(&quot;host&quot;) String host,
          @FormParam(&quot;path&quot;) String path, @FormParam(&quot;jobProducer&quot;) boolean jobProducer) {
    try {
<span class="nc" id="L190">      return new JaxbServiceRegistration(serviceRegistry.registerService(serviceType, host, path, jobProducer));</span>
<span class="nc" id="L191">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L192">      throw new WebApplicationException(e);</span>
    }
  }

  @POST
  @Path(&quot;unregister&quot;)
  @RestQuery(name = &quot;unregister&quot;, description = &quot;Removes a service registration.&quot;, returnDescription = &quot;No content&quot;, restParameters = {
          @RestParameter(name = &quot;serviceType&quot;, isRequired = true, description = &quot;The service type identifier&quot;, type = Type.STRING),
          @RestParameter(name = &quot;host&quot;, isRequired = true, description = &quot;The host providing the service, including the http(s) protocol&quot;, type = Type.STRING) }, responses = { @RestResponse(responseCode = SC_NO_CONTENT, description = &quot;The service was unregistered successfully&quot;) })
  public Response unregister(@FormParam(&quot;serviceType&quot;) String serviceType, @FormParam(&quot;host&quot;) String host) {
    try {
<span class="nc" id="L203">      serviceRegistry.unRegisterService(serviceType, host);</span>
<span class="nc" id="L204">      return Response.status(Status.NO_CONTENT).build();</span>
<span class="nc" id="L205">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L206">      throw new WebApplicationException(e);</span>
    }
  }

  @POST
  @Path(&quot;enablehost&quot;)
  @RestQuery(name = &quot;enablehost&quot;, description = &quot;Enable a server from the cluster.&quot;, returnDescription = &quot;No content.&quot;, restParameters = { @RestParameter(name = &quot;host&quot;, isRequired = true, description = &quot;The host name, including the http(s) protocol&quot;, type = Type.STRING) }, responses = {
          @RestResponse(responseCode = SC_NO_CONTENT, description = &quot;The host was enabled successfully&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;The host does not exist&quot;) })
  public Response enableHost(@FormParam(&quot;host&quot;) String host) throws NotFoundException {
    try {
<span class="nc" id="L217">      serviceRegistry.enableHost(host);</span>
<span class="nc" id="L218">      return Response.status(Status.NO_CONTENT).build();</span>
<span class="nc" id="L219">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L220">      throw new WebApplicationException(e);</span>
    }
  }

  @POST
  @Path(&quot;disablehost&quot;)
  @RestQuery(name = &quot;disablehost&quot;, description = &quot;Disable a server from the cluster.&quot;, returnDescription = &quot;No content.&quot;, restParameters = { @RestParameter(name = &quot;host&quot;, isRequired = true, description = &quot;The host name, including the http(s) protocol&quot;, type = Type.STRING) }, responses = {
          @RestResponse(responseCode = SC_NO_CONTENT, description = &quot;The host was disabled successfully&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;The host does not exist&quot;) })
  public Response disableHost(@FormParam(&quot;host&quot;) String host) throws NotFoundException {
    try {
<span class="nc" id="L231">      serviceRegistry.disableHost(host);</span>
<span class="nc" id="L232">      return Response.status(Status.NO_CONTENT).build();</span>
<span class="nc" id="L233">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L234">      throw new WebApplicationException(e);</span>
    }
  }

  @POST
  @Path(&quot;registerhost&quot;)
  @RestQuery(name = &quot;registerhost&quot;, description = &quot;Add a new server to the cluster.&quot;, returnDescription = &quot;No content.&quot;, restParameters = {
          @RestParameter(name = &quot;host&quot;, isRequired = true, description = &quot;The host name, including the http(s) protocol&quot;, type = Type.STRING),
          @RestParameter(name = &quot;address&quot;, isRequired = true, description = &quot;The IP address&quot;, type = Type.STRING),
          @RestParameter(name = &quot;nodeName&quot;, isRequired = true, description = &quot;Descriptive node name&quot;, type = Type.STRING),
          @RestParameter(name = &quot;memory&quot;, isRequired = true, description = &quot;The allocated memory&quot;, type = Type.STRING),
          @RestParameter(name = &quot;cores&quot;, isRequired = true, description = &quot;The available cores&quot;, type = Type.STRING),
          @RestParameter(name = &quot;maxLoad&quot;, isRequired = true, description = &quot;The maximum load this host support&quot;, type = Type.STRING) }, responses = { @RestResponse(responseCode = SC_NO_CONTENT, description = &quot;The host was registered successfully&quot;) })
  public void register(@FormParam(&quot;host&quot;) String host, @FormParam(&quot;address&quot;) String address, @FormParam(&quot;nodeName&quot;) String nodeName,
          @FormParam(&quot;memory&quot;) long memory, @FormParam(&quot;cores&quot;) int cores, @FormParam(&quot;maxLoad&quot;) float maxLoad) {
    try {
<span class="nc" id="L250">      serviceRegistry.registerHost(host, address, nodeName, memory, cores, maxLoad);</span>
<span class="nc" id="L251">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L252">      throw new WebApplicationException(e);</span>
<span class="nc" id="L253">    }</span>
<span class="nc" id="L254">  }</span>

  @POST
  @Path(&quot;unregisterhost&quot;)
  @RestQuery(name = &quot;unregisterhost&quot;, description = &quot;Removes a server from the cluster.&quot;,
          returnDescription = &quot;No content.&quot;,
          restParameters = {
          @RestParameter(name = &quot;host&quot;, isRequired = true, description = &quot;The host name, including the http(s) protocol&quot;, type = Type.STRING)
          }, responses = {
          @RestResponse(responseCode = SC_NO_CONTENT, description = &quot;The host was removed successfully&quot;) })
  public Response unregister(@FormParam(&quot;host&quot;) String host) {
    try {
<span class="nc" id="L266">      serviceRegistry.unregisterHost(host);</span>
<span class="nc" id="L267">      return Response.status(Status.NO_CONTENT).build();</span>
<span class="nc" id="L268">    } catch (ServiceRegistryException e) {</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">      if (e.getCause() instanceof IllegalArgumentException) {</span>
<span class="nc" id="L270">        return Response.status(Status.NOT_FOUND).entity(e.getMessage()).build();</span>
      }
<span class="nc" id="L272">      throw new WebApplicationException(e);</span>
    }
  }

  @POST
  @Path(&quot;maintenance&quot;)
  @RestQuery(name = &quot;maintenance&quot;, description = &quot;Sets the maintenance status for a server in the cluster.&quot;, returnDescription = &quot;No content.&quot;, restParameters = {
          @RestParameter(name = &quot;host&quot;, isRequired = true, type = Type.STRING, description = &quot;The host name, including the http(s) protocol&quot;),
          @RestParameter(name = &quot;maintenance&quot;, isRequired = true, type = Type.BOOLEAN, description = &quot;Whether this host should be put into maintenance mode (true) or not&quot;) }, responses = {
          @RestResponse(responseCode = SC_NO_CONTENT, description = &quot;The host was registered successfully&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;Host not found&quot;) })
  public Response setMaintenanceMode(@FormParam(&quot;host&quot;) String host, @FormParam(&quot;maintenance&quot;) boolean maintenance)
          throws NotFoundException {
    try {
<span class="nc" id="L286">      serviceRegistry.setMaintenanceStatus(host, maintenance);</span>
<span class="nc" id="L287">      return Response.status(Status.NO_CONTENT).build();</span>
<span class="nc" id="L288">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L289">      throw new WebApplicationException(e);</span>
    }
  }

  @GET
  @Path(&quot;available.xml&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(name = &quot;availableasxml&quot;, description = &quot;Lists available services by service type identifier, ordered by load.&quot;, returnDescription = &quot;The services list as XML&quot;, restParameters = { @RestParameter(name = &quot;serviceType&quot;, isRequired = false, type = Type.STRING, description = &quot;The service type identifier&quot;) }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Returned the available services.&quot;),
          @RestResponse(responseCode = SC_BAD_REQUEST, description = &quot;No service type specified, bad request.&quot;) })
  public Response getAvailableServicesAsXml(@QueryParam(&quot;serviceType&quot;) String serviceType) {

<span class="nc bnc" id="L301" title="All 2 branches missed.">    if (isBlank(serviceType))</span>
<span class="nc" id="L302">      throw new WebApplicationException(Response.status(Status.BAD_REQUEST).entity(&quot;Service type must be specified&quot;)</span>
<span class="nc" id="L303">              .build());</span>

<span class="nc" id="L305">    Map&lt;String, String&gt; properties = securityService.getOrganization().getProperties();</span>

<span class="nc" id="L307">    JaxbServiceRegistrationList registrations = new JaxbServiceRegistrationList();</span>
    try {
<span class="nc bnc" id="L309" title="All 2 branches missed.">      for (ServiceRegistration reg : serviceRegistry.getServiceRegistrationsByLoad(serviceType)) {</span>
<span class="nc" id="L310">        JaxbServiceRegistration jaxbReg = new JaxbServiceRegistration(reg);</span>
<span class="nc" id="L311">        URL internalHostUrl = new URL(jaxbReg.getHost());</span>
<span class="nc" id="L312">        String tenantSpecificHost = StringUtils.trimToNull(properties.get(&quot;org.opencastproject.host.&quot; + internalHostUrl.getHost()));</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">        if (StringUtils.isNotBlank(tenantSpecificHost)) {</span>
<span class="nc" id="L314">          jaxbReg.setHost(tenantSpecificHost);</span>
        }
<span class="nc" id="L316">        registrations.add(jaxbReg);</span>
<span class="nc" id="L317">      }</span>
<span class="nc" id="L318">      return Response.ok(registrations).build();</span>
<span class="nc" id="L319">    } catch (ServiceRegistryException | MalformedURLException e) {</span>
<span class="nc" id="L320">      throw new WebApplicationException(e);</span>
    }
  }

  @GET
  @Path(&quot;available.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;availableasjson&quot;, description = &quot;Lists available services by service type identifier, ordered by load.&quot;, returnDescription = &quot;The services list as JSON&quot;, restParameters = { @RestParameter(name = &quot;serviceType&quot;, isRequired = false, type = Type.STRING, description = &quot;The service type identifier&quot;) }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Returned the available services.&quot;),
          @RestResponse(responseCode = SC_BAD_REQUEST, description = &quot;No service type specified, bad request.&quot;) })
  public Response getAvailableServicesAsJson(@QueryParam(&quot;serviceType&quot;) String serviceType) {
<span class="nc" id="L331">    return getAvailableServicesAsXml(serviceType);</span>
  }

  @GET
  @Path(&quot;health.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;health&quot;, description = &quot;Checks the status of the registered services&quot;, returnDescription = &quot;Returns NO_CONTENT if services are in a proper state&quot;, restParameters = {
          @RestParameter(name = &quot;serviceType&quot;, isRequired = false, type = Type.STRING, description = &quot;The service type identifier&quot;),
          @RestParameter(name = &quot;host&quot;, isRequired = false, type = Type.STRING, description = &quot;The host, including the http(s) protocol&quot;) }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Service states returned&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No service of that type on that host is registered.&quot;),
          @RestResponse(responseCode = SC_SERVICE_UNAVAILABLE, description = &quot;An error has occurred during stats processing&quot;) })
  public Response getHealthStatusAsJson(@QueryParam(&quot;serviceType&quot;) String serviceType, @QueryParam(&quot;host&quot;) String host)
          throws NotFoundException {
<span class="nc" id="L345">    return getHealthStatus(serviceType, host);</span>
  }

  @GET
  @Path(&quot;health.xml&quot;)
  @Produces(MediaType.APPLICATION_XML)
  @RestQuery(name = &quot;health&quot;, description = &quot;Checks the status of the registered services&quot;, returnDescription = &quot;Returns NO_CONTENT if services are in a proper state&quot;, restParameters = {
          @RestParameter(name = &quot;serviceType&quot;, isRequired = false, type = Type.STRING, description = &quot;The service type identifier&quot;),
          @RestParameter(name = &quot;host&quot;, isRequired = false, type = Type.STRING, description = &quot;The host, including the http(s) protocol&quot;) }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Service states returned&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No service of that type on that host is registered.&quot;),
          @RestResponse(responseCode = SC_SERVICE_UNAVAILABLE, description = &quot;An error has occurred during stats processing&quot;) })
  public Response getHealthStatus(@QueryParam(&quot;serviceType&quot;) String serviceType, @QueryParam(&quot;host&quot;) String host)
          throws NotFoundException {
    try {
<span class="nc" id="L360">      List&lt;ServiceRegistration&gt; services = null;</span>
<span class="nc bnc" id="L361" title="All 4 branches missed.">      if (isNotBlank(serviceType) &amp;&amp; isNotBlank(host)) {</span>
        // This is a request for one specific service. Return it, or SC_NOT_FOUND if not found
<span class="nc" id="L363">        ServiceRegistration reg = serviceRegistry.getServiceRegistration(serviceType, host);</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">        if (reg == null)</span>
<span class="nc" id="L365">          throw new NotFoundException();</span>

<span class="nc" id="L367">        services = new LinkedList&lt;ServiceRegistration&gt;();</span>
<span class="nc" id="L368">        services.add(reg);</span>
<span class="nc bnc" id="L369" title="All 4 branches missed.">      } else if (isBlank(serviceType) &amp;&amp; isBlank(host)) {</span>
        // This is a request for all service registrations
<span class="nc" id="L371">        services = serviceRegistry.getServiceRegistrations();</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">      } else if (isNotBlank(serviceType)) {</span>
        // This is a request for all service registrations of a particular type
<span class="nc" id="L374">        services = serviceRegistry.getServiceRegistrationsByType(serviceType);</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">      } else if (isNotBlank(host)) {</span>
        // This is a request for all service registrations of a particular host
<span class="nc" id="L377">        services = serviceRegistry.getServiceRegistrationsByHost(host);</span>
      }

<span class="nc" id="L380">      int healthy = 0;</span>
<span class="nc" id="L381">      int warning = 0;</span>
<span class="nc" id="L382">      int error = 0;</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">      for (ServiceRegistration reg : services) {</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">        if (ServiceState.NORMAL == reg.getServiceState()) {</span>
<span class="nc" id="L385">          healthy++;</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">        } else if (ServiceState.WARNING == reg.getServiceState()) {</span>
<span class="nc" id="L387">          warning++;</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">        } else if (ServiceState.ERROR == reg.getServiceState()) {</span>
<span class="nc" id="L389">          error++;</span>
        } else {
<span class="nc" id="L391">           error++;</span>
        }
<span class="nc" id="L393">      }</span>
<span class="nc" id="L394">      JaxbServiceHealth stats = new JaxbServiceHealth(healthy, warning, error);</span>
<span class="nc" id="L395">      return Response.ok(stats).build();</span>
<span class="nc" id="L396">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L397">      throw new WebApplicationException(e);</span>
    }
  }

  @GET
  @Path(&quot;services.xml&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(name = &quot;servicesasxml&quot;, description = &quot;Returns a service registraton or list of available service registrations as XML.&quot;, returnDescription = &quot;The services list as XML&quot;, restParameters = {
          @RestParameter(name = &quot;serviceType&quot;, isRequired = false, type = Type.STRING, description = &quot;The service type identifier&quot;),
          @RestParameter(name = &quot;host&quot;, isRequired = false, type = Type.STRING, description = &quot;The host, including the http(s) protocol&quot;) }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Returned the available service.&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No service of that type on that host is registered.&quot;) })
  public JaxbServiceRegistrationList getRegistrationsAsXml(@QueryParam(&quot;serviceType&quot;) String serviceType,
          @QueryParam(&quot;host&quot;) String host) throws NotFoundException {
<span class="nc" id="L411">    JaxbServiceRegistrationList registrations = new JaxbServiceRegistrationList();</span>
    try {
<span class="nc bnc" id="L413" title="All 4 branches missed.">      if (isNotBlank(serviceType) &amp;&amp; isNotBlank(host)) {</span>
        // This is a request for one specific service. Return it, or SC_NOT_FOUND if not found
<span class="nc" id="L415">        ServiceRegistration reg = serviceRegistry.getServiceRegistration(serviceType, host);</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">        if (reg == null) {</span>
<span class="nc" id="L417">          throw new NotFoundException();</span>
        } else {
<span class="nc" id="L419">          return new JaxbServiceRegistrationList(new JaxbServiceRegistration(reg));</span>
        }
<span class="nc bnc" id="L421" title="All 4 branches missed.">      } else if (isBlank(serviceType) &amp;&amp; isBlank(host)) {</span>
        // This is a request for all service registrations
<span class="nc bnc" id="L423" title="All 2 branches missed.">        for (ServiceRegistration reg : serviceRegistry.getServiceRegistrations()) {</span>
<span class="nc" id="L424">          registrations.add(new JaxbServiceRegistration(reg));</span>
<span class="nc" id="L425">        }</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">      } else if (isNotBlank(serviceType)) {</span>
        // This is a request for all service registrations of a particular type
<span class="nc bnc" id="L428" title="All 2 branches missed.">        for (ServiceRegistration reg : serviceRegistry.getServiceRegistrationsByType(serviceType)) {</span>
<span class="nc" id="L429">          registrations.add(new JaxbServiceRegistration(reg));</span>
<span class="nc" id="L430">        }</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">      } else if (isNotBlank(host)) {</span>
        // This is a request for all service registrations of a particular host
<span class="nc bnc" id="L433" title="All 2 branches missed.">        for (ServiceRegistration reg : serviceRegistry.getServiceRegistrationsByHost(host)) {</span>
<span class="nc" id="L434">          registrations.add(new JaxbServiceRegistration(reg));</span>
<span class="nc" id="L435">        }</span>
      }
<span class="nc" id="L437">      return registrations;</span>
<span class="nc" id="L438">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L439">      throw new WebApplicationException(e);</span>
    }
  }

  @GET
  @Path(&quot;services.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;servicesasjson&quot;, description = &quot;Returns a service registraton or list of available service registrations as JSON.&quot;, returnDescription = &quot;The services list as XML&quot;, restParameters = {
          @RestParameter(name = &quot;serviceType&quot;, isRequired = false, type = Type.STRING, description = &quot;The service type identifier&quot;),
          @RestParameter(name = &quot;host&quot;, isRequired = false, type = Type.STRING, description = &quot;The host, including the http(s) protocol&quot;) }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Returned the available service.&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No service of that type on that host is registered.&quot;) })
  public JaxbServiceRegistrationList getRegistrationsAsJson(@QueryParam(&quot;serviceType&quot;) String serviceType,
          @QueryParam(&quot;host&quot;) String host) throws NotFoundException {
<span class="nc" id="L453">    return getRegistrationsAsXml(serviceType, host);</span>
  }

  @GET
  @Path(&quot;hosts.xml&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(name = &quot;hostsasxml&quot;, description = &quot;Returns a host registraton or list of available host registrations as XML.&quot;, returnDescription = &quot;The host list as XML&quot;, responses = { @RestResponse(responseCode = SC_OK, description = &quot;Returned the available hosts.&quot;) })
  public JaxbHostRegistrationList getHostsAsXml() throws NotFoundException {
<span class="nc" id="L461">    JaxbHostRegistrationList registrations = new JaxbHostRegistrationList();</span>
    try {
<span class="nc bnc" id="L463" title="All 2 branches missed.">      for (HostRegistration reg : serviceRegistry.getHostRegistrations())</span>
<span class="nc" id="L464">        registrations.add(new JaxbHostRegistration(reg));</span>
<span class="nc" id="L465">      return registrations;</span>
<span class="nc" id="L466">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L467">      throw new WebApplicationException(e);</span>
    }
  }

  @GET
  @Path(&quot;hosts.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;hostsasjson&quot;, description = &quot;Returns a host registraton or list of available host registrations as JSON.&quot;, returnDescription = &quot;The host list as JSON&quot;, responses = { @RestResponse(responseCode = SC_OK, description = &quot;Returned the available hosts.&quot;) })
  public JaxbHostRegistrationList getHostsAsJson() throws NotFoundException {
<span class="nc" id="L476">    return getHostsAsXml();</span>
  }

  @POST
  @Path(&quot;job&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(name = &quot;createjob&quot;, description = &quot;Creates a new job.&quot;, returnDescription = &quot;An XML representation of the job.&quot;, restParameters = {
          @RestParameter(name = &quot;jobType&quot;, isRequired = true, type = Type.STRING, description = &quot;The job type identifier&quot;),
          @RestParameter(name = &quot;host&quot;, isRequired = true, type = Type.STRING, description = &quot;The creating host, including the http(s) protocol&quot;),
          @RestParameter(name = &quot;operation&quot;, isRequired = true, type = Type.STRING, description = &quot;The operation this job should execute&quot;),
          @RestParameter(name = &quot;payload&quot;, isRequired = false, type = Type.TEXT, description = &quot;The job type identifier&quot;),
          @RestParameter(name = &quot;start&quot;, isRequired = false, type = Type.BOOLEAN, description = &quot;Whether the job should be queued for dispatch and execution&quot;),
          @RestParameter(name = &quot;jobLoad&quot;, isRequired = false, type = Type.STRING, description = &quot;The load this job will incur on the system&quot;),
          @RestParameter(name = &quot;arg&quot;, isRequired = false, type = Type.TEXT, description = &quot;An argument for the operation&quot;),
          @RestParameter(name = &quot;arg&quot;, isRequired = false, type = Type.TEXT, description = &quot;An argument for the operation&quot;),
          @RestParameter(name = &quot;arg&quot;, isRequired = false, type = Type.TEXT, description = &quot;An argument for the operation&quot;),
          @RestParameter(name = &quot;arg&quot;, isRequired = false, type = Type.TEXT, description = &quot;An argument for the operation&quot;),
          @RestParameter(name = &quot;arg&quot;, isRequired = false, type = Type.TEXT, description = &quot;An argument for the operation&quot;) }, responses = {
          @RestResponse(responseCode = SC_CREATED, description = &quot;Job created.&quot;),
          @RestResponse(responseCode = SC_BAD_REQUEST, description = &quot;The required parameters were not supplied, bad request.&quot;) })
  public Response createJob(@Context HttpServletRequest request) {
<span class="nc" id="L497">    String[] argArray = request.getParameterValues(&quot;arg&quot;);</span>
<span class="nc" id="L498">    List&lt;String&gt; arguments = null;</span>
<span class="nc bnc" id="L499" title="All 4 branches missed.">    if (argArray != null &amp;&amp; argArray.length &gt; 0) {</span>
<span class="nc" id="L500">      arguments = Arrays.asList(argArray);</span>
    }
<span class="nc" id="L502">    String jobType = request.getParameter(&quot;jobType&quot;);</span>
<span class="nc" id="L503">    String operation = request.getParameter(&quot;operation&quot;);</span>
<span class="nc" id="L504">    String host = request.getParameter(&quot;host&quot;);</span>
<span class="nc" id="L505">    String payload = request.getParameter(&quot;payload&quot;);</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">    boolean start = StringUtils.isBlank(request.getParameter(&quot;start&quot;))</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">            || Boolean.TRUE.toString().equalsIgnoreCase(request.getParameter(&quot;start&quot;));</span>
    try {
<span class="nc" id="L509">      Job job = null;</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">      if (StringUtils.isNotBlank(request.getParameter(&quot;jobLoad&quot;))) {</span>
<span class="nc" id="L511">        Float jobLoad = Float.parseFloat(request.getParameter(&quot;jobLoad&quot;));</span>
<span class="nc" id="L512">        job = ((ServiceRegistryJpaImpl) serviceRegistry).createJob(host, jobType, operation, arguments, payload,</span>
<span class="nc" id="L513">              start, serviceRegistry.getCurrentJob(), jobLoad);</span>
<span class="nc" id="L514">      } else {</span>
<span class="nc" id="L515">        job = ((ServiceRegistryJpaImpl) serviceRegistry).createJob(host, jobType, operation, arguments, payload,</span>
<span class="nc" id="L516">                start, serviceRegistry.getCurrentJob());</span>
      }
<span class="nc" id="L518">      return Response.created(job.getUri()).entity(new JaxbJob(job)).build();</span>
<span class="nc" id="L519">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L520">      throw new WebApplicationException(Status.BAD_REQUEST);</span>
<span class="nc" id="L521">    } catch (Exception e) {</span>
<span class="nc" id="L522">      throw new WebApplicationException(e);</span>
    }
  }

  @PUT
  @Path(&quot;job/{id}.xml&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(name = &quot;updatejob&quot;, description = &quot;Updates an existing job&quot;, returnDescription = &quot;No content&quot;, pathParameters = { @RestParameter(name = &quot;id&quot;, isRequired = true, type = Type.STRING, description = &quot;The job identifier&quot;) }, restParameters = { @RestParameter(name = &quot;job&quot;, isRequired = true, type = Type.TEXT, description = &quot;The updated job as XML&quot;) }, responses = {
          @RestResponse(responseCode = SC_NO_CONTENT, description = &quot;Job updated.&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;Job not found.&quot;) })
  public Response updateJob(@PathParam(&quot;id&quot;) String id, @FormParam(&quot;job&quot;) String jobXml) throws NotFoundException {
    try {
<span class="nc" id="L534">      Job job = JobParser.parseJob(jobXml);</span>
<span class="nc" id="L535">      serviceRegistry.updateJob(job);</span>
<span class="nc" id="L536">      return Response.status(Status.NO_CONTENT).build();</span>
<span class="nc" id="L537">    } catch (Exception e) {</span>
<span class="nc" id="L538">      throw new WebApplicationException(e);</span>
    }
  }

  @GET
  @Path(&quot;job/{id}.xml&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(name = &quot;jobasxml&quot;, description = &quot;Returns a job as XML.&quot;, returnDescription = &quot;The job as XML&quot;, pathParameters = { @RestParameter(name = &quot;id&quot;, isRequired = true, type = Type.STRING, description = &quot;The job identifier&quot;) }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Job found.&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No job with that identifier exists.&quot;) })
  public JaxbJob getJobAsXml(@PathParam(&quot;id&quot;) long id) throws NotFoundException {
<span class="nc" id="L549">    return getJobAsJson(id);</span>
  }

  @GET
  @Path(&quot;job/{id}.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;jobasjson&quot;, description = &quot;Returns a job as JSON.&quot;, returnDescription = &quot;The job as JSON&quot;, pathParameters = { @RestParameter(name = &quot;id&quot;, isRequired = true, type = Type.STRING, description = &quot;The job identifier&quot;) }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Job found.&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No job with that identifier exists.&quot;) })
  public JaxbJob getJobAsJson(@PathParam(&quot;id&quot;) long id) throws NotFoundException {
    try {
<span class="nc" id="L560">      return new JaxbJob(serviceRegistry.getJob(id));</span>
<span class="nc" id="L561">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L562">      throw new WebApplicationException(e);</span>
    }
  }

  @GET
  @Path(&quot;job/{id}/children.xml&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(name = &quot;childrenjobsasxml&quot;, description = &quot;Returns all children from a job as XML.&quot;, returnDescription = &quot;A list of children jobs as XML&quot;, pathParameters = { @RestParameter(name = &quot;id&quot;, isRequired = true, type = Type.STRING, description = &quot;The parent job identifier&quot;) }, responses = { @RestResponse(responseCode = SC_OK, description = &quot;Jobs found.&quot;) })
  public JaxbJobList getChildrenJobsAsXml(@PathParam(&quot;id&quot;) long id) {
<span class="nc" id="L571">    return getChildrenJobsAsJson(id);</span>
  }

  @GET
  @Path(&quot;job/{id}/children.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;childrenjobsasjson&quot;, description = &quot;Returns all children from a job as JSON.&quot;, returnDescription = &quot;A list of children jobs as JSON&quot;, pathParameters = { @RestParameter(name = &quot;id&quot;, isRequired = true, type = Type.STRING, description = &quot;The parent job identifier&quot;) }, responses = { @RestResponse(responseCode = SC_OK, description = &quot;Jobs found.&quot;) })
  public JaxbJobList getChildrenJobsAsJson(@PathParam(&quot;id&quot;) long id) {
    try {
<span class="nc" id="L580">      return new JaxbJobList(serviceRegistry.getChildJobs(id));</span>
<span class="nc" id="L581">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L582">      throw new WebApplicationException(e);</span>
    }
  }

  @GET
  @Path(&quot;jobs.xml&quot;)
  @Produces(MediaType.TEXT_XML)
  public JaxbJobList getJobsAsXml(@QueryParam(&quot;serviceType&quot;) String serviceType, @QueryParam(&quot;status&quot;) Job.Status status) {
    try {
<span class="nc" id="L591">      return new JaxbJobList(serviceRegistry.getJobs(serviceType, status));</span>
<span class="nc" id="L592">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L593">      throw new WebApplicationException(e);</span>
    }

  }

  @GET
  @Path(&quot;activeJobs.xml&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(name = &quot;activejobsasxml&quot;,
          description = &quot;Returns all active jobs as XML.&quot;,
          returnDescription = &quot;A list of active jobs as XML&quot;,
          responses = { @RestResponse(responseCode = SC_OK, description = &quot;Active jobs found.&quot;) })
  public JaxbJobList getActiveJobsAsXml() {
    try {
<span class="nc" id="L607">      return new JaxbJobList(serviceRegistry.getActiveJobs());</span>
<span class="nc" id="L608">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L609">      throw new WebApplicationException(e);</span>
    }
  }

  @GET
  @Path(&quot;activeJobs.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;activejobsasjson&quot;,
          description = &quot;Returns all active jobs as JSON.&quot;,
          returnDescription = &quot;A list of active jobs as JSON&quot;,
          responses = { @RestResponse(responseCode = SC_OK, description = &quot;Active jobs found.&quot;) })
  public JaxbJobList getActiveJobsAsJson() {
    try {
<span class="nc" id="L622">      return new JaxbJobList(serviceRegistry.getActiveJobs());</span>
<span class="nc" id="L623">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L624">      throw new WebApplicationException(e);</span>
    }
  }

  @GET
  @Path(&quot;count&quot;)
  @Produces(MediaType.TEXT_PLAIN)
  @RestQuery(name = &quot;count&quot;, description = &quot;Returns the number of jobs matching the query parameters as plain text.&quot;, returnDescription = &quot;The number of matching jobs&quot;, restParameters = {
          @RestParameter(name = &quot;serviceType&quot;, isRequired = false, type = Type.STRING, description = &quot;The service type identifier&quot;),
          @RestParameter(name = &quot;status&quot;, isRequired = false, type = Type.STRING, description = &quot;The job status&quot;),
          @RestParameter(name = &quot;host&quot;, isRequired = false, type = Type.STRING, description = &quot;The host executing the job&quot;),
          @RestParameter(name = &quot;operation&quot;, isRequired = false, type = Type.STRING, description = &quot;The job's operation&quot;) }, responses = { @RestResponse(responseCode = SC_OK, description = &quot;Job count returned.&quot;) })
  public long count(@QueryParam(&quot;serviceType&quot;) String serviceType, @QueryParam(&quot;status&quot;) Job.Status status,
          @QueryParam(&quot;host&quot;) String host, @QueryParam(&quot;operation&quot;) String operation) {
    try {
<span class="nc bnc" id="L639" title="All 4 branches missed.">      if (isNotBlank(host) &amp;&amp; isNotBlank(operation)) {</span>
<span class="nc bnc" id="L640" title="All 2 branches missed.">        if (isBlank(serviceType))</span>
<span class="nc" id="L641">          throw new WebApplicationException(Response.serverError().entity(&quot;Service type must not be null&quot;).build());</span>
<span class="nc" id="L642">        return serviceRegistry.count(serviceType, host, operation, status);</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">      } else if (isNotBlank(host)) {</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">        if (isBlank(serviceType))</span>
<span class="nc" id="L645">          throw new WebApplicationException(Response.serverError().entity(&quot;Service type must not be null&quot;).build());</span>
<span class="nc" id="L646">        return serviceRegistry.countByHost(serviceType, host, status);</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">      } else if (isNotBlank(operation)) {</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">        if (isBlank(serviceType))</span>
<span class="nc" id="L649">          throw new WebApplicationException(Response.serverError().entity(&quot;Service type must not be null&quot;).build());</span>
<span class="nc" id="L650">        return serviceRegistry.countByOperation(serviceType, operation, status);</span>
      } else {
<span class="nc" id="L652">        return serviceRegistry.count(serviceType, status);</span>
      }
<span class="nc" id="L654">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L655">      throw new WebApplicationException(e);</span>
    }
  }

  @GET
  @Path(&quot;maxconcurrentjobs&quot;)
  @Produces(MediaType.TEXT_PLAIN)
  @RestQuery(name = &quot;maxconcurrentjobs&quot;, description = &quot;Returns the number of jobs that the servers in this service registry can execute concurrently. If there is only one server in this service registry this will be the number of jobs that one server is able to do at one time. If it is a distributed install across many servers then this number will be the total number of jobs the cluster can process concurrently.&quot;, returnDescription = &quot;The maximum number of concurrent jobs&quot;, responses = { @RestResponse(responseCode = SC_OK, description = &quot;Maximum number of concurrent jobs returned.&quot;) })
  @Deprecated
  public Response getMaximumConcurrentWorkflows() {
<span class="nc" id="L665">    return Response.status(Status.MOVED_PERMANENTLY).type(MediaType.TEXT_PLAIN)</span>
<span class="nc" id="L666">            .header(&quot;Location&quot;, servicePath + &quot;/maxload&quot;).build();</span>
  }

  @GET
  @Path(&quot;maxload&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(name = &quot;maxload&quot;, description = &quot;Returns the maximum load that servers in this service registry can execute concurrently.  &quot;
          + &quot;If there is only one server in this service registry this will be the maximum load that one server is able to handle at one time.  &quot;
          + &quot;If it is a distributed install across many servers then this number will be the maximum load the cluster can process concurrently.&quot;,
          returnDescription = &quot;The maximum load of the cluster or server&quot;, restParameters = {
              @RestParameter(name = &quot;host&quot;, isRequired = false, type = Type.STRING, description = &quot;The host you want to know the maximum load for.&quot;)
          }, responses = { @RestResponse(responseCode = SC_OK, description = &quot;Maximum load for the cluster.&quot;) })
  public Response getMaxLoadOnNode(@QueryParam(&quot;host&quot;) String host) throws NotFoundException {
    try {
<span class="nc bnc" id="L680" title="All 2 branches missed.">      if (StringUtils.isEmpty(host)) {</span>
<span class="nc" id="L681">        return Response.ok(serviceRegistry.getMaxLoads()).build();</span>
      } else {
<span class="nc" id="L683">        SystemLoad systemLoad = new SystemLoad();</span>
<span class="nc" id="L684">        systemLoad.addNodeLoad(serviceRegistry.getMaxLoadOnNode(host));</span>
<span class="nc" id="L685">        return Response.ok(systemLoad).build();</span>
      }
<span class="nc" id="L687">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L688">      throw new WebApplicationException(e);</span>
    }
  }

  @GET
  @Path(&quot;currentload&quot;)
  @Produces(MediaType.TEXT_XML)
  @RestQuery(name = &quot;currentload&quot;, description = &quot;Returns the current load on the servers in this service registry.  &quot;
          + &quot;If there is only one server in this service registry this will be the the load that one server.  &quot;
          + &quot;If it is a distributed install across many servers then this number will be a dictionary of the load on all nodes in the cluster.&quot;,
          returnDescription = &quot;The current load across the cluster&quot;, restParameters = {},
          responses = { @RestResponse(responseCode = SC_OK, description = &quot;Current load for the cluster.&quot;) })
  public Response getCurrentLoad() {
    try {
<span class="nc" id="L702">      return Response.ok(serviceRegistry.getCurrentHostLoads()).build();</span>
<span class="nc" id="L703">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L704">      throw new WebApplicationException(e);</span>
    }
  }

  @GET
  @Path(&quot;ownload&quot;)
  @Produces(MediaType.TEXT_PLAIN)
  @RestQuery(name = &quot;ownload&quot;, description = &quot;Returns the current load on this service registry's node.&quot;,
          returnDescription = &quot;The current load across the cluster&quot;, restParameters = {},
          responses = { @RestResponse(responseCode = SC_OK, description = &quot;Current load for the cluster.&quot;) })
  public Response getOwnLoad() {
    try {
<span class="nc" id="L716">      return Response.ok(serviceRegistry.getOwnLoad()).build();</span>
<span class="nc" id="L717">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L718">      throw new WebApplicationException(e);</span>
    }
  }


  @DELETE
  @Path(&quot;job/{id}&quot;)
  @RestQuery(name = &quot;deletejob&quot;, description = &quot;Deletes a job from the service registry&quot;, returnDescription = &quot;No data is returned, just the HTTP status code&quot;, pathParameters = { @RestParameter(isRequired = true, name = &quot;id&quot;, type = Type.INTEGER, description = &quot;ID of the job to delete&quot;) }, responses = {
          @RestResponse(responseCode = SC_NO_CONTENT, description = &quot;Job successfully deleted&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;Job with given id could not be found&quot;) })
  public Response deleteJob(@PathParam(&quot;id&quot;) long id) throws NotFoundException {
    try {
<span class="nc" id="L730">      serviceRegistry.removeJobs(Collections.singletonList(id));</span>
<span class="nc" id="L731">      return Response.noContent().build();</span>
<span class="nc" id="L732">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L733">      throw new WebApplicationException(e);</span>
    }
  }


  @POST
  @Path(&quot;removejobs&quot;)
  @RestQuery(name = &quot;removejobs&quot;, description = &quot;Removes all given jobs and their child jobs&quot;, returnDescription = &quot;No data is returned, just the HTTP status code&quot;, restParameters = { @RestParameter(name = &quot;jobIds&quot;, isRequired = true, description = &quot;The IDs of the jobs to delete&quot;, type = Type.TEXT), }, responses = {
          @RestResponse(responseCode = SC_NO_CONTENT, description = &quot;Jobs successfully removed&quot;),
          @RestResponse(responseCode = HttpServletResponse.SC_INTERNAL_SERVER_ERROR, description = &quot;Error while removing jobs&quot;) })
  public Response removeParentlessJobs(@FormParam(&quot;jobIds&quot;) String jobIds) throws NotFoundException {
    try {
<span class="nc" id="L745">      final JSONArray array = (JSONArray) JSONValue.parse(jobIds);</span>
<span class="nc" id="L746">      final List&lt;Long&gt; jobIdList = Arrays.asList((Long[]) array.toArray(new Long[0]));</span>
<span class="nc" id="L747">      serviceRegistry.removeJobs(jobIdList);</span>
<span class="nc" id="L748">      return Response.noContent().build();</span>
<span class="nc" id="L749">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L750">      throw new WebApplicationException(e);</span>
    }
  }


  @POST
  @Path(&quot;removeparentlessjobs&quot;)
  @RestQuery(name = &quot;removeparentlessjobs&quot;, description = &quot;Removes all jobs without a parent job which have passed their lifetime&quot;, returnDescription = &quot;No data is returned, just the HTTP status code&quot;, restParameters = { @RestParameter(name = &quot;lifetime&quot;, isRequired = true, type = Type.INTEGER, description = &quot;Lifetime of parentless jobs&quot;) }, responses = {
          @RestResponse(responseCode = SC_NO_CONTENT, description = &quot;Parentless jobs successfully removed&quot;),
          @RestResponse(responseCode = HttpServletResponse.SC_INTERNAL_SERVER_ERROR, description = &quot;Error while removing parentless jobs&quot;) })
  public Response removeParentlessJobs(@FormParam(&quot;lifetime&quot;) int lifetime) {
    try {
<span class="nc" id="L762">      serviceRegistry.removeParentlessJobs(lifetime);</span>
<span class="nc" id="L763">      return Response.noContent().build();</span>
<span class="nc" id="L764">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L765">      throw new WebApplicationException(e);</span>
    }
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>