<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AnnotationServiceJpaImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-annotation-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.annotation.impl</a> &gt; <span class="el_source">AnnotationServiceJpaImpl.java</span></div><h1>AnnotationServiceJpaImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.annotation.impl;

import static org.opencastproject.db.Queries.namedQuery;

import org.opencastproject.annotation.api.Annotation;
import org.opencastproject.annotation.api.AnnotationList;
import org.opencastproject.annotation.api.AnnotationService;
import org.opencastproject.db.DBSession;
import org.opencastproject.db.DBSessionFactory;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.util.NotFoundException;

import org.apache.commons.lang3.tuple.Pair;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Deactivate;
import org.osgi.service.component.annotations.Reference;

import java.util.Calendar;
import java.util.Collection;
import java.util.GregorianCalendar;
import java.util.function.Function;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.Query;
import javax.persistence.TemporalType;

/**
 * JPA-based implementation of the {@link AnnotationService}
 */
@Component(
    immediate = true,
    service = AnnotationService.class,
    property = {
        &quot;service.description=Annotation Service&quot;
    }
)
<span class="fc" id="L60">public class AnnotationServiceJpaImpl implements AnnotationService {</span>

  /** JPA persistence unit name */
  public static final String PERSISTENCE_UNIT = &quot;org.opencastproject.annotation&quot;;

  /** The factory used to generate the entity manager */
<span class="fc" id="L66">  protected EntityManagerFactory emf = null;</span>

  protected DBSessionFactory dbSessionFactory;

  protected DBSession db;

  /** Opencast's security service */
  protected SecurityService securityService;

  /** OSGi DI */
  @Reference(target = &quot;(osgi.unit.name=org.opencastproject.annotation)&quot;)
  void setEntityManagerFactory(EntityManagerFactory emf) {
<span class="fc" id="L78">    this.emf = emf;</span>
<span class="fc" id="L79">  }</span>

  @Reference
  public void setDBSessionFactory(DBSessionFactory dbSessionFactory) {
<span class="fc" id="L83">    this.dbSessionFactory = dbSessionFactory;</span>
<span class="fc" id="L84">  }</span>

  @Activate
  public void activate() {
<span class="fc" id="L88">    db = dbSessionFactory.createSession(emf);</span>
<span class="fc" id="L89">  }</span>

  @Deactivate
  public void deactivate() {
<span class="nc" id="L93">    db.close();</span>
<span class="nc" id="L94">  }</span>

  /**
   * Sets the opencast security service
   *
   * @param securityService
   *          the securityService to set
   */
  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="fc" id="L104">    this.securityService = securityService;</span>
<span class="fc" id="L105">  }</span>

  public Annotation addAnnotation(Annotation a) {
    // set the User ID on the annotation
<span class="fc" id="L109">    a.setUserId(securityService.getUser().getUsername());</span>
<span class="fc" id="L110">    return db.execTx(namedQuery.persist(a));</span>
  }

  public boolean removeAnnotation(Annotation a) {
    try {
<span class="fc" id="L115">      db.execTxChecked(em -&gt; {</span>
        // first merge then remove element
<span class="fc" id="L117">        em.remove(em.merge(a));</span>
<span class="fc" id="L118">      });</span>
<span class="fc" id="L119">      return true;</span>
<span class="nc" id="L120">    } catch (Exception e) {</span>
<span class="nc" id="L121">      return false;</span>
    }
  }

  public Annotation changeAnnotation(Annotation a) throws NotFoundException {
<span class="fc" id="L126">    long id = a.getAnnotationId();</span>
<span class="fc" id="L127">    return db.execTx(em -&gt; {</span>
<span class="fc" id="L128">      Query q = em.createNamedQuery(&quot;updateAnnotation&quot;);</span>
<span class="fc" id="L129">      q.setParameter(&quot;value&quot;, a.getValue());</span>
<span class="fc" id="L130">      q.setParameter(&quot;annotationId&quot;, id);</span>
<span class="fc" id="L131">      int no = q.executeUpdate();</span>

<span class="fc" id="L133">      AnnotationImpl b = null;</span>
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">      if (no == 1) {</span>
<span class="fc" id="L135">        b = em.find(AnnotationImpl.class, id);</span>
      }
<span class="fc" id="L137">      return b;</span>
    });
  }

  public Annotation getAnnotation(long id) throws NotFoundException {
<span class="fc" id="L142">    AnnotationImpl a = db.exec(namedQuery.findById(AnnotationImpl.class, id));</span>
<span class="fc bfc" id="L143" title="All 2 branches covered.">    if (a == null) {</span>
<span class="fc" id="L144">      throw new NotFoundException(&quot;Annotation '&quot; + id + &quot;' not found&quot;);</span>
    }
<span class="fc" id="L146">    return a;</span>
  }

  @SuppressWarnings(&quot;unchecked&quot;)
  public AnnotationList getAnnotations(int offset, int limit) {
<span class="nc" id="L151">    AnnotationListImpl result = new AnnotationListImpl();</span>

<span class="nc" id="L153">    db.exec(em -&gt; {</span>
<span class="nc" id="L154">      result.setTotal(getTotalQuery().apply(em));</span>
<span class="nc" id="L155">      result.setOffset(offset);</span>
<span class="nc" id="L156">      result.setLimit(limit);</span>

<span class="nc" id="L158">      Query q = em.createNamedQuery(&quot;findAnnotations&quot;);</span>
<span class="nc" id="L159">      q.setParameter(&quot;userId&quot;, securityService.getUser().getUsername());</span>
<span class="nc" id="L160">      q.setFirstResult(offset);</span>
<span class="nc" id="L161">      q.setMaxResults(limit);</span>
<span class="nc" id="L162">      Collection&lt;Annotation&gt; annotations = q.getResultList();</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">      for (Annotation a : annotations) {</span>
<span class="nc" id="L164">        result.add(a);</span>
<span class="nc" id="L165">      }</span>
<span class="nc" id="L166">    });</span>

<span class="nc" id="L168">    return result;</span>
  }

  public AnnotationList getAnnotationsByTypeAndMediapackageId(String type, String mediapackageId, int offset,
      int limit) {
<span class="fc" id="L173">    AnnotationListImpl result = new AnnotationListImpl();</span>

<span class="fc" id="L175">    db.exec(em -&gt; {</span>
<span class="fc" id="L176">      result.setTotal(getTotalQuery(type, mediapackageId).apply(em));</span>
<span class="fc" id="L177">      result.setOffset(offset);</span>
<span class="fc" id="L178">      result.setLimit(limit);</span>

<span class="fc" id="L180">      Query q = em.createNamedQuery(&quot;findAnnotationsByTypeAndMediapackageId&quot;);</span>
<span class="fc" id="L181">      q.setParameter(&quot;userId&quot;, securityService.getUser().getUsername());</span>
<span class="fc" id="L182">      q.setParameter(&quot;type&quot;, type);</span>
<span class="fc" id="L183">      q.setParameter(&quot;mediapackageId&quot;, mediapackageId);</span>
<span class="fc" id="L184">      q.setFirstResult(offset);</span>
<span class="fc" id="L185">      q.setMaxResults(limit);</span>
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L187">      Collection&lt;Annotation&gt; annotations = q.getResultList();</span>

<span class="fc bfc" id="L189" title="All 2 branches covered.">      for (Annotation a : annotations) {</span>
<span class="fc" id="L190">        result.add(a);</span>
<span class="fc" id="L191">      }</span>
<span class="fc" id="L192">    });</span>

<span class="fc" id="L194">    return result;</span>
  }

  public AnnotationList getAnnotationsByMediapackageId(String mediapackageId, int offset, int limit) {
<span class="fc" id="L198">    AnnotationListImpl result = new AnnotationListImpl();</span>

<span class="fc" id="L200">    db.exec(em -&gt; {</span>
<span class="fc" id="L201">      result.setTotal(getTotalByMediapackageIDQuery(mediapackageId).apply(em));</span>
<span class="fc" id="L202">      result.setOffset(offset);</span>
<span class="fc" id="L203">      result.setLimit(limit);</span>

<span class="fc" id="L205">      Query q = em.createNamedQuery(&quot;findAnnotationsByMediapackageId&quot;);</span>
<span class="fc" id="L206">      q.setParameter(&quot;userId&quot;, securityService.getUser().getUsername());</span>
<span class="fc" id="L207">      q.setParameter(&quot;mediapackageId&quot;, mediapackageId);</span>
<span class="fc" id="L208">      q.setFirstResult(offset);</span>
<span class="fc" id="L209">      q.setMaxResults(limit);</span>
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L211">      Collection&lt;Annotation&gt; annotations = q.getResultList();</span>

<span class="fc bfc" id="L213" title="All 2 branches covered.">      for (Annotation a : annotations) {</span>
<span class="fc" id="L214">        result.add(a);</span>
<span class="fc" id="L215">      }</span>
<span class="fc" id="L216">    });</span>

<span class="fc" id="L218">    return result;</span>
  }

  @SuppressWarnings(&quot;unchecked&quot;)
  public AnnotationList getAnnotationsByTypeAndDay(String type, String day, int offset, int limit) {
<span class="nc" id="L223">    int year = Integer.parseInt(day.substring(0, 4));</span>
<span class="nc" id="L224">    int month = Integer.parseInt(day.substring(4, 6)) - 1;</span>
<span class="nc" id="L225">    int date = Integer.parseInt(day.substring(6, 8));</span>

<span class="nc" id="L227">    Calendar calBegin = new GregorianCalendar();</span>
<span class="nc" id="L228">    calBegin.set(year, month, date, 0, 0);</span>
<span class="nc" id="L229">    Calendar calEnd = new GregorianCalendar();</span>
<span class="nc" id="L230">    calEnd.set(year, month, date, 23, 59);</span>

<span class="nc" id="L232">    AnnotationListImpl result = new AnnotationListImpl();</span>

<span class="nc" id="L234">    db.exec(em -&gt; {</span>
<span class="nc" id="L235">      result.setTotal(getTotalQuery(type, calBegin, calEnd).apply(em));</span>
<span class="nc" id="L236">      result.setOffset(offset);</span>
<span class="nc" id="L237">      result.setLimit(limit);</span>

<span class="nc" id="L239">      Query q = em.createNamedQuery(&quot;findAnnotationsByTypeAndIntervall&quot;);</span>
<span class="nc" id="L240">      q.setParameter(&quot;userId&quot;, securityService.getUser().getUsername());</span>
<span class="nc" id="L241">      q.setParameter(&quot;type&quot;, type);</span>
<span class="nc" id="L242">      q.setParameter(&quot;begin&quot;, calBegin, TemporalType.TIMESTAMP);</span>
<span class="nc" id="L243">      q.setParameter(&quot;end&quot;, calEnd, TemporalType.TIMESTAMP);</span>
<span class="nc" id="L244">      q.setFirstResult(offset);</span>
<span class="nc" id="L245">      q.setMaxResults(limit);</span>
<span class="nc" id="L246">      Collection&lt;Annotation&gt; annotations = q.getResultList();</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">      for (Annotation a : annotations) {</span>
<span class="nc" id="L248">        result.add(a);</span>
<span class="nc" id="L249">      }</span>
<span class="nc" id="L250">    });</span>

<span class="nc" id="L252">    return result;</span>
  }

  @SuppressWarnings(&quot;unchecked&quot;)
  public AnnotationList getAnnotationsByDay(String day, int offset, int limit) {
<span class="nc" id="L257">    AnnotationListImpl result = new AnnotationListImpl();</span>

<span class="nc" id="L259">    int year = Integer.parseInt(day.substring(0, 4));</span>
<span class="nc" id="L260">    int month = Integer.parseInt(day.substring(4, 6)) - 1;</span>
<span class="nc" id="L261">    int date = Integer.parseInt(day.substring(6, 8));</span>

<span class="nc" id="L263">    Calendar calBegin = new GregorianCalendar();</span>
<span class="nc" id="L264">    calBegin.set(year, month, date, 0, 0);</span>
<span class="nc" id="L265">    Calendar calEnd = new GregorianCalendar();</span>
<span class="nc" id="L266">    calEnd.set(year, month, date, 23, 59);</span>

<span class="nc" id="L268">    db.exec(em -&gt; {</span>
<span class="nc" id="L269">      result.setTotal(getTotalQuery(calBegin, calEnd).apply(em));</span>
<span class="nc" id="L270">      result.setOffset(offset);</span>
<span class="nc" id="L271">      result.setLimit(limit);</span>

<span class="nc" id="L273">      Query q = em.createNamedQuery(&quot;findAnnotationsByIntervall&quot;);</span>
<span class="nc" id="L274">      q.setParameter(&quot;userId&quot;, securityService.getUser().getUsername());</span>
<span class="nc" id="L275">      q.setParameter(&quot;begin&quot;, calBegin, TemporalType.TIMESTAMP);</span>
<span class="nc" id="L276">      q.setParameter(&quot;end&quot;, calEnd, TemporalType.TIMESTAMP);</span>
<span class="nc" id="L277">      q.setFirstResult(offset);</span>
<span class="nc" id="L278">      q.setMaxResults(limit);</span>
<span class="nc" id="L279">      Collection&lt;Annotation&gt; annotations = q.getResultList();</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">      for (Annotation a : annotations) {</span>
<span class="nc" id="L281">        result.add(a);</span>
<span class="nc" id="L282">      }</span>
<span class="nc" id="L283">    });</span>

<span class="nc" id="L285">    return result;</span>
  }

  @SuppressWarnings(&quot;unchecked&quot;)
  public AnnotationList getAnnotationsByType(String type, int offset, int limit) {
<span class="nc" id="L290">    AnnotationListImpl result = new AnnotationListImpl();</span>

<span class="nc" id="L292">    db.exec(em -&gt; {</span>
<span class="nc" id="L293">      result.setTotal(getTotalQuery(type).apply(em));</span>
<span class="nc" id="L294">      result.setOffset(offset);</span>
<span class="nc" id="L295">      result.setLimit(limit);</span>

<span class="nc" id="L297">      Query q = em.createNamedQuery(&quot;findAnnotationsByType&quot;);</span>
<span class="nc" id="L298">      q.setParameter(&quot;userId&quot;, securityService.getUser().getUsername());</span>
<span class="nc" id="L299">      q.setParameter(&quot;type&quot;, type);</span>
<span class="nc" id="L300">      q.setFirstResult(offset);</span>
<span class="nc" id="L301">      q.setMaxResults(limit);</span>
<span class="nc" id="L302">      Collection&lt;Annotation&gt; annotations = q.getResultList();</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">      for (Annotation a : annotations) {</span>
<span class="nc" id="L304">        result.add(a);</span>
<span class="nc" id="L305">      }</span>
<span class="nc" id="L306">    });</span>

<span class="nc" id="L308">    return result;</span>
  }

  private Function&lt;EntityManager, Integer&gt; getTotalQuery() {
<span class="nc" id="L312">    return namedQuery.find(</span>
        &quot;findTotal&quot;,
        Long.class,
<span class="nc" id="L315">        Pair.of(&quot;userId&quot;, securityService.getUser().getUsername())</span>
<span class="nc" id="L316">    ).andThen(Long::intValue);</span>
  }

  private Function&lt;EntityManager, Integer&gt; getTotalQuery(String type) {
<span class="nc" id="L320">    return namedQuery.find(</span>
        &quot;findTotalByType&quot;,
        Long.class,
<span class="nc" id="L323">        Pair.of(&quot;userId&quot;, securityService.getUser().getUsername()),</span>
<span class="nc" id="L324">        Pair.of(&quot;type&quot;, type)</span>
<span class="nc" id="L325">    ).andThen(Long::intValue);</span>
  }

  private Function&lt;EntityManager, Integer&gt; getTotalQuery(String type, String mediapackageId) {
<span class="fc" id="L329">    return namedQuery.find(</span>
        &quot;findTotalByTypeAndMediapackageId&quot;,
        Long.class,
<span class="fc" id="L332">        Pair.of(&quot;userId&quot;, securityService.getUser().getUsername()),</span>
<span class="fc" id="L333">        Pair.of(&quot;type&quot;, type),</span>
<span class="fc" id="L334">        Pair.of(&quot;mediapackageId&quot;, mediapackageId)</span>
<span class="fc" id="L335">    ).andThen(Long::intValue);</span>
  }

  private Function&lt;EntityManager, Integer&gt; getTotalByMediapackageIDQuery(String mediapackageId) {
<span class="fc" id="L339">    return namedQuery.find(</span>
        &quot;findTotalByMediapackageId&quot;,
        Long.class,
<span class="fc" id="L342">        Pair.of(&quot;userId&quot;, securityService.getUser().getUsername()),</span>
<span class="fc" id="L343">        Pair.of(&quot;mediapackageId&quot;, mediapackageId)</span>
<span class="fc" id="L344">    ).andThen(Long::intValue);</span>
  }

  private Function&lt;EntityManager, Integer&gt; getTotalQuery(String type, Calendar calBegin, Calendar calEnd) {
<span class="nc" id="L348">    return namedQuery.find(</span>
        &quot;findTotalByTypeAndIntervall&quot;,
        Long.class,
<span class="nc" id="L351">        Pair.of(&quot;userId&quot;, securityService.getUser().getUsername()),</span>
<span class="nc" id="L352">        Pair.of(&quot;type&quot;, type),</span>
<span class="nc" id="L353">        Pair.of(&quot;begin&quot;, calBegin),</span>
<span class="nc" id="L354">        Pair.of(&quot;end&quot;, calEnd)</span>
<span class="nc" id="L355">    ).andThen(Long::intValue);</span>
  }

  private Function&lt;EntityManager, Integer&gt; getTotalQuery(Calendar calBegin, Calendar calEnd) {
<span class="nc" id="L359">    return namedQuery.find(</span>
        &quot;findTotalByIntervall&quot;,
        Long.class,
<span class="nc" id="L362">        Pair.of(&quot;userId&quot;, securityService.getUser().getUsername()),</span>
<span class="nc" id="L363">        Pair.of(&quot;begin&quot;, calBegin),</span>
<span class="nc" id="L364">        Pair.of(&quot;end&quot;, calEnd)</span>
<span class="nc" id="L365">    ).andThen(Long::intValue);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>