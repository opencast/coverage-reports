<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>OAuthConsumerDetailsService.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-kernel</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.kernel.security</a> &gt; <span class="el_source">OAuthConsumerDetailsService.java</span></div><h1>OAuthConsumerDetailsService.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.kernel.security;

import org.apache.commons.lang3.StringUtils;
import org.osgi.service.cm.ConfigurationException;
import org.osgi.service.cm.ManagedService;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.oauth.common.OAuthException;
import org.springframework.security.oauth.common.signature.SharedConsumerSecretImpl;
import org.springframework.security.oauth.provider.BaseConsumerDetails;
import org.springframework.security.oauth.provider.ConsumerDetails;
import org.springframework.security.oauth.provider.ConsumerDetailsService;
import org.springframework.security.oauth.provider.ExtraTrustConsumerDetails;

import java.util.ArrayList;
import java.util.Dictionary;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * A OAuth consumer details service with multiple consumers. UserDetailsService is used for delegating user
 * lookup requests.
 */
@Component(
    immediate = true,
    service = { ManagedService.class,ConsumerDetailsService.class },
    property = {
        &quot;service.description=OAuth consumer details service&quot;
    }
)
<span class="nc" id="L60">public class OAuthConsumerDetailsService implements ConsumerDetailsService, UserDetailsService, ManagedService {</span>

  /** The logger */
<span class="nc" id="L63">  private static final Logger logger = LoggerFactory.getLogger(OAuthConsumerDetailsService.class);</span>

  /** The prefix of the key to look up a consumer name. */
  private static final String CONSUMER_NAME_PREFIX = &quot;oauth.consumer.name.&quot;;

  /** The prefix of the key to look up a consumer key. */
  private static final String CONSUMER_KEY_PREFIX = &quot;oauth.consumer.key.&quot;;

  /** The prefix of the key to look up a consumer secret. */
  private static final String CONSUMER_SECRET_PREFIX = &quot;oauth.consumer.secret.&quot;;

  /** The user details service to use as a delegate for user lookups */
  private UserDetailsService delegate;

  /** A map associating consumer keys to OAuth consumers. */
<span class="nc" id="L78">  private Map&lt;String, ConsumerDetails&gt; consumers = new HashMap&lt;&gt;();</span>

  /**
   * OSGi DI
   */
  @Reference
  public void setDelegate(UserDetailsService delegate) {
<span class="nc" id="L85">    this.delegate = delegate;</span>
<span class="nc" id="L86">  }</span>

  @Override
  public void updated(Dictionary&lt;String, ?&gt; properties) throws ConfigurationException {
<span class="nc" id="L90">    logger.debug(&quot;Updating OAuthConsumerDetailsService&quot;);</span>

<span class="nc" id="L92">    consumers.clear();</span>

<span class="nc bnc" id="L94" title="All 2 branches missed.">    if (properties == null) {</span>
<span class="nc" id="L95">      logger.warn(&quot;OAuthConsumerDetailsService has no configured OAuth consumers&quot;);</span>
<span class="nc" id="L96">      return;</span>
    }

<span class="nc" id="L99">    for (int i = 1; true; i++) {</span>
<span class="nc" id="L100">      logger.debug(&quot;Looking for configuration of {}&quot;, CONSUMER_NAME_PREFIX + i);</span>
<span class="nc" id="L101">      String consumerName = StringUtils.trimToNull((String) properties.get(CONSUMER_NAME_PREFIX + i));</span>
<span class="nc" id="L102">      String consumerKey = StringUtils.trimToNull((String) properties.get(CONSUMER_KEY_PREFIX + i));</span>
<span class="nc" id="L103">      String consumerSecret = StringUtils.trimToNull((String) properties.get(CONSUMER_SECRET_PREFIX + i));</span>

      // Has the consumer been fully configured
<span class="nc bnc" id="L106" title="All 6 branches missed.">      if (consumerName == null || consumerKey == null || consumerSecret == null) {</span>
<span class="nc" id="L107">        logger.debug(</span>
                &quot;Unable to configure OAuth consumer with name'{}' because the name, key or secret is missing. Stopping to look for new consumers.&quot;,
                consumerName);
<span class="nc" id="L110">        break;</span>
      }

<span class="nc" id="L113">      consumers.put(consumerKey, createConsumerDetails(consumerName, consumerKey, consumerSecret));</span>
    }
<span class="nc" id="L115">  }</span>

  /**
   * Creates a spring security consumer details object, suitable to achieve two-legged OAuth.
   *
   * @param consumerName
   *          the consumer name
   * @param consumerKey
   *          the consumer key
   * @param consumerSecret
   *          the consumer secret
   * @return the consumer details
   */
  private ExtraTrustConsumerDetails createConsumerDetails(String consumerName, String consumerKey,
          String consumerSecret) {
<span class="nc" id="L130">    SharedConsumerSecretImpl secret = new SharedConsumerSecretImpl(consumerSecret);</span>
<span class="nc" id="L131">    BaseConsumerDetails bcd = new BaseConsumerDetails();</span>
<span class="nc" id="L132">    bcd.setConsumerKey(consumerKey);</span>
<span class="nc" id="L133">    bcd.setConsumerName(consumerName);</span>
<span class="nc" id="L134">    bcd.setSignatureSecret(secret);</span>
<span class="nc" id="L135">    List&lt;GrantedAuthority&gt; authorities = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L136">    authorities.add(new SimpleGrantedAuthority(&quot;ROLE_OAUTH_USER&quot;));</span>
<span class="nc" id="L137">    bcd.setAuthorities(authorities);</span>
<span class="nc" id="L138">    bcd.setRequiredToObtainAuthenticatedToken(false); // false for 2 legged OAuth</span>
<span class="nc" id="L139">    return bcd;</span>
  }

  @Override
  public ConsumerDetails loadConsumerByConsumerKey(String key) throws OAuthException {
<span class="nc" id="L144">    logger.debug(&quot;Request received to find consumer for consumerKey=[&quot; + key + &quot;]&quot;);</span>
<span class="nc" id="L145">    ConsumerDetails consumer = consumers.get(key);</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">    if (consumer == null) {</span>
<span class="nc" id="L147">      logger.debug(&quot;Result: No consumer found for [&quot; + key + &quot;]&quot;);</span>
<span class="nc" id="L148">      throw new OAuthException(&quot;No consumer found for key &quot; + key);</span>
    }
<span class="nc" id="L150">    logger.debug(&quot;Result: Found consumer [&quot; + consumer.getConsumerName() + &quot;]&quot;);</span>
<span class="nc" id="L151">    return consumer;</span>
  }

  @Override
  public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
<span class="nc" id="L156">    return delegate.loadUserByUsername(username);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>