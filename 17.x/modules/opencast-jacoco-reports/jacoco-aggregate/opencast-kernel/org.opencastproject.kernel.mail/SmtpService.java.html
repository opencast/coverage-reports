<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SmtpService.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-kernel</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.kernel.mail</a> &gt; <span class="el_source">SmtpService.java</span></div><h1>SmtpService.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.kernel.mail;

import org.apache.commons.lang3.BooleanUtils;
import org.apache.commons.lang3.StringUtils;
import org.osgi.service.cm.ConfigurationException;
import org.osgi.service.cm.ManagedService;
import org.osgi.service.component.annotations.Component;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Dictionary;

import javax.mail.Message.RecipientType;
import javax.mail.MessagingException;
import javax.mail.internet.InternetAddress;
import javax.mail.internet.MimeBodyPart;
import javax.mail.internet.MimeMessage;
import javax.mail.internet.MimeMultipart;

/**
 * OSGi service that allows to send e-mails using &lt;code&gt;javax.mail&lt;/code&gt;.
 */
@Component(
    immediate = true,
    service = { ManagedService.class,SmtpService.class },
    property = {
        &quot;service.description=SMTP Service&quot;
    }
)
<span class="nc" id="L51">public class SmtpService extends BaseSmtpService implements ManagedService {</span>

  /** The logging facility */
<span class="fc" id="L54">  private static final Logger logger = LoggerFactory.getLogger(SmtpService.class);</span>

  /** Parameter name for the test setting */
  private static final String OPT_MAIL_TEST = &quot;mail.test&quot;;

  /** Parameter name for the mode setting */
  private static final String OPT_MAIL_MODE = &quot;mail.mode&quot;;

  /**
   * Pattern to split strings containing lists of emails. This pattern matches any number of contiguous spaces or commas
   */
  private static final String SPLIT_PATTERN = &quot;[\\s,]+&quot;;

  /** Define the MIME type for text mail content */
  private static final String TEXT_PLAIN = &quot;text/plain; charset=UTF-8&quot;;

  /** Define the MIME type for HTML mail content */
  private static final String TEXT_HTML = &quot;text/html; charset=UTF-8&quot;;

  /**
   * Callback from the OSGi &lt;code&gt;ConfigurationAdmin&lt;/code&gt; on configuration changes.
   *
   * @param properties
   *          the configuration properties
   * @throws ConfigurationException
   *           if configuration fails
   */
  @Override
  public void updated(Dictionary&lt;String, ?&gt; properties) throws ConfigurationException {

    // Production or test mode
<span class="nc" id="L85">    String optMode = StringUtils.trimToNull((String) properties.get(OPT_MAIL_MODE));</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">    if (optMode != null) {</span>
      try {
<span class="nc" id="L88">        Mode mode = Mode.valueOf(optMode);</span>
<span class="nc" id="L89">        setProductionMode(Mode.production.equals(mode));</span>
<span class="nc" id="L90">      } catch (Exception e) {</span>
<span class="nc" id="L91">        logger.error(&quot;Error parsing smtp service mode '{}': {}&quot;, optMode, e.getMessage());</span>
<span class="nc" id="L92">        throw new ConfigurationException(OPT_MAIL_MODE, e.getMessage());</span>
<span class="nc" id="L93">      }</span>
    }
<span class="nc bnc" id="L95" title="All 2 branches missed.">    logger.info(&quot;Smtp service is in {} mode&quot;, isProductionMode() ? &quot;production&quot; : &quot;test&quot;);</span>

    // Mail transport protocol
<span class="nc" id="L98">    String optMailTransport = StringUtils.trimToNull((String) properties.get(OPT_MAIL_TRANSPORT));</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">    if (StringUtils.isNotBlank(optMailTransport))</span>
<span class="nc" id="L100">      setMailTransport(optMailTransport);</span>

    // The mail host is mandatory
<span class="nc" id="L103">    String propName = OPT_MAIL_PREFIX + mailTransport + OPT_MAIL_HOST_SUFFIX;</span>
<span class="nc" id="L104">    String mailHost = (String) properties.get(propName);</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">    if (StringUtils.isBlank(mailHost))</span>
<span class="nc" id="L106">      throw new ConfigurationException(propName, &quot;is not set&quot;);</span>
<span class="nc" id="L107">    setHost(mailHost);</span>

    // Mail port
<span class="nc" id="L110">    propName = OPT_MAIL_PREFIX + mailTransport + OPT_MAIL_PORT_SUFFIX;</span>
<span class="nc" id="L111">    String mailPort = (String) properties.get(propName);</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">    if (StringUtils.isNotBlank(mailPort))</span>
<span class="nc" id="L113">      setPort(Integer.parseInt(mailPort));</span>

    // TSL over SMTP support
<span class="nc" id="L116">    propName = OPT_MAIL_PREFIX + mailTransport + OPT_MAIL_TLS_ENABLE_SUFFIX;</span>
<span class="nc" id="L117">    setSsl(BooleanUtils.toBoolean((String) properties.get(propName)));</span>

    // Mail user
<span class="nc" id="L120">    String mailUser = (String) properties.get(OPT_MAIL_USER);</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">    if (StringUtils.isNotBlank(mailUser))</span>
<span class="nc" id="L122">      setUser(mailUser);</span>

    // Mail password
<span class="nc" id="L125">    String mailPassword = (String) properties.get(OPT_MAIL_PASSWORD);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">    if (StringUtils.isNotBlank(mailPassword))</span>
<span class="nc" id="L127">      setPassword(mailPassword);</span>

    // Mail sender
<span class="nc" id="L130">    String mailFrom = (String) properties.get(OPT_MAIL_FROM);</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">    if (StringUtils.isNotBlank(mailFrom))</span>
<span class="nc" id="L132">      setSender(mailFrom);</span>

    // Mail debugging
<span class="nc" id="L135">    setDebug(BooleanUtils.toBoolean((String) properties.get(OPT_MAIL_DEBUG)));</span>

<span class="nc" id="L137">    configure();</span>

    // Test
<span class="nc" id="L140">    String mailTest = StringUtils.trimToNull((String) properties.get(OPT_MAIL_TEST));</span>
<span class="nc bnc" id="L141" title="All 4 branches missed.">    if (mailTest != null &amp;&amp; Boolean.parseBoolean(mailTest)) {</span>
<span class="nc" id="L142">      logger.info(&quot;Sending test message to {}&quot;, mailFrom);</span>
      try {
<span class="nc" id="L144">        sendTestMessage(mailFrom);</span>
<span class="nc" id="L145">      } catch (MessagingException e) {</span>
<span class="nc" id="L146">        logger.error(&quot;Error sending test message to &quot; + mailFrom + &quot;: &quot; + e.getMessage());</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        while (e.getNextException() != null) {</span>
<span class="nc" id="L148">          Exception ne = e.getNextException();</span>
<span class="nc" id="L149">          logger.error(&quot;Error sending test message to &quot; + mailFrom + &quot;: &quot; + ne.getMessage());</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">          if (ne instanceof MessagingException)</span>
<span class="nc" id="L151">            e = (MessagingException) ne;</span>
          else
            break;
<span class="nc" id="L154">        }</span>
<span class="nc" id="L155">        throw new ConfigurationException(OPT_MAIL_PREFIX + mailTransport + OPT_MAIL_HOST_SUFFIX,</span>
                &quot;Failed to send test message to &quot; + mailFrom);
<span class="nc" id="L157">      }</span>
    }

<span class="nc" id="L160">  }</span>

  /**
   * Method to send a test message.
   *
   * @throws MessagingException
   *           if sending the message failed
   */
  private void sendTestMessage(String recipient) throws MessagingException {
<span class="nc" id="L169">    send(recipient, &quot;Test from Opencast&quot;, &quot;Hello world&quot;);</span>
<span class="nc" id="L170">  }</span>

  /**
   * Method to send a message
   *
   * @param to
   *          Recipient of the message
   * @param subject
   *          Subject of the message
   * @param bodyText
   *          Text body of the message (null if there should be no text part)
   * @throws MessagingException
   *           if sending the message failed
   */
  public void send(String to, String subject, String bodyText) throws MessagingException {
<span class="nc" id="L185">    send(to, subject, bodyText, null);</span>
<span class="nc" id="L186">  }</span>

  /**
   * Method to send a message
   *
   * @param to
   *          Recipient of the message
   * @param subject
   *          Subject of the message
   * @param bodyText
   *          Text body of the message (null if there should be no text part)
   * @param bodyHTML
   *          HTML body of the message (null if there should be no HTML part)
   * @throws MessagingException
   *           if sending the message failed
   */
  public void send(String to, String subject, String bodyText, String bodyHTML) throws MessagingException {
<span class="nc" id="L203">    send(to, null, null, subject, bodyText, bodyHTML);</span>
<span class="nc" id="L204">  }</span>

  /**
   * Send a message to multiple recipients
   *
   * @param to
   *          &quot;To:&quot; message recipient(s), separated by commas and/or spaces
   * @param cc
   *          &quot;CC:&quot; message recipient(s), separated by commas and/or spaces
   * @param bcc
   *          &quot;BCC:&quot; message recipient(s), separated by commas and/or spaces
   * @param subject
   *          Subject of the message
   * @param bodyText
   *          Text body of the message (null if there should be no text part)
   * @throws MessagingException
   *           if sending the message failed
   */
  public void send(String to, String cc, String bcc, String subject, String bodyText) throws MessagingException {
<span class="nc" id="L223">    send(to, cc, bcc, subject, bodyText, null);</span>
<span class="nc" id="L224">  }</span>

  /**
   * Send a message to multiple recipients
   *
   * @param to
   *          &quot;To:&quot; message recipient(s), separated by commas and/or spaces
   * @param cc
   *          &quot;CC:&quot; message recipient(s), separated by commas and/or spaces
   * @param bcc
   *          &quot;BCC:&quot; message recipient(s), separated by commas and/or spaces
   * @param subject
   *          Subject of the message
   * @param bodyText
   *          Text body of the message (null if there should be no text part)
   * @param bodyHTML
   *          HTML body of the message (null if there should be no HTML part)
   * @throws MessagingException
   *           if sending the message failed
   */
  public void send(String to, String cc, String bcc, String subject, String bodyText, String bodyHTML) throws MessagingException {
<span class="nc" id="L245">    String[] toArray = null;</span>
<span class="nc" id="L246">    String[] ccArray = null;</span>
<span class="nc" id="L247">    String[] bccArray = null;</span>

<span class="nc bnc" id="L249" title="All 2 branches missed.">    if (to != null)</span>
<span class="nc" id="L250">      toArray = to.trim().split(SPLIT_PATTERN, 0);</span>

<span class="nc bnc" id="L252" title="All 2 branches missed.">    if (cc != null)</span>
<span class="nc" id="L253">      ccArray = cc.trim().split(SPLIT_PATTERN, 0);</span>

<span class="nc bnc" id="L255" title="All 2 branches missed.">    if (bcc != null)</span>
<span class="nc" id="L256">      bccArray = bcc.trim().split(SPLIT_PATTERN, 0);</span>

<span class="nc" id="L258">    send(toArray, ccArray, bccArray, subject, bodyText, bodyHTML);</span>
<span class="nc" id="L259">  }</span>

  /**
   * Send a message to multiple recipients
   *
   * @param to
   *          Array with the &quot;To:&quot; recipients of the message
   * @param cc
   *          Array with the &quot;CC:&quot; recipients of the message
   * @param bcc
   *          Array with the &quot;BCC:&quot; recipients of the message
   * @param subject
   *          Subject of the message
   * @param bodyText
   *          Text body of the message (null if there should be no text part)
   * @throws MessagingException
   *           if sending the message failed
   */
  public void send(String[] to, String[] cc, String[] bcc, String subject, String bodyText) throws MessagingException {
<span class="nc" id="L278">    send(to, cc, bcc, subject, bodyText, null);</span>
<span class="nc" id="L279">  }</span>

  /**
   * Send a message to multiple recipients
   *
   * @param to
   *          Array with the &quot;To:&quot; recipients of the message
   * @param cc
   *          Array with the &quot;CC:&quot; recipients of the message
   * @param bcc
   *          Array with the &quot;BCC:&quot; recipients of the message
   * @param subject
   *          Subject of the message
   * @param bodyText
   *          Text body of the message (null if there should be no text part)
   * @param bodyHTML
   *          HTML body of the message (null if there should be no HTML part)
   * @throws MessagingException
   *          if sending the message failed
   * @throws IllegalArgumentException
   *          if both bodyText and bodyHTML are null
   */
  public void send(String[] to, String[] cc, String[] bcc, String subject, String bodyText, String bodyHTML) throws MessagingException {
<span class="nc bnc" id="L302" title="All 4 branches missed.">    if (bodyText == null &amp;&amp; bodyHTML == null) {</span>
<span class="nc" id="L303">      throw new IllegalArgumentException(&quot;bodyText and bodyHTML cannot both be empty&quot;);</span>
    }

<span class="nc" id="L306">    MimeMessage message = createMessage();</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">    if (StringUtils.isNotBlank(getSender())) {</span>
<span class="nc" id="L308">      message.addFrom(new InternetAddress[] { new InternetAddress(getSender()) });</span>
    }
<span class="nc" id="L310">    addRecipients(message, RecipientType.TO, to);</span>
<span class="nc" id="L311">    addRecipients(message, RecipientType.CC, cc);</span>
<span class="nc" id="L312">    addRecipients(message, RecipientType.BCC, bcc);</span>
<span class="nc" id="L313">    message.setSubject(subject);</span>

<span class="nc" id="L315">    MimeMultipart mp = new MimeMultipart(&quot;alternative&quot;);</span>
    // the text/plain part needs to be added first!
<span class="nc bnc" id="L317" title="All 2 branches missed.">    if (bodyText != null) {</span>
<span class="nc" id="L318">      MimeBodyPart part = new MimeBodyPart();</span>
<span class="nc" id="L319">      part.setContent(bodyText, TEXT_PLAIN);</span>
<span class="nc" id="L320">      mp.addBodyPart(part);</span>
    }
<span class="nc bnc" id="L322" title="All 2 branches missed.">    if (bodyHTML != null) {</span>
<span class="nc" id="L323">      MimeBodyPart part = new MimeBodyPart();</span>
<span class="nc" id="L324">      part.setContent(bodyHTML, TEXT_HTML);</span>
<span class="nc" id="L325">      mp.addBodyPart(part);</span>
    }
<span class="nc" id="L327">    message.setContent(mp);</span>
<span class="nc" id="L328">    message.saveChanges();</span>
<span class="nc" id="L329">    send(message);</span>
<span class="nc" id="L330">  }</span>

  /**
   * Process an array of recipients with the given {@link javax.mail.Message.RecipientType}
   *
   * @param message
   *          The message to add the recipients to
   * @param type
   *          The type of recipient
   * @param strAddresses
   * @throws MessagingException
   */
  private static void addRecipients(MimeMessage message, RecipientType type, String... strAddresses)
          throws MessagingException {
<span class="nc bnc" id="L344" title="All 2 branches missed.">    if (strAddresses != null) {</span>
<span class="nc" id="L345">      InternetAddress[] addresses = new InternetAddress[strAddresses.length];</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">      for (int i = 0; i &lt; strAddresses.length; i++)</span>
<span class="nc" id="L347">        addresses[i] = new InternetAddress(strAddresses[i]);</span>
<span class="nc" id="L348">      message.addRecipients(type, addresses);</span>
    }
<span class="nc" id="L350">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>