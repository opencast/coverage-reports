<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SchedulerUtil.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-scheduler-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.scheduler.impl</a> &gt; <span class="el_source">SchedulerUtil.java</span></div><h1>SchedulerUtil.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.scheduler.impl;

import static com.entwinemedia.fn.Prelude.chuck;
import static com.entwinemedia.fn.Stream.$;

import org.opencastproject.mediapackage.Catalog;
import org.opencastproject.mediapackage.EName;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.mediapackage.MediaPackageElementFlavor;
import org.opencastproject.mediapackage.MediaPackageElements;
import org.opencastproject.mediapackage.MediaPackageSupport;
import org.opencastproject.metadata.dublincore.DublinCore;
import org.opencastproject.metadata.dublincore.DublinCoreCatalog;
import org.opencastproject.metadata.dublincore.DublinCoreUtil;
import org.opencastproject.metadata.dublincore.DublinCoreValue;
import org.opencastproject.metadata.dublincore.EventCatalogUIAdapter;
import org.opencastproject.scheduler.api.SchedulerEvent;
import org.opencastproject.scheduler.api.TechnicalMetadata;
import org.opencastproject.security.api.AccessControlList;
import org.opencastproject.security.api.AccessControlUtil;
import org.opencastproject.util.Checksum;
import org.opencastproject.util.DateTimeSupport;
import org.opencastproject.workspace.api.Workspace;

import com.entwinemedia.fn.Fn;
import com.entwinemedia.fn.Fn2;
import com.entwinemedia.fn.data.Opt;

import org.apache.commons.lang3.CharUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;
import java.util.TreeMap;

/**
 * Functions to support scheduler service operations.
 */
public final class SchedulerUtil {

  /** The logger */
<span class="fc" id="L72">  private static final Logger logger = LoggerFactory.getLogger(SchedulerUtil.class);</span>

  private SchedulerUtil() {
  }

<span class="fc" id="L77">  public static final Comparator&lt;Catalog&gt; sortCatalogById = new Comparator&lt;Catalog&gt;() {</span>
    @Override
    public int compare(Catalog c1, Catalog c2) {
<span class="fc" id="L80">      return c1.getIdentifier().compareTo(c2.getIdentifier());</span>
    }
  };

  public static String calculateChecksum(
      Workspace workspace,
      List&lt;MediaPackageElementFlavor&gt; eventCatalogUIAdapterFlavors,
      Date startDateTime,
      Date endDateTime,
      String captureAgentId,
      Set&lt;String&gt; userIds,
      MediaPackage mediaPackage,
      Opt&lt;DublinCoreCatalog&gt; episodeDublincore,
      Map&lt;String, String&gt; wfProperties,
      Map&lt;String, String&gt; finalCaProperties,
      AccessControlList acl) {
<span class="fc" id="L96">    List&lt;String&gt; userIdsList = new ArrayList&lt;&gt;(userIds);</span>
<span class="fc" id="L97">    Collections.sort(userIdsList);</span>
<span class="fc" id="L98">    final MessageDigest messageDigest = mkMd5MessageDigest();</span>
<span class="fc" id="L99">    messageDigest.update(mkChecksumInput(startDateTime));</span>
<span class="fc" id="L100">    messageDigest.update(mkChecksumInput(endDateTime));</span>
<span class="fc" id="L101">    messageDigest.update(mkChecksumInput(captureAgentId));</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">    for (String user : userIdsList) {</span>
<span class="fc" id="L103">      messageDigest.update(mkChecksumInput(user));</span>
<span class="fc" id="L104">    }</span>
<span class="fc bfc" id="L105" title="All 2 branches covered.">    if (episodeDublincore.isSome()) {</span>
<span class="fc" id="L106">      Catalog episodeCatalog = $(mediaPackage.getCatalogs())</span>
<span class="fc" id="L107">          .filter(MediaPackageSupport.Filters.isEpisodeDublinCore.toFn()).head2();</span>
<span class="fc" id="L108">      Checksum checksum = episodeCatalog.getChecksum();</span>
<span class="fc bfc" id="L109" title="All 2 branches covered.">      if (checksum == null) {</span>
<span class="fc" id="L110">        checksum = DublinCoreUtil.calculateChecksum(episodeDublincore.get());</span>
<span class="fc" id="L111">        episodeCatalog.setChecksum(checksum);</span>
      }
<span class="fc" id="L113">      messageDigest.update(mkChecksumInput(checksum.toString()));</span>
    }
    // Add extended metadata to calculation
<span class="fc bfc" id="L116" title="All 2 branches covered.">    for (Catalog c : $(mediaPackage.getCatalogs()).sort(sortCatalogById)) {</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">      if (eventCatalogUIAdapterFlavors.contains(c.getFlavor())) {</span>
<span class="fc" id="L118">        Checksum checksum = c.getChecksum();</span>
<span class="fc bfc" id="L119" title="All 2 branches covered.">        if (checksum == null) {</span>
<span class="fc" id="L120">          DublinCoreCatalog dublinCore = DublinCoreUtil.loadDublinCore(workspace, c);</span>
<span class="fc" id="L121">          checksum = DublinCoreUtil.calculateChecksum(dublinCore);</span>
<span class="fc" id="L122">          c.setChecksum(checksum);</span>
        }
<span class="fc" id="L124">        messageDigest.update(mkChecksumInput(checksum.toString()));</span>
      }
<span class="fc" id="L126">    }</span>
<span class="fc" id="L127">    messageDigest.update(mkChecksumInput(AccessControlUtil.calculateChecksum(acl).toString()));</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">    for (Entry&lt;String, String&gt; entry : new TreeMap&lt;&gt;(wfProperties).entrySet()) {</span>
<span class="fc" id="L129">      messageDigest.update(mkChecksumInput(entry.getKey()));</span>
<span class="fc" id="L130">      messageDigest.update(mkChecksumInput(entry.getValue()));</span>
<span class="fc" id="L131">    }</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">    for (Entry&lt;String, String&gt; entry : new TreeMap&lt;&gt;(finalCaProperties).entrySet()) {</span>
<span class="fc" id="L133">      messageDigest.update(mkChecksumInput(entry.getKey()));</span>
<span class="fc" id="L134">      messageDigest.update(mkChecksumInput(entry.getValue()));</span>
<span class="fc" id="L135">    }</span>
<span class="fc" id="L136">    return Checksum.convertToHex(messageDigest.digest());</span>
  }

  private static MessageDigest mkMd5MessageDigest() {
    try {
<span class="fc" id="L141">      return MessageDigest.getInstance(&quot;MD5&quot;);</span>
<span class="nc" id="L142">    } catch (NoSuchAlgorithmException e) {</span>
<span class="nc" id="L143">      logger.error(&quot;Unable to create md5 message digest&quot;);</span>
<span class="nc" id="L144">      return chuck(e);</span>
    }
  }

  private static byte[] mkChecksumInput(String input) {
<span class="fc" id="L149">    return input.getBytes(StandardCharsets.UTF_8);</span>
  }

  private static byte[] mkChecksumInput(Date input) {
<span class="fc" id="L153">    return mkChecksumInput(Long.toString(input.getTime()));</span>
  }

  /**
   * Converts a scheduler event to a human readable string
   *
   * @param workspace
   *          the workspace
   * @param catalogFlavors
   *          the event catalog flavors
   * @param event
   *          the scheduler event
   * @return a human readable string
   */
  public static String toHumanReadableString(Workspace workspace, List&lt;MediaPackageElementFlavor&gt; catalogFlavors,
          SchedulerEvent event) {
<span class="nc" id="L169">    TechnicalMetadata technicalMetadata = event.getTechnicalMetadata();</span>
<span class="nc" id="L170">    StringBuilder sb = new StringBuilder(&quot;Event: &quot;).append(CharUtils.LF);</span>
<span class="nc" id="L171">    sb.append(&quot;- &quot;).append(event.getEventId()).append(CharUtils.LF);</span>
<span class="nc" id="L172">    sb.append(CharUtils.LF);</span>

<span class="nc" id="L174">    sb.append(&quot;Version&quot;).append(CharUtils.LF);</span>
<span class="nc" id="L175">    sb.append(&quot;- &quot;).append(event.getVersion()).append(CharUtils.LF);</span>
<span class="nc" id="L176">    sb.append(CharUtils.LF);</span>

<span class="nc" id="L178">    sb.append(&quot;Start&quot;).append(CharUtils.LF);</span>
<span class="nc" id="L179">    sb.append(&quot;- &quot;).append(DateTimeSupport.toUTC(technicalMetadata.getStartDate().getTime())).append(CharUtils.LF);</span>
<span class="nc" id="L180">    sb.append(CharUtils.LF);</span>

<span class="nc" id="L182">    sb.append(&quot;End&quot;).append(CharUtils.LF);</span>
<span class="nc" id="L183">    sb.append(&quot;- &quot;).append(DateTimeSupport.toUTC(technicalMetadata.getEndDate().getTime())).append(CharUtils.LF);</span>
<span class="nc" id="L184">    sb.append(CharUtils.LF);</span>

<span class="nc" id="L186">    sb.append(&quot;Room&quot;).append(CharUtils.LF);</span>
<span class="nc" id="L187">    sb.append(&quot;- &quot;).append(technicalMetadata.getAgentId()).append(CharUtils.LF);</span>
<span class="nc" id="L188">    sb.append(CharUtils.LF);</span>

<span class="nc" id="L190">    sb.append(&quot;Scheduling configuration&quot;).append(CharUtils.LF);</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">    for (Entry&lt;String, String&gt; entry : technicalMetadata.getCaptureAgentConfiguration().entrySet()) {</span>
<span class="nc" id="L192">      sb.append(&quot;- &quot;).append(entry.getKey()).append(&quot;: &quot;).append(entry.getValue()).append(CharUtils.LF);</span>
<span class="nc" id="L193">    }</span>
<span class="nc" id="L194">    sb.append(CharUtils.LF);</span>

<span class="nc" id="L196">    sb.append(&quot;Presenters&quot;).append(CharUtils.LF);</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">    for (String presenter : technicalMetadata.getPresenters()) {</span>
<span class="nc" id="L198">      sb.append(&quot;- &quot;).append(presenter).append(CharUtils.LF);</span>
<span class="nc" id="L199">    }</span>
<span class="nc" id="L200">    sb.append(CharUtils.LF);</span>

<span class="nc" id="L202">    sb.append(&quot;Workflow configuration&quot;).append(CharUtils.LF);</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">    for (Entry&lt;String, String&gt; entry : technicalMetadata.getWorkflowProperties().entrySet()) {</span>
<span class="nc" id="L204">      sb.append(&quot;- &quot;).append(entry.getKey()).append(&quot;: &quot;).append(entry.getValue()).append(CharUtils.LF);</span>
<span class="nc" id="L205">    }</span>
<span class="nc" id="L206">    sb.append(CharUtils.LF);</span>

<span class="nc bnc" id="L208" title="All 2 branches missed.">    for (Catalog c : $(event.getMediaPackage().getCatalogs())) {</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">      if (!catalogFlavors.contains(c.getFlavor()))</span>
<span class="nc" id="L210">        continue;</span>

      DublinCoreCatalog dublinCore;
      try {
<span class="nc" id="L214">        dublinCore = DublinCoreUtil.loadDublinCore(workspace, c);</span>
<span class="nc" id="L215">      } catch (Exception e) {</span>
<span class="nc" id="L216">        logger.error(&quot;Unable to read event dublincore&quot;, e);</span>
<span class="nc" id="L217">        continue;</span>
<span class="nc" id="L218">      }</span>

<span class="nc" id="L220">      sb.append(&quot;Event metadata &quot;).append(&quot;(&quot;).append(c.getFlavor().toString()).append(&quot;)&quot;).append(CharUtils.LF);</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">      for (Entry&lt;EName, List&lt;DublinCoreValue&gt;&gt; entry : dublinCore.getValues().entrySet()) {</span>
<span class="nc" id="L222">        EName eName = entry.getKey();</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">        for (DublinCoreValue value : entry.getValue()) {</span>
<span class="nc" id="L224">          sb.append(&quot;- &quot;).append(eName.getNamespaceURI()).append(&quot;:&quot;).append(eName.getLocalName()).append(&quot;: &quot;)</span>
<span class="nc" id="L225">                  .append(value.getValue());</span>

<span class="nc bnc" id="L227" title="All 2 branches missed.">          boolean hasLanguageDefined = !DublinCore.LANGUAGE_UNDEFINED.equals(value.getLanguage());</span>

<span class="nc bnc" id="L229" title="All 4 branches missed.">          if (hasLanguageDefined || value.getEncodingScheme().isSome()) {</span>
<span class="nc" id="L230">            sb.append(&quot; (&quot;);</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">            if (hasLanguageDefined) {</span>
<span class="nc" id="L232">              sb.append(&quot;lang:&quot;).append(value.getLanguage());</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">              if (value.getEncodingScheme().isSome())</span>
<span class="nc" id="L234">                sb.append(&quot;/&quot;);</span>
            }

<span class="nc bnc" id="L237" title="All 2 branches missed.">            for (EName schema : value.getEncodingScheme()) {</span>
<span class="nc" id="L238">              sb.append(schema.getLocalName());</span>
<span class="nc" id="L239">            }</span>
<span class="nc" id="L240">            sb.append(&quot;)&quot;);</span>
          }
<span class="nc" id="L242">          sb.append(CharUtils.LF);</span>
<span class="nc" id="L243">        }</span>
<span class="nc" id="L244">      }</span>
<span class="nc" id="L245">      sb.append(CharUtils.LF);</span>
<span class="nc" id="L246">    }</span>
<span class="nc" id="L247">    return sb.toString();</span>
  }

<span class="fc" id="L250">  public static final Fn&lt;MediaPackageElementFlavor, Boolean&gt; isNotEpisodeDublinCore = new Fn&lt;MediaPackageElementFlavor, Boolean&gt;() {</span>
    @Override
    public Boolean apply(MediaPackageElementFlavor mpe) {
      // match is commutative
<span class="fc bfc" id="L254" title="All 2 branches covered.">      return !MediaPackageElements.EPISODE.matches(mpe);</span>
    }
  };

<span class="fc" id="L258">  public static final Fn&lt;EventCatalogUIAdapter, MediaPackageElementFlavor&gt; uiAdapterToFlavor = new Fn&lt;EventCatalogUIAdapter, MediaPackageElementFlavor&gt;() {</span>
    @Override
    public MediaPackageElementFlavor apply(EventCatalogUIAdapter adapter) {
<span class="fc" id="L261">      return adapter.getFlavor();</span>
    }
  };

<span class="fc" id="L265">  public static final Fn2&lt;EventCatalogUIAdapter, String, Boolean&gt; eventOrganizationFilter = new Fn2&lt;EventCatalogUIAdapter, String, Boolean&gt;() {</span>
    @Override
    public Boolean apply(EventCatalogUIAdapter catalogUIAdapter, String organization) {
<span class="fc" id="L268">      return catalogUIAdapter.getOrganization().equals(organization);</span>
    }
  };
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>