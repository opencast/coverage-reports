<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>WorkflowsEndpoint.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-external-api</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.external.endpoint</a> &gt; <span class="el_source">WorkflowsEndpoint.java</span></div><h1>WorkflowsEndpoint.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.external.endpoint;

import static com.entwinemedia.fn.data.json.Jsons.BLANK;
import static com.entwinemedia.fn.data.json.Jsons.ZERO;
import static com.entwinemedia.fn.data.json.Jsons.arr;
import static com.entwinemedia.fn.data.json.Jsons.f;
import static com.entwinemedia.fn.data.json.Jsons.obj;
import static com.entwinemedia.fn.data.json.Jsons.v;
import static java.time.ZoneOffset.UTC;
import static org.apache.commons.lang3.StringUtils.isBlank;
import static org.apache.commons.lang3.StringUtils.isNoneBlank;
import static org.opencastproject.util.RestUtil.getEndpointUrl;
import static org.opencastproject.util.doc.rest.RestParameter.Type.BOOLEAN;
import static org.opencastproject.util.doc.rest.RestParameter.Type.INTEGER;
import static org.opencastproject.util.doc.rest.RestParameter.Type.STRING;

import org.opencastproject.elasticsearch.index.ElasticsearchIndex;
import org.opencastproject.elasticsearch.index.objects.event.Event;
import org.opencastproject.external.common.ApiMediaType;
import org.opencastproject.external.common.ApiResponseBuilder;
import org.opencastproject.external.common.ApiVersion;
import org.opencastproject.index.service.api.IndexService;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.rest.RestConstants;
import org.opencastproject.security.api.UnauthorizedException;
import org.opencastproject.systems.OpencastConstants;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.RestUtil;
import org.opencastproject.util.UrlSupport;
import org.opencastproject.util.data.Tuple;
import org.opencastproject.util.doc.rest.RestParameter;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestResponse;
import org.opencastproject.util.doc.rest.RestService;
import org.opencastproject.workflow.api.RetryStrategy;
import org.opencastproject.workflow.api.WorkflowDefinition;
import org.opencastproject.workflow.api.WorkflowInstance;
import org.opencastproject.workflow.api.WorkflowOperationInstance;
import org.opencastproject.workflow.api.WorkflowService;
import org.opencastproject.workflow.api.WorkflowStateException;

import com.entwinemedia.fn.data.Opt;
import com.entwinemedia.fn.data.json.Field;
import com.entwinemedia.fn.data.json.JValue;

import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.jaxrs.whiteboard.propertytypes.JaxrsResource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.net.URI;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.DELETE;
import javax.ws.rs.FormParam;
import javax.ws.rs.GET;
import javax.ws.rs.HeaderParam;
import javax.ws.rs.POST;
import javax.ws.rs.PUT;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.core.Response;

@Path(&quot;/api/workflows&quot;)
@Produces({ ApiMediaType.JSON, ApiMediaType.VERSION_1_1_0, ApiMediaType.VERSION_1_2_0, ApiMediaType.VERSION_1_3_0,
            ApiMediaType.VERSION_1_4_0, ApiMediaType.VERSION_1_5_0, ApiMediaType.VERSION_1_6_0,
            ApiMediaType.VERSION_1_7_0, ApiMediaType.VERSION_1_8_0, ApiMediaType.VERSION_1_9_0,
            ApiMediaType.VERSION_1_10_0, ApiMediaType.VERSION_1_11_0 })
@RestService(name = &quot;externalapiworkflowinstances&quot;, title = &quot;External API Workflow Instances Service&quot;, notes = {},
             abstractText = &quot;Provides resources and operations related to the workflow instances&quot;)
@Component(
    immediate = true,
    service = WorkflowsEndpoint.class,
    property = {
        &quot;service.description=External API - Workflow Instances Endpoint&quot;,
        &quot;opencast.service.type=org.opencastproject.external.workflows.instances&quot;,
        &quot;opencast.service.path=/api/workflows&quot;
    }
)
@JaxrsResource
<span class="fc" id="L115">public class WorkflowsEndpoint {</span>
  /** The logging facility */
<span class="fc" id="L117">  private static final Logger logger = LoggerFactory.getLogger(WorkflowsEndpoint.class);</span>

  /** Base URL of this endpoint */
  protected String endpointBaseUrl;

  /* OSGi service references */
  private WorkflowService workflowService;
  private ElasticsearchIndex elasticsearchIndex;
  private IndexService indexService;

  /** OSGi DI */
  @Reference
  public void setWorkflowService(WorkflowService workflowService) {
<span class="fc" id="L130">    this.workflowService = workflowService;</span>
<span class="fc" id="L131">  }</span>

  /** OSGi DI */
  @Reference
  public void setElasticsearchIndex(ElasticsearchIndex elasticsearchIndex) {
<span class="nc" id="L136">    this.elasticsearchIndex = elasticsearchIndex;</span>
<span class="nc" id="L137">  }</span>

  /** OSGi DI */
  @Reference
  public void setIndexService(IndexService indexService) {
<span class="fc" id="L142">    this.indexService = indexService;</span>
<span class="fc" id="L143">  }</span>

  /**
   * OSGi activation method
   */
  @Activate
  void activate(ComponentContext cc) {
<span class="nc" id="L150">    logger.info(&quot;Activating External API - Workflow Instances Endpoint&quot;);</span>

<span class="nc" id="L152">    final Tuple&lt;String, String&gt; endpointUrl = getEndpointUrl(cc, OpencastConstants.EXTERNAL_API_URL_ORG_PROPERTY,</span>
            RestConstants.SERVICE_PATH_PROPERTY);
<span class="nc" id="L154">    endpointBaseUrl = UrlSupport.concat(endpointUrl.getA(), endpointUrl.getB());</span>
<span class="nc" id="L155">    logger.debug(&quot;Configured service endpoint is {}&quot;, endpointBaseUrl);</span>
<span class="nc" id="L156">  }</span>

  @POST
  @Path(&quot;&quot;)
  @RestQuery(name = &quot;createworkflowinstance&quot;, description = &quot;Creates a workflow instance.&quot;, returnDescription = &quot;&quot;, restParameters = {
          @RestParameter(name = &quot;event_identifier&quot;, description = &quot;The event identifier this workflow should run against&quot;, isRequired = true, type = STRING),
          @RestParameter(name = &quot;workflow_definition_identifier&quot;, description = &quot;The identifier of the workflow definition to use&quot;, isRequired = true, type = STRING),
          @RestParameter(name = &quot;configuration&quot;, description = &quot;The optional configuration for this workflow&quot;, isRequired = false, type = STRING),
          @RestParameter(name = &quot;withoperations&quot;, description = &quot;Whether the workflow operations should be included in the response&quot;, isRequired = false, type = BOOLEAN),
          @RestParameter(name = &quot;withconfiguration&quot;, description = &quot;Whether the workflow configuration should be included in the response&quot;, isRequired = false, type = BOOLEAN), }, responses = {
          @RestResponse(description = &quot;A new workflow is created and its identifier is returned in the Location header.&quot;, responseCode = HttpServletResponse.SC_CREATED),
          @RestResponse(description = &quot;The request is invalid or inconsistent.&quot;, responseCode = HttpServletResponse.SC_BAD_REQUEST),
          @RestResponse(description = &quot;The event or workflow definition could not be found.&quot;, responseCode = HttpServletResponse.SC_NOT_FOUND) })
  public Response createWorkflowInstance(@HeaderParam(&quot;Accept&quot;) String acceptHeader,
          @FormParam(&quot;event_identifier&quot;) String eventId,
          @FormParam(&quot;workflow_definition_identifier&quot;) String workflowDefinitionIdentifier,
          @FormParam(&quot;configuration&quot;) String configuration, @QueryParam(&quot;withoperations&quot;) boolean withOperations,
          @QueryParam(&quot;withconfiguration&quot;) boolean withConfiguration) {
<span class="fc bfc" id="L174" title="All 2 branches covered.">    if (isBlank(eventId)) {</span>
<span class="fc" id="L175">      return RestUtil.R.badRequest(&quot;Required parameter 'event_identifier' is missing or invalid&quot;);</span>
    }

<span class="fc bfc" id="L178" title="All 2 branches covered.">    if (isBlank(workflowDefinitionIdentifier)) {</span>
<span class="fc" id="L179">      return RestUtil.R.badRequest(&quot;Required parameter 'workflow_definition_identifier' is missing or invalid&quot;);</span>
    }

    try {
      // Media Package
<span class="fc" id="L184">      Opt&lt;Event&gt; event = indexService.getEvent(eventId, elasticsearchIndex);</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">      if (event.isNone()) {</span>
<span class="fc" id="L186">        return ApiResponseBuilder.notFound(&quot;Cannot find an event with id '%s'.&quot;, eventId);</span>
      }
<span class="fc" id="L188">      MediaPackage mp = indexService.getEventMediapackage(event.get());</span>

      // Workflow definition
      WorkflowDefinition wd;
      try {
<span class="fc" id="L193">        wd = workflowService.getWorkflowDefinitionById(workflowDefinitionIdentifier);</span>
<span class="fc" id="L194">      } catch (NotFoundException e) {</span>
<span class="fc" id="L195">        return ApiResponseBuilder.notFound(&quot;Cannot find a workflow definition with id '%s'.&quot;, workflowDefinitionIdentifier);</span>
<span class="fc" id="L196">      }</span>

      // Configuration
<span class="fc" id="L199">      Map&lt;String, String&gt; properties = new HashMap&lt;&gt;();</span>
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">      if (isNoneBlank(configuration)) {</span>
<span class="fc" id="L201">        JSONParser parser = new JSONParser();</span>
        try {
<span class="fc" id="L203">          properties.putAll((JSONObject) parser.parse(configuration));</span>
<span class="fc" id="L204">        } catch (ParseException e) {</span>
<span class="fc" id="L205">          return RestUtil.R.badRequest(&quot;Passed parameter 'configuration' is invalid JSON.&quot;);</span>
<span class="fc" id="L206">        }</span>
      }

      // Start workflow
<span class="fc" id="L210">      WorkflowInstance wi = workflowService.start(wd, mp, null, properties);</span>
<span class="fc" id="L211">      return ApiResponseBuilder.Json.created(acceptHeader, URI.create(getWorkflowUrl(wi.getId())),</span>
<span class="fc" id="L212">              workflowInstanceToJSON(wi, withOperations, withConfiguration));</span>
<span class="fc" id="L213">    } catch (IllegalStateException e) {</span>
<span class="fc" id="L214">      final ApiVersion requestedVersion = ApiMediaType.parse(acceptHeader).getVersion();</span>
<span class="fc" id="L215">      return ApiResponseBuilder.Json.conflict(requestedVersion, obj(f(&quot;message&quot;, v(e.getMessage(), BLANK))));</span>
<span class="nc" id="L216">    } catch (Exception e) {</span>
<span class="nc" id="L217">      logger.error(&quot;Could not create workflow instances&quot;, e);</span>
<span class="nc" id="L218">      return ApiResponseBuilder.serverError(&quot;Could not create workflow instances, reason: '%s'&quot;, e.getMessage());</span>
    }
  }

  @GET
  @Path(&quot;{workflowInstanceId}&quot;)
  @RestQuery(name = &quot;getworkflowinstance&quot;, description = &quot;Returns a single workflow instance.&quot;, returnDescription = &quot;&quot;, pathParameters = {
          @RestParameter(name = &quot;workflowInstanceId&quot;, description = &quot;The workflow instance id&quot;, isRequired = true, type = INTEGER) }, restParameters = {
          @RestParameter(name = &quot;withoperations&quot;, description = &quot;Whether the workflow operations should be included in the response&quot;, isRequired = false, type = BOOLEAN),
          @RestParameter(name = &quot;withconfiguration&quot;, description = &quot;Whether the workflow configuration should be included in the response&quot;, isRequired = false, type = BOOLEAN) }, responses = {
          @RestResponse(description = &quot;The workflow instance is returned.&quot;, responseCode = HttpServletResponse.SC_OK),
          @RestResponse(description = &quot;The user doesn't have the rights to make this request.&quot;, responseCode = HttpServletResponse.SC_FORBIDDEN),
          @RestResponse(description = &quot;The specified workflow instance does not exist.&quot;, responseCode = HttpServletResponse.SC_NOT_FOUND) })
  public Response getWorkflowInstance(@HeaderParam(&quot;Accept&quot;) String acceptHeader,
          @PathParam(&quot;workflowInstanceId&quot;) Long id, @QueryParam(&quot;withoperations&quot;) boolean withOperations,
          @QueryParam(&quot;withconfiguration&quot;) boolean withConfiguration) {
    WorkflowInstance wi;
    try {
<span class="fc" id="L236">      wi = workflowService.getWorkflowById(id);</span>
<span class="fc" id="L237">    } catch (NotFoundException e) {</span>
<span class="fc" id="L238">      return ApiResponseBuilder.notFound(&quot;Cannot find workflow instance with id '%d'.&quot;, id);</span>
<span class="fc" id="L239">    } catch (UnauthorizedException e) {</span>
<span class="fc" id="L240">      return Response.status(Response.Status.FORBIDDEN).build();</span>
<span class="nc" id="L241">    } catch (Exception e) {</span>
<span class="nc" id="L242">      logger.error(&quot;The workflow service was not able to get the workflow instance&quot;, e);</span>
<span class="nc" id="L243">      return ApiResponseBuilder.serverError(&quot;Could not retrieve workflow instance, reason: '%s'&quot;, e.getMessage());</span>
<span class="fc" id="L244">    }</span>

<span class="fc" id="L246">    return ApiResponseBuilder.Json.ok(acceptHeader, workflowInstanceToJSON(wi, withOperations, withConfiguration));</span>
  }

  @PUT
  @Path(&quot;{workflowInstanceId}&quot;)
  @RestQuery(name = &quot;updateworkflowinstance&quot;, description = &quot;Creates a workflow instance.&quot;, returnDescription = &quot;&quot;, pathParameters = {
          @RestParameter(name = &quot;workflowInstanceId&quot;, description = &quot;The workflow instance id&quot;, isRequired = true, type = INTEGER) }, restParameters = {
          @RestParameter(name = &quot;configuration&quot;, description = &quot;The optional configuration for this workflow&quot;, isRequired = false, type = STRING),
          @RestParameter(name = &quot;state&quot;, description = &quot;The optional state transition for this workflow&quot;, isRequired = false, type = STRING),
          @RestParameter(name = &quot;withoperations&quot;, description = &quot;Whether the workflow operations should be included in the response&quot;, isRequired = false, type = BOOLEAN),
          @RestParameter(name = &quot;withconfiguration&quot;, description = &quot;Whether the workflow configuration should be included in the response&quot;, isRequired = false, type = BOOLEAN), }, responses = {
          @RestResponse(description = &quot;The workflow instance is updated.&quot;, responseCode = HttpServletResponse.SC_OK),
          @RestResponse(description = &quot;The request is invalid or inconsistent.&quot;, responseCode = HttpServletResponse.SC_BAD_REQUEST),
          @RestResponse(description = &quot;The user doesn't have the rights to make this request.&quot;, responseCode = HttpServletResponse.SC_FORBIDDEN),
          @RestResponse(description = &quot;The workflow instance could not be found.&quot;, responseCode = HttpServletResponse.SC_NOT_FOUND),
          @RestResponse(description = &quot;The workflow instance cannot transition to this state.&quot;, responseCode = HttpServletResponse.SC_CONFLICT) })
  public Response updateWorkflowInstance(@HeaderParam(&quot;Accept&quot;) String acceptHeader,
          @PathParam(&quot;workflowInstanceId&quot;) Long id, @FormParam(&quot;configuration&quot;) String configuration,
          @FormParam(&quot;state&quot;) String stateStr, @QueryParam(&quot;withoperations&quot;) boolean withOperations,
          @QueryParam(&quot;withconfiguration&quot;) boolean withConfiguration) {
    try {
<span class="fc" id="L267">      boolean changed = false;</span>
<span class="fc" id="L268">      WorkflowInstance wi = workflowService.getWorkflowById(id);</span>

      // Configuration
<span class="fc bfc" id="L271" title="All 2 branches covered.">      if (isNoneBlank(configuration)) {</span>
<span class="fc" id="L272">        JSONParser parser = new JSONParser();</span>
        try {
<span class="fc" id="L274">          Map&lt;String, String&gt; properties = new HashMap&lt;&gt;((JSONObject) parser.parse(configuration));</span>

          // Remove old configuration
<span class="fc" id="L277">          wi.getConfigurationKeys().forEach(wi::removeConfiguration);</span>
          // Add new configuration
<span class="fc" id="L279">          properties.forEach(wi::setConfiguration);</span>

<span class="fc" id="L281">          changed = true;</span>
<span class="fc" id="L282">        } catch (ParseException e) {</span>
<span class="fc" id="L283">          return RestUtil.R.badRequest(&quot;Passed parameter 'configuration' is invalid JSON.&quot;);</span>
<span class="fc" id="L284">        }</span>
      }

      // TODO: does it make sense to change the media package?

<span class="fc bfc" id="L289" title="All 2 branches covered.">      if (changed) {</span>
<span class="fc" id="L290">        workflowService.update(wi);</span>
      }

      // State change
<span class="fc bfc" id="L294" title="All 2 branches covered.">      if (isNoneBlank(stateStr)) {</span>
        WorkflowInstance.WorkflowState state;
        try {
<span class="fc" id="L297">          state = jsonToEnum(WorkflowInstance.WorkflowState.class, stateStr);</span>
<span class="nc" id="L298">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L299">          return RestUtil.R.badRequest(String.format(&quot;Invalid workflow state '%s'&quot;, stateStr));</span>
<span class="fc" id="L300">        }</span>

<span class="fc" id="L302">        WorkflowInstance.WorkflowState currentState = wi.getState();</span>
<span class="pc bpc" id="L303" title="1 of 2 branches missed.">        if (state != currentState) {</span>
          // Allowed transitions:
          //
          //   instantiated -&gt; paused, stopped, running
          //   running      -&gt; paused, stopped
          //   failing      -&gt; paused, stopped
          //   paused       -&gt; paused, stopped, running
          //   succeeded    -&gt; paused, stopped
          //   stopped      -&gt; paused, stopped
          //   failed       -&gt; paused, stopped
<span class="pc bpc" id="L313" title="2 of 4 branches missed.">          switch (state) {</span>
            case PAUSED:
<span class="fc" id="L315">              workflowService.suspend(wi.getId());</span>
<span class="fc" id="L316">              break;</span>
            case STOPPED:
<span class="nc" id="L318">              workflowService.stop(wi.getId());</span>
<span class="nc" id="L319">              break;</span>
            case RUNNING:
<span class="pc bpc" id="L321" title="2 of 4 branches missed.">              if (currentState == WorkflowInstance.WorkflowState.INSTANTIATED</span>
                      || currentState == WorkflowInstance.WorkflowState.PAUSED) {
<span class="nc" id="L323">                workflowService.resume(wi.getId());</span>
              } else {
<span class="fc" id="L325">                return RestUtil.R.conflict(</span>
<span class="fc" id="L326">                        String.format(&quot;Cannot resume from workflow state '%s'&quot;, currentState.toString().toLowerCase()));</span>
              }
              break;
            default:
<span class="nc" id="L330">              return RestUtil.R.conflict(</span>
<span class="nc" id="L331">                      String.format(&quot;Cannot transition state from '%s' to '%s'&quot;, currentState.toString().toLowerCase(),</span>
                              stateStr));
          }
        }
      }

<span class="fc" id="L337">      wi = workflowService.getWorkflowById(id);</span>
<span class="fc" id="L338">      return ApiResponseBuilder.Json.ok(acceptHeader, workflowInstanceToJSON(wi, withOperations, withConfiguration));</span>
<span class="fc" id="L339">    } catch (NotFoundException e) {</span>
<span class="fc" id="L340">      return ApiResponseBuilder.notFound(&quot;Cannot find workflow instance with id '%d'.&quot;, id);</span>
<span class="fc" id="L341">    } catch (UnauthorizedException e) {</span>
<span class="fc" id="L342">      return Response.status(Response.Status.FORBIDDEN).build();</span>
<span class="nc" id="L343">    } catch (Exception e) {</span>
<span class="nc" id="L344">      logger.error(&quot;The workflow service was not able to get the workflow instance&quot;, e);</span>
<span class="nc" id="L345">      return ApiResponseBuilder.serverError(&quot;Could not retrieve workflow instance, reason: '%s'&quot;, e.getMessage());</span>
    }
  }

  @DELETE
  @Path(&quot;{workflowInstanceId}&quot;)
  @RestQuery(name = &quot;deleteworkflowinstance&quot;, description = &quot;Deletes a workflow instance.&quot;, returnDescription = &quot;&quot;, pathParameters = {
          @RestParameter(name = &quot;workflowInstanceId&quot;, description = &quot;The workflow instance id&quot;, isRequired = true, type = INTEGER) }, responses = {
          @RestResponse(description = &quot;The workflow instance has been deleted.&quot;, responseCode = HttpServletResponse.SC_NO_CONTENT),
          @RestResponse(description = &quot;The user doesn't have the rights to make this request.&quot;, responseCode = HttpServletResponse.SC_FORBIDDEN),
          @RestResponse(description = &quot;The specified workflow instance does not exist.&quot;, responseCode = HttpServletResponse.SC_NOT_FOUND),
          @RestResponse(description = &quot;The workflow instance cannot be deleted in this state.&quot;, responseCode = HttpServletResponse.SC_CONFLICT) })
  public Response deleteWorkflowInstance(@HeaderParam(&quot;Accept&quot;) String acceptHeader,
          @PathParam(&quot;workflowInstanceId&quot;) Long id) {
    try {
<span class="fc" id="L360">      workflowService.remove(id);</span>
<span class="fc" id="L361">    } catch (WorkflowStateException e) {</span>
<span class="fc" id="L362">      return RestUtil.R.conflict(&quot;Cannot delete workflow instance in this workflow state&quot;);</span>
<span class="fc" id="L363">    } catch (NotFoundException e) {</span>
<span class="fc" id="L364">      return ApiResponseBuilder.notFound(&quot;Cannot find workflow instance with id '%d'.&quot;, id);</span>
<span class="fc" id="L365">    } catch (UnauthorizedException e) {</span>
<span class="fc" id="L366">      return Response.status(Response.Status.FORBIDDEN).build();</span>
<span class="nc" id="L367">    } catch (Exception e) {</span>
<span class="nc" id="L368">      logger.error(&quot;Could not delete workflow instances&quot;, e);</span>
<span class="nc" id="L369">      return ApiResponseBuilder.serverError(&quot;Could not delete workflow instances, reason: '%s'&quot;, e.getMessage());</span>
<span class="fc" id="L370">    }</span>

<span class="fc" id="L372">    return Response.noContent().build();</span>
  }

  private JValue workflowInstanceToJSON(WorkflowInstance wi, boolean withOperations, boolean withConfiguration) {
<span class="fc" id="L376">    List&lt;Field&gt; fields = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L378">    fields.add(f(&quot;identifier&quot;, v(wi.getId())));</span>
<span class="fc" id="L379">    fields.add(f(&quot;title&quot;, v(wi.getTitle(), BLANK)));</span>
<span class="fc" id="L380">    fields.add(f(&quot;description&quot;, v(wi.getDescription(), BLANK)));</span>
<span class="fc" id="L381">    fields.add(f(&quot;workflow_definition_identifier&quot;, v(wi.getTemplate(), BLANK)));</span>
<span class="fc" id="L382">    fields.add(f(&quot;event_identifier&quot;, v(wi.getMediaPackage().getIdentifier().toString())));</span>
<span class="fc" id="L383">    fields.add(f(&quot;creator&quot;, v(wi.getCreatorName())));</span>
<span class="fc" id="L384">    fields.add(f(&quot;state&quot;, enumToJSON(wi.getState())));</span>
<span class="fc bfc" id="L385" title="All 2 branches covered.">    if (withOperations) {</span>
<span class="fc" id="L386">      fields.add(f(&quot;operations&quot;, arr(wi.getOperations()</span>
<span class="fc" id="L387">                                       .stream()</span>
<span class="fc" id="L388">                                       .map(this::workflowOperationInstanceToJSON)</span>
<span class="fc" id="L389">                                       .collect(Collectors.toList()))));</span>
    }
<span class="pc bpc" id="L391" title="1 of 2 branches missed.">    if (withConfiguration) {</span>
<span class="fc" id="L392">      fields.add(f(&quot;configuration&quot;, obj(wi.getConfigurationKeys()</span>
<span class="fc" id="L393">                                          .stream()</span>
<span class="fc" id="L394">                                          .map(key -&gt; f(key, wi.getConfiguration(key)))</span>
<span class="fc" id="L395">                                          .collect(Collectors.toList()))));</span>
    }

<span class="fc" id="L398">    return obj(fields);</span>
  }

  private JValue workflowOperationInstanceToJSON(WorkflowOperationInstance woi) {
<span class="fc" id="L402">    List&lt;Field&gt; fields = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L403">    DateTimeFormatter dateFormatter = DateTimeFormatter.ISO_DATE_TIME;</span>

    // The job ID can be null if the workflow was just created
<span class="fc" id="L406">    fields.add(f(&quot;identifier&quot;, v(woi.getId(), BLANK)));</span>
<span class="fc" id="L407">    fields.add(f(&quot;operation&quot;, v(woi.getTemplate())));</span>
<span class="fc" id="L408">    fields.add(f(&quot;description&quot;, v(woi.getDescription(), BLANK)));</span>
<span class="fc" id="L409">    fields.add(f(&quot;state&quot;, enumToJSON(woi.getState())));</span>
<span class="fc" id="L410">    fields.add(f(&quot;time_in_queue&quot;, v(woi.getTimeInQueue(), ZERO)));</span>
<span class="fc" id="L411">    fields.add(f(&quot;host&quot;, v(woi.getExecutionHost(), BLANK)));</span>
<span class="fc" id="L412">    fields.add(f(&quot;if&quot;, v(woi.getExecutionCondition(), BLANK)));</span>
<span class="fc" id="L413">    fields.add(f(&quot;fail_workflow_on_error&quot;, v(woi.isFailOnError())));</span>
<span class="fc" id="L414">    fields.add(f(&quot;error_handler_workflow&quot;, v(woi.getExceptionHandlingWorkflow(), BLANK)));</span>
<span class="fc" id="L415">    fields.add(f(&quot;retry_strategy&quot;, v(new RetryStrategy.Adapter().marshal(woi.getRetryStrategy()), BLANK)));</span>
<span class="fc" id="L416">    fields.add(f(&quot;max_attempts&quot;, v(woi.getMaxAttempts())));</span>
<span class="fc" id="L417">    fields.add(f(&quot;failed_attempts&quot;, v(woi.getFailedAttempts())));</span>
<span class="fc" id="L418">    fields.add(f(&quot;configuration&quot;, obj(woi.getConfigurationKeys()</span>
<span class="fc" id="L419">                                         .stream()</span>
<span class="fc" id="L420">                                         .map(key -&gt; f(key, woi.getConfiguration(key)))</span>
<span class="fc" id="L421">                                         .collect(Collectors.toList()))));</span>
<span class="pc bpc" id="L422" title="1 of 2 branches missed.">    if (woi.getDateStarted() != null) {</span>
<span class="fc" id="L423">      fields.add(f(&quot;start&quot;, v(dateFormatter.format(woi.getDateStarted().toInstant().atZone(UTC)))));</span>
    } else {
<span class="nc" id="L425">      fields.add(f(&quot;start&quot;, BLANK));</span>
    }
<span class="pc bpc" id="L427" title="1 of 2 branches missed.">    if (woi.getDateCompleted() != null) {</span>
<span class="nc" id="L428">      fields.add(f(&quot;completion&quot;, v(dateFormatter.format(woi.getDateCompleted().toInstant().atZone(UTC)))));</span>
    } else {
<span class="fc" id="L430">      fields.add(f(&quot;completion&quot;, BLANK));</span>
    }

<span class="fc" id="L433">    return obj(fields);</span>
  }

  private JValue enumToJSON(Enum e) {
<span class="pc bpc" id="L437" title="1 of 2 branches missed.">    return e == null ? null : v(e.toString().toLowerCase());</span>
  }

  private &lt;T extends Enum&lt;T&gt;&gt; T jsonToEnum(Class&lt;T&gt; enumType, String name) {
<span class="fc" id="L441">    return Enum.valueOf(enumType, name.toUpperCase());</span>
  }

  private String getWorkflowUrl(long workflowInstanceId) {
<span class="fc" id="L445">    return UrlSupport.concat(endpointBaseUrl, Long.toString(workflowInstanceId));</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>