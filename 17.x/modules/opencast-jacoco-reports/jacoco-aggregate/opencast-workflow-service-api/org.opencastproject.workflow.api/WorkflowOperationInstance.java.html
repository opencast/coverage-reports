<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>WorkflowOperationInstance.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-workflow-service-api</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.workflow.api</a> &gt; <span class="el_source">WorkflowOperationInstance.java</span></div><h1>WorkflowOperationInstance.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.workflow.api;

import java.util.Collections;
import java.util.Date;
import java.util.Map;
import java.util.Objects;
import java.util.Set;
import java.util.TreeMap;

import javax.persistence.Access;
import javax.persistence.AccessType;
import javax.persistence.CollectionTable;
import javax.persistence.Column;
import javax.persistence.ElementCollection;
import javax.persistence.Entity;
import javax.persistence.FetchType;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;
import javax.persistence.Index;
import javax.persistence.JoinColumn;
import javax.persistence.Lob;
import javax.persistence.ManyToOne;
import javax.persistence.MapKeyColumn;
import javax.persistence.Table;
import javax.persistence.Temporal;
import javax.persistence.TemporalType;

/**
 * A workflow operation belonging to a workflow instance.
 */
@Entity(name = &quot;WorkflowOperationInstance&quot;)
@Access(AccessType.FIELD)
@Table(name = &quot;oc_workflow_operation&quot;, indexes = {
    @Index(name = &quot;IX_oc_workflow_operation_workflow_id&quot;, columnList = (&quot;workflow_id&quot;))})
public class WorkflowOperationInstance implements Configurable {
<span class="fc" id="L57">  public enum OperationState {</span>
<span class="fc" id="L58">    INSTANTIATED, RUNNING, PAUSED, SUCCEEDED, FAILED, SKIPPED, RETRY</span>
  }

  @Id
  @GeneratedValue
  @Column(name = &quot;id&quot;)
  private Long id;

  @Column(name = &quot;template&quot;)
  protected String template;

  @Column(name = &quot;job&quot;)
  protected Long jobId;

  @Column(name = &quot;state&quot;)
  protected OperationState state;

  @Column(name = &quot;description&quot;)
  @Lob
  protected String description;

  @ElementCollection
  @CollectionTable(
          name = &quot;oc_workflow_operation_configuration&quot;,
          joinColumns = @JoinColumn(name = &quot;workflow_operation_id&quot;),
          indexes = {
                @Index(name = &quot;IX_oc_workflow_operation_configuration_workflow_operation_id&quot;, columnList = (&quot;workflow_operation_id&quot;)),
          }
  )
  @MapKeyColumn(name = &quot;configuration_key&quot;, nullable = false)
  @Lob
  @Column(name = &quot;configuration_value&quot;)
  protected Map&lt;String, String&gt; configurations;

  @Column(name = &quot;fail_on_error&quot;)
  protected boolean failOnError;

  @Column(name = &quot;if_condition&quot;)
  @Lob
  protected String executeCondition;

  @Column(name = &quot;exception_handler_workflow&quot;)
  protected String exceptionHandlingWorkflow;

  @Column(name = &quot;abortable&quot;)
  protected Boolean abortable;

  @Column(name = &quot;continuable&quot;)
  protected Boolean continuable;

  @Column(name = &quot;started&quot;)
  @Temporal(TemporalType.TIMESTAMP)
  protected Date dateStarted;

  @Column(name = &quot;completed&quot;)
  @Temporal(TemporalType.TIMESTAMP)
  protected Date dateCompleted;

  @Column(name = &quot;time_in_queue&quot;)
  protected Long timeInQueue;

  @Column(name = &quot;max_attempts&quot;)
  protected int maxAttempts;

  @Column(name = &quot;failed_attempts&quot;)
  protected int failedAttempts;

  @Column(name = &quot;execution_host&quot;)
  protected String executionHost;

  @Column(name = &quot;retry_strategy&quot;, length = 128)
  protected RetryStrategy retryStrategy;

  @ManyToOne(fetch = FetchType.LAZY)
  @JoinColumn(name = &quot;workflow_id&quot;, nullable = false)
  private WorkflowInstance instance;

  /**
   * No-arg constructor needed for JAXB serialization
   */
<span class="fc" id="L138">  public WorkflowOperationInstance() {</span>
<span class="fc" id="L139">    this.maxAttempts = 1;</span>
<span class="fc" id="L140">    this.retryStrategy = RetryStrategy.NONE;</span>
<span class="fc" id="L141">  }</span>

  /**
   * Builds a new workflow operation instance based on another workflow operation.
   *
   * @param def
   *          the workflow definition
   */
  public WorkflowOperationInstance(WorkflowOperationDefinition def) {
<span class="fc" id="L150">    this();</span>
<span class="fc" id="L151">    setTemplate(def.getId());</span>
<span class="fc" id="L152">    setState(OperationState.INSTANTIATED);</span>
<span class="fc" id="L153">    setDescription(def.getDescription());</span>
<span class="fc" id="L154">    setMaxAttempts(def.getMaxAttempts());</span>
<span class="fc" id="L155">    setFailOnError(def.isFailWorkflowOnException());</span>
<span class="fc" id="L156">    setExceptionHandlingWorkflow(def.getExceptionHandlingWorkflow());</span>
<span class="fc" id="L157">    setExecutionCondition(def.getExecutionCondition());</span>
<span class="fc" id="L158">    setRetryStrategy(def.getRetryStrategy());</span>
<span class="fc" id="L159">    Set&lt;String&gt; defConfigs = def.getConfigurationKeys();</span>
<span class="fc" id="L160">    this.configurations = new TreeMap&lt;&gt;();</span>
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">    if (defConfigs != null) {</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">      for (String key : defConfigs) {</span>
<span class="fc" id="L163">        configurations.put(key, def.getConfiguration(key));</span>
<span class="fc" id="L164">      }</span>
    }

<span class="fc bfc" id="L167" title="All 6 branches covered.">    if ((retryStrategy == RetryStrategy.RETRY || retryStrategy == RetryStrategy.HOLD) &amp;&amp; maxAttempts &lt; 2) {</span>
<span class="fc" id="L168">      maxAttempts = 2;</span>
    }
<span class="fc" id="L170">  }</span>

  /**
   * Constructs a new operation instance with the given id and initial state.
   *
   * @param id
   *          the operation id
   * @param state
   *          the state
   */
  public WorkflowOperationInstance(String id, OperationState state) {
<span class="fc" id="L181">    this();</span>
<span class="fc" id="L182">    setTemplate(id);</span>
<span class="fc" id="L183">    setState(state);</span>
<span class="fc" id="L184">  }</span>

  public WorkflowOperationInstance(
          String template,
          Long jobId,
          OperationState state,
          String description,
          Map&lt;String, String&gt; configurations,
          boolean failOnError,
          String executeCondition,
          String exceptionHandlingWorkflow,
          Boolean abortable,
          Boolean continuable,
          Date dateStarted,
          Date dateCompleted,
          Long timeInQueue,
          int maxAttempts,
          int failedAttempts,
          String executionHost,
<span class="fc" id="L203">          RetryStrategy retryStrategy) {</span>
<span class="fc" id="L204">    this.template = template;</span>
<span class="fc" id="L205">    this.jobId = jobId;</span>
<span class="fc" id="L206">    this.state = state;</span>
<span class="fc" id="L207">    this.description = description;</span>
<span class="fc" id="L208">    this.configurations = configurations;</span>
<span class="fc" id="L209">    this.failOnError = failOnError;</span>
<span class="fc" id="L210">    this.executeCondition = executeCondition;</span>
<span class="fc" id="L211">    this.exceptionHandlingWorkflow = exceptionHandlingWorkflow;</span>
<span class="fc" id="L212">    this.abortable = abortable;</span>
<span class="fc" id="L213">    this.continuable = continuable;</span>
<span class="fc" id="L214">    this.dateStarted = dateStarted;</span>
<span class="fc" id="L215">    this.dateCompleted = dateCompleted;</span>
<span class="fc" id="L216">    this.timeInQueue = timeInQueue;</span>
<span class="fc" id="L217">    this.maxAttempts = maxAttempts;</span>
<span class="fc" id="L218">    this.failedAttempts = failedAttempts;</span>
<span class="fc" id="L219">    this.executionHost = executionHost;</span>
<span class="fc" id="L220">    this.retryStrategy = retryStrategy;</span>
<span class="fc" id="L221">  }</span>

  /**
   * Sets the template
   *
   * @param template
   *          the template
   */
  public void setTemplate(String template) {
<span class="fc" id="L230">    this.template = template;</span>
<span class="fc" id="L231">  }</span>

  /**
   * Gets the operation type.
   *
   * @return the operation type
   */
  public String getTemplate() {
<span class="fc" id="L239">    return template;</span>
  }

  /**
   * Gets the unique identifier for this operation, or null.
   *
   * @return the identifier, or null if this operation has not yet run
   */
  public Long getId() {
<span class="fc" id="L248">    return jobId;</span>
  }

  /**
   * Sets the unique identifier for this operation.
   *
   * @param jobId
   *          the identifier
   */
  public void setId(Long jobId) {
<span class="fc" id="L258">    this.jobId = jobId;</span>
<span class="fc" id="L259">  }</span>

  /**
   * Gets the operation description
   *
   * @return the description
   */
  public String getDescription() {
<span class="fc" id="L267">    return description;</span>
  }

  /**
   * Set the operation description.
   *
   * @param description The new description
   */
  public void setDescription(String description) {
<span class="fc" id="L276">    this.description = description;</span>
<span class="fc" id="L277">  }</span>

  /**
   * The state of this operation.
   */
  public OperationState getState() {
<span class="fc" id="L283">    return state;</span>
  }

  /**
   * Sets the state of this operation
   *
   * @param state
   *          the state to set
   */
  public void setState(OperationState state) {
<span class="fc" id="L293">    Date now = new Date();</span>
<span class="fc bfc" id="L294" title="All 2 branches covered.">    if (OperationState.RUNNING.equals(state)) {</span>
<span class="fc" id="L295">      this.dateStarted = now;</span>
<span class="fc bfc" id="L296" title="All 4 branches covered.">    } else if (OperationState.FAILED.equals(state) || OperationState.SUCCEEDED.equals(state)) {</span>
<span class="fc" id="L297">      this.dateCompleted = now;</span>
    }
<span class="fc" id="L299">    this.state = state;</span>
<span class="fc" id="L300">  }</span>

  /**
   * Return configuration of this workflow operation as Map.
   * Guaranteed to be not null
   *
   * @return Configuration map
   */
  public Map&lt;String, String&gt; getConfigurations() {
<span class="fc" id="L309">    return configurations;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowInstance#getConfiguration(java.lang.String)
   */
  @Override
  public String getConfiguration(String key) {
<span class="pc bpc" id="L319" title="1 of 4 branches missed.">    if (key == null || configurations == null)</span>
<span class="fc" id="L320">      return null;</span>
<span class="fc" id="L321">    return configurations.get(key);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowInstance#removeConfiguration(java.lang.String)
   */
  @Override
  public void removeConfiguration(String key) {
<span class="nc bnc" id="L331" title="All 4 branches missed.">    if (key == null || configurations == null)</span>
<span class="nc" id="L332">      return;</span>
<span class="nc" id="L333">    configurations.remove(key);</span>
<span class="nc" id="L334">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowInstance#setConfiguration(java.lang.String, java.lang.String)
   */
  @Override
  public void setConfiguration(String key, String value) {
<span class="pc bpc" id="L343" title="1 of 2 branches missed.">    if (key == null)</span>
<span class="nc" id="L344">      return;</span>
<span class="fc bfc" id="L345" title="All 2 branches covered.">    if (configurations == null)</span>
<span class="fc" id="L346">      configurations = new TreeMap&lt;&gt;();</span>

<span class="fc" id="L348">    configurations.put(key, value);</span>
<span class="fc" id="L349">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowOperationInstance#getConfigurationKeys()
   */
  @Override
  public Set&lt;String&gt; getConfigurationKeys() {
<span class="pc bpc" id="L358" title="1 of 2 branches missed.">    if (configurations == null) {</span>
<span class="nc" id="L359">      return Collections.emptySet();</span>
    }
<span class="fc" id="L361">    return configurations.keySet();</span>
  }

  /** The workflow to run if an exception is thrown while this operation is running. */
  public String getExceptionHandlingWorkflow() {
<span class="fc" id="L366">    return exceptionHandlingWorkflow;</span>
  }

  public void setExceptionHandlingWorkflow(String exceptionHandlingWorkflow) {
<span class="fc" id="L370">    this.exceptionHandlingWorkflow = exceptionHandlingWorkflow;</span>
<span class="fc" id="L371">  }</span>

  /**
   * If true, this workflow will be put into a failed (or failing, if getExceptionHandlingWorkflow() is not null) state
   * when exceptions are thrown during an operation.
   */
  public boolean isFailOnError() {
<span class="fc" id="L378">    return failOnError;</span>
  }

  public void setFailOnError(boolean failOnError) {
<span class="fc" id="L382">    this.failOnError = failOnError;</span>
<span class="fc" id="L383">  }</span>

  /**
   * The timestamp this operation started. If the job was queued, this can be significantly later than the date created.
   */
  public Date getDateStarted() {
<span class="fc" id="L389">    return dateStarted;</span>
  }

  /** The number of milliseconds this operation waited in a service queue */
  public Long getTimeInQueue() {
<span class="fc" id="L394">    return timeInQueue;</span>
  }

  public void setTimeInQueue(long timeInQueue) {
<span class="fc" id="L398">    this.timeInQueue = timeInQueue;</span>
<span class="fc" id="L399">  }</span>

  /** The timestamp this operation completed */
  public Date getDateCompleted() {
<span class="fc" id="L403">    return dateCompleted;</span>
  }

  /**
   * Returns either &lt;code&gt;null&lt;/code&gt; or &lt;code&gt;true&lt;/code&gt; to have the operation executed. Any other value is
   * interpreted as &lt;code&gt;false&lt;/code&gt; and will skip the operation.
   * &lt;p&gt;
   * Usually, this will be a variable name such as &lt;code&gt;${foo}&lt;/code&gt;, which will be replaced with its acutal value
   * once the workflow is executed.
   * &lt;p&gt;
   * If both &lt;code&gt;getExecuteCondition()&lt;/code&gt; and &lt;code&gt;getSkipCondition&lt;/code&gt; return a non-null value, the execute
   * condition takes precedence.
   *
   * @return the execution condition.
   */
  public String getExecutionCondition() {
<span class="fc" id="L419">    return executeCondition;</span>
  }

  public void setExecutionCondition(String condition) {
<span class="fc" id="L423">    this.executeCondition = condition;</span>
<span class="fc" id="L424">  }</span>

  /**
   * Returns &lt;code&gt;true&lt;/code&gt; if this operation can be continued by the user from an optional hold state. A return
   * value of &lt;code&gt;null&lt;/code&gt; indicates that this operation instance does not have a hold state.
   *
   * @return &lt;code&gt;true&lt;/code&gt; if this operation instance is continuable
   */
  public Boolean isContinuable() {
<span class="fc" id="L433">    return continuable;</span>
  }

  /**
   * Defines whether this operation instance should be continuable from a hold state or whether it is resumed
   * automatically.
   *
   * @param continuable
   *          &lt;code&gt;true&lt;/code&gt; to allow the user to resume the operation
   */
  public void setContinuable(Boolean continuable) {
<span class="fc" id="L444">    this.continuable = continuable;</span>
<span class="fc" id="L445">  }</span>

  /**
   * Returns &lt;code&gt;true&lt;/code&gt; if this operation can be aborted by the user from an optional hold state. If a resumable
   * operation is aborted from its hold state, the workflow is put into
   * {@link org.opencastproject.workflow.api.WorkflowInstance.WorkflowState#STOPPED}. A return value of
   * &lt;code&gt;null&lt;/code&gt; indicates that this operation instance does not have a hold state.
   *
   * @return &lt;code&gt;true&lt;/code&gt; if this operation instance is abortable
   */
  public Boolean isAbortable() {
<span class="fc" id="L456">    return abortable;</span>
  }

  /**
   * Defines whether this operation instance should be abortable from a hold state.
   *
   * @param abortable
   *          &lt;code&gt;true&lt;/code&gt; to allow the user to cancel the operation
   */
  public void setAbortable(Boolean abortable) {
<span class="fc" id="L466">    this.abortable = abortable;</span>
<span class="fc" id="L467">  }</span>

  /**
   * Return the strategy to use in case of operation failure
   *
   * @return a strategy from {@link org.opencastproject.workflow.api.RetryStrategy}.
   */
  public RetryStrategy getRetryStrategy() {
<span class="fc" id="L475">    return retryStrategy;</span>
  }

  private void setRetryStrategy(RetryStrategy retryStrategy) {
<span class="fc" id="L479">    this.retryStrategy = retryStrategy;</span>
<span class="fc" id="L480">  }</span>

  /**
   * Returns the number of attempts the workflow service will make to execute this operation.
   *
   * @return the maximum number of retries before failing
   */
  public int getMaxAttempts() {
<span class="fc" id="L488">    return maxAttempts;</span>
  }

  /**
   * @param maxAttempts
   *          the maxAttempts to set
   * @throws IllegalArgumentException
   *           if maxAttempts is less than one.
   */
  private void setMaxAttempts(int maxAttempts) {
<span class="pc bpc" id="L498" title="1 of 2 branches missed.">    if (maxAttempts &lt; 1) {</span>
<span class="nc" id="L499">      throw new IllegalArgumentException(&quot;maxAttempts must be &gt;=1&quot;);</span>
    }
<span class="fc" id="L501">    this.maxAttempts = maxAttempts;</span>
<span class="fc" id="L502">  }</span>

  /**
   * Returns the number of failed executions that have previously been attempted.
   *
   * @return the number of previous attempts
   */
  public int getFailedAttempts() {
<span class="fc" id="L510">    return failedAttempts;</span>
  }

  public void setFailedAttempts(int failedAttempts) {
<span class="fc" id="L514">    this.failedAttempts = failedAttempts;</span>
<span class="fc" id="L515">  }</span>

  /**
   * Returns the current execution host
   *
   * @return the execution host
   */
  public String getExecutionHost() {
<span class="fc" id="L523">    return executionHost;</span>
  }

  /**
   * Sets the current execution host
   *
   * @param executionHost
   *          the execution host
   */
  public void setExecutionHost(String executionHost) {
<span class="fc" id="L533">    this.executionHost = executionHost;</span>
<span class="fc" id="L534">  }</span>

  public WorkflowInstance getWorkflowInstance() {
<span class="nc" id="L537">    return instance;</span>
  }

  public void setWorkflowInstance(WorkflowInstance instance) {
<span class="fc" id="L541">    this.instance = instance;</span>
<span class="fc" id="L542">  }</span>

  @Override
  public int hashCode() {
<span class="fc" id="L546">    return Long.valueOf(id).hashCode();</span>
  }

  @Override
  public boolean equals(Object o) {
<span class="fc bfc" id="L551" title="All 2 branches covered.">    if (this == o) {</span>
<span class="fc" id="L552">      return true;</span>
    }
<span class="fc bfc" id="L554" title="All 2 branches covered.">    if (o instanceof WorkflowOperationInstance) {</span>
<span class="fc" id="L555">      WorkflowOperationInstance other = (WorkflowOperationInstance) o;</span>
<span class="fc bfc" id="L556" title="All 4 branches covered.">      return other.getTemplate().equals(this.getTemplate()) &amp;&amp; Objects.equals(other.id, this.id);</span>
    }
<span class="fc" id="L558">    return false;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see java.lang.Object#toString()
   */
  @Override
  public String toString() {
<span class="fc" id="L568">    return &quot;operation:'&quot; + template +  &quot;, state:'&quot; + this.state + &quot;'&quot;;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>