<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SeriesIndexUtils.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-elasticsearch-index</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.elasticsearch.index.objects.series</a> &gt; <span class="el_source">SeriesIndexUtils.java</span></div><h1>SeriesIndexUtils.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.elasticsearch.index.objects.series;

import org.opencastproject.elasticsearch.api.SearchMetadata;
import org.opencastproject.elasticsearch.impl.SearchMetadataCollection;
import org.opencastproject.security.api.AccessControlEntry;
import org.opencastproject.security.api.AccessControlList;
import org.opencastproject.security.api.AccessControlParser;
import org.opencastproject.security.api.Permissions;
import org.opencastproject.security.api.Permissions.Action;
import org.opencastproject.util.DateTimeSupport;

import org.apache.commons.io.IOUtils;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.nio.charset.Charset;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.xml.bind.Unmarshaller;

/**
 * Utility implementation to deal with the conversion of series and its corresponding index data structures.
 */
public final class SeriesIndexUtils {

<span class="nc" id="L52">  private static final Logger logger = LoggerFactory.getLogger(SeriesIndexUtils.class);</span>

  /**
   * This is a utility class and should therefore not be instantiated.
   */
  private SeriesIndexUtils() {
  }

  /**
   * Creates a search result item based on the data returned from the search index.
   *
   * @param metadata
   *          the search metadata
   * @param unmarshaller the unmarshaller to use
   * @return the search result item
   * @throws IOException
   *           if unmarshalling fails
   */
  public static Series toSeries(SearchMetadataCollection metadata, Unmarshaller unmarshaller) throws IOException {
<span class="nc" id="L71">    Map&lt;String, SearchMetadata&lt;?&gt;&gt; metadataMap = metadata.toMap();</span>
<span class="nc" id="L72">    String seriesXml = (String) metadataMap.get(SeriesIndexSchema.OBJECT).getValue();</span>
<span class="nc" id="L73">    return Series.valueOf(IOUtils.toInputStream(seriesXml, Charset.defaultCharset()), unmarshaller);</span>
  }

  /**
   * Creates search metadata from a series such that the event can be stored in the search index.
   *
   * @param series
   *          the series
   * @return the set of metadata
   */
  public static SearchMetadataCollection toSearchMetadata(Series series) {
<span class="nc" id="L84">    SearchMetadataCollection metadata = new SearchMetadataCollection(</span>
<span class="nc" id="L85">            series.getIdentifier().concat(series.getOrganization()), Series.DOCUMENT_TYPE);</span>
<span class="nc" id="L86">    metadata.addField(SeriesIndexSchema.UID, series.getIdentifier(), true);</span>
<span class="nc" id="L87">    metadata.addField(SeriesIndexSchema.ORGANIZATION, series.getOrganization(), false);</span>
<span class="nc" id="L88">    metadata.addField(SeriesIndexSchema.OBJECT, series.toXML(), false);</span>
<span class="nc" id="L89">    metadata.addField(SeriesIndexSchema.TITLE, series.getTitle(), true);</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">    if (StringUtils.trimToNull(series.getDescription()) != null) {</span>
<span class="nc" id="L91">      metadata.addField(SeriesIndexSchema.DESCRIPTION, series.getDescription(), true);</span>
    }
<span class="nc bnc" id="L93" title="All 2 branches missed.">    if (StringUtils.trimToNull(series.getSubject()) != null) {</span>
<span class="nc" id="L94">      metadata.addField(SeriesIndexSchema.SUBJECT, series.getSubject(), true);</span>
    }
<span class="nc bnc" id="L96" title="All 2 branches missed.">    if (StringUtils.trimToNull(series.getLanguage()) != null) {</span>
<span class="nc" id="L97">      metadata.addField(SeriesIndexSchema.LANGUAGE, series.getLanguage(), true);</span>
    }
<span class="nc bnc" id="L99" title="All 2 branches missed.">    if (StringUtils.trimToNull(series.getCreator()) != null) {</span>
<span class="nc" id="L100">      metadata.addField(SeriesIndexSchema.CREATOR, series.getCreator(), true);</span>
    }
<span class="nc bnc" id="L102" title="All 2 branches missed.">    if (StringUtils.trimToNull(series.getLicense()) != null) {</span>
<span class="nc" id="L103">      metadata.addField(SeriesIndexSchema.LICENSE, series.getLicense(), true);</span>
    }
<span class="nc bnc" id="L105" title="All 2 branches missed.">    if (StringUtils.trimToNull(series.getManagedAcl()) != null) {</span>
<span class="nc" id="L106">      metadata.addField(SeriesIndexSchema.MANAGED_ACL, series.getManagedAcl(), true);</span>
    }
<span class="nc bnc" id="L108" title="All 2 branches missed.">    if (series.getCreatedDateTime() != null) {</span>
<span class="nc" id="L109">      metadata.addField(SeriesIndexSchema.CREATED_DATE_TIME,</span>
<span class="nc" id="L110">              DateTimeSupport.toUTC(series.getCreatedDateTime().getTime()), true);</span>
    }
<span class="nc bnc" id="L112" title="All 2 branches missed.">    if (series.getOrganizers() != null) {</span>
<span class="nc" id="L113">      metadata.addField(SeriesIndexSchema.ORGANIZERS, series.getOrganizers().toArray(), true);</span>
    }
<span class="nc bnc" id="L115" title="All 2 branches missed.">    if (series.getContributors() != null) {</span>
<span class="nc" id="L116">      metadata.addField(SeriesIndexSchema.CONTRIBUTORS, series.getContributors().toArray(), true);</span>
    }
<span class="nc bnc" id="L118" title="All 2 branches missed.">    if (series.getPublishers() != null) {</span>
<span class="nc" id="L119">      metadata.addField(SeriesIndexSchema.PUBLISHERS, series.getPublishers().toArray(), true);</span>
    }
<span class="nc bnc" id="L121" title="All 2 branches missed.">    if (series.getRightsHolder() != null) {</span>
<span class="nc" id="L122">      metadata.addField(SeriesIndexSchema.RIGHTS_HOLDER, series.getRightsHolder(), true);</span>
    }

<span class="nc bnc" id="L125" title="All 2 branches missed.">    if (!series.getExtendedMetadata().isEmpty()) {</span>
<span class="nc" id="L126">      addExtendedMetadata(metadata, series.getExtendedMetadata());</span>
    }

<span class="nc bnc" id="L129" title="All 2 branches missed.">    if (StringUtils.trimToNull(series.getAccessPolicy()) != null) {</span>
<span class="nc" id="L130">      metadata.addField(SeriesIndexSchema.ACCESS_POLICY, series.getAccessPolicy(), false);</span>
<span class="nc" id="L131">      addAuthorization(metadata, series.getAccessPolicy());</span>
    }
<span class="nc bnc" id="L133" title="All 2 branches missed.">    if (series.getTheme() != null) {</span>
<span class="nc" id="L134">      metadata.addField(SeriesIndexSchema.THEME, series.getTheme(), false);</span>
    }
<span class="nc" id="L136">    return metadata;</span>
  }

  /**
   * Adds extended metadata fields to the input document
   *
   * @param doc
   *          the input document
   * @param extendedMetadata
   *          the extended metadata map
   */
  private static void addExtendedMetadata(SearchMetadataCollection doc, Map&lt;String, Map&lt;String,
          List&lt;String&gt;&gt;&gt; extendedMetadata) {
<span class="nc bnc" id="L149" title="All 2 branches missed.">    for (String type: extendedMetadata.keySet()) {</span>
<span class="nc" id="L150">      Map&lt;String, List&lt;String&gt;&gt; extendedMetadataByType = extendedMetadata.get(type);</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">      for (String name: extendedMetadataByType.keySet()) {</span>
<span class="nc" id="L152">        List&lt;String&gt; values = extendedMetadataByType.get(name);</span>
<span class="nc" id="L153">        String fieldName = SeriesIndexSchema.EXTENDED_METADATA_PREFIX.concat(type + &quot;_&quot; + name);</span>
<span class="nc" id="L154">        doc.addField(fieldName, values, true);</span>
<span class="nc" id="L155">      }</span>
<span class="nc" id="L156">    }</span>
<span class="nc" id="L157">  }</span>

  /**
   * Adds authorization fields to the input document.
   *
   * @param doc
   *          the input document
   * @param aclString
   *          the access control list string
   */
  private static void addAuthorization(SearchMetadataCollection doc, String aclString) {
<span class="nc" id="L168">    Map&lt;String, List&lt;String&gt;&gt; permissions = new HashMap&lt;&gt;();</span>

    // Define containers for common permissions
<span class="nc bnc" id="L171" title="All 2 branches missed.">    for (Action action : Permissions.Action.values()) {</span>
<span class="nc" id="L172">      permissions.put(action.toString(), new ArrayList&lt;&gt;());</span>
    }

<span class="nc" id="L175">    AccessControlList acl = AccessControlParser.parseAclSilent(aclString);</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">    for (AccessControlEntry entry : acl.getEntries()) {</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">      if (!entry.isAllow()) {</span>
<span class="nc" id="L178">        logger.info(&quot;Series index does not support denial via ACL, ignoring {}&quot;, entry);</span>
<span class="nc" id="L179">        continue;</span>
      }
<span class="nc" id="L181">      List&lt;String&gt; actionPermissions = permissions.get(entry.getAction());</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">      if (actionPermissions == null) {</span>
<span class="nc" id="L183">        actionPermissions = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L184">        permissions.put(entry.getAction(), actionPermissions);</span>
      }
<span class="nc" id="L186">      actionPermissions.add(entry.getRole());</span>
<span class="nc" id="L187">    }</span>

    // Write the permissions to the input document
<span class="nc bnc" id="L190" title="All 2 branches missed.">    for (Map.Entry&lt;String, List&lt;String&gt;&gt; entry : permissions.entrySet()) {</span>
<span class="nc" id="L191">      String fieldName = SeriesIndexSchema.ACL_PERMISSION_PREFIX.concat(entry.getKey());</span>
<span class="nc" id="L192">      doc.addField(fieldName, entry.getValue(), false);</span>
<span class="nc" id="L193">    }</span>
<span class="nc" id="L194">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>