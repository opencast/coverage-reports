<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>IndexTheme.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-elasticsearch-index</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.elasticsearch.index.objects.theme</a> &gt; <span class="el_source">IndexTheme.java</span></div><h1>IndexTheme.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.elasticsearch.index.objects.theme;

import org.opencastproject.elasticsearch.api.SearchMetadata;
import org.opencastproject.elasticsearch.impl.SearchMetadataCollection;
import org.opencastproject.elasticsearch.index.objects.IndexObject;
import org.opencastproject.util.DateTimeSupport;
import org.opencastproject.util.DateTimeSupport.UtcTimestampAdapter;
import org.opencastproject.util.IoSupport;
import org.opencastproject.util.XmlSafeParser;

import org.apache.commons.io.IOUtils;
import org.apache.commons.lang3.StringUtils;
import org.xml.sax.SAXException;

import java.io.IOException;
import java.io.InputStream;
import java.io.StringWriter;
import java.util.Date;
import java.util.Map;

import javax.xml.bind.JAXBContext;
import javax.xml.bind.JAXBException;
import javax.xml.bind.Marshaller;
import javax.xml.bind.Unmarshaller;
import javax.xml.bind.annotation.XmlAccessType;
import javax.xml.bind.annotation.XmlAccessorType;
import javax.xml.bind.annotation.XmlElement;
import javax.xml.bind.annotation.XmlRootElement;
import javax.xml.bind.annotation.XmlType;
import javax.xml.bind.annotation.adapters.XmlJavaTypeAdapter;

/**
 * Object wrapper for a theme.
 */
@XmlType(name = &quot;theme&quot;, namespace = IndexObject.INDEX_XML_NAMESPACE, propOrder = { &quot;identifier&quot;, &quot;creationDate&quot;,
        &quot;isDefault&quot;, &quot;description&quot;, &quot;name&quot;, &quot;creator&quot;, &quot;organization&quot;, &quot;bumperActive&quot;, &quot;bumperFile&quot;, &quot;trailerActive&quot;,
        &quot;trailerFile&quot;, &quot;titleSlideActive&quot;, &quot;titleSlideMetadata&quot;, &quot;titleSlideBackground&quot;, &quot;licenseSlideActive&quot;,
        &quot;licenseSlideDescription&quot;, &quot;licenseSlideBackground&quot;, &quot;watermarkActive&quot;, &quot;watermarkFile&quot;, &quot;watermarkPosition&quot; })
@XmlRootElement(name = &quot;theme&quot;, namespace = IndexObject.INDEX_XML_NAMESPACE)
@XmlAccessorType(XmlAccessType.NONE)
public class IndexTheme implements IndexObject {

  /** The document type */
  public static final String DOCUMENT_TYPE = &quot;theme&quot;;

  /** The name of the surrounding XML tag to wrap a result of multiple theme */
  public static final String XML_SURROUNDING_TAG = &quot;themes&quot;;

  /** The identifier */
<span class="pc" id="L71">  @XmlElement(name = &quot;identifier&quot;)</span>
  private Long identifier = null;

  /** The date and time the theme was created in UTC format e.g. 2011-07-16T20:39:05Z */
  @XmlElement(name = &quot;creationDate&quot;)
  @XmlJavaTypeAdapter(UtcTimestampAdapter.class)
  private Date creationDate;

  /** Whether the theme is the default theme */
<span class="pc" id="L80">  @XmlElement(name = &quot;default&quot;)</span>
  private boolean isDefault = false;

  /** The description of the theme. */
<span class="pc" id="L84">  @XmlElement(name = &quot;description&quot;)</span>
  private String description = null;

  /** The name of this theme. */
<span class="pc" id="L88">  @XmlElement(name = &quot;name&quot;)</span>
  private String name = null;

  /** The creator of the theme */
<span class="pc" id="L92">  @XmlElement(name = &quot;creator&quot;)</span>
  private String creator = null;

  /** The organization of the theme */
<span class="pc" id="L96">  @XmlElement(name = &quot;organization&quot;)</span>
  private String organization = null;

  /** Whether the bumper set in this theme should be used */
<span class="pc" id="L100">  @XmlElement(name = &quot;bumperActive&quot;)</span>
  private boolean bumperActive = false;

  /** The id of the file to use as a bumper */
<span class="pc" id="L104">  @XmlElement(name = &quot;bumperFile&quot;)</span>
  private String bumperFile = null;

  /** Whether the trailer set in this theme should be used */
<span class="pc" id="L108">  @XmlElement(name = &quot;trailerActive&quot;)</span>
  private boolean trailerActive = false;

  /** The id of the file to use as a trailer for this theme. */
<span class="pc" id="L112">  @XmlElement(name = &quot;trailerFile&quot;)</span>
  private String trailerFile = null;

  /** Whether the title slide should be used in this theme */
<span class="pc" id="L116">  @XmlElement(name = &quot;titleSlideActive&quot;)</span>
  private boolean titleSlideActive = false;

  /** The definition about which metadata to use in the title slide */
<span class="pc" id="L120">  @XmlElement(name = &quot;titleSlideMetadata&quot;)</span>
  private String titleSlideMetadata = null;

  /** The id of the file to use as the background to the title slide */
<span class="pc" id="L124">  @XmlElement(name = &quot;titleSlideBackground&quot;)</span>
  private String titleSlideBackground = null;

  /** Whether the license slide in this theme should be used */
<span class="pc" id="L128">  @XmlElement(name = &quot;licenseSlideActive&quot;)</span>
  private boolean licenseSlideActive = false;

  /** The license description for the video */
<span class="pc" id="L132">  @XmlElement(name = &quot;licenseSlideDescription&quot;)</span>
  private String licenseSlideDescription = null;

  /** The id of the file to use as a background for the license */
<span class="pc" id="L136">  @XmlElement(name = &quot;licenseSlideBackground&quot;)</span>
  private String licenseSlideBackground = null;

  /** Whether the watermark from the theme should be applied to the video */
<span class="pc" id="L140">  @XmlElement(name = &quot;watermarkActive&quot;)</span>
  private boolean watermarkActive = false;

  /** The id of the file to use as watermark on the video */
<span class="pc" id="L144">  @XmlElement(name = &quot;watermarkFile&quot;)</span>
  private String watermarkFile = null;

  /** Dictates where the watermark should be placed on the video */
<span class="pc" id="L148">  @XmlElement(name = &quot;watermarkPosition&quot;)</span>
  private String watermarkPosition = null;

  /** Context for serializing and deserializing */
<span class="fc" id="L152">  private static JAXBContext context = null;</span>

  /**
   * Required default no arg constructor for JAXB.
   */
<span class="nc" id="L157">  public IndexTheme() {</span>
<span class="nc" id="L158">  }</span>

  /**
   * @param identifier
   *          the theme identifier
   * @param organization
   *          the organization
   */
<span class="fc" id="L166">  public IndexTheme(long identifier, String organization) {</span>
<span class="fc" id="L167">    this.identifier = identifier;</span>
<span class="fc" id="L168">    this.organization = organization;</span>
<span class="fc" id="L169">  }</span>

  public long getIdentifier() {
<span class="fc" id="L172">    return identifier;</span>
  }

  public Date getCreationDate() {
<span class="fc" id="L176">    return creationDate;</span>
  }

  public void setCreationDate(Date creationDate) {
<span class="fc" id="L180">    this.creationDate = creationDate;</span>
<span class="fc" id="L181">  }</span>

  public boolean isDefault() {
<span class="fc" id="L184">    return isDefault;</span>
  }

  public void setDefault(boolean isDefault) {
<span class="nc" id="L188">    this.isDefault = isDefault;</span>
<span class="nc" id="L189">  }</span>

  public String getDescription() {
<span class="fc" id="L192">    return description;</span>
  }

  public void setDescription(String description) {
<span class="fc" id="L196">    this.description = description;</span>
<span class="fc" id="L197">  }</span>

  public String getName() {
<span class="fc" id="L200">    return name;</span>
  }

  public void setName(String name) {
<span class="fc" id="L204">    this.name = name;</span>
<span class="fc" id="L205">  }</span>

  public String getCreator() {
<span class="fc" id="L208">    return creator;</span>
  }

  public void setCreator(String creator) {
<span class="fc" id="L212">    this.creator = creator;</span>
<span class="fc" id="L213">  }</span>

  public String getOrganization() {
<span class="nc" id="L216">    return organization;</span>
  }

  public boolean isBumperActive() {
<span class="fc" id="L220">    return bumperActive;</span>
  }

  public void setBumperActive(boolean bumperActive) {
<span class="nc" id="L224">    this.bumperActive = bumperActive;</span>
<span class="nc" id="L225">  }</span>

  public String getBumperFile() {
<span class="fc" id="L228">    return bumperFile;</span>
  }

  public void setBumperFile(String bumperFile) {
<span class="fc" id="L232">    this.bumperFile = bumperFile;</span>
<span class="fc" id="L233">  }</span>

  public boolean isTrailerActive() {
<span class="fc" id="L236">    return trailerActive;</span>
  }

  public void setTrailerActive(boolean trailerActive) {
<span class="nc" id="L240">    this.trailerActive = trailerActive;</span>
<span class="nc" id="L241">  }</span>

  public String getTrailerFile() {
<span class="fc" id="L244">    return trailerFile;</span>
  }

  public void setTrailerFile(String trailerFile) {
<span class="nc" id="L248">    this.trailerFile = trailerFile;</span>
<span class="nc" id="L249">  }</span>

  public boolean isTitleSlideActive() {
<span class="fc" id="L252">    return titleSlideActive;</span>
  }

  public void setTitleSlideActive(boolean titleSlideActive) {
<span class="nc" id="L256">    this.titleSlideActive = titleSlideActive;</span>
<span class="nc" id="L257">  }</span>

  public String getTitleSlideMetadata() {
<span class="fc" id="L260">    return titleSlideMetadata;</span>
  }

  public void setTitleSlideMetadata(String titleSlideMetadata) {
<span class="nc" id="L264">    this.titleSlideMetadata = titleSlideMetadata;</span>
<span class="nc" id="L265">  }</span>

  public String getTitleSlideBackground() {
<span class="fc" id="L268">    return titleSlideBackground;</span>
  }

  public void setTitleSlideBackground(String titleSlideBackground) {
<span class="nc" id="L272">    this.titleSlideBackground = titleSlideBackground;</span>
<span class="nc" id="L273">  }</span>

  public boolean isLicenseSlideActive() {
<span class="fc" id="L276">    return licenseSlideActive;</span>
  }

  public void setLicenseSlideActive(boolean licenseSlideActive) {
<span class="nc" id="L280">    this.licenseSlideActive = licenseSlideActive;</span>
<span class="nc" id="L281">  }</span>

  public String getLicenseSlideDescription() {
<span class="fc" id="L284">    return licenseSlideDescription;</span>
  }

  public void setLicenseSlideDescription(String licenseSlideDescription) {
<span class="nc" id="L288">    this.licenseSlideDescription = licenseSlideDescription;</span>
<span class="nc" id="L289">  }</span>

  public String getLicenseSlideBackground() {
<span class="fc" id="L292">    return licenseSlideBackground;</span>
  }

  public void setLicenseSlideBackground(String licenseSlideBackground) {
<span class="nc" id="L296">    this.licenseSlideBackground = licenseSlideBackground;</span>
<span class="nc" id="L297">  }</span>

  public boolean isWatermarkActive() {
<span class="fc" id="L300">    return watermarkActive;</span>
  }

  public void setWatermarkActive(boolean watermarkActive) {
<span class="nc" id="L304">    this.watermarkActive = watermarkActive;</span>
<span class="nc" id="L305">  }</span>

  public String getWatermarkFile() {
<span class="fc" id="L308">    return watermarkFile;</span>
  }

  public void setWatermarkFile(String watermarkFile) {
<span class="fc" id="L312">    this.watermarkFile = watermarkFile;</span>
<span class="fc" id="L313">  }</span>

  public String getWatermarkPosition() {
<span class="fc" id="L316">    return watermarkPosition;</span>
  }

  public void setWatermarkPosition(String watermarkPosition) {
<span class="nc" id="L320">    this.watermarkPosition = watermarkPosition;</span>
<span class="nc" id="L321">  }</span>

  /**
   * Reads the theme from the input stream.
   *
   * @param xml
   *          the input stream
   * @return the deserialized theme
   * @throws IOException
   */
  public static IndexTheme valueOf(InputStream xml) throws IOException {
    try {
<span class="nc bnc" id="L333" title="All 2 branches missed.">      if (context == null) {</span>
<span class="nc" id="L334">        createJAXBContext();</span>
      }
<span class="nc" id="L336">      Unmarshaller unmarshaller = context.createUnmarshaller();</span>
<span class="nc" id="L337">      return unmarshaller.unmarshal(XmlSafeParser.parse(xml), IndexTheme.class).getValue();</span>
<span class="nc" id="L338">    } catch (JAXBException e) {</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">      throw new IOException(e.getLinkedException() != null ? e.getLinkedException() : e);</span>
<span class="nc" id="L340">    } catch (SAXException e) {</span>
<span class="nc" id="L341">      throw new IOException(e);</span>
    } finally {
<span class="nc" id="L343">      IoSupport.closeQuietly(xml);</span>
    }
  }

  /**
   * Initialize the JAXBContext.
   */
  private static void createJAXBContext() throws JAXBException {
<span class="nc" id="L351">    context = JAXBContext.newInstance(IndexTheme.class);</span>
<span class="nc" id="L352">  }</span>

  /**
   * Serializes the theme to an XML format.
   *
   * @return A String with this theme's content as XML.
   */
  public String toXML() {
    try {
<span class="nc bnc" id="L361" title="All 2 branches missed.">      if (context == null) {</span>
<span class="nc" id="L362">        createJAXBContext();</span>
      }
<span class="nc" id="L364">      StringWriter writer = new StringWriter();</span>
<span class="nc" id="L365">      Marshaller marshaller = IndexTheme.context.createMarshaller();</span>
<span class="nc" id="L366">      marshaller.marshal(this, writer);</span>
<span class="nc" id="L367">      return writer.toString();</span>
<span class="nc" id="L368">    } catch (JAXBException e) {</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">      throw new IllegalStateException(e.getLinkedException() != null ? e.getLinkedException() : e);</span>
    }
  }

  /**
   * Creates a search result item based on the data returned from the search index.
   *
   * @param metadata
   *          the search metadata
   * @return the search result item
   * @throws IOException
   *           if unmarshalling fails
   */
  public static IndexTheme fromSearchMetadata(SearchMetadataCollection metadata) throws IOException {
<span class="nc" id="L383">    Map&lt;String, SearchMetadata&lt;?&gt;&gt; metadataMap = metadata.toMap();</span>
<span class="nc" id="L384">    String themeXml = (String) metadataMap.get(ThemeIndexSchema.OBJECT).getValue();</span>
<span class="nc" id="L385">    return IndexTheme.valueOf(IOUtils.toInputStream(themeXml));</span>
  }

  /**
   * Creates search metadata from a theme such that the theme can be stored in the search index.
   *
   * @return the set of metadata
   */
  public SearchMetadataCollection toSearchMetadata() {
<span class="nc" id="L394">    SearchMetadataCollection metadata = new SearchMetadataCollection(Long.toString(getIdentifier()).concat(</span>
<span class="nc" id="L395">            getOrganization()), IndexTheme.DOCUMENT_TYPE);</span>
    // Mandatory fields
<span class="nc" id="L397">    metadata.addField(ThemeIndexSchema.ID, getIdentifier(), true);</span>
<span class="nc" id="L398">    metadata.addField(ThemeIndexSchema.ORGANIZATION, getOrganization(), false);</span>
<span class="nc" id="L399">    metadata.addField(ThemeIndexSchema.OBJECT, toXML(), false);</span>

    // Optional fields
<span class="nc bnc" id="L402" title="All 2 branches missed.">    if (StringUtils.isNotBlank(getName())) {</span>
<span class="nc" id="L403">      metadata.addField(ThemeIndexSchema.NAME, getName(), true);</span>
    }

<span class="nc bnc" id="L406" title="All 2 branches missed.">    if (StringUtils.isNotBlank(getDescription())) {</span>
<span class="nc" id="L407">      metadata.addField(ThemeIndexSchema.DESCRIPTION, getDescription(), true);</span>
    }

<span class="nc" id="L410">    metadata.addField(ThemeIndexSchema.DEFAULT, isDefault(), false);</span>

<span class="nc bnc" id="L412" title="All 2 branches missed.">    if (getCreationDate() != null) {</span>
<span class="nc" id="L413">      metadata.addField(ThemeIndexSchema.CREATION_DATE,</span>
<span class="nc" id="L414">              DateTimeSupport.toUTC(getCreationDate().getTime()), true);</span>
    }

<span class="nc bnc" id="L417" title="All 2 branches missed.">    if (StringUtils.isNotBlank(getCreator())) {</span>
<span class="nc" id="L418">      metadata.addField(ThemeIndexSchema.CREATOR, getCreator(), true);</span>
    }

<span class="nc" id="L421">    metadata.addField(ThemeIndexSchema.BUMPER_ACTIVE, isBumperActive(), false);</span>

<span class="nc bnc" id="L423" title="All 2 branches missed.">    if (StringUtils.isNotBlank(getBumperFile())) {</span>
<span class="nc" id="L424">      metadata.addField(ThemeIndexSchema.BUMPER_FILE, getBumperFile(), false);</span>
    }

<span class="nc" id="L427">    metadata.addField(ThemeIndexSchema.TRAILER_ACTIVE, isTrailerActive(), false);</span>

<span class="nc bnc" id="L429" title="All 2 branches missed.">    if (StringUtils.isNotBlank(getTrailerFile())) {</span>
<span class="nc" id="L430">      metadata.addField(ThemeIndexSchema.TRAILER_FILE, getTrailerFile(), false);</span>
    }

<span class="nc" id="L433">    metadata.addField(ThemeIndexSchema.TITLE_SLIDE_ACTIVE, isTrailerActive(), false);</span>

<span class="nc bnc" id="L435" title="All 2 branches missed.">    if (StringUtils.isNotBlank(getTitleSlideMetadata())) {</span>
<span class="nc" id="L436">      metadata.addField(ThemeIndexSchema.TITLE_SLIDE_METADATA, getTitleSlideMetadata(), false);</span>
    }

<span class="nc bnc" id="L439" title="All 2 branches missed.">    if (StringUtils.isNotBlank(getTitleSlideBackground())) {</span>
<span class="nc" id="L440">      metadata.addField(ThemeIndexSchema.TITLE_SLIDE_BACKGROUND, getTitleSlideBackground(), false);</span>
    }

<span class="nc" id="L443">    metadata.addField(ThemeIndexSchema.LICENSE_SLIDE_ACTIVE, isLicenseSlideActive(), false);</span>

<span class="nc bnc" id="L445" title="All 2 branches missed.">    if (StringUtils.isNotBlank(getLicenseSlideDescription())) {</span>
<span class="nc" id="L446">      metadata.addField(ThemeIndexSchema.LICENSE_SLIDE_DESCRIPTION, getLicenseSlideDescription(), false);</span>
    }

<span class="nc bnc" id="L449" title="All 2 branches missed.">    if (StringUtils.isNotBlank(getLicenseSlideBackground())) {</span>
<span class="nc" id="L450">      metadata.addField(ThemeIndexSchema.LICENSE_SLIDE_BACKGROUND, getLicenseSlideBackground(), false);</span>
    }

<span class="nc" id="L453">    metadata.addField(ThemeIndexSchema.WATERMARK_ACTIVE, isWatermarkActive(), false);</span>

<span class="nc bnc" id="L455" title="All 2 branches missed.">    if (StringUtils.isNotBlank(getWatermarkFile())) {</span>
<span class="nc" id="L456">      metadata.addField(ThemeIndexSchema.WATERMARK_FILE, getWatermarkFile(), false);</span>
    }

<span class="nc bnc" id="L459" title="All 2 branches missed.">    if (StringUtils.isNotBlank(getWatermarkPosition())) {</span>
<span class="nc" id="L460">      metadata.addField(ThemeIndexSchema.WATERMARK_POSITION, getWatermarkPosition(), false);</span>
    }
<span class="nc" id="L462">    return metadata;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>