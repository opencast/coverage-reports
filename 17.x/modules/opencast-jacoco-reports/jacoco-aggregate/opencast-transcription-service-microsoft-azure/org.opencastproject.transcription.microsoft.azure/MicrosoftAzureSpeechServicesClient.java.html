<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>MicrosoftAzureSpeechServicesClient.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-transcription-service-microsoft-azure</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.transcription.microsoft.azure</a> &gt; <span class="el_source">MicrosoftAzureSpeechServicesClient.java</span></div><h1>MicrosoftAzureSpeechServicesClient.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.transcription.microsoft.azure;

import org.opencastproject.transcription.microsoft.azure.model.MicrosoftAzureSpeechTranscription;
import org.opencastproject.transcription.microsoft.azure.model.MicrosoftAzureSpeechTranscriptionFile;
import org.opencastproject.transcription.microsoft.azure.model.MicrosoftAzureSpeechTranscriptionFiles;
import org.opencastproject.transcription.microsoft.azure.model.MicrosoftAzureSpeechTranscriptionJson;
import org.opencastproject.transcription.microsoft.azure.model.MicrosoftAzureSpeechTranscriptions;
import org.opencastproject.workspace.api.Workspace;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;

import org.apache.commons.lang3.StringUtils;
import org.apache.http.HttpStatus;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpDelete;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.ContentType;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.util.EntityUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.URI;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;

public class MicrosoftAzureSpeechServicesClient {

<span class="fc" id="L60">  private static final Logger logger = LoggerFactory.getLogger(MicrosoftAzureSpeechServicesClient.class);</span>
  private static final String WORKSPACE_COLLECTION = &quot;azure-speech-services&quot;;
  private static final String DEFAULT_TRANSCRIPTION_TIME_TO_LIVE = &quot;P14D&quot;;
  private final String azureSpeechServicesEndpoint;
  private final String azureCognitiveServicesSubscriptionKey;

  public MicrosoftAzureSpeechServicesClient(String azureSpeechServicesEndpoint,
<span class="fc" id="L67">      String azureCognitiveServicesSubscriptionKey) {</span>
<span class="fc" id="L68">    this.azureSpeechServicesEndpoint = StringUtils.trimToEmpty(azureSpeechServicesEndpoint);</span>
<span class="fc" id="L69">    this.azureCognitiveServicesSubscriptionKey = StringUtils.trimToEmpty(azureCognitiveServicesSubscriptionKey);</span>
<span class="fc" id="L70">  }</span>

  public List&lt;MicrosoftAzureSpeechTranscription&gt; getTranscriptions(int skip, int top)
          throws IOException, MicrosoftAzureNotAllowedException, MicrosoftAzureSpeechClientException {
<span class="nc" id="L74">    return getTranscriptions(skip, top, null);</span>
  }

  public List&lt;MicrosoftAzureSpeechTranscription&gt; getTranscriptions(int skip, int top, String filter)
          throws IOException, MicrosoftAzureNotAllowedException, MicrosoftAzureSpeechClientException {
    // Documentation:
    // https://eastus.dev.cognitive.microsoft.com/docs/services/speech-to-text-api-v3-1/operations/Transcriptions_List
<span class="nc" id="L81">    StringBuilder url = new StringBuilder(azureSpeechServicesEndpoint + &quot;/speechtotext/v3.1/transcriptions&quot;);</span>
<span class="nc" id="L82">    StringBuilder params = new StringBuilder();</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">    if (skip &gt; 0) {</span>
<span class="nc" id="L84">      params.append(&quot;skip=&quot; + skip);</span>
    }
<span class="nc bnc" id="L86" title="All 2 branches missed.">    if (top &gt; 0) {</span>
<span class="nc" id="L87">      params.append(&quot;top=&quot; + top);</span>
    }
<span class="nc bnc" id="L89" title="All 2 branches missed.">    if (StringUtils.isNotBlank(filter)) {</span>
<span class="nc" id="L90">      params.append(&quot;filter=&quot; + URLEncoder.encode(filter, StandardCharsets.UTF_8));</span>
    }
<span class="nc bnc" id="L92" title="All 2 branches missed.">    if (params.length() &gt; 0) {</span>
<span class="nc" id="L93">      url.append(&quot;?&quot;);</span>
<span class="nc" id="L94">      url.append(params);</span>
    }
<span class="nc" id="L96">    try (CloseableHttpClient httpClient = HttpUtils.makeHttpClient()) {</span>
<span class="nc" id="L97">      HttpGet httpGet = new HttpGet(url.toString());</span>
<span class="nc" id="L98">      httpGet.addHeader(&quot;Ocp-Apim-Subscription-Key&quot;, azureCognitiveServicesSubscriptionKey);</span>
<span class="nc" id="L99">      try (CloseableHttpResponse response = httpClient.execute(httpGet)) {</span>
<span class="nc" id="L100">        int code = response.getStatusLine().getStatusCode();</span>
<span class="nc" id="L101">        String responseString = &quot;&quot;;</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (response.getEntity() != null) {</span>
<span class="nc" id="L103">          responseString = EntityUtils.toString(response.getEntity());</span>
        }
<span class="nc bnc" id="L105" title="All 3 branches missed.">        switch (code) {</span>
          case HttpStatus.SC_OK: // 200
<span class="nc" id="L107">            break;</span>
          case HttpStatus.SC_FORBIDDEN: // 403
<span class="nc" id="L109">            throw new MicrosoftAzureNotAllowedException(String.format(&quot;Not allowed to get transcriptions. &quot;</span>
                + &quot;Microsoft Azure Speech Services response: %s&quot;, responseString));
          default:
<span class="nc" id="L112">            throw new MicrosoftAzureSpeechClientException(String.format(</span>
                &quot;Getting transcriptions failed with HTTP response code %d. &quot;
<span class="nc" id="L114">                    + &quot;Microsoft Azure Speech Services response: %s&quot;, code, responseString));</span>
        }
<span class="nc" id="L116">        Gson gson = new GsonBuilder().create();</span>
<span class="nc" id="L117">        MicrosoftAzureSpeechTranscriptions transcriptions = gson.fromJson(responseString,</span>
            MicrosoftAzureSpeechTranscriptions.class);
<span class="nc" id="L119">        return transcriptions.values;</span>
      }
    }
  }

  public MicrosoftAzureSpeechTranscription getTranscriptionById(String transcriptionId)
          throws IOException, MicrosoftAzureNotAllowedException, MicrosoftAzureSpeechClientException,
          MicrosoftAzureNotFoundException {
<span class="nc" id="L127">    String transcriptionUrl = azureSpeechServicesEndpoint + &quot;/speechtotext/v3.1/transcriptions/&quot;</span>
<span class="nc" id="L128">        + StringUtils.trimToEmpty(transcriptionId);</span>
<span class="nc" id="L129">    return getTranscription(transcriptionUrl);</span>
  }

  public MicrosoftAzureSpeechTranscription getTranscription(String transcriptionUrl)
          throws IOException, MicrosoftAzureNotAllowedException, MicrosoftAzureSpeechClientException,
          MicrosoftAzureNotFoundException {
<span class="nc bnc" id="L135" title="All 2 branches missed.">    if (StringUtils.isBlank(transcriptionUrl)) {</span>
<span class="nc" id="L136">      throw new IllegalArgumentException(&quot;Transcription URL not set.&quot;);</span>
    }
    // Documentation:
    // https://eastus.dev.cognitive.microsoft.com/docs/services/speech-to-text-api-v3-1/operations/Transcriptions_Get
<span class="nc" id="L140">    String url = StringUtils.trimToEmpty(transcriptionUrl);</span>
<span class="nc" id="L141">    try (CloseableHttpClient httpClient = HttpUtils.makeHttpClient()) {</span>
<span class="nc" id="L142">      HttpGet httpGet = new HttpGet(url);</span>
<span class="nc" id="L143">      httpGet.addHeader(&quot;Ocp-Apim-Subscription-Key&quot;, azureCognitiveServicesSubscriptionKey);</span>
<span class="nc" id="L144">      try (CloseableHttpResponse response = httpClient.execute(httpGet)) {</span>
<span class="nc" id="L145">        int code = response.getStatusLine().getStatusCode();</span>
<span class="nc" id="L146">        String responseString = &quot;&quot;;</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (response.getEntity() != null) {</span>
<span class="nc" id="L148">          responseString = EntityUtils.toString(response.getEntity());</span>
        }
<span class="nc bnc" id="L150" title="All 4 branches missed.">        switch (code) {</span>
          case HttpStatus.SC_OK: // 200
<span class="nc" id="L152">            break;</span>
          case HttpStatus.SC_FORBIDDEN: // 403
<span class="nc" id="L154">            throw new MicrosoftAzureNotAllowedException(String.format(&quot;Not allowed to get transcription '%s'. &quot;</span>
                    + &quot;Microsoft Azure Speech Services response: %s&quot;, transcriptionUrl, responseString));
          case HttpStatus.SC_NOT_FOUND: // 404
<span class="nc" id="L157">            throw new MicrosoftAzureNotFoundException(String.format(&quot;Transcription '%s' not found.&quot;, transcriptionUrl));</span>
          default:
<span class="nc" id="L159">            throw new MicrosoftAzureSpeechClientException(String.format(</span>
                &quot;Getting transcription '%s' failed with HTTP response code %d. &quot;
<span class="nc" id="L161">                    + &quot;Microsoft Azure Speech Services  response: %s&quot;, transcriptionUrl, code, responseString));</span>
        }
<span class="nc" id="L163">        Gson gson = new GsonBuilder().create();</span>
<span class="nc" id="L164">        return gson.fromJson(responseString, MicrosoftAzureSpeechTranscription.class);</span>
      }
    }
  }

  public MicrosoftAzureSpeechTranscription createTranscription(List&lt;String&gt; contentUrls, String destinationContainerUrl,
      String displayName , String locale, List&lt;String&gt; candidateLocales, String timeToLive,
      Map&lt;String, Object&gt; properties)
          throws IOException, MicrosoftAzureNotAllowedException, MicrosoftAzureSpeechClientException {
    // CHECKSTYLE:OFF checkstyle:LineLength
    // Documentation:
    // https://eastus.dev.cognitive.microsoft.com/docs/services/speech-to-text-api-v3-1/operations/Transcriptions_Create
    // https://learn.microsoft.com/en-us/azure/cognitive-services/speech-service/batch-transcription-create?pivots=rest-api
    // CHECKSTYLE:ON checkstyle:LineLength
<span class="nc" id="L178">    String url = azureSpeechServicesEndpoint  + &quot;/speechtotext/v3.1/transcriptions&quot;;</span>
<span class="nc" id="L179">    MicrosoftAzureSpeechTranscription requestTranscription = new MicrosoftAzureSpeechTranscription();</span>
    // required properties
<span class="nc" id="L181">    requestTranscription.displayName = displayName;</span>
<span class="nc" id="L182">    requestTranscription.locale = locale;</span>
<span class="nc" id="L183">    requestTranscription.contentUrls = contentUrls;</span>
    // optional properties
<span class="nc" id="L185">    requestTranscription.properties = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L186" title="All 4 branches missed.">    if (properties != null &amp;&amp; !properties.isEmpty()) {</span>
<span class="nc" id="L187">      requestTranscription.properties.putAll(properties);</span>
    }
    // TODO produces InvalidUri: Could not access the results container
//    if (StringUtils.isNotEmpty(destinationContainerUrl)) {
//      requestTranscription.properties.put(&quot;destinationContainerUrl&quot;, destinationContainerUrl);
//    }
<span class="nc bnc" id="L193" title="All 4 branches missed.">    if (candidateLocales != null &amp;&amp; !candidateLocales.isEmpty()) {</span>
<span class="nc" id="L194">      Map&lt;String, Object&gt; languageIdentification = new HashMap&lt;&gt;();</span>
<span class="nc" id="L195">      languageIdentification.put(&quot;candidateLocales&quot;, candidateLocales);</span>
<span class="nc" id="L196">      requestTranscription.properties.put(&quot;languageIdentification&quot;,languageIdentification);</span>
    }
<span class="nc bnc" id="L198" title="All 2 branches missed.">    if (StringUtils.isNotEmpty(timeToLive)) {</span>
<span class="nc" id="L199">      requestTranscription.properties.put(&quot;timeToLive&quot;, timeToLive);</span>
    } else {
<span class="nc" id="L201">      requestTranscription.properties.put(&quot;timeToLive&quot;, DEFAULT_TRANSCRIPTION_TIME_TO_LIVE);</span>
    }
<span class="nc" id="L203">    Gson gson = new GsonBuilder().create();</span>
<span class="nc" id="L204">    try (CloseableHttpClient httpClient = HttpUtils.makeHttpClient()) {</span>
<span class="nc" id="L205">      HttpPost httpPost = new HttpPost(url);</span>
<span class="nc" id="L206">      httpPost.addHeader(&quot;Ocp-Apim-Subscription-Key&quot;, azureCognitiveServicesSubscriptionKey);</span>
<span class="nc" id="L207">      httpPost.setEntity(new StringEntity(gson.toJson(requestTranscription), ContentType.APPLICATION_JSON));</span>
<span class="nc" id="L208">      try (CloseableHttpResponse response = httpClient.execute(httpPost)) {</span>
<span class="nc" id="L209">        int code = response.getStatusLine().getStatusCode();</span>
<span class="nc" id="L210">        String responseString = &quot;&quot;;</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">        if (response.getEntity() != null) {</span>
<span class="nc" id="L212">          responseString = EntityUtils.toString(response.getEntity());</span>
        }
<span class="nc bnc" id="L214" title="All 3 branches missed.">        switch (code) {</span>
          case HttpStatus.SC_OK: // 200
          case HttpStatus.SC_CREATED: // 201
<span class="nc" id="L217">            break;</span>
          case HttpStatus.SC_FORBIDDEN: // 403
<span class="nc" id="L219">            throw new MicrosoftAzureNotAllowedException(String.format(</span>
                &quot;Not allowed to create transcription '%s'. Microsoft Azure Speech Services response: %s&quot;,
                displayName, responseString));
          default:
<span class="nc" id="L223">            throw new MicrosoftAzureSpeechClientException(String.format(</span>
                &quot;Creating transcription '%s' failed with HTTP response code %d. &quot;
<span class="nc" id="L225">                    + &quot;Microsoft Azure Speech Services response: %s&quot;, displayName, code, responseString));</span>
        }
<span class="nc" id="L227">        return gson.fromJson(responseString, MicrosoftAzureSpeechTranscription.class);</span>
      }
    }
  }

  public MicrosoftAzureSpeechTranscriptionFiles getTranscriptionFilesById(String transcriptionId)
          throws IOException, MicrosoftAzureNotAllowedException, MicrosoftAzureSpeechClientException,
          MicrosoftAzureNotFoundException {
<span class="nc" id="L235">    String transcriptionUrl = String.format(&quot;%s/speechtotext/v3.1/transcriptions/%s/files&quot;, azureSpeechServicesEndpoint,</span>
<span class="nc" id="L236">        StringUtils.trimToEmpty(transcriptionId));</span>
<span class="nc" id="L237">    return getTranscriptionFiles(transcriptionUrl);</span>
  }

  public MicrosoftAzureSpeechTranscriptionFiles getTranscriptionFiles(String transcriptionFilesUrl)
          throws IOException, MicrosoftAzureNotAllowedException, MicrosoftAzureSpeechClientException,
          MicrosoftAzureNotFoundException {
<span class="nc bnc" id="L243" title="All 2 branches missed.">    if (StringUtils.isBlank(transcriptionFilesUrl)) {</span>
<span class="nc" id="L244">      throw new IllegalArgumentException(&quot;Transcription files URL not set.&quot;);</span>
    }
    // Documentation:
    // https://eastus.dev.cognitive.microsoft.com/docs/services/speech-to-text-api-v3-1/operations/Transcriptions_Get
<span class="nc" id="L248">    String url = StringUtils.trimToEmpty(transcriptionFilesUrl);</span>
<span class="nc" id="L249">    try (CloseableHttpClient httpClient = HttpUtils.makeHttpClient()) {</span>
<span class="nc" id="L250">      HttpGet httpGet = new HttpGet(url);</span>
<span class="nc" id="L251">      httpGet.addHeader(&quot;Ocp-Apim-Subscription-Key&quot;, azureCognitiveServicesSubscriptionKey);</span>
<span class="nc" id="L252">      try (CloseableHttpResponse response = httpClient.execute(httpGet)) {</span>
<span class="nc" id="L253">        int code = response.getStatusLine().getStatusCode();</span>
<span class="nc" id="L254">        String responseString = &quot;&quot;;</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (response.getEntity() != null) {</span>
<span class="nc" id="L256">          responseString = EntityUtils.toString(response.getEntity());</span>
        }
<span class="nc bnc" id="L258" title="All 4 branches missed.">        switch (code) {</span>
          case HttpStatus.SC_OK: // 200
<span class="nc" id="L260">            break;</span>
          case HttpStatus.SC_FORBIDDEN: // 403
<span class="nc" id="L262">            throw new MicrosoftAzureNotAllowedException(String.format(&quot;Not allowed to get transcription files '%s'. &quot;</span>
                    + &quot;Microsoft Azure Speech Services response: %s&quot;, transcriptionFilesUrl, responseString));
          case HttpStatus.SC_NOT_FOUND: // 404
<span class="nc" id="L265">            throw new MicrosoftAzureNotFoundException(String.format(&quot;Transcription files '%s' not found. &quot;</span>
                + &quot;Microsoft Azure Speech Services response: %s&quot;, transcriptionFilesUrl, responseString));
          default:
<span class="nc" id="L268">            throw new MicrosoftAzureSpeechClientException(String.format(</span>
                &quot;Getting transcription files '%s' failed with HTTP response code %d. &quot;
<span class="nc" id="L270">                    + &quot;Microsoft Azure Speech Services response: %s&quot;, transcriptionFilesUrl, code, responseString));</span>
        }
<span class="nc" id="L272">        Gson gson = new GsonBuilder().create();</span>
<span class="nc" id="L273">        return gson.fromJson(responseString, MicrosoftAzureSpeechTranscriptionFiles.class);</span>
      }
    }
  }

  public static MicrosoftAzureSpeechTranscriptionJson getTranscriptionJson(
      MicrosoftAzureSpeechTranscriptionFile transcriptionFile)
          throws IOException, MicrosoftAzureNotAllowedException, MicrosoftAzureSpeechClientException,
          MicrosoftAzureNotFoundException {
<span class="nc" id="L282">    String transcriptionUrl = transcriptionFile.links.contentUrl;</span>
<span class="nc" id="L283">    try (CloseableHttpClient httpClient = HttpUtils.makeHttpClient()) {</span>
<span class="nc" id="L284">      HttpGet httpGet = new HttpGet(transcriptionUrl);</span>
<span class="nc" id="L285">      try (CloseableHttpResponse response = httpClient.execute(httpGet)) {</span>
<span class="nc" id="L286">        int code = response.getStatusLine().getStatusCode();</span>
<span class="nc" id="L287">        String responseString = &quot;&quot;;</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (response.getEntity() != null) {</span>
<span class="nc" id="L289">          responseString = EntityUtils.toString(response.getEntity());</span>
        }
<span class="nc bnc" id="L291" title="All 4 branches missed.">        switch (code) {</span>
          case HttpStatus.SC_OK: // 200
<span class="nc" id="L293">            break;</span>
          case HttpStatus.SC_FORBIDDEN: // 403
<span class="nc" id="L295">            throw new MicrosoftAzureNotAllowedException(String.format(&quot;Not allowed to get transcription file '%s'. &quot;</span>
                    + &quot;Microsoft Azure Speech Services response: %s&quot;,
                transcriptionUrl, responseString));
          case HttpStatus.SC_NOT_FOUND: // 404
<span class="nc" id="L299">            throw new MicrosoftAzureNotFoundException(String.format(&quot;Transcription file '%s' not found. &quot;</span>
                    + &quot;Microsoft Azure Speech Services response: %s&quot;, transcriptionUrl, responseString));
          default:
<span class="nc" id="L302">            throw new MicrosoftAzureSpeechClientException(String.format(</span>
                &quot;Getting transcription file '%s' failed with HTTP response code %d. &quot;
<span class="nc" id="L304">                    + &quot;Microsoft Azure Speech Services response: %s&quot;, transcriptionUrl, code, responseString));</span>
        }
<span class="nc" id="L306">        Gson gson = new GsonBuilder().create();</span>
<span class="nc" id="L307">        return gson.fromJson(responseString, MicrosoftAzureSpeechTranscriptionJson.class);</span>
      }
    }
  }

  public static URI writeTranscriptionFile(MicrosoftAzureSpeechTranscriptionJson transcriptionJson,
      Workspace workspace, String format, float minConfidence, int maxCueLength) throws IOException {
    boolean formatIsWebVtt;
<span class="nc bnc" id="L315" title="All 3 branches missed.">    switch (StringUtils.lowerCase(format)) {</span>
      case &quot;vtt&quot;:
<span class="nc" id="L317">        formatIsWebVtt = true;</span>
<span class="nc" id="L318">        break;</span>
      case &quot;srt&quot;:
<span class="nc" id="L320">        formatIsWebVtt = false;</span>
<span class="nc" id="L321">        break;</span>
      default:
<span class="nc" id="L323">        throw new IllegalArgumentException(&quot;format should be srt or vtt&quot;);</span>
    }
    String content;
<span class="nc bnc" id="L326" title="All 2 branches missed.">    if (formatIsWebVtt) {</span>
<span class="nc" id="L327">      content = transcriptionJson.toWebVtt(minConfidence, maxCueLength);</span>
    } else {
<span class="nc" id="L329">      content = transcriptionJson.toSrt(minConfidence, maxCueLength);</span>
    }
<span class="nc" id="L331">    String fileName = UUID.randomUUID().toString();</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">    if (formatIsWebVtt) {</span>
<span class="nc" id="L333">      fileName += &quot;.vtt&quot;;</span>
    } else {
<span class="nc" id="L335">      fileName += &quot;.srt&quot;;</span>
    }
<span class="nc" id="L337">    try (InputStream is = new ByteArrayInputStream(content.getBytes(StandardCharsets.UTF_8))) {</span>
<span class="nc" id="L338">      return workspace.putInCollection(WORKSPACE_COLLECTION, fileName, is);</span>
    }
  }

  public void deleteTranscription(String transcriptionId)
          throws IOException, MicrosoftAzureNotAllowedException, MicrosoftAzureSpeechClientException {
<span class="nc" id="L344">    String transcriptionDeleteUrl = azureSpeechServicesEndpoint + &quot;/speechtotext/v3.1/transcriptions/&quot;</span>
<span class="nc" id="L345">        + StringUtils.trimToEmpty(transcriptionId);</span>
<span class="nc" id="L346">    try (CloseableHttpClient httpClient = HttpUtils.makeHttpClient()) {</span>
<span class="nc" id="L347">      HttpDelete httpDelete = new HttpDelete(transcriptionDeleteUrl);</span>
<span class="nc" id="L348">      httpDelete.addHeader(&quot;Ocp-Apim-Subscription-Key&quot;, azureCognitiveServicesSubscriptionKey);</span>
<span class="nc" id="L349">      try (CloseableHttpResponse response = httpClient.execute(httpDelete)) {</span>
<span class="nc" id="L350">        int code = response.getStatusLine().getStatusCode();</span>
<span class="nc" id="L351">        String responseString = &quot;&quot;;</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">        if (response.getEntity() != null) {</span>
<span class="nc" id="L353">          responseString = EntityUtils.toString(response.getEntity());</span>
        }
<span class="nc bnc" id="L355" title="All 3 branches missed.">        switch (code) {</span>
          case HttpStatus.SC_OK: // 200
          case HttpStatus.SC_NO_CONTENT: // 204
          case HttpStatus.SC_NOT_FOUND: // 404
<span class="nc" id="L359">            break;</span>
          case HttpStatus.SC_FORBIDDEN: // 403
<span class="nc" id="L361">            throw new MicrosoftAzureNotAllowedException(String.format(&quot;Not allowed to delete transcription '%s'. &quot;</span>
                    + &quot;Microsoft Azure Speech Services response: %s&quot;,
                transcriptionId, responseString));
          default:
<span class="nc" id="L365">            throw new MicrosoftAzureSpeechClientException(String.format(</span>
                &quot;Deleting transcription '%s' failed with HTTP response code %d. &quot;
<span class="nc" id="L367">                    + &quot;Microsoft Azure Speech Services response: %s&quot;, transcriptionId, code, responseString));</span>
        }
      }
    }
<span class="nc" id="L371">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>