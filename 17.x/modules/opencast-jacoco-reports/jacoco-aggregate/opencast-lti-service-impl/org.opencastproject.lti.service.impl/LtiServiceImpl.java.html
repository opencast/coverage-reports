<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>LtiServiceImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-lti-service-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.lti.service.impl</a> &gt; <span class="el_source">LtiServiceImpl.java</span></div><h1>LtiServiceImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.lti.service.impl;

import static org.opencastproject.util.MimeType.mimeType;
import static org.opencastproject.workflow.api.ConfiguredWorkflow.workflow;
import static org.opencastproject.workflow.api.WorkflowInstance.WorkflowState.SUCCEEDED;

import org.opencastproject.assetmanager.api.AssetManager;
import org.opencastproject.assetmanager.util.Workflows;
import org.opencastproject.elasticsearch.api.SearchIndexException;
import org.opencastproject.elasticsearch.api.SearchResult;
import org.opencastproject.elasticsearch.api.SearchResultItem;
import org.opencastproject.elasticsearch.index.ElasticsearchIndex;
import org.opencastproject.elasticsearch.index.objects.event.Event;
import org.opencastproject.elasticsearch.index.objects.event.EventSearchQuery;
import org.opencastproject.index.service.api.IndexService;
import org.opencastproject.index.service.exception.IndexServiceException;
import org.opencastproject.index.service.impl.util.EventUtils;
import org.opencastproject.ingest.api.IngestService;
import org.opencastproject.lti.service.api.LtiFileUpload;
import org.opencastproject.lti.service.api.LtiJob;
import org.opencastproject.lti.service.api.LtiService;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.mediapackage.MediaPackageElement;
import org.opencastproject.mediapackage.MediaPackageElementBuilder;
import org.opencastproject.mediapackage.MediaPackageElementBuilderFactory;
import org.opencastproject.mediapackage.MediaPackageElementFlavor;
import org.opencastproject.mediapackage.MediaPackageElements;
import org.opencastproject.metadata.dublincore.DublinCore;
import org.opencastproject.metadata.dublincore.DublinCoreMetadataCollection;
import org.opencastproject.metadata.dublincore.EventCatalogUIAdapter;
import org.opencastproject.metadata.dublincore.MetadataField;
import org.opencastproject.metadata.dublincore.MetadataJson;
import org.opencastproject.metadata.dublincore.MetadataList;
import org.opencastproject.security.api.AccessControlEntry;
import org.opencastproject.security.api.AccessControlList;
import org.opencastproject.security.api.AclScope;
import org.opencastproject.security.api.AuthorizationService;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.UnauthorizedException;
import org.opencastproject.security.api.User;
import org.opencastproject.series.api.SeriesService;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.workflow.api.ConfiguredWorkflow;
import org.opencastproject.workflow.api.WorkflowDatabaseException;
import org.opencastproject.workflow.api.WorkflowDefinition;
import org.opencastproject.workflow.api.WorkflowInstance;
import org.opencastproject.workflow.api.WorkflowListener;
import org.opencastproject.workflow.api.WorkflowService;
import org.opencastproject.workflow.api.WorkflowUtil;
import org.opencastproject.workspace.api.Workspace;

import com.entwinemedia.fn.data.Opt;
import com.entwinemedia.fn.data.json.SimpleSerializer;
import com.google.gson.Gson;
import com.google.gson.JsonSyntaxException;

import org.apache.commons.lang3.StringUtils;
import org.json.simple.JSONArray;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Modified;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.component.annotations.ReferenceCardinality;
import org.osgi.service.component.annotations.ReferencePolicy;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.ByteArrayInputStream;
import java.net.URI;
import java.nio.charset.StandardCharsets;
import java.time.ZonedDateTime;
import java.time.temporal.ChronoUnit;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.Dictionary;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.UUID;
import java.util.stream.Collectors;

/**
 * The LTI service implementation
 */
@Component(
    immediate = true,
    service = { LtiService.class },
    property = {
        &quot;service.description=LTI Service&quot;
    }
)
<span class="nc" id="L117">public class LtiServiceImpl implements LtiService {</span>
<span class="nc" id="L118">  private static final Logger logger = LoggerFactory.getLogger(LtiServiceImpl.class);</span>

<span class="nc" id="L120">  private static final Gson gson = new Gson();</span>
  private static final String NEW_MP_ID_KEY = &quot;newMpId&quot;;
  private IndexService indexService;
  private IngestService ingestService;
  private SecurityService securityService;
  private WorkflowService workflowService;
  private AssetManager assetManager;
  private Workspace workspace;
  private ElasticsearchIndex searchIndex;
  private AuthorizationService authorizationService;
  private SeriesService seriesService;
  private String workflow;
  private String workflowConfiguration;
  private String retractWorkflowId;
  private String copyWorkflowId;
<span class="nc" id="L135">  private final List&lt;EventCatalogUIAdapter&gt; catalogUIAdapters = new ArrayList&lt;&gt;();</span>
  private boolean listAllJobsInSeries;

  /** OSGi DI */
  @Reference
  public void setAuthorizationService(AuthorizationService authorizationService) {
<span class="nc" id="L141">    this.authorizationService = authorizationService;</span>
<span class="nc" id="L142">  }</span>

  /** OSGI DI */
  @Reference
  public void setSeriesService(SeriesService seriesService) {
<span class="nc" id="L147">    this.seriesService = seriesService;</span>
<span class="nc" id="L148">  }</span>

  /** OSGi DI */
  @Reference
  public void setAssetManager(AssetManager assetManager) {
<span class="nc" id="L153">    this.assetManager = assetManager;</span>
<span class="nc" id="L154">  }</span>

  /** OSGi DI */
  @Reference
  public void setWorkflowService(WorkflowService workflowService) {
<span class="nc" id="L159">    this.workflowService = workflowService;</span>
<span class="nc" id="L160">  }</span>

  /** OSGi DI */
  @Reference
  public void setWorkspace(Workspace workspace) {
<span class="nc" id="L165">    this.workspace = workspace;</span>
<span class="nc" id="L166">  }</span>

  /** OSGi DI */
  @Reference
  public void setSearchIndex(ElasticsearchIndex searchIndex) {
<span class="nc" id="L171">    this.searchIndex = searchIndex;</span>
<span class="nc" id="L172">  }</span>

  /** OSGi DI */
  @Reference
  public void setIndexService(IndexService indexService) {
<span class="nc" id="L177">    this.indexService = indexService;</span>
<span class="nc" id="L178">  }</span>

  /** OSGi DI */
  @Reference
  public void setIngestService(IngestService ingestService) {
<span class="nc" id="L183">    this.ingestService = ingestService;</span>
<span class="nc" id="L184">  }</span>

  /** OSGi DI */
  @Reference
  void setSecurityService(SecurityService securityService) {
<span class="nc" id="L189">    this.securityService = securityService;</span>
<span class="nc" id="L190">  }</span>

  /** OSGi DI. */
  @Reference(
      cardinality = ReferenceCardinality.MULTIPLE,
      policy = ReferencePolicy.DYNAMIC,
      unbind = &quot;removeCatalogUIAdapter&quot;
  )
  public void addCatalogUIAdapter(EventCatalogUIAdapter catalogUIAdapter) {
<span class="nc" id="L199">    catalogUIAdapters.add(catalogUIAdapter);</span>
<span class="nc" id="L200">  }</span>

  /** OSGi DI. */
  public void removeCatalogUIAdapter(EventCatalogUIAdapter catalogUIAdapter) {
<span class="nc" id="L204">    catalogUIAdapters.remove(catalogUIAdapter);</span>
<span class="nc" id="L205">  }</span>

  @Activate
  public void activate(ComponentContext cc) {
<span class="nc" id="L209">    workflowService.addWorkflowListener(new WorkflowListener() {</span>
      @Override
      public void stateChanged(WorkflowInstance workflow) {
<span class="nc bnc" id="L212" title="All 2 branches missed.">        if (!workflow.getTemplate().equals(copyWorkflowId)) {</span>
<span class="nc" id="L213">          return;</span>
        }

<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (workflow.getState().equals(SUCCEEDED)) {</span>
<span class="nc" id="L217">          final String publishWorkflowName = &quot;publish&quot;;</span>
<span class="nc" id="L218">          logger.info(&quot;workflow '{}' succeeded for media package '{}', starting workflow '{}'&quot;, workflow.getTemplate(),</span>
<span class="nc" id="L219">                  workflow.getMediaPackage().getIdentifier(), publishWorkflowName);</span>
          final WorkflowDefinition wfd;
          try {
<span class="nc" id="L222">            wfd = workflowService.getWorkflowDefinitionById(publishWorkflowName);</span>
<span class="nc" id="L223">            final Workflows workflows = new Workflows(assetManager, workflowService);</span>
<span class="nc" id="L224">            final ConfiguredWorkflow newWorkflow = workflow(wfd);</span>
<span class="nc" id="L225">            final String targetMpId = workflow.getConfiguration(NEW_MP_ID_KEY);</span>
<span class="nc" id="L226">            final List&lt;WorkflowInstance&gt; workflowInstances = workflows</span>
<span class="nc" id="L227">                    .applyWorkflowToLatestVersion(Collections.singleton(targetMpId), newWorkflow).toList();</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">            if (workflowInstances.isEmpty()) {</span>
<span class="nc" id="L229">              throw new RuntimeException(</span>
<span class="nc" id="L230">                      String.format(&quot;couldn't start workflow '%s' for event %s&quot;, publishWorkflowName, targetMpId));</span>
            }
<span class="nc" id="L232">          } catch (WorkflowDatabaseException e) {</span>
<span class="nc" id="L233">            logger.error(String.format(&quot;couldn't instantiate workflow '%s'&quot;, publishWorkflowName), e);</span>
<span class="nc" id="L234">          } catch (NotFoundException e) {</span>
<span class="nc" id="L235">            logger.error(String.format(&quot;couldn't find media package while starting workflow workflow '%s'&quot;,</span>
                    publishWorkflowName), e);
<span class="nc" id="L237">          }</span>
        }
<span class="nc" id="L239">      }</span>
    });
<span class="nc" id="L241">    updated(cc.getProperties());</span>
<span class="nc" id="L242">  }</span>

  @Modified
  public void modified(ComponentContext cc) {
<span class="nc" id="L246">    updated(cc.getProperties());</span>
<span class="nc" id="L247">  }</span>

  @Override
  public List&lt;LtiJob&gt; listJobs(String seriesId) {
<span class="nc" id="L251">    final User user = securityService.getUser();</span>
<span class="nc" id="L252">    final EventSearchQuery query = new EventSearchQuery(securityService.getOrganization().getId(), user)</span>
<span class="nc" id="L253">            .withSeriesId(StringUtils.trimToNull(seriesId));</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">    if (!listAllJobsInSeries) {</span>
<span class="nc" id="L255">      query.withCreator(user.getName());</span>
    }
    try {
<span class="nc" id="L258">      SearchResult&lt;Event&gt; results = this.searchIndex.getByQuery(query);</span>
<span class="nc" id="L259">      ZonedDateTime startOfDay = ZonedDateTime.now().truncatedTo(ChronoUnit.DAYS);</span>
<span class="nc" id="L260">      return Arrays.stream(results.getItems())</span>
<span class="nc" id="L261">              .map(SearchResultItem::getSource)</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">              .filter(e -&gt; ZonedDateTime.parse(e.getCreated()).compareTo(startOfDay) &gt; 0)</span>
<span class="nc" id="L263">              .map(e -&gt; new LtiJob(e.getTitle(), e.getDisplayableStatus(workflowService.getWorkflowStateMappings())))</span>
<span class="nc" id="L264">              .collect(Collectors.toList());</span>
<span class="nc" id="L265">    } catch (SearchIndexException e) {</span>
<span class="nc" id="L266">      throw new RuntimeException(&quot;search index exception&quot;, e);</span>
    }
  }

  @Override
  public void upsertEvent(
          final LtiFileUpload file,
          final String captions,
          final String captionFormat,
          final String captionLanguage,
          final String eventId,
          final String seriesId,
          final String metadataJson) throws UnauthorizedException, NotFoundException {
<span class="nc bnc" id="L279" title="All 2 branches missed.">    if (eventId != null) {</span>
<span class="nc" id="L280">      updateEvent(eventId, metadataJson);</span>
<span class="nc" id="L281">      return;</span>
    }
<span class="nc bnc" id="L283" title="All 4 branches missed.">    if (workflow == null || workflowConfiguration == null) {</span>
<span class="nc" id="L284">      throw new RuntimeException(&quot;No workflow configured, cannot upload&quot;);</span>
    }
    try {
<span class="nc" id="L287">      MediaPackage mediaPackage = ingestService.createMediaPackage();</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">      if (mediaPackage == null) {</span>
<span class="nc" id="L289">        throw new RuntimeException(&quot;Unable to create media package for event&quot;);</span>
      }

<span class="nc bnc" id="L292" title="All 2 branches missed.">      if (captions != null) {</span>
<span class="nc" id="L293">        final MediaPackageElementFlavor captionsFlavor = new MediaPackageElementFlavor(</span>
            &quot;captions&quot;, &quot;source&quot;
        );
        final MediaPackageElementBuilder elementBuilder =
<span class="nc" id="L297">            MediaPackageElementBuilderFactory.newInstance().newElementBuilder();</span>
<span class="nc" id="L298">        final MediaPackageElement captionsMediaPackage = elementBuilder</span>
<span class="nc" id="L299">                .newElement(MediaPackageElement.Type.Track, captionsFlavor);</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">        if (!&quot;vtt&quot;.equals(captionFormat)) {</span>
<span class="nc" id="L301">          throw new IllegalArgumentException(&quot;Subtitle format must be vtt, but was &quot; + captionFormat);</span>
        }
<span class="nc" id="L303">        captionsMediaPackage.setMimeType(mimeType(&quot;text&quot;, captionFormat));</span>

<span class="nc" id="L305">        captionsMediaPackage.addTag(&quot;lang:&quot; + captionLanguage);</span>
<span class="nc" id="L306">        mediaPackage.add(captionsMediaPackage);</span>
<span class="nc" id="L307">        final URI captionsUri = workspace</span>
<span class="nc" id="L308">                .put(</span>
<span class="nc" id="L309">                        mediaPackage.getIdentifier().toString(),</span>
<span class="nc" id="L310">                        captionsMediaPackage.getIdentifier(),</span>
                        &quot;captions.&quot; + captionFormat,
<span class="nc" id="L312">                        new ByteArrayInputStream(captions.getBytes(StandardCharsets.UTF_8)));</span>
<span class="nc" id="L313">        captionsMediaPackage.setURI(captionsUri);</span>
      }

<span class="nc" id="L316">      final EventCatalogUIAdapter adapter = getEventCatalogUIAdapter();</span>

<span class="nc" id="L318">      final DublinCoreMetadataCollection collection = adapter.getRawFields();</span>

<span class="nc" id="L320">      JSONArray metadataJsonArray = (JSONArray) new JSONParser().parse(metadataJson);</span>

<span class="nc" id="L322">      JSONArray collectionJsonArray = MetadataJson.extractSingleCollectionfromListJson(metadataJsonArray);</span>
<span class="nc" id="L323">      MetadataJson.fillCollectionFromJson(collection, collectionJsonArray);</span>

<span class="nc" id="L325">      replaceField(collection, &quot;isPartOf&quot;, seriesId);</span>
<span class="nc" id="L326">      adapter.storeFields(mediaPackage, collection);</span>

<span class="nc" id="L328">      AccessControlList accessControlList = null;</span>

      // If series is set and it's ACL is not empty, use series' ACL as default
<span class="nc bnc" id="L331" title="All 2 branches missed.">      if (StringUtils.isNotBlank(seriesId)) {</span>
<span class="nc" id="L332">        accessControlList = seriesService.getSeriesAccessControl(seriesId);</span>
      }

<span class="nc bnc" id="L335" title="All 4 branches missed.">      if (accessControlList == null || accessControlList.getEntries().isEmpty()) {</span>
<span class="nc" id="L336">        accessControlList = new AccessControlList(</span>
          new AccessControlEntry(&quot;ROLE_ADMIN&quot;, &quot;write&quot;, true),
          new AccessControlEntry(&quot;ROLE_ADMIN&quot;, &quot;read&quot;, true),
          new AccessControlEntry(&quot;ROLE_USER&quot;, &quot;read&quot;, true));
      }

<span class="nc" id="L342">      this.authorizationService.setAcl(mediaPackage, AclScope.Episode, accessControlList);</span>
<span class="nc" id="L343">      mediaPackage = ingestService.addTrack(</span>
<span class="nc" id="L344">            file.getStream(),</span>
<span class="nc" id="L345">            file.getSourceName(),</span>
            MediaPackageElements.PRESENTER_SOURCE,
            mediaPackage
      );

<span class="nc" id="L350">      final Map&lt;String, String&gt; configuration = gson.fromJson(workflowConfiguration, Map.class);</span>
<span class="nc" id="L351">      configuration.put(&quot;workflowDefinitionId&quot;, workflow);</span>
<span class="nc" id="L352">      ingestService.ingest(mediaPackage, workflow, configuration);</span>
<span class="nc" id="L353">    } catch (Exception e) {</span>
<span class="nc" id="L354">      throw new RuntimeException(&quot;unable to create event&quot;, e);</span>
<span class="nc" id="L355">    }</span>
<span class="nc" id="L356">  }</span>

  private static Map&lt;String, String&gt; createCopyWorkflowConfig(final String seriesId, final String newMpId) {
<span class="nc" id="L359">    final Map&lt;String, String&gt; result = new HashMap&lt;&gt;();</span>
<span class="nc" id="L360">    result.put(&quot;numberOfEvents&quot;, &quot;1&quot;);</span>
<span class="nc" id="L361">    result.put(&quot;noSuffix&quot;, &quot;true&quot;);</span>
<span class="nc" id="L362">    result.put(&quot;setSeriesId&quot;, seriesId);</span>
<span class="nc" id="L363">    result.put(NEW_MP_ID_KEY, newMpId);</span>
<span class="nc" id="L364">    return result;</span>
  }

  @Override
  public void copyEventToSeries(final String eventId, final String seriesId) {
<span class="nc" id="L369">    final String workflowId = copyWorkflowId;</span>
    try {
<span class="nc" id="L371">      final WorkflowDefinition wfd = workflowService.getWorkflowDefinitionById(workflowId);</span>
<span class="nc" id="L372">      final Workflows workflows = new Workflows(assetManager, workflowService);</span>
<span class="nc" id="L373">      final ConfiguredWorkflow workflow</span>
<span class="nc" id="L374">          = workflow(wfd, createCopyWorkflowConfig(seriesId, UUID.randomUUID().toString()));</span>
<span class="nc" id="L375">      final List&lt;WorkflowInstance&gt; workflowInstances = workflows</span>
<span class="nc" id="L376">              .applyWorkflowToLatestVersion(Collections.singleton(eventId), workflow).toList();</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">      if (workflowInstances.isEmpty()) {</span>
<span class="nc" id="L378">        throw new RuntimeException(String.format(&quot;Couldn't start workflow '%s' for event %s&quot;, workflowId, eventId));</span>
      }
<span class="nc" id="L380">    } catch (WorkflowDatabaseException | NotFoundException e) {</span>
<span class="nc" id="L381">      logger.error(&quot;Unable to get workflow definition {}&quot;, workflowId, e);</span>
<span class="nc" id="L382">      throw new RuntimeException(e);</span>
<span class="nc" id="L383">    }</span>
<span class="nc" id="L384">  }</span>

  private EventCatalogUIAdapter getEventCatalogUIAdapter() {
<span class="nc" id="L387">    final MediaPackageElementFlavor flavor = new MediaPackageElementFlavor(&quot;dublincore&quot;, &quot;episode&quot;);</span>
<span class="nc" id="L388">    final EventCatalogUIAdapter adapter = catalogUIAdapters.stream()</span>
<span class="nc" id="L389">        .filter(e -&gt; e.getFlavor().equals(flavor))</span>
<span class="nc" id="L390">        .findAny()</span>
<span class="nc" id="L391">        .orElseThrow(() -&gt; new RuntimeException(&quot;no adapter found&quot;));</span>
<span class="nc" id="L392">    return adapter;</span>
  }

  private void updateEvent(final String eventId, final String metadata)
          throws NotFoundException, UnauthorizedException {
<span class="nc" id="L397">    final EventCatalogUIAdapter adapter = getEventCatalogUIAdapter();</span>
<span class="nc" id="L398">    final DublinCoreMetadataCollection collection = adapter.getRawFields();</span>
    try {
<span class="nc" id="L400">      final MetadataList metadataList = new MetadataList();</span>
<span class="nc" id="L401">      metadataList.add(adapter, collection);</span>
<span class="nc" id="L402">      MetadataJson.fillListFromJson(metadataList, (JSONArray) new JSONParser().parse(metadata));</span>
<span class="nc" id="L403">      this.indexService.updateEventMetadata(eventId, metadataList, searchIndex);</span>
<span class="nc" id="L404">      republishMetadata(eventId);</span>
<span class="nc" id="L405">    } catch (IndexServiceException | SearchIndexException | ParseException e) {</span>
<span class="nc" id="L406">      throw new RuntimeException(e);</span>
<span class="nc" id="L407">    }</span>
<span class="nc" id="L408">  }</span>

  private void republishMetadata(final String eventId) {
<span class="nc" id="L411">    final String workflowId = &quot;republish-metadata&quot;;</span>
    try {
<span class="nc" id="L413">      final WorkflowDefinition wfd = workflowService.getWorkflowDefinitionById(workflowId);</span>
<span class="nc" id="L414">      final Workflows workflows = new Workflows(assetManager, workflowService);</span>
<span class="nc" id="L415">      final ConfiguredWorkflow workflow = workflow(wfd, Collections.emptyMap());</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">      if (workflows.applyWorkflowToLatestVersion(Collections.singleton(eventId), workflow).isEmpty()) {</span>
<span class="nc" id="L417">        throw new RuntimeException(String.format(&quot;couldn't start workflow '%s' for event %s&quot;, workflowId, eventId));</span>
      }
<span class="nc" id="L419">    } catch (WorkflowDatabaseException | NotFoundException e) {</span>
<span class="nc" id="L420">      logger.error(&quot;Unable to get workflow definition {}&quot;, workflowId, e);</span>
<span class="nc" id="L421">      throw new RuntimeException(e);</span>
<span class="nc" id="L422">    }</span>
<span class="nc" id="L423">  }</span>

  @Override
  public String getEventMetadata(final String eventId) throws NotFoundException, UnauthorizedException {
    final Opt&lt;Event&gt; optEvent;
    try {
<span class="nc" id="L429">      optEvent = indexService.getEvent(eventId, searchIndex);</span>
<span class="nc" id="L430">    } catch (SearchIndexException e) {</span>
<span class="nc" id="L431">      throw new RuntimeException(e);</span>
<span class="nc" id="L432">    }</span>

<span class="nc bnc" id="L434" title="All 2 branches missed.">    if (optEvent.isNone()) {</span>
<span class="nc" id="L435">      throw new NotFoundException(&quot;cannot find event with id '&quot; + eventId + &quot;'&quot;);</span>
    }

<span class="nc" id="L438">    final Event event = optEvent.get();</span>

<span class="nc" id="L440">    final MetadataList metadataList = new MetadataList();</span>
<span class="nc" id="L441">    final List&lt;EventCatalogUIAdapter&gt; catalogUIAdapters = this.indexService.getEventCatalogUIAdapters();</span>
<span class="nc" id="L442">    catalogUIAdapters.remove(this.indexService.getCommonEventCatalogUIAdapter());</span>
    final MediaPackage mediaPackage;
    try {
<span class="nc" id="L445">      mediaPackage = this.indexService.getEventMediapackage(event);</span>
<span class="nc" id="L446">    } catch (IndexServiceException e) {</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">      if (e.getCause() instanceof NotFoundException) {</span>
<span class="nc" id="L448">        throw new NotFoundException(&quot;Cannot retrieve metadata for event with id '&quot; + eventId + &quot;'&quot;);</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">      } else if (e.getCause() instanceof UnauthorizedException) {</span>
<span class="nc" id="L450">        throw new UnauthorizedException(&quot;Not authorized to access event with id '&quot; + eventId + &quot;'&quot;);</span>
      }
<span class="nc" id="L452">      throw new RuntimeException(e);</span>
<span class="nc" id="L453">    }</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">    for (EventCatalogUIAdapter catalogUIAdapter : catalogUIAdapters) {</span>
<span class="nc" id="L455">      metadataList.add(catalogUIAdapter, catalogUIAdapter.getFields(mediaPackage));</span>
<span class="nc" id="L456">    }</span>

    final DublinCoreMetadataCollection metadataCollection;
    try {
<span class="nc" id="L460">      metadataCollection = EventUtils.getEventMetadata(event, this.indexService.getCommonEventCatalogUIAdapter());</span>
<span class="nc" id="L461">    } catch (final Exception e) {</span>
<span class="nc" id="L462">      throw new RuntimeException(e);</span>
<span class="nc" id="L463">    }</span>
<span class="nc" id="L464">    metadataList.add(this.indexService.getCommonEventCatalogUIAdapter(), metadataCollection);</span>

<span class="nc" id="L466">    final String wfState = event.getWorkflowState();</span>
<span class="nc bnc" id="L467" title="All 4 branches missed.">    if (wfState != null &amp;&amp; WorkflowUtil.isActive(WorkflowInstance.WorkflowState.valueOf(wfState))) {</span>
<span class="nc" id="L468">      metadataList.setLocked(MetadataList.Locked.WORKFLOW_RUNNING);</span>
    }
<span class="nc" id="L470">    return new SimpleSerializer().toJson(MetadataJson.listToJson(metadataList, true));</span>
  }

  @Override
  public String getNewEventMetadata() {
<span class="nc" id="L475">    final MetadataList metadataList = this.indexService.getMetadataListWithAllEventCatalogUIAdapters();</span>
<span class="nc" id="L476">    final DublinCoreMetadataCollection collection = metadataList</span>
<span class="nc" id="L477">            .getMetadataByAdapter(this.indexService.getCommonEventCatalogUIAdapter());</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">    if (collection != null) {</span>
<span class="nc bnc" id="L479" title="All 2 branches missed.">      if (collection.getOutputFields().containsKey(DublinCore.PROPERTY_CREATED.getLocalName())) {</span>
<span class="nc" id="L480">        collection.removeField(collection.getOutputFields().get(DublinCore.PROPERTY_CREATED.getLocalName()));</span>
      }
<span class="nc bnc" id="L482" title="All 2 branches missed.">      if (collection.getOutputFields().containsKey(&quot;duration&quot;)) {</span>
<span class="nc" id="L483">        collection.removeField(collection.getOutputFields().get(&quot;duration&quot;));</span>
      }
<span class="nc bnc" id="L485" title="All 2 branches missed.">      if (collection.getOutputFields().containsKey(DublinCore.PROPERTY_IDENTIFIER.getLocalName())) {</span>
<span class="nc" id="L486">        collection.removeField(collection.getOutputFields().get(DublinCore.PROPERTY_IDENTIFIER.getLocalName()));</span>
      }
<span class="nc bnc" id="L488" title="All 2 branches missed.">      if (collection.getOutputFields().containsKey(DublinCore.PROPERTY_SOURCE.getLocalName())) {</span>
<span class="nc" id="L489">        collection.removeField(collection.getOutputFields().get(DublinCore.PROPERTY_SOURCE.getLocalName()));</span>
      }
<span class="nc bnc" id="L491" title="All 2 branches missed.">      if (collection.getOutputFields().containsKey(&quot;startDate&quot;)) {</span>
<span class="nc" id="L492">        collection.removeField(collection.getOutputFields().get(&quot;startDate&quot;));</span>
      }
<span class="nc bnc" id="L494" title="All 2 branches missed.">      if (collection.getOutputFields().containsKey(&quot;startTime&quot;)) {</span>
<span class="nc" id="L495">        collection.removeField(collection.getOutputFields().get(&quot;startTime&quot;));</span>
      }
<span class="nc bnc" id="L497" title="All 2 branches missed.">      if (collection.getOutputFields().containsKey(&quot;location&quot;)) {</span>
<span class="nc" id="L498">        collection.removeField(collection.getOutputFields().get(&quot;location&quot;));</span>
      }

<span class="nc bnc" id="L501" title="All 2 branches missed.">      if (collection.getOutputFields().containsKey(DublinCore.PROPERTY_PUBLISHER.getLocalName())) {</span>
<span class="nc" id="L502">        final MetadataField publisher</span>
<span class="nc" id="L503">            = collection.getOutputFields().get(DublinCore.PROPERTY_PUBLISHER.getLocalName());</span>
        final Map&lt;String, String&gt; users
<span class="nc bnc" id="L505" title="All 2 branches missed.">            = publisher.getCollection() == null ? new HashMap&lt;&gt;() : publisher.getCollection();</span>
<span class="nc" id="L506">        final String loggedInUser = this.securityService.getUser().getName();</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">        if (!users.containsKey(loggedInUser)) {</span>
<span class="nc" id="L508">          users.put(loggedInUser, loggedInUser);</span>
        }
<span class="nc" id="L510">        publisher.setValue(loggedInUser);</span>
      }

<span class="nc" id="L513">      metadataList.add(this.indexService.getCommonEventCatalogUIAdapter(), collection);</span>
    }
<span class="nc" id="L515">    return new SimpleSerializer().toJson(MetadataJson.listToJson(metadataList, true));</span>
  }

  @Override
  public void setEventMetadataJson(final String eventId, final String metadataJson)
          throws NotFoundException, UnauthorizedException {
    try {
<span class="nc" id="L522">      this.indexService.updateAllEventMetadata(eventId, metadataJson, this.searchIndex);</span>
<span class="nc" id="L523">    } catch (IndexServiceException | SearchIndexException e) {</span>
<span class="nc" id="L524">      throw new RuntimeException(e);</span>
<span class="nc" id="L525">    }</span>
<span class="nc" id="L526">  }</span>

  private void replaceField(DublinCoreMetadataCollection collection, String fieldName, String fieldValue) {
<span class="nc" id="L529">    final MetadataField field = collection.getOutputFields().get(fieldName);</span>
<span class="nc" id="L530">    collection.removeField(field);</span>
<span class="nc" id="L531">    collection.addField(MetadataJson.copyWithDifferentJsonValue(field, fieldValue));</span>
<span class="nc" id="L532">  }</span>

  @Override
  public void delete(String id) {
    try {
<span class="nc" id="L537">      final Opt&lt;Event&gt; event = indexService.getEvent(id, searchIndex);</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">      if (event.isNone()) {</span>
<span class="nc" id="L539">        throw new RuntimeException(&quot;Event '&quot; + id + &quot;' not found&quot;);</span>
      }
<span class="nc" id="L541">      final IndexService.EventRemovalResult eventRemovalResult = indexService.removeEvent(event.get(),</span>
              retractWorkflowId);
<span class="nc bnc" id="L543" title="All 2 branches missed.">      if (eventRemovalResult == IndexService.EventRemovalResult.GENERAL_FAILURE) {</span>
<span class="nc" id="L544">        throw new RuntimeException(&quot;Error deleting event: &quot; + eventRemovalResult);</span>
      }
<span class="nc" id="L546">    } catch (WorkflowDatabaseException | SearchIndexException | UnauthorizedException | NotFoundException e) {</span>
<span class="nc" id="L547">      throw new RuntimeException(&quot;Error deleting event&quot;, e);</span>
<span class="nc" id="L548">    }</span>
<span class="nc" id="L549">  }</span>

  /** OSGi callback if properties file is present */
  private void updated(Dictionary&lt;String, ?&gt; properties) {
    // Ensure properties is not null
<span class="nc bnc" id="L554" title="All 2 branches missed.">    if (properties == null) {</span>
<span class="nc" id="L555">      throw new IllegalArgumentException(&quot;No configuration specified for events endpoint&quot;);</span>
    }
<span class="nc" id="L557">    String workflowStr = (String) properties.get(&quot;workflow&quot;);</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">    if (workflowStr == null) {</span>
<span class="nc" id="L559">      throw new IllegalArgumentException(&quot;Configuration is missing 'workflow' parameter&quot;);</span>
    }
<span class="nc" id="L561">    String workflowConfigurationStr = (String) properties.get(&quot;workflow-configuration&quot;);</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">    if (workflowConfigurationStr == null) {</span>
<span class="nc" id="L563">      throw new IllegalArgumentException(&quot;Configuration is missing 'workflow-configuration' parameter&quot;);</span>
    }
    try {
<span class="nc" id="L566">      gson.fromJson(workflowConfigurationStr, Map.class);</span>
<span class="nc" id="L567">      workflowConfiguration = workflowConfigurationStr;</span>
<span class="nc" id="L568">      workflow = workflowStr;</span>
<span class="nc" id="L569">      this.retractWorkflowId = Objects.toString(properties.get(&quot;retract-workflow-id&quot;), &quot;retract&quot;);</span>
<span class="nc" id="L570">      this.copyWorkflowId = Objects.toString(properties.get(&quot;copy-workflow-id&quot;), &quot;copy-event-to-series&quot;);</span>
<span class="nc" id="L571">    } catch (JsonSyntaxException e) {</span>
<span class="nc" id="L572">      throw new IllegalArgumentException(&quot;Invalid JSON specified for workflow configuration&quot;);</span>
<span class="nc" id="L573">    }</span>
<span class="nc" id="L574">    String listAllJobsInSeriesStr = Objects.toString(properties.get(&quot;list-all-jobs-in-series&quot;), &quot;false&quot;);</span>
<span class="nc" id="L575">    this.listAllJobsInSeries = Boolean.parseBoolean(listAllJobsInSeriesStr);</span>
<span class="nc" id="L576">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>