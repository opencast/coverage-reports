<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>MattermostNotificationWorkflowOperationHandler.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-mattermost-notification-workflowoperation</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.workflow.handler.mattermost.notification</a> &gt; <span class="el_source">MattermostNotificationWorkflowOperationHandler.java</span></div><h1>MattermostNotificationWorkflowOperationHandler.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.workflow.handler.mattermost.notification;

import static java.lang.String.format;
import static org.apache.commons.lang3.StringUtils.join;
import static org.apache.http.HttpStatus.SC_ACCEPTED;
import static org.apache.http.HttpStatus.SC_NO_CONTENT;
import static org.apache.http.HttpStatus.SC_OK;

import org.opencastproject.job.api.JobContext;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.workflow.api.AbstractWorkflowOperationHandler;
import org.opencastproject.workflow.api.WorkflowInstance;
import org.opencastproject.workflow.api.WorkflowOperationException;
import org.opencastproject.workflow.api.WorkflowOperationHandler;
import org.opencastproject.workflow.api.WorkflowOperationResult;
import org.opencastproject.workflow.api.WorkflowOperationResult.Action;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.JsonObject;

import org.apache.commons.lang3.StringUtils;
import org.apache.http.HttpResponse;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.config.RequestConfig;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.HttpEntityEnclosingRequestBase;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.client.methods.HttpPut;
import org.apache.http.client.methods.HttpUriRequest;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClientBuilder;
import org.apache.http.message.BasicNameValuePair;
import org.osgi.service.component.annotations.Component;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.util.ArrayList;
import java.util.List;

/**
 * Workflow operation for notifying Mattermost about the status of the current workflow.
 */
@Component(
    immediate = true,
    service = WorkflowOperationHandler.class,
    property = {
        &quot;service.description=Mattermost Notification Operation Handler&quot;,
        &quot;workflow.operation=mattermost-notify&quot;
    }
)
<span class="nc" id="L74">public class MattermostNotificationWorkflowOperationHandler extends AbstractWorkflowOperationHandler {</span>
  /**
   * Configuration key for the target URL of the notification request
   */
  public static final String OPT_URL_PATH = &quot;url&quot;;

  /**
   * Configuration key for the notification message
   */
  public static final String OPT_NOTIFICATION_MESSAGE = &quot;message&quot;;

  /**
   * Configuration key for the HTTP method to use (put or post)
   */
  public static final String OPT_METHOD = &quot;method&quot;;

  /**
   * Configuration key for the maximal attempts for the notification request
   */
  public static final String OPT_MAX_RETRY = &quot;max-retry&quot;;

  /**
   * Configuration key for the request timeout in milliseconds
   */
  public static final String OPT_TIMEOUT = &quot;timeout&quot;;

  /**
   * Name of the subject HTTP parameter
   */
  public static final String HTTP_PARAM_PAYLOAD = &quot;payload&quot;;

  /**
   * HTTP method POST
   */
  public static final String POST = &quot;post&quot;;

  /**
   * HTTP method PUT
   */
  public static final String PUT = &quot;put&quot;;

  /**
   * The logging facility
   */
<span class="nc" id="L118">  private static final Logger logger = LoggerFactory.getLogger(MattermostNotificationWorkflowOperationHandler.class);</span>

  /**
   * Default value for the number of attempts for a request
   */
  private static final int DEFAULT_MAX_RETRY = 5;

  /**
   * Default maximum wait time the client when trying to execute a request in milliseconds
   */
  private static final int DEFAULT_TIMEOUT = 10 * 1000;

  /**
   * Default time between two request attempts in milliseconds
   */
  public static final int INITIAL_SLEEP_TIME = 10 * 1000;

  /**
   * The scale factor to the sleep time between two notification attempts
   */
  public static final int SLEEP_SCALE_FACTOR = 2;

  /**
   * Gson instance for JSON serialization.
   */
<span class="nc" id="L143">  private static Gson gson = new GsonBuilder().create();</span>

  /**
   * {@inheritDoc}
   */
  @Override
  public WorkflowOperationResult start(WorkflowInstance workflowInstance, JobContext context)
          throws WorkflowOperationException {
<span class="nc" id="L151">    logger.debug(&quot;Running HTTP notification workflow operation on workflow {}&quot;, workflowInstance.getId());</span>
<span class="nc" id="L152">    int maxRetry = DEFAULT_MAX_RETRY;</span>
<span class="nc" id="L153">    int timeout = DEFAULT_TIMEOUT;</span>

    // Required configuration
<span class="nc" id="L156">    String urlPath = getConfig(workflowInstance, OPT_URL_PATH);</span>

    // Optional configuration
<span class="nc" id="L159">    String notificationMessage = getConfig(workflowInstance, OPT_NOTIFICATION_MESSAGE, null);</span>
<span class="nc" id="L160">    String method = getConfig(workflowInstance, OPT_METHOD, POST);</span>
<span class="nc" id="L161">    String maxRetryOpt = getConfig(workflowInstance, OPT_MAX_RETRY, null);</span>
<span class="nc" id="L162">    String timeoutOpt = getConfig(workflowInstance, OPT_TIMEOUT, null);</span>

    // If set, convert the timeout to milliseconds
<span class="nc bnc" id="L165" title="All 2 branches missed.">    if (timeoutOpt != null) {</span>
<span class="nc" id="L166">      timeout = Integer.parseInt(timeoutOpt) * 1000;</span>
    }

    // Is there a need to retry on failure?
<span class="nc bnc" id="L170" title="All 2 branches missed.">    if (maxRetryOpt != null) {</span>
<span class="nc" id="L171">      maxRetry = Integer.parseInt(maxRetryOpt);</span>
    }

    // Figure out which request method to use
    HttpEntityEnclosingRequestBase request;
<span class="nc bnc" id="L176" title="All 2 branches missed.">    if (StringUtils.equalsIgnoreCase(POST, method)) {</span>
<span class="nc" id="L177">      request = new HttpPost(urlPath);</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">    } else if (StringUtils.equalsIgnoreCase(PUT, method)) {</span>
<span class="nc" id="L179">      request = new HttpPut(urlPath);</span>
    } else {
<span class="nc" id="L181">      throw new WorkflowOperationException(&quot;The configuration key '&quot; + OPT_METHOD + &quot;' only supports 'post' and 'put'&quot;);</span>
    }
<span class="nc" id="L183">    logger.debug(&quot;Request will be sent using the '{}' method&quot;, method);</span>

    // Add event parameters as form parameters
<span class="nc" id="L186">    MediaPackage mp = workflowInstance.getMediaPackage();</span>
    try {
<span class="nc" id="L188">      List&lt;BasicNameValuePair&gt; params = new ArrayList&lt;&gt;();</span>

      // Add the subject (if specified)
<span class="nc bnc" id="L191" title="All 2 branches missed.">      if (notificationMessage != null) {</span>
<span class="nc" id="L192">        params.add(new BasicNameValuePair(HTTP_PARAM_PAYLOAD, makeJson(notificationMessage, workflowInstance, mp)));</span>
      }

<span class="nc" id="L195">      request.setEntity(new UrlEncodedFormEntity(params, &quot;UTF-8&quot;));</span>
<span class="nc" id="L196">    } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L197">      throw new WorkflowOperationException(&quot;Error encoding the event parameter as form parameter&quot;, e);</span>
<span class="nc" id="L198">    }</span>

    // Execute the request
<span class="nc bnc" id="L201" title="All 2 branches missed.">    if (!executeRequest(request, maxRetry, timeout, INITIAL_SLEEP_TIME)) {</span>
<span class="nc" id="L202">      throw new WorkflowOperationException(format(&quot;Notification could not be delivered to %s&quot;, urlPath));</span>
    }

<span class="nc" id="L205">    return createResult(mp, Action.CONTINUE);</span>
  }

  /**
   * Gets a notification message with placeholders and substitute them with corresponding meta-data of workflowInstance.
   * The resulting String is transformed to a Json-String
   *
   * @param s                The notification message to transform to Json-String
   * @param workflowInstance The workflowInstance which getting metadata from
   * @param mediaPackage     The mediaPackage
   * @return JSON-String containing the information of the workflowInstance
   */
  private String makeJson(String s, WorkflowInstance workflowInstance, MediaPackage mediaPackage) {
<span class="nc" id="L218">    s = s.replace(&quot;%t&quot;, checkIfNull(workflowInstance.getTitle(), &quot;Title&quot;));</span>
<span class="nc" id="L219">    s = s.replace(&quot;%i&quot;, String.valueOf(workflowInstance.getId()));</span>
<span class="nc" id="L220">    s = s.replace(&quot;%s&quot;, String.valueOf(workflowInstance.getState()));</span>
<span class="nc" id="L221">    s = s.replace(&quot;%o&quot;, String.valueOf(workflowInstance.getCurrentOperation().getId()));</span>
<span class="nc" id="L222">    s = s.replace(&quot;%I&quot;, checkIfNull(mediaPackage.getIdentifier(), &quot;Mediapackage-ID&quot;));</span>
<span class="nc" id="L223">    s = s.replace(&quot;%T&quot;, checkIfNull(mediaPackage.getTitle(), &quot;Mediapackage-Title&quot;));</span>
<span class="nc" id="L224">    s = s.replace(&quot;%c&quot;, checkIfNull(mediaPackage.getContributors(), &quot;Contributors&quot;));</span>
<span class="nc" id="L225">    s = s.replace(&quot;%C&quot;, checkIfNull(mediaPackage.getCreators(), &quot;Creators&quot;));</span>
<span class="nc" id="L226">    s = s.replace(&quot;%D&quot;, checkIfNull(mediaPackage.getDate(), &quot;Date&quot;));</span>
<span class="nc" id="L227">    s = s.replace(&quot;%d&quot;, checkIfNull(mediaPackage.getDuration(), &quot;Duration&quot;));</span>
<span class="nc" id="L228">    s = s.replace(&quot;%l&quot;, checkIfNull(mediaPackage.getLanguage(), &quot;Language&quot;));</span>
<span class="nc" id="L229">    s = s.replace(&quot;%L&quot;, checkIfNull(mediaPackage.getLicense(), &quot;License&quot;));</span>
<span class="nc" id="L230">    s = s.replace(&quot;%S&quot;, checkIfNull(mediaPackage.getSeriesTitle(), &quot;Series-Title&quot;));</span>

<span class="nc" id="L232">    JsonObject json = new JsonObject();</span>
<span class="nc" id="L233">    json.addProperty(&quot;text&quot;, s);</span>
<span class="nc" id="L234">    return gson.toJson(json);</span>
  }

  /**
   * Checks if an object is null. If an object is null, then method returns not defined, else it returns object as a
   * String
   *
   * @param o The object to check
   * @param s The name of metadata to check
   * @return String containing the transformed object
   */
  private String checkIfNull(Object o, String s) {

<span class="nc bnc" id="L247" title="All 2 branches missed.">    if (o == null) {</span>
<span class="nc" id="L248">      return s + &quot;not defined&quot;;</span>
    }
<span class="nc bnc" id="L250" title="All 2 branches missed.">    if (o instanceof String[]) {</span>
<span class="nc" id="L251">      return join((String[]) o, ',');</span>
    }
<span class="nc" id="L253">    return o.toString();</span>

  }

  /**
   * Execute the given notification request. If the target is not responding, retry as many time as the maxAttampts
   * parameter with in between each try a sleep time.
   *
   * @param request     The request to execute
   * @param maxAttempts The number of attempts in case of error
   * @param timeout     The wait time in milliseconds at which a connection attempt will throw
   * @param sleepTime   The sleep time in milliseconds of a connection
   * @return true if the request has been executed successfully
   */
  private boolean executeRequest(HttpUriRequest request, int maxAttempts, int timeout, int sleepTime) {

<span class="nc" id="L269">    logger.debug(&quot;Executing notification request on target {}, {} attempts left&quot;, request.getURI(), maxAttempts);</span>

<span class="nc" id="L271">    RequestConfig config = RequestConfig.custom()</span>
<span class="nc" id="L272">                                        .setConnectTimeout(timeout)</span>
<span class="nc" id="L273">                                        .setConnectionRequestTimeout(timeout)</span>
<span class="nc" id="L274">                                        .setSocketTimeout(timeout)</span>
<span class="nc" id="L275">                                        .build();</span>
<span class="nc" id="L276">    CloseableHttpClient httpClient = HttpClientBuilder.create()</span>
<span class="nc" id="L277">                                                      .useSystemProperties()</span>
<span class="nc" id="L278">                                                      .setDefaultRequestConfig(config)</span>
<span class="nc" id="L279">                                                      .build();</span>

    HttpResponse response;
    try {
<span class="nc" id="L283">      response = httpClient.execute(request);</span>
<span class="nc" id="L284">    } catch (ClientProtocolException e) {</span>
<span class="nc" id="L285">      logger.error(&quot;Protocol error during execution of query on target {}&quot;, request.getURI(), e);</span>
<span class="nc" id="L286">      return false;</span>
<span class="nc" id="L287">    } catch (IOException e) {</span>
<span class="nc" id="L288">      logger.error(&quot;I/O error during execution of query on target {}&quot;, request.getURI(), e);</span>
<span class="nc" id="L289">      return false;</span>
<span class="nc" id="L290">    }</span>

<span class="nc" id="L292">    Integer statusCode = response.getStatusLine().getStatusCode();</span>
<span class="nc bnc" id="L293" title="All 6 branches missed.">    if (statusCode == SC_OK || statusCode == SC_NO_CONTENT || statusCode == SC_ACCEPTED) {</span>
<span class="nc" id="L294">      logger.debug(&quot;Request successfully executed on target {}, status code: {}&quot;, request.getURI(), statusCode);</span>
<span class="nc" id="L295">      return true;</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">    } else if (maxAttempts &gt; 1) {</span>
<span class="nc" id="L297">      logger.debug(&quot;Request failed on target {}, status code: {}, will retry in {} seconds&quot;, request.getURI(),</span>
<span class="nc" id="L298">              statusCode, sleepTime / 1000);</span>
      try {
<span class="nc" id="L300">        Thread.sleep(sleepTime);</span>
<span class="nc" id="L301">        return executeRequest(request, --maxAttempts, timeout, sleepTime * SLEEP_SCALE_FACTOR);</span>
<span class="nc" id="L302">      } catch (InterruptedException e) {</span>
<span class="nc" id="L303">        logger.error(&quot;Error during sleep time before new notification request try&quot;, e);</span>
<span class="nc" id="L304">        return false;</span>
      }
    } else {
<span class="nc" id="L307">      logger.error(&quot;Request failed on target {}, status code: {}, no more attempt.&quot;, request.getURI(), statusCode);</span>
<span class="nc" id="L308">      return false;</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>