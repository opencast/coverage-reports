<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AdminUserAndGroupLoader.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-userdirectory</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.userdirectory</a> &gt; <span class="el_source">AdminUserAndGroupLoader.java</span></div><h1>AdminUserAndGroupLoader.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.userdirectory;

import static org.opencastproject.userdirectory.InMemoryUserAndRoleProvider.PROVIDER_NAME;

import org.opencastproject.security.api.Organization;
import org.opencastproject.security.api.OrganizationDirectoryListener;
import org.opencastproject.security.api.OrganizationDirectoryService;
import org.opencastproject.security.api.SecurityConstants;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.impl.jpa.JpaGroup;
import org.opencastproject.security.impl.jpa.JpaOrganization;
import org.opencastproject.security.impl.jpa.JpaRole;
import org.opencastproject.security.impl.jpa.JpaUser;
import org.opencastproject.security.util.SecurityUtil;
import org.opencastproject.systems.OpencastConstants;

import org.apache.commons.lang3.StringUtils;
import org.osgi.framework.BundleContext;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.Arrays;
import java.util.HashSet;
import java.util.Objects;
import java.util.Set;
import java.util.stream.Collectors;

/**
 * User and group loader to create a system administrator group for each tenant along with a user named after the
 * organization.
 */
@Component(
    property = {
        &quot;service.description=System admin user and group loader&quot;
    },
    immediate = true,
    service = { AdminUserAndGroupLoader.class }
)
<span class="nc" id="L64">public class AdminUserAndGroupLoader implements OrganizationDirectoryListener {</span>

  /** The logging facility */
<span class="nc" id="L67">  private static final Logger logger = LoggerFactory.getLogger(AdminUserAndGroupLoader.class);</span>

  /** The administrator password configuration option */
  public static final String OPT_ADMIN_PASSWORD = &quot;org.opencastproject.security.admin.pass&quot;;

  /**
   * The administrator password set by default in the configuration file.
   * Note that this is not set if it is not defined in the configuration file.
   **/
  private static final String DEFAULT_ADMIN_PASSWORD_CONFIGURATION = &quot;opencast&quot;;

  /** The administrator roles configuration option */
  public static final String OPT_ADMIN_ROLES = &quot;org.opencastproject.security.admin.roles&quot;;

  /** The administrator group's suffix */
  public static final String SYSTEM_ADMIN_GROUP_SUFFIX = &quot;_SYSTEM_ADMINS&quot;;

  /** The configuration value of the administrator username */
<span class="nc" id="L85">  private String adminUserName = null;</span>

  /** The configuration value of the administrator password */
<span class="nc" id="L88">  private String adminPassword = null;</span>

  /** The configuration value of the administrator email */
<span class="nc" id="L91">  private String adminEmail = null;</span>

  /** The configuration value of the administrator roles */
<span class="nc" id="L94">  private String adminRoles = null;</span>

  /** User and role provider */
  protected JpaUserAndRoleProvider userAndRoleProvider;

  /** Group provider */
  protected JpaGroupRoleProvider groupRoleProvider;

  /** The organization directory service */
  protected OrganizationDirectoryService organizationDirectoryService;

  /** The security service to use to run as the context for adding the groups */
  protected SecurityService securityService;

  /** The component context */
<span class="nc" id="L109">  protected ComponentContext componentCtx = null;</span>

  /**
   * Callback for activation of this component.
   *
   * @param cc
   *          the component context
   */
  @Activate
  public void activate(ComponentContext cc) throws Exception {
<span class="nc" id="L119">    logger.debug(&quot;Activating admin group loader&quot;);</span>
<span class="nc" id="L120">    BundleContext bundleCtx = cc.getBundleContext();</span>
<span class="nc" id="L121">    adminUserName = StringUtils.trimToNull(bundleCtx.getProperty(SecurityConstants.GLOBAL_ADMIN_USER_PROPERTY));</span>
<span class="nc" id="L122">    adminPassword = StringUtils.trimToNull(bundleCtx.getProperty(OPT_ADMIN_PASSWORD));</span>
<span class="nc" id="L123">    adminEmail = StringUtils.trimToNull(bundleCtx.getProperty(OpencastConstants.ADMIN_EMAIL_PROPERTY));</span>
<span class="nc" id="L124">    adminRoles = StringUtils.trimToNull(bundleCtx.getProperty(OPT_ADMIN_ROLES));</span>

<span class="nc bnc" id="L126" title="All 2 branches missed.">    if (DEFAULT_ADMIN_PASSWORD_CONFIGURATION.equals(adminPassword)) {</span>
<span class="nc" id="L127">      logger.warn(&quot;\n&quot;</span>
            + &quot;######################################################\n&quot;
            + &quot;#                                                    #\n&quot;
            + &quot;# WARNING: Opencast still uses the default admin     #\n&quot;
            + &quot;#          credentials. Never do this in production. #\n&quot;
            + &quot;#                                                    #\n&quot;
            + &quot;#          To change the password, edit the key      #\n&quot;
            + &quot;#          org.opencastproject.security.admin.pass   #\n&quot;
            + &quot;#          in custom.properties.                     #\n&quot;
            + &quot;#                                                    #\n&quot;
            + &quot;######################################################&quot;);
    }

    // Keep a reference to the component context
<span class="nc" id="L141">    componentCtx = cc;</span>

    // Create the administration user and group for each organization
<span class="nc bnc" id="L144" title="All 2 branches missed.">    for (final Organization organization : organizationDirectoryService.getOrganizations()) {</span>
<span class="nc" id="L145">      createSystemAdministratorUserAndGroup(organization);</span>
<span class="nc" id="L146">    }</span>
<span class="nc" id="L147">  }</span>

  /**
   * Creates a JpaOrganization from an organization
   *
   * @param org
   *          the organization
   */
  private JpaOrganization fromOrganization(Organization org) {
<span class="nc bnc" id="L156" title="All 2 branches missed.">    if (org instanceof JpaOrganization) {</span>
<span class="nc" id="L157">      return (JpaOrganization) org;</span>
    }
<span class="nc" id="L159">    return new JpaOrganization(org.getId(), org.getName(), org.getServers(), org.getAdminRole(), org.getAnonymousRole(),</span>
<span class="nc" id="L160">            org.getProperties());</span>
  }

  /**
   * Creates initial groups for system administrators per organization.
   *
   * @param organization
   *          the organization
   * @throws IOException
   *           if loading of the role lists fails
   * @throws IllegalStateException
   *           if the specified role list is unavailable
   */
  private void createSystemAdministratorUserAndGroup(final Organization organization) {

<span class="nc bnc" id="L175" title="All 4 branches missed.">    if ((adminUserName == null) || (adminPassword == null)) {</span>
<span class="nc" id="L176">      logger.info(&quot;The administrator user and group loader is disabled.&quot;);</span>
<span class="nc" id="L177">      return;</span>
    }

<span class="nc" id="L180">    SecurityUtil.runAs(securityService, organization, SecurityUtil.createSystemUser(componentCtx, organization), () -&gt; {</span>
      try {
<span class="nc" id="L182">        JpaOrganization org = fromOrganization(organizationDirectoryService.getOrganization(organization.getId()));</span>

        // Make sure the administrator exists for this organization. Note that the user will gain its roles through
        // membership in the administrator group
<span class="nc bnc" id="L186" title="All 2 branches missed.">        boolean userExists = userAndRoleProvider.loadUser(adminUserName) != null;</span>
        // Add roles according to the system configuration
<span class="nc" id="L188">        Set&lt;JpaRole&gt; adminRolesSet = Arrays.stream(StringUtils.split(Objects.toString(adminRoles, &quot;&quot;), ','))</span>
<span class="nc" id="L189">            .map(StringUtils::trimToNull)</span>
<span class="nc" id="L190">            .filter(Objects::nonNull)</span>
<span class="nc" id="L191">            .map(r -&gt; new JpaRole(r, org))</span>
<span class="nc" id="L192">            .collect(Collectors.toSet());</span>
<span class="nc" id="L193">        JpaUser adminUser = new JpaUser(adminUserName, adminPassword, org, &quot;Administrator&quot;, adminEmail, PROVIDER_NAME,</span>
                                false, adminRolesSet);
<span class="nc bnc" id="L195" title="All 2 branches missed.">        if (userExists) {</span>
<span class="nc" id="L196">          userAndRoleProvider.updateUser(adminUser);</span>
<span class="nc" id="L197">          logger.info(&quot;Administrator user for '{}' updated&quot;, org.getId());</span>
        } else {
<span class="nc" id="L199">          userAndRoleProvider.addUser(adminUser);</span>
<span class="nc" id="L200">          logger.info(&quot;Administrator user for '{}' created&quot;, org.getId());</span>
        }

        // System administrator group
<span class="nc" id="L204">        String adminGroupId = org.getId().toUpperCase().concat(SYSTEM_ADMIN_GROUP_SUFFIX);</span>
<span class="nc" id="L205">        JpaGroup systemAdminGroup = (JpaGroup) groupRoleProvider.loadGroup(adminGroupId, org.getId());</span>
<span class="nc" id="L206">        Set&lt;JpaRole&gt; systemAdminRoles = new HashSet&lt;&gt;();</span>
<span class="nc" id="L207">        Set&lt;String&gt; systemAdminRolesIds = new HashSet&lt;&gt;();</span>

        // Add global system roles as defined in the code base
<span class="nc bnc" id="L210" title="All 2 branches missed.">        for (String role : SecurityConstants.GLOBAL_SYSTEM_ROLES) {</span>
<span class="nc" id="L211">          systemAdminRoles.add(new JpaRole(role, org));</span>
<span class="nc" id="L212">          systemAdminRolesIds.add(role);</span>
        }

        // Add roles as defined by the organization
<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (StringUtils.isNotBlank(org.getAdminRole())) {</span>
<span class="nc" id="L217">          systemAdminRoles.add(new JpaRole(org.getAdminRole(), org));</span>
<span class="nc" id="L218">          systemAdminRolesIds.add(org.getAdminRole());</span>
        }
<span class="nc bnc" id="L220" title="All 2 branches missed.">        if (StringUtils.isNotBlank(org.getAnonymousRole())) {</span>
<span class="nc" id="L221">          systemAdminRoles.add(new JpaRole(org.getAnonymousRole(), org));</span>
<span class="nc" id="L222">          systemAdminRolesIds.add(org.getAnonymousRole());</span>
        }

        // Add roles according to the system configuration
<span class="nc bnc" id="L226" title="All 2 branches missed.">        if (adminRoles != null) {</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">          for (String r : StringUtils.split(adminRoles, ',')) {</span>
<span class="nc" id="L228">            String roleId = StringUtils.trimToNull(r);</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">            if (roleId != null) {</span>
<span class="nc" id="L230">              systemAdminRoles.add(new JpaRole(roleId, org));</span>
<span class="nc" id="L231">              systemAdminRolesIds.add(roleId);</span>
            }
          }
        }

        // Make sure the organization administrator is part of this group
<span class="nc" id="L237">        Set&lt;String&gt; groupMembers = new HashSet&lt;String&gt;();</span>
<span class="nc" id="L238">        groupMembers.add(adminUserName);</span>

        // Create the group
<span class="nc" id="L241">        String adminGroupName = org.getName().concat(&quot; System Administrators&quot;);</span>
<span class="nc" id="L242">        String adminGroupDescription = &quot;System administrators of '&quot; + org.getName() + &quot;'&quot;;</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (systemAdminGroup == null) {</span>
<span class="nc" id="L244">          logger.info(&quot;Creating {}'s system administrator group&quot;, org.getId());</span>
<span class="nc" id="L245">          systemAdminGroup = new JpaGroup(adminGroupId, org, adminGroupName, adminGroupDescription, systemAdminRoles);</span>
<span class="nc" id="L246">          systemAdminGroup.setMembers(groupMembers);</span>
<span class="nc" id="L247">          groupRoleProvider.addGroup(systemAdminGroup);</span>
        } else {
<span class="nc" id="L249">          logger.info(&quot;Updating roles of {}'s system administrator group&quot;, org.getId());</span>
<span class="nc" id="L250">          groupMembers.addAll(systemAdminGroup.getMembers());</span>
<span class="nc" id="L251">          groupRoleProvider.updateGroup(adminGroupId, adminGroupName, adminGroupDescription,</span>
<span class="nc" id="L252">                  StringUtils.join(systemAdminRolesIds, ','), StringUtils.join(groupMembers, ','));</span>
        }

<span class="nc" id="L255">      } catch (Throwable t) {</span>
<span class="nc" id="L256">        logger.error(&quot;Unable to load system administrator group&quot;, t);</span>
<span class="nc" id="L257">      }</span>
<span class="nc" id="L258">    });</span>
<span class="nc" id="L259">  }</span>

  @Override
  public void organizationRegistered(Organization organization) {
<span class="nc" id="L263">    createSystemAdministratorUserAndGroup(organization);</span>
<span class="nc" id="L264">  }</span>

  @Override
  public void organizationUnregistered(Organization organization) {
    // Nothing to do
<span class="nc" id="L269">  }</span>

  @Override
  public void organizationUpdated(Organization organization) {
    // Nothing to do
<span class="nc" id="L274">  }</span>

  /**
   * OSGi callback for declarative services.
   *
   * @param groupRoleProvider
   *          the groupRoleProvider to set
   */
  @Reference
  void setGroupRoleProvider(JpaGroupRoleProvider groupRoleProvider) {
<span class="nc" id="L284">    this.groupRoleProvider = groupRoleProvider;</span>
<span class="nc" id="L285">  }</span>

  /**
   * OSGi callback for declarative services.
   *
   * @param userAndRoleProvider
   *          the user and role provider to set
   */
  @Reference
  void setUserAndRoleProvider(JpaUserAndRoleProvider userAndRoleProvider) {
<span class="nc" id="L295">    this.userAndRoleProvider = userAndRoleProvider;</span>
<span class="nc" id="L296">  }</span>

  /**
   * OSGi callback for declarative services.
   *
   * @param organizationDirectoryService
   *          the organizationDirectoryService to set
   */
  @Reference
  void setOrganizationDirectoryService(OrganizationDirectoryService organizationDirectoryService) {
<span class="nc" id="L306">    this.organizationDirectoryService = organizationDirectoryService;</span>
<span class="nc" id="L307">    this.organizationDirectoryService.addOrganizationDirectoryListener(this);</span>
<span class="nc" id="L308">  }</span>

  /**
   * OSGi callback for declarative services.
   *
   * @param securityService
   *          the security service
   */
  @Reference
  void setSecurityService(SecurityService securityService) {
<span class="nc" id="L318">    this.securityService = securityService;</span>
<span class="nc" id="L319">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>