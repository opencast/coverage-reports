<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>XACMLUtils.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-authorization-xacml</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.authorization.xacml</a> &gt; <span class="el_source">XACMLUtils.java</span></div><h1>XACMLUtils.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.authorization.xacml;

import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.security.api.AccessControlEntry;
import org.opencastproject.security.api.AccessControlList;
import org.opencastproject.util.XmlSafeParser;

import org.jboss.security.xacml.core.model.policy.ActionMatchType;
import org.jboss.security.xacml.core.model.policy.ActionType;
import org.jboss.security.xacml.core.model.policy.ActionsType;
import org.jboss.security.xacml.core.model.policy.ApplyType;
import org.jboss.security.xacml.core.model.policy.AttributeDesignatorType;
import org.jboss.security.xacml.core.model.policy.AttributeValueType;
import org.jboss.security.xacml.core.model.policy.ConditionType;
import org.jboss.security.xacml.core.model.policy.EffectType;
import org.jboss.security.xacml.core.model.policy.ObjectFactory;
import org.jboss.security.xacml.core.model.policy.PolicyType;
import org.jboss.security.xacml.core.model.policy.ResourceMatchType;
import org.jboss.security.xacml.core.model.policy.ResourceType;
import org.jboss.security.xacml.core.model.policy.ResourcesType;
import org.jboss.security.xacml.core.model.policy.RuleType;
import org.jboss.security.xacml.core.model.policy.SubjectAttributeDesignatorType;
import org.jboss.security.xacml.core.model.policy.TargetType;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.InputStream;
import java.io.StringWriter;
import java.util.List;

import javax.xml.bind.JAXBContext;
import javax.xml.bind.JAXBElement;
import javax.xml.bind.JAXBException;

/**
 * Utility implementation for dealing with XACML data.
 */
public final class XACMLUtils {

  /** XACML rule for combining policies */
  public static final String RULE_COMBINING_ALG
      = &quot;urn:oasis:names:tc:xacml:1.0:rule-combining-algorithm:permit-overrides&quot;;
  /** XACML urn for actions */
  public static final String ACTION_IDENTIFIER = &quot;urn:oasis:names:tc:xacml:1.0:action:action-id&quot;;
  /** XACML urn for resources */
  public static final String RESOURCE_IDENTIFIER = &quot;urn:oasis:names:tc:xacml:1.0:resource:resource-id&quot;;
  /** XACML urn for subject */
  public static final String SUBJECT_IDENTIFIER = &quot;urn:oasis:names:tc:xacml:1.0:subject:subject-id&quot;;
  /** XACML urn for roles */
  public static final String SUBJECT_ROLE_IDENTIFIER = &quot;urn:oasis:names:tc:xacml:2.0:subject:role&quot;;
  /** XACML urn for string equality */
  public static final String XACML_STRING_EQUAL = &quot;urn:oasis:names:tc:xacml:1.0:function:string-equal&quot;;
  /** XACML urn for string equality */
  public static final String XACML_STRING_IS_IN = &quot;urn:oasis:names:tc:xacml:1.0:function:string-is-in&quot;;
  /** W3C String data type */
  public static final String W3C_STRING = &quot;http://www.w3.org/2001/XMLSchema#string&quot;;
  /** The policy assertion issuer */
  public static final String ISSUER = &quot;matterhorn&quot;;
  /** The JAXB Context to use for marshaling XACML security policy documents */
  protected static JAXBContext jBossXacmlJaxbContext;
  /** The logging facility */
<span class="fc" id="L83">  private static final Logger logger = LoggerFactory.getLogger(XACMLUtils.class);</span>

  /** Static initializer for the single JAXB context */
  static {
    try {
<span class="fc" id="L88">      XACMLUtils.jBossXacmlJaxbContext = JAXBContext.newInstance(&quot;org.jboss.security.xacml.core.model.policy&quot;,</span>
<span class="fc" id="L89">              PolicyType.class.getClassLoader());</span>
<span class="nc" id="L90">    } catch (JAXBException e) {</span>
<span class="nc" id="L91">      throw new RuntimeException(e);</span>
<span class="fc" id="L92">    }</span>
<span class="fc" id="L93">  }</span>

  /**
   * Private constructor to disable clients from instantiating this class.
   */
  private XACMLUtils() {
  }

  /**
   * Parses a XACML into an {@link AccessControlList}.
   * &lt;p&gt;
   * Only rules which follow the structure of those created by {@link #getXacml(MediaPackage, AccessControlList)} may be
   * successfully parsed. All other rules are ignored.
   * 
   * @param xacml
   *          the XACML to parse
   * @return the ACL, never {@code null}
   * @throws XACMLParsingException
   *           if parsing fails
   */
  public static AccessControlList parseXacml(InputStream xacml) throws XACMLParsingException {

    try {
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L117">      final AccessControlList acl = new AccessControlList();</span>
<span class="fc" id="L118">      final List&lt;AccessControlEntry&gt; entries = acl.getEntries();</span>
<span class="fc" id="L119">      final PolicyType policy = ((JAXBElement&lt;PolicyType&gt;) XACMLUtils.jBossXacmlJaxbContext</span>
<span class="fc" id="L120">          .createUnmarshaller()</span>
<span class="fc" id="L121">          .unmarshal(XmlSafeParser.parse(xacml)))</span>
<span class="fc" id="L122">          .getValue();</span>

<span class="fc bfc" id="L124" title="All 2 branches covered.">      for (Object object : policy.getCombinerParametersOrRuleCombinerParametersOrVariableDefinition()) {</span>
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">        if (!(object instanceof RuleType)) {</span>
<span class="nc" id="L126">          throw new XACMLParsingException(&quot;Object &quot; + object + &quot; of policy &quot; + policy + &quot; is not of type RuleType&quot;);</span>
        }
<span class="fc" id="L128">        RuleType rule = (RuleType) object;</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">        if (rule.getTarget() == null) {</span>
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">          if (rule.getRuleId().equals(&quot;DenyRule&quot;)) {</span>
<span class="fc" id="L131">            logger.trace(&quot;Skipping global deny rule&quot;);</span>
<span class="fc" id="L132">            continue;</span>
          }
<span class="nc" id="L134">          throw new XACMLParsingException(&quot;Empty rule &quot; + rule + &quot; in policy &quot; + policy);</span>
        }

<span class="fc" id="L137">        String role = null;</span>
<span class="fc" id="L138">        String actionForAce = null;</span>
        try {
<span class="fc" id="L140">          ActionType action = rule.getTarget().getActions().getAction().get(0);</span>
<span class="fc" id="L141">          actionForAce = (String) action.getActionMatch().get(0).getAttributeValue().getContent().get(0);</span>

<span class="fc" id="L143">          @SuppressWarnings(&quot;unchecked&quot;) JAXBElement&lt;ApplyType&gt; apply</span>
<span class="fc" id="L144">              = (JAXBElement&lt;ApplyType&gt;) rule.getCondition().getExpression();</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">          for (JAXBElement&lt;?&gt; element : apply.getValue().getExpression()) {</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">            if (element.getValue() instanceof AttributeValueType) {</span>
<span class="fc" id="L147">              role = (String) ((AttributeValueType) element.getValue()).getContent().get(0);</span>
<span class="fc" id="L148">              break;</span>
            }
<span class="nc" id="L150">          }</span>
<span class="nc" id="L151">        } catch (Exception e) {</span>
<span class="nc" id="L152">          throw new XACMLParsingException(&quot;Rule &quot; + rule + &quot; of policy &quot; + policy + &quot; could not be parsed&quot;, e);</span>
<span class="fc" id="L153">        }</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">        if (role == null) {</span>
<span class="nc" id="L155">          throw new XACMLParsingException(&quot;Unable to find role in rule &quot; + rule + &quot; of policy &quot; + policy);</span>
        }
<span class="fc" id="L157">        AccessControlEntry ace = new AccessControlEntry(role, actionForAce, rule.getEffect().equals(EffectType.PERMIT));</span>
<span class="fc" id="L158">        entries.add(ace);</span>
<span class="fc" id="L159">      }</span>
<span class="fc" id="L160">      return acl;</span>
<span class="nc" id="L161">    } catch (Exception e) {</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">      if (e instanceof XACMLParsingException) {</span>
<span class="nc" id="L163">        throw (XACMLParsingException) e;</span>
      }
<span class="nc" id="L165">      throw new XACMLParsingException(&quot;XACML could not be parsed&quot;, e);</span>
    }
  }

  /**
   * Builds an xml string containing the xacml for the mediapackage.
   *
   * @param mediapackage
   *          the mediapackage
   * @param accessControlList
   *          the tuples of roles to actions
   * @return
   * @throws JAXBException
   */
  public static String getXacml(MediaPackage mediapackage, AccessControlList accessControlList) throws JAXBException {
<span class="fc" id="L180">    ObjectFactory jbossXacmlObjectFactory = new ObjectFactory();</span>
<span class="fc" id="L181">    PolicyType policy = new PolicyType();</span>
<span class="fc" id="L182">    policy.setPolicyId(mediapackage.getIdentifier().toString());</span>
<span class="fc" id="L183">    policy.setVersion(&quot;2.0&quot;);</span>
<span class="fc" id="L184">    policy.setRuleCombiningAlgId(XACMLUtils.RULE_COMBINING_ALG);</span>

    // TODO: Add target/resources to rule
<span class="fc" id="L187">    TargetType policyTarget = new TargetType();</span>
<span class="fc" id="L188">    ResourcesType resources = new ResourcesType();</span>
<span class="fc" id="L189">    ResourceType resource = new ResourceType();</span>
<span class="fc" id="L190">    ResourceMatchType resourceMatch = new ResourceMatchType();</span>
<span class="fc" id="L191">    resourceMatch.setMatchId(XACMLUtils.XACML_STRING_EQUAL);</span>
<span class="fc" id="L192">    AttributeValueType resourceAttributeValue = new AttributeValueType();</span>
<span class="fc" id="L193">    resourceAttributeValue.setDataType(XACMLUtils.W3C_STRING);</span>
<span class="fc" id="L194">    resourceAttributeValue.getContent().add(mediapackage.getIdentifier().toString());</span>
<span class="fc" id="L195">    AttributeDesignatorType resourceDesignator = new AttributeDesignatorType();</span>
<span class="fc" id="L196">    resourceDesignator.setAttributeId(XACMLUtils.RESOURCE_IDENTIFIER);</span>
<span class="fc" id="L197">    resourceDesignator.setDataType(XACMLUtils.W3C_STRING);</span>

    // now go back up the tree
<span class="fc" id="L200">    resourceMatch.setResourceAttributeDesignator(resourceDesignator);</span>
<span class="fc" id="L201">    resourceMatch.setAttributeValue(resourceAttributeValue);</span>
<span class="fc" id="L202">    resource.getResourceMatch().add(resourceMatch);</span>
<span class="fc" id="L203">    resources.getResource().add(resource);</span>
<span class="fc" id="L204">    policyTarget.setResources(resources);</span>
<span class="fc" id="L205">    policy.setTarget(policyTarget);</span>

    // Loop over roleActions and add a rule for each
<span class="fc bfc" id="L208" title="All 2 branches covered.">    for (AccessControlEntry ace : accessControlList.getEntries()) {</span>
<span class="fc" id="L209">      boolean allow = ace.isAllow();</span>

<span class="fc" id="L211">      RuleType rule = new RuleType();</span>
<span class="fc bfc" id="L212" title="All 2 branches covered.">      rule.setRuleId(ace.getRole() + &quot;_&quot; + ace.getAction() + (allow ? &quot;_Permit&quot; : &quot;_Deny&quot;));</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">      if (allow) {</span>
<span class="fc" id="L214">        rule.setEffect(EffectType.PERMIT);</span>
      } else {
<span class="fc" id="L216">        rule.setEffect(EffectType.DENY);</span>
      }

<span class="fc" id="L219">      TargetType target = new TargetType();</span>
<span class="fc" id="L220">      ActionsType actions = new ActionsType();</span>
<span class="fc" id="L221">      ActionType action = new ActionType();</span>
<span class="fc" id="L222">      ActionMatchType actionMatch = new ActionMatchType();</span>
<span class="fc" id="L223">      actionMatch.setMatchId(XACMLUtils.XACML_STRING_EQUAL);</span>
<span class="fc" id="L224">      AttributeValueType attributeValue = new AttributeValueType();</span>
<span class="fc" id="L225">      attributeValue.setDataType(XACMLUtils.W3C_STRING);</span>
<span class="fc" id="L226">      attributeValue.getContent().add(ace.getAction());</span>
<span class="fc" id="L227">      AttributeDesignatorType designator = new AttributeDesignatorType();</span>
<span class="fc" id="L228">      designator.setAttributeId(XACMLUtils.ACTION_IDENTIFIER);</span>
<span class="fc" id="L229">      designator.setDataType(XACMLUtils.W3C_STRING);</span>

      // now go back up the tree
<span class="fc" id="L232">      actionMatch.setActionAttributeDesignator(designator);</span>
<span class="fc" id="L233">      actionMatch.setAttributeValue(attributeValue);</span>
<span class="fc" id="L234">      action.getActionMatch().add(actionMatch);</span>
<span class="fc" id="L235">      actions.getAction().add(action);</span>
<span class="fc" id="L236">      target.setActions(actions);</span>
<span class="fc" id="L237">      rule.setTarget(target);</span>

<span class="fc" id="L239">      ConditionType condition = new ConditionType();</span>
<span class="fc" id="L240">      ApplyType apply = new ApplyType();</span>
<span class="fc" id="L241">      apply.setFunctionId(XACMLUtils.XACML_STRING_IS_IN);</span>

<span class="fc" id="L243">      AttributeValueType conditionAttributeValue = new AttributeValueType();</span>
<span class="fc" id="L244">      conditionAttributeValue.setDataType(XACMLUtils.W3C_STRING);</span>
<span class="fc" id="L245">      conditionAttributeValue.getContent().add(ace.getRole());</span>

<span class="fc" id="L247">      SubjectAttributeDesignatorType subjectDesignator = new SubjectAttributeDesignatorType();</span>
<span class="fc" id="L248">      subjectDesignator.setDataType(XACMLUtils.W3C_STRING);</span>
<span class="fc" id="L249">      subjectDesignator.setAttributeId(XACMLUtils.SUBJECT_ROLE_IDENTIFIER);</span>
<span class="fc" id="L250">      apply.getExpression().add(jbossXacmlObjectFactory.createAttributeValue(conditionAttributeValue));</span>
<span class="fc" id="L251">      apply.getExpression().add(jbossXacmlObjectFactory.createSubjectAttributeDesignator(subjectDesignator));</span>

<span class="fc" id="L253">      condition.setExpression(jbossXacmlObjectFactory.createApply(apply));</span>
<span class="fc" id="L254">      rule.setCondition(condition);</span>
<span class="fc" id="L255">      policy.getCombinerParametersOrRuleCombinerParametersOrVariableDefinition().add(rule);</span>
<span class="fc" id="L256">    }</span>

    // Add the global deny rule
<span class="fc" id="L259">    RuleType deny = new RuleType();</span>
<span class="fc" id="L260">    deny.setEffect(EffectType.DENY);</span>
<span class="fc" id="L261">    deny.setRuleId(&quot;DenyRule&quot;);</span>
<span class="fc" id="L262">    policy.getCombinerParametersOrRuleCombinerParametersOrVariableDefinition().add(deny);</span>

    // serialize to xml
<span class="fc" id="L265">    StringWriter writer = new StringWriter();</span>
<span class="fc" id="L266">    XACMLUtils.jBossXacmlJaxbContext.createMarshaller().marshal(jbossXacmlObjectFactory.createPolicy(policy), writer);</span>
<span class="fc" id="L267">    return writer.getBuffer().toString();</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>