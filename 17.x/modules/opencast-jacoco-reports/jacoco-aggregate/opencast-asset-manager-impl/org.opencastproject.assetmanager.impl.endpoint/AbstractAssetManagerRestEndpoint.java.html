<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AbstractAssetManagerRestEndpoint.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-asset-manager-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.assetmanager.impl.endpoint</a> &gt; <span class="el_source">AbstractAssetManagerRestEndpoint.java</span></div><h1>AbstractAssetManagerRestEndpoint.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.assetmanager.impl.endpoint;

import static javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;
import static javax.servlet.http.HttpServletResponse.SC_CREATED;
import static javax.servlet.http.HttpServletResponse.SC_FORBIDDEN;
import static javax.servlet.http.HttpServletResponse.SC_INTERNAL_SERVER_ERROR;
import static javax.servlet.http.HttpServletResponse.SC_NOT_FOUND;
import static javax.servlet.http.HttpServletResponse.SC_NOT_MODIFIED;
import static javax.servlet.http.HttpServletResponse.SC_NO_CONTENT;
import static javax.servlet.http.HttpServletResponse.SC_OK;
import static org.opencastproject.assetmanager.api.AssetManager.DEFAULT_OWNER;
import static org.opencastproject.systems.OpencastConstants.WORKFLOW_PROPERTIES_NAMESPACE;
import static org.opencastproject.util.RestUtil.R.badRequest;
import static org.opencastproject.util.RestUtil.R.forbidden;
import static org.opencastproject.util.RestUtil.R.noContent;
import static org.opencastproject.util.RestUtil.R.notFound;
import static org.opencastproject.util.RestUtil.R.ok;
import static org.opencastproject.util.RestUtil.R.serverError;
import static org.opencastproject.util.doc.rest.RestParameter.Type.STRING;

import org.opencastproject.assetmanager.api.AssetManager;
import org.opencastproject.assetmanager.api.Property;
import org.opencastproject.assetmanager.api.PropertyId;
import org.opencastproject.assetmanager.api.Value;
import org.opencastproject.assetmanager.api.query.AQueryBuilder;
import org.opencastproject.assetmanager.api.query.AResult;
import org.opencastproject.assetmanager.api.query.ASelectQuery;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.mediapackage.MediaPackageImpl;
import org.opencastproject.rest.AbstractJobProducerEndpoint;
import org.opencastproject.security.api.UnauthorizedException;
import org.opencastproject.util.Checksum;
import org.opencastproject.util.ChecksumType;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.data.Option;
import org.opencastproject.util.doc.rest.RestParameter;
import org.opencastproject.util.doc.rest.RestParameter.Type;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestResponse;
import org.opencastproject.util.doc.rest.RestService;

import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;

import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.HashMap;
import java.util.Map;
import java.util.Optional;

import javax.ws.rs.DELETE;
import javax.ws.rs.FormParam;
import javax.ws.rs.GET;
import javax.ws.rs.HeaderParam;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.WebApplicationException;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;

/**
 * A base REST endpoint for the {@link AssetManager}.
 * &lt;p&gt;
 * The endpoint provides assets over http (see {@link org.opencastproject.assetmanager.impl.HttpAssetProvider}).
 * &lt;p&gt;
 * No @Path annotation here since this class cannot be created by JAX-RS. Put it on the concrete implementations.
 */
@RestService(name = &quot;assetManager&quot;, title = &quot;AssetManager&quot;,
    notes = {
        &quot;All paths are relative to the REST endpoint base (something like http://your.server/files)&quot;,
        &quot;If you notice that this service is not working as expected, there might be a bug! &quot;
            + &quot;You should file an error report with your server logs from the time when the error occurred: &quot;
            + &quot;&lt;a href=\&quot;http://github.com/opencast/opencast/issues\&quot;&gt;Opencast Issue Tracker&lt;/a&gt;&quot;
    },
    abstractText = &quot;This service indexes and queries available (distributed) episodes.&quot;)
<span class="nc" id="L100">public abstract class AbstractAssetManagerRestEndpoint extends AbstractJobProducerEndpoint {</span>
<span class="nc" id="L101">  protected static final Logger logger = LoggerFactory.getLogger(AbstractAssetManagerRestEndpoint.class);</span>

<span class="nc" id="L103">  private final Gson gson = new Gson();</span>

<span class="nc" id="L105">  private final java.lang.reflect.Type stringMapType = new TypeToken&lt;Map&lt;String, String&gt;&gt;() { }.getType();</span>

  public abstract AssetManager getAssetManager();

  /**
   * @deprecated use {@link #snapshot} instead
   */
  @POST
  @Path(&quot;add&quot;)
  @RestQuery(
      name = &quot;add&quot;,
      description = &quot;Adds a media package to the asset manager. This method is deprecated in &quot;
          + &quot;favor of method POST 'snapshot'.&quot;,
      restParameters = {
          @RestParameter(
              name = &quot;mediapackage&quot;,
              isRequired = true,
              type = Type.TEXT,
              description = &quot;The media package to add to the search index.&quot;)},
      responses = {
          @RestResponse(
              description = &quot;The media package was added, no content to return.&quot;,
              responseCode = SC_NO_CONTENT),
          @RestResponse(
              description = &quot;Not allowed to add a media package.&quot;,
              responseCode = SC_FORBIDDEN),
          @RestResponse(
              description = &quot;There has been an internal error and the media package could not be added&quot;,
              responseCode = SC_INTERNAL_SERVER_ERROR)},
      returnDescription = &quot;No content is returned.&quot;)
  @Deprecated
  public Response add(@FormParam(&quot;mediapackage&quot;) final MediaPackageImpl mediaPackage) {
<span class="nc" id="L137">    return snapshot(mediaPackage);</span>
  }

  @POST
  @Path(&quot;snapshot&quot;)
  @RestQuery(name = &quot;snapshot&quot;, description = &quot;Take a versioned snapshot of a media package.&quot;,
      restParameters = {
          @RestParameter(
              name = &quot;mediapackage&quot;,
              isRequired = true,
              type = Type.TEXT,
              description = &quot;The media package to take a snapshot from.&quot;)},
      responses = {
          @RestResponse(
              description = &quot;A snapshot of the media package has been taken, no content to return.&quot;,
              responseCode = SC_NO_CONTENT),
          @RestResponse(
              description = &quot;Not allowed to take a snapshot.&quot;,
              responseCode = SC_FORBIDDEN),
          @RestResponse(
              description = &quot;There has been an internal error and no snapshot could be taken.&quot;,
              responseCode = SC_INTERNAL_SERVER_ERROR)},
      returnDescription = &quot;No content is returned.&quot;)
  public Response snapshot(@FormParam(&quot;mediapackage&quot;) final MediaPackageImpl mediaPackage) {
    try {
<span class="nc" id="L162">      getAssetManager().takeSnapshot(DEFAULT_OWNER, mediaPackage);</span>
<span class="nc" id="L163">      return noContent();</span>
<span class="nc" id="L164">    } catch (Exception e) {</span>
<span class="nc" id="L165">      return handleException(e);</span>
    }
  }

  @POST
  @Path(&quot;updateIndex&quot;)
  @RestQuery(name = &quot;updateIndex&quot;,
      description = &quot;Trigger search index update for event. The usage of this is limited to global administrators.&quot;,
      restParameters = {
          @RestParameter(
              name = &quot;id&quot;,
              isRequired = true,
              type = STRING,
              description = &quot;The event ID to trigger an index update for.&quot;)},
      responses = {
          @RestResponse(
              description = &quot;Update successfully triggered.&quot;,
              responseCode = SC_NO_CONTENT),
          @RestResponse(
              description = &quot;Not allowed to trigger update.&quot;,
              responseCode = SC_FORBIDDEN),
          @RestResponse(
              description = &quot;No such event found.&quot;,
              responseCode = SC_NOT_FOUND)},
      returnDescription = &quot;No content is returned.&quot;)
  public Response indexUpdate(@FormParam(&quot;id&quot;) final String id) {
    try {
<span class="nc" id="L192">      getAssetManager().triggerIndexUpdate(id);</span>
<span class="nc" id="L193">      return noContent();</span>
<span class="nc" id="L194">    } catch (UnauthorizedException e) {</span>
<span class="nc" id="L195">      return forbidden();</span>
<span class="nc" id="L196">    } catch (NotFoundException e) {</span>
<span class="nc" id="L197">      return notFound();</span>
<span class="nc" id="L198">    } catch (Exception e) {</span>
<span class="nc" id="L199">      return handleException(e);</span>
    }
  }

  @DELETE
  @Path(&quot;delete/{id}&quot;)
  @RestQuery(name = &quot;deleteSnapshots&quot;,
      description = &quot;Removes snapshots of an episode, owned by the default owner from the asset manager.&quot;,
      pathParameters = {
          @RestParameter(
              name = &quot;id&quot;,
              isRequired = true,
              type = Type.STRING,
              description = &quot;The media package ID of the episode whose snapshots shall be removed&quot;
                  + &quot; from the asset manager.&quot;)},
      responses = {
          @RestResponse(
              description = &quot;Snapshots have been removed, no content to return.&quot;,
              responseCode = SC_NO_CONTENT),
          @RestResponse(
              description = &quot;The episode does either not exist or no snapshots are owned by the default owner.&quot;,
              responseCode = SC_NOT_FOUND),
          @RestResponse(
              description = &quot;Not allowed to delete this episode.&quot;,
              responseCode = SC_FORBIDDEN),
          @RestResponse(
              description = &quot;There has been an internal error and the episode could not be deleted.&quot;,
              responseCode = SC_INTERNAL_SERVER_ERROR)},
      returnDescription = &quot;No content is returned.&quot;)
  public Response delete(@PathParam(&quot;id&quot;) final String mediaPackageId) {
<span class="nc bnc" id="L229" title="All 2 branches missed.">    if (StringUtils.isEmpty(mediaPackageId)) {</span>
<span class="nc" id="L230">      return notFound();</span>
    }
    try {
<span class="nc" id="L233">      final AQueryBuilder q = getAssetManager().createQuery();</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">      if (q.delete(AssetManager.DEFAULT_OWNER, q.snapshot()).where(q.mediaPackageId(mediaPackageId)).run() &gt; 0) {</span>
<span class="nc" id="L235">        return noContent();</span>
      }
<span class="nc" id="L237">      return notFound();</span>
<span class="nc" id="L238">    } catch (Exception e) {</span>
<span class="nc" id="L239">      return handleException(e);</span>
    }
  }

  @GET
  @Produces(MediaType.TEXT_XML)
  @Path(&quot;episode/{mediaPackageID}&quot;)
  @RestQuery(name = &quot;getLatestEpisode&quot;,
      description = &quot;Get the media package from the last snapshot of an episode.&quot;,
      returnDescription = &quot;The media package&quot;,
      pathParameters = {
          @RestParameter(
              name = &quot;mediaPackageID&quot;,
              description = &quot;the media package ID&quot;,
              isRequired = true,
              type = STRING)
      },
      responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Media package returned&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;Not found&quot;),
          @RestResponse(responseCode = SC_FORBIDDEN, description = &quot;Not allowed to read media package.&quot;),
          @RestResponse(responseCode = SC_INTERNAL_SERVER_ERROR, description = &quot;There has been an internal error.&quot;)
      })
  public Response getMediaPackage(@PathParam(&quot;mediaPackageID&quot;) final String mediaPackageId) {

    try {
<span class="nc" id="L265">      Optional&lt;MediaPackage&gt; mp = getAssetManager().getMediaPackage(mediaPackageId);</span>

<span class="nc bnc" id="L267" title="All 2 branches missed.">      if (mp.isPresent()) {</span>
<span class="nc" id="L268">        return ok(mp.get());</span>
      } else {
<span class="nc" id="L270">        return notFound();</span>
      }
<span class="nc" id="L272">    } catch (Exception e) {</span>
<span class="nc" id="L273">      return handleException(e);</span>
    }
  }

  @GET
  @Path(&quot;assets/{mediaPackageID}/{mediaPackageElementID}/{version}/{filename}&quot;)
  @RestQuery(name = &quot;getAsset&quot;,
      description = &quot;Get an asset&quot;,
      returnDescription = &quot;The file&quot;,
      pathParameters = {
          @RestParameter(
              name = &quot;mediaPackageID&quot;,
              description = &quot;the media package identifier&quot;,
              isRequired = true,
              type = STRING),
          @RestParameter(
              name = &quot;mediaPackageElementID&quot;,
              description = &quot;the media package element identifier&quot;,
              isRequired = true,
              type = STRING),
          @RestParameter(
              name = &quot;version&quot;,
              description = &quot;the media package version&quot;,
              isRequired = true,
              type = STRING),
          @RestParameter(
              name = &quot;filename&quot;,
              description = &quot;a descriptive filename used as the download filename&quot;,
              isRequired = false,
              type = STRING)},
      responses = {
          @RestResponse(
              responseCode = SC_OK,
              description = &quot;File returned&quot;),
          @RestResponse(
              responseCode = SC_NOT_FOUND,
              description = &quot;Not found&quot;),
          @RestResponse(
              responseCode = SC_NOT_MODIFIED,
              description = &quot;If file not modified&quot;),
          @RestResponse(
              description = &quot;Not allowed to read assets of this snapshot.&quot;,
              responseCode = SC_FORBIDDEN),
          @RestResponse(
              description = &quot;There has been an internal error.&quot;,
              responseCode = SC_INTERNAL_SERVER_ERROR)})
  public Response getAsset(@PathParam(&quot;mediaPackageID&quot;) final String mediaPackageID,
                           @PathParam(&quot;mediaPackageElementID&quot;) final String mediaPackageElementID,
                           @PathParam(&quot;version&quot;) final String version,
                           @PathParam(&quot;filename&quot;) String fileName,
                           @HeaderParam(&quot;If-None-Match&quot;) String ifNoneMatch) {

    try {
<span class="nc" id="L326">      final var v = getAssetManager().toVersion(version);</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">      if (v.isPresent()) {</span>
<span class="nc" id="L328">        var assetOpt = getAssetManager().getAsset(v.get(), mediaPackageID, mediaPackageElementID);</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">        if (assetOpt.isPresent()) {</span>
<span class="nc" id="L330">          var asset = assetOpt.get();</span>

<span class="nc bnc" id="L332" title="All 2 branches missed.">          if (StringUtils.isNotBlank(ifNoneMatch)) {</span>
<span class="nc" id="L333">            Checksum checksum = asset.getChecksum();</span>

<span class="nc bnc" id="L335" title="All 4 branches missed.">            if (checksum != null &amp;&amp; checksum.getType().equals(ChecksumType.DEFAULT_TYPE)) {</span>
<span class="nc" id="L336">              String md5 = checksum.getValue();</span>

<span class="nc bnc" id="L338" title="All 2 branches missed.">              if (md5.equals(ifNoneMatch)) {</span>
<span class="nc" id="L339">                return Response.notModified(md5).build();</span>
              }
<span class="nc" id="L341">            }</span>
            else {
<span class="nc" id="L343">              logger.warn(&quot;Checksum of asset {} of media package {} is of incorrect type or missing&quot;,</span>
                      mediaPackageElementID, mediaPackageID);
            }
          }

<span class="nc bnc" id="L348" title="All 2 branches missed.">          if (StringUtils.isBlank(fileName)) {</span>
<span class="nc" id="L349">            String suffix = &quot;unknown&quot;;</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">            if (asset.getMimeType().isPresent()) {</span>
<span class="nc" id="L351">              var mimetype = asset.getMimeType().get();</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">              if (mimetype.getSuffix().isSome()) {</span>
<span class="nc" id="L353">                suffix = mimetype.getSuffix().get();</span>
              }
            }
<span class="nc" id="L356">            fileName = mediaPackageElementID</span>
<span class="nc" id="L357">                .concat(&quot;.&quot;)</span>
<span class="nc" id="L358">                .concat(suffix);</span>
          }

          // Write the file contents back
<span class="nc bnc" id="L362" title="All 2 branches missed.">          Option&lt;Long&gt; length = asset.getSize() &gt; 0 ? Option.some(asset.getSize()) : Option.none();</span>
<span class="nc" id="L363">          return ok(asset.getInputStream(),</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">                  asset.getMimeType().isPresent() ? Option.some(asset.getMimeType().get().toString()) : Option.none(),</span>
                  length,
<span class="nc" id="L366">                  Option.some(fileName));</span>
        }
        // none
<span class="nc" id="L369">        return notFound();</span>
      }
      // cannot parse version
<span class="nc" id="L372">      return badRequest(&quot;malformed version&quot;);</span>
<span class="nc" id="L373">    } catch (Exception e) {</span>
<span class="nc" id="L374">      return handleException(e);</span>
    }
  }

  @GET
  @Produces(MediaType.APPLICATION_JSON)
  @Path(&quot;{mediaPackageID}/properties.json&quot;)
  @RestQuery(name = &quot;getProperties&quot;,
      description = &quot;Get stored properties for an episode.&quot;,
      returnDescription = &quot;Properties as JSON&quot;,
      pathParameters = {
          @RestParameter(
              name = &quot;mediaPackageID&quot;,
              description = &quot;the media package ID&quot;,
              isRequired = true,
              type = STRING)
      }, restParameters = {
          @RestParameter(
              name = &quot;namespace&quot;,
              description = &quot;property namespace&quot;,
              isRequired = false,
              type = STRING)
      },
      responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Media package returned&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;Not found&quot;),
          @RestResponse(responseCode = SC_FORBIDDEN, description = &quot;Not allowed to read media package.&quot;),
          @RestResponse(responseCode = SC_INTERNAL_SERVER_ERROR, description = &quot;There has been an internal error.&quot;)
      })
  public Response getProperties(@PathParam(&quot;mediaPackageID&quot;) final String mediaPackageId,
          @FormParam(&quot;namespace&quot;) final String namespace) {
    try {
<span class="nc" id="L406">      final AQueryBuilder queryBuilder = getAssetManager().createQuery();</span>
      ASelectQuery query;
<span class="nc bnc" id="L408" title="All 2 branches missed.">      if (StringUtils.isEmpty(namespace)) {</span>
<span class="nc" id="L409">        query = queryBuilder.select(queryBuilder.properties());</span>
      } else {
<span class="nc" id="L411">        query = queryBuilder.select(queryBuilder.propertiesOf(namespace));</span>
      }
<span class="nc" id="L413">      query = query.where(queryBuilder.mediaPackageId(mediaPackageId).and(queryBuilder.version().isLatest()));</span>
<span class="nc" id="L414">      final AResult result = query.run();</span>

      // we expect exactly one result when specifying a media package id
<span class="nc bnc" id="L417" title="All 2 branches missed.">      if (result.getSize() &lt; 1) {</span>
<span class="nc" id="L418">        return notFound();</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">      } else if (result.getSize() &gt; 1) {</span>
<span class="nc" id="L420">        return serverError();</span>
      }

      // build map from properties
<span class="nc" id="L424">      HashMap&lt;String, HashMap&lt;String, String&gt;&gt; properties = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">      if (result.getRecords().stream().findFirst().isPresent()) {</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">        for (final Property property : result.getRecords().stream().findFirst().get().getProperties()) {</span>
<span class="nc" id="L427">          final String key = property.getId().getNamespace() + &quot;.&quot; + property.getId().getName();</span>
<span class="nc" id="L428">          final HashMap&lt;String, String&gt; val = new HashMap&lt;&gt;();</span>
<span class="nc" id="L429">          val.put(&quot;type&quot;, property.getValue().getType().getClass().getSimpleName());</span>
<span class="nc" id="L430">          val.put(&quot;value&quot;, property.getValue().get().toString());</span>
<span class="nc" id="L431">          properties.put(key, val);</span>
<span class="nc" id="L432">        }</span>
      }
<span class="nc" id="L434">      return ok(gson.toJson(properties));</span>
<span class="nc" id="L435">    } catch (Exception e) {</span>
<span class="nc" id="L436">      return handleException(e);</span>
    }
  }

  @GET
  @Produces(MediaType.APPLICATION_JSON)
  @Path(&quot;{mediaPackageID}/workflowProperties.json&quot;)
  @RestQuery(name = &quot;getWorkflowProperties&quot;,
      description = &quot;Get stored workflow properties for an episode.&quot;,
      returnDescription = &quot;Properties as JSON&quot;,
      pathParameters = {
          @RestParameter(
              name = &quot;mediaPackageID&quot;,
              description = &quot;the media package ID&quot;,
              isRequired = true,
              type = STRING)
      },
      responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Media package returned&quot;),
          @RestResponse(responseCode = SC_OK, description = &quot;Invalid parameters&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;Not found&quot;),
          @RestResponse(responseCode = SC_FORBIDDEN, description = &quot;Not allowed to read media package.&quot;),
          @RestResponse(responseCode = SC_INTERNAL_SERVER_ERROR, description = &quot;There has been an internal error.&quot;)
      })
  public Response getWorkflowProperties(@PathParam(&quot;mediaPackageID&quot;) final String mediaPackageId) {
    try {
<span class="nc" id="L462">      final AQueryBuilder queryBuilder = getAssetManager().createQuery();</span>
<span class="nc" id="L463">      final AResult result = queryBuilder.select(queryBuilder.propertiesOf(WORKFLOW_PROPERTIES_NAMESPACE))</span>
<span class="nc" id="L464">              .where(queryBuilder.mediaPackageId(mediaPackageId).and(queryBuilder.version().isLatest())).run();</span>

      // we expect exactly one result when specifying a media package id
<span class="nc bnc" id="L467" title="All 2 branches missed.">      if (result.getSize() &lt; 1) {</span>
<span class="nc" id="L468">        return notFound();</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">      } else if (result.getSize() &gt; 1) {</span>
<span class="nc" id="L470">        return serverError();</span>
      }

      // build map from properties
<span class="nc" id="L474">      HashMap&lt;String, String&gt; properties = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">      if (result.getRecords().stream().findFirst().isPresent()) {</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">        for (final Property property : result.getRecords().stream().findFirst().get().getProperties()) {</span>
<span class="nc" id="L477">          properties.put(property.getId().getName(), property.getValue().get(Value.STRING));</span>
<span class="nc" id="L478">        }</span>
      }
<span class="nc" id="L480">      return ok(gson.toJson(properties));</span>
<span class="nc" id="L481">    } catch (Exception e) {</span>
<span class="nc" id="L482">      return handleException(e);</span>
    }
  }


  @POST
  @Path(&quot;{mediaPackageID}/workflowProperties&quot;)
  @RestQuery(name = &quot;setWorkflowProperties&quot;,
      description = &quot;Set additional workflow properties&quot;,
      pathParameters = {
          @RestParameter(
              name = &quot;mediaPackageID&quot;,
              description = &quot;the media package ID&quot;,
              isRequired = true,
              type = STRING)
      },
      restParameters = {
          @RestParameter(
              name = &quot;properties&quot;,
              isRequired = true,
              type = STRING,
              description = &quot;JSON object containing new properties&quot;)
      },
      responses = {
          @RestResponse(description = &quot;Properties successfully set&quot;, responseCode = SC_CREATED),
          @RestResponse(description = &quot;Invalid data&quot;, responseCode = SC_BAD_REQUEST),
          @RestResponse(description = &quot;Internal error&quot;, responseCode = SC_INTERNAL_SERVER_ERROR) },
      returnDescription = &quot;Returned status code indicates success&quot;)
  public Response setWorkflowProperties(@PathParam(&quot;mediaPackageID&quot;) final String mediaPackageId,
          @FormParam(&quot;properties&quot;) final String propertiesJSON) {
    Map&lt;String, String&gt; properties;
    try {
<span class="nc" id="L514">      properties = gson.fromJson(propertiesJSON, stringMapType);</span>
<span class="nc" id="L515">    } catch (Exception e) {</span>
<span class="nc" id="L516">      return badRequest();</span>
<span class="nc" id="L517">    }</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">    for (final Map.Entry&lt;String, String&gt; entry : properties.entrySet()) {</span>
<span class="nc" id="L519">      final PropertyId propertyId = PropertyId.mk(mediaPackageId, WORKFLOW_PROPERTIES_NAMESPACE, entry.getKey());</span>
<span class="nc" id="L520">      final Property property = Property.mk(propertyId, Value.mk(entry.getValue()));</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">      if (!getAssetManager().setProperty(property)) {</span>
<span class="nc" id="L522">        return notFound();</span>
      }
<span class="nc" id="L524">    }</span>
<span class="nc" id="L525">    return noContent();</span>
  }

  /** Unify exception handling. */
  public static Response handleException(Exception e) {
<span class="nc" id="L530">    logger.debug(&quot;Error calling REST method&quot;, e);</span>
<span class="nc" id="L531">    Throwable cause = e;</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">    if (e.getCause() != null) {</span>
<span class="nc" id="L533">      cause = e.getCause();</span>
    }
<span class="nc bnc" id="L535" title="All 2 branches missed.">    if (cause instanceof UnauthorizedException) {</span>
<span class="nc" id="L536">      return forbidden();</span>
    }

<span class="nc" id="L539">    throw new WebApplicationException(e, Response.Status.INTERNAL_SERVER_ERROR);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>