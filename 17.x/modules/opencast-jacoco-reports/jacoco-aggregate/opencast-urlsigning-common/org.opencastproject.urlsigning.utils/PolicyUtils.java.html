<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>PolicyUtils.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-urlsigning-common</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.urlsigning.utils</a> &gt; <span class="el_source">PolicyUtils.java</span></div><h1>PolicyUtils.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.urlsigning.utils;

import org.opencastproject.urlsigning.common.Policy;

import org.apache.commons.codec.binary.Base64;
import org.joda.time.DateTime;
import org.joda.time.DateTimeZone;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;

import java.nio.charset.StandardCharsets;
import java.util.Map;
import java.util.TreeMap;

/**
 * A Utility class to encode / decode Policy files from and to Base 64 and Json.
 */
public final class PolicyUtils {
  /** The JSON key for object that contains the date and ip conditions for the resource. */
  private static final String CONDITION_KEY = &quot;Condition&quot;;
  /** The JSON key for the date and time the resource will become available. */
  private static final String DATE_GREATER_THAN_KEY = &quot;DateGreaterThan&quot;;
  /** The JSON key for the date and time the resource will no longer be available. */
  private static final String DATE_LESS_THAN_KEY = &quot;DateLessThan&quot;;
  /** The JSON key for the IP address of the acceptable client. */
  private static final String IP_ADDRESS_KEY = &quot;IpAddress&quot;;
  /** The JSON key for the base url for the resource. */
  private static final String RESOURCE_KEY = &quot;Resource&quot;;
  /** The JSON key for the main object of the policy. */
  private static final String STATEMENT_KEY = &quot;Statement&quot;;

  private PolicyUtils() {

  }

  /**
   * Encode a {@link String} into Base 64 encoding
   *
   * @param value
   *          The {@link String} to encode into base 64 encoding
   * @return The {@link String} encoded into base 64.
   */
  public static String base64Encode(String value) {
<span class="fc" id="L65">    return Base64.encodeBase64URLSafeString(value.getBytes());</span>
  }

  /**
   * Decode a {@link String} from Base 64 encoding
   *
   * @param value
   *          The {@link String} to encode into Base 64
   * @return The {@link String} decoded from base 64.
   */
  public static String base64Decode(String value) {
<span class="fc" id="L76">    return new String(Base64.decodeBase64(value), StandardCharsets.UTF_8);</span>
  }

  /**
   * Get a {@link Policy} from JSON data.
   *
   * @param policyJson
   *          The {@link String} representation of the json.
   * @return A new {@link Policy} object populated from the JSON.
   */
  public static Policy fromJson(String policyJson) {
<span class="fc" id="L87">    JSONObject jsonPolicy = null;</span>
<span class="fc" id="L88">    JSONParser jsonParser = new JSONParser();</span>
    try {
<span class="fc" id="L90">      jsonPolicy = (JSONObject) jsonParser.parse(policyJson);</span>
<span class="nc" id="L91">    } catch (ParseException e) {</span>
<span class="nc" id="L92">      e.printStackTrace();</span>
<span class="fc" id="L93">    }</span>
<span class="fc" id="L94">    JSONObject statement = (JSONObject) jsonPolicy.get(STATEMENT_KEY);</span>
<span class="fc" id="L95">    String resource = statement.get(RESOURCE_KEY).toString();</span>
<span class="fc" id="L96">    JSONObject condition = (JSONObject) statement.get(CONDITION_KEY);</span>

<span class="fc" id="L98">    final String lessThanString = condition.get(DATE_LESS_THAN_KEY).toString();</span>
<span class="fc" id="L99">    final DateTime dateLessThan = new DateTime(Long.parseLong(lessThanString), DateTimeZone.UTC);</span>

    final DateTime dateGreaterThan;
<span class="fc" id="L102">    Object greaterThanString = condition.get(DATE_GREATER_THAN_KEY);</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">    if (greaterThanString != null) {</span>
<span class="fc" id="L104">      dateGreaterThan = new DateTime(Long.parseLong(greaterThanString.toString()), DateTimeZone.UTC);</span>
    } else {
<span class="fc" id="L106">      dateGreaterThan = null;</span>
    }

<span class="fc" id="L109">    return Policy.mkPolicyValidFromWithIP(resource, dateLessThan, dateGreaterThan,</span>
<span class="fc" id="L110">            (String) condition.get(IP_ADDRESS_KEY));</span>
  }

  /**
   * Render a {@link Policy} into JSON.
   *
   * @param policy
   *          The {@link Policy} to render into JSON.
   * @return The {@link JSONObject} representation of the {@link Policy}.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  public static JSONObject toJson(Policy policy) {
<span class="fc" id="L122">    JSONObject policyJSON = new JSONObject();</span>

<span class="fc" id="L124">    Map&lt;String, Object&gt; conditions = new TreeMap&lt;String, Object&gt;();</span>
<span class="fc" id="L125">    conditions.put(DATE_LESS_THAN_KEY, new Long(policy.getValidUntil().getMillis()));</span>
<span class="fc bfc" id="L126" title="All 2 branches covered.">    if (policy.getValidFrom().isPresent()) {</span>
<span class="fc" id="L127">      conditions.put(DATE_GREATER_THAN_KEY, new Long(policy.getValidFrom().get().getMillis()));</span>
    }
<span class="fc bfc" id="L129" title="All 2 branches covered.">    if (policy.getClientIpAddress().isPresent()) {</span>
<span class="fc" id="L130">      conditions.put(IP_ADDRESS_KEY, policy.getClientIpAddress().get().getHostAddress());</span>
    }
<span class="fc" id="L132">    JSONObject conditionsJSON = new JSONObject();</span>
<span class="fc" id="L133">    conditionsJSON.putAll(conditions);</span>

<span class="fc" id="L135">    JSONObject statement = new JSONObject();</span>
<span class="fc" id="L136">    statement.put(RESOURCE_KEY, policy.getResource());</span>
<span class="fc" id="L137">    statement.put(CONDITION_KEY, conditions);</span>

<span class="fc" id="L139">    policyJSON.put(STATEMENT_KEY, statement);</span>

<span class="fc" id="L141">    return policyJSON;</span>
  }

  /**
   * Create a {@link Policy} in Json format and Base 64 encoded.
   *
   * @param encodedPolicy
   *          The String representation of the {@link Policy} in Json format and encoded into Base 64
   * @return The {@link Policy} data
   */
  public static Policy fromBase64EncodedPolicy(String encodedPolicy) {
<span class="fc" id="L152">    String decodedPolicyString = base64Decode(encodedPolicy);</span>
<span class="fc" id="L153">    return fromJson(decodedPolicyString);</span>
  }

  /**
   * Create a {@link Policy} in Json format and Base 64 encoded.
   *
   * @param policy
   *          The String representation of the {@link Policy} in Json format and encoded into Base 64
   * @return The {@link Policy} data
   */
  public static String toBase64EncodedPolicy(Policy policy) {
<span class="fc" id="L164">    return base64Encode(PolicyUtils.toJson(policy).toJSONString());</span>
  }

  /**
   * Get an encrypted version of a {@link Policy} to use as a signature.
   *
   * @param policy
   *          {@link Policy} that needs to be encrypted.
   * @param encryptionKey
   *          The key to use to encrypt the {@link Policy}.
   * @return An encrypted version of the {@link Policy} that is also Base64 encoded to make it safe to transmit as a
   *         query parameter.
   * @throws Exception
   *           Thrown if there is a problem encrypting or encoding the {@link Policy}
   */
  public static String getPolicySignature(Policy policy, String encryptionKey) throws Exception {
<span class="fc" id="L180">    return SHA256Util.digest(PolicyUtils.toJson(policy).toJSONString(), encryptionKey);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>