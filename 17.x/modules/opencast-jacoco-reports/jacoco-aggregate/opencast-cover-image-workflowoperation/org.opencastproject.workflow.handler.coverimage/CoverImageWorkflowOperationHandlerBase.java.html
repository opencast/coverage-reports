<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CoverImageWorkflowOperationHandlerBase.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-cover-image-workflowoperation</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.workflow.handler.coverimage</a> &gt; <span class="el_source">CoverImageWorkflowOperationHandlerBase.java</span></div><h1>CoverImageWorkflowOperationHandlerBase.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.workflow.handler.coverimage;

import org.opencastproject.coverimage.CoverImageException;
import org.opencastproject.coverimage.CoverImageService;
import org.opencastproject.job.api.Job;
import org.opencastproject.job.api.JobContext;
import org.opencastproject.mediapackage.Attachment;
import org.opencastproject.mediapackage.Catalog;
import org.opencastproject.mediapackage.EName;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.mediapackage.MediaPackageElementFlavor;
import org.opencastproject.mediapackage.MediaPackageElementParser;
import org.opencastproject.mediapackage.MediaPackageException;
import org.opencastproject.metadata.api.StaticMetadataService;
import org.opencastproject.metadata.dublincore.DublinCoreCatalog;
import org.opencastproject.metadata.dublincore.DublinCoreCatalogService;
import org.opencastproject.metadata.dublincore.DublinCoreUtil;
import org.opencastproject.metadata.dublincore.DublinCoreValue;
import org.opencastproject.serviceregistry.api.ServiceRegistryException;
import org.opencastproject.util.MimeTypes;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.workflow.api.AbstractWorkflowOperationHandler;
import org.opencastproject.workflow.api.ConfiguredTagsAndFlavors;
import org.opencastproject.workflow.api.WorkflowInstance;
import org.opencastproject.workflow.api.WorkflowOperationException;
import org.opencastproject.workflow.api.WorkflowOperationInstance;
import org.opencastproject.workflow.api.WorkflowOperationResult;
import org.opencastproject.workflow.api.WorkflowOperationResult.Action;
import org.opencastproject.workspace.api.Workspace;

import org.apache.commons.io.IOUtils;
import org.apache.commons.lang3.StringEscapeUtils;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.net.URI;
import java.net.URISyntaxException;
import java.net.URL;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.UUID;

/**
 * Base implementation of the cover image workflow operation handler
 */
<span class="fc" id="L73">public abstract class CoverImageWorkflowOperationHandlerBase extends AbstractWorkflowOperationHandler {</span>

  private static final String EPISODE_FLAVOR = &quot;episodeFlavor&quot;;
  private static final String SERIES_FLAVOR = &quot;seriesFlavor&quot;;
  private static final String COVERIMAGE_FILENAME = &quot;coverimage.png&quot;;
  private static final String XSL_FILE_URL = &quot;stylesheet&quot;;
  private static final String XML_METADATA = &quot;metadata&quot;;
  private static final String WIDTH = &quot;width&quot;;
  private static final String HEIGHT = &quot;height&quot;;
  private static final String POSTERIMAGE_FLAVOR = &quot;posterimage-flavor&quot;;
  private static final String POSTERIMAGE_URL = &quot;posterimage&quot;;

  /** The logging facility */
<span class="fc" id="L86">  private static final Logger logger = LoggerFactory.getLogger(CoverImageWorkflowOperationHandlerBase.class);</span>

  /** Returns a cover image service */
  protected abstract CoverImageService getCoverImageService();

  /** Returns a workspace service */
  protected abstract Workspace getWorkspace();

  /** Returns a static metadata service */
  protected abstract StaticMetadataService getStaticMetadataService();

  /** Returns a dublin core catalog service */
  protected abstract DublinCoreCatalogService getDublinCoreCatalogService();

  /** Returns value of karaf.etc */
  protected abstract String getKarafEtc();

  @Override
  public WorkflowOperationResult start(final WorkflowInstance workflowInstance, JobContext context)
          throws WorkflowOperationException {

<span class="nc" id="L107">    MediaPackage mediaPackage = workflowInstance.getMediaPackage();</span>
<span class="nc" id="L108">    WorkflowOperationInstance operation = workflowInstance.getCurrentOperation();</span>

<span class="nc" id="L110">    logger.info(&quot;Cover Image Workflow started for media package '{}'&quot;, mediaPackage.getIdentifier());</span>

    // User XML metadata from operation configuration, fallback to default metadata
<span class="nc" id="L113">    String xml = operation.getConfiguration(XML_METADATA);</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">    if (xml == null) {</span>
<span class="nc" id="L115">      xml = getMetadataXml(mediaPackage, operation);</span>
<span class="nc" id="L116">      logger.debug(&quot;Metadata was not part of operation configuration, using Dublin Core as fallback&quot;);</span>
    }
<span class="nc" id="L118">    logger.debug(&quot;Metadata set to: {}&quot;, xml);</span>

<span class="nc" id="L120">    String xsl = loadXsl(operation);</span>
<span class="nc" id="L121">    logger.debug(&quot;XSL for transforming metadata to SVG loaded: {}&quot;, xsl);</span>

    // Read image dimensions
<span class="nc" id="L124">    int width = getIntConfiguration(operation, WIDTH);</span>
<span class="nc" id="L125">    logger.debug(&quot;Image width set to {}px&quot;, width);</span>
<span class="nc" id="L126">    int height = getIntConfiguration(operation, HEIGHT);</span>
<span class="nc" id="L127">    logger.debug(&quot;Image height set to {}px&quot;, height);</span>

    // Read optional poster image flavor
<span class="nc" id="L130">    String posterImgUri = getPosterImageFileUrl(operation.getConfiguration(POSTERIMAGE_URL));</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">    if (posterImgUri == null) {</span>
<span class="nc" id="L132">      posterImgUri = getPosterImageFileUrl(mediaPackage, operation.getConfiguration(POSTERIMAGE_FLAVOR));</span>
    }
<span class="nc bnc" id="L134" title="All 2 branches missed.">    if (posterImgUri == null) {</span>
<span class="nc" id="L135">      logger.debug(&quot;No optional poster image set&quot;);</span>
    } else {
<span class="nc" id="L137">      logger.debug(&quot;Poster image found at '{}'&quot;, posterImgUri);</span>
    }

    //Get tags and flavors
<span class="nc" id="L141">    ConfiguredTagsAndFlavors tagsAndFlavors = getTagsAndFlavors(workflowInstance,</span>
        Configuration.none, Configuration.none, Configuration.many, Configuration.one);

    // Read target flavor
<span class="nc" id="L145">    MediaPackageElementFlavor targetFlavor = tagsAndFlavors.getSingleTargetFlavor();</span>

    Job generate;
    try {
<span class="nc" id="L149">      generate = getCoverImageService().generateCoverImage(xml, xsl, String.valueOf(width), String.valueOf(height),</span>
<span class="nc" id="L150">              posterImgUri, targetFlavor.toString());</span>
<span class="nc" id="L151">      logger.debug(&quot;Job for cover image generation created&quot;);</span>

<span class="nc bnc" id="L153" title="All 2 branches missed.">      if (!waitForStatus(generate).isSuccess()) {</span>
<span class="nc" id="L154">        throw new WorkflowOperationException(&quot;'Cover image' job did not successfuly end&quot;);</span>
      }

<span class="nc" id="L157">      generate = serviceRegistry.getJob(generate.getId());</span>
<span class="nc" id="L158">      Attachment coverImage = (Attachment) MediaPackageElementParser.getFromXml(generate.getPayload());</span>

<span class="nc" id="L160">      URI attachmentUri = getWorkspace().moveTo(coverImage.getURI(), mediaPackage.getIdentifier().toString(),</span>
<span class="nc" id="L161">              UUID.randomUUID().toString(), COVERIMAGE_FILENAME);</span>
<span class="nc" id="L162">      coverImage.setURI(attachmentUri);</span>

<span class="nc" id="L164">      coverImage.setMimeType(MimeTypes.PNG);</span>

      // Add tags
<span class="nc bnc" id="L167" title="All 2 branches missed.">      for (String tag : tagsAndFlavors.getTargetTags()) {</span>
<span class="nc" id="L168">        logger.trace(&quot;Tagging image with '{}'&quot;, tag);</span>
<span class="nc" id="L169">        coverImage.addTag(tag);</span>
<span class="nc" id="L170">      }</span>

<span class="nc" id="L172">      mediaPackage.add(coverImage);</span>
<span class="nc" id="L173">    } catch (MediaPackageException | NotFoundException | ServiceRegistryException | CoverImageException</span>
             | IllegalArgumentException | IOException e) {
<span class="nc" id="L175">      throw new WorkflowOperationException(e);</span>
<span class="nc" id="L176">    }</span>

<span class="nc" id="L178">    logger.info(&quot;Cover Image Workflow finished successfully for media package '{}' within {}ms&quot;,</span>
<span class="nc" id="L179">            mediaPackage.getIdentifier(), generate.getQueueTime());</span>
<span class="nc" id="L180">    return createResult(mediaPackage, Action.CONTINUE, generate.getQueueTime());</span>
  }

  protected String getPosterImageFileUrl(MediaPackage mediaPackage, String posterimageFlavor)
          throws WorkflowOperationException {

<span class="nc bnc" id="L186" title="All 2 branches missed.">    if (posterimageFlavor == null) {</span>
<span class="nc" id="L187">      logger.debug(&quot;Optional configuration key '{}' not set&quot;, POSTERIMAGE_FLAVOR);</span>
<span class="nc" id="L188">      return null;</span>
    }

    MediaPackageElementFlavor flavor;
    try {
<span class="nc" id="L193">      flavor = MediaPackageElementFlavor.parseFlavor(posterimageFlavor);</span>
<span class="nc" id="L194">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L195">      logger.warn(&quot;'{}' is not a valid flavor&quot;, posterimageFlavor);</span>
<span class="nc" id="L196">      throw new WorkflowOperationException(e);</span>
<span class="nc" id="L197">    }</span>

<span class="nc" id="L199">    Attachment[] atts = mediaPackage.getAttachments(flavor);</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">    if (atts.length &gt; 1) {</span>
<span class="nc" id="L201">      logger.warn(&quot;More than one attachment with the flavor '{}' found in media package '{}'&quot;, posterimageFlavor,</span>
<span class="nc" id="L202">              mediaPackage.getIdentifier());</span>
<span class="nc" id="L203">      throw new WorkflowOperationException(</span>
              &quot;More than one attachment with the flavor'&quot; + posterimageFlavor + &quot;' found.&quot;);
<span class="nc bnc" id="L205" title="All 2 branches missed.">    } else if (atts.length == 0) {</span>
<span class="nc" id="L206">      logger.warn(&quot;No attachment with the flavor '{}' found in media package '{}'&quot;, posterimageFlavor,</span>
<span class="nc" id="L207">              mediaPackage.getIdentifier());</span>
<span class="nc" id="L208">      return null;</span>
    }
    try {
<span class="nc" id="L211">      return getWorkspace().get(atts[0].getURI()).getAbsolutePath();</span>
<span class="nc" id="L212">    } catch (NotFoundException | IOException e) {</span>
<span class="nc" id="L213">      throw new WorkflowOperationException(e);</span>
    }
  }

  protected String getPosterImageFileUrl(String posterimageUrlOpt) {

<span class="fc bfc" id="L219" title="All 2 branches covered.">    if (StringUtils.isBlank(posterimageUrlOpt)) {</span>
<span class="fc" id="L220">      return null;</span>
    }

<span class="fc" id="L223">    URL url = null;</span>
    try {
<span class="fc" id="L225">      url = new URL(posterimageUrlOpt);</span>
<span class="fc" id="L226">    } catch (Exception e) {</span>
<span class="fc" id="L227">      logger.debug(&quot;Given poster image URI '{}' is not valid&quot;, posterimageUrlOpt);</span>
<span class="fc" id="L228">    }</span>

<span class="fc bfc" id="L230" title="All 2 branches covered.">    if (url == null) {</span>
<span class="fc" id="L231">      return null;</span>
    }

<span class="fc bfc" id="L234" title="All 2 branches covered.">    if (&quot;file&quot;.equals(url.getProtocol())) {</span>
<span class="fc" id="L235">      return url.toExternalForm();</span>
    }

    try {
<span class="fc" id="L239">      File coverImageFile = getWorkspace().get(url.toURI());</span>
<span class="fc" id="L240">      return coverImageFile.getPath();</span>
<span class="nc" id="L241">    } catch (NotFoundException e) {</span>
<span class="nc" id="L242">      logger.warn(&quot;Poster image could not be found at '{}'&quot;, url);</span>
<span class="nc" id="L243">      return null;</span>
<span class="nc" id="L244">    } catch (IOException e) {</span>
<span class="nc" id="L245">      logger.warn(&quot;Error getting poster image: {}&quot;, e.getMessage());</span>
<span class="nc" id="L246">      return null;</span>
<span class="nc" id="L247">    } catch (URISyntaxException e) {</span>
<span class="nc" id="L248">      logger.warn(&quot;Given URL '{}' is not a valid URI&quot;, url);</span>
<span class="nc" id="L249">      return null;</span>
    }
  }

  protected int getIntConfiguration(WorkflowOperationInstance operation, String key) throws WorkflowOperationException {
<span class="nc" id="L254">    String confString = operation.getConfiguration(key);</span>
<span class="nc" id="L255">    int confValue = 0;</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">    if (StringUtils.isBlank(confString)) {</span>
<span class="nc" id="L257">      throw new WorkflowOperationException(&quot;Configuration key '&quot; + key + &quot;' must be set&quot;);</span>
    }
    try {
<span class="nc" id="L260">      confValue = Integer.parseInt(confString);</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">      if (confValue &lt; 1) {</span>
<span class="nc" id="L262">        throw new WorkflowOperationException(&quot;Configuration key '&quot; + key</span>
            + &quot;' must be set to a valid positive integer value&quot;);
      }
<span class="nc" id="L265">    } catch (NumberFormatException e) {</span>
<span class="nc" id="L266">      throw new WorkflowOperationException(&quot;Configuration key '&quot; + key</span>
          + &quot;' must be set to a valid positive integer value&quot;);
<span class="nc" id="L268">    }</span>
<span class="nc" id="L269">    return confValue;</span>
  }

  protected String loadXsl(WorkflowOperationInstance operation) throws WorkflowOperationException {
<span class="nc" id="L273">    String xslUriString = operation.getConfiguration(XSL_FILE_URL);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">    if (getKarafEtc() != null) {</span>
<span class="nc" id="L275">      xslUriString = xslUriString.replace(&quot;${karaf.etc}&quot;, getKarafEtc());</span>
    }
<span class="nc bnc" id="L277" title="All 2 branches missed.">    if (StringUtils.isBlank(xslUriString)) {</span>
<span class="nc" id="L278">      throw new WorkflowOperationException(&quot;Configuration option '&quot; + XSL_FILE_URL + &quot;' must not be empty&quot;);</span>
    }
<span class="nc" id="L280">    FileReader reader = null;</span>
    try {
<span class="nc" id="L282">      URI xslUri = new URI(xslUriString);</span>
<span class="nc" id="L283">      File xslFile = new File(xslUri);</span>
<span class="nc" id="L284">      reader = new FileReader(xslFile);</span>
<span class="nc" id="L285">      return IOUtils.toString(reader);</span>
<span class="nc" id="L286">    } catch (FileNotFoundException e) {</span>
<span class="nc" id="L287">      logger.warn(&quot;There is no (xsl) file at the given uri '{}': {}&quot;, xslUriString, e.getMessage());</span>
<span class="nc" id="L288">      throw new WorkflowOperationException(&quot;There is no (XSL) file at the given URI&quot;, e);</span>
<span class="nc" id="L289">    } catch (URISyntaxException e) {</span>
<span class="nc" id="L290">      logger.warn(&quot;Given XSL file URI ({}) is not valid: {}&quot;, xslUriString, e.getMessage());</span>
<span class="nc" id="L291">      throw new WorkflowOperationException(&quot;Given XSL file URI is not valid&quot;, e);</span>
<span class="nc" id="L292">    } catch (IOException e) {</span>
<span class="nc" id="L293">      logger.warn(&quot;Error while reading XSL file ({}): {}&quot;, xslUriString, e.getMessage());</span>
<span class="nc" id="L294">      throw new WorkflowOperationException(&quot;Error while reading XSL file&quot;, e);</span>
    } finally {
<span class="nc" id="L296">      IOUtils.closeQuietly(reader);</span>
    }
  }

  protected String getMetadataXml(MediaPackage mp, WorkflowOperationInstance operation) {
    //get specified episode/series flavor
<span class="nc" id="L302">    final String configuredEpisodeFlavor =</span>
<span class="nc" id="L303">            Objects.toString(StringUtils.trimToNull(operation.getConfiguration(EPISODE_FLAVOR)),</span>
                    &quot;dublincore/episode&quot;);
<span class="nc" id="L305">    final String configuredSeriesFlavor =</span>
<span class="nc" id="L306">            Objects.toString(StringUtils.trimToNull(operation.getConfiguration(SERIES_FLAVOR)),</span>
                    &quot;dublincore/series&quot;);

<span class="nc" id="L309">    MediaPackageElementFlavor episodeFlavor = MediaPackageElementFlavor.parseFlavor(configuredEpisodeFlavor);</span>
<span class="nc" id="L310">    MediaPackageElementFlavor seriesFlavor = MediaPackageElementFlavor.parseFlavor(configuredSeriesFlavor);</span>

    //Get episode metadata-catalog
<span class="nc" id="L313">    Catalog[] catalogs =</span>
<span class="nc" id="L314">            mp.getCatalogs(new MediaPackageElementFlavor(episodeFlavor.getType(),</span>
<span class="nc" id="L315">                    StringUtils.lowerCase(episodeFlavor.getSubtype())));</span>

    //load metadata-catalog
<span class="nc" id="L318">    DublinCoreCatalog dc = DublinCoreUtil.loadDublinCore(getWorkspace(), catalogs[0]);</span>
<span class="nc" id="L319">    Map&lt;EName, List&lt;DublinCoreValue&gt;&gt; data = dc.getValues();</span>

    //build xml from metadata
<span class="nc" id="L322">    StringBuilder xml = new StringBuilder();</span>
<span class="nc" id="L323">    xml.append(&quot;&lt;metadata xmlns:dcterms=\&quot;http://purl.org/dc/terms/\&quot;&gt;&quot;);</span>

<span class="nc bnc" id="L325" title="All 2 branches missed.">    for (Map.Entry&lt;EName, List&lt;DublinCoreValue&gt;&gt; entry : data.entrySet()) {</span>
<span class="nc" id="L326">      String currentKey = entry.getKey().getLocalName();</span>
<span class="nc bnc" id="L327" title="All 6 branches missed.">      switch(currentKey) {</span>
        case &quot;creator&quot;:
<span class="nc" id="L329">          appendXml(xml, &quot;creators&quot;, getValuesAsString(entry));</span>
<span class="nc" id="L330">          break;</span>
        case &quot;isPartOf&quot;:
          //get series catalog
<span class="nc" id="L333">          Catalog[] seriesCatalogs =</span>
<span class="nc" id="L334">                  mp.getCatalogs(new MediaPackageElementFlavor(seriesFlavor.getType(), seriesFlavor.getSubtype()));</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">          if (seriesCatalogs.length == 0) {</span>
<span class="nc" id="L336">            continue;</span>
          }
<span class="nc" id="L338">          xml.append(&quot;&lt;series&gt;&quot;);</span>
          //get Series metadata
<span class="nc" id="L340">          DublinCoreCatalog dcSeries = DublinCoreUtil.loadDublinCore(getWorkspace(), seriesCatalogs[0]);</span>
<span class="nc" id="L341">          Map&lt;EName, List&lt;DublinCoreValue&gt;&gt; seriesMetadata = dcSeries.getValues();</span>
          //append series metadata
<span class="nc bnc" id="L343" title="All 2 branches missed.">          for (Map.Entry&lt;EName, List&lt;DublinCoreValue&gt;&gt; seriesEntry : seriesMetadata.entrySet()) {</span>
<span class="nc" id="L344">            String currentSeriesKey = seriesEntry.getKey().getLocalName();</span>
<span class="nc bnc" id="L345" title="All 3 branches missed.">            switch(currentSeriesKey) {</span>
              case &quot;created&quot;:
<span class="nc" id="L347">                String[] date = seriesEntry.getValue().get(0).getValue().split(&quot;\\.&quot;);</span>
<span class="nc" id="L348">                appendXml(xml, &quot;date&quot;, date[0]);</span>
<span class="nc" id="L349">                break;</span>
              case &quot;contributor&quot;:
<span class="nc" id="L351">                appendXml(xml, &quot;contributors&quot;, getValuesAsString(seriesEntry));</span>
<span class="nc" id="L352">                break;</span>
<span class="nc" id="L353">              default: String key = seriesEntry.getKey().getLocalName();</span>
<span class="nc" id="L354">                appendXml(xml, key, getValuesAsString(seriesEntry));</span>
            }
<span class="nc" id="L356">          }</span>
<span class="nc" id="L357">          xml.append(&quot;&lt;/series&gt;&quot;);</span>
<span class="nc" id="L358">          break;</span>
        case &quot;temporal&quot;:
<span class="nc" id="L360">          String[] entries = entry.getValue().get(0).getValue().split(&quot;;&quot;);</span>
<span class="nc" id="L361">          entries[0] = entries[0].trim().substring(6);</span>
<span class="nc" id="L362">          entries[1] = entries[1].trim().substring(4);</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">          if (entries[0] != null) {</span>
<span class="nc" id="L364">            appendXml(xml, &quot;start&quot;, entries[0]);</span>
          }
<span class="nc bnc" id="L366" title="All 2 branches missed.">          if (entries[1] != null) {</span>
<span class="nc" id="L367">            appendXml(xml, &quot;end&quot;, entries[1]);</span>
          }
          break;
        case &quot;created&quot;:
<span class="nc" id="L371">          String[] date = entry.getValue().get(0).getValue().split(&quot;\\.&quot;);</span>
<span class="nc" id="L372">          appendXml(xml, &quot;date&quot;, date[0]);</span>
<span class="nc" id="L373">          break;</span>
        case &quot;contributor&quot;:
<span class="nc" id="L375">          appendXml(xml, &quot;contributors&quot;, getValuesAsString(entry));</span>
<span class="nc" id="L376">          break;</span>
<span class="nc" id="L377">        default: appendXml(xml, entry.getKey().getLocalName(), getValuesAsString(entry));</span>
      }
<span class="nc" id="L379">    }</span>

<span class="nc" id="L381">    xml.append(&quot;&lt;/metadata&gt;&quot;);</span>
<span class="nc" id="L382">    return xml.toString();</span>
  }

  protected String getValuesAsString(Map.Entry&lt;EName, List&lt;DublinCoreValue&gt;&gt; entry) {
<span class="nc" id="L386">    List&lt;DublinCoreValue&gt; values = entry.getValue();</span>
<span class="nc" id="L387">    String stringValues = &quot;&quot;;</span>
    try {
<span class="nc" id="L389">      stringValues += values.get(0).getValue();</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">      for (int i = 1; i &lt; values.size(); i++) {</span>
<span class="nc" id="L391">        stringValues += &quot;, &quot; + values.get(i).getValue();</span>
      }
<span class="nc" id="L393">    } catch (IndexOutOfBoundsException e) {</span>
<span class="nc" id="L394">      logger.warn(&quot;Given Key '{}' has no Entries : {}&quot;, entry.getKey(), e.getMessage());</span>
<span class="nc" id="L395">    }</span>
<span class="nc" id="L396">    return stringValues;</span>
  }

  protected void appendXml(StringBuilder xml, String name, String body) {
<span class="pc bpc" id="L400" title="2 of 4 branches missed.">    if (StringUtils.isBlank(body) || StringUtils.isBlank(name)) {</span>
<span class="nc" id="L401">      return;</span>
    }

<span class="fc" id="L404">    xml.append(&quot;&lt;&quot;);</span>
<span class="fc" id="L405">    xml.append(name);</span>
<span class="fc" id="L406">    xml.append(&quot;&gt;&quot;);</span>

<span class="fc" id="L408">    xml.append(StringEscapeUtils.escapeXml(body));</span>

<span class="fc" id="L410">    xml.append(&quot;&lt;/&quot;);</span>
<span class="fc" id="L411">    xml.append(name);</span>
<span class="fc" id="L412">    xml.append(&quot;&gt;&quot;);</span>
<span class="fc" id="L413">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>