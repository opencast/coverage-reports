<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ConfigurablePublicationServiceImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-publication-service-configurable</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.publication.configurable</a> &gt; <span class="el_source">ConfigurablePublicationServiceImpl.java</span></div><h1>ConfigurablePublicationServiceImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.publication.configurable;

import org.opencastproject.distribution.api.DistributionException;
import org.opencastproject.distribution.api.DownloadDistributionService;
import org.opencastproject.job.api.AbstractJobProducer;
import org.opencastproject.job.api.Job;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.mediapackage.MediaPackageElement;
import org.opencastproject.mediapackage.MediaPackageElementParser;
import org.opencastproject.mediapackage.MediaPackageException;
import org.opencastproject.mediapackage.MediaPackageParser;
import org.opencastproject.mediapackage.Publication;
import org.opencastproject.mediapackage.PublicationImpl;
import org.opencastproject.publication.api.ConfigurablePublicationService;
import org.opencastproject.publication.api.PublicationException;
import org.opencastproject.security.api.OrganizationDirectoryService;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.UserDirectoryService;
import org.opencastproject.serviceregistry.api.ServiceRegistry;
import org.opencastproject.serviceregistry.api.ServiceRegistryException;
import org.opencastproject.util.JobUtil;

import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;

import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;

import java.util.Arrays;
import java.util.Collection;
import java.util.HashSet;
import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.UUID;

@Component(
    immediate = true,
    service = ConfigurablePublicationService.class,
    property = {
        &quot;service.description=Publication Service (Configurable)&quot;
    }
)
public class ConfigurablePublicationServiceImpl extends AbstractJobProducer implements ConfigurablePublicationService {

  /* Gson is thread-safe so we use a single instance */
<span class="nc" id="L68">  private Gson gson = new Gson();</span>

  @Override
  public void activate(ComponentContext cc) {
<span class="nc" id="L72">    super.activate(cc);</span>
<span class="nc" id="L73">  }</span>

  public ConfigurablePublicationServiceImpl() {
<span class="nc" id="L76">    super(JOB_TYPE);</span>
<span class="nc" id="L77">  }</span>

  @Override
  public String getJobType() {
<span class="nc" id="L81">    return super.getJobType();</span>
  }

<span class="nc" id="L84">  public enum Operation {</span>
<span class="nc" id="L85">    Replace</span>
  }

  private DownloadDistributionService distributionService;

  private SecurityService securityService;

  private UserDirectoryService userDirectoryService;

  private OrganizationDirectoryService organizationDirectoryService;

  private ServiceRegistry serviceRegistry;

  @Override
  public Job replace(final MediaPackage mediaPackage, final String channelId,
          final Collection&lt;? extends MediaPackageElement&gt; addElements, final Set&lt;String&gt; retractElementIds)
          throws PublicationException, MediaPackageException {
    try {
<span class="nc" id="L103">      return serviceRegistry.createJob(JOB_TYPE, Operation.Replace.toString(),</span>
<span class="nc" id="L104">              Arrays.asList(MediaPackageParser.getAsXml(mediaPackage), channelId,</span>
<span class="nc" id="L105">                      MediaPackageElementParser.getArrayAsXml(addElements), gson.toJson(retractElementIds)));</span>
<span class="nc" id="L106">    } catch (final ServiceRegistryException e) {</span>
<span class="nc" id="L107">      throw new PublicationException(&quot;Unable to create job&quot;, e);</span>
    }
  }

  @Override
  public Publication replaceSync(
      MediaPackage mediaPackage, String channelId, Collection&lt;? extends MediaPackageElement&gt; addElements,
      Set&lt;String&gt; retractElementIds) throws PublicationException, MediaPackageException {
    try {
<span class="nc" id="L116">      return doReplaceSync(mediaPackage, channelId, addElements, retractElementIds);</span>
<span class="nc" id="L117">    } catch (DistributionException e) {</span>
<span class="nc" id="L118">      throw new PublicationException(e);</span>
    }
  }

  @Override
  protected String process(final Job job) throws Exception {
<span class="nc" id="L124">    final List&lt;String&gt; arguments = job.getArguments();</span>
<span class="nc" id="L125">    final MediaPackage mediaPackage = MediaPackageParser.getFromXml(arguments.get(0));</span>
<span class="nc" id="L126">    final String channelId = arguments.get(1);</span>
<span class="nc" id="L127">    final Collection&lt;? extends MediaPackageElement&gt; addElements = MediaPackageElementParser</span>
<span class="nc" id="L128">            .getArrayFromXml(arguments.get(2));</span>
<span class="nc" id="L129">    Set&lt;String&gt; retractElementIds = gson.fromJson(arguments.get(3), new TypeToken&lt;Set&lt;String&gt;&gt;() { }.getType());</span>

<span class="nc" id="L131">    Publication result = null;</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">    switch (Operation.valueOf(job.getOperation())) {</span>
      case Replace:
<span class="nc" id="L134">        result = doReplace(mediaPackage, channelId, addElements, retractElementIds);</span>
<span class="nc" id="L135">        break;</span>
      default:
        break;
    }
<span class="nc bnc" id="L139" title="All 2 branches missed.">    if (result != null) {</span>
<span class="nc" id="L140">      return MediaPackageElementParser.getAsXml(result);</span>
    } else {
<span class="nc" id="L142">      return null;</span>
    }
  }

  private void distributeMany(final MediaPackage mp, final String channelId,
          final Collection&lt;? extends MediaPackageElement&gt; elements)
          throws DistributionException, MediaPackageException {

<span class="nc" id="L150">    final Optional&lt;Publication&gt; publicationOpt = getPublication(mp, channelId);</span>

<span class="nc bnc" id="L152" title="All 2 branches missed.">    if (publicationOpt.isPresent()) {</span>

<span class="nc" id="L154">      final Publication publication = publicationOpt.get();</span>

      // Add all the elements top-level so the distribution service knows what to do
<span class="nc" id="L157">      elements.forEach(mp::add);</span>

<span class="nc" id="L159">      Set&lt;String&gt; elementIds = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">      for (final MediaPackageElement mpe : elements) {</span>
<span class="nc" id="L161">        elementIds.add(mpe.getIdentifier());</span>
<span class="nc" id="L162">      }</span>

      try {
<span class="nc" id="L165">        Job job = distributionService.distribute(channelId, mp, elementIds, false);</span>

<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (!JobUtil.waitForJob(serviceRegistry, job).isSuccess()) {</span>
<span class="nc" id="L168">          throw new DistributionException(&quot;At least one of the publication jobs did not complete successfully&quot;);</span>
        }
<span class="nc" id="L170">        List&lt;? extends MediaPackageElement&gt; distributedElements</span>
<span class="nc" id="L171">            = MediaPackageElementParser.getArrayFromXml(job.getPayload());</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">        for (MediaPackageElement mpe : distributedElements) {</span>
<span class="nc" id="L173">          PublicationImpl.addElementToPublication(publication, mpe);</span>
<span class="nc" id="L174">        }</span>
      } finally {
        // Remove our changes
<span class="nc" id="L177">        elements.stream().map(MediaPackageElement::getIdentifier).forEach(mp::removeElementById);</span>
      }
    }
<span class="nc" id="L180">  }</span>

  private void distributeManySync(final MediaPackage mp, final String channelId,
          final Collection&lt;? extends MediaPackageElement&gt; elements) throws DistributionException {

<span class="nc" id="L185">    final Optional&lt;Publication&gt; publicationOpt = getPublication(mp, channelId);</span>

<span class="nc bnc" id="L187" title="All 2 branches missed.">    if (publicationOpt.isPresent()) {</span>

<span class="nc" id="L189">      final Publication publication = publicationOpt.get();</span>

      // Add all the elements top-level so the distribution service knows what to do
<span class="nc" id="L192">      elements.forEach(mp::add);</span>

<span class="nc" id="L194">      Set&lt;String&gt; elementIds = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">      for (final MediaPackageElement mpe : elements) {</span>
<span class="nc" id="L196">        elementIds.add(mpe.getIdentifier());</span>
<span class="nc" id="L197">      }</span>

      try {
<span class="nc" id="L200">        List&lt;? extends MediaPackageElement&gt; distributedElements = distributionService.distributeSync(channelId, mp,</span>
            elementIds, false);
<span class="nc bnc" id="L202" title="All 2 branches missed.">        for (MediaPackageElement mpe : distributedElements) {</span>
<span class="nc" id="L203">          PublicationImpl.addElementToPublication(publication, mpe);</span>
<span class="nc" id="L204">        }</span>
      } finally {
        // Remove our changes
<span class="nc" id="L207">        elements.stream().map(MediaPackageElement::getIdentifier).forEach(mp::removeElementById);</span>
      }
    }
<span class="nc" id="L210">  }</span>

  private Publication doReplace(final MediaPackage mp, final String channelId,
          final Collection&lt;? extends MediaPackageElement&gt; addElementIds, final Set&lt;String&gt; retractElementIds)
          throws DistributionException, MediaPackageException {
    // Retract old elements
<span class="nc" id="L216">    final Job retractJob = distributionService.retract(channelId, mp, retractElementIds);</span>

<span class="nc bnc" id="L218" title="All 2 branches missed.">    if (!JobUtil.waitForJobs(serviceRegistry, retractJob).isSuccess()) {</span>
<span class="nc" id="L219">      throw new DistributionException(&quot;At least one of the retraction jobs did not complete successfully&quot;);</span>
    }

<span class="nc" id="L222">    final Optional&lt;Publication&gt; priorPublication = getPublication(mp, channelId);</span>

    final Publication publication;

<span class="nc bnc" id="L226" title="All 2 branches missed.">    if (priorPublication.isPresent()) {</span>
<span class="nc" id="L227">      publication = priorPublication.get();</span>
    } else {
<span class="nc" id="L229">      final String publicationUUID = UUID.randomUUID().toString();</span>
<span class="nc" id="L230">      publication = PublicationImpl.publication(publicationUUID, channelId, null, null);</span>
<span class="nc" id="L231">      mp.add(publication);</span>
    }

<span class="nc" id="L234">    retractElementIds.forEach(publication::removeAttachmentById);</span>

<span class="nc" id="L236">    distributeMany(mp, channelId, addElementIds);</span>

<span class="nc" id="L238">    return publication;</span>
  }

  private Publication doReplaceSync(final MediaPackage mp, final String channelId,
          final Collection&lt;? extends MediaPackageElement&gt; addElementIds, final Set&lt;String&gt; retractElementIds)
          throws DistributionException {
    // Retract old elements
<span class="nc" id="L245">    distributionService.retractSync(channelId, mp, retractElementIds);</span>

<span class="nc" id="L247">    final Optional&lt;Publication&gt; priorPublication = getPublication(mp, channelId);</span>

    final Publication publication;

<span class="nc bnc" id="L251" title="All 2 branches missed.">    if (priorPublication.isPresent()) {</span>
<span class="nc" id="L252">      publication = priorPublication.get();</span>
    } else {
<span class="nc" id="L254">      final String publicationUUID = UUID.randomUUID().toString();</span>
<span class="nc" id="L255">      publication = PublicationImpl.publication(publicationUUID, channelId, null, null);</span>
<span class="nc" id="L256">      mp.add(publication);</span>
    }

<span class="nc" id="L259">    retractElementIds.forEach(publication::removeAttachmentById);</span>

<span class="nc" id="L261">    distributeManySync(mp, channelId, addElementIds);</span>

<span class="nc" id="L263">    return publication;</span>
  }

  private Optional&lt;Publication&gt; getPublication(final MediaPackage mp, final String channelId) {
<span class="nc" id="L267">    return Arrays.stream(mp.getPublications()).filter(p -&gt; p.getChannel().equalsIgnoreCase(channelId)).findAny();</span>
  }

  @Override
  protected ServiceRegistry getServiceRegistry() {
<span class="nc" id="L272">    return this.serviceRegistry;</span>
  }

  @Override
  protected SecurityService getSecurityService() {
<span class="nc" id="L277">    return this.securityService;</span>
  }

  @Override
  protected UserDirectoryService getUserDirectoryService() {
<span class="nc" id="L282">    return this.userDirectoryService;</span>
  }

  @Override
  protected OrganizationDirectoryService getOrganizationDirectoryService() {
<span class="nc" id="L287">    return this.organizationDirectoryService;</span>
  }

  @Reference
  public void setServiceRegistry(ServiceRegistry serviceRegistry) {
<span class="nc" id="L292">    this.serviceRegistry = serviceRegistry;</span>
<span class="nc" id="L293">  }</span>

  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="nc" id="L297">    this.serviceRegistry = serviceRegistry;</span>
<span class="nc" id="L298">  }</span>

  @Reference
  public void setUserDirectoryService(UserDirectoryService userDirectoryService) {
<span class="nc" id="L302">    this.userDirectoryService = userDirectoryService;</span>
<span class="nc" id="L303">  }</span>

  @Reference
  public void setOrganizationDirectoryService(OrganizationDirectoryService organizationDirectoryService) {
<span class="nc" id="L307">    this.organizationDirectoryService = organizationDirectoryService;</span>
<span class="nc" id="L308">  }</span>

  @Reference(target = &quot;(distribution.channel=download)&quot;)
  public void setDownloadDistributionService(DownloadDistributionService downloadDistributionService) {
<span class="nc" id="L312">    this.distributionService = downloadDistributionService;</span>
<span class="nc" id="L313">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>