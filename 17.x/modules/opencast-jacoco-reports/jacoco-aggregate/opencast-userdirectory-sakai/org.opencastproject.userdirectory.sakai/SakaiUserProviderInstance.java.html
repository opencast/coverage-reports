<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SakaiUserProviderInstance.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-userdirectory-sakai</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.userdirectory.sakai</a> &gt; <span class="el_source">SakaiUserProviderInstance.java</span></div><h1>SakaiUserProviderInstance.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.userdirectory.sakai;

import org.opencastproject.security.api.CachingUserProviderMXBean;
import org.opencastproject.security.api.Group;
import org.opencastproject.security.api.JaxbOrganization;
import org.opencastproject.security.api.JaxbRole;
import org.opencastproject.security.api.JaxbUser;
import org.opencastproject.security.api.Organization;
import org.opencastproject.security.api.Role;
import org.opencastproject.security.api.RoleProvider;
import org.opencastproject.security.api.User;
import org.opencastproject.security.api.UserProvider;
import org.opencastproject.util.XmlSafeParser;

import com.google.common.cache.CacheBuilder;
import com.google.common.cache.CacheLoader;
import com.google.common.cache.LoadingCache;
import com.google.common.util.concurrent.ExecutionError;
import com.google.common.util.concurrent.UncheckedExecutionException;

import org.apache.commons.codec.binary.Base64;
import org.apache.commons.io.IOUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;

import java.io.BufferedInputStream;
import java.io.FileNotFoundException;
import java.io.StringReader;
import java.lang.management.ManagementFactory;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.List;
import java.util.Set;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.AtomicLong;
import java.util.regex.PatternSyntaxException;

import javax.management.InstanceNotFoundException;
import javax.management.MBeanServer;
import javax.management.ObjectName;
import javax.xml.parsers.DocumentBuilder;

/**
 * A UserProvider that reads user roles from Sakai.
 */
public class SakaiUserProviderInstance implements UserProvider, RoleProvider, CachingUserProviderMXBean {

  private static final String LTI_LEARNER_ROLE = &quot;Learner&quot;;

  private static final String LTI_INSTRUCTOR_ROLE = &quot;Instructor&quot;;

  public static final String PROVIDER_NAME = &quot;sakai&quot;;

  private static final String OC_USERAGENT = &quot;Opencast&quot;;

  /** The logger */
<span class="nc" id="L88">  private static final Logger logger = LoggerFactory.getLogger(SakaiUserProviderInstance.class);</span>

  /** The organization */
<span class="nc" id="L91">  private Organization organization = null;</span>

  /** Total number of requests made to load users */
<span class="nc" id="L94">  private AtomicLong requests = null;</span>

  /** The number of requests made to Sakai */
<span class="nc" id="L97">  private AtomicLong sakaiLoads = null;</span>

  /** A cache of users, which lightens the load on Sakai */
<span class="nc" id="L100">  private LoadingCache&lt;String, Object&gt; cache = null;</span>

  /** A token to store in the miss cache */
<span class="nc" id="L103">  protected Object nullToken = new Object();</span>

  /** The URL of the Sakai instance */
<span class="nc" id="L106">  private String sakaiUrl = null;</span>

  /** The username used to call Sakai REST webservices */
<span class="nc" id="L109">  private String sakaiUsername = null;</span>

  /** The password of the user used to call Sakai REST webservices */
<span class="nc" id="L112">  private String sakaiPassword = null;</span>

  /** Regular expression for matching valid sites */
  private String sitePattern;

  /** Regular expression for matching valid users */
  private String userPattern;

  /** A map of roles which are regarded as Instructor roles */
  private Set&lt;String&gt; instructorRoles;

  /**
   * Constructs an Sakai user provider with the needed settings.
   *
   * @param pid
   *          the pid of this service
   * @param organization
   *          the organization
   * @param url
   *          the url of the Sakai server
   * @param userName
   *          the user to authenticate as
   * @param password
   *          the user credentials
   * @param cacheSize
   *          the number of users to cache
   * @param cacheExpiration
   *          the number of minutes to cache users
   */
  public SakaiUserProviderInstance(
      String pid,
      Organization organization,
      String url,
      String userName,
      String password,
      String sitePattern,
      String userPattern,
      Set&lt;String&gt; instructorRoles,
      int cacheSize,
      int cacheExpiration
<span class="nc" id="L152">  ) {</span>

<span class="nc" id="L154">    this.organization = organization;</span>
<span class="nc" id="L155">    this.sakaiUrl = url;</span>
<span class="nc" id="L156">    this.sakaiUsername = userName;</span>
<span class="nc" id="L157">    this.sakaiPassword = password;</span>
<span class="nc" id="L158">    this.sitePattern = sitePattern;</span>
<span class="nc" id="L159">    this.userPattern = userPattern;</span>
<span class="nc" id="L160">    this.instructorRoles = instructorRoles;</span>

<span class="nc" id="L162">    logger.info(&quot;Creating new SakaiUserProviderInstance(pid={}, url={}, cacheSize={}, cacheExpiration={})&quot;,</span>
<span class="nc" id="L163">                 pid, url, cacheSize, cacheExpiration);</span>

    // Setup the caches
<span class="nc" id="L166">    cache = CacheBuilder.newBuilder().maximumSize(cacheSize).expireAfterWrite(cacheExpiration, TimeUnit.MINUTES)</span>
<span class="nc" id="L167">        .build(new CacheLoader&lt;String, Object&gt;() {</span>
          @Override
          public Object load(String id) throws Exception {
<span class="nc" id="L170">            User user = loadUserFromSakai(id);</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">            return user == null ? nullToken : user;</span>
          }
        });

<span class="nc" id="L175">    registerMBean(pid);</span>
<span class="nc" id="L176">  }</span>

  @Override
  public String getName() {
<span class="nc" id="L180">    return PROVIDER_NAME;</span>
  }

  /**
   * Registers an MXBean.
   */
  protected void registerMBean(String pid) {
    // register with jmx
<span class="nc" id="L188">    requests = new AtomicLong();</span>
<span class="nc" id="L189">    sakaiLoads = new AtomicLong();</span>
    try {
      ObjectName name;
<span class="nc" id="L192">      name = SakaiUserProviderFactory.getObjectName(pid);</span>
<span class="nc" id="L193">      Object mbean = this;</span>
<span class="nc" id="L194">      MBeanServer mbs = ManagementFactory.getPlatformMBeanServer();</span>
      try {
<span class="nc" id="L196">        mbs.unregisterMBean(name);</span>
<span class="nc" id="L197">      } catch (InstanceNotFoundException e) {</span>
<span class="nc" id="L198">        logger.debug(name + &quot; was not registered&quot;);</span>
<span class="nc" id="L199">      }</span>
<span class="nc" id="L200">      mbs.registerMBean(mbean, name);</span>
<span class="nc" id="L201">    } catch (Exception e) {</span>
<span class="nc" id="L202">      logger.error(&quot;Unable to register {} as an mbean&quot;, this, e);</span>
<span class="nc" id="L203">    }</span>
<span class="nc" id="L204">  }</span>

  // UserProvider methods

  /**
   * {@inheritDoc}
   * 
   * @see org.opencastproject.security.api.UserProvider#getOrganization()
   */
  @Override
  public String getOrganization() {
<span class="nc" id="L215">    return organization.getId();</span>
  }

  /**
   * {@inheritDoc}
   * 
   * @see org.opencastproject.security.api.UserProvider#loadUser(java.lang.String)
   */
  @Override
  public User loadUser(String userName) {
<span class="nc" id="L225">    logger.debug(&quot;loaduser(&quot; + userName + &quot;)&quot;);</span>

    try {
<span class="nc bnc" id="L228" title="All 4 branches missed.">      if ((userPattern != null) &amp;&amp; !userName.matches(userPattern)) {</span>
<span class="nc" id="L229">        logger.debug(&quot;load user {} failed regexp {}&quot;, userName, userPattern);</span>
<span class="nc" id="L230">        return null;</span>
      }
<span class="nc" id="L232">    } catch (PatternSyntaxException e) {</span>
<span class="nc" id="L233">      logger.warn(&quot;Invalid regular expression for user pattern {} - disabling checks&quot;, userPattern);</span>
<span class="nc" id="L234">      userPattern = null;</span>
<span class="nc" id="L235">    }</span>

<span class="nc" id="L237">    requests.incrementAndGet();</span>
    try {
<span class="nc" id="L239">      Object user = cache.getUnchecked(userName);</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">      if (user == nullToken) {</span>
<span class="nc" id="L241">        logger.debug(&quot;Returning null user from cache&quot;);</span>
<span class="nc" id="L242">        return null;</span>
      } else {
<span class="nc" id="L244">        logger.debug(&quot;Returning user &quot; + userName + &quot; from cache&quot;);</span>
<span class="nc" id="L245">        return (JaxbUser) user;</span>
      }
<span class="nc" id="L247">    } catch (ExecutionError e) {</span>
<span class="nc" id="L248">      logger.warn(&quot;Exception while loading user {}&quot;, userName, e);</span>
<span class="nc" id="L249">      return null;</span>
<span class="nc" id="L250">    } catch (UncheckedExecutionException e) {</span>
<span class="nc" id="L251">      logger.warn(&quot;Exception while loading user {}&quot;, userName, e);</span>
<span class="nc" id="L252">      return null;</span>
    }
  }

  /**
   * Loads a user from Sakai.
   * 
   * @param userName
   *          the username
   * @return the user
   */
  protected User loadUserFromSakai(String userName) {

<span class="nc bnc" id="L265" title="All 2 branches missed.">    if (cache == null) {</span>
<span class="nc" id="L266">      throw new IllegalStateException(&quot;The Sakai user detail service has not yet been configured&quot;);</span>
    }

    // Don't answer for admin, anonymous or empty user
<span class="nc bnc" id="L270" title="All 6 branches missed.">    if (&quot;admin&quot;.equals(userName) || &quot;&quot;.equals(userName) || &quot;anonymous&quot;.equals(userName)) {</span>
<span class="nc" id="L271">      cache.put(userName, nullToken);</span>
<span class="nc" id="L272">      logger.debug(&quot;we don't answer for: &quot; + userName);</span>
<span class="nc" id="L273">      return null;</span>
    }

<span class="nc" id="L276">    logger.debug(&quot;In loadUserFromSakai, currently processing user : {}&quot;, userName);</span>

<span class="nc" id="L278">    JaxbOrganization jaxbOrganization = JaxbOrganization.fromOrganization(organization);</span>

    // update cache statistics
<span class="nc" id="L281">    sakaiLoads.incrementAndGet();</span>

<span class="nc" id="L283">    Thread currentThread = Thread.currentThread();</span>
<span class="nc" id="L284">    ClassLoader originalClassloader = currentThread.getContextClassLoader();</span>
    try {

      // Sakai userId (internal id), email address and display name
<span class="nc" id="L288">      String[] sakaiUser = getSakaiUser(userName);</span>

<span class="nc bnc" id="L290" title="All 2 branches missed.">      if (sakaiUser == null) {</span>
        // user not known to this provider
<span class="nc" id="L292">        logger.debug(&quot;User {} not found in Sakai system&quot;, userName);</span>
<span class="nc" id="L293">        cache.put(userName, nullToken);</span>
<span class="nc" id="L294">        return null;</span>
      }

<span class="nc" id="L297">      String userId = sakaiUser[0];</span>
<span class="nc" id="L298">      String email = sakaiUser[1];</span>
<span class="nc" id="L299">      String displayName = sakaiUser[2];</span>

      // Get the set of Sakai roles for the user
<span class="nc" id="L302">      String[] sakaiRoles = getRolesFromSakai(userId);</span>

      // if Sakai doesn't know about this user we need to return
<span class="nc bnc" id="L305" title="All 2 branches missed.">      if (sakaiRoles == null) {</span>
<span class="nc" id="L306">        cache.put(userName, nullToken);</span>
<span class="nc" id="L307">        return null;</span>
      }

<span class="nc" id="L310">      logger.debug(&quot;Sakai roles for eid &quot; + userName + &quot; id &quot; + userId + &quot;: &quot; + Arrays.toString(sakaiRoles));</span>

<span class="nc" id="L312">      Set&lt;JaxbRole&gt; roles = new HashSet&lt;JaxbRole&gt;();</span>

<span class="nc" id="L314">      boolean isInstructor = false;</span>

<span class="nc bnc" id="L316" title="All 2 branches missed.">      for (String r : sakaiRoles) {</span>
<span class="nc" id="L317">        roles.add(new JaxbRole(r, jaxbOrganization, &quot;Sakai external role&quot;, Role.Type.EXTERNAL));</span>

<span class="nc bnc" id="L319" title="All 2 branches missed.">        if (r.endsWith(LTI_INSTRUCTOR_ROLE)) {</span>
<span class="nc" id="L320">          isInstructor = true;</span>
        }
      }

      // Group role for all Sakai users
<span class="nc" id="L325">      roles.add(new JaxbRole(Group.ROLE_PREFIX + &quot;SAKAI&quot;, jaxbOrganization, &quot;Sakai Users&quot;, Role.Type.EXTERNAL_GROUP));</span>

      // Group role for Sakai users who are an instructor in one more sites
<span class="nc bnc" id="L328" title="All 2 branches missed.">      if (isInstructor) {</span>
<span class="nc" id="L329">        roles.add(new JaxbRole(</span>
            Group.ROLE_PREFIX + &quot;SAKAI_INSTRUCTOR&quot;,
            jaxbOrganization,
            &quot;Sakai Instructors&quot;,
            Role.Type.EXTERNAL_GROUP
        ));
      }

<span class="nc" id="L337">      logger.debug(&quot;Returning JaxbRoles: &quot; + roles);</span>

<span class="nc" id="L339">      User user = new JaxbUser(userName, null, displayName, email, PROVIDER_NAME, jaxbOrganization, roles);</span>

<span class="nc" id="L341">      cache.put(userName, user);</span>
<span class="nc" id="L342">      logger.debug(&quot;Returning user {}&quot;, userName);</span>

<span class="nc" id="L344">      return user;</span>

    } finally {
<span class="nc" id="L347">      currentThread.setContextClassLoader(originalClassloader);</span>
    }

  }

  /*
   ** Verify that the user exists
   ** Query with /direct/user/:ID:/exists
   */
  private boolean verifySakaiUser(String userId) {

<span class="nc" id="L358">    logger.debug(&quot;verifySakaiUser({})&quot;, userId);</span>

    try {
<span class="nc bnc" id="L361" title="All 4 branches missed.">      if ((userPattern != null) &amp;&amp; !userId.matches(userPattern)) {</span>
<span class="nc" id="L362">        logger.debug(&quot;verify user {} failed regexp {}&quot;, userId, userPattern);</span>
<span class="nc" id="L363">        return false;</span>
      }
<span class="nc" id="L365">    } catch (PatternSyntaxException e) {</span>
<span class="nc" id="L366">      logger.warn(&quot;Invalid regular expression for user pattern {} - disabling checks&quot;, userPattern);</span>
<span class="nc" id="L367">      userPattern = null;</span>
<span class="nc" id="L368">    }</span>

    int code;

    try {
      // This webservice does not require authentication
<span class="nc" id="L374">      URL url = new URL(sakaiUrl + &quot;/direct/user/&quot; + userId + &quot;/exists&quot;);</span>

<span class="nc" id="L376">      HttpURLConnection connection = (HttpURLConnection) url.openConnection();</span>
<span class="nc" id="L377">      connection.setRequestMethod(&quot;GET&quot;);</span>
<span class="nc" id="L378">      connection.setRequestProperty(&quot;User-Agent&quot;, OC_USERAGENT);</span>

<span class="nc" id="L380">      connection.connect();</span>
<span class="nc" id="L381">      code = connection.getResponseCode();</span>
<span class="nc" id="L382">    } catch (Exception e) {</span>
<span class="nc" id="L383">      logger.warn(&quot;Exception verifying Sakai user &quot; + userId + &quot; at &quot; + sakaiUrl + &quot;: &quot; + e.getMessage());</span>
<span class="nc" id="L384">      return false;</span>
<span class="nc" id="L385">    }</span>

    // HTTP OK 200 for site exists, return false for everything else (typically 404 not found)
<span class="nc bnc" id="L388" title="All 2 branches missed.">    return (code == 200);</span>
  }

  /*
   ** Verify that the site exists
   ** Query with /direct/site/:ID:/exists
   */
  private boolean verifySakaiSite(String siteId) {

    // We could additionally cache positive and negative siteId lookup results here

<span class="nc" id="L399">    logger.debug(&quot;verifySakaiSite(&quot; + siteId + &quot;)&quot;);</span>

    try {
<span class="nc bnc" id="L402" title="All 4 branches missed.">      if ((sitePattern != null) &amp;&amp; !siteId.matches(sitePattern)) {</span>
<span class="nc" id="L403">        logger.debug(&quot;verify site {} failed regexp {}&quot;, siteId, sitePattern);</span>
<span class="nc" id="L404">        return false;</span>
      }
<span class="nc" id="L406">    } catch (PatternSyntaxException e) {</span>
<span class="nc" id="L407">      logger.warn(&quot;Invalid regular expression for site pattern {} - disabling checks&quot;, sitePattern);</span>
<span class="nc" id="L408">      sitePattern = null;</span>
<span class="nc" id="L409">    }</span>

    int code;

    try {
      // This webservice does not require authentication
<span class="nc" id="L415">      URL url = new URL(sakaiUrl + &quot;/direct/site/&quot; + siteId + &quot;/exists&quot;);</span>

<span class="nc" id="L417">      HttpURLConnection connection = (HttpURLConnection) url.openConnection();</span>
<span class="nc" id="L418">      connection.setRequestMethod(&quot;GET&quot;);</span>
<span class="nc" id="L419">      connection.setRequestProperty(&quot;User-Agent&quot;, OC_USERAGENT);</span>

<span class="nc" id="L421">      connection.connect();</span>
<span class="nc" id="L422">      code = connection.getResponseCode();</span>
<span class="nc" id="L423">    } catch (Exception e) {</span>
<span class="nc" id="L424">      logger.warn(&quot;Exception verifying Sakai site &quot; + siteId + &quot; at &quot; + sakaiUrl + &quot;: &quot; + e.getMessage());</span>
<span class="nc" id="L425">      return false;</span>
<span class="nc" id="L426">    }</span>

    // HTTP OK 200 for site exists, return false for everything else (typically 404 not found)
<span class="nc bnc" id="L429" title="All 2 branches missed.">    return (code == 200);</span>
  }

  private String[] getRolesFromSakai(String userId) {
<span class="nc" id="L433">    logger.debug(&quot;getRolesFromSakai(&quot; + userId + &quot;)&quot;);</span>
    try {

<span class="nc" id="L436">      URL url = new URL(sakaiUrl + &quot;/direct/membership/fastroles/&quot; + userId + &quot;.xml&quot; + &quot;?__auth=basic&quot;);</span>
<span class="nc" id="L437">      String encoded = Base64.encodeBase64String((sakaiUsername + &quot;:&quot; + sakaiPassword).getBytes(&quot;utf8&quot;));</span>

<span class="nc" id="L439">      HttpURLConnection connection = (HttpURLConnection) url.openConnection();</span>
<span class="nc" id="L440">      connection.setRequestMethod(&quot;GET&quot;);</span>
<span class="nc" id="L441">      connection.setDoOutput(true);</span>
<span class="nc" id="L442">      connection.setRequestProperty(&quot;Authorization&quot;, &quot;Basic &quot; + encoded);</span>
<span class="nc" id="L443">      connection.setRequestProperty(&quot;User-Agent&quot;, OC_USERAGENT);</span>

<span class="nc" id="L445">      String xml = IOUtils.toString(new BufferedInputStream(connection.getInputStream()));</span>
<span class="nc" id="L446">      logger.debug(xml);</span>

<span class="nc" id="L448">      DocumentBuilder parser = XmlSafeParser.newDocumentBuilderFactory().newDocumentBuilder();</span>

<span class="nc" id="L450">      Document document = parser.parse(new org.xml.sax.InputSource(new StringReader(xml)));</span>

<span class="nc" id="L452">      Element root = document.getDocumentElement();</span>
<span class="nc" id="L453">      NodeList nodes = root.getElementsByTagName(&quot;membership&quot;);</span>
<span class="nc" id="L454">      List&lt;String&gt; roleList = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">      for (int i = 0; i &lt; nodes.getLength(); i++) {</span>
<span class="nc" id="L456">        Element element = (Element) nodes.item(i);</span>
        // The Role in sakai
<span class="nc" id="L458">        String sakaiRole = getTagValue(&quot;memberRole&quot;, element);</span>

        // the location in sakai e.g. /site/admin
<span class="nc" id="L461">        String sakaiLocationReference = getTagValue(&quot;locationReference&quot;, element);</span>
        // we don't do the sakai admin role
<span class="nc bnc" id="L463" title="All 2 branches missed.">        if (&quot;/site/!admin&quot;.equals(sakaiLocationReference)) {</span>
<span class="nc" id="L464">          continue;</span>
        }

<span class="nc" id="L467">        String opencastRole = buildOpencastRole(sakaiLocationReference, sakaiRole);</span>
<span class="nc" id="L468">        roleList.add(opencastRole);</span>
      }

<span class="nc" id="L471">      return roleList.toArray(new String[0]);</span>

<span class="nc" id="L473">    } catch (FileNotFoundException fnf) {</span>
      // if the return is 404 it means the user wasn't found
<span class="nc" id="L475">      logger.debug(&quot;user id &quot; + userId + &quot; not found on &quot; + sakaiUrl);</span>
<span class="nc" id="L476">    } catch (Exception e) {</span>
<span class="nc" id="L477">      logger.warn(</span>
          &quot;Exception getting site/role membership for Sakai user {} at {}: {}&quot;,
          userId,
          sakaiUrl,
<span class="nc" id="L481">          e.getMessage()</span>
      );
<span class="nc" id="L483">    }</span>

<span class="nc" id="L485">    return null;</span>
  }

  /**
   * Get the internal Sakai user Id for the supplied user. If the user exists, set the user's email address.
   * 
   * @param eid
   * @return
   */
  private String[] getSakaiUser(String eid) {

    try {

<span class="nc" id="L498">      URL url = new URL(sakaiUrl + &quot;/direct/user/&quot; + eid + &quot;.xml&quot; + &quot;?__auth=basic&quot;);</span>
<span class="nc" id="L499">      logger.debug(&quot;Sakai URL: &quot; + sakaiUrl);</span>
<span class="nc" id="L500">      String encoded = Base64.encodeBase64String((sakaiUsername + &quot;:&quot; + sakaiPassword).getBytes(&quot;utf8&quot;));</span>
<span class="nc" id="L501">      HttpURLConnection connection = (HttpURLConnection) url.openConnection();</span>
<span class="nc" id="L502">      connection.setRequestMethod(&quot;GET&quot;);</span>
<span class="nc" id="L503">      connection.setDoOutput(true);</span>
<span class="nc" id="L504">      connection.setRequestProperty(&quot;Authorization&quot;, &quot;Basic &quot; + encoded);</span>
<span class="nc" id="L505">      connection.setRequestProperty(&quot;User-Agent&quot;, OC_USERAGENT);</span>

<span class="nc" id="L507">      String xml = IOUtils.toString(new BufferedInputStream(connection.getInputStream()));</span>
<span class="nc" id="L508">      logger.debug(xml);</span>

      // Parse the document
<span class="nc" id="L511">      DocumentBuilder parser = XmlSafeParser.newDocumentBuilderFactory().newDocumentBuilder();</span>
<span class="nc" id="L512">      Document document = parser.parse(new org.xml.sax.InputSource(new StringReader(xml)));</span>
<span class="nc" id="L513">      Element root = document.getDocumentElement();</span>

<span class="nc" id="L515">      String sakaiID = getTagValue(&quot;id&quot;, root);</span>
<span class="nc" id="L516">      String sakaiEmail = getTagValue(&quot;email&quot;, root);</span>
<span class="nc" id="L517">      String sakaiDisplayName = getTagValue(&quot;displayName&quot;, root);</span>

<span class="nc" id="L519">      return new String[]{sakaiID, sakaiEmail, sakaiDisplayName};</span>

<span class="nc" id="L521">    } catch (FileNotFoundException fnf) {</span>
<span class="nc" id="L522">      logger.debug(&quot;user {} does not exist on Sakai system&quot;, eid, fnf);</span>
<span class="nc" id="L523">    } catch (Exception e) {</span>
<span class="nc" id="L524">      logger.warn(&quot;Exception getting Sakai user information for user {} at {}&quot;, eid, sakaiUrl, e);</span>
<span class="nc" id="L525">    }</span>

<span class="nc" id="L527">    return null;</span>
  }

  /**
   * {@inheritDoc}
   * 
   * @see org.opencastproject.security.api.CachingUserProviderMXBean#getCacheHitRatio()
   */
  @Override
  public float getCacheHitRatio() {
<span class="nc bnc" id="L537" title="All 2 branches missed.">    if (requests.get() == 0) {</span>
<span class="nc" id="L538">      return 0;</span>
    }
<span class="nc" id="L540">    return (float) (requests.get() - sakaiLoads.get()) / requests.get();</span>
  }

  /**
   * Build a Opencast role &quot;foo_user&quot; from the given Sakai locations
   * 
   * @param sakaiLocationReference
   * @param sakaiRole
   * @return
   */
  private String buildOpencastRole(String sakaiLocationReference, String sakaiRole) {

    // we need to parse the site id from the reference
<span class="nc" id="L553">    String siteId = sakaiLocationReference.substring(sakaiLocationReference.indexOf(&quot;/&quot;, 2) + 1);</span>

    // map Sakai role to LTI role
<span class="nc bnc" id="L556" title="All 2 branches missed.">    String ltiRole = instructorRoles.contains(sakaiRole) ? LTI_INSTRUCTOR_ROLE : LTI_LEARNER_ROLE;</span>

<span class="nc" id="L558">    return siteId + &quot;_&quot; + ltiRole;</span>
  }

  /**
   * Get a value for for a tag in the element
   * 
   * @param sTag
   * @param eElement
   * @return
   */
  private static String getTagValue(String sTag, Element eElement) {
<span class="nc bnc" id="L569" title="All 2 branches missed.">    if (eElement.getElementsByTagName(sTag) == null) {</span>
<span class="nc" id="L570">      return null;</span>
    }

<span class="nc" id="L573">    NodeList nlList = eElement.getElementsByTagName(sTag).item(0).getChildNodes();</span>
<span class="nc" id="L574">    Node nValue = nlList.item(0);</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">    return (nValue != null) ? nValue.getNodeValue() : null;</span>
  }

  @Override
  public Iterator&lt;User&gt; findUsers(String query, int offset, int limit) {

<span class="nc bnc" id="L581" title="All 2 branches missed.">    if (query == null) {</span>
<span class="nc" id="L582">      throw new IllegalArgumentException(&quot;Query must be set&quot;);</span>
    }

<span class="nc bnc" id="L585" title="All 2 branches missed.">    if (query.endsWith(&quot;%&quot;)) {</span>
<span class="nc" id="L586">      query = query.substring(0, query.length() - 1);</span>
    }

<span class="nc bnc" id="L589" title="All 2 branches missed.">    if (query.isEmpty()) {</span>
<span class="nc" id="L590">      return Collections.emptyIterator();</span>
    }

    // Verify if a user exists (non-wildcard searches only)
<span class="nc bnc" id="L594" title="All 2 branches missed.">    if (!verifySakaiUser(query)) {</span>
<span class="nc" id="L595">      return Collections.emptyIterator();</span>
    }

<span class="nc" id="L598">    List&lt;User&gt; users = new LinkedList&lt;User&gt;();</span>
<span class="nc" id="L599">    JaxbOrganization jaxbOrganization = JaxbOrganization.fromOrganization(organization);</span>
<span class="nc" id="L600">    JaxbUser queryUser = new JaxbUser(query, PROVIDER_NAME, jaxbOrganization, new HashSet&lt;JaxbRole&gt;());</span>
<span class="nc" id="L601">    users.add(queryUser);</span>

<span class="nc" id="L603">    return users.iterator();</span>
  }

  @Override
  public Iterator&lt;User&gt; getUsers() {
    // We never enumerate all users
<span class="nc" id="L609">    return Collections.emptyIterator();</span>
  }

  @Override
  public void invalidate(String userName) {
<span class="nc" id="L614">    cache.invalidate(userName);</span>
<span class="nc" id="L615">  }</span>

  @Override
  public long countUsers() {
    // Not meaningful, as we never enumerate users
<span class="nc" id="L620">    return 0;</span>
  }

  // RoleProvider methods

  @Override
  public List&lt;Role&gt; getRolesForUser(String userName) {

<span class="nc" id="L628">    List&lt;Role&gt; roles = new LinkedList&lt;Role&gt;();</span>

    // Don't answer for admin, anonymous or empty user
<span class="nc bnc" id="L631" title="All 6 branches missed.">    if (&quot;admin&quot;.equals(userName) || &quot;&quot;.equals(userName) || &quot;anonymous&quot;.equals(userName)) {</span>
<span class="nc" id="L632">      logger.debug(&quot;we don't answer for: &quot; + userName);</span>
<span class="nc" id="L633">      return roles;</span>
    }

<span class="nc" id="L636">    logger.debug(&quot;getRolesForUser(&quot; + userName + &quot;)&quot;);</span>

<span class="nc" id="L638">    User user = loadUser(userName);</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">    if (user != null) {</span>
<span class="nc" id="L640">      logger.debug(&quot;Returning cached roleset for {}&quot;, userName);</span>
<span class="nc" id="L641">      return new ArrayList&lt;Role&gt;(user.getRoles());</span>
    }

    // Not found
<span class="nc" id="L645">    logger.debug(&quot;Return empty roleset for {} - not found on Sakai&quot;, userName);</span>
<span class="nc" id="L646">    return new LinkedList&lt;Role&gt;();</span>
  }

  @Override
  public Iterator&lt;Role&gt; findRoles(String query, Role.Target target, int offset, int limit) {

    // We search for SITEID, SITEID_Learner, SITEID_Instructor

<span class="nc" id="L654">    logger.debug(&quot;findRoles(query=&quot; + query + &quot; offset=&quot; + offset + &quot; limit=&quot; + limit + &quot;)&quot;);</span>

    // Don't return roles for users or groups
<span class="nc bnc" id="L657" title="All 2 branches missed.">    if (target == Role.Target.USER) {</span>
<span class="nc" id="L658">      return Collections.emptyIterator();</span>
    }

<span class="nc" id="L661">    boolean exact = true;</span>
<span class="nc" id="L662">    boolean ltirole = false;</span>

<span class="nc bnc" id="L664" title="All 2 branches missed.">    if (query.endsWith(&quot;%&quot;)) {</span>
<span class="nc" id="L665">      exact = false;</span>
<span class="nc" id="L666">      query = query.substring(0, query.length() - 1);</span>
    }

<span class="nc bnc" id="L669" title="All 2 branches missed.">    if (query.isEmpty()) {</span>
<span class="nc" id="L670">      return Collections.emptyIterator();</span>
    }

    // Verify that role name ends with LTI_LEARNER_ROLE or LTI_INSTRUCTOR_ROLE
<span class="nc bnc" id="L674" title="All 6 branches missed.">    if (exact &amp;&amp; !query.endsWith(&quot;_&quot; + LTI_LEARNER_ROLE) &amp;&amp; !query.endsWith(&quot;_&quot; + LTI_INSTRUCTOR_ROLE)) {</span>
<span class="nc" id="L675">      return Collections.emptyIterator();</span>
    }

<span class="nc" id="L678">    String sakaiSite = null;</span>

<span class="nc bnc" id="L680" title="All 2 branches missed.">    if (query.endsWith(&quot;_&quot; + LTI_LEARNER_ROLE)) {</span>
<span class="nc" id="L681">      sakaiSite = query.substring(0, query.lastIndexOf(&quot;_&quot; + LTI_LEARNER_ROLE));</span>
<span class="nc" id="L682">      ltirole = true;</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">    } else if (query.endsWith(&quot;_&quot; + LTI_INSTRUCTOR_ROLE)) {</span>
<span class="nc" id="L684">      sakaiSite = query.substring(0, query.lastIndexOf(&quot;_&quot; + LTI_INSTRUCTOR_ROLE));</span>
<span class="nc" id="L685">      ltirole = true;</span>
    }

<span class="nc bnc" id="L688" title="All 2 branches missed.">    if (!ltirole) {</span>
<span class="nc" id="L689">      sakaiSite = query;</span>
    }

<span class="nc bnc" id="L692" title="All 2 branches missed.">    if (!verifySakaiSite(sakaiSite)) {</span>
<span class="nc" id="L693">      return Collections.emptyIterator();</span>
    }

    // Roles list
<span class="nc" id="L697">    List&lt;Role&gt; roles = new LinkedList&lt;Role&gt;();</span>

<span class="nc" id="L699">    JaxbOrganization jaxbOrganization = JaxbOrganization.fromOrganization(organization);</span>

<span class="nc bnc" id="L701" title="All 2 branches missed.">    if (ltirole) {</span>
      // Query is for a Site ID and an LTI role (Instructor/Learner)
<span class="nc" id="L703">      roles.add(new JaxbRole(query, jaxbOrganization, &quot;Sakai Site Role&quot;, Role.Type.EXTERNAL));</span>
    } else {
      // Site ID - return both roles
<span class="nc" id="L706">      roles.add(new JaxbRole(</span>
          sakaiSite + &quot;_&quot; + LTI_INSTRUCTOR_ROLE,
          jaxbOrganization,
          &quot;Sakai Site Instructor Role&quot;,
          Role.Type.EXTERNAL
      ));
<span class="nc" id="L712">      roles.add(new JaxbRole(</span>
          sakaiSite + &quot;_&quot; + LTI_LEARNER_ROLE,
          jaxbOrganization,
          &quot;Sakai Site Learner Role&quot;,
          Role.Type.EXTERNAL
      ));
    }

<span class="nc" id="L720">    return roles.iterator();</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>