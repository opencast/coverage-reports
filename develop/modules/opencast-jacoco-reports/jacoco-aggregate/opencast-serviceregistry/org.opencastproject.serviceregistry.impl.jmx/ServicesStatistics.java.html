<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ServicesStatistics.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-serviceregistry</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.serviceregistry.impl.jmx</a> &gt; <span class="el_source">ServicesStatistics.java</span></div><h1>ServicesStatistics.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.serviceregistry.impl.jmx;

import org.opencastproject.serviceregistry.api.ServiceRegistration;
import org.opencastproject.serviceregistry.api.ServiceState;
import org.opencastproject.serviceregistry.api.ServiceStatistics;
import org.opencastproject.util.data.Tuple;
import org.opencastproject.util.jmx.JmxUtil;

import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.collections4.PredicateUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;

import javax.management.MBeanNotificationInfo;
import javax.management.Notification;
import javax.management.NotificationBroadcasterSupport;

public class ServicesStatistics extends NotificationBroadcasterSupport implements ServicesStatisticsMXBean {

<span class="fc" id="L47">  private static final Logger logger = LoggerFactory.getLogger(ServicesStatistics.class);</span>

  private static final String DELIMITER = &quot;;&quot;;

<span class="fc" id="L51">  private Map&lt;Tuple&lt;String, String&gt;, ServiceState&gt; services = new HashMap&lt;Tuple&lt;String, String&gt;, ServiceState&gt;();</span>
<span class="fc" id="L52">  private long sequenceNumber = 1;</span>
  private final String hostName;

<span class="fc" id="L55">  public ServicesStatistics(String hostName, List&lt;ServiceStatistics&gt; statistics) {</span>
<span class="fc" id="L56">    this.hostName = hostName;</span>
<span class="fc bfc" id="L57" title="All 2 branches covered.">    for (ServiceStatistics stats : statistics) {</span>
<span class="pc bpc" id="L58" title="1 of 2 branches missed.">      if (!stats.getServiceRegistration().isActive()) {</span>
<span class="nc" id="L59">        logger.trace(&quot;Ignoring inactive service '{}'&quot;, stats);</span>
<span class="nc" id="L60">        continue;</span>
      }
<span class="fc" id="L62">      String host = stats.getServiceRegistration().getHost();</span>
<span class="fc" id="L63">      String serviceType = stats.getServiceRegistration().getServiceType();</span>
<span class="fc" id="L64">      ServiceState serviceState = stats.getServiceRegistration().getServiceState();</span>
<span class="fc" id="L65">      services.put(Tuple.tuple(host, serviceType), serviceState);</span>
<span class="fc" id="L66">    }</span>
<span class="fc" id="L67">  }</span>

  public void updateService(ServiceRegistration registration) {
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">    if (!registration.isActive()) {</span>
<span class="nc" id="L71">      services.remove(Tuple.tuple(registration.getHost(), registration.getServiceType()));</span>
<span class="nc" id="L72">      logger.trace(&quot;Removing inactive service '{}'&quot;, registration);</span>
    } else {
<span class="fc" id="L74">      services.put(Tuple.tuple(registration.getHost(), registration.getServiceType()), registration.getServiceState());</span>
    }

<span class="fc" id="L77">    sendNotification(JmxUtil.createUpdateNotification(this, sequenceNumber++, &quot;Service updated&quot;));</span>
<span class="fc" id="L78">  }</span>

  @Override
  public MBeanNotificationInfo[] getNotificationInfo() {
<span class="fc" id="L82">    String[] types = new String[] { JmxUtil.OPENCAST_UPDATE_NOTIFICATION };</span>

<span class="fc" id="L84">    String name = Notification.class.getName();</span>
<span class="fc" id="L85">    String description = &quot;An update was executed&quot;;</span>
<span class="fc" id="L86">    MBeanNotificationInfo info = new MBeanNotificationInfo(types, name, description);</span>
<span class="fc" id="L87">    return new MBeanNotificationInfo[] { info };</span>
  }

  /**
   * @see org.opencastproject.serviceregistry.impl.jmx.ServicesStatisticsMXBean#getServiceCount()
   */
  @Override
  public int getServiceCount() {
<span class="nc" id="L95">    return services.size();</span>
  }

  /**
   * @see org.opencastproject.serviceregistry.impl.jmx.ServicesStatisticsMXBean#getServiceCountByNode()
   */
  @Override
  public int getServiceCountByNode() {
<span class="nc" id="L103">    int i = 0;</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">    for (Tuple&lt;String, String&gt; key : services.keySet()) {</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">      if (key.getA().equals(hostName))</span>
<span class="nc" id="L106">        i++;</span>
<span class="nc" id="L107">    }</span>
<span class="nc" id="L108">    return i;</span>
  }

  /**
   * @see org.opencastproject.serviceregistry.impl.jmx.ServicesStatisticsMXBean#getNormalServiceCountByNode()
   */
  @Override
  public int getNormalServiceCountByNode() {
<span class="nc" id="L116">    int i = 0;</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">    for (Entry&lt;Tuple&lt;String, String&gt;, ServiceState&gt; entry : services.entrySet()) {</span>
<span class="nc bnc" id="L118" title="All 4 branches missed.">      if (entry.getKey().getA().equals(hostName) &amp;&amp; ServiceState.NORMAL.equals(entry.getValue()))</span>
<span class="nc" id="L119">        i++;</span>
<span class="nc" id="L120">    }</span>
<span class="nc" id="L121">    return i;</span>
  }

  /**
   * @see org.opencastproject.serviceregistry.impl.jmx.ServicesStatisticsMXBean#getWarningServiceCountByNode()
   */
  @Override
  public int getWarningServiceCountByNode() {
<span class="nc" id="L129">    int i = 0;</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">    for (Entry&lt;Tuple&lt;String, String&gt;, ServiceState&gt; entry : services.entrySet()) {</span>
<span class="nc bnc" id="L131" title="All 4 branches missed.">      if (entry.getKey().getA().equals(hostName) &amp;&amp; ServiceState.WARNING.equals(entry.getValue()))</span>
<span class="nc" id="L132">        i++;</span>
<span class="nc" id="L133">    }</span>
<span class="nc" id="L134">    return i;</span>
  }

  /**
   * @see org.opencastproject.serviceregistry.impl.jmx.ServicesStatisticsMXBean#getErrorServiceCountByNode()
   */
  @Override
  public int getErrorServiceCountByNode() {
<span class="nc" id="L142">    int i = 0;</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">    for (Entry&lt;Tuple&lt;String, String&gt;, ServiceState&gt; entry : services.entrySet()) {</span>
<span class="nc bnc" id="L144" title="All 4 branches missed.">      if (entry.getKey().getA().equals(hostName) &amp;&amp; ServiceState.ERROR.equals(entry.getValue()))</span>
<span class="nc" id="L145">        i++;</span>
<span class="nc" id="L146">    }</span>
<span class="nc" id="L147">    return i;</span>
  }

  /**
   * @see org.opencastproject.serviceregistry.impl.jmx.ServicesStatisticsMXBean#getNormalServiceCount()
   */
  @Override
  public int getNormalServiceCount() {
<span class="nc" id="L155">    return CollectionUtils.countMatches(services.values(), PredicateUtils.equalPredicate(ServiceState.NORMAL));</span>
  }

  /**
   * @see org.opencastproject.serviceregistry.impl.jmx.ServicesStatisticsMXBean#getWarningServiceCount()
   */
  @Override
  public int getWarningServiceCount() {
<span class="nc" id="L163">    return CollectionUtils.countMatches(services.values(), PredicateUtils.equalPredicate(ServiceState.WARNING));</span>
  }

  /**
   * @see org.opencastproject.serviceregistry.impl.jmx.ServicesStatisticsMXBean#getErrorServiceCount()
   */
  @Override
  public int getErrorServiceCount() {
<span class="nc" id="L171">    return CollectionUtils.countMatches(services.values(), PredicateUtils.equalPredicate(ServiceState.ERROR));</span>
  }

  /**
   * @see org.opencastproject.serviceregistry.impl.jmx.ServicesStatisticsMXBean#getServices()
   */
  @Override
  public String[] getServices() {
<span class="nc" id="L179">    List&lt;String&gt; serviceList = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">    for (Tuple&lt;String, String&gt; key : services.keySet()) {</span>
<span class="nc" id="L181">      serviceList.add(key.getA() + DELIMITER + key.getB());</span>
<span class="nc" id="L182">    }</span>
<span class="nc" id="L183">    return serviceList.toArray(new String[serviceList.size()]);</span>
  }

  /**
   * @see org.opencastproject.serviceregistry.impl.jmx.ServicesStatisticsMXBean#getServicesByNode()
   */
  @Override
  public String[] getServicesByNode() {
<span class="nc" id="L191">    List&lt;String&gt; serviceList = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">    for (Tuple&lt;String, String&gt; key : services.keySet()) {</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">      if (key.getA().equals(hostName))</span>
<span class="nc" id="L194">        serviceList.add(key.getA() + DELIMITER + key.getB());</span>
<span class="nc" id="L195">    }</span>
<span class="nc" id="L196">    return serviceList.toArray(new String[serviceList.size()]);</span>
  }

  /**
   * @see org.opencastproject.serviceregistry.impl.jmx.ServicesStatisticsMXBean#getNormalServices()
   */
  @Override
  public String[] getNormalServices() {
<span class="nc" id="L204">    List&lt;String&gt; normalServices = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">    for (Entry&lt;Tuple&lt;String, String&gt;, ServiceState&gt; entry : services.entrySet()) {</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">      if (ServiceState.NORMAL.equals(entry.getValue()))</span>
<span class="nc" id="L207">        normalServices.add(entry.getKey().getA() + DELIMITER + entry.getKey().getB());</span>
<span class="nc" id="L208">    }</span>
<span class="nc" id="L209">    return normalServices.toArray(new String[normalServices.size()]);</span>
  }

  /**
   * @see org.opencastproject.serviceregistry.impl.jmx.ServicesStatisticsMXBean#getNormalServicesByNode()
   */
  @Override
  public String[] getNormalServicesByNode() {
<span class="nc" id="L217">    List&lt;String&gt; normalServices = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">    for (Entry&lt;Tuple&lt;String, String&gt;, ServiceState&gt; entry : services.entrySet()) {</span>
<span class="nc bnc" id="L219" title="All 4 branches missed.">      if (entry.getKey().getA().equals(hostName) &amp;&amp; ServiceState.NORMAL.equals(entry.getValue()))</span>
<span class="nc" id="L220">        normalServices.add(entry.getKey().getA() + DELIMITER + entry.getKey().getB());</span>
<span class="nc" id="L221">    }</span>
<span class="nc" id="L222">    return normalServices.toArray(new String[normalServices.size()]);</span>
  }

  /**
   * @see org.opencastproject.serviceregistry.impl.jmx.ServicesStatisticsMXBean#getWarningServices()
   */
  @Override
  public String[] getWarningServices() {
<span class="nc" id="L230">    List&lt;String&gt; warningServices = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">    for (Entry&lt;Tuple&lt;String, String&gt;, ServiceState&gt; entry : services.entrySet()) {</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">      if (ServiceState.WARNING.equals(entry.getValue()))</span>
<span class="nc" id="L233">        warningServices.add(entry.getKey().getA() + DELIMITER + entry.getKey().getB());</span>
<span class="nc" id="L234">    }</span>
<span class="nc" id="L235">    return warningServices.toArray(new String[warningServices.size()]);</span>
  }

  /**
   * @see org.opencastproject.serviceregistry.impl.jmx.ServicesStatisticsMXBean#getWarningServicesByNode()
   */
  @Override
  public String[] getWarningServicesByNode() {
<span class="nc" id="L243">    List&lt;String&gt; warningServices = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">    for (Entry&lt;Tuple&lt;String, String&gt;, ServiceState&gt; entry : services.entrySet()) {</span>
<span class="nc bnc" id="L245" title="All 4 branches missed.">      if (entry.getKey().getA().equals(hostName) &amp;&amp; ServiceState.WARNING.equals(entry.getValue()))</span>
<span class="nc" id="L246">        warningServices.add(entry.getKey().getA() + DELIMITER + entry.getKey().getB());</span>
<span class="nc" id="L247">    }</span>
<span class="nc" id="L248">    return warningServices.toArray(new String[warningServices.size()]);</span>
  }

  /**
   * @see org.opencastproject.serviceregistry.impl.jmx.ServicesStatisticsMXBean#getErrorServices()
   */
  @Override
  public String[] getErrorServices() {
<span class="nc" id="L256">    List&lt;String&gt; erroServices = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">    for (Entry&lt;Tuple&lt;String, String&gt;, ServiceState&gt; entry : services.entrySet()) {</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">      if (ServiceState.ERROR.equals(entry.getValue()))</span>
<span class="nc" id="L259">        erroServices.add(entry.getKey().getA() + DELIMITER + entry.getKey().getB());</span>
<span class="nc" id="L260">    }</span>
<span class="nc" id="L261">    return erroServices.toArray(new String[erroServices.size()]);</span>
  }

  /**
   * @see org.opencastproject.serviceregistry.impl.jmx.ServicesStatisticsMXBean#getErrorServicesByNode()
   */
  @Override
  public String[] getErrorServicesByNode() {
<span class="nc" id="L269">    List&lt;String&gt; erroServices = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">    for (Entry&lt;Tuple&lt;String, String&gt;, ServiceState&gt; entry : services.entrySet()) {</span>
<span class="nc bnc" id="L271" title="All 4 branches missed.">      if (entry.getKey().getA().equals(hostName) &amp;&amp; ServiceState.ERROR.equals(entry.getValue()))</span>
<span class="nc" id="L272">        erroServices.add(entry.getKey().getA() + DELIMITER + entry.getKey().getB());</span>
<span class="nc" id="L273">    }</span>
<span class="nc" id="L274">    return erroServices.toArray(new String[erroServices.size()]);</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>