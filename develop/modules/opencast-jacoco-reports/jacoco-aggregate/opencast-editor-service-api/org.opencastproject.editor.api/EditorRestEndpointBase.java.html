<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>EditorRestEndpointBase.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-editor-service-api</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.editor.api</a> &gt; <span class="el_source">EditorRestEndpointBase.java</span></div><h1>EditorRestEndpointBase.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.editor.api;

import static javax.servlet.http.HttpServletResponse.SC_CONFLICT;
import static javax.servlet.http.HttpServletResponse.SC_CREATED;
import static javax.servlet.http.HttpServletResponse.SC_NOT_FOUND;
import static javax.servlet.http.HttpServletResponse.SC_OK;

import org.opencastproject.security.api.UnauthorizedException;
import org.opencastproject.util.RestUtil;
import org.opencastproject.util.doc.rest.RestParameter;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestResponse;

import org.apache.commons.io.IOUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.io.InputStream;
import java.net.URI;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.Consumes;
import javax.ws.rs.DELETE;
import javax.ws.rs.FormParam;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.core.Context;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;

/**
 * The REST endpoint for the {@link EditorService} service
 */
<span class="nc" id="L60">public abstract class EditorRestEndpointBase {</span>
  /** The logger */
<span class="nc" id="L62">  private static final Logger logger = LoggerFactory.getLogger(EditorRestEndpointBase.class);</span>

  /** The service */
  protected EditorService editorService;

  public abstract void setEditorService(EditorService service);

  @GET
  @Path(&quot;{mediaPackageId}/edit.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;getEditorData&quot;,
          description = &quot;Returns all the information required to get the editor tool started&quot;,
          returnDescription = &quot;JSON object&quot;,
          pathParameters = { @RestParameter(name = &quot;mediaPackageId&quot;, description = &quot;The id of the media package&quot;,
                  isRequired = true, type = RestParameter.Type.STRING) }, responses = {
          @RestResponse(description = &quot;Media package found&quot;, responseCode = SC_OK),
          @RestResponse(description = &quot;Media package not found&quot;, responseCode = SC_NOT_FOUND) })
  public Response getEditorData(@PathParam(&quot;mediaPackageId&quot;) final String mediaPackageId) {
    try {
<span class="nc" id="L81">      EditingData response = editorService.getEditData(mediaPackageId);</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">      if (response != null) {</span>
<span class="nc" id="L83">        return Response.ok(response.toString(), MediaType.APPLICATION_JSON_TYPE).build();</span>
      } else {
<span class="nc" id="L85">        logger.error(&quot;EditorService returned empty response&quot;);</span>
<span class="nc" id="L86">        return RestUtil.R.serverError();</span>
      }
<span class="nc" id="L88">    } catch (EditorServiceException e) {</span>
<span class="nc" id="L89">      return checkErrorState(mediaPackageId, e);</span>
<span class="nc" id="L90">    } catch (UnauthorizedException e) {</span>
<span class="nc" id="L91">      return Response.status(Response.Status.FORBIDDEN).entity(&quot;No write access to this event.&quot;).build();</span>
    }
  }

  @POST
  @Path(&quot;{mediaPackageId}/lock&quot;)
  @RestQuery(name = &quot;lockMediapackage&quot;,
          description = &quot;Creates and updates the lock for a mediapackage in the editor. &quot;
          + &quot;Requests will create/refreshen a lock at /editor/{mediapackageId}/lock{uuid} &quot;
          + &quot;(see Location header in response) that will expire after the configured period. &quot;
          + &quot;Subsequent calls must have the same uuid, which will then freshen the lock.&quot;,
          returnDescription = &quot;The lock is returned in the Location header.&quot;,
          pathParameters = {
            @RestParameter(name = &quot;mediaPackageId&quot;, description = &quot;The id of the media package&quot;, isRequired = true,
                    type = RestParameter.Type.STRING)
          },
          restParameters = {
            @RestParameter(name = &quot;user&quot;, isRequired = true,
                description = &quot;The user requesting to lock this mediapackage&quot;,
                type = RestParameter.Type.STRING, defaultValue = &quot;admin&quot;),
            @RestParameter(name = &quot;uuid&quot;, isRequired = true,
                description = &quot;The unique identitier of the lock&quot;,
                type = RestParameter.Type.STRING)
          },
          responses = {
            @RestResponse(description = &quot;Lock obtained&quot;, responseCode = SC_CREATED),
            @RestResponse(description = &quot;Lock not obtained&quot;, responseCode = SC_CONFLICT),
            @RestResponse(description = &quot;Mediapackage not found&quot;, responseCode = SC_NOT_FOUND)
          })
  public Response lockMediapackage(@PathParam(&quot;mediaPackageId&quot;) final String mediaPackageId,
         @FormParam(&quot;user&quot;) final String user, @FormParam(&quot;uuid&quot;) final String uuid,
         @Context HttpServletRequest request) {
    try {
<span class="nc" id="L124">      LockData lockData = new LockData(uuid, user);</span>
<span class="nc" id="L125">      editorService.lockMediaPackage(mediaPackageId, lockData);</span>
<span class="nc" id="L126">      return RestUtil.R.created(new URI(request.getRequestURI() + &quot;/&quot; + lockData.getUUID()));</span>
<span class="nc" id="L127">    } catch (EditorServiceException e) {</span>
<span class="nc" id="L128">      return checkErrorState(mediaPackageId, e);</span>
<span class="nc" id="L129">    } catch (Exception e) {</span>
<span class="nc" id="L130">      logger.debug(&quot;Unable to create lock&quot;,  e);</span>
<span class="nc" id="L131">      return RestUtil.R.badRequest();</span>
    }
  }

  @DELETE
  @Path(&quot;{mediaPackageId}/lock/{uuid}&quot;)
  @RestQuery(name = &quot;unlockMediapackage&quot;,
          description = &quot;Releases the lock for a mediapackage in the editor&quot;,
          returnDescription = &quot;&quot;,
          pathParameters = {
            @RestParameter(name = &quot;mediaPackageId&quot;, description = &quot;The id of the media package&quot;, isRequired = true,
                    type = RestParameter.Type.STRING),
            @RestParameter(name = &quot;uuid&quot;, description = &quot;Identifier of editor session&quot;, isRequired = true,
                    type = RestParameter.Type.STRING)
          },
          responses = {
            @RestResponse(description = &quot;Lock deleted&quot;, responseCode = SC_OK),
            @RestResponse(description = &quot;Lock not obtained&quot;, responseCode = SC_CONFLICT),
            @RestResponse(description = &quot;Lock not found&quot;, responseCode = SC_NOT_FOUND)
          })

  public Response unlockMediapackage(@PathParam(&quot;mediaPackageId&quot;) final String mediaPackageId,
          @PathParam(&quot;uuid&quot;) final String uuid)  {
    try {
<span class="nc" id="L155">      editorService.unlockMediaPackage(mediaPackageId, new LockData(uuid, &quot;&quot;));</span>
<span class="nc" id="L156">      return RestUtil.R.ok();</span>
<span class="nc" id="L157">    } catch (EditorServiceException e) {</span>
<span class="nc" id="L158">      return checkErrorState(mediaPackageId, e);</span>
    }
  }

  @POST
  @Path(&quot;{mediaPackageId}/edit.json&quot;)
  @Consumes(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;editVideo&quot;, description = &quot;Takes editing information from the client side and processes it&quot;,
          returnDescription = &quot;&quot;,
          pathParameters = {
          @RestParameter(name = &quot;mediaPackageId&quot;, description = &quot;The id of the media package&quot;, isRequired = true,
                  type = RestParameter.Type.STRING) },
          responses = {
          @RestResponse(description = &quot;Editing information saved and processed&quot;, responseCode = SC_OK),
          @RestResponse(description = &quot;Media package not found&quot;, responseCode = SC_NOT_FOUND),
          @RestResponse(description = &quot;The editing information cannot be parsed&quot;,
                  responseCode = HttpServletResponse.SC_BAD_REQUEST) })
  public Response editVideo(@PathParam(&quot;mediaPackageId&quot;) final String mediaPackageId,
          @Context HttpServletRequest request) {
<span class="nc" id="L177">    String details = null;</span>
    try {
<span class="nc" id="L179">      details = readInputStream(request);</span>
<span class="nc" id="L180">      logger.debug(&quot;Editor POST-Request received: {}&quot;, details);</span>
<span class="nc" id="L181">      EditingData editingInfo = EditingData.parse(details);</span>
<span class="nc" id="L182">      editorService.setEditData(mediaPackageId, editingInfo);</span>
<span class="nc" id="L183">    } catch (EditorServiceException e) {</span>
<span class="nc" id="L184">      return checkErrorState(mediaPackageId, e);</span>
<span class="nc" id="L185">    } catch (Exception e) {</span>
<span class="nc" id="L186">      logger.debug(&quot;Unable to parse editing information ({})&quot;, details, e);</span>
<span class="nc" id="L187">      return RestUtil.R.badRequest(&quot;Unable to parse details&quot;);</span>
<span class="nc" id="L188">    }</span>

<span class="nc" id="L190">    return RestUtil.R.ok();</span>
  }

  protected String readInputStream(HttpServletRequest request) {
    String details;
<span class="nc" id="L195">    try (InputStream is = request.getInputStream()) {</span>
<span class="nc" id="L196">      details = IOUtils.toString(is, request.getCharacterEncoding());</span>
<span class="nc" id="L197">    } catch (IOException e) {</span>
<span class="nc" id="L198">      logger.error(&quot;Error reading request body:&quot;, e);</span>
<span class="nc" id="L199">      return null;</span>
<span class="nc" id="L200">    }</span>
<span class="nc" id="L201">    return details;</span>
  }

  protected Response checkErrorState(final String eventId, EditorServiceException e) {
<span class="nc bnc" id="L205" title="All 6 branches missed.">    switch (e.getErrorStatus()) {</span>
      case MEDIAPACKAGE_NOT_FOUND:
<span class="nc" id="L207">        return RestUtil.R.notFound(String.format(&quot;Event '%s' not Found&quot;, eventId), MediaType.TEXT_PLAIN_TYPE);</span>
      case MEDIAPACKAGE_LOCKED:
<span class="nc" id="L209">        return RestUtil.R.conflict(String.format(&quot;Event '%s' is %s&quot;, eventId, e.getMessage()));</span>
      case WORKFLOW_ACTIVE:
<span class="nc" id="L211">        return RestUtil.R.locked();</span>
      case NOT_AUTHORIZED:
<span class="nc" id="L213">        return RestUtil.R.unauthorized(String.format(&quot;Unauthorized for event '%s'&quot;, eventId));</span>
      case WORKFLOW_NOT_FOUND:
      case METADATA_UPDATE_FAIL:
      case NO_INTERNAL_PUBLICATION:
<span class="nc" id="L217">        return RestUtil.R.badRequest(e.getMessage());</span>
      case UNABLE_TO_CREATE_CATALOG:
      case WORKFLOW_ERROR:
      case UNKNOWN:
      default:
<span class="nc" id="L222">        return RestUtil.R.serverError();</span>
    }
  }

  @GET
  @Path(&quot;{mediaPackageId}/metadata.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;getMetadata&quot;,
          description = &quot;Returns all the data related to the metadata tab in the event details modal as JSON&quot;,
          returnDescription = &quot;All the data related to the event metadata tab as JSON&quot;,
          pathParameters = {
          @RestParameter(name = &quot;mediaPackageId&quot;, description = &quot;The event id&quot;, isRequired = true,
                  type = RestParameter.Type.STRING) },
          responses = {
          @RestResponse(description = &quot;Returns all the data related to the event metadata tab as JSON&quot;,
                  responseCode = HttpServletResponse.SC_OK),
          @RestResponse(description = &quot;No event with this identifier was found.&quot;,
                  responseCode = HttpServletResponse.SC_NOT_FOUND) })
  public Response getEventMetadata(@PathParam(&quot;mediaPackageId&quot;) String eventId) {
    try {
<span class="nc" id="L242">      String response = editorService.getMetadata(eventId);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">      if (response != null) {</span>
<span class="nc" id="L244">        return Response.ok(response, MediaType.APPLICATION_JSON_TYPE).build();</span>
      } else {
<span class="nc" id="L246">        logger.error(&quot;EditorService returned empty response&quot;);</span>
<span class="nc" id="L247">        return RestUtil.R.serverError();</span>
      }
<span class="nc" id="L249">    } catch (EditorServiceException e) {</span>
<span class="nc" id="L250">      return checkErrorState(eventId, e);</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>