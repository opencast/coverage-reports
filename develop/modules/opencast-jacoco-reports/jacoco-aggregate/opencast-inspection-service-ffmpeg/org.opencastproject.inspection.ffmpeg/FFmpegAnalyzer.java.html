<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>FFmpegAnalyzer.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-inspection-service-ffmpeg</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.inspection.ffmpeg</a> &gt; <span class="el_source">FFmpegAnalyzer.java</span></div><h1>FFmpegAnalyzer.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.inspection.ffmpeg;

import org.opencastproject.inspection.ffmpeg.api.AudioStreamMetadata;
import org.opencastproject.inspection.ffmpeg.api.MediaAnalyzer;
import org.opencastproject.inspection.ffmpeg.api.MediaAnalyzerException;
import org.opencastproject.inspection.ffmpeg.api.MediaContainerMetadata;
import org.opencastproject.inspection.ffmpeg.api.SubtitleStreamMetadata;
import org.opencastproject.inspection.ffmpeg.api.VideoStreamMetadata;
import org.opencastproject.util.IoSupport;

import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

/**
 * This MediaAnalyzer implementation uses the ffprobe binary of FFmpeg for media analysis. Also this implementation does
 * not keep control-, text- or other non-audio or video streams and purposefully ignores them during the
 * &lt;code&gt;postProcess()&lt;/code&gt; step.
 */
public class FFmpegAnalyzer implements MediaAnalyzer {

  /** Path to the executable */
  protected String binary;

  public static final String FFPROBE_BINARY_CONFIG = &quot;org.opencastproject.inspection.ffprobe.path&quot;;
  public static final String FFPROBE_BINARY_DEFAULT = &quot;ffprobe&quot;;

  /** Logging facility */
<span class="fc" id="L60">  private static final Logger logger = LoggerFactory.getLogger(FFmpegAnalyzer.class);</span>

  /** Whether the calculation of the frames is accurate or not */
  private boolean accurateFrameCount;

<span class="fc" id="L65">  public FFmpegAnalyzer(boolean accurateFrameCount) {</span>
<span class="fc" id="L66">    this.accurateFrameCount = accurateFrameCount;</span>
    // instantiated using MediaAnalyzerFactory via newInstance()
<span class="fc" id="L68">    this.binary = FFPROBE_BINARY_DEFAULT;</span>
<span class="fc" id="L69">  }</span>

  /**
   * Returns the binary used to provide media inspection functionality.
   *
   * @return the binary
   */
  protected String getBinary() {
<span class="nc" id="L77">    return binary;</span>
  }

  public void setBinary(String binary) {
<span class="fc" id="L81">    this.binary = binary;</span>
<span class="fc" id="L82">  }</span>

  @Override
  public MediaContainerMetadata analyze(File media) throws MediaAnalyzerException {
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">    if (binary == null) {</span>
<span class="nc" id="L87">      throw new IllegalStateException(&quot;Binary is not set&quot;);</span>
    }

<span class="fc" id="L90">    List&lt;String&gt; command = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L91">    command.add(binary);</span>
<span class="fc" id="L92">    command.add(&quot;-show_format&quot;);</span>
<span class="fc" id="L93">    command.add(&quot;-show_streams&quot;);</span>
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">    if (accurateFrameCount)</span>
<span class="nc" id="L95">      command.add(&quot;-count_frames&quot;);</span>
<span class="fc" id="L96">    command.add(&quot;-of&quot;);</span>
<span class="fc" id="L97">    command.add(&quot;json&quot;);</span>
<span class="fc" id="L98">    command.add(media.getAbsolutePath().replaceAll(&quot; &quot;, &quot;\\ &quot;));</span>

    /* Execute ffprobe and obtain the result */
<span class="fc" id="L101">    logger.debug(&quot;Running {} {}&quot;, binary, command);</span>

<span class="fc" id="L103">    MediaContainerMetadata metadata = new MediaContainerMetadata();</span>

<span class="fc" id="L105">    final StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L106">    Process encoderProcess = null;</span>
    try {
<span class="fc" id="L108">      encoderProcess = new ProcessBuilder(command)</span>
<span class="fc" id="L109">          .redirectError(ProcessBuilder.Redirect.DISCARD)</span>
<span class="fc" id="L110">          .start();</span>

      // tell encoder listeners about output
<span class="fc" id="L113">      try (var in = new BufferedReader(new InputStreamReader(encoderProcess.getInputStream()))) {</span>
        String line;
<span class="fc bfc" id="L115" title="All 2 branches covered.">        while ((line = in.readLine()) != null) {</span>
<span class="fc" id="L116">          logger.debug(line);</span>
<span class="fc" id="L117">          sb.append(line).append(System.getProperty(&quot;line.separator&quot;));</span>
        }
      }
      // wait until the task is finished
<span class="fc" id="L121">      int exitCode = encoderProcess.waitFor();</span>
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">      if (exitCode != 0) {</span>
<span class="nc" id="L123">        throw new MediaAnalyzerException(&quot;Frame analyzer &quot; + binary + &quot; exited with code &quot; + exitCode);</span>
      }
<span class="nc" id="L125">    } catch (IOException | InterruptedException e) {</span>
<span class="nc" id="L126">      logger.error(&quot;Error executing ffprobe&quot;, e);</span>
<span class="nc" id="L127">      throw new MediaAnalyzerException(&quot;Error while running &quot; + binary, e);</span>
    } finally {
<span class="fc" id="L129">      IoSupport.closeQuietly(encoderProcess);</span>
    }

<span class="fc" id="L132">    JSONParser parser = new JSONParser();</span>

    try {
<span class="fc" id="L135">      JSONObject jsonObject = (JSONObject) parser.parse(sb.toString());</span>
      Object obj;
      Double duration;

      /* Get format specific stuff */
<span class="fc" id="L140">      JSONObject jsonFormat = (JSONObject) jsonObject.get(&quot;format&quot;);</span>

      /* File Name */
<span class="fc" id="L143">      obj = jsonFormat.get(&quot;filename&quot;);</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">      if (obj != null) {</span>
<span class="fc" id="L145">        metadata.setFileName((String) obj);</span>
      }

      /* Format */
<span class="fc" id="L149">      obj = jsonFormat.get(&quot;format_long_name&quot;);</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">      if (obj != null) {</span>
<span class="fc" id="L151">        metadata.setFormat((String) obj);</span>
      }

      /*
       * Mediainfo does not return a duration if there is no stream but FFprobe will return 0. For compatibility
       * reasons, check if there are any streams before reading the duration:
       */
<span class="fc" id="L158">      obj = jsonFormat.get(&quot;nb_streams&quot;);</span>
<span class="pc bpc" id="L159" title="1 of 4 branches missed.">      if (obj != null &amp;&amp; (Long) obj &gt; 0) {</span>
<span class="fc" id="L160">        obj = jsonFormat.get(&quot;duration&quot;);</span>
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">        if (obj != null) {</span>
<span class="fc" id="L162">          duration = Double.parseDouble((String) obj) * 1000;</span>
<span class="fc" id="L163">          metadata.setDuration(duration.longValue());</span>
        }
      }

      /* File Size */
<span class="fc" id="L168">      obj = jsonFormat.get(&quot;size&quot;);</span>
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">      if (obj != null) {</span>
<span class="fc" id="L170">        metadata.setSize(Long.parseLong((String) obj));</span>
      }

      /* Bitrate */
<span class="fc" id="L174">      obj = jsonFormat.get(&quot;bit_rate&quot;);</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">      if (obj != null) {</span>
<span class="fc" id="L176">        metadata.setBitRate(Float.parseFloat((String) obj));</span>
      }

      /* Loop through streams */
      /*
       * FFprobe will return an empty stream array if there are no streams. Thus we do not need to check.
       */
<span class="fc" id="L183">      JSONArray streams = (JSONArray) jsonObject.get(&quot;streams&quot;);</span>
<span class="fc bfc" id="L184" title="All 2 branches covered.">      for (JSONObject stream : (Iterable&lt;JSONObject&gt;) streams) {</span>
        /* Check type of string */
<span class="fc" id="L186">        String codecType = (String) stream.get(&quot;codec_type&quot;);</span>

        /* Handle audio streams ----------------------------- */

<span class="fc bfc" id="L190" title="All 2 branches covered.">        if (&quot;audio&quot;.equals(codecType)) {</span>
          /* Extract audio stream metadata */
<span class="fc" id="L192">          AudioStreamMetadata aMetadata = new AudioStreamMetadata();</span>

          /* Codec */
<span class="fc" id="L195">          obj = stream.get(&quot;codec_long_name&quot;);</span>
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">          if (obj != null) {</span>
<span class="fc" id="L197">            aMetadata.setFormat((String) obj);</span>
          }

          /* Duration */
<span class="fc" id="L201">          obj = stream.get(&quot;duration&quot;);</span>
<span class="fc bfc" id="L202" title="All 2 branches covered.">          if (obj != null) {</span>
<span class="fc" id="L203">            duration = new Double((String) obj) * 1000;</span>
<span class="fc" id="L204">            aMetadata.setDuration(duration.longValue());</span>
          } else {
            /*
             * If no duration for this stream is specified assume the duration of the file for this as well.
             */
<span class="fc" id="L209">            aMetadata.setDuration(metadata.getDuration());</span>
          }

          /* Bitrate */
<span class="fc" id="L213">          obj = stream.get(&quot;bit_rate&quot;);</span>
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">          if (obj != null) {</span>
<span class="fc" id="L215">            aMetadata.setBitRate(new Float((String) obj));</span>
          }

          /* Channels */
<span class="fc" id="L219">          obj = stream.get(&quot;channels&quot;);</span>
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">          if (obj != null) {</span>
<span class="fc" id="L221">            aMetadata.setChannels(((Long) obj).intValue());</span>
          }

          /* Sample Rate */
<span class="fc" id="L225">          obj = stream.get(&quot;sample_rate&quot;);</span>
<span class="pc bpc" id="L226" title="1 of 2 branches missed.">          if (obj != null) {</span>
<span class="fc" id="L227">            aMetadata.setSamplingRate(Integer.parseInt((String) obj));</span>
          }

          /* Frame Count */
<span class="fc" id="L231">          obj = stream.get(&quot;nb_read_frames&quot;);</span>
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">          if (obj != null) {</span>
<span class="nc" id="L233">            aMetadata.setFrames(Long.parseLong((String) obj));</span>
          } else {

            /* alternate JSON element if accurate frame count is not requested from ffmpeg */
<span class="fc" id="L237">            obj = stream.get(&quot;nb_frames&quot;);</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">            if (obj != null) {</span>
<span class="fc" id="L239">              aMetadata.setFrames(Long.parseLong((String) obj));</span>
            }
          }

          /* Add video stream metadata to overall metadata */
<span class="fc" id="L244">          metadata.getAudioStreamMetadata().add(aMetadata);</span>

          /* Handle video streams ----------------------------- */

<span class="pc bpc" id="L248" title="1 of 2 branches missed.">        } else if (&quot;video&quot;.equals(codecType)) {</span>
          /* Extract video stream metadata */
<span class="fc" id="L250">          VideoStreamMetadata vMetadata = new VideoStreamMetadata();</span>

          /* Codec */
<span class="fc" id="L253">          obj = stream.get(&quot;codec_long_name&quot;);</span>
<span class="pc bpc" id="L254" title="1 of 2 branches missed.">          if (obj != null) {</span>
<span class="fc" id="L255">            vMetadata.setFormat((String) obj);</span>
          }

          /* Duration */
<span class="fc" id="L259">          obj = stream.get(&quot;duration&quot;);</span>
<span class="fc bfc" id="L260" title="All 2 branches covered.">          if (obj != null) {</span>
<span class="fc" id="L261">            duration = new Double((String) obj) * 1000;</span>
<span class="fc" id="L262">            vMetadata.setDuration(duration.longValue());</span>
          } else {
            /*
             * If no duration for this stream is specified assume the duration of the file for this as well.
             */
<span class="fc" id="L267">            vMetadata.setDuration(metadata.getDuration());</span>
          }

          /* Bitrate */
<span class="fc" id="L271">          obj = stream.get(&quot;bit_rate&quot;);</span>
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">          if (obj != null) {</span>
<span class="fc" id="L273">            vMetadata.setBitRate(new Float((String) obj));</span>
          }

          /* Width */
<span class="fc" id="L277">          obj = stream.get(&quot;width&quot;);</span>
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">          if (obj != null) {</span>
<span class="fc" id="L279">            vMetadata.setFrameWidth(((Long) obj).intValue());</span>
          }

          /* Height */
<span class="fc" id="L283">          obj = stream.get(&quot;height&quot;);</span>
<span class="pc bpc" id="L284" title="1 of 2 branches missed.">          if (obj != null) {</span>
<span class="fc" id="L285">            vMetadata.setFrameHeight(((Long) obj).intValue());</span>
          }

          /* Profile */
<span class="fc" id="L289">          obj = stream.get(&quot;profile&quot;);</span>
<span class="pc bpc" id="L290" title="1 of 2 branches missed.">          if (obj != null) {</span>
<span class="fc" id="L291">            vMetadata.setFormatProfile((String) obj);</span>
          }

          /* Aspect Ratio */
<span class="fc" id="L295">          obj = stream.get(&quot;sample_aspect_ratio&quot;);</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">          if (obj != null) {</span>
<span class="fc" id="L297">            vMetadata.setPixelAspectRatio(parseFloat((String) obj));</span>
          }

          /* Frame Rate */
<span class="fc" id="L301">          obj = stream.get(&quot;avg_frame_rate&quot;);</span>
<span class="pc bpc" id="L302" title="1 of 2 branches missed.">          if (obj != null) {</span>
<span class="fc" id="L303">            vMetadata.setFrameRate(parseFloat((String) obj));</span>
          }

          /* Frame Count */
<span class="fc" id="L307">          obj = stream.get(&quot;nb_read_frames&quot;);</span>
<span class="pc bpc" id="L308" title="1 of 2 branches missed.">          if (obj != null) {</span>
<span class="nc" id="L309">            vMetadata.setFrames(Long.parseLong((String) obj));</span>
          } else {

            /* alternate JSON element if accurate frame count is not requested from ffmpeg */
<span class="fc" id="L313">            obj = stream.get(&quot;nb_frames&quot;);</span>
<span class="fc bfc" id="L314" title="All 2 branches covered.">            if (obj != null) {</span>
<span class="fc" id="L315">              vMetadata.setFrames(Long.parseLong((String) obj));</span>
<span class="pc bpc" id="L316" title="2 of 4 branches missed.">            } else if (vMetadata.getDuration() != null &amp;&amp; vMetadata.getFrameRate() != null) {</span>
<span class="fc" id="L317">              long framesEstimation = Double.valueOf(vMetadata.getDuration() / 1000.0 * vMetadata.getFrameRate())</span>
<span class="fc" id="L318">                  .longValue();</span>
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">              if (framesEstimation &gt;= 1) {</span>
<span class="fc" id="L320">                vMetadata.setFrames(framesEstimation);</span>
              }
            }
          }

          /* Add video stream metadata to overall metadata */
<span class="fc" id="L326">          metadata.getVideoStreamMetadata().add(vMetadata);</span>

          /* Handle subtitle streams ----------------------------- */

<span class="pc bnc" id="L330" title="All 2 branches missed.">        } else if (&quot;subtitle&quot;.equals(codecType)) {</span>
          /* Extract subtitle stream metadata */
<span class="nc" id="L332">          SubtitleStreamMetadata sMetadata = new SubtitleStreamMetadata();</span>

          /* Codec */
<span class="nc" id="L335">          obj = stream.get(&quot;codec_long_name&quot;);</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">          if (obj != null) {</span>
<span class="nc" id="L337">            sMetadata.setFormat((String) obj);</span>
          }

<span class="nc" id="L340">          metadata.getSubtitleStreamMetadata().add(sMetadata);</span>
        }
<span class="fc" id="L342">      }</span>

<span class="nc" id="L344">    } catch (ParseException e) {</span>
<span class="nc" id="L345">      logger.error(&quot;Error parsing ffprobe output: {}&quot;, e.getMessage());</span>
<span class="fc" id="L346">    }</span>

<span class="fc" id="L348">    return metadata;</span>
  }

  /**
   * Allows configuration {@inheritDoc}
   *
   * @see org.opencastproject.inspection.ffmpeg.api.MediaAnalyzer#setConfig(java.util.Map)
   */
  @Override
  public void setConfig(Map&lt;String, Object&gt; config) {
<span class="pc bpc" id="L358" title="1 of 2 branches missed.">    if (config != null) {</span>
<span class="pc bpc" id="L359" title="1 of 2 branches missed.">      if (config.containsKey(FFPROBE_BINARY_CONFIG)) {</span>
<span class="fc" id="L360">        String binary = (String) config.get(FFPROBE_BINARY_CONFIG);</span>
<span class="fc" id="L361">        setBinary(binary);</span>
<span class="fc" id="L362">        logger.debug(&quot;FFmpegAnalyzer config binary: &quot; + binary);</span>
      }
    }
<span class="fc" id="L365">  }</span>

  private float parseFloat(String val) {
<span class="fc bfc" id="L368" title="All 2 branches covered.">    if (val.contains(&quot;/&quot;)) {</span>
<span class="fc" id="L369">      String[] v = val.split(&quot;/&quot;);</span>
<span class="pc bpc" id="L370" title="1 of 2 branches missed.">      if (Float.parseFloat(v[1]) == 0) {</span>
<span class="nc" id="L371">        return 0;</span>
      } else {
<span class="fc" id="L373">        return Float.parseFloat(v[0]) / Float.parseFloat(v[1]);</span>
      }
<span class="pc bpc" id="L375" title="1 of 2 branches missed.">    } else if (val.contains(&quot;:&quot;)) {</span>
<span class="fc" id="L376">      String[] v = val.split(&quot;:&quot;);</span>
<span class="pc bpc" id="L377" title="1 of 2 branches missed.">      if (Float.parseFloat(v[1]) == 0) {</span>
<span class="nc" id="L378">        return 0;</span>
      } else {
<span class="fc" id="L380">        return Float.parseFloat(v[0]) / Float.parseFloat(v[1]);</span>
      }
    } else {
<span class="nc" id="L383">      return Float.parseFloat(val);</span>
    }
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>