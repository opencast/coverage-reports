<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>PublishOaiPmhWorkflowOperationHandler.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-distribution-workflowoperation</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.workflow.handler.distribution</a> &gt; <span class="el_source">PublishOaiPmhWorkflowOperationHandler.java</span></div><h1>PublishOaiPmhWorkflowOperationHandler.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.workflow.handler.distribution;

import static org.opencastproject.mediapackage.MediaPackageSupport.Filters.ofChannel;
import static org.opencastproject.util.data.Collections.list;
import static org.opencastproject.util.data.Option.option;
import static org.opencastproject.util.data.functions.Strings.toBool;
import static org.opencastproject.util.data.functions.Strings.trimToNone;

import org.opencastproject.distribution.api.StreamingDistributionService;
import org.opencastproject.job.api.Job;
import org.opencastproject.job.api.JobContext;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.mediapackage.MediaPackageElement;
import org.opencastproject.mediapackage.MediaPackageElementFlavor;
import org.opencastproject.mediapackage.MediaPackageElementParser;
import org.opencastproject.mediapackage.MediaPackageException;
import org.opencastproject.mediapackage.Publication;
import org.opencastproject.mediapackage.PublicationImpl;
import org.opencastproject.mediapackage.selector.SimpleElementSelector;
import org.opencastproject.publication.api.OaiPmhPublicationService;
import org.opencastproject.publication.api.PublicationException;
import org.opencastproject.serviceregistry.api.ServiceRegistry;
import org.opencastproject.util.MimeType;
import org.opencastproject.util.MimeTypes;
import org.opencastproject.workflow.api.AbstractWorkflowOperationHandler;
import org.opencastproject.workflow.api.WorkflowInstance;
import org.opencastproject.workflow.api.WorkflowOperationException;
import org.opencastproject.workflow.api.WorkflowOperationHandler;
import org.opencastproject.workflow.api.WorkflowOperationResult;
import org.opencastproject.workflow.api.WorkflowOperationResult.Action;

import org.apache.commons.lang3.StringUtils;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.net.URI;
import java.util.Collection;
import java.util.HashSet;
import java.util.Optional;
import java.util.Set;
import java.util.UUID;

/**
 * The workflow definition for handling &quot;publish&quot; operations
 */
@Component(
    immediate = true,
    service = WorkflowOperationHandler.class,
    property = {
        &quot;service.description=OAI-PMH Publication Workflow Handler&quot;,
        &quot;workflow.operation=publish-oaipmh&quot;
    }
)
<span class="nc" id="L78">public class PublishOaiPmhWorkflowOperationHandler extends AbstractWorkflowOperationHandler {</span>

  /** The logging facility */
<span class="nc" id="L81">  private static final Logger logger = LoggerFactory.getLogger(PublishOaiPmhWorkflowOperationHandler.class);</span>

  /** Workflow configuration option keys */
  private static final String DOWNLOAD_FLAVORS = &quot;download-flavors&quot;;
  private static final String DOWNLOAD_TAGS = &quot;download-tags&quot;;
  private static final String STREAMING_TAGS = &quot;streaming-tags&quot;;
  private static final String STREAMING_FLAVORS = &quot;streaming-flavors&quot;;
  private static final String CHECK_AVAILABILITY = &quot;check-availability&quot;;
  private static final String REPOSITORY = &quot;repository&quot;;
  private static final String EXTERNAL_TEMPLATE = &quot;external-template&quot;;
  private static final String EXTERNAL_CHANNEL_NAME = &quot;external-channel&quot;;
  private static final String EXTERNAL_MIME_TYPE = &quot;external-mime-type&quot;;

  /** The publication service */
<span class="nc" id="L95">  private OaiPmhPublicationService publicationService = null;</span>

  /** The streaming distribution service */
<span class="nc" id="L98">  private StreamingDistributionService streamingDistributionService = null;</span>

  /**
   * Callback for the OSGi declarative services configuration.
   *
   * @param publicationService
   *          the publication service
   */
  @Reference
  public void setPublicationService(OaiPmhPublicationService publicationService) {
<span class="nc" id="L108">    this.publicationService = publicationService;</span>
<span class="nc" id="L109">  }</span>

  /**
   * Callback for the OSGi declarative services configuration.
   *
   * @param streamingDistributionService
   *          the streaming distribution service
   */
  @Reference(target = &quot;(distribution.channel=streaming)&quot;)
  protected void setStreamingDistributionService(StreamingDistributionService streamingDistributionService) {
<span class="nc" id="L119">    this.streamingDistributionService = streamingDistributionService;</span>
<span class="nc" id="L120">  }</span>

  @Reference
  @Override
  public void setServiceRegistry(ServiceRegistry serviceRegistry) {
<span class="nc" id="L125">    super.setServiceRegistry(serviceRegistry);</span>
<span class="nc" id="L126">  }</span>

  /** OSGi component activation. */
  @Override
  @Activate
  public void activate(ComponentContext cc) {
<span class="nc" id="L132">  }</span>

  @Override
  public WorkflowOperationResult start(final WorkflowInstance workflowInstance, JobContext context)
          throws WorkflowOperationException {
<span class="nc" id="L137">    logger.debug(&quot;Running distribution workflow operation&quot;);</span>

<span class="nc" id="L139">    MediaPackage mediaPackage = workflowInstance.getMediaPackage();</span>

    // Check which tags have been configured
<span class="nc" id="L142">    String downloadTags = StringUtils</span>
<span class="nc" id="L143">            .trimToEmpty(workflowInstance.getCurrentOperation().getConfiguration(DOWNLOAD_TAGS));</span>
<span class="nc" id="L144">    String downloadFlavors = StringUtils</span>
<span class="nc" id="L145">            .trimToEmpty(workflowInstance.getCurrentOperation().getConfiguration(DOWNLOAD_FLAVORS));</span>
<span class="nc" id="L146">    String streamingTags = StringUtils</span>
<span class="nc" id="L147">            .trimToEmpty(workflowInstance.getCurrentOperation().getConfiguration(STREAMING_TAGS));</span>
<span class="nc" id="L148">    String streamingFlavors = StringUtils</span>
<span class="nc" id="L149">            .trimToEmpty(workflowInstance.getCurrentOperation().getConfiguration(STREAMING_FLAVORS));</span>
<span class="nc" id="L150">    boolean checkAvailability = option(workflowInstance.getCurrentOperation().getConfiguration(CHECK_AVAILABILITY))</span>
<span class="nc" id="L151">            .bind(trimToNone).map(toBool).getOrElse(true);</span>
<span class="nc" id="L152">    String repository = StringUtils.trimToNull(workflowInstance.getCurrentOperation().getConfiguration(REPOSITORY));</span>

<span class="nc" id="L154">    Optional&lt;String&gt; externalChannel = getOptConfig(workflowInstance.getCurrentOperation(), EXTERNAL_CHANNEL_NAME);</span>
<span class="nc" id="L155">    Optional&lt;String&gt; externalTemplate = getOptConfig(workflowInstance.getCurrentOperation(), EXTERNAL_TEMPLATE);</span>
<span class="nc" id="L156">    Optional&lt;MimeType&gt; externalMimetype = getOptConfig(workflowInstance.getCurrentOperation(), EXTERNAL_MIME_TYPE)</span>
<span class="nc" id="L157">        .flatMap(MimeTypes::toMimeType);</span>

<span class="nc bnc" id="L159" title="All 2 branches missed.">    if (repository == null) {</span>
<span class="nc" id="L160">      throw new IllegalArgumentException(&quot;No repository has been specified&quot;);</span>
    }

<span class="nc" id="L163">    String[] sourceDownloadTags = StringUtils.split(downloadTags, &quot;,&quot;);</span>
<span class="nc" id="L164">    String[] sourceDownloadFlavors = StringUtils.split(downloadFlavors, &quot;,&quot;);</span>
<span class="nc" id="L165">    String[] sourceStreamingTags = StringUtils.split(streamingTags, &quot;,&quot;);</span>
<span class="nc" id="L166">    String[] sourceStreamingFlavors = StringUtils.split(streamingFlavors, &quot;,&quot;);</span>

<span class="nc bnc" id="L168" title="All 8 branches missed.">    if (sourceDownloadTags.length == 0 &amp;&amp; sourceDownloadFlavors.length == 0 &amp;&amp; sourceStreamingTags.length == 0</span>
            &amp;&amp; sourceStreamingFlavors.length == 0) {
<span class="nc" id="L170">      logger.warn(&quot;No tags or flavors have been specified, so nothing will be published to the engage&quot;);</span>
<span class="nc" id="L171">      return createResult(mediaPackage, Action.CONTINUE);</span>
    }

<span class="nc" id="L174">    final SimpleElementSelector downloadElementSelector = new SimpleElementSelector();</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">    for (String flavor : sourceDownloadFlavors) {</span>
<span class="nc" id="L176">      downloadElementSelector.addFlavor(MediaPackageElementFlavor.parseFlavor(flavor));</span>
    }
<span class="nc bnc" id="L178" title="All 2 branches missed.">    for (String tag : sourceDownloadTags) {</span>
<span class="nc" id="L179">      downloadElementSelector.addTag(tag);</span>
    }
<span class="nc" id="L181">    final Collection&lt;MediaPackageElement&gt; downloadElements = downloadElementSelector.select(mediaPackage, false);</span>

    final Collection&lt;MediaPackageElement&gt; streamingElements;
<span class="nc bnc" id="L184" title="All 4 branches missed.">    if (streamingDistributionService != null &amp;&amp; streamingDistributionService.publishToStreaming()) {</span>
<span class="nc" id="L185">      final SimpleElementSelector streamingElementSelector = new SimpleElementSelector();</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">      for (String flavor : sourceStreamingFlavors) {</span>
<span class="nc" id="L187">        streamingElementSelector.addFlavor(MediaPackageElementFlavor.parseFlavor(flavor));</span>
      }
<span class="nc bnc" id="L189" title="All 2 branches missed.">      for (String tag : sourceStreamingTags) {</span>
<span class="nc" id="L190">        streamingElementSelector.addTag(tag);</span>
      }
<span class="nc" id="L192">      streamingElements = streamingElementSelector.select(mediaPackage, false);</span>
<span class="nc" id="L193">    } else {</span>
<span class="nc" id="L194">      streamingElements = list();</span>
    }

    try {
<span class="nc" id="L198">      Set&lt;String&gt; downloadElementIds = new HashSet&lt;&gt;();</span>
<span class="nc" id="L199">      Set&lt;String&gt; streamingElementIds = new HashSet&lt;&gt;();</span>

      // Look for elements matching the tag
<span class="nc bnc" id="L202" title="All 2 branches missed.">      for (MediaPackageElement elem : downloadElements) {</span>
<span class="nc" id="L203">        downloadElementIds.add(elem.getIdentifier());</span>
<span class="nc" id="L204">      }</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">      for (MediaPackageElement elem : streamingElements) {</span>
<span class="nc" id="L206">        streamingElementIds.add(elem.getIdentifier());</span>
<span class="nc" id="L207">      }</span>

<span class="nc" id="L209">      Job publishJob = null;</span>
      try {
<span class="nc" id="L211">        publishJob = publicationService.publish(mediaPackage, repository, downloadElementIds, streamingElementIds,</span>
                checkAvailability);
<span class="nc" id="L213">      } catch (MediaPackageException e) {</span>
<span class="nc" id="L214">        throw new WorkflowOperationException(&quot;Error parsing media package&quot;, e);</span>
<span class="nc" id="L215">      } catch (PublicationException e) {</span>
<span class="nc" id="L216">        throw new WorkflowOperationException(&quot;Error parsing media package&quot;, e);</span>
<span class="nc" id="L217">      }</span>

      // Wait until the publication job has returned
<span class="nc bnc" id="L220" title="All 2 branches missed.">      if (!waitForStatus(publishJob).isSuccess()) {</span>
<span class="nc" id="L221">        throw new WorkflowOperationException(&quot;Mediapackage &quot; + mediaPackage.getIdentifier()</span>
                + &quot; could not be published to OAI-PMH repository &quot; + repository);
      }

      // The job has passed
<span class="nc" id="L226">      Job job = serviceRegistry.getJob(publishJob.getId());</span>

      // If there is no payload, then the item has not been published.
<span class="nc bnc" id="L229" title="All 2 branches missed.">      if (job.getPayload() == null) {</span>
<span class="nc" id="L230">        logger.warn(&quot;Publish to OAI-PMH repository '{}' failed, no payload from publication job: {}&quot;, repository, job);</span>
<span class="nc" id="L231">        return createResult(mediaPackage, Action.CONTINUE);</span>
      }

<span class="nc" id="L234">      Publication newElement = null;</span>
      try {
<span class="nc" id="L236">        newElement = (Publication) MediaPackageElementParser.getFromXml(job.getPayload());</span>
<span class="nc" id="L237">      } catch (MediaPackageException e) {</span>
<span class="nc" id="L238">        throw new WorkflowOperationException(e);</span>
<span class="nc" id="L239">      }</span>

<span class="nc bnc" id="L241" title="All 2 branches missed.">      if (newElement == null) {</span>
<span class="nc" id="L242">        logger.warn(</span>
            &quot;Publication to OAI-PMH repository '{}' failed, unable to parse the payload '{}' from &quot;
                + &quot;job '{}' to a mediapackage element&quot;,
<span class="nc" id="L245">            repository, job.getPayload(), job.toString());</span>
<span class="nc" id="L246">        return createResult(mediaPackage, Action.CONTINUE);</span>
      }

<span class="nc bnc" id="L249" title="All 2 branches missed.">      for (Publication existingPublication : mediaPackage.getPublications()) {</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">        if (ofChannel(newElement.getChannel()).apply(existingPublication)) {</span>
<span class="nc" id="L251">          mediaPackage.remove(existingPublication);</span>
        }
      }
<span class="nc" id="L254">      mediaPackage.add(newElement);</span>

<span class="nc bnc" id="L256" title="All 6 branches missed.">      if (externalChannel.isPresent() &amp;&amp; externalMimetype.isPresent() &amp;&amp; externalTemplate.isPresent()) {</span>
<span class="nc" id="L257">        String template = externalTemplate.get().replace(&quot;{event}&quot;, mediaPackage.getIdentifier().toString());</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">        if (StringUtils.isNotBlank(mediaPackage.getSeries())) {</span>
<span class="nc" id="L259">          template = template.replace(&quot;{series}&quot;, mediaPackage.getSeries());</span>
        }

<span class="nc" id="L262">        Publication externalElement = PublicationImpl.publication(UUID.randomUUID().toString(), externalChannel.get(),</span>
<span class="nc" id="L263">                URI.create(template), externalMimetype.get());</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">        for (Publication existingPublication : mediaPackage.getPublications()) {</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">          if (ofChannel(externalChannel.get()).apply(existingPublication)) {</span>
<span class="nc" id="L266">            mediaPackage.remove(existingPublication);</span>
          }
        }
<span class="nc" id="L269">        mediaPackage.add(externalElement);</span>
      }

<span class="nc" id="L272">      logger.debug(&quot;Publication to OAI-PMH repository '{}' operation completed&quot;, repository);</span>
<span class="nc" id="L273">    } catch (Exception e) {</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">      if (e instanceof WorkflowOperationException) {</span>
<span class="nc" id="L275">        throw (WorkflowOperationException) e;</span>
      } else {
<span class="nc" id="L277">        throw new WorkflowOperationException(e);</span>
      }
<span class="nc" id="L279">    }</span>
<span class="nc" id="L280">    return createResult(mediaPackage, Action.CONTINUE);</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>