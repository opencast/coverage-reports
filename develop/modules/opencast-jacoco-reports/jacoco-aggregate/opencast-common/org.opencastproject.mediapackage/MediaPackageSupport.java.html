<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>MediaPackageSupport.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-common</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.mediapackage</a> &gt; <span class="el_source">MediaPackageSupport.java</span></div><h1>MediaPackageSupport.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.mediapackage;

import static org.apache.commons.lang3.StringUtils.isNotBlank;
import static org.opencastproject.util.IoSupport.withResource;
import static org.opencastproject.util.data.Collections.list;
import static org.opencastproject.util.data.functions.Booleans.not;
import static org.opencastproject.util.data.functions.Options.sequenceOpt;
import static org.opencastproject.util.data.functions.Options.toOption;

import org.opencastproject.util.data.Function;
import org.opencastproject.util.data.Option;

import org.apache.commons.io.FilenameUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.InputStream;
import java.net.URI;
import java.util.Collections;
import java.util.List;
import java.util.Optional;
import java.util.function.Consumer;

/** Utility class used for media package handling. */
public final class MediaPackageSupport {
  /** Disable construction of this utility class */
  private MediaPackageSupport() {
  }

<span class="fc" id="L51">  private static final List NIL = java.util.Collections.EMPTY_LIST;</span>

  /**
   * Mode used when merging media packages.
   * &lt;p&gt;
   * &lt;ul&gt;
   * &lt;li&gt;&lt;code&gt;Merge&lt;/code&gt; assigns a new identifier in case of conflicts&lt;/li&gt;
   * &lt;li&gt;&lt;code&gt;Replace&lt;/code&gt; replaces elements in the target media package with matching identifier&lt;/li&gt;
   * &lt;li&gt;&lt;code&gt;Skip&lt;/code&gt; skips elements from the source media package with matching identifer&lt;/li&gt;
   * &lt;li&gt;&lt;code&gt;Fail&lt;/code&gt; fail in case of conflicting identifier&lt;/li&gt;
   * &lt;/ul&gt;
   */
<span class="fc" id="L63">  public enum MergeMode {</span>
<span class="fc" id="L64">    Merge, Replace, Skip, Fail</span>
  }

  /** the logging facility provided by log4j */
<span class="fc" id="L68">  private static final Logger logger = LoggerFactory.getLogger(MediaPackageSupport.class.getName());</span>

  /**
   * Merges the contents of media package located at &lt;code&gt;sourceDir&lt;/code&gt; into the media package located at
   * &lt;code&gt;targetDir&lt;/code&gt;.
   * &lt;p&gt;
   * When choosing to move the media package element into the new place instead of copying them, the source media
   * package folder will be removed afterwards.
   * &lt;/p&gt;
   *
   * @param dest
   *          the target media package directory
   * @param src
   *          the source media package directory
   * @param mode
   *          conflict resolution strategy in case of identical element identifier
   * @throws MediaPackageException
   *           if an error occurs either accessing one of the two media packages or merging them
   */
  public static MediaPackage merge(MediaPackage dest, MediaPackage src, MergeMode mode) throws MediaPackageException {
    try {
<span class="fc bfc" id="L89" title="All 2 branches covered.">      for (MediaPackageElement e : src.elements()) {</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">        if (dest.getElementById(e.getIdentifier()) == null)</span>
<span class="fc" id="L91">          dest.add(e);</span>
        else {
<span class="fc bfc" id="L93" title="All 2 branches covered.">          if (MergeMode.Replace == mode) {</span>
<span class="fc" id="L94">            logger.debug(&quot;Replacing element &quot; + e.getIdentifier() + &quot; while merging &quot; + dest + &quot; with &quot; + src);</span>
<span class="fc" id="L95">            dest.remove(dest.getElementById(e.getIdentifier()));</span>
<span class="fc" id="L96">            dest.add(e);</span>
<span class="fc bfc" id="L97" title="All 2 branches covered.">          } else if (MergeMode.Skip == mode) {</span>
<span class="fc" id="L98">            logger.debug(&quot;Skipping element &quot; + e.getIdentifier() + &quot; while merging &quot; + dest + &quot; with &quot; + src);</span>
<span class="fc" id="L99">            continue;</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">          } else if (MergeMode.Merge == mode) {</span>
<span class="fc" id="L101">            logger.debug(&quot;Renaming element &quot; + e.getIdentifier() + &quot; while merging &quot; + dest + &quot; with &quot; + src);</span>
<span class="fc" id="L102">            e.setIdentifier(null);</span>
<span class="fc" id="L103">            dest.add(e);</span>
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">          } else if (MergeMode.Fail == mode) {</span>
<span class="fc" id="L105">            throw new MediaPackageException(&quot;Target media package &quot; + dest + &quot; already contains element with id &quot;</span>
<span class="fc" id="L106">                    + e.getIdentifier());</span>
          }
        }
<span class="fc" id="L109">      }</span>
<span class="nc" id="L110">    } catch (UnsupportedElementException e) {</span>
<span class="nc" id="L111">      throw new MediaPackageException(e);</span>
<span class="fc" id="L112">    }</span>
<span class="fc" id="L113">    return dest;</span>
  }

  /**
   * Returns &lt;code&gt;true&lt;/code&gt; if the media package contains an element with the specified identifier.
   *
   * @param identifier
   *          the identifier
   * @return &lt;code&gt;true&lt;/code&gt; if the media package contains an element with this identifier
   */
  public static boolean contains(String identifier, MediaPackage mp) {
<span class="nc bnc" id="L124" title="All 2 branches missed.">    for (MediaPackageElement element : mp.getElements()) {</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">      if (element.getIdentifier().equals(identifier))</span>
<span class="nc" id="L126">        return true;</span>
    }
<span class="nc" id="L128">    return false;</span>
  }

  /**
   * Extract the file name from a media package elements URI.
   *
   * @return the file name or none if it could not be determined
   */
  public static Optional&lt;String&gt; getFileName(MediaPackageElement mpe) {
<span class="fc" id="L137">    URI uri = mpe.getURI();</span>
<span class="fc bfc" id="L138" title="All 2 branches covered.">    if (uri == null) {</span>
<span class="fc" id="L139">      return Optional.empty();</span>
    }
<span class="fc" id="L141">    String name = FilenameUtils.getName(uri.toString());</span>
<span class="pc bpc" id="L142" title="2 of 4 branches missed.">    if (name == null || name.isBlank()) {</span>
<span class="nc" id="L143">      return Optional.empty();</span>
    }
<span class="fc" id="L145">    return Optional.of(name);</span>
  }

  /**
   * Create a copy of the given media package.
   * &lt;p&gt;
   * ATTENTION: Copying changes the type of the media package elements, e.g. an element of
   * type &lt;code&gt;DublinCoreCatalog&lt;/code&gt; will become a &lt;code&gt;CatalogImpl&lt;/code&gt;.
   */
  public static MediaPackage copy(MediaPackage mp) {
<span class="fc" id="L155">    return (MediaPackage) mp.clone();</span>
  }

  /** Update a mediapackage element of a mediapackage. Mutates &lt;code&gt;mp&lt;/code&gt;. */
  public static void updateElement(MediaPackage mp, MediaPackageElement e) {
<span class="fc" id="L160">    mp.removeElementById(e.getIdentifier());</span>
<span class="fc" id="L161">    mp.add(e);</span>
<span class="fc" id="L162">  }</span>

  /** {@link #updateElement(MediaPackage, MediaPackageElement)} as en effect. */


  public static Consumer&lt;MediaPackageElement&gt; updateElement(final MediaPackage mp) {
<span class="fc" id="L168">    return e -&gt; updateElement(mp, e);</span>
  }

<span class="fc" id="L171">  public static final Function&lt;MediaPackageElement, String&gt; getMediaPackageElementId = new Function&lt;MediaPackageElement, String&gt;() {</span>
    @Override
    public String apply(MediaPackageElement mediaPackageElement) {
<span class="nc" id="L174">      return mediaPackageElement.getIdentifier();</span>
    }
  };

  /** Filters and predicates to work with media package element collections. */
  public static final class Filters {
    private Filters() {
    }

    // functions implemented for monadic bind in order to cast types

    public static &lt;A extends MediaPackageElement&gt; Function&lt;MediaPackageElement, List&lt;A&gt;&gt; byType(final Class&lt;A&gt; type) {
<span class="fc" id="L186">      return new Function&lt;MediaPackageElement, List&lt;A&gt;&gt;() {</span>
        @Override
        public List&lt;A&gt; apply(MediaPackageElement mpe) {
<span class="fc bfc" id="L189" title="All 2 branches covered.">          return type.isAssignableFrom(mpe.getClass()) ? list((A) mpe) : (List&lt;A&gt;) NIL;</span>
        }
      };
    }

    public static Function&lt;MediaPackageElement, List&lt;MediaPackageElement&gt;&gt; byFlavor(
            final MediaPackageElementFlavor flavor) {
<span class="nc" id="L196">      return new Function&lt;MediaPackageElement, List&lt;MediaPackageElement&gt;&gt;() {</span>
        @Override
        public List&lt;MediaPackageElement&gt; apply(MediaPackageElement mpe) {
          // match is commutative
<span class="nc bnc" id="L200" title="All 2 branches missed.">          return flavor.matches(mpe.getFlavor()) ? Collections.singletonList(mpe) : Collections.emptyList();</span>
        }
      };
    }

    public static &lt;A extends MediaPackageElement&gt; Function&lt;MediaPackageElement, Boolean&gt; ofType(final Class&lt;A&gt; type) {
<span class="fc" id="L206">      return new Function&lt;MediaPackageElement, Boolean&gt;() {</span>
        @Override
        public Boolean apply(MediaPackageElement mpe) {
<span class="fc" id="L209">          return type.isAssignableFrom(mpe.getClass());</span>
        }
      };
    }

<span class="fc" id="L214">    public static final Function&lt;MediaPackageElement, List&lt;Publication&gt;&gt; presentations = byType(Publication.class);</span>

<span class="fc" id="L216">    public static final Function&lt;MediaPackageElement, List&lt;Attachment&gt;&gt; attachments = byType(Attachment.class);</span>

<span class="fc" id="L218">    public static final Function&lt;MediaPackageElement, List&lt;Track&gt;&gt; tracks = byType(Track.class);</span>

<span class="fc" id="L220">    public static final Function&lt;MediaPackageElement, List&lt;Catalog&gt;&gt; catalogs = byType(Catalog.class);</span>

<span class="fc" id="L222">    public static final Function&lt;MediaPackageElement, Boolean&gt; isPublication = ofType(Publication.class);</span>

<span class="fc" id="L224">    public static final Function&lt;MediaPackageElement, Boolean&gt; isNotPublication = not(isPublication);</span>

<span class="fc" id="L226">    public static final Function&lt;MediaPackageElement, Boolean&gt; hasChecksum = new Function&lt;MediaPackageElement, Boolean&gt;() {</span>
      @Override
      public Boolean apply(MediaPackageElement e) {
<span class="fc bfc" id="L229" title="All 2 branches covered.">        return e.getChecksum() != null;</span>
      }
    };

<span class="fc" id="L233">    public static final Function&lt;MediaPackageElement, Boolean&gt; hasNoChecksum = not(hasChecksum);</span>

<span class="fc" id="L235">    public static final Function&lt;Track, Boolean&gt; hasVideo = new Function&lt;Track, Boolean&gt;() {</span>
      @Override
      public Boolean apply(Track track) {
<span class="nc" id="L238">        return track.hasVideo();</span>
      }
    };

<span class="fc" id="L242">    public static final Function&lt;Track, Boolean&gt; hasAudio = new Function&lt;Track, Boolean&gt;() {</span>
      @Override
      public Boolean apply(Track track) {
<span class="nc" id="L245">        return track.hasAudio();</span>
      }
    };

<span class="fc" id="L249">    public static final Function&lt;Track, Boolean&gt; hasNoVideo = not(hasVideo);</span>

<span class="fc" id="L251">    public static final Function&lt;Track, Boolean&gt; hasNoAudio = not(hasAudio);</span>

    /** Filters publications to channel &lt;code&gt;channelId&lt;/code&gt;. */
    public static Function&lt;Publication, Boolean&gt; ofChannel(final String channelId) {
<span class="nc" id="L255">      return new Function&lt;Publication, Boolean&gt;() {</span>
        @Override
        public Boolean apply(Publication p) {
<span class="nc" id="L258">          return p.getChannel().equals(channelId);</span>
        }
      };
    }

    /** Check if mediapackage element has any of the given tags. */
    public static Function&lt;MediaPackageElement, Boolean&gt; hasTagAny(final List&lt;String&gt; tags) {
<span class="fc" id="L265">      return new Function&lt;MediaPackageElement, Boolean&gt;() {</span>
        @Override
        public Boolean apply(MediaPackageElement mpe) {
<span class="fc" id="L268">          return mpe.containsTag(tags);</span>
        }
      };
    }

    /**
     * Return true if the element has a flavor that matches &lt;code&gt;flavor&lt;/code&gt;.
     *
     * @see MediaPackageElementFlavor#matches(MediaPackageElementFlavor)
     */
    public static Function&lt;MediaPackageElement, Boolean&gt; matchesFlavor(final MediaPackageElementFlavor flavor) {
<span class="fc" id="L279">      return new Function&lt;MediaPackageElement, Boolean&gt;() {</span>
        @Override
        public Boolean apply(MediaPackageElement mpe) {
          // match is commutative
<span class="fc" id="L283">          return flavor.matches(mpe.getFlavor());</span>
        }
      };
    }

<span class="fc" id="L288">    public static final Function&lt;MediaPackageElementFlavor, Function&lt;MediaPackageElement, Boolean&gt;&gt; matchesFlavor = new Function&lt;MediaPackageElementFlavor, Function&lt;MediaPackageElement, Boolean&gt;&gt;() {</span>
      @Override
      public Function&lt;MediaPackageElement, Boolean&gt; apply(final MediaPackageElementFlavor flavor) {
<span class="fc" id="L291">        return matchesFlavor(flavor);</span>
      }
    };

<span class="fc" id="L295">    public static final Function&lt;MediaPackageElement, Boolean&gt; isEpisodeDublinCore = new Function&lt;MediaPackageElement, Boolean&gt;() {</span>
      @Override
      public Boolean apply(MediaPackageElement mpe) {
        // match is commutative
<span class="fc" id="L299">        return MediaPackageElements.EPISODE.matches(mpe.getFlavor());</span>
      }
    };

<span class="fc" id="L303">    public static final Function&lt;MediaPackageElement, Boolean&gt; isSmilCatalog = new Function&lt;MediaPackageElement, Boolean&gt;() {</span>
      @Override
      public Boolean apply(MediaPackageElement mpe) {
        // match is commutative
<span class="fc" id="L307">        return MediaPackageElements.SMIL.matches(mpe.getFlavor());</span>
      }
    };
  }

  /**
   * Basic sanity checking for media packages.
   *
   * &lt;pre&gt;
   * // media package is ok
   * sanityCheck(mp).isNone()
   * &lt;/pre&gt;
   *
   * @return none if the media package is a healthy condition, some([error_msgs]) otherwise
   */
  public static Option&lt;List&lt;String&gt;&gt; sanityCheck(MediaPackage mp) {
<span class="pc bpc" id="L323" title="1 of 2 branches missed.">    final Option&lt;List&lt;String&gt;&gt; errors = sequenceOpt(list(toOption(mp.getIdentifier() != null, &quot;no ID&quot;),</span>
<span class="pc bpc" id="L324" title="1 of 4 branches missed.">            toOption(mp.getIdentifier() != null &amp;&amp; isNotBlank(mp.getIdentifier().toString()), &quot;blank ID&quot;)));</span>
<span class="fc bfc" id="L325" title="All 2 branches covered.">    return errors.getOrElse(NIL).size() == 0 ? Option.&lt;List&lt;String&gt;&gt; none() : errors;</span>
  }

  /** To be used in unit tests. */
  public static MediaPackage loadFromClassPath(String path) {
<span class="fc" id="L330">    return withResource(MediaPackageSupport.class.getResourceAsStream(path),</span>
<span class="fc" id="L331">            new Function.X&lt;InputStream, MediaPackage&gt;() {</span>
              @Override
              public MediaPackage xapply(InputStream is) throws MediaPackageException {
<span class="fc" id="L334">                return MediaPackageBuilderFactory.newInstance().newMediaPackageBuilder().loadFromXml(is);</span>
              }
            });
  }

  /**
   * Function to extract the ID of a media package.
   */
  @Deprecated
<span class="fc" id="L343">  public static final Function&lt;MediaPackage, String&gt; getId = new Function&lt;MediaPackage, String&gt;() {</span>
    @Override
    public String apply(MediaPackage mp) {
<span class="nc" id="L346">      return mp.getIdentifier().toString();</span>
    }
  };

  /** Functions on media packages. */
  public static final class Fn {
    private Fn() {
    }

  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>