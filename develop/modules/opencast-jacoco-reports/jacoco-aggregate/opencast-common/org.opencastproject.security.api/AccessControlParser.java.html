<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AccessControlParser.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-common</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.security.api</a> &gt; <span class="el_source">AccessControlParser.java</span></div><h1>AccessControlParser.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.security.api;

import static org.opencastproject.util.data.functions.Misc.chuck;

import org.opencastproject.util.XmlSafeParser;

import org.apache.commons.io.IOUtils;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;

import java.io.IOException;
import java.io.InputStream;
import java.io.StringWriter;
import java.io.Writer;
import java.util.List;

import javax.xml.bind.JAXBContext;
import javax.xml.bind.JAXBException;
import javax.xml.bind.Marshaller;
import javax.xml.bind.Unmarshaller;

/**
 * Marshals and unmarshals {@link AccessControlList}s to/from XML.
 */
public final class AccessControlParser {
  /** Role constant used in JSON formatted access control entries */
  public static final String ROLE = &quot;role&quot;;

  /** Action constant used in JSON formatted access control entries */
  public static final String ACTION = &quot;action&quot;;

  /** Allow constant used in JSON formatted access control entries */
  public static final String ALLOW = &quot;allow&quot;;

  /** ACL constant used in JSON formatted access control entries */
  public static final String ACL = &quot;acl&quot;;

  /** ACE constant used in JSON formatted access control entries */
  public static final String ACE = &quot;ace&quot;;

  /** Encoding expected from all inputs */
  public static final String ENCODING = &quot;UTF-8&quot;;

  private static final JAXBContext jaxbContext;

  static {
    try {
<span class="fc" id="L71">      jaxbContext = JAXBContext.newInstance(&quot;org.opencastproject.security.api&quot;,</span>
<span class="fc" id="L72">              AccessControlParser.class.getClassLoader());</span>
<span class="nc" id="L73">    } catch (JAXBException e) {</span>
<span class="nc" id="L74">      throw new IllegalStateException(e);</span>
<span class="fc" id="L75">    }</span>
<span class="fc" id="L76">  }</span>

  /**
   * Disallow construction of this utility class.
   */
  private AccessControlParser() {
  }

  /**
   * Parses a string into an ACL.
   *
   * @param serializedForm
   *          the string containing the xml or json formatted access control list.
   * @return the access control list
   * @throws IOException
   *           if the encoding is invalid
   * @throws AccessControlParsingException
   *           if the format is invalid
   */
  public static AccessControlList parseAcl(String serializedForm) throws IOException, AccessControlParsingException {
    // Determine whether to parse this as XML or JSON
<span class="fc bfc" id="L97" title="All 2 branches covered.">    if (serializedForm.startsWith(&quot;{&quot;)) {</span>
<span class="fc" id="L98">      return parseJson(serializedForm);</span>
    } else {
<span class="fc" id="L100">      return parseXml(IOUtils.toInputStream(serializedForm, ENCODING));</span>
    }
  }

  /** Same like {@link #parseAcl(String)} but throws runtime exceptions in case of an error. */
  public static AccessControlList parseAclSilent(String serializedForm) {
    try {
<span class="fc" id="L107">      return parseAcl(serializedForm);</span>
<span class="nc" id="L108">    } catch (Exception e) {</span>
<span class="nc" id="L109">      return chuck(e);</span>
    }
  }

  /**
   * Unmarshals an ACL from an xml input stream.
   *
   * @param in
   *          the xml input stream
   * @return the acl
   * @throws IOException
   *           if there is a problem unmarshaling the stream
   * @throws AccessControlParsingException
   *           if the format is invalid
   */
  public static AccessControlList parseAcl(InputStream in) throws IOException, AccessControlParsingException {
<span class="fc" id="L125">    return parseAcl(IOUtils.toString(in, ENCODING));</span>
  }

  /**
   * Parses a JSON stream to an ACL.
   *
   * @param content
   *          the JSON stream
   * @return the access control list
   * @throws AccessControlParsingException
   *           if the json is not properly formatted
   */
  private static AccessControlList parseJson(String content) throws AccessControlParsingException {
    try {
<span class="fc" id="L139">      AccessControlList acl = new AccessControlList();</span>
<span class="fc" id="L140">      JSONObject json = (JSONObject) new JSONParser().parse(content);</span>
<span class="fc" id="L141">      JSONObject jsonAcl = (JSONObject) json.get(ACL);</span>
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">      if (jsonAcl == null) {</span>
<span class="nc" id="L143">        return acl;</span>
      }
<span class="fc" id="L145">      Object jsonAceObj = jsonAcl.get(ACE);</span>

<span class="pc bpc" id="L147" title="1 of 2 branches missed.">      if (jsonAceObj == null)</span>
<span class="nc" id="L148">        return acl;</span>

<span class="fc bfc" id="L150" title="All 2 branches covered.">      if (jsonAceObj instanceof JSONObject) {</span>
<span class="fc" id="L151">        JSONObject jsonAce = (JSONObject) jsonAceObj;</span>
<span class="fc" id="L152">        acl.getEntries().add(getAce(jsonAce));</span>
<span class="fc" id="L153">      } else {</span>
<span class="fc" id="L154">        JSONArray jsonAceArray = (JSONArray) jsonAceObj;</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">        for (Object element : jsonAceArray) {</span>
<span class="fc" id="L156">          JSONObject jsonAce = (JSONObject) element;</span>
<span class="fc" id="L157">          acl.getEntries().add(getAce(jsonAce));</span>
<span class="fc" id="L158">        }</span>
      }
<span class="fc" id="L160">      return acl;</span>
<span class="fc" id="L161">    } catch (ParseException e) {</span>
<span class="fc" id="L162">      throw new AccessControlParsingException(e);</span>
    }
  }

  /**
   * Converts a JSON representation of an access control entry to an {@link AccessControlEntry}.
   *
   * @param jsonAce
   *          the json object
   * @return the access control entry
   */
  private static AccessControlEntry getAce(JSONObject jsonAce) {
<span class="fc" id="L174">    String role = (String) jsonAce.get(ROLE);</span>
<span class="fc" id="L175">    String action = (String) jsonAce.get(ACTION);</span>
<span class="fc" id="L176">    Boolean allow = (Boolean) jsonAce.getOrDefault(ALLOW, Boolean.TRUE);</span>
<span class="fc" id="L177">    return new AccessControlEntry(role, action, allow);</span>
  }

  /**
   * Parses an XML stream to an ACL.
   *
   * @param in
   *          the XML stream
   * @throws IOException
   *           if there is a problem unmarshaling the stream
   */
  private static AccessControlList parseXml(InputStream in) throws IOException, AccessControlParsingException {
    Unmarshaller unmarshaller;
    try {
<span class="fc" id="L191">      unmarshaller = jaxbContext.createUnmarshaller();</span>
<span class="fc" id="L192">      return unmarshaller.unmarshal(XmlSafeParser.parse(in), AccessControlList.class).getValue();</span>
<span class="fc" id="L193">    } catch (Exception e) {</span>
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">      if (e instanceof IOException) {</span>
<span class="nc" id="L195">        throw (IOException) e;</span>
      } else {
<span class="fc" id="L197">        throw new AccessControlParsingException(e);</span>
      }
    } finally {
<span class="fc" id="L200">      IOUtils.closeQuietly(in);</span>
    }
  }

  /**
   * Serializes an AccessControlList to its XML form.
   *
   * @param acl
   *          the access control list
   * @return the xml as a string
   * @throws IOException
   *           if there is a problem marshaling the xml
   */
  public static String toXml(AccessControlList acl) throws IOException {
    try {
<span class="fc" id="L215">      Marshaller marshaller = jaxbContext.createMarshaller();</span>
<span class="fc" id="L216">      Writer writer = new StringWriter();</span>
<span class="fc" id="L217">      marshaller.marshal(acl, writer);</span>
<span class="fc" id="L218">      return writer.toString();</span>
<span class="nc" id="L219">    } catch (JAXBException e) {</span>
<span class="nc" id="L220">      throw new IOException(e);</span>
    }
  }

  @SuppressWarnings(&quot;unchecked&quot;)
  public static String toJson(AccessControlList acl) throws IOException {
<span class="fc" id="L226">    JSONObject json = new JSONObject();</span>
<span class="fc" id="L227">    JSONObject jsonAcl = new JSONObject();</span>
<span class="fc" id="L228">    List&lt;AccessControlEntry&gt; entries = acl.getEntries();</span>
<span class="fc bfc" id="L229" title="All 2 branches covered.">    if (entries.size() &gt; 0) {</span>
<span class="fc" id="L230">      JSONArray jsonEntryArray = new JSONArray();</span>
<span class="fc" id="L231">      jsonAcl.put(ACE, jsonEntryArray);</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">      for (AccessControlEntry entry : entries) {</span>
<span class="fc" id="L233">        JSONObject jsonEntry = new JSONObject();</span>
<span class="fc" id="L234">        jsonEntry.put(ACTION, entry.getAction());</span>
<span class="fc" id="L235">        jsonEntry.put(ROLE, entry.getRole());</span>
<span class="fc" id="L236">        jsonEntry.put(ALLOW, entry.isAllow());</span>
<span class="fc" id="L237">        jsonEntryArray.add(jsonEntry);</span>
<span class="fc" id="L238">      }</span>
    }
<span class="fc" id="L240">    json.put(ACL, jsonAcl);</span>
<span class="fc" id="L241">    return json.toJSONString();</span>
  }

  public static String toJsonSilent(AccessControlList acl) {
    try {
<span class="fc" id="L246">      return toJson(acl);</span>
<span class="nc" id="L247">    } catch (IOException e) {</span>
<span class="nc" id="L248">      return chuck(e);</span>
    }
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>