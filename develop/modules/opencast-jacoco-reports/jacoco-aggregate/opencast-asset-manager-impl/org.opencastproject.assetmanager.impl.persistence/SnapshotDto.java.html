<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SnapshotDto.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-asset-manager-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.assetmanager.impl.persistence</a> &gt; <span class="el_source">SnapshotDto.java</span></div><h1>SnapshotDto.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.assetmanager.impl.persistence;

import static org.opencastproject.util.data.functions.Functions.chuck;

import org.opencastproject.assetmanager.api.Availability;
import org.opencastproject.assetmanager.api.Snapshot;
import org.opencastproject.assetmanager.impl.SnapshotImpl;
import org.opencastproject.assetmanager.impl.VersionImpl;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.mediapackage.MediaPackageElement;
import org.opencastproject.mediapackage.MediaPackageParser;

import org.eclipse.persistence.annotations.CascadeOnDelete;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Arrays;
import java.util.Date;
import java.util.Set;
import java.util.function.Function;

import javax.persistence.CascadeType;
import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.EntityManager;
import javax.persistence.FetchType;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Index;
import javax.persistence.Lob;
import javax.persistence.NamedQueries;
import javax.persistence.NamedQuery;
import javax.persistence.OneToMany;
import javax.persistence.Table;
import javax.persistence.TableGenerator;
import javax.persistence.Temporal;
import javax.persistence.TemporalType;
import javax.persistence.TypedQuery;
import javax.persistence.UniqueConstraint;

/** JPA DTO. */
@Entity(name = &quot;Snapshot&quot;)
@Table(name = &quot;oc_assets_snapshot&quot;, indexes = {
    @Index(name = &quot;IX_oc_assets_snapshot_archival_date&quot;, columnList = (&quot;archival_date&quot;)),
    @Index(name = &quot;IX_oc_assets_snapshot_mediapackage_id&quot;, columnList = (&quot;mediapackage_id&quot;)),
    @Index(name = &quot;IX_oc_assets_snapshot_organization_id&quot;, columnList = (&quot;organization_id&quot;)),
    @Index(name = &quot;IX_oc_assets_snapshot_owner&quot;, columnList = (&quot;owner&quot;)),
    @Index(name = &quot;IX_oc_assets_snapshot_series&quot;, columnList = (&quot;series_id, version&quot;))
    }, uniqueConstraints = {
    @UniqueConstraint(columnNames = {&quot;mediapackage_id&quot;, &quot;version&quot;}) })
@NamedQueries({
        @NamedQuery(name = &quot;Snapshot.countOrgEvents&quot;, query = &quot;select count(distinct s.mediaPackageId) from Snapshot s &quot;
                + &quot;where s.organizationId = :organizationId&quot;),
        @NamedQuery(name = &quot;Snapshot.countEvents&quot;, query = &quot;select count(distinct s.mediaPackageId) from Snapshot s&quot;),
        @NamedQuery(name = &quot;Snapshot.countByMediaPackage&quot;, query = &quot;select count(s) from Snapshot s &quot;
                + &quot;where s.mediaPackageId = :mediaPackageId&quot;),
        @NamedQuery(name = &quot;Snapshot.countByMediaPackageAndOrg&quot;, query = &quot;select count(s) from Snapshot s &quot;
                + &quot;where s.mediaPackageId = :mediaPackageId and s.organizationId = :organizationId&quot;),
        @NamedQuery(
            name = &quot;Snapshot.findByMpIdAndVersionOrderByVersionDesc&quot;,
            query = &quot;SELECT s FROM Snapshot s &quot;
                + &quot;WHERE s.mediaPackageId = :mpId &quot;
                + &quot;AND s.version = :version &quot;
                + &quot;ORDER BY s.version DESC&quot;
        ),
        @NamedQuery(
            name = &quot;Snapshot.findLatest&quot;,
            query = &quot;SELECT s FROM Snapshot s &quot;
                + &quot;WHERE s.mediaPackageId = :mediaPackageId &quot;
                + &quot;AND (:organizationId IS NULL OR s.organizationId = :organizationId) &quot;
                + &quot;AND s.version = ( &quot;
                + &quot;  SELECT MAX(s2.version) FROM Snapshot s2 WHERE s2.mediaPackageId = s.mediaPackageId &quot;
                + &quot;)&quot;
        ),
        @NamedQuery(
            name = &quot;Snapshot.findLatestVersionFirst&quot;,
            query = &quot;SELECT s FROM Snapshot s &quot;
                + &quot;WHERE s.mediaPackageId = :mediaPackageId &quot;
                + &quot;AND (:organizationId IS NULL OR s.organizationId = :organizationId) &quot;
                + &quot;ORDER BY s.version DESC&quot;
        ),
        @NamedQuery(
            name = &quot;Snapshot.findOldestVersionFirst&quot;,
            query = &quot;SELECT s FROM Snapshot s &quot;
                + &quot;WHERE s.mediaPackageId = :mediaPackageId &quot;
                + &quot;AND (:organizationId IS NULL OR s.organizationId = :organizationId) &quot;
                + &quot;ORDER BY s.version ASC&quot;
        ),
        @NamedQuery(
            name = &quot;Snapshot.findByMpIdAndVersion&quot;,
            query = &quot;SELECT s FROM Snapshot s &quot;
                + &quot;WHERE s.mediaPackageId = :mediaPackageId &quot;
                + &quot;AND (:organizationId IS NULL OR s.organizationId = :organizationId) &quot;
                + &quot;AND s.version = :version&quot;
        ),
        @NamedQuery(
            name = &quot;Snapshot.findByDateOrderByMpId&quot;,
            query = &quot;SELECT s FROM Snapshot s &quot;
                + &quot;WHERE s.archivalDate BETWEEN :startDate AND :endDate &quot;
                + &quot;AND (:organizationId IS NULL OR s.organizationId = :organizationId) &quot;
                + &quot;ORDER BY s.mediaPackageId ASC&quot;
        ),
        @NamedQuery(
            name = &quot;Snapshot.findByMpIdAndDate&quot;,
            query = &quot;SELECT s FROM Snapshot s &quot;
                + &quot;WHERE s.mediaPackageId = :mediaPackageId &quot;
                + &quot;AND s.archivalDate BETWEEN :startDate AND :endDate &quot;
                + &quot;AND (:organizationId IS NULL OR s.organizationId = :organizationId) &quot;
        ),
        @NamedQuery(
            name = &quot;Snapshot.findByMpIdAndDateLatestVersionFirst&quot;,
            query = &quot;SELECT s FROM Snapshot s &quot;
                + &quot;WHERE s.mediaPackageId = :mediaPackageId &quot;
                + &quot;AND s.archivalDate BETWEEN :startDate AND :endDate &quot;
                + &quot;AND (:organizationId IS NULL OR s.organizationId = :organizationId) &quot;
                + &quot;ORDER BY s.version DESC&quot;
        ),
        @NamedQuery(
            name = &quot;Snapshot.findByMpIdAndDateOldestVersionFirst&quot;,
            query = &quot;SELECT s FROM Snapshot s &quot;
                + &quot;WHERE s.mediaPackageId = :mediaPackageId &quot;
                + &quot;AND s.archivalDate BETWEEN :startDate AND :endDate &quot;
                + &quot;AND (:organizationId IS NULL OR s.organizationId = :organizationId) &quot;
                + &quot;ORDER BY s.version ASC&quot;
        ),
        @NamedQuery(
            name = &quot;Snapshot.findByNotStorageAndDate&quot;,
            query = &quot;SELECT s FROM Snapshot s &quot;
                + &quot;WHERE s.storageId != :storageId &quot;
                + &quot;AND s.archivalDate BETWEEN :startDate AND :endDate &quot;
                + &quot;AND (:organizationId IS NULL OR s.organizationId = :organizationId)&quot;
        ),
        @NamedQuery(
            name = &quot;Snapshot.findForIndexRebuild&quot;,
            query = &quot;SELECT s FROM Snapshot s &quot;
                + &quot;WHERE s.version = ( &quot;
                + &quot;  SELECT MAX(s2.version) FROM Snapshot s2 &quot;
                + &quot;  WHERE s2.mediaPackageId = s.mediaPackageId &quot;
                + &quot;) &quot;
                + &quot;ORDER BY s.mediaPackageId DESC &quot;
        ),
        @NamedQuery(
            name = &quot;Snapshot.delete&quot;,
            query = &quot;DELETE FROM Snapshot s &quot;
                + &quot;WHERE s.mediaPackageId = :mediaPackageId &quot;
                + &quot;AND (:organizationId IS NULL OR s.organizationId = :organizationId) &quot;
        ),
        @NamedQuery(
            name = &quot;Snapshot.deleteAllButLatest&quot;,
            query = &quot;DELETE FROM Snapshot s &quot;
                + &quot;WHERE s.mediaPackageId = :mediaPackageId &quot;
                + &quot;AND (:organizationId IS NULL OR s.organizationId = :organizationId) &quot;
                + &quot;AND s.version &lt; ( &quot;
                + &quot;  SELECT MAX(s2.version) FROM Snapshot s2 WHERE s2.mediaPackageId = :mediaPackageId &quot;
                + &quot;) &quot;
        ),
        @NamedQuery(
            name = &quot;Snapshot.findLatestBySeriesId&quot;,
            query = &quot;SELECT s FROM Snapshot s &quot;
                + &quot;WHERE s.seriesId = :seriesId &quot;
                + &quot;AND (:organizationId IS NULL OR s.organizationId = :organizationId) &quot;
                + &quot;AND s.version = ( &quot;
                + &quot;  SELECT MAX(s2.version) FROM Snapshot s2 WHERE s2.mediaPackageId = s.mediaPackageId &quot;
                + &quot;)&quot;
        ),
        @NamedQuery(
            name = &quot;Snapshot.findLatestByMpIds&quot;,
            query = &quot;SELECT s FROM Snapshot s &quot;
                + &quot;WHERE s.mediaPackageId IN :mediaPackageIds &quot;
                + &quot;AND (:organizationId IS NULL OR s.organizationId = :organizationId) &quot;
                + &quot;AND s.version = ( &quot;
                + &quot;  SELECT MAX(s2.version) FROM Snapshot s2 WHERE s2.mediaPackageId = s.mediaPackageId &quot;
                + &quot;) &quot;
        ),
        @NamedQuery(
            name = &quot;Snapshot.findByMpIdOrgIdAndVersion&quot;,
            query = &quot;SELECT s FROM Snapshot s &quot;
                + &quot;WHERE s.mediaPackageId = :mediaPackageId &quot;
                + &quot;AND s.organizationId = :organizationId &quot;
                + &quot;AND s.version = :version &quot;
        ),
        @NamedQuery(
            name = &quot;Snapshot.countSnapshots&quot;,
            query = &quot;SELECT COUNT(s) FROM Snapshot s &quot;
                + &quot;WHERE (:organizationId IS NULL OR s.organizationId = :organizationId)&quot;
        ),
        @NamedQuery(
            name = &quot;Snapshot.updateStorageIdByVersionAndMpId&quot;,
            query = &quot;UPDATE Snapshot s SET s.storageId = :storageId &quot;
                + &quot;WHERE s.version = :version &quot;
                + &quot;AND s.mediaPackageId = :mediaPackageId&quot;
        ),
        @NamedQuery(
            name = &quot;Snapshot.updateAvailabilityByVersionAndMpId&quot;,
            query = &quot;UPDATE Snapshot s SET s.availability = :availability &quot;
                + &quot;WHERE s.version = :version &quot;
                + &quot;AND s.mediaPackageId = :mediaPackageId&quot;
        ),
        @NamedQuery(
          name = &quot;Snapshot.getSnapshotVersions&quot;,
          query = &quot;SELECT s.version FROM Snapshot s &quot;
                + &quot;WHERE s.mediaPackageId = :mediaPackageId &quot;
                + &quot;AND (:organizationId IS NULL OR s.organizationId = :organizationId) &quot;
                + &quot;ORDER BY s.version ASC&quot;
        ),
})
// Maintain own generator to support database migrations from Archive to AssetManager
// The generator's initial value has to be set after the data migration.
// Otherwise duplicate key errors will most likely happen.
@TableGenerator(name = &quot;seq_oc_assets_snapshot&quot;, initialValue = 0, allocationSize = 50)
<span class="fc" id="L232">public class SnapshotDto {</span>
<span class="fc" id="L233">  private static final Logger logger = LoggerFactory.getLogger(SnapshotDto.class);</span>

  @Id
  @Column(name = &quot;id&quot;)
  @GeneratedValue(strategy = GenerationType.TABLE, generator = &quot;seq_oc_assets_snapshot&quot;)
  private Long id;

  @Column(name = &quot;mediapackage_id&quot;, length = 128, nullable = false)
  private String mediaPackageId;

  @Column(name = &quot;version&quot;, nullable = false)
  private Long version;

  @Column(name = &quot;series_id&quot;, length = 128)
  private String seriesId;

  @Column(name = &quot;organization_id&quot;, length = 128, nullable = false)
  private String organizationId;

  @Column(name = &quot;archival_date&quot;, nullable = false)
  @Temporal(TemporalType.TIMESTAMP)
  private Date archivalDate;

  @Column(name = &quot;availability&quot;, nullable = false, length = 32)
  private String availability;

  @Column(name = &quot;storage_id&quot;, nullable = false, length = 256)
  private String storageId;

  @Column(name = &quot;owner&quot;, nullable = false, length = 256)
  private String owner;

  @Lob
  @Column(name = &quot;mediapackage_xml&quot;, length = 65535, nullable = false)
  private String mediaPackageXml;

  @CascadeOnDelete
  @OneToMany(targetEntity = AssetDto.class, fetch = FetchType.LAZY, cascade = CascadeType.ALL, mappedBy = &quot;snapshot&quot;)
  private Set&lt;AssetDto&gt; assets;

  public static SnapshotDto mk(
          MediaPackage mediaPackage,
          VersionImpl version,
          String organization,
          Date archivalDate,
          Availability availability,
          String storageId,
          String owner) {
    try {
<span class="fc" id="L282">      final SnapshotDto dto = new SnapshotDto();</span>
<span class="fc" id="L283">      dto.mediaPackageId = mediaPackage.getIdentifier().toString();</span>
<span class="fc" id="L284">      dto.version = version.value();</span>
<span class="fc" id="L285">      dto.seriesId = mediaPackage.getSeries();</span>
<span class="fc" id="L286">      dto.organizationId = organization;</span>
<span class="fc" id="L287">      dto.archivalDate = archivalDate;</span>
<span class="fc" id="L288">      dto.mediaPackageXml = MediaPackageParser.getAsXml(mediaPackage);</span>
<span class="fc" id="L289">      dto.availability = availability.name();</span>
<span class="fc" id="L290">      dto.storageId = storageId;</span>
<span class="fc" id="L291">      dto.owner = owner;</span>
<span class="fc" id="L292">      return dto;</span>
<span class="nc" id="L293">    } catch (Exception e) {</span>
<span class="nc" id="L294">      return chuck(e);</span>
    }
  }

  public static SnapshotDto mk(Snapshot snapshot) {
    try {
<span class="nc" id="L300">      return mk(snapshot.getMediaPackage(),</span>
<span class="nc" id="L301">              VersionImpl.mk(Long.parseLong(snapshot.getVersion().toString())),</span>
<span class="nc" id="L302">              snapshot.getOrganizationId(),</span>
<span class="nc" id="L303">              snapshot.getArchivalDate(),</span>
<span class="nc" id="L304">              snapshot.getAvailability(),</span>
<span class="nc" id="L305">              snapshot.getStorageId(),</span>
<span class="nc" id="L306">              snapshot.getOwner());</span>
<span class="nc" id="L307">    } catch (Exception e) {</span>
<span class="nc" id="L308">      return chuck(e);</span>
    }
  }

  public Long getId() {
<span class="nc" id="L313">    return Database.insidePersistenceContextCheck(id);</span>
  }

  public VersionImpl getVersion() {
<span class="fc" id="L317">    return Conversions.toVersion(version);</span>
  }

  public String getMediaPackageId() {
<span class="fc" id="L321">    return mediaPackageId;</span>
  }

  public String getStorageId() {
<span class="fc" id="L325">    return storageId;</span>
  }

  public String getOrganizationId() {
<span class="fc" id="L329">    return organizationId;</span>
  }

  public String getAvailability() {
<span class="fc" id="L333">    return availability;</span>
  }

  public String getOwner() {
<span class="fc" id="L337">    return owner;</span>
  }

  void setAvailability(Availability a) {
<span class="nc" id="L341">    this.availability = a.name();</span>
<span class="nc" id="L342">  }</span>

  void setStorageId(String id) {
<span class="nc" id="L345">    this.storageId = id;</span>
<span class="nc" id="L346">  }</span>

  public boolean addAsset(AssetDto asset) {
<span class="nc" id="L349">    return this.assets.add(asset);</span>
  }

  public boolean removeAsset(AssetDto asset) {
<span class="nc" id="L353">    return this.assets.remove(asset);</span>
  }

  public Snapshot toSnapshot() {
<span class="fc" id="L357">    MediaPackage mediaPackage = Conversions.toMediaPackage(mediaPackageXml);</span>
    // ensure elements are tagged `archive`
<span class="fc bfc" id="L359" title="All 2 branches covered.">    for (MediaPackageElement element: mediaPackage.getElements()) {</span>
<span class="pc bpc" id="L360" title="1 of 2 branches missed.">      if (!Arrays.asList(element.getTags()).contains(&quot;archive&quot;)) {</span>
<span class="fc" id="L361">        logger.debug(&quot;Adding additional tag `archive` to element {} retrieved from asset manager&quot;, element);</span>
<span class="fc" id="L362">        element.addTag(&quot;archive&quot;);</span>
      }
    }
<span class="fc" id="L365">    return new SnapshotImpl(</span>
            id,
<span class="fc" id="L367">            Conversions.toVersion(version),</span>
            organizationId,
            archivalDate,
<span class="fc" id="L370">            Availability.valueOf(availability),</span>
            storageId,
            owner,
            mediaPackage);
  }

  /**
   * Check if any snapshot with the given media package exists.
   *
   * @param mediaPackageId
   *          The media package identifier to check for
   * @return If a snapshot exists for the given media package
   */
  public static Function&lt;EntityManager, Boolean&gt; existsQuery(final String mediaPackageId) {
<span class="fc" id="L384">    return existsQuery(mediaPackageId, null);</span>
  }

  /**
   * Check if any snapshot with the given media package exists.
   *
   * @param mediaPackageId
   *          The media package identifier to check for
   * @param organization
   *          An organization to limit the check for
   * @return If a snapshot exists for the given media package
   */
  public static Function&lt;EntityManager, Boolean&gt; existsQuery(final String mediaPackageId, final String organization) {
<span class="fc" id="L397">    return em -&gt; {</span>
      TypedQuery&lt;Long&gt; query;
<span class="fc bfc" id="L399" title="All 2 branches covered.">      if (organization == null) {</span>
<span class="fc" id="L400">        query = em.createNamedQuery(&quot;Snapshot.countByMediaPackage&quot;, Long.class)</span>
<span class="fc" id="L401">            .setParameter(&quot;mediaPackageId&quot;, mediaPackageId);</span>
      } else {
<span class="fc" id="L403">        query = em.createNamedQuery(&quot;Snapshot.countByMediaPackageAndOrg&quot;, Long.class)</span>
<span class="fc" id="L404">            .setParameter(&quot;mediaPackageId&quot;, mediaPackageId)</span>
<span class="fc" id="L405">            .setParameter(&quot;organizationId&quot;, organization);</span>
      }
<span class="fc" id="L407">      logger.debug(&quot;Executing query {}&quot;, query);</span>
<span class="fc bfc" id="L408" title="All 2 branches covered.">      return query.getSingleResult() &gt; 0;</span>
    };
  }

  /**
   * Count events with snapshots in the asset manager
   *
   * @param organization
   *          An organization to count in
   * @return Number of events
   */
  public static Function&lt;EntityManager, Long&gt; countEventsQuery(final String organization) {
<span class="fc" id="L420">    return em -&gt; {</span>
      TypedQuery&lt;Long&gt; query;
<span class="pc bpc" id="L422" title="1 of 2 branches missed.">      if (null != organization) {</span>
<span class="fc" id="L423">        query = em.createNamedQuery(&quot;Snapshot.countOrgEvents&quot;, Long.class)</span>
<span class="fc" id="L424">            .setParameter(&quot;organizationId&quot;, organization);</span>
      } else {
<span class="nc" id="L426">        query = em.createNamedQuery(&quot;Snapshot.countEvents&quot;, Long.class);</span>
      }
<span class="fc" id="L428">      logger.debug(&quot;Executing query {}&quot;, query);</span>
<span class="fc" id="L429">      return query.getSingleResult();</span>
    };
  }

  /**
   * Count events with snapshots in the asset manager
   *
   * @param organization
   *          An organization to count in
   * @return Number of events
   */
  public static Function&lt;EntityManager, Long&gt; countSnapshotsQuery(final String organization) {
<span class="fc" id="L441">    return em -&gt; {</span>
      TypedQuery&lt;Long&gt; query;
<span class="fc" id="L443">      query = em.createNamedQuery(&quot;Snapshot.countSnapshots&quot;, Long.class)</span>
<span class="fc" id="L444">          .setParameter(&quot;organizationId&quot;, organization);</span>
<span class="fc" id="L445">      logger.debug(&quot;Executing query {}&quot;, query);</span>
<span class="fc" id="L446">      return query.getSingleResult();</span>
    };
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>