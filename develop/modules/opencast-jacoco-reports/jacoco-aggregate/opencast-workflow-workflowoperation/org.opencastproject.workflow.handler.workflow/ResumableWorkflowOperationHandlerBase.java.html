<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ResumableWorkflowOperationHandlerBase.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-workflow-workflowoperation</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.workflow.handler.workflow</a> &gt; <span class="el_source">ResumableWorkflowOperationHandlerBase.java</span></div><h1>ResumableWorkflowOperationHandlerBase.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.workflow.handler.workflow;

import org.opencastproject.job.api.JobContext;
import org.opencastproject.rest.RestConstants;
import org.opencastproject.rest.StaticResource;
import org.opencastproject.workflow.api.AbstractWorkflowOperationHandler;
import org.opencastproject.workflow.api.ResumableWorkflowOperationHandler;
import org.opencastproject.workflow.api.WorkflowInstance;
import org.opencastproject.workflow.api.WorkflowOperationException;
import org.opencastproject.workflow.api.WorkflowOperationResult;
import org.opencastproject.workflow.api.WorkflowOperationResult.Action;

import org.apache.commons.io.FilenameUtils;
import org.osgi.framework.ServiceRegistration;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.http.whiteboard.HttpWhiteboardConstants;

import java.util.Dictionary;
import java.util.Hashtable;
import java.util.Map;

import javax.servlet.Servlet;

/**
 * Abstract base implementation for a resumable operation handler, which implements a simple operations for starting an
 * operation, returning a {@link WorkflowOperationResult} with the current mediapackage and {@link Action#PAUSE} and
 * resuming an operation, returning a {@link WorkflowOperationResult} with the current mediapackage and
 * {@link Action#CONTINUE}.
 */
<span class="fc" id="L51">public class ResumableWorkflowOperationHandlerBase extends AbstractWorkflowOperationHandler implements</span>
        ResumableWorkflowOperationHandler {

  /** OSGi component context, obtained during component activation */
<span class="fc" id="L55">  protected ComponentContext componentContext = null;</span>

  /** Reference to the static resource service */
<span class="fc" id="L58">  protected ServiceRegistration staticResourceRegistration = null;</span>

  /** The static resource representing the hold state ui */
<span class="fc" id="L61">  protected StaticResource staticResource = null;</span>

  /** Title of this hold state */
<span class="fc" id="L64">  protected String holdActionTitle = null;</span>

  private static final String DEFAULT_TITLE = &quot;Action&quot;;

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.AbstractWorkflowOperationHandler#activate(org.osgi.service.component.ComponentContext)
   */
  public void activate(ComponentContext componentContext) {
<span class="nc" id="L74">    this.componentContext = componentContext;</span>
<span class="nc" id="L75">    super.activate(componentContext);</span>
<span class="nc" id="L76">  }</span>

  /**
   * Callback from the OSGi environment on component shutdown. Make sure to call this super implementation when
   * overwriting this class.
   */
  public void deactivate() {
<span class="nc bnc" id="L83" title="All 2 branches missed.">    if (staticResourceRegistration != null)</span>
<span class="nc" id="L84">      staticResourceRegistration.unregister();</span>
<span class="nc" id="L85">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.ResumableWorkflowOperationHandler#getHoldStateUserInterfaceURL(org.opencastproject.workflow.api.WorkflowInstance)
   */
  public String getHoldStateUserInterfaceURL(WorkflowInstance workflowInstance) throws WorkflowOperationException {
<span class="nc bnc" id="L93" title="All 2 branches missed.">    if (staticResource == null)</span>
<span class="nc" id="L94">      return null;</span>
<span class="nc" id="L95">    return staticResource.getDefaultUrl();</span>
  }

  /**
   * Sets the title that is displayed on the hold state ui.
   *
   * @param title
   *          the title
   */
  protected void setHoldActionTitle(String title) {
<span class="nc" id="L105">    this.holdActionTitle = title;</span>
<span class="nc" id="L106">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.ResumableWorkflowOperationHandler#getHoldActionTitle()
   */
  public String getHoldActionTitle() {
<span class="nc bnc" id="L114" title="All 2 branches missed.">    if (holdActionTitle == null) {</span>
<span class="nc" id="L115">      return DEFAULT_TITLE;</span>
    } else {
<span class="nc" id="L117">      return holdActionTitle;</span>
    }
  }

  /**
   * Registers the resource identified by &lt;code&gt;resourcePath&lt;/code&gt; as the ui to be displayed during hold.
   *
   * @param resourcePath
   *          the path to the resource
   * @return the URL that was created when registering the resource
   */
  protected String registerHoldStateUserInterface(final String resourcePath) {
<span class="nc" id="L129">    String alias = &quot;/workflow/hold/&quot; + getClass().getName().toLowerCase();</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">    if (resourcePath == null)</span>
<span class="nc" id="L131">      throw new IllegalArgumentException(&quot;Classpath must not be null&quot;);</span>
<span class="nc" id="L132">    String path = FilenameUtils.getPathNoEndSeparator(resourcePath);</span>
<span class="nc" id="L133">    String welcomeFile = FilenameUtils.getName(resourcePath);</span>
<span class="nc" id="L134">    staticResource = new StaticResource(getClass().getClassLoader(), path, alias, welcomeFile);</span>
<span class="nc" id="L135">    Dictionary&lt;String, String&gt; props = new Hashtable&lt;&gt;();</span>
<span class="nc" id="L136">    props.put(HttpWhiteboardConstants.HTTP_WHITEBOARD_CONTEXT_SELECT, &quot;(&quot; + HttpWhiteboardConstants.HTTP_WHITEBOARD_CONTEXT_NAME + &quot;=&quot; + RestConstants.HTTP_CONTEXT_ID + &quot;)&quot;);</span>
<span class="nc" id="L137">    props.put(HttpWhiteboardConstants.HTTP_WHITEBOARD_SERVLET_NAME, alias);</span>
<span class="nc" id="L138">    props.put(HttpWhiteboardConstants.HTTP_WHITEBOARD_SERVLET_PATTERN, alias + &quot;/*&quot;);</span>
<span class="nc" id="L139">    staticResourceRegistration = componentContext.getBundleContext().registerService(Servlet.class.getName(),</span>
            staticResource, props);
<span class="nc" id="L141">    return staticResource.getDefaultUrl();</span>
  }

  /**
   * {@inheritDoc}
   *
   * This default implementation will put the workflow into the hold state.
   *
   * @see org.opencastproject.workflow.api.AbstractWorkflowOperationHandler#start(org.opencastproject.workflow.api.WorkflowInstance,
   *      JobContext)
   */
  @Override
  public WorkflowOperationResult start(WorkflowInstance workflowInstance, JobContext context)
          throws WorkflowOperationException {
<span class="fc" id="L155">    return createResult(Action.PAUSE);</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.ResumableWorkflowOperationHandler#resume(org.opencastproject.workflow.api.WorkflowInstance,
   *      JobContext, java.util.Map)
   */
  @Override
  public WorkflowOperationResult resume(WorkflowInstance workflowInstance, JobContext context,
          Map&lt;String, String&gt; properties) throws WorkflowOperationException {
<span class="nc" id="L167">    return createResult(Action.CONTINUE);</span>
  }

  @Override
  public boolean isAlwaysPause() {
<span class="nc" id="L172">    return false;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>