<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AddCatalogWorkflowOperationHandler.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-workflow-workflowoperation</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.workflow.handler.workflow</a> &gt; <span class="el_source">AddCatalogWorkflowOperationHandler.java</span></div><h1>AddCatalogWorkflowOperationHandler.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.workflow.handler.workflow;

import org.opencastproject.job.api.JobContext;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.mediapackage.MediaPackageElement;
import org.opencastproject.mediapackage.MediaPackageElementFlavor;
import org.opencastproject.mediapackage.selector.CatalogSelector;
import org.opencastproject.util.MimeType;
import org.opencastproject.workflow.api.AbstractWorkflowOperationHandler;
import org.opencastproject.workflow.api.WorkflowInstance;
import org.opencastproject.workflow.api.WorkflowOperationException;
import org.opencastproject.workflow.api.WorkflowOperationHandler;
import org.opencastproject.workflow.api.WorkflowOperationResult;
import org.opencastproject.workflow.api.WorkflowOperationResult.Action;
import org.opencastproject.workspace.api.Workspace;

import org.apache.commons.io.FileUtils;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.net.URI;
import java.util.UUID;

/**
 * This WorkflowOperationHandler adds an configurable catalog to the MediaPackage.
 * It supports the following workflow configuration keys:
 *   catalog-path the path of the catalog to add;
 *   catalog-flavor the flavor of the catalog, used to identify catalogs of the same type;
 *   catalog-name name of the catalog in the workspace;
 *   catalog-tags list of comma seperated catalog tags;
 *   catalog-type-collision-behavior the action to perform, if an catalog of the same flavor already exists,
 *     three options are supported: 'skip' the adding of the catalog, 'fail' the workflow operation or 'keep'
 *     the new catalog, resulting in two or more catalogs of the same type coexisting
 */
@Component(
    immediate = true,
    service = WorkflowOperationHandler.class,
    property = {
        &quot;service.description=Add Catalog Operation Handler&quot;,
        &quot;workflow.operation=add-catalog&quot;
    }
)
<span class="fc" id="L67">public class AddCatalogWorkflowOperationHandler extends AbstractWorkflowOperationHandler {</span>

  /** enum used to specify the behavior on detecting a catalog type collision */
<span class="fc" id="L70">  private enum CatalogTypeCollisionBehavior {</span>
<span class="fc" id="L71">    SKIP, KEEP, FAIL</span>
  }

  /** config key for the catalog name */
  private static final String CFG_KEY_CATALOG_NAME   = &quot;catalog-name&quot;;
  /** config key for the catalog flavor */
  private static final String CFG_KEY_CATALOG_FLAVOR = &quot;catalog-flavor&quot;;
  /** config key which locates the catalog on the filesystem */
  private static final String CFG_KEY_CATALOG_PATH   = &quot;catalog-path&quot;;
  /** config key for the catalog tags */
  private static final String CFG_KEY_CATALOG_TAGS   = &quot;catalog-tags&quot;;
  /** config key which defines the behavior if a catalog of the same flavor already exists */
  private static final String CFG_KEY_CATALOG_TYPE_COLLISION_BEHAVIOR = &quot;catalog-type-collision-behavior&quot;;

  /** The mimetype of the added catalogs */
<span class="fc" id="L86">  private static final MimeType CATALOG_MIME_TYPE = MimeType.mimeType(&quot;text&quot;, &quot;xml&quot;);</span>

  /** The workspace, where the catalog files are put. */
  private Workspace workspace;

  /**
   * Sets the workspace to use.
   *
   * @param workspace
   *          the workspace
   */
  @Reference
  public void setWorkspace(Workspace workspace) {
<span class="fc" id="L99">    this.workspace = workspace;</span>
<span class="fc" id="L100">  }</span>

  @Override
  public WorkflowOperationResult start(WorkflowInstance wInst, JobContext context)
      throws WorkflowOperationException {
    // get Workflow configuration
<span class="fc" id="L106">    String catalogName = getConfig(wInst, CFG_KEY_CATALOG_NAME);</span>
<span class="fc" id="L107">    String catalogPath = getConfig(wInst, CFG_KEY_CATALOG_PATH);</span>
<span class="fc" id="L108">    String catalogTags = getConfig(wInst, CFG_KEY_CATALOG_TAGS, &quot;&quot;);</span>
<span class="fc" id="L109">    CatalogTypeCollisionBehavior collBehavior  = parseCollisionBehavior(</span>
<span class="fc" id="L110">                           getConfig(wInst, CFG_KEY_CATALOG_TYPE_COLLISION_BEHAVIOR));</span>
<span class="fc" id="L111">    MediaPackageElementFlavor    catalogFlavor = null;</span>
    try {
<span class="fc" id="L113">      catalogFlavor = MediaPackageElementFlavor.parseFlavor(</span>
<span class="fc" id="L114">                           getConfig(wInst, CFG_KEY_CATALOG_FLAVOR));</span>
    }
<span class="nc" id="L116">    catch (IllegalArgumentException e) {</span>
<span class="nc" id="L117">      throw new WorkflowOperationException(&quot;Unknown flavor&quot;);</span>
<span class="fc" id="L118">    }</span>

<span class="fc" id="L120">    MediaPackage mp = wInst.getMediaPackage();</span>

<span class="fc" id="L122">    CatalogSelector catalogSelector = new CatalogSelector();</span>
<span class="fc" id="L123">    catalogSelector.addFlavor(catalogFlavor);</span>

    // if CatalogType is already part of the MediaPackage handle special cases
<span class="fc bfc" id="L126" title="All 2 branches covered.">    if (catalogSelector.select(mp, false).size() &gt; 0) {</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">      if (collBehavior == CatalogTypeCollisionBehavior.FAIL) {</span>
<span class="fc" id="L128">        throw new WorkflowOperationException(&quot;Catalog Type already exists and 'fail' was specified&quot;);</span>
      }
<span class="fc bfc" id="L130" title="All 2 branches covered.">      else if (collBehavior == CatalogTypeCollisionBehavior.SKIP) {</span>
        // don't add the Catalog
<span class="fc" id="L132">        return createResult(mp, Action.CONTINUE);</span>
      }
    }

    // 'upload Catalog' to workspace
<span class="fc" id="L137">    File   catalogFile = new File(catalogPath);</span>
<span class="fc" id="L138">    String catalogId   = UUID.randomUUID().toString();</span>
<span class="fc" id="L139">    URI    catalogURI  = null;</span>
<span class="fc" id="L140">    try (InputStream catalogInputStream = FileUtils.openInputStream(catalogFile)) {</span>
<span class="fc" id="L141">      catalogURI = workspace.put(mp.getIdentifier().toString(), catalogId,</span>
              catalogName, catalogInputStream);
    }
<span class="nc" id="L144">    catch (IOException e) {</span>
<span class="nc" id="L145">      throw new WorkflowOperationException(e);</span>
<span class="fc" id="L146">    }</span>

    // add Catalog to MediaPackage (and set Properties)
<span class="fc" id="L149">    MediaPackageElement mpe = mp.add(catalogURI, MediaPackageElement.Type.Catalog, catalogFlavor);</span>
<span class="fc" id="L150">    mpe.setIdentifier(catalogId);</span>
<span class="fc" id="L151">    mpe.setMimeType(CATALOG_MIME_TYPE);</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">    for (String tag : asList(catalogTags)) {</span>
<span class="fc" id="L153">      mpe.addTag(tag);</span>
<span class="fc" id="L154">    }</span>

<span class="fc" id="L156">    return createResult(mp, Action.CONTINUE);</span>
  }

  /**
   * Parses the rawBehavior String into an CatalogTypeCollisionBehavior.
   * Throws an WorkflowOperationException if the String couldn't be parsed.
   *
   * @param rawBehavior
   * @return
   * @throws WorkflowOperationException
   */
  private CatalogTypeCollisionBehavior parseCollisionBehavior(String rawBehavior)
      throws WorkflowOperationException {
    try {
<span class="fc" id="L170">      return CatalogTypeCollisionBehavior.valueOf(rawBehavior.toUpperCase());</span>
    }
<span class="nc" id="L172">    catch (IllegalArgumentException e) {</span>
<span class="nc" id="L173">      throw new WorkflowOperationException(&quot;Workflowoperation configured incorrectly, the configuration '&quot;</span>
                                           + CFG_KEY_CATALOG_TYPE_COLLISION_BEHAVIOR
                                           + &quot;' only accepts 'skip', 'keep', 'fail'&quot;);
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>