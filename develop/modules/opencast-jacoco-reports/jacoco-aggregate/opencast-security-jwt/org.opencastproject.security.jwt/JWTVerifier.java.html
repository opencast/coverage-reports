<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>JWTVerifier.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-security-jwt</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.security.jwt</a> &gt; <span class="el_source">JWTVerifier.java</span></div><h1>JWTVerifier.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.security.jwt;

import com.auth0.jwk.JwkException;
import com.auth0.jwt.JWT;
import com.auth0.jwt.algorithms.Algorithm;
import com.auth0.jwt.exceptions.JWTVerificationException;
import com.auth0.jwt.interfaces.DecodedJWT;

import org.apache.commons.lang3.StringUtils;
import org.springframework.expression.EvaluationException;
import org.springframework.expression.Expression;
import org.springframework.expression.ExpressionParser;
import org.springframework.expression.ParseException;
import org.springframework.expression.spel.standard.SpelExpressionParser;
import org.springframework.util.Assert;

import java.util.List;

/**
 * Helper class to verify JWTs.
 */
public final class JWTVerifier {

  private JWTVerifier() { }

  /**
   * Verifies a given JWT string with a given JWK provider and given claim constraints.
   *
   * @param token The JWT string.
   * @param provider The JWK provider.
   * @param claimConstraints The claim constraints.
   * @return The decoded and verified JWT.
   * @throws JwkException If the JWT cannot be verified successfully.
   */
  public static DecodedJWT verify(String token, GuavaCachedUrlJwkProvider provider, List&lt;String&gt; claimConstraints)
          throws JwkException {
<span class="fc" id="L58">    Assert.notNull(token, &quot;A token must be set&quot;);</span>
<span class="fc" id="L59">    Assert.notNull(provider, &quot;A JWKS provider must be set&quot;);</span>

<span class="fc" id="L61">    DecodedJWT jwt = JWT.decode(token);</span>

    // First try with cache...
    List&lt;Algorithm&gt; algorithms;
    try {
<span class="fc" id="L66">      algorithms = provider.getAlgorithms(jwt, false);</span>
<span class="fc" id="L67">      return verify(jwt, claimConstraints, algorithms);</span>
<span class="fc" id="L68">    } catch (JWTVerificationException | JwkException e) {</span>
      // ...then try again with forced fetch
      // (recommended by e.g. https://openid.net/specs/openid-connect-core-1_0.html#RotateSigKeys)
<span class="fc" id="L71">      algorithms = provider.getAlgorithms(jwt, true);</span>
<span class="fc" id="L72">      return verify(jwt, claimConstraints, algorithms);</span>
    }
  }

  /**
   * Verifies a given JWT string with a secret and given claim constraints.
   *
   * @param token The JWT string.
   * @param secret The secret.
   * @param claimConstraints The claim constraints.
   * @return The decoded and verified JWT.
   * @throws JWTVerificationException If the JWT cannot be verified successfully.
   */
  public static DecodedJWT verify(String token, String secret, List&lt;String&gt; claimConstraints)
          throws JWTVerificationException {
<span class="fc" id="L87">    Assert.notNull(token, &quot;A token must be set&quot;);</span>
<span class="fc" id="L88">    Assert.isTrue(StringUtils.isNotBlank(secret), &quot;A secret must be set&quot;);</span>

<span class="fc" id="L90">    DecodedJWT jwt = JWT.decode(token);</span>
<span class="fc" id="L91">    return verify(jwt, claimConstraints, AlgorithmBuilder.buildAlgorithm(jwt, secret));</span>
  }

  /**
   * Verifies a given decoded JWT with the given claim constraints and algorithms. The verification has to be
   * successful with at least one provided algorithm. Otherwise a {@link JWTVerificationException} is thrown.
   *
   * @param jwt The decoded JWT.
   * @param claimConstraints The claim constraints.
   * @param algorithms The algorithms.
   * @return The decoded and verified JWT.
   * @throws JWTVerificationException If the JWT cannot be verified successfully.
   */
  public static DecodedJWT verify(DecodedJWT jwt, List&lt;String&gt; claimConstraints, List&lt;Algorithm&gt; algorithms)
          throws JWTVerificationException {
<span class="fc" id="L106">    return verify(jwt, claimConstraints, algorithms.toArray(new Algorithm[0]));</span>
  }

  /**
   * Verifies a given decoded JWT with the given claim constraints and algorithms. The verification has to be
   * successful with at least one provided algorithm. Otherwise a {@link JWTVerificationException} is thrown.
   *
   * @param jwt The decoded JWT.
   * @param claimConstraints The claim constraints.
   * @param algorithms The algorithms.
   * @return The decoded and verified JWT.
   * @throws JWTVerificationException If the JWT cannot be verified successfully.
   */
  public static DecodedJWT verify(DecodedJWT jwt, List&lt;String&gt; claimConstraints, Algorithm... algorithms)
          throws JWTVerificationException {
<span class="fc" id="L121">    Assert.notNull(jwt, &quot;A decoded JWT must be set&quot;);</span>
<span class="fc" id="L122">    Assert.notEmpty(claimConstraints, &quot;Claim constraints must be set&quot;);</span>
<span class="fc" id="L123">    Assert.notEmpty(algorithms, &quot;Algorithms must be set&quot;);</span>
<span class="fc" id="L124">    Assert.isTrue(algorithmsMatch(algorithms), &quot;Algorithms must be of same class&quot;);</span>

<span class="fc" id="L126">    boolean verified = false;</span>
<span class="fc" id="L127">    Exception lastException = new JWTVerificationException(&quot;JWT could not be verified&quot;);</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">    for (Algorithm algorithm : algorithms) {</span>
      try {
        // General verification
<span class="fc" id="L131">        JWT.require(algorithm).build().verify(jwt);</span>

        // Claim constraints verification
<span class="fc" id="L134">        ExpressionParser parser = new SpelExpressionParser();</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">        for (String constraint : claimConstraints) {</span>
<span class="fc" id="L136">          Expression exp = parser.parseExpression(constraint);</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">          if (!exp.getValue(jwt.getClaims(), Boolean.class)) {</span>
<span class="fc" id="L138">            throw new JWTVerificationException(&quot;The claims did not fulfill constraint '&quot; + constraint + &quot;'&quot;);</span>
          }
<span class="fc" id="L140">        }</span>

        // Verification was successful if no exception has been thrown
<span class="fc" id="L143">        verified = true;</span>
<span class="fc" id="L144">        break;</span>
<span class="fc" id="L145">      } catch (JWTVerificationException | EvaluationException | ParseException e) {</span>
        // Ignore for now and try next algorithm
<span class="fc" id="L147">        lastException = e;</span>
      }
    }

    // If verification was not successful until here, throw last known exception
<span class="fc bfc" id="L152" title="All 2 branches covered.">    if (!verified) {</span>
<span class="fc" id="L153">      throw new JWTVerificationException(lastException.getMessage());</span>
    }

<span class="fc" id="L156">    return jwt;</span>
  }

  /**
   * Checks if the given array of algorithms match.
   *
   * @param algorithms The algorithms.
   * @return &lt;code&gt;true&lt;/code&gt; if all algorithms match, &lt;code&gt;false&lt;/code&gt; otherwise.
   */
  private static boolean algorithmsMatch(Algorithm... algorithms) {
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">    for (int i = 1; i &lt; algorithms.length; i++) {</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">      if (!algorithms[i].getClass().equals(algorithms[0].getClass())) {</span>
<span class="nc" id="L168">        return false;</span>
      }
    }
<span class="fc" id="L171">    return true;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>