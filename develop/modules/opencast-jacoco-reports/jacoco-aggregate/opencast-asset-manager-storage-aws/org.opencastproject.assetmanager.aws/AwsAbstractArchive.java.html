<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AwsAbstractArchive.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-asset-manager-storage-aws</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.assetmanager.aws</a> &gt; <span class="el_source">AwsAbstractArchive.java</span></div><h1>AwsAbstractArchive.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.assetmanager.aws;

import static org.apache.commons.lang3.exception.ExceptionUtils.getMessage;

import org.opencastproject.assetmanager.api.storage.AssetStore;
import org.opencastproject.assetmanager.api.storage.AssetStoreException;
import org.opencastproject.assetmanager.api.storage.DeletionSelector;
import org.opencastproject.assetmanager.api.storage.Source;
import org.opencastproject.assetmanager.api.storage.StoragePath;
import org.opencastproject.assetmanager.aws.persistence.AwsAssetDatabase;
import org.opencastproject.assetmanager.aws.persistence.AwsAssetDatabaseException;
import org.opencastproject.assetmanager.aws.persistence.AwsAssetMapping;
import org.opencastproject.assetmanager.impl.VersionImpl;
import org.opencastproject.util.ConfigurationException;
import org.opencastproject.util.MimeType;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.OsgiUtil;
import org.opencastproject.util.data.Option;
import org.opencastproject.workspace.api.Workspace;

import org.apache.commons.io.FilenameUtils;
import org.apache.commons.lang3.StringUtils;
import org.osgi.service.component.ComponentContext;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.util.List;
import java.util.Optional;

<span class="fc" id="L54">public abstract class AwsAbstractArchive implements AssetStore {</span>

  /** Log facility */
<span class="fc" id="L57">  private static final Logger logger = LoggerFactory.getLogger(AwsAbstractArchive.class);</span>

  protected Workspace workspace;
  protected AwsAssetDatabase database;

  /** The store type e.g. aws (long-term), or other implementations */
<span class="fc" id="L63">  protected String storeType = null;</span>
  /** The AWS region */
<span class="fc" id="L65">  protected String regionName = null;</span>

  protected String getAWSConfigKey(ComponentContext cc, String key) {
    try {
<span class="nc" id="L69">      String value = StringUtils.trimToEmpty(OsgiUtil.getComponentContextProperty(cc, key));</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">      if (StringUtils.isNotBlank(value)) {</span>
<span class="nc" id="L71">        return value;</span>
      }
<span class="nc" id="L73">      throw new ConfigurationException(key + &quot; is invalid&quot;);</span>
<span class="nc" id="L74">    } catch (RuntimeException e) {</span>
<span class="nc" id="L75">      throw new ConfigurationException(key + &quot; is missing or invalid&quot;, e);</span>
    }
  }

  public Option&lt;Long&gt; getUsedSpace() {
<span class="nc" id="L80">    throw new UnsupportedOperationException(&quot;Not implemented&quot;);</span>
  }

  public Option&lt;Long&gt; getUsableSpace() {
<span class="nc" id="L84">    throw new UnsupportedOperationException(&quot;Not implemented&quot;);</span>
  }

  public Option&lt;Long&gt; getTotalSpace() {
<span class="nc" id="L88">    throw new UnsupportedOperationException(&quot;Not implemented&quot;);</span>
  }

  public String getStoreType() {
<span class="fc" id="L92">    return this.storeType;</span>
  }

  public String getRegion() {
<span class="nc" id="L96">    return this.regionName;</span>
  }

  /** OSGi Di */
  public void setWorkspace(Workspace workspace) {
<span class="fc" id="L101">    this.workspace = workspace;</span>
<span class="fc" id="L102">  }</span>

  /** OSGi Di */
  public void setDatabase(AwsAssetDatabase db) {
<span class="fc" id="L106">    this.database = db;</span>
<span class="fc" id="L107">  }</span>

  /** @see AssetStore#copy(StoragePath, StoragePath) */
  public boolean copy(final StoragePath from, final StoragePath to) throws AssetStoreException {
    try {
<span class="fc" id="L112">      AwsAssetMapping map = database.findMapping(from);</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">      if (!contains(from)) {</span>
<span class="fc" id="L114">        logger.warn(&quot;Origin file mapping not found in database: {}&quot;, from);</span>
<span class="fc" id="L115">        return false;</span>
      }
      // New mapping will point to the SAME AWS object, nothing will be uploaded
<span class="fc" id="L118">      logger.debug(&quot;Adding AWS {} link mapping to database: {} points to {}, version {}&quot;, getStoreType(),</span>
<span class="fc" id="L119">              to, map.getObjectKey(), map.getObjectVersion());</span>
<span class="fc" id="L120">      database.storeMapping(to, map.getObjectKey(), map.getObjectVersion());</span>
<span class="fc" id="L121">      return true;</span>
<span class="nc" id="L122">    } catch (AwsAssetDatabaseException e) {</span>
<span class="nc" id="L123">      throw new AssetStoreException(e);</span>
    }
  }

  public boolean contains(StoragePath path) throws AssetStoreException {
    try {
<span class="fc" id="L129">      AwsAssetMapping map = database.findMapping(path);</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">      return (map != null);</span>
<span class="nc" id="L131">    } catch (AwsAssetDatabaseException e) {</span>
<span class="nc" id="L132">      throw new AssetStoreException(e);</span>
    }
  }

  protected File getFileFromWorkspace(Source source) {
    try {
<span class="fc" id="L138">      return workspace.get(source.getUri());</span>
<span class="nc" id="L139">    } catch (NotFoundException e) {</span>
<span class="nc" id="L140">      logger.error(&quot;Source file '{}' does not exist&quot;, source.getUri());</span>
<span class="nc" id="L141">      throw new AssetStoreException(e);</span>
<span class="nc" id="L142">    } catch (IOException e) {</span>
<span class="nc" id="L143">      logger.error(&quot;Error while getting file '{}' from workspace: {}&quot;, source.getUri(), getMessage(e));</span>
<span class="nc" id="L144">      throw new AssetStoreException(e);</span>
    }
  }

  public String buildObjectName(File origin, StoragePath storagePath) {
    // origin file name from workspace will be called
    // WORKSPACE/http_ADMIN_HOST/assets/assets/MP_ID/EL_ID/VERSION/filename.EXTENSION
    // while the actual file is in ARCHIVE/ORG/MP_ID/VERSION/EL_ID.EXTENSION

    // Create object key - S3 style but works for Glacier as well
<span class="fc" id="L154">    String fileExt = FilenameUtils.getExtension(origin.getName());</span>
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">    return buildFilename(storagePath, fileExt.isEmpty() ? &quot;&quot; : &quot;.&quot; + fileExt);</span>
  }

  /**
   * Builds the aws object name.
   */
  protected String buildFilename(StoragePath path, String ext) {
    // Something like ORG_ID/MP_ID/VERSION/ELEMENT_ID.EXTENSION
<span class="fc" id="L163">    return StringUtils.join(new String[] { path.getOrganizationId(), path.getMediaPackageId(),</span>
<span class="fc" id="L164">            path.getVersion().toString(), path.getMediaPackageElementId() + ext }, &quot;/&quot;);</span>
  }

  /**
   * @see AssetStore#put(StoragePath, Source)
   */
  public void put(StoragePath storagePath, Source source) throws AssetStoreException {
    // If the workspace  to asset manager hard-linking is enabled then this is just a
    // hard-link. If not, this will be a download + hard-link
<span class="fc" id="L173">    final File origin = getFileFromWorkspace(source);</span>

<span class="fc" id="L175">    String objectName = buildObjectName(origin, storagePath);</span>
<span class="fc" id="L176">    String objectVersion = null;</span>
    try {
      // Upload file to AWS
<span class="fc" id="L179">      AwsUploadOperationResult result = uploadObject(storagePath.getOrganizationId(), origin, objectName,</span>
<span class="fc" id="L180">          source.getMimeType());</span>
<span class="fc" id="L181">      objectName = result.getObjectName();</span>
<span class="fc" id="L182">      objectVersion = result.getObjectVersion();</span>
<span class="fc" id="L183">    } catch (Exception e) {</span>
<span class="fc" id="L184">      throw new AssetStoreException(e);</span>
<span class="fc" id="L185">    }</span>

    try {
      // Upload was successful. Store mapping in the database
<span class="fc" id="L189">      logger.debug(&quot;Adding AWS {} mapping to database: {} points to {}, object version {}&quot;, getStoreType(),</span>
              storagePath, objectName, objectVersion);
<span class="fc" id="L191">      database.storeMapping(storagePath, objectName, objectVersion);</span>
<span class="nc" id="L192">    } catch (AwsAssetDatabaseException e) {</span>
<span class="nc" id="L193">      throw new AssetStoreException(e);</span>
<span class="fc" id="L194">    }</span>
<span class="fc" id="L195">  }</span>

  protected abstract AwsUploadOperationResult uploadObject(String orgId, File origin, String objectName,
          Optional&lt;MimeType&gt; mimeType) throws AssetStoreException;

  /** @see AssetStore#get(StoragePath) */
  public Optional&lt;InputStream&gt; get(final StoragePath path) throws AssetStoreException {
    try {
<span class="fc" id="L203">      AwsAssetMapping map = database.findMapping(path);</span>
<span class="fc bfc" id="L204" title="All 2 branches covered.">      if (map == null) {</span>
<span class="fc" id="L205">        logger.warn(&quot;File mapping not found in database: {}&quot;, path);</span>
<span class="fc" id="L206">        return Optional.empty();</span>
      }

<span class="fc" id="L209">      logger.debug(&quot;Getting archive object from AWS {}: {}&quot;, getStoreType(), map.getObjectKey());</span>
<span class="fc" id="L210">      return Optional.of(getObject(map));</span>

<span class="nc" id="L212">    } catch (AssetStoreException e) {</span>
<span class="nc" id="L213">      throw e;</span>
<span class="nc" id="L214">    } catch (AwsAssetDatabaseException e) {</span>
<span class="nc" id="L215">      throw new AssetStoreException(e);</span>
    }
  }

  protected abstract InputStream getObject(AwsAssetMapping map) throws AssetStoreException;

  /** @see AssetStore#delete(DeletionSelector) */
  public boolean delete(DeletionSelector sel) throws AssetStoreException {
    // Build path, version may be null if all versions are desired
<span class="fc" id="L224">    StoragePath path = new StoragePath(</span>
<span class="fc" id="L225">        sel.getOrganizationId(), sel.getMediaPackageId(), sel.getVersion().orElse(null), null);</span>
    try {
<span class="fc" id="L227">      List&lt;AwsAssetMapping&gt; list = database.findMappingsByMediaPackageAndVersion(path);</span>
      // Traverse all file mappings for that media package / version(s)
<span class="fc bfc" id="L229" title="All 2 branches covered.">      for (AwsAssetMapping map : list) {</span>
        // Find all mappings that point to the same object (like hard-links)
<span class="fc" id="L231">        List&lt;AwsAssetMapping&gt; links = database.findMappingsByKey(map.getObjectKey());</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">        if (links.size() == 1) {</span>
          // This is the only active mapping thats point to the object; thus, the object can be deleted.
<span class="fc" id="L234">          logger.debug(&quot;Deleting archive object from AWS {}: {}, version {}&quot;,</span>
<span class="fc" id="L235">              getStoreType(), map.getObjectKey(), map.getObjectVersion());</span>
<span class="fc" id="L236">          deleteObject(map);</span>
<span class="fc" id="L237">          logger.info(&quot;Archive object deleted from AWS {}: {}, version {}&quot;,</span>
<span class="fc" id="L238">              getStoreType(), map.getObjectKey(), map.getObjectVersion());</span>
        }
        // Add a deletion date to the mapping in the table. This doesn't delete the row.
<span class="fc" id="L241">        database.deleteMapping(new StoragePath(</span>
<span class="fc" id="L242">            map.getOrganizationId(),</span>
<span class="fc" id="L243">            map.getMediaPackageId(),</span>
<span class="fc" id="L244">            new VersionImpl(map.getVersion()),</span>
<span class="fc" id="L245">            map.getMediaPackageElementId()));</span>
<span class="fc" id="L246">      }</span>
<span class="fc" id="L247">      return true;</span>
<span class="nc" id="L248">    } catch (AwsAssetDatabaseException e) {</span>
<span class="nc" id="L249">      throw new AssetStoreException(e);</span>
    }
  }

  protected abstract void deleteObject(AwsAssetMapping map) throws AssetStoreException;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>