<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AwsS3RestEndpoint.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-asset-manager-storage-aws</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.assetmanager.aws.s3.endpoint</a> &gt; <span class="el_source">AwsS3RestEndpoint.java</span></div><h1>AwsS3RestEndpoint.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.assetmanager.aws.s3.endpoint;

import static org.opencastproject.util.RestUtil.R.noContent;
import static org.opencastproject.util.RestUtil.R.notFound;
import static org.opencastproject.util.RestUtil.R.ok;

import org.opencastproject.assetmanager.api.AssetManager;
import org.opencastproject.assetmanager.api.AssetManagerException;
import org.opencastproject.assetmanager.api.Snapshot;
import org.opencastproject.assetmanager.api.storage.AssetStoreException;
import org.opencastproject.assetmanager.api.storage.StoragePath;
import org.opencastproject.assetmanager.aws.s3.AwsS3AssetStore;
import org.opencastproject.mediapackage.MediaPackageElement;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.data.Function0;
import org.opencastproject.util.doc.rest.RestParameter;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestResponse;
import org.opencastproject.util.doc.rest.RestService;

import com.amazonaws.services.s3.model.StorageClass;

import org.apache.commons.lang3.StringUtils;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.jaxrs.whiteboard.propertytypes.JaxrsResource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Optional;

import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.BadRequestException;
import javax.ws.rs.FormParam;
import javax.ws.rs.GET;
import javax.ws.rs.PUT;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.WebApplicationException;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;

@Path(&quot;/assets/aws/s3&quot;)
@RestService(name = &quot;archive-aws-s3&quot;, title = &quot;AWS S3 Archive&quot;,
    notes = {
        &quot;All paths are relative to the REST endpoint base (something like http://your.server/files)&quot;,
        &quot;If you notice that this service is not working as expected, there might be a bug! &quot;
            + &quot;You should file an error report with your server logs from the time when the error occurred: &quot;
            + &quot;&lt;a href=\&quot;http://opencast.jira.com\&quot;&gt;Opencast Issue Tracker&lt;/a&gt;&quot;
    },
    abstractText = &quot;This service handles AWS S3 archived assets&quot;)
@Component(
    immediate = true,
    service = AwsS3RestEndpoint.class,
    property = {
        &quot;service.description=AssetManager S3 REST Endpoint&quot;,
        &quot;opencast.service.type=org.opencastproject.assetmanager.aws-s3&quot;,
        &quot;opencast.service.path=/assets/aws/s3&quot;,
    }
)
@JaxrsResource
<span class="nc" id="L85">public class AwsS3RestEndpoint {</span>

<span class="nc" id="L87">  private static final Logger logger = LoggerFactory.getLogger(AwsS3RestEndpoint.class);</span>

<span class="nc" id="L89">  private AwsS3AssetStore awsS3AssetStore = null;</span>
<span class="nc" id="L90">  private AssetManager assetManager = null;</span>
<span class="nc" id="L91">  private SecurityService securityService = null;</span>

  @GET
  @Path(&quot;{mediaPackageId}/assets/storageClass&quot;)
  @Produces(MediaType.TEXT_PLAIN)
  @RestQuery(name = &quot;getStorageClass&quot;,
      description = &quot;Get the S3 Storage Class for each asset in the Media Package&quot;,
      pathParameters = {
          @RestParameter(
              name = &quot;mediaPackageId&quot;, isRequired = true,
              type = RestParameter.Type.STRING,
              description = &quot;The media package indentifier.&quot;)},
      responses = {
          @RestResponse(
              description = &quot;mediapackage found in S3&quot;,
              responseCode = HttpServletResponse.SC_OK),
          @RestResponse(
              description = &quot;mediapackage not found or has no assets in S3&quot;,
              responseCode = HttpServletResponse.SC_NOT_FOUND)
      },
      returnDescription = &quot;List each assets's Object Key and S3 Storage Class&quot;)
  public Response getStorageClass(@PathParam(&quot;mediaPackageId&quot;) final String mediaPackageId) {
<span class="nc" id="L113">    return handleException(new Function0&lt;Response&gt;() {</span>
      private String getMediaPackageId() {
<span class="nc" id="L115">        return StringUtils.trimToNull(mediaPackageId);</span>
      }

      @Override public Response apply() {
<span class="nc" id="L119">        Optional&lt;Snapshot&gt; snapshot = assetManager.getLatestSnapshot(mediaPackageId);</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (snapshot.isEmpty()) {</span>
<span class="nc" id="L121">          return notFound();</span>
        }

<span class="nc" id="L124">        StringBuilder info = new StringBuilder();</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">        for (MediaPackageElement e : snapshot.get().getMediaPackage().elements()) {</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">          if (e.getElementType() == MediaPackageElement.Type.Publication) {</span>
<span class="nc" id="L127">            continue;</span>
          }

<span class="nc" id="L130">          StoragePath storagePath = new StoragePath(securityService.getOrganization().getId(),</span>
<span class="nc" id="L131">              getMediaPackageId(),</span>
<span class="nc" id="L132">              snapshot.get().getVersion(),</span>
<span class="nc" id="L133">              e.getIdentifier());</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">          if (awsS3AssetStore.contains(storagePath)) {</span>
            try {
<span class="nc" id="L136">              info.append(String.format(&quot;%s,%s\n&quot;, awsS3AssetStore.getAssetObjectKey(storagePath),</span>
<span class="nc" id="L137">                                                   awsS3AssetStore.getAssetStorageClass(storagePath)));</span>
<span class="nc" id="L138">            } catch (AssetStoreException ex) {</span>
<span class="nc" id="L139">              throw new AssetManagerException(ex);</span>
<span class="nc" id="L140">            }</span>
          } else {
<span class="nc" id="L142">            info.append(String.format(&quot;%s,NONE\n&quot;, e.getURI()));</span>
          }
<span class="nc" id="L144">        }</span>
<span class="nc" id="L145">        return ok(info.toString());</span>
      }

    });
  }

  @PUT
  @Path(&quot;{mediaPackageId}/assets&quot;)
  @Produces(MediaType.TEXT_PLAIN)
  @RestQuery(name = &quot;modifyStorageClass&quot;,
      description = &quot;Move the Media Package assets to the specified S3 Storage Class if possible&quot;,
      pathParameters = {
          @RestParameter(
              name = &quot;mediaPackageId&quot;,
              isRequired = true,
              type = RestParameter.Type.STRING,
              description = &quot;The media package indentifier.&quot;)
      },
      restParameters = {
          @RestParameter(
              name = &quot;storageClass&quot;,
              isRequired = true,
              type = RestParameter.Type.STRING,
              description = &quot;The S3 storage class, valid terms STANDARD, STANDARD_IA, INTELLIGENT_TIERING, ONEZONE_IA,&quot;
                          + &quot;GLACIER_IR, GLACIER, and DEEP_ARCHIVE. See https://aws.amazon.com/s3/storage-classes/&quot;)
      },
      responses = {
          @RestResponse(
              description = &quot;mediapackage found in S3&quot;,
              responseCode = HttpServletResponse.SC_OK),
          @RestResponse(
              description = &quot;mediapackage not found or has no assets in S3&quot;,
              responseCode = HttpServletResponse.SC_NOT_FOUND)      },
      returnDescription = &quot;List each asset's Object Key and new S3 Storage Class&quot;)
  public Response modifyStorageClass(@PathParam(&quot;mediaPackageId&quot;) final String mediaPackageId,
                                     @FormParam(&quot;storageClass&quot;) final String storageClass) {
<span class="nc" id="L181">    return handleException(new Function0&lt;Response&gt;() {</span>
      private String getMediaPackageId() {
<span class="nc" id="L183">        return StringUtils.trimToNull(mediaPackageId);</span>
      }

      private String getStorageClass() {
<span class="nc" id="L187">        return StringUtils.trimToNull(storageClass);</span>
      }

      @Override public Response apply() {
<span class="nc" id="L191">        Optional&lt;Snapshot&gt; snapshot = assetManager.getLatestSnapshot(mediaPackageId);</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">        if (snapshot.isEmpty()) {</span>
<span class="nc" id="L193">          return notFound();</span>
        }
<span class="nc" id="L195">        StringBuilder info = new StringBuilder();</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">        for (MediaPackageElement e : snapshot.get().getMediaPackage().elements()) {</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">          if (e.getElementType() == MediaPackageElement.Type.Publication) {</span>
<span class="nc" id="L198">            continue;</span>
          }

<span class="nc" id="L201">          StoragePath storagePath = new StoragePath(securityService.getOrganization().getId(),</span>
<span class="nc" id="L202">              getMediaPackageId(),</span>
<span class="nc" id="L203">              snapshot.get().getVersion(),</span>
<span class="nc" id="L204">              e.getIdentifier());</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">          if (awsS3AssetStore.contains(storagePath)) {</span>
            try {
<span class="nc" id="L207">              info.append(String.format(&quot;%s,%s\n&quot;, awsS3AssetStore.getAssetObjectKey(storagePath),</span>
<span class="nc" id="L208">                                                   awsS3AssetStore.modifyAssetStorageClass(storagePath,</span>
<span class="nc" id="L209">                                                   getStorageClass())));</span>
<span class="nc" id="L210">            } catch (AssetStoreException ex) {</span>
<span class="nc" id="L211">              throw new AssetManagerException(ex);</span>
<span class="nc" id="L212">            }</span>
          } else {
<span class="nc" id="L214">            info.append(String.format(&quot;%s,NONE\n&quot;, e.getURI()));</span>
          }
<span class="nc" id="L216">        }</span>
<span class="nc" id="L217">        return ok(info.toString());</span>
      }

    });
  }

  @GET
  @Path(&quot;glacier/{mediaPackageId}/assets&quot;)
  @Produces(MediaType.TEXT_PLAIN)
  @RestQuery(name = &quot;restoreAssetsStatus&quot;,
      description = &quot;Get the mediapackage asset's restored status&quot;,
      pathParameters = {
          @RestParameter(
              name = &quot;mediaPackageId&quot;,
              isRequired = true,
              type = RestParameter.Type.STRING,
              description = &quot;The media package indentifier.&quot;)
      },
      responses = {
          @RestResponse(
              description = &quot;mediapackage found in S3 and assets in Glacier&quot;,
              responseCode = HttpServletResponse.SC_OK),
          @RestResponse(
              description = &quot;mediapackage found in S3 but no assets in Glacier&quot;,
              responseCode = HttpServletResponse.SC_NO_CONTENT),
          @RestResponse(
              description = &quot;mediapackage not found or has no assets in S3&quot;,
              responseCode = HttpServletResponse.SC_NOT_FOUND)
      },
      returnDescription = &quot;List each glacier asset's restoration status and expiration date&quot;)
  public Response getAssetRestoreState(@PathParam(&quot;mediaPackageId&quot;) final String mediaPackageId) {
<span class="nc" id="L248">    return handleException(new Function0&lt;Response&gt;() {</span>
      private String getMediaPackageId() {
<span class="nc" id="L250">        return StringUtils.trimToNull(mediaPackageId);</span>
      }

      @Override public Response apply() {
<span class="nc" id="L254">        Optional&lt;Snapshot&gt; snapshot = assetManager.getLatestSnapshot(mediaPackageId);</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (snapshot.isEmpty()) {</span>
<span class="nc" id="L256">          return notFound();</span>
        }

<span class="nc" id="L259">        StringBuilder info = new StringBuilder();</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">        for (MediaPackageElement e : snapshot.get().getMediaPackage().elements()) {</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">          if (e.getElementType() == MediaPackageElement.Type.Publication) {</span>
<span class="nc" id="L262">            continue;</span>
          }

<span class="nc" id="L265">          StoragePath storagePath = new StoragePath(securityService.getOrganization().getId(),</span>
<span class="nc" id="L266">                                                    getMediaPackageId(),</span>
<span class="nc" id="L267">                                                    snapshot.get().getVersion(),</span>
<span class="nc" id="L268">                                                    e.getIdentifier());</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">          if (isFrozen(storagePath)) {</span>
            try {
<span class="nc" id="L271">              info.append(String.format(&quot;%s,%s\n&quot;, awsS3AssetStore.getAssetObjectKey(storagePath),</span>
<span class="nc" id="L272">                                                   awsS3AssetStore.getAssetRestoreStatusString(storagePath)));</span>
<span class="nc" id="L273">            } catch (AssetStoreException ex) {</span>
<span class="nc" id="L274">              throw new AssetManagerException(ex);</span>
<span class="nc" id="L275">            }</span>
          } else {
<span class="nc" id="L277">            info.append(String.format(&quot;%s,NONE\n&quot;, storagePath));</span>
          }
<span class="nc" id="L279">        }</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">        if (info.length() == 0) {</span>
<span class="nc" id="L281">          return noContent();</span>
        }
<span class="nc" id="L283">        return ok(info.toString());</span>
      }
    });
  }

  @PUT
  @Path(&quot;glacier/{mediaPackageId}/assets&quot;)
  @Produces(MediaType.TEXT_PLAIN)
  @RestQuery(name = &quot;restoreAssets&quot;,
      description = &quot;Initiate the restore of any assets in Glacier storage class&quot;,
      pathParameters = {
          @RestParameter(
              name = &quot;mediaPackageId&quot;,
              isRequired = true,
              type = RestParameter.Type.STRING,
              description = &quot;The media package indentifier.&quot;)
      },
      restParameters = {
          @RestParameter(
              name = &quot;restorePeriod&quot;,
              isRequired = false,
              type = RestParameter.Type.INTEGER,
              defaultValue = &quot;2&quot;,
              description = &quot;Number of days to restore the assets for, default see service configuration&quot;)
      },
      responses = {
          @RestResponse(
              description = &quot;restore of assets started&quot;,
              responseCode = HttpServletResponse.SC_NO_CONTENT),
          @RestResponse(
              description = &quot;invalid restore period, must be greater than zero&quot;,
              responseCode = HttpServletResponse.SC_BAD_REQUEST),
          @RestResponse(
              description = &quot;mediapackage not found or has no assets in S3&quot;,
              responseCode = HttpServletResponse.SC_NOT_FOUND)
      },
      returnDescription = &quot;Restore of assets initiated&quot;)
  public Response restoreAssets(@PathParam(&quot;mediaPackageId&quot;) final String mediaPackageId,
                                @FormParam(&quot;restorePeriod&quot;) final Integer restorePeriod) {
<span class="nc" id="L322">    return handleException(new Function0&lt;Response&gt;() {</span>
      private String getMediaPackageId() {
<span class="nc" id="L324">        return StringUtils.trimToNull(mediaPackageId);</span>
      }

      private Integer getRestorePeriod() {
<span class="nc bnc" id="L328" title="All 2 branches missed.">        return restorePeriod != null ? restorePeriod : awsS3AssetStore.getRestorePeriod();</span>
      }

      @Override public Response apply() {
<span class="nc" id="L332">        Integer restorePeriod = getRestorePeriod();</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">        if (restorePeriod &lt; 1) {</span>
<span class="nc" id="L334">          throw new BadRequestException(&quot;Restore period must be greater than zero!&quot;);</span>
        }

<span class="nc" id="L337">        Optional&lt;Snapshot&gt; snapshot = assetManager.getLatestSnapshot(mediaPackageId);</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (snapshot.isEmpty()) {</span>
<span class="nc" id="L339">          return notFound();</span>
        }

<span class="nc bnc" id="L342" title="All 2 branches missed.">        for (MediaPackageElement e : snapshot.get().getMediaPackage().elements()) {</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">          if (e.getElementType() == MediaPackageElement.Type.Publication) {</span>
<span class="nc" id="L344">            continue;</span>
          }

<span class="nc" id="L347">          StoragePath storagePath = new StoragePath(securityService.getOrganization().getId(),</span>
<span class="nc" id="L348">                                                    getMediaPackageId(),</span>
<span class="nc" id="L349">                                                    snapshot.get().getVersion(),</span>
<span class="nc" id="L350">                                                    e.getIdentifier());</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">          if (isFrozen(storagePath)) {</span>
            try {
              // Initiate restore and return
<span class="nc" id="L354">              awsS3AssetStore.initiateRestoreAsset(storagePath, getRestorePeriod());</span>
<span class="nc" id="L355">            } catch (AssetStoreException ex) {</span>
<span class="nc" id="L356">              throw new AssetManagerException(ex);</span>
<span class="nc" id="L357">            }</span>
          }
<span class="nc" id="L359">        }</span>
<span class="nc" id="L360">        return noContent();</span>
      }
    });
  }

  private boolean isFrozen(StoragePath storagePath) {
<span class="nc" id="L366">    String assetStorageClass = awsS3AssetStore.getAssetStorageClass(storagePath);</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">    return awsS3AssetStore.contains(storagePath)</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">        &amp;&amp; (StorageClass.Glacier == StorageClass.fromValue(assetStorageClass)</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">          || StorageClass.DeepArchive == StorageClass.fromValue(assetStorageClass));</span>
  }


  /** Unify exception handling. */
  public static &lt;A&gt; A handleException(final Function0&lt;A&gt; f) {
    try {
<span class="nc" id="L376">      return f.apply();</span>
<span class="nc" id="L377">    } catch (AssetManagerException e) {</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">      if (e.isCauseNotAuthorized()) {</span>
<span class="nc" id="L379">        throw new WebApplicationException(e, Response.Status.UNAUTHORIZED);</span>
      }
<span class="nc bnc" id="L381" title="All 2 branches missed.">      if (e.isCauseNotFound()) {</span>
<span class="nc" id="L382">        throw new WebApplicationException(e, Response.Status.NOT_FOUND);</span>
      }
<span class="nc" id="L384">      throw new WebApplicationException(e, Response.Status.INTERNAL_SERVER_ERROR);</span>
<span class="nc" id="L385">    } catch (Exception e) {</span>
<span class="nc" id="L386">      logger.error(&quot;Error calling archive REST method&quot;, e);</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">      if (e instanceof NotFoundException) {</span>
<span class="nc" id="L388">        throw new WebApplicationException(e, Response.Status.NOT_FOUND);</span>
      }
<span class="nc" id="L390">      throw new WebApplicationException(e, Response.Status.INTERNAL_SERVER_ERROR);</span>
    }
  }

  @Reference()
  void setAwsS3AssetStore(AwsS3AssetStore store) {
<span class="nc" id="L396">    awsS3AssetStore = store;</span>
<span class="nc" id="L397">  }</span>

  @Reference()
  void setAssetManager(AssetManager service) {
<span class="nc" id="L401">    assetManager = service;</span>
<span class="nc" id="L402">  }</span>

  @Reference()
  void setSecurityService(SecurityService service) {
<span class="nc" id="L406">    securityService = service;</span>
<span class="nc" id="L407">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>