<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>Mpeg7CaptionConverter.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-caption-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.caption.converters</a> &gt; <span class="el_source">Mpeg7CaptionConverter.java</span></div><h1>Mpeg7CaptionConverter.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.caption.converters;

import org.opencastproject.caption.api.Caption;
import org.opencastproject.caption.api.CaptionConverter;
import org.opencastproject.caption.api.CaptionConverterException;
import org.opencastproject.caption.api.IllegalTimeFormatException;
import org.opencastproject.caption.api.Time;
import org.opencastproject.caption.impl.CaptionImpl;
import org.opencastproject.caption.impl.TimeImpl;
import org.opencastproject.mediapackage.MediaPackageElement;
import org.opencastproject.mediapackage.MediaPackageElement.Type;
import org.opencastproject.metadata.mpeg7.Audio;
import org.opencastproject.metadata.mpeg7.AudioSegment;
import org.opencastproject.metadata.mpeg7.FreeTextAnnotation;
import org.opencastproject.metadata.mpeg7.FreeTextAnnotationImpl;
import org.opencastproject.metadata.mpeg7.MediaDuration;
import org.opencastproject.metadata.mpeg7.MediaTime;
import org.opencastproject.metadata.mpeg7.MediaTimeImpl;
import org.opencastproject.metadata.mpeg7.MediaTimePoint;
import org.opencastproject.metadata.mpeg7.Mpeg7Catalog;
import org.opencastproject.metadata.mpeg7.Mpeg7CatalogImpl;
import org.opencastproject.metadata.mpeg7.TemporalDecomposition;
import org.opencastproject.metadata.mpeg7.TextAnnotation;
import org.opencastproject.util.XmlSafeParser;

import org.osgi.service.component.annotations.Component;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Set;
import java.util.TimeZone;

import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerConfigurationException;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactoryConfigurationError;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;

/**
 * This is converter for Mpeg7 caption format.
 */
@Component(
    immediate = true,
    service = { CaptionConverter.class },
    property = {
        &quot;service.description=Mpeg7 caption converter&quot;,
        &quot;caption.format=mpeg7&quot;
    }
)
<span class="fc" id="L81">public class Mpeg7CaptionConverter implements CaptionConverter {</span>

  /** File extension for mpeg 7 catalogs */
  private static final String EXTENSION = &quot;xml&quot;;

  /** The logger */
<span class="fc" id="L87">  private static final Logger logger = LoggerFactory.getLogger(Mpeg7CaptionConverter.class);</span>

  /**
   * @see org.opencastproject.caption.api.CaptionConverter#importCaption(java.io.InputStream, java.lang.String)
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  @Override
  public List&lt;Caption&gt; importCaption(InputStream inputStream, String language) throws CaptionConverterException {
<span class="fc" id="L95">    List&lt;Caption&gt; captions = new ArrayList&lt;Caption&gt;();</span>
<span class="fc" id="L96">    Mpeg7Catalog catalog = new Mpeg7CatalogImpl(inputStream);</span>
<span class="fc" id="L97">    Iterator&lt;Audio&gt; audioContentIterator = catalog.audioContent();</span>
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">    if (audioContentIterator == null)</span>
<span class="nc" id="L99">      return captions;</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">    content: while (audioContentIterator.hasNext()) {</span>
<span class="fc" id="L101">      Audio audioContent = audioContentIterator.next();</span>
<span class="fc" id="L102">      TemporalDecomposition&lt;AudioSegment&gt; audioSegments = (TemporalDecomposition&lt;AudioSegment&gt;) audioContent</span>
<span class="fc" id="L103">              .getTemporalDecomposition();</span>
<span class="fc" id="L104">      Iterator&lt;AudioSegment&gt; audioSegmentIterator = audioSegments.segments();</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">      if (audioSegmentIterator == null)</span>
<span class="nc" id="L106">        continue content;</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">      while (audioSegmentIterator.hasNext()) {</span>
<span class="fc" id="L108">        AudioSegment segment = audioSegmentIterator.next();</span>
<span class="fc" id="L109">        Iterator&lt;TextAnnotation&gt; annotationIterator = segment.textAnnotations();</span>
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">        if (annotationIterator == null)</span>
<span class="nc" id="L111">          continue content;</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">        while (annotationIterator.hasNext()) {</span>
<span class="fc" id="L113">          TextAnnotation annotation = annotationIterator.next();</span>
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">          if (!annotation.getLanguage().equals(language)) {</span>
<span class="nc" id="L115">            logger.debug(&quot;Skipping audio content '{}' because of language mismatch&quot;, audioContent.getId());</span>
<span class="nc" id="L116">            continue content;</span>
          }

<span class="fc" id="L119">          List&lt;String&gt; captionLines = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L120">          Iterator&lt;FreeTextAnnotation&gt; freeTextAnnotationIterator = annotation.freeTextAnnotations();</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">          if (freeTextAnnotationIterator == null)</span>
<span class="nc" id="L122">            continue;</span>

<span class="fc bfc" id="L124" title="All 2 branches covered.">          while (freeTextAnnotationIterator.hasNext()) {</span>
<span class="fc" id="L125">            FreeTextAnnotation freeTextAnnotation = freeTextAnnotationIterator.next();</span>
<span class="fc" id="L126">            captionLines.add(freeTextAnnotation.getText());</span>
<span class="fc" id="L127">          }</span>

<span class="fc" id="L129">          MediaTime segmentTime = segment.getMediaTime();</span>
<span class="fc" id="L130">          MediaTimePoint stp = segmentTime.getMediaTimePoint();</span>
<span class="fc" id="L131">          MediaDuration d = segmentTime.getMediaDuration();</span>

<span class="fc" id="L133">          Calendar startCalendar = Calendar.getInstance();</span>
<span class="fc" id="L134">          int millisAtStart = (int) (stp.getTimeInMilliseconds() - (((stp.getHour() * 60 + stp.getMinutes()) * 60 + stp</span>
<span class="fc" id="L135">                  .getSeconds()) * 1000));</span>
<span class="fc" id="L136">          int millisAtEnd = (int) (d.getDurationInMilliseconds() - (((d.getHours() * 60 + d.getMinutes()) * 60 + d</span>
<span class="fc" id="L137">                  .getSeconds()) * 1000));</span>

<span class="fc" id="L139">          startCalendar.set(Calendar.HOUR, stp.getHour());</span>
<span class="fc" id="L140">          startCalendar.set(Calendar.MINUTE, stp.getMinutes());</span>
<span class="fc" id="L141">          startCalendar.set(Calendar.SECOND, stp.getSeconds());</span>
<span class="fc" id="L142">          startCalendar.set(Calendar.MILLISECOND, millisAtStart);</span>

<span class="fc" id="L144">          startCalendar.add(Calendar.HOUR, d.getHours());</span>
<span class="fc" id="L145">          startCalendar.add(Calendar.MINUTE, d.getMinutes());</span>
<span class="fc" id="L146">          startCalendar.add(Calendar.SECOND, d.getSeconds());</span>
<span class="fc" id="L147">          startCalendar.set(Calendar.MILLISECOND, millisAtEnd);</span>

          try {
<span class="fc" id="L150">            Time startTime = new TimeImpl(stp.getHour(), stp.getMinutes(), stp.getSeconds(), millisAtStart);</span>
<span class="fc" id="L151">            Time endTime = new TimeImpl(startCalendar.get(Calendar.HOUR), startCalendar.get(Calendar.MINUTE),</span>
<span class="fc" id="L152">                    startCalendar.get(Calendar.SECOND), startCalendar.get(Calendar.MILLISECOND));</span>
<span class="fc" id="L153">            Caption caption = new CaptionImpl(startTime, endTime, captionLines.toArray(new String[captionLines.size()]));</span>
<span class="fc" id="L154">            captions.add(caption);</span>
<span class="nc" id="L155">          } catch (IllegalTimeFormatException e) {</span>
<span class="nc" id="L156">            logger.warn(&quot;Error setting caption time: {}&quot;, e.getMessage());</span>
<span class="fc" id="L157">          }</span>
<span class="fc" id="L158">        }</span>
<span class="fc" id="L159">      }</span>
<span class="fc" id="L160">    }</span>

<span class="fc" id="L162">    return captions;</span>
  }

  @Override
  public void exportCaption(OutputStream outputStream, List&lt;Caption&gt; captions, String language) throws IOException {

<span class="fc" id="L168">    Mpeg7Catalog mpeg7 = Mpeg7CatalogImpl.newInstance();</span>

<span class="fc" id="L170">    MediaTime mediaTime = new MediaTimeImpl(0, 0);</span>
<span class="fc" id="L171">    Audio audioContent = mpeg7.addAudioContent(&quot;captions&quot;, mediaTime, null);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L173">    TemporalDecomposition&lt;AudioSegment&gt; captionDecomposition = (TemporalDecomposition&lt;AudioSegment&gt;) audioContent</span>
<span class="fc" id="L174">            .getTemporalDecomposition();</span>

<span class="fc" id="L176">    int segmentCount = 0;</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">    for (Caption caption : captions) {</span>

      // Get all the words/parts for the transcript
<span class="fc" id="L180">      String[] words = caption.getCaption();</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">      if (words.length == 0)</span>
<span class="nc" id="L182">        continue;</span>

      // Create a new segment
<span class="fc" id="L185">      AudioSegment segment = captionDecomposition.createSegment(&quot;segment-&quot; + segmentCount++);</span>

<span class="fc" id="L187">      Time captionST = caption.getStartTime();</span>
<span class="fc" id="L188">      Time captionET = caption.getStopTime();</span>

      // Calculate start time
<span class="fc" id="L191">      Calendar startTime = Calendar.getInstance(TimeZone.getTimeZone(&quot;UTC&quot;));</span>
<span class="fc" id="L192">      startTime.setTimeInMillis(0);</span>
<span class="fc" id="L193">      startTime.add(Calendar.HOUR_OF_DAY, captionST.getHours());</span>
<span class="fc" id="L194">      startTime.add(Calendar.MINUTE, captionST.getMinutes());</span>
<span class="fc" id="L195">      startTime.add(Calendar.SECOND, captionST.getSeconds());</span>
<span class="fc" id="L196">      startTime.add(Calendar.MILLISECOND, captionST.getMilliseconds());</span>

      // Calculate end time
<span class="fc" id="L199">      Calendar endTime = Calendar.getInstance(TimeZone.getTimeZone(&quot;UTC&quot;));</span>
<span class="fc" id="L200">      endTime.setTimeInMillis(0);</span>
<span class="fc" id="L201">      endTime.add(Calendar.HOUR_OF_DAY, captionET.getHours());</span>
<span class="fc" id="L202">      endTime.add(Calendar.MINUTE, captionET.getMinutes());</span>
<span class="fc" id="L203">      endTime.add(Calendar.SECOND, captionET.getSeconds());</span>
<span class="fc" id="L204">      endTime.add(Calendar.MILLISECOND, captionET.getMilliseconds());</span>

<span class="fc" id="L206">      long startTimeInMillis = startTime.getTimeInMillis();</span>
<span class="fc" id="L207">      long endTimeInMillis = endTime.getTimeInMillis();</span>

<span class="fc" id="L209">      long duration = endTimeInMillis - startTimeInMillis;</span>

<span class="fc" id="L211">      segment.setMediaTime(new MediaTimeImpl(startTimeInMillis, duration));</span>
<span class="fc" id="L212">      TextAnnotation textAnnotation = segment.createTextAnnotation(0, 0, language);</span>

      // Collect all the words in the segment
<span class="fc" id="L215">      StringBuffer captionLine = new StringBuffer();</span>

      // Add each words/parts as segment to the catalog
<span class="fc bfc" id="L218" title="All 2 branches covered.">      for (String word : words) {</span>
<span class="pc bpc" id="L219" title="1 of 2 branches missed.">        if (captionLine.length() &gt; 0)</span>
<span class="nc" id="L220">          captionLine.append(' ');</span>
<span class="fc" id="L221">        captionLine.append(word);</span>
      }

      // Append the text to the annotation
<span class="fc" id="L225">      textAnnotation.addFreeTextAnnotation(new FreeTextAnnotationImpl(captionLine.toString()));</span>

<span class="fc" id="L227">    }</span>

<span class="fc" id="L229">    Transformer tf = null;</span>
    try {
<span class="fc" id="L231">      tf = XmlSafeParser.newTransformerFactory().newTransformer();</span>
<span class="fc" id="L232">      DOMSource xmlSource = new DOMSource(mpeg7.toXml());</span>
<span class="fc" id="L233">      tf.transform(xmlSource, new StreamResult(outputStream));</span>
<span class="nc" id="L234">    } catch (TransformerConfigurationException e) {</span>
<span class="nc" id="L235">      logger.warn(&quot;Error serializing mpeg7 captions catalog: {}&quot;, e.getMessage());</span>
<span class="nc" id="L236">      throw new IOException(e);</span>
<span class="nc" id="L237">    } catch (TransformerFactoryConfigurationError e) {</span>
<span class="nc" id="L238">      logger.warn(&quot;Error serializing mpeg7 captions catalog: {}&quot;, e.getMessage());</span>
<span class="nc" id="L239">      throw new IOException(e);</span>
<span class="nc" id="L240">    } catch (TransformerException e) {</span>
<span class="nc" id="L241">      logger.warn(&quot;Error serializing mpeg7 captions catalog: {}&quot;, e.getMessage());</span>
<span class="nc" id="L242">      throw new IOException(e);</span>
<span class="nc" id="L243">    } catch (ParserConfigurationException e) {</span>
<span class="nc" id="L244">      logger.warn(&quot;Error serializing mpeg7 captions catalog: {}&quot;, e.getMessage());</span>
<span class="nc" id="L245">      throw new IOException(e);</span>
<span class="fc" id="L246">    }</span>
<span class="fc" id="L247">  }</span>

  /**
   * @see org.opencastproject.caption.api.CaptionConverter#getLanguageList(java.io.InputStream)
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  @Override
  public String[] getLanguageList(InputStream inputStream) throws CaptionConverterException {
<span class="nc" id="L255">    Set&lt;String&gt; languages = new HashSet&lt;String&gt;();</span>

<span class="nc" id="L257">    Mpeg7Catalog catalog = new Mpeg7CatalogImpl(inputStream);</span>
<span class="nc" id="L258">    Iterator&lt;Audio&gt; audioContentIterator = catalog.audioContent();</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">    if (audioContentIterator == null)</span>
<span class="nc" id="L260">      return languages.toArray(new String[languages.size()]);</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">    content: while (audioContentIterator.hasNext()) {</span>
<span class="nc" id="L262">      Audio audioContent = audioContentIterator.next();</span>
<span class="nc" id="L263">      TemporalDecomposition&lt;AudioSegment&gt; audioSegments = (TemporalDecomposition&lt;AudioSegment&gt;) audioContent</span>
<span class="nc" id="L264">              .getTemporalDecomposition();</span>
<span class="nc" id="L265">      Iterator&lt;AudioSegment&gt; audioSegmentIterator = audioSegments.segments();</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">      if (audioSegmentIterator == null)</span>
<span class="nc" id="L267">        continue content;</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">      while (audioSegmentIterator.hasNext()) {</span>
<span class="nc" id="L269">        AudioSegment segment = audioSegmentIterator.next();</span>
<span class="nc" id="L270">        Iterator&lt;TextAnnotation&gt; annotationIterator = segment.textAnnotations();</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">        if (annotationIterator == null)</span>
<span class="nc" id="L272">          continue content;</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">        while (annotationIterator.hasNext()) {</span>
<span class="nc" id="L274">          TextAnnotation annotation = annotationIterator.next();</span>
<span class="nc" id="L275">          String language = annotation.getLanguage();</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">          if (language != null)</span>
<span class="nc" id="L277">            languages.add(language);</span>
<span class="nc" id="L278">        }</span>
<span class="nc" id="L279">      }</span>
<span class="nc" id="L280">    }</span>

<span class="nc" id="L282">    return languages.toArray(new String[languages.size()]);</span>
  }

  /**
   * @see org.opencastproject.caption.api.CaptionConverter#getExtension()
   */
  @Override
  public String getExtension() {
<span class="nc" id="L290">    return EXTENSION;</span>
  }

  @Override
  public Type getElementType() {
<span class="nc" id="L295">    return MediaPackageElement.Type.Catalog;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>