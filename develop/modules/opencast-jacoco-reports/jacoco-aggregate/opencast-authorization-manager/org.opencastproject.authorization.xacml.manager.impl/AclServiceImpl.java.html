<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AclServiceImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-authorization-manager</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.authorization.xacml.manager.impl</a> &gt; <span class="el_source">AclServiceImpl.java</span></div><h1>AclServiceImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.authorization.xacml.manager.impl;

import org.opencastproject.authorization.xacml.manager.api.AclService;
import org.opencastproject.authorization.xacml.manager.api.AclServiceException;
import org.opencastproject.authorization.xacml.manager.api.ManagedAcl;
import org.opencastproject.elasticsearch.api.SearchIndexException;
import org.opencastproject.elasticsearch.api.SearchResult;
import org.opencastproject.elasticsearch.api.SearchResultItem;
import org.opencastproject.elasticsearch.index.ElasticsearchIndex;
import org.opencastproject.elasticsearch.index.objects.event.Event;
import org.opencastproject.elasticsearch.index.objects.event.EventSearchQuery;
import org.opencastproject.elasticsearch.index.objects.series.Series;
import org.opencastproject.elasticsearch.index.objects.series.SeriesSearchQuery;
import org.opencastproject.security.api.AccessControlList;
import org.opencastproject.security.api.Organization;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.User;
import org.opencastproject.util.NotFoundException;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.List;
import java.util.Optional;
import java.util.function.Function;

/** Organization bound impl. */
public final class AclServiceImpl implements AclService {
  /** Logging utility */
<span class="fc" id="L51">  private static final Logger logger = LoggerFactory.getLogger(AclServiceImpl.class);</span>

  /** Context */
  private final Organization organization;

  /** Service dependencies */
  private final AclDb aclDb;
  private final SecurityService securityService;

  /** The Elasticsearch indices */
  protected ElasticsearchIndex index;

  public AclServiceImpl(Organization organization, AclDb aclDb, ElasticsearchIndex index,
<span class="fc" id="L64">          SecurityService securityService) {</span>
<span class="fc" id="L65">    this.organization = organization;</span>
<span class="fc" id="L66">    this.aclDb = aclDb;</span>
<span class="fc" id="L67">    this.index = index;</span>
<span class="fc" id="L68">    this.securityService = securityService;</span>
<span class="fc" id="L69">  }</span>

  @Override
  public List&lt;ManagedAcl&gt; getAcls() {
<span class="fc" id="L73">    return aclDb.getAcls(organization);</span>
  }

  @Override
  public Optional&lt;ManagedAcl&gt; getAcl(long id) {
<span class="fc" id="L78">    return aclDb.getAcl(organization, id);</span>
  }

  @Override
  public boolean updateAcl(ManagedAcl acl) {
<span class="fc" id="L83">    Optional&lt;ManagedAcl&gt; oldName = getAcl(acl.getId());</span>
<span class="fc" id="L84">    boolean updateAcl = aclDb.updateAcl(acl);</span>
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">    if (updateAcl) {</span>
<span class="pc bpc" id="L86" title="1 of 4 branches missed.">      if (oldName.isPresent() &amp;&amp; !(oldName.get().getName().equals(acl.getName()))) {</span>
<span class="fc" id="L87">        User user = securityService.getUser();</span>
<span class="fc" id="L88">        updateAclInIndex(oldName.get().getName(), acl.getName(), index, organization.getId(), user);</span>
      }
    }
<span class="fc" id="L91">    return updateAcl;</span>
  }

  @Override
  public Optional&lt;ManagedAcl&gt; createAcl(AccessControlList acl, String name) {
    // we don't need to update the Elasticsearch indices in this case
<span class="fc" id="L97">    return aclDb.createAcl(organization, acl, name);</span>
  }

  @Override
  public boolean deleteAcl(long id) throws AclServiceException, NotFoundException {
<span class="fc" id="L102">    Optional&lt;ManagedAcl&gt; deletedAcl = getAcl(id);</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">    if (aclDb.deleteAcl(organization, id)) {</span>
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">      if (deletedAcl.isPresent()) {</span>
<span class="fc" id="L105">        User user = securityService.getUser();</span>
<span class="fc" id="L106">        removeAclFromIndex(deletedAcl.get().getName(), index, organization.getId(), user);</span>
      }
<span class="fc" id="L108">      return true;</span>
    }
<span class="nc" id="L110">    throw new NotFoundException(&quot;Managed acl with id &quot; + id + &quot; not found.&quot;);</span>
  }

  /**
   * Update the Managed ACL in the events and series in the Elasticsearch index.
   *
   * @param currentAclName
   *         the current name of the managed acl
   * @param newAclName
   *         the new name of the managed acl
   * @param index
   *         the index to update
   * @param orgId
   *         the organization the managed acl belongs to
   * @param user
   *         the current user
   */
  private void updateAclInIndex(String currentAclName, String newAclName, ElasticsearchIndex index, String orgId,
          User user) {
<span class="fc" id="L129">    logger.debug(&quot;Update the events to change the managed acl name from '{}' to '{}'.&quot;, currentAclName, newAclName);</span>
<span class="fc" id="L130">    updateManagedAclForEvents(currentAclName, Optional.of(newAclName), index, orgId, user);</span>

<span class="fc" id="L132">    logger.debug(&quot;Update the series to change the managed acl name from '{}' to '{}'.&quot;, currentAclName, newAclName);</span>
<span class="fc" id="L133">    updateManagedAclForSeries(currentAclName, Optional.of(newAclName), index, orgId, user);</span>
<span class="fc" id="L134">  }</span>

  /**
   * Remove the Managed ACL from the events and series in the Elasticsearch index.
   *
   * @param currentAclName
   *         the current name of the managed acl
   * @param index
   *         the index to update
   * @param orgId
   *         the organization the managed acl belongs to
   * @param user
   *         the current user
   */
  private void removeAclFromIndex(String currentAclName, ElasticsearchIndex index, String orgId,
          User user) {
<span class="fc" id="L150">    logger.debug(&quot;Update the events to remove the managed acl name '{}'.&quot;, currentAclName);</span>
<span class="fc" id="L151">    updateManagedAclForEvents(currentAclName, Optional.empty(), index, orgId, user);</span>

<span class="fc" id="L153">    logger.debug(&quot;Update the series to remove the managed acl name '{}'.&quot;, currentAclName);</span>
<span class="fc" id="L154">    updateManagedAclForSeries(currentAclName, Optional.empty(), index, orgId, user);</span>
<span class="fc" id="L155">  }</span>

  /**
   * Update or remove the Managed Acl for the series in the Elasticsearch index.
   *
   * @param currentAclName
   *         the current name of the managed acl
   * @param newAclNameOpt
   * @param index
   *         the index to update
   * @param orgId
   *         the organization the managed acl belongs to
   * @param user
   *         the current user
   */
  private void updateManagedAclForSeries(String currentAclName, Optional&lt;String&gt; newAclNameOpt,
          ElasticsearchIndex index, String orgId, User user) {
    SearchResult&lt;Series&gt; result;
    try {
<span class="fc" id="L174">      result = index.getByQuery(new SeriesSearchQuery(orgId, user).withoutActions()</span>
<span class="fc" id="L175">              .withManagedAcl(currentAclName));</span>
<span class="nc" id="L176">    } catch (SearchIndexException e) {</span>
<span class="nc" id="L177">      logger.error(&quot;Unable to find the series in org '{}' with current managed acl name '{}'&quot;, orgId, currentAclName,</span>
              e);
<span class="nc" id="L179">      return;</span>
<span class="fc" id="L180">    }</span>

<span class="pc bpc" id="L182" title="1 of 2 branches missed.">    for (SearchResultItem&lt;Series&gt; seriesItem : result.getItems()) {</span>
<span class="nc" id="L183">      String seriesId = seriesItem.getSource().getIdentifier();</span>

<span class="nc" id="L185">      Function&lt;Optional&lt;Series&gt;, Optional&lt;Series&gt;&gt; updateFunction = (Optional&lt;Series&gt; seriesOpt) -&gt; {</span>
<span class="nc bnc" id="L186" title="All 4 branches missed.">        if (seriesOpt.isPresent() &amp;&amp; seriesOpt.get().getManagedAcl().equals(currentAclName)) {</span>
<span class="nc" id="L187">          Series series = seriesOpt.get();</span>
<span class="nc" id="L188">          series.setManagedAcl(newAclNameOpt.orElse(null));</span>
<span class="nc" id="L189">          return Optional.of(series);</span>
        }
<span class="nc" id="L191">        return Optional.empty();</span>
      };

      try {
<span class="nc" id="L195">        index.addOrUpdateSeries(seriesId, updateFunction, orgId, user);</span>
<span class="nc" id="L196">      } catch (SearchIndexException e) {</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">        if (newAclNameOpt.isPresent()) {</span>
<span class="nc" id="L198">          logger.warn(&quot;Unable to update series'{}' from current managed acl '{}' to new managed acl name '{}'&quot;,</span>
<span class="nc" id="L199">                  seriesId, currentAclName, newAclNameOpt.get(), e);</span>
        } else {
<span class="nc" id="L201">          logger.warn(&quot;Unable to update series '{}' to remove managed acl '{}'&quot;, seriesId, currentAclName, e);</span>
        }
<span class="nc" id="L203">      }</span>
    }
<span class="fc" id="L205">  }</span>

  /**
   * Update or remove the Managed Acl for the events in the Elasticsearch index.
   *
   * @param currentAclName
   *         the current name of the managed acl
   * @param newAclNameOpt
   * @param index
   *         the index to update
   * @param orgId
   *         the organization the managed acl belongs to
   * @param user
   *         the current user
   */
  private void updateManagedAclForEvents(String currentAclName, Optional&lt;String&gt; newAclNameOpt,
          ElasticsearchIndex index, String orgId, User user) {
    SearchResult&lt;Event&gt; result;
    try {
<span class="fc" id="L224">      result = index.getByQuery(new EventSearchQuery(orgId, user).withoutActions()</span>
<span class="fc" id="L225">              .withManagedAcl(currentAclName));</span>
<span class="nc" id="L226">    } catch (SearchIndexException e) {</span>
<span class="nc" id="L227">      logger.error(&quot;Unable to find the events in org '{}' with current managed acl name '{}' for event&quot;,</span>
              orgId, currentAclName, e);
<span class="nc" id="L229">      return;</span>
<span class="fc" id="L230">    }</span>

<span class="pc bpc" id="L232" title="1 of 2 branches missed.">    for (SearchResultItem&lt;Event&gt; eventItem : result.getItems()) {</span>
<span class="nc" id="L233">      String eventId = eventItem.getSource().getIdentifier();</span>

<span class="nc" id="L235">      Function&lt;Optional&lt;Event&gt;, Optional&lt;Event&gt;&gt; updateFunction = (Optional&lt;Event&gt; eventOpt) -&gt; {</span>
<span class="nc bnc" id="L236" title="All 4 branches missed.">        if (eventOpt.isPresent() &amp;&amp; eventOpt.get().getManagedAcl().equals(currentAclName)) {</span>
<span class="nc" id="L237">          Event event = eventOpt.get();</span>
<span class="nc" id="L238">          event.setManagedAcl(newAclNameOpt.orElse(null));</span>
<span class="nc" id="L239">          return Optional.of(event);</span>
        }
<span class="nc" id="L241">        return Optional.empty();</span>
      };

      try {
<span class="nc" id="L245">        index.addOrUpdateEvent(eventId, updateFunction, orgId, user);</span>
<span class="nc" id="L246">      } catch (SearchIndexException e) {</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">        if (newAclNameOpt.isPresent()) {</span>
<span class="nc" id="L248">          logger.warn(</span>
                  &quot;Unable to update event '{}' from current managed acl '{}' to new managed acl name '{}'&quot;,
<span class="nc" id="L250">                  eventId, currentAclName, newAclNameOpt.get(), e);</span>
        } else {
<span class="nc" id="L252">          logger.warn(&quot;Unable to update event '{}' to remove managed acl '{}'&quot;, eventId, currentAclName, e);</span>
        }
<span class="nc" id="L254">      }</span>
    }
<span class="fc" id="L256">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>