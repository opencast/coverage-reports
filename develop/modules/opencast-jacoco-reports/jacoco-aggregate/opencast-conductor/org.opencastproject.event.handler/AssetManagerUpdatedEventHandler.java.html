<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AssetManagerUpdatedEventHandler.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-conductor</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.event.handler</a> &gt; <span class="el_source">AssetManagerUpdatedEventHandler.java</span></div><h1>AssetManagerUpdatedEventHandler.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.event.handler;


import org.opencastproject.assetmanager.api.AssetManager;
import org.opencastproject.assetmanager.api.AssetManagerException;
import org.opencastproject.assetmanager.api.Snapshot;
import org.opencastproject.mediapackage.Attachment;
import org.opencastproject.mediapackage.Catalog;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.mediapackage.MediaPackageElementFlavor;
import org.opencastproject.mediapackage.MediaPackageElements;
import org.opencastproject.mediapackage.MediaPackageException;
import org.opencastproject.message.broker.api.series.SeriesItem;
import org.opencastproject.metadata.dublincore.DublinCore;
import org.opencastproject.metadata.dublincore.DublinCoreCatalog;
import org.opencastproject.metadata.dublincore.DublinCoreCatalogService;
import org.opencastproject.metadata.dublincore.DublinCoreUtil;
import org.opencastproject.security.api.AclScope;
import org.opencastproject.security.api.AuthorizationService;
import org.opencastproject.security.api.Organization;
import org.opencastproject.security.api.OrganizationDirectoryService;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.User;
import org.opencastproject.security.util.SecurityUtil;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.data.Tuple;
import org.opencastproject.workspace.api.Workspace;

import org.apache.commons.io.FilenameUtils;
import org.osgi.framework.BundleContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.net.URI;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;

/**
 * Responds to series events by re-distributing metadata and security policy files to episodes.
 */
@Component(
    immediate = true,
    service = {
        AssetManagerUpdatedEventHandler.class
    },
    property = {
        &quot;service.description=AssetManagerUpdatedEventHandler&quot;
    }
)
<span class="nc" id="L76">public class AssetManagerUpdatedEventHandler {</span>

  /** The logger */
<span class="nc" id="L79">  protected static final Logger logger = LoggerFactory.getLogger(AssetManagerUpdatedEventHandler.class);</span>

  /** The archive */
<span class="nc" id="L82">  protected AssetManager assetManager = null;</span>

  /** The security service */
<span class="nc" id="L85">  protected SecurityService securityService = null;</span>

  /** The authorization service */
<span class="nc" id="L88">  protected AuthorizationService authorizationService = null;</span>

  /** The organization directory */
<span class="nc" id="L91">  protected OrganizationDirectoryService organizationDirectoryService = null;</span>

  /** Dublin core catalog service */
<span class="nc" id="L94">  protected DublinCoreCatalogService dublinCoreService = null;</span>

  /** The workspace */
<span class="nc" id="L97">  protected Workspace workspace = null;</span>

  /** The system account to use for running asynchronous events */
<span class="nc" id="L100">  protected String systemAccount = null;</span>

  /**
   * OSGI callback for component activation.
   *
   * @param bundleContext
   *          the OSGI bundle context
   */
  @Activate
  protected void activate(BundleContext bundleContext) {
<span class="nc" id="L110">    this.systemAccount = bundleContext.getProperty(&quot;org.opencastproject.security.digest.user&quot;);</span>
<span class="nc" id="L111">  }</span>

  /**
   * @param workspace
   *          the workspace to set
   */
  @Reference
  public void setWorkspace(Workspace workspace) {
<span class="nc" id="L119">    this.workspace = workspace;</span>
<span class="nc" id="L120">  }</span>

  /**
   * @param dublinCoreService
   *          the dublin core service to set
   */
  @Reference
  public void setDublinCoreCatalogService(DublinCoreCatalogService dublinCoreService) {
<span class="nc" id="L128">    this.dublinCoreService = dublinCoreService;</span>
<span class="nc" id="L129">  }</span>

  /**
   * @param assetManager
   *          the asset manager to set
   */
  @Reference
  public void setAssetManager(AssetManager assetManager) {
<span class="nc" id="L137">    this.assetManager = assetManager;</span>
<span class="nc" id="L138">  }</span>

  /**
   * @param securityService
   *          the securityService to set
   */
  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="nc" id="L146">    this.securityService = securityService;</span>
<span class="nc" id="L147">  }</span>

  /**
   * @param authorizationService
   *          the authorizationService to set
   */
  @Reference
  public void setAuthorizationService(AuthorizationService authorizationService) {
<span class="nc" id="L155">    this.authorizationService = authorizationService;</span>
<span class="nc" id="L156">  }</span>

  /**
   * @param organizationDirectoryService
   *          the organizationDirectoryService to set
   */
  @Reference
  public void setOrganizationDirectoryService(OrganizationDirectoryService organizationDirectoryService) {
<span class="nc" id="L164">    this.organizationDirectoryService = organizationDirectoryService;</span>
<span class="nc" id="L165">  }</span>

  public void handleEvent(final SeriesItem seriesItem) {
    // A series or its ACL has been updated. Find any mediapackages with that series, and update them.
<span class="nc" id="L169">    logger.debug(&quot;Handling {}&quot;, seriesItem);</span>
<span class="nc" id="L170">    String seriesId = seriesItem.getSeriesId();</span>

    // We must be an administrative user to make this query
<span class="nc" id="L173">    final User prevUser = securityService.getUser();</span>
<span class="nc" id="L174">    final Organization prevOrg = securityService.getOrganization();</span>
    try {
<span class="nc" id="L176">      securityService.setUser(SecurityUtil.createSystemUser(systemAccount, prevOrg));</span>

<span class="nc" id="L178">      List&lt;Snapshot&gt; snapshots = assetManager.getLatestSnapshotsBySeriesId(seriesId);</span>

<span class="nc" id="L180">      Collections.sort(</span>
          snapshots,
<span class="nc" id="L182">          Comparator.comparing(s-&gt;s.getMediaPackage().getIdentifier().toString())</span>
      );

<span class="nc bnc" id="L185" title="All 2 branches missed.">      for (Snapshot snapshot : snapshots) {</span>
<span class="nc" id="L186">        final String orgId = snapshot.getOrganizationId();</span>
<span class="nc" id="L187">        final Organization organization = organizationDirectoryService.getOrganization(orgId);</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">        if (organization == null) {</span>
<span class="nc" id="L189">          logger.warn(&quot;Skipping update of episode {} since organization {} is unknown&quot;,</span>
<span class="nc" id="L190">                  snapshot.getMediaPackage().getIdentifier().toString(), orgId);</span>
<span class="nc" id="L191">          continue;</span>
        }
<span class="nc" id="L193">        securityService.setOrganization(organization);</span>

<span class="nc" id="L195">        MediaPackage mp = snapshot.getMediaPackage();</span>

        // Update the series XACML file
<span class="nc" id="L198">        Tuple&lt;MediaPackage, Attachment&gt; mpAclAttachmentTuple = null;</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (SeriesItem.Type.UpdateAcl.equals(seriesItem.getType())) {</span>
          // Build a new XACML file for this mediapackage
          try {
<span class="nc bnc" id="L202" title="All 2 branches missed.">            if (seriesItem.getOverrideEpisodeAcl()) {</span>
<span class="nc" id="L203">              authorizationService.removeAcl(mp, AclScope.Episode);</span>
            }
<span class="nc" id="L205">            mpAclAttachmentTuple = authorizationService.setAcl(mp,</span>
<span class="nc" id="L206">                AclScope.Series, seriesItem.getAcl());</span>
<span class="nc" id="L207">          } catch (MediaPackageException e) {</span>
<span class="nc" id="L208">            logger.error(&quot;Error setting ACL for media package {}&quot;, mp.getIdentifier(), e);</span>
<span class="nc" id="L209">          }</span>
        }

        // Update the series dublin core or extended metadata
<span class="nc bnc" id="L213" title="All 2 branches missed.">        if (SeriesItem.Type.UpdateCatalog.equals(seriesItem.getType())</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                || SeriesItem.Type.UpdateElement.equals(seriesItem.getType())) {</span>
<span class="nc" id="L215">          DublinCoreCatalog seriesDublinCore = null;</span>
<span class="nc" id="L216">          MediaPackageElementFlavor catalogType = null;</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">          if (SeriesItem.Type.UpdateCatalog.equals(seriesItem.getType())) {</span>
<span class="nc" id="L218">            seriesDublinCore = seriesItem.getMetadata();</span>
<span class="nc" id="L219">            mp.setSeriesTitle(seriesDublinCore.getFirst(DublinCore.PROPERTY_TITLE));</span>
<span class="nc" id="L220">            catalogType = MediaPackageElements.SERIES;</span>
          } else {
<span class="nc" id="L222">            seriesDublinCore = seriesItem.getExtendedMetadata();</span>
<span class="nc" id="L223">            catalogType = MediaPackageElementFlavor.flavor(seriesItem.getElementType(), &quot;series&quot;);</span>
          }

          // Update the series dublin core
<span class="nc" id="L227">          Catalog[] seriesCatalogs = mp.getCatalogs(catalogType);</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">          if (seriesCatalogs.length == 1) {</span>
<span class="nc" id="L229">            Catalog c = seriesCatalogs[0];</span>
<span class="nc" id="L230">            String filename = FilenameUtils.getName(c.getURI().toString());</span>
<span class="nc" id="L231">            URI uri = workspace.put(mp.getIdentifier().toString(), c.getIdentifier(), filename,</span>
<span class="nc" id="L232">                    dublinCoreService.serialize(seriesDublinCore));</span>
<span class="nc" id="L233">            c.setURI(uri);</span>
            // setting the URI to a new source so the checksum will most like be invalid
<span class="nc" id="L235">            c.setChecksum(null);</span>
          }
        }

        // Remove the series catalogs and isPartOf from episode catalog
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (SeriesItem.Type.Delete.equals(seriesItem.getType())) {</span>
<span class="nc" id="L241">          mp.setSeries(null);</span>
<span class="nc" id="L242">          mp.setSeriesTitle(null);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">          for (Catalog seriesCatalog : mp.getCatalogs(MediaPackageElements.SERIES)) {</span>
<span class="nc" id="L244">            mp.remove(seriesCatalog);</span>
          }
<span class="nc" id="L246">          authorizationService.removeAcl(mp, AclScope.Series);</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">          for (Catalog episodeCatalog : mp.getCatalogs(MediaPackageElements.EPISODE)) {</span>
<span class="nc" id="L248">            DublinCoreCatalog episodeDublinCore = DublinCoreUtil.loadDublinCore(workspace, episodeCatalog);</span>
<span class="nc" id="L249">            episodeDublinCore.remove(DublinCore.PROPERTY_IS_PART_OF);</span>
<span class="nc" id="L250">            String filename = FilenameUtils.getName(episodeCatalog.getURI().toString());</span>
<span class="nc" id="L251">            URI uri = workspace.put(mp.getIdentifier().toString(), episodeCatalog.getIdentifier(), filename,</span>
<span class="nc" id="L252">                    dublinCoreService.serialize(episodeDublinCore));</span>
<span class="nc" id="L253">            episodeCatalog.setURI(uri);</span>
            // setting the URI to a new source so the checksum will most like be invalid
<span class="nc" id="L255">            episodeCatalog.setChecksum(null);</span>
          }
          // here we don't know the series extended metadata types,
          // we assume that all series catalog flavors have a fixed subtype: series
<span class="nc" id="L259">          MediaPackageElementFlavor seriesFlavor = MediaPackageElementFlavor.flavor(&quot;*&quot;, &quot;series&quot;);</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">          for (Catalog catalog : mp.getCatalogs()) {</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">            if (catalog.getFlavor().matches(seriesFlavor)) {</span>
<span class="nc" id="L262">              mp.remove(catalog);</span>
            }
          }
        }

        try {
          // Update the asset manager with the modified mediapackage
<span class="nc" id="L269">          assetManager.takeSnapshot(snapshot.getOwner(), mp);</span>
<span class="nc" id="L270">        } catch (AssetManagerException e) {</span>
<span class="nc" id="L271">          logger.error(&quot;Error updating mediapackage {}&quot;, mp.getIdentifier().toString(), e);</span>
        } finally {
<span class="nc bnc" id="L273" title="All 2 branches missed.">          if (mpAclAttachmentTuple != null) {</span>
            try {
<span class="nc" id="L275">              workspace.delete(mpAclAttachmentTuple.getB().getURI());</span>
<span class="nc" id="L276">            } catch (Exception ex) {</span>
              // We only want to clean up. If the file is gone, that is fine too.
<span class="nc" id="L278">            }</span>
          }
        }
<span class="nc" id="L281">      }</span>
<span class="nc" id="L282">    } catch (IOException | NotFoundException e) {</span>
<span class="nc" id="L283">      logger.warn(&quot;Unable to handle update event for series {} for user {}: {}&quot;,</span>
<span class="nc" id="L284">                  seriesItem, prevUser.getUsername(), e.getMessage());</span>
    } finally {
<span class="nc" id="L286">      securityService.setOrganization(prevOrg);</span>
<span class="nc" id="L287">      securityService.setUser(prevUser);</span>
    }
<span class="nc" id="L289">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>