<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SchedulerItem.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-message-broker-api</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.message.broker.api.scheduler</a> &gt; <span class="el_source">SchedulerItem.java</span></div><h1>SchedulerItem.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.message.broker.api.scheduler;

import org.opencastproject.metadata.dublincore.DublinCoreCatalog;
import org.opencastproject.metadata.dublincore.DublinCoreXmlFormat;
import org.opencastproject.security.api.AccessControlList;
import org.opencastproject.security.api.AccessControlParser;

import com.google.gson.Gson;

import org.apache.commons.lang3.StringUtils;

import java.io.IOException;
import java.io.Serializable;
import java.io.StringReader;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.Properties;
import java.util.Set;

/**
 * {@link Serializable} class that represents all of the possible messages sent through a SchedulerService queue.
 */
public class SchedulerItem implements Serializable {
  private static final long serialVersionUID = 6061069989788904237L;

<span class="fc" id="L48">  private static final Gson gson = new Gson();</span>

  private final String event;
  private final String properties;
  private final String acl;
  private final String agentId;
  private final long end;
  private final String presenters;
  private final String recordingState;
  private final long start;

  private final Type type;

<span class="fc" id="L61">  public enum Type {</span>
<span class="fc" id="L62">    UpdateCatalog, UpdateProperties, UpdateAcl, UpdateAgentId, UpdateEnd, UpdatePresenters, UpdateRecordingStatus,</span>
<span class="fc" id="L63">    UpdateStart, DeleteRecordingStatus, Delete</span>
  };

  /**
   * @param event
   *          The event details to update to.
   * @return Builds {@link SchedulerItem} for updating a scheduled event.
   */
  public static SchedulerItem updateCatalog(DublinCoreCatalog event) {
<span class="fc" id="L72">    return new SchedulerItem(event);</span>
  }

  /**
   * @param properties
   *          The new properties to update to.
   * @return Builds {@link SchedulerItem} for updating the properties of an event.
   */
  public static SchedulerItem updateProperties(Map&lt;String, String&gt; properties) {
<span class="fc" id="L81">    return new SchedulerItem(properties);</span>
  }

  /**
   * @return Builds {@link SchedulerItem} for deleting an event.
   */
  public static SchedulerItem delete() {
<span class="fc" id="L88">    return new SchedulerItem(Type.Delete);</span>
  }

  /**
   * @param accessControlList
   *          the access control list
   * @return Builds {@link SchedulerItem} for updating the access control list of an event.
   */
  public static SchedulerItem updateAcl(AccessControlList accessControlList) {
<span class="fc" id="L97">    return new SchedulerItem(accessControlList);</span>
  }

  /**
   * @param state
   *          The recording state
   * @param lastHeardFrom
   *          The recording last heard from date
   * @return Builds {@link SchedulerItem} for updating a recording.
   */
  public static SchedulerItem updateRecordingStatus(String state, Long lastHeardFrom) {
<span class="fc" id="L108">    return new SchedulerItem(state, lastHeardFrom);</span>
  }

  /**
   * @param start
   *        The new start time for the event.
   * @return Builds {@link SchedulerItem} for updating the start of an event.
   */
  public static SchedulerItem updateStart(Date start) {
<span class="fc" id="L117">    return new SchedulerItem(start, null, Type.UpdateStart);</span>
  }

  /**
   * @param end
   *        The new end time for the event.
   * @return Builds {@link SchedulerItem} for updating the end of an event.
   */
  public static SchedulerItem updateEnd(Date end) {
<span class="fc" id="L126">    return new SchedulerItem(null, end, Type.UpdateEnd);</span>
  }

  /**
   * @param presenters
   *        The new set of presenters for the event.
   * @return Builds {@link SchedulerItem} for updating the presenters of an event.
   */
  public static SchedulerItem updatePresenters(Set&lt;String&gt; presenters) {
<span class="nc" id="L135">    return new SchedulerItem(presenters);</span>
  }

  /**
   * @param agentId
   *        The new agent id for the event.
   * @return Builds {@link SchedulerItem} for updating the agent id of an event.
   */
  public static SchedulerItem updateAgent(String agentId) {
<span class="fc" id="L144">    return new SchedulerItem(agentId);</span>
  }

  /**
   * @return Builds {@link SchedulerItem} for deleting a recording.
   */
  public static SchedulerItem deleteRecordingState() {
<span class="fc" id="L151">    return new SchedulerItem(Type.DeleteRecordingStatus);</span>
  }

  /**
   * Constructor to build an update event {@link SchedulerItem}.
   *
   * @param event
   *          The event details to update.
   */
<span class="fc" id="L160">  public SchedulerItem(DublinCoreCatalog event) {</span>
    try {
<span class="fc" id="L162">      this.event = event.toXmlString();</span>
<span class="nc" id="L163">    } catch (IOException e) {</span>
<span class="nc" id="L164">      throw new IllegalStateException();</span>
<span class="fc" id="L165">    }</span>
<span class="fc" id="L166">    this.properties = null;</span>
<span class="fc" id="L167">    this.acl = null;</span>
<span class="fc" id="L168">    this.agentId = null;</span>
<span class="fc" id="L169">    this.end = -1;</span>
<span class="fc" id="L170">    this.presenters = null;</span>
<span class="fc" id="L171">    this.recordingState = null;</span>
<span class="fc" id="L172">    this.start = -1;</span>
<span class="fc" id="L173">    this.type = Type.UpdateCatalog;</span>
<span class="fc" id="L174">  }</span>

  /**
   * Constructor to build an update properties for an event {@link SchedulerItem}.
   *
   * @param properties
   *          The properties to update.
   */
<span class="fc" id="L182">  public SchedulerItem(Map&lt;String, String&gt; properties) {</span>
<span class="fc" id="L183">    this.event = null;</span>
<span class="fc" id="L184">    this.properties = serializeProperties(properties);</span>
<span class="fc" id="L185">    this.acl = null;</span>
<span class="fc" id="L186">    this.agentId = null;</span>
<span class="fc" id="L187">    this.end = -1;</span>
<span class="fc" id="L188">    this.presenters = null;</span>
<span class="fc" id="L189">    this.recordingState = null;</span>
<span class="fc" id="L190">    this.start = -1;</span>
<span class="fc" id="L191">    this.type = Type.UpdateProperties;</span>
<span class="fc" id="L192">  }</span>

  /**
   * Constructor to build a delete event {@link SchedulerItem}.
   *
   */
<span class="fc" id="L198">  public SchedulerItem(Type type) {</span>
<span class="fc" id="L199">    this.event = null;</span>
<span class="fc" id="L200">    this.properties = null;</span>
<span class="fc" id="L201">    this.acl = null;</span>
<span class="fc" id="L202">    this.agentId = null;</span>
<span class="fc" id="L203">    this.end = -1;</span>
<span class="fc" id="L204">    this.presenters = null;</span>
<span class="fc" id="L205">    this.recordingState = null;</span>
<span class="fc" id="L206">    this.start = -1;</span>
<span class="fc" id="L207">    this.type = type;</span>
<span class="fc" id="L208">  }</span>

  /**
   * Constructor to build an update access control list event {@link SchedulerItem}.
   *
   * @param accessControlList
   *          The access control list
   */
<span class="fc" id="L216">  public SchedulerItem(AccessControlList accessControlList) {</span>
<span class="fc" id="L217">    this.event = null;</span>
<span class="fc" id="L218">    this.properties = null;</span>
    try {
<span class="fc" id="L220">      this.acl = AccessControlParser.toJson(accessControlList);</span>
<span class="nc" id="L221">    } catch (IOException e) {</span>
<span class="nc" id="L222">      throw new IllegalStateException();</span>
<span class="fc" id="L223">    }</span>
<span class="fc" id="L224">    this.agentId = null;</span>
<span class="fc" id="L225">    this.end = -1;</span>
<span class="fc" id="L226">    this.presenters = null;</span>
<span class="fc" id="L227">    this.recordingState = null;</span>
<span class="fc" id="L228">    this.start = -1;</span>
<span class="fc" id="L229">    this.type = Type.UpdateAcl;</span>
<span class="fc" id="L230">  }</span>

  /**
   * Constructor to build an update recording status event {@link SchedulerItem}.
   *
   * @param state
   *          the recording status
   * @param lastHeardFrom
   *          the last heard from time
   */
<span class="fc" id="L240">  public SchedulerItem(String state, Long lastHeardFrom) {</span>
<span class="fc" id="L241">    this.event = null;</span>
<span class="fc" id="L242">    this.properties = null;</span>
<span class="fc" id="L243">    this.acl = null;</span>
<span class="fc" id="L244">    this.agentId = null;</span>
<span class="fc" id="L245">    this.end = -1;</span>
<span class="fc" id="L246">    this.presenters = null;</span>
<span class="fc" id="L247">    this.recordingState = state;</span>
<span class="fc" id="L248">    this.start = -1;</span>
<span class="fc" id="L249">    this.type = Type.UpdateRecordingStatus;</span>
<span class="fc" id="L250">  }</span>

<span class="fc" id="L252">  public SchedulerItem(Date start, Date end, Type type) {</span>
<span class="fc" id="L253">    this.event = null;</span>
<span class="fc" id="L254">    this.acl = null;</span>
<span class="fc" id="L255">    this.agentId = null;</span>
<span class="fc bfc" id="L256" title="All 2 branches covered.">    this.end = end == null ? -1 : end.getTime();</span>
<span class="fc" id="L257">    this.presenters = null;</span>
<span class="fc" id="L258">    this.properties = null;</span>
<span class="fc" id="L259">    this.recordingState = null;</span>
<span class="fc bfc" id="L260" title="All 2 branches covered.">    this.start = start == null ? -1 : start.getTime();</span>
<span class="fc" id="L261">    this.type = type;</span>
<span class="fc" id="L262">  }</span>

<span class="fc" id="L264">  public SchedulerItem(String agentId) {</span>
<span class="fc" id="L265">    this.event = null;</span>
<span class="fc" id="L266">    this.acl = null;</span>
<span class="fc" id="L267">    this.agentId = agentId;</span>
<span class="fc" id="L268">    this.end = -1;</span>
<span class="fc" id="L269">    this.presenters = null;</span>
<span class="fc" id="L270">    this.properties = null;</span>
<span class="fc" id="L271">    this.recordingState = null;</span>
<span class="fc" id="L272">    this.start = -1;</span>
<span class="fc" id="L273">    this.type = Type.UpdateAgentId;</span>
<span class="fc" id="L274">  }</span>

<span class="nc" id="L276">  public SchedulerItem(Set&lt;String&gt; presenters) {</span>
<span class="nc" id="L277">    this.event = null;</span>
<span class="nc" id="L278">    this.acl = null;</span>
<span class="nc" id="L279">    this.agentId = null;</span>
<span class="nc" id="L280">    this.end = -1;</span>
<span class="nc" id="L281">    this.presenters = gson.toJson(presenters);</span>
<span class="nc" id="L282">    this.properties = null;</span>
<span class="nc" id="L283">    this.recordingState = null;</span>
<span class="nc" id="L284">    this.start = -1;</span>
<span class="nc" id="L285">    this.type = Type.UpdatePresenters;</span>
<span class="nc" id="L286">  }</span>
  public DublinCoreCatalog getEvent() {
<span class="nc bnc" id="L288" title="All 2 branches missed.">    if (StringUtils.isBlank(event)) {</span>
<span class="nc" id="L289">      return null;</span>
    }

<span class="nc" id="L292">    return DublinCoreXmlFormat.readOpt(event).orElse(null);</span>
  }

  public Map&lt;String, String&gt; getProperties() {
    try {
<span class="nc" id="L297">      return parseProperties(properties);</span>
<span class="nc" id="L298">    } catch (IOException e) {</span>
<span class="nc" id="L299">      throw new IllegalStateException();</span>
    }
  }

  public AccessControlList getAcl() {
    try {
<span class="nc bnc" id="L305" title="All 2 branches missed.">      return acl == null ? null : AccessControlParser.parseAcl(acl);</span>
<span class="nc" id="L306">    } catch (Exception e) {</span>
<span class="nc" id="L307">      throw new IllegalStateException(e);</span>
    }
  }

  public String getAgentId() {
<span class="nc" id="L312">    return agentId;</span>
  }

  public Date getEnd() {
<span class="nc bnc" id="L316" title="All 2 branches missed.">    return end &lt; 0 ? null : new Date(end);</span>
  }

  @SuppressWarnings(&quot;unchecked&quot;)
  public Set&lt;String&gt; getPresenters() {
<span class="nc" id="L321">    return gson.fromJson(presenters, Set.class);</span>
  }

  public String getRecordingState() {
<span class="nc" id="L325">    return recordingState;</span>
  }

  public Date getStart() {
<span class="nc bnc" id="L329" title="All 2 branches missed.">    return start &lt; 0 ? null : new Date(start);</span>
  }

  public Type getType() {
<span class="nc" id="L333">    return type;</span>
  }

  /**
   * Serializes Properties to String.
   *
   * @param caProperties
   *          properties to be serialized
   * @return serialized properties
   */
  private String serializeProperties(Map&lt;String, String&gt; caProperties) {
<span class="fc" id="L344">    StringBuilder wfPropertiesString = new StringBuilder();</span>
<span class="fc bfc" id="L345" title="All 2 branches covered.">    for (Map.Entry&lt;String, String&gt; entry : caProperties.entrySet()) {</span>
<span class="fc" id="L346">      wfPropertiesString.append(entry.getKey() + &quot;=&quot; + entry.getValue() + &quot;\n&quot;);</span>
<span class="fc" id="L347">    }</span>
<span class="fc" id="L348">    return wfPropertiesString.toString();</span>
  }

  /**
   * Parses Properties represented as String.
   *
   * @param serializedProperties
   *          properties to be parsed.
   * @return parsed properties
   * @throws IOException
   *           if parsing fails
   */
  private Map&lt;String, String&gt; parseProperties(String serializedProperties) throws IOException {
<span class="nc" id="L361">    Properties caProperties = new Properties();</span>
<span class="nc" id="L362">    caProperties.load(new StringReader(serializedProperties));</span>
<span class="nc" id="L363">    return new HashMap&lt;String, String&gt;((Map) caProperties);</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>