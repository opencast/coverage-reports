<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>UserEndpoint.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-userdirectory</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.userdirectory.endpoint</a> &gt; <span class="el_source">UserEndpoint.java</span></div><h1>UserEndpoint.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.userdirectory.endpoint;

import static org.apache.http.HttpStatus.SC_BAD_REQUEST;
import static org.apache.http.HttpStatus.SC_CONFLICT;
import static org.apache.http.HttpStatus.SC_CREATED;
import static org.apache.http.HttpStatus.SC_FORBIDDEN;
import static org.apache.http.HttpStatus.SC_INTERNAL_SERVER_ERROR;
import static org.apache.http.HttpStatus.SC_NOT_FOUND;
import static org.apache.http.HttpStatus.SC_OK;
import static org.opencastproject.util.RestUtil.getEndpointUrl;
import static org.opencastproject.util.UrlSupport.uri;
import static org.opencastproject.util.doc.rest.RestParameter.Type.STRING;

import org.opencastproject.security.api.JaxbUser;
import org.opencastproject.security.api.JaxbUserList;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.UnauthorizedException;
import org.opencastproject.security.api.User;
import org.opencastproject.security.impl.jpa.JpaOrganization;
import org.opencastproject.security.impl.jpa.JpaRole;
import org.opencastproject.security.impl.jpa.JpaUser;
import org.opencastproject.userdirectory.JpaUserAndRoleProvider;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.UrlSupport;
import org.opencastproject.util.data.Tuple;
import org.opencastproject.util.doc.rest.RestParameter;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestResponse;
import org.opencastproject.util.doc.rest.RestService;

import org.apache.commons.lang3.StringUtils;
import org.json.simple.JSONArray;
import org.json.simple.JSONValue;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.jaxrs.whiteboard.propertytypes.JaxrsResource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Set;

import javax.ws.rs.DELETE;
import javax.ws.rs.FormParam;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.PUT;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;

/**
 * Provides a sorted set of known users
 */
@Path(&quot;/user-utils&quot;)
@RestService(
    name = &quot;UsersUtils&quot;,
    title = &quot;User utils&quot;,
    notes = &quot;This service offers the default CRUD Operations for the internal Opencast users.&quot;,
    abstractText = &quot;Provides operations for internal Opencast users&quot;)
@Component(
    property = {
        &quot;service.description=User REST endpoint&quot;,
        &quot;opencast.service.type=org.opencastproject.userdirectory.endpoint.UserEndpoint&quot;,
        &quot;opencast.service.path=/user-utils&quot;,
        &quot;opencast.service.jobproducer=false&quot;
    },
    immediate = true,
    service = { UserEndpoint.class }
)
@JaxrsResource
<span class="nc" id="L99">public class UserEndpoint {</span>

  /** The logger */
<span class="nc" id="L102">  private static final Logger logger = LoggerFactory.getLogger(UserEndpoint.class);</span>

  private JpaUserAndRoleProvider jpaUserAndRoleProvider;

  private SecurityService securityService;

  private String endpointBaseUrl;

  /** OSGi callback. */
  public void activate(ComponentContext cc) {
<span class="nc" id="L112">    logger.info(&quot;Start users endpoint&quot;);</span>
<span class="nc" id="L113">    final Tuple&lt;String, String&gt; endpointUrl = getEndpointUrl(cc);</span>
<span class="nc" id="L114">    endpointBaseUrl = UrlSupport.concat(endpointUrl.getA(), endpointUrl.getB());</span>
<span class="nc" id="L115">  }</span>

  /**
   * @param securityService
   *          the securityService to set
   */
  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="nc" id="L123">    this.securityService = securityService;</span>
<span class="nc" id="L124">  }</span>

  /**
   * @param jpaUserAndRoleProvider
   *          the persistenceProperties to set
   */
  @Reference
  public void setJpaUserAndRoleProvider(JpaUserAndRoleProvider jpaUserAndRoleProvider) {
<span class="nc" id="L132">    this.jpaUserAndRoleProvider = jpaUserAndRoleProvider;</span>
<span class="nc" id="L133">  }</span>

  @GET
  @Path(&quot;users.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(
      name = &quot;allusersasjson&quot;,
      description = &quot;Returns a list of users&quot;,
      returnDescription = &quot;Returns a JSON representation of the list of user accounts&quot;,
      restParameters = {
      @RestParameter(
        name = &quot;limit&quot;,
        defaultValue = &quot;100&quot;,
        description = &quot;The maximum number of items to return per page.&quot;,
        isRequired = false,
        type = RestParameter.Type.STRING),
      @RestParameter(
        name = &quot;offset&quot;,
        defaultValue = &quot;0&quot;,
        description = &quot;The page number.&quot;,
        isRequired = false,
        type = RestParameter.Type.STRING)
      }, responses = {
      @RestResponse(
        responseCode = SC_OK,
        description = &quot;The user accounts.&quot;)
    })
  public JaxbUserList getUsersAsJson(@QueryParam(&quot;limit&quot;) int limit, @QueryParam(&quot;offset&quot;) int offset)
          throws IOException {

    // Set the maximum number of items to return to 100 if this limit parameter is not given
<span class="nc bnc" id="L164" title="All 2 branches missed.">    if (limit &lt; 1) {</span>
<span class="nc" id="L165">      limit = 100;</span>
    }

<span class="nc" id="L168">    JaxbUserList userList = new JaxbUserList();</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">    for (Iterator&lt;User&gt; i = jpaUserAndRoleProvider.findUsers(&quot;%&quot;, offset, limit); i.hasNext();) {</span>
<span class="nc" id="L170">      userList.add(i.next());</span>
    }
<span class="nc" id="L172">    return userList;</span>
  }

  @GET
  @Path(&quot;{username}.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(
      name = &quot;user&quot;,
      description = &quot;Returns a user&quot;,
      returnDescription = &quot;Returns a JSON representation of a user&quot;,
      pathParameters = {
      @RestParameter(
        name = &quot;username&quot;,
        description = &quot;The username.&quot;,
        isRequired = true,
        type = STRING)
      }, responses = {
      @RestResponse(
        responseCode = SC_OK,
        description = &quot;The user account.&quot;),
      @RestResponse(
        responseCode = SC_NOT_FOUND,
        description = &quot;User not found&quot;)
    })
  public Response getUserAsJson(@PathParam(&quot;username&quot;) String username) throws NotFoundException {
<span class="nc" id="L197">    User user = jpaUserAndRoleProvider.loadUser(username);</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">    if (user == null) {</span>
<span class="nc" id="L199">      logger.debug(&quot;Requested user not found: {}&quot;, username);</span>
<span class="nc" id="L200">      return Response.status(SC_NOT_FOUND).build();</span>
    }
<span class="nc" id="L202">    return Response.ok(JaxbUser.fromUser(user)).build();</span>
  }

  @GET
  @Path(&quot;users/md5.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(
      name = &quot;users-with-insecure-hashing&quot;,
      description = &quot;Returns a list of users which passwords are stored using MD5 hashes&quot;,
      returnDescription = &quot;Returns a JSON representation of the list of matching user accounts&quot;,
      responses = {
      @RestResponse(
          responseCode = SC_OK,
          description = &quot;The user accounts.&quot;)
  })
  public JaxbUserList getUserWithInsecurePasswordHashingAsJson() {
<span class="nc" id="L218">    JaxbUserList userList = new JaxbUserList();</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">    for (User user: jpaUserAndRoleProvider.findInsecurePasswordHashes()) {</span>
<span class="nc" id="L220">      userList.add(user);</span>
<span class="nc" id="L221">    }</span>
<span class="nc" id="L222">    return userList;</span>
  }

  @POST
  @Path(&quot;/&quot;)
  @RestQuery(
      name = &quot;createUser&quot;,
      description = &quot;Create a new  user&quot;,
      returnDescription = &quot;Location of the new ressource&quot;,
      restParameters = {
      @RestParameter(
        name = &quot;username&quot;,
        description = &quot;The username.&quot;,
        isRequired = true,
        type = STRING),
      @RestParameter(
        name = &quot;password&quot;,
        description = &quot;The password.&quot;,
        isRequired = true,
        type = STRING),
      @RestParameter(
        name = &quot;name&quot;,
        description = &quot;The name.&quot;,
        isRequired = false,
        type = STRING),
      @RestParameter(
        name = &quot;email&quot;,
        description = &quot;The email.&quot;,
        isRequired = false,
        type = STRING),
      @RestParameter(
        name = &quot;roles&quot;,
        description = &quot;The user roles as a json array, for example: [\&quot;ROLE_USER\&quot;, \&quot;ROLE_ADMIN\&quot;]&quot;,
        isRequired = false,
        type = STRING)
      }, responses = {
      @RestResponse(
        responseCode = SC_BAD_REQUEST,
        description = &quot;Malformed request syntax.&quot;),
      @RestResponse(
        responseCode = SC_CREATED,
        description = &quot;User has been created.&quot;),
      @RestResponse(
        responseCode = SC_CONFLICT,
        description = &quot;An user with this username already exist.&quot;),
      @RestResponse(
        responseCode = SC_FORBIDDEN,
        description = &quot;Not enough permissions to create a user with the admin role.&quot;)
    })
  public Response createUser(@FormParam(&quot;username&quot;) String username, @FormParam(&quot;password&quot;) String password,
          @FormParam(&quot;name&quot;) String name, @FormParam(&quot;email&quot;) String email, @FormParam(&quot;roles&quot;) String roles) {

<span class="nc bnc" id="L274" title="All 2 branches missed.">    if (jpaUserAndRoleProvider.loadUser(username) != null) {</span>
<span class="nc" id="L275">      return Response.status(SC_CONFLICT).build();</span>
    }

    try {
<span class="nc" id="L279">      Set&lt;JpaRole&gt; rolesSet = parseRoles(roles);</span>

      /* Add new user */
<span class="nc" id="L282">      logger.debug(&quot;Updating user {}&quot;, username);</span>
<span class="nc" id="L283">      JpaOrganization organization = (JpaOrganization) securityService.getOrganization();</span>
<span class="nc" id="L284">      JpaUser user = new JpaUser(username, password, organization, name, email, jpaUserAndRoleProvider.getName(), true,</span>
              rolesSet);
      try {
<span class="nc" id="L287">        jpaUserAndRoleProvider.addUser(user);</span>
<span class="nc" id="L288">        return Response.created(uri(endpointBaseUrl, user.getUsername() + &quot;.json&quot;)).build();</span>
<span class="nc" id="L289">      } catch (UnauthorizedException ex) {</span>
<span class="nc" id="L290">        logger.debug(&quot;Create user failed&quot;, ex);</span>
<span class="nc" id="L291">        return Response.status(Response.Status.FORBIDDEN).build();</span>
      }

<span class="nc" id="L294">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L295">      logger.debug(&quot;Request with malformed ROLE data: {}&quot;, roles);</span>
<span class="nc" id="L296">      return Response.status(SC_BAD_REQUEST).build();</span>
    }
  }

  @PUT
  @Path(&quot;{username}.json&quot;)
  @RestQuery(
      name = &quot;updateUser&quot;,
      description = &quot;Update an user&quot;,
      returnDescription = &quot;Status ok&quot;,
      restParameters = {
      @RestParameter(
        name = &quot;password&quot;,
        description = &quot;The password.&quot;,
        isRequired = true,
        type = STRING),
      @RestParameter(
        name = &quot;name&quot;,
        description = &quot;The name.&quot;,
        isRequired = false,
        type = STRING),
      @RestParameter(
        name = &quot;email&quot;,
        description = &quot;The email.&quot;,
        isRequired = false,
        type = STRING),
      @RestParameter(
        name = &quot;roles&quot;,
        description = &quot;The user roles as a json array, for example: [\&quot;ROLE_USER\&quot;, \&quot;ROLE_ADMIN\&quot;]&quot;,
        isRequired = false,
        type = STRING)
      }, pathParameters = @RestParameter(
      name = &quot;username&quot;,
      description = &quot;The username&quot;,
      isRequired = true,
      type = STRING),
      responses = {
      @RestResponse(
        responseCode = SC_BAD_REQUEST,
        description = &quot;Malformed request syntax.&quot;),
      @RestResponse(
        responseCode = SC_FORBIDDEN,
        description = &quot;Not enough permissions to update a user with the admin role.&quot;),
      @RestResponse(
        responseCode = SC_OK,
        description = &quot;User has been updated.&quot;)    })
  public Response setUser(@PathParam(&quot;username&quot;) String username, @FormParam(&quot;password&quot;) String password,
          @FormParam(&quot;name&quot;) String name, @FormParam(&quot;email&quot;) String email, @FormParam(&quot;roles&quot;) String roles) {

    try {
<span class="nc" id="L346">      User user = jpaUserAndRoleProvider.loadUser(username);</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">      if (user == null) {</span>
<span class="nc" id="L348">        return createUser(username, password, name, email, roles);</span>
      }

<span class="nc" id="L351">      Set&lt;JpaRole&gt; rolesSet = parseRoles(roles);</span>

<span class="nc" id="L353">      logger.debug(&quot;Updating user {}&quot;, username);</span>
<span class="nc" id="L354">      JpaOrganization organization = (JpaOrganization) securityService.getOrganization();</span>
<span class="nc" id="L355">      jpaUserAndRoleProvider.updateUser(new JpaUser(username, password, organization, name, email,</span>
<span class="nc" id="L356">                jpaUserAndRoleProvider.getName(), true, rolesSet));</span>
<span class="nc" id="L357">      return Response.status(SC_OK).build();</span>
<span class="nc" id="L358">    } catch (NotFoundException e) {</span>
<span class="nc" id="L359">      logger.debug(&quot;User {} not found.&quot;, username);</span>
<span class="nc" id="L360">      return Response.status(SC_NOT_FOUND).build();</span>
<span class="nc" id="L361">    } catch (UnauthorizedException e) {</span>
<span class="nc" id="L362">      logger.debug(&quot;Update user failed&quot;, e);</span>
<span class="nc" id="L363">      return Response.status(Response.Status.FORBIDDEN).build();</span>
<span class="nc" id="L364">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L365">      logger.debug(&quot;Request with malformed ROLE data: {}&quot;, roles);</span>
<span class="nc" id="L366">      return Response.status(SC_BAD_REQUEST).build();</span>
    }
  }

  @DELETE
  @Path(&quot;{username}.json&quot;)
  @RestQuery(
      name = &quot;deleteUser&quot;,
      description = &quot;Delete a new  user&quot;,
      returnDescription = &quot;Status ok&quot;,
      pathParameters = @RestParameter(
      name = &quot;username&quot;,
      type = STRING,
      isRequired = true,
      description = &quot;The username&quot;),
      responses = {
      @RestResponse(
        responseCode = SC_OK,
        description = &quot;User has been deleted.&quot;),
      @RestResponse(
        responseCode = SC_FORBIDDEN,
        description = &quot;Not enough permissions to delete a user with the admin role.&quot;),
      @RestResponse(
        responseCode = SC_NOT_FOUND,
        description = &quot;User not found.&quot;)
    })
  public Response deleteUser(@PathParam(&quot;username&quot;) String username) {
    try {
<span class="nc" id="L394">      jpaUserAndRoleProvider.deleteUser(username, securityService.getOrganization().getId());</span>
<span class="nc" id="L395">    } catch (NotFoundException e) {</span>
<span class="nc" id="L396">      logger.debug(&quot;User {} not found.&quot;, username);</span>
<span class="nc" id="L397">      return Response.status(SC_NOT_FOUND).build();</span>
<span class="nc" id="L398">    } catch (UnauthorizedException e) {</span>
<span class="nc" id="L399">      logger.debug(&quot;Error during deletion of user {}&quot;, username, e);</span>
<span class="nc" id="L400">      return Response.status(SC_FORBIDDEN).build();</span>
<span class="nc" id="L401">    } catch (Exception e) {</span>
<span class="nc" id="L402">      logger.error(&quot;Error during deletion of user {}&quot;, username, e);</span>
<span class="nc" id="L403">      return Response.status(SC_INTERNAL_SERVER_ERROR).build();</span>
<span class="nc" id="L404">    }</span>

<span class="nc" id="L406">    logger.debug(&quot;User {} removed.&quot;, username);</span>
<span class="nc" id="L407">    return Response.status(SC_OK).build();</span>
  }

  /**
   * Parse JSON roles array.
   *
   * @param roles
   *          String representation of JSON array containing roles
   */
  private Set&lt;JpaRole&gt; parseRoles(String roles) throws IllegalArgumentException {
<span class="nc" id="L417">    JSONArray rolesArray = null;</span>
    /* Try parsing JSON. Return Bad Request if malformed. */
    try {
<span class="nc bnc" id="L420" title="All 2 branches missed.">      rolesArray = (JSONArray) JSONValue.parseWithException(StringUtils.isEmpty(roles) ? &quot;[]&quot; : roles);</span>
<span class="nc" id="L421">    } catch (Exception e) {</span>
<span class="nc" id="L422">      throw new IllegalArgumentException(&quot;Error parsing JSON array&quot;, e);</span>
<span class="nc" id="L423">    }</span>

<span class="nc" id="L425">    Set&lt;JpaRole&gt; rolesSet = new HashSet&lt;JpaRole&gt;();</span>
    /* Add given roles */
<span class="nc bnc" id="L427" title="All 2 branches missed.">    for (Object role : rolesArray) {</span>
      try {
<span class="nc" id="L429">        rolesSet.add(new JpaRole((String) role, (JpaOrganization) securityService.getOrganization()));</span>
<span class="nc" id="L430">      } catch (ClassCastException e) {</span>
<span class="nc" id="L431">        throw new IllegalArgumentException(&quot;Error parsing array vales as String&quot;, e);</span>
<span class="nc" id="L432">      }</span>
<span class="nc" id="L433">    }</span>

<span class="nc" id="L435">    return rolesSet;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>