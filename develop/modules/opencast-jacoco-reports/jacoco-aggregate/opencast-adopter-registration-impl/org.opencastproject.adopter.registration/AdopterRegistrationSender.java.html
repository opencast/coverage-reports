<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AdopterRegistrationSender.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-adopter-registration-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.adopter.registration</a> &gt; <span class="el_source">AdopterRegistrationSender.java</span></div><h1>AdopterRegistrationSender.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.adopter.registration;

import org.apache.http.HttpResponse;
import org.apache.http.client.methods.HttpEntityEnclosingRequestBase;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClientBuilder;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.URI;
import java.net.URL;
import java.nio.charset.StandardCharsets;

/**
 * Contains methods for sending statistic data via rest.
 */
public class AdopterRegistrationSender {

  /** The logger */
<span class="nc" id="L47">  private static final Logger logger = LoggerFactory.getLogger(AdopterRegistrationSender.class);</span>

  /** The base URL for the external server where the data will be send to */
  private String baseUrl;

  // The suffixes for the base statistic server URL
  // they determine to which REST endpoint the data will be sent
  private static final String GENERAL_DATA_URL_SUFFIX = &quot;api/1.0/adopter&quot;;
  private static final String STATISTIC_URL_SUFFIX = &quot;api/1.0/statistic&quot;;

  private static final String EXTRA_URL_INFIX = &quot;api/1.0&quot;;

  //================================================================================
  // Constructor
  //================================================================================

  /**
   * Simple Constructor that requires the URL of the statistic server.
   * @param statisticServerBaseUrl The URL prefix of the statistic server.
   */
<span class="nc" id="L67">  public AdopterRegistrationSender(String statisticServerBaseUrl) {</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">    if (!statisticServerBaseUrl.endsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L69">      statisticServerBaseUrl += &quot;/&quot;;</span>
    }
<span class="nc" id="L71">    this.baseUrl = statisticServerBaseUrl;</span>
<span class="nc" id="L72">  }</span>

  //================================================================================
  // Methods
  //================================================================================

  /**
   * Executes the 'send' method with the proper REST URL suffix.
   * @param json The data which shall be sent.
   * @throws IOException General exception that can occur while sending the data.
   */
  public void sendGeneralData(String json) throws IOException  {
<span class="nc" id="L84">    send(json, GENERAL_DATA_URL_SUFFIX);</span>
<span class="nc" id="L85">  }</span>

  /**
   * Deletes the adopter data
   * @param json The data which shall be sent.
   * @throws IOException General exception that can occur while sending the data.
   */
  public void deleteGeneralData(String json) throws IOException  {
<span class="nc" id="L93">    send(json, GENERAL_DATA_URL_SUFFIX, &quot;DELETE&quot;);</span>
<span class="nc" id="L94">  }</span>

  /**
   * Executes the 'send' method with the proper REST URL suffix.
   * @param json The data which shall be sent.
   * @throws IOException General exception that can occur while sending the data.
   */
  public void sendStatistics(String json) throws IOException {
<span class="nc" id="L102">    send(json, STATISTIC_URL_SUFFIX);</span>
<span class="nc" id="L103">  }</span>

  /**
   * Executes the 'send' method with the proper REST URL suffix.
   * @param key The key for the extra data.
   * @param json The data which shall be sent.
   * @throws IOException General exception that can occur while sending the data.
   */
  public void sendExtraData(String key, String json) throws IOException {
<span class="nc" id="L112">    send(json, EXTRA_URL_INFIX + &quot;/&quot; + key);</span>
<span class="nc" id="L113">  }</span>

  /**
   * Deletes the statistics data
   * @param json The data which shall be sent.
   * @throws IOException General exception that can occur while sending the data.
   */
  public void deleteStatistics(String json) throws IOException {
<span class="nc" id="L121">    send(json, STATISTIC_URL_SUFFIX, &quot;DELETE&quot;);</span>
<span class="nc" id="L122">  }</span>


  /**
   * Sends the JSON string via post request.
   * @param json The JSON string that has to be send.
   * @param urlSuffix The url suffix determines to which rest endpoint the data will be send.
   * @throws IOException General exception that can occur while processing the POST request.
   */
  private void send(String json, String urlSuffix) throws IOException {
<span class="nc" id="L132">    send(json, urlSuffix, &quot;GET&quot;);</span>
<span class="nc" id="L133">  }</span>

  /**
   * Sends the JSON string via post request.
   * @param json The JSON string that has to be send.
   * @param urlSuffix The url suffix determines to which rest endpoint the data will be send.
   * @param method The HTTP method to send to the server with.  Hint: Try DELETE
   * @throws IOException General exception that can occur while processing the POST request.
   */
  private void send(String json, String urlSuffix, String method) throws IOException {
<span class="nc" id="L143">    try (CloseableHttpClient client = HttpClientBuilder.create().useSystemProperties().build()) {</span>
<span class="nc" id="L144">      String url = new URL(baseUrl + urlSuffix).toString();</span>
<span class="nc" id="L145">      HttpEntityEnclosingRequestBase request = null;</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">      if (&quot;DELETE&quot;.equals(method)) {</span>
<span class="nc" id="L147">        request = new HttpDeleteWithEntity(url);</span>
      } else {
<span class="nc" id="L149">        request = new HttpPost(url);</span>
      }
<span class="nc" id="L151">      request.addHeader(&quot;Content-Type&quot;, &quot;application/json; utf-8&quot;);</span>
<span class="nc" id="L152">      request.addHeader(&quot;Accept&quot;, &quot;application/json&quot;);</span>
<span class="nc" id="L153">      request.setEntity(new StringEntity(json, StandardCharsets.UTF_8));</span>

<span class="nc" id="L155">      HttpResponse resp = client.execute(request);</span>
<span class="nc" id="L156">      int httpStatus = resp.getStatusLine().getStatusCode();</span>
<span class="nc bnc" id="L157" title="All 4 branches missed.">      boolean errorOccurred = httpStatus &lt; 200 || httpStatus &gt; 299;</span>
<span class="nc" id="L158">      InputStream responseStream = resp.getEntity().getContent();</span>

<span class="nc" id="L160">      try (BufferedReader br = new BufferedReader(new InputStreamReader(responseStream, StandardCharsets.UTF_8))) {</span>
<span class="nc" id="L161">        StringBuilder response = new StringBuilder();</span>
        String responseLine;
<span class="nc bnc" id="L163" title="All 2 branches missed.">        while ((responseLine = br.readLine()) != null) {</span>
<span class="nc" id="L164">          response.append(responseLine.trim());</span>
        }
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (errorOccurred) {</span>
<span class="nc" id="L167">          String errorMessage = String.format(&quot;HttpStatus: %s, HttpResponse: %s&quot;, httpStatus, response);</span>
<span class="nc" id="L168">          throw new RuntimeException(errorMessage);</span>
        }
      }
    }
<span class="nc" id="L172">  }</span>

  //This custom class is here because HttpDelete doesn't accept entities, which is needed by the server
  static class HttpDeleteWithEntity extends HttpEntityEnclosingRequestBase {

    public static final String METHOD_NAME = &quot;DELETE&quot;;

    HttpDeleteWithEntity(final String uri) {
<span class="nc" id="L180">      super();</span>
<span class="nc" id="L181">      setURI(URI.create(uri));</span>
<span class="nc" id="L182">    }</span>

    @Override
    public String getMethod() {
<span class="nc" id="L186">      return METHOD_NAME;</span>
    }
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>