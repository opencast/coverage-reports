<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>StudipUserProviderInstance.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-userdirectory-studip</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.userdirectory.studip</a> &gt; <span class="el_source">StudipUserProviderInstance.java</span></div><h1>StudipUserProviderInstance.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.userdirectory.studip;

import org.opencastproject.security.api.CachingUserProviderMXBean;
import org.opencastproject.security.api.Group;
import org.opencastproject.security.api.JaxbOrganization;
import org.opencastproject.security.api.JaxbRole;
import org.opencastproject.security.api.JaxbUser;
import org.opencastproject.security.api.Organization;
import org.opencastproject.security.api.Role;
import org.opencastproject.security.api.RoleProvider;
import org.opencastproject.security.api.User;
import org.opencastproject.security.api.UserProvider;

import com.google.common.cache.CacheBuilder;
import com.google.common.cache.CacheLoader;
import com.google.common.cache.LoadingCache;
import com.google.common.util.concurrent.ExecutionError;
import com.google.common.util.concurrent.UncheckedExecutionException;

import org.apache.http.client.config.RequestConfig;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.utils.URIBuilder;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClientBuilder;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.lang.management.ManagementFactory;
import java.net.URI;
import java.net.URISyntaxException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.List;
import java.util.Objects;
import java.util.Set;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.AtomicLong;

import javax.management.InstanceNotFoundException;
import javax.management.MBeanServer;
import javax.management.ObjectName;

/**
 * A UserProvider that reads user roles from Studip.
 */
public class StudipUserProviderInstance implements UserProvider, RoleProvider, CachingUserProviderMXBean {

  public static final String PROVIDER_NAME = &quot;studip&quot;;

  private static final String OC_USERAGENT = &quot;Opencast&quot;;
  private static final String STUDIP_GROUP = Group.ROLE_PREFIX + &quot;STUDIP&quot;;

  /** The logger */
<span class="nc" id="L86">  private static final Logger logger = LoggerFactory.getLogger(StudipUserProviderInstance.class);</span>

  /** The organization */
<span class="nc" id="L89">  private Organization organization = null;</span>

  /** Total number of requests made to load users */
<span class="nc" id="L92">  private AtomicLong requests = null;</span>

  /** The number of requests made to Studip */
<span class="nc" id="L95">  private AtomicLong studipLoads = null;</span>

  /** A cache of users, which lightens the load on Studip */
<span class="nc" id="L98">  private LoadingCache&lt;String, Object&gt; cache = null;</span>

  /** A token to store in the miss cache */
<span class="nc" id="L101">  protected Object nullToken = new Object();</span>

  /** The URL of the Studip instance */
  private URI studipUrl;

  /** The URL of the Studip instance */
<span class="nc" id="L107">  private String studipToken = null;</span>

  /**
   * Constructs an Studip user provider with the needed settings.
   *
   * @param pid
   *          the pid of this service
   * @param organization
   *          the organization
   * @param url
   *          the url of the Studip server
   * @param token
   *          the token to authenticate with
   * @param cacheSize
   *          the number of users to cache
   * @param cacheExpiration
   *          the number of minutes to cache users
   */
  public StudipUserProviderInstance(
      String pid,
      Organization organization,
      URI url,
      String token,

      int cacheSize,
      int cacheExpiration
<span class="nc" id="L133">  ) {</span>

<span class="nc" id="L135">    this.organization = organization;</span>
<span class="nc" id="L136">    this.studipUrl = url;</span>
<span class="nc" id="L137">    this.studipToken = token;</span>

<span class="nc" id="L139">    logger.info(&quot;Creating new StudipUserProviderInstance(pid={}, url={}, cacheSize={}, cacheExpiration={})&quot;,</span>
<span class="nc" id="L140">                 pid, url, cacheSize, cacheExpiration);</span>

    // Setup the caches
<span class="nc" id="L143">    cache = CacheBuilder.newBuilder().maximumSize(cacheSize).expireAfterWrite(cacheExpiration, TimeUnit.MINUTES)</span>
<span class="nc" id="L144">        .build(new CacheLoader&lt;String, Object&gt;() {</span>
          @Override
          public Object load(String id) throws Exception {
<span class="nc" id="L147">            User user = loadUserFromStudip(id);</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">            return user == null ? nullToken : user;</span>
          }
        });

<span class="nc" id="L152">    registerMBean(pid);</span>
<span class="nc" id="L153">  }</span>

  @Override
  public String getName() {
<span class="nc" id="L157">    return PROVIDER_NAME;</span>
  }

  /**
   * Registers an MXBean.
   */
  protected void registerMBean(String pid) {
    // register with jmx
<span class="nc" id="L165">    requests = new AtomicLong();</span>
<span class="nc" id="L166">    studipLoads = new AtomicLong();</span>
    try {
      ObjectName name;
<span class="nc" id="L169">      name = StudipUserProviderFactory.getObjectName(pid);</span>
<span class="nc" id="L170">      Object mbean = this;</span>
<span class="nc" id="L171">      MBeanServer mbs = ManagementFactory.getPlatformMBeanServer();</span>
      try {
<span class="nc" id="L173">        mbs.unregisterMBean(name);</span>
<span class="nc" id="L174">      } catch (InstanceNotFoundException e) {</span>
<span class="nc" id="L175">        logger.debug(&quot;{} was not registered before&quot;, name);</span>
<span class="nc" id="L176">      }</span>
<span class="nc" id="L177">      mbs.registerMBean(mbean, name);</span>
<span class="nc" id="L178">    } catch (Exception e) {</span>
<span class="nc" id="L179">      logger.error(&quot;Unable to register {} as an mbean&quot;, this, e);</span>
<span class="nc" id="L180">    }</span>
<span class="nc" id="L181">  }</span>

  // UserProvider methods

  /**
   * {@inheritDoc}
   * 
   * @see org.opencastproject.security.api.UserProvider#getOrganization()
   */
  @Override
  public String getOrganization() {
<span class="nc" id="L192">    return organization.getId();</span>
  }

  /**
   * {@inheritDoc}
   * 
   * @see org.opencastproject.security.api.UserProvider#loadUser(java.lang.String)
   */
  @Override
  public User loadUser(String userName) {
<span class="nc" id="L202">    logger.debug(&quot;loaduser({})&quot;, userName);</span>

<span class="nc" id="L204">    requests.incrementAndGet();</span>
    try {
<span class="nc" id="L206">      Object user = cache.getUnchecked(userName);</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">      if (user == nullToken) {</span>
<span class="nc" id="L208">        logger.debug(&quot;Returning null user from cache&quot;);</span>
<span class="nc" id="L209">        return null;</span>
      } else {
<span class="nc" id="L211">        logger.debug(&quot;Returning user {} from cache&quot;, userName);</span>
<span class="nc" id="L212">        return (JaxbUser) user;</span>
      }
<span class="nc" id="L214">    } catch (ExecutionError | UncheckedExecutionException e) {</span>
<span class="nc" id="L215">      logger.warn(&quot;Exception while loading user {}&quot;, userName, e);</span>
<span class="nc" id="L216">      return null;</span>
    }
  }

  /**
   * Loads a user from Stud.IP.
   * 
   * @param userName
   *          the username
   * @return the user
   */
  protected User loadUserFromStudip(String userName) {
<span class="nc bnc" id="L228" title="All 2 branches missed.">    if (cache == null) {</span>
<span class="nc" id="L229">      throw new IllegalStateException(&quot;The Stud.IP user detail service has not yet been configured&quot;);</span>
    }

    // Don't answer for admin, anonymous or empty user
<span class="nc bnc" id="L233" title="All 6 branches missed.">    if (&quot;admin&quot;.equals(userName) || &quot;&quot;.equals(userName) || &quot;anonymous&quot;.equals(userName)) {</span>
<span class="nc" id="L234">      cache.put(userName, nullToken);</span>
<span class="nc" id="L235">      logger.debug(&quot;we don't answer for {}&quot;, userName);</span>
<span class="nc" id="L236">      return null;</span>
    }

<span class="nc" id="L239">    logger.debug(&quot;In loadUserFromStudip, currently processing user : {}&quot;, userName);</span>

<span class="nc" id="L241">    JaxbOrganization jaxbOrganization = JaxbOrganization.fromOrganization(organization);</span>

    // update cache statistics
<span class="nc" id="L244">    studipLoads.incrementAndGet();</span>

<span class="nc" id="L246">    Thread currentThread = Thread.currentThread();</span>
<span class="nc" id="L247">    ClassLoader originalClassloader = currentThread.getContextClassLoader();</span>
    try {
      // Stud.IP userId (internal id), email address and display name
<span class="nc" id="L250">      JSONObject userJsonObj = getStudipUser(userName);</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">      if (userJsonObj == null) {</span>
<span class="nc" id="L252">        return null;</span>
      }

<span class="nc" id="L255">      Set&lt;JaxbRole&gt; roles = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">      if (userJsonObj.containsKey(&quot;roles&quot;)) {</span>
<span class="nc" id="L257">        JSONArray rolesArray = (JSONArray) userJsonObj.get(&quot;roles&quot;);</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">        for (Object r : rolesArray) {</span>
<span class="nc" id="L259">          roles.add(new JaxbRole(r.toString(), jaxbOrganization, &quot;Studip external role&quot;, Role.Type.EXTERNAL));</span>
<span class="nc" id="L260">        }</span>
      }

      // Group role for all Stud.IP users
<span class="nc" id="L264">      roles.add(new JaxbRole(STUDIP_GROUP, jaxbOrganization, &quot;Studip Users&quot;, Role.Type.EXTERNAL_GROUP));</span>
<span class="nc" id="L265">      logger.debug(&quot;Returning JaxbRoles: {}&quot;, roles);</span>

      // Email address
<span class="nc" id="L268">      var email = Objects.toString(userJsonObj.get(&quot;email&quot;), null);</span>
<span class="nc" id="L269">      var name = Objects.toString(userJsonObj.get(&quot;fullname&quot;), null);</span>

<span class="nc" id="L271">      User user = new JaxbUser(userName, null, name, email, PROVIDER_NAME, jaxbOrganization, roles);</span>

<span class="nc" id="L273">      cache.put(userName, user);</span>
<span class="nc" id="L274">      logger.debug(&quot;Returning user {}&quot;, userName);</span>

<span class="nc" id="L276">      return user;</span>

<span class="nc" id="L278">    } catch (ParseException e) {</span>
<span class="nc" id="L279">      logger.error(&quot;Exception while parsing response from provider for user {}&quot;, userName, e);</span>
<span class="nc" id="L280">      return null;</span>
<span class="nc" id="L281">    } catch (IOException e) {</span>
<span class="nc" id="L282">      logger.error(&quot;Error requesting user data for user `{}`: {}&quot;, userName, e.getMessage());</span>
<span class="nc" id="L283">      return null;</span>
<span class="nc" id="L284">    } catch (URISyntaxException e) {</span>
<span class="nc" id="L285">      logger.error(&quot;Misspelled URI&quot;, e);</span>
<span class="nc" id="L286">      return null;</span>
    } finally {
<span class="nc" id="L288">      currentThread.setContextClassLoader(originalClassloader);</span>
    }
  }

  /**
   * Get the internal Stud.IP user Id for the supplied user. If the user exists, set the user's email address.
   * 
   * @param uid Identifier of the user to look for
   * @return JSON object containing user information
   */
  private JSONObject getStudipUser(String uid) throws URISyntaxException, IOException, ParseException {
    // Build URL
<span class="nc" id="L300">    var apiPath = new URIBuilder().setPathSegments(&quot;opencast&quot;, &quot;user&quot;, uid).getPath();</span>
<span class="nc" id="L301">    var url = new URIBuilder(studipUrl)</span>
<span class="nc" id="L302">        .setPath(studipUrl.getPath().replaceAll(&quot;/*$&quot;, &quot;&quot;) + apiPath)</span>
<span class="nc" id="L303">        .addParameter(&quot;token&quot;, studipToken)</span>
<span class="nc" id="L304">        .build();</span>

    // Execute request
<span class="nc" id="L307">    HttpGet get = new HttpGet(url);</span>
<span class="nc" id="L308">    get.setHeader(&quot;User-Agent&quot;, OC_USERAGENT);</span>

    // Don't wait for responses indefinitely
<span class="nc" id="L311">    RequestConfig config = RequestConfig.custom()</span>
<span class="nc" id="L312">        .setConnectTimeout(5000)</span>
<span class="nc" id="L313">        .setSocketTimeout(10000).build();</span>

<span class="nc" id="L315">    try (CloseableHttpClient client = HttpClientBuilder.create().setDefaultRequestConfig(config).build();) {</span>
<span class="nc" id="L316">      try (CloseableHttpResponse resp = client.execute(get)) {</span>
<span class="nc" id="L317">        var statusCode = resp.getStatusLine().getStatusCode();</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (statusCode == 404) {</span>
          // Stud.IP does not know about the user
<span class="nc" id="L320">          return null;</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">        } else if (statusCode / 100 != 2) {</span>
<span class="nc" id="L322">          throw new IOException(&quot;HttpRequest unsuccessful, reason: &quot; + resp.getStatusLine().getReasonPhrase());</span>
        }

        // Parse response
<span class="nc" id="L326">        BufferedReader reader = new BufferedReader(new InputStreamReader(resp.getEntity().getContent()));</span>
<span class="nc" id="L327">        JSONParser parser = new JSONParser();</span>
<span class="nc" id="L328">        Object obj = parser.parse(reader);</span>

        // Check for errors
<span class="nc bnc" id="L331" title="All 2 branches missed.">        if (!(obj instanceof JSONObject)) {</span>
<span class="nc" id="L332">          throw new IOException(&quot;StudIP responded in unexpected format&quot;);</span>
        }

<span class="nc" id="L335">        JSONObject jObj = (JSONObject) obj;</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">        if (jObj.containsKey(&quot;errors&quot;)) {</span>
<span class="nc" id="L337">          throw new IOException(&quot;Stud.IP returned an error: &quot; + jObj.toJSONString());</span>
        }

<span class="nc" id="L340">        return jObj;</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">      }</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">    }</span>
  }

  /**
   * {@inheritDoc}
   * 
   * @see org.opencastproject.security.api.CachingUserProviderMXBean#getCacheHitRatio()
   */
  @Override
  public float getCacheHitRatio() {
<span class="nc bnc" id="L352" title="All 2 branches missed.">    if (requests.get() == 0) {</span>
<span class="nc" id="L353">      return 0;</span>
    }
<span class="nc" id="L355">    return (float) (requests.get() - studipLoads.get()) / requests.get();</span>
  }

  @Override
  public Iterator&lt;User&gt; findUsers(String query, int offset, int limit) {

<span class="nc bnc" id="L361" title="All 2 branches missed.">    if (query == null) {</span>
<span class="nc" id="L362">      throw new IllegalArgumentException(&quot;Query must be set&quot;);</span>
    }

<span class="nc bnc" id="L365" title="All 2 branches missed.">    if (query.endsWith(&quot;%&quot;)) {</span>
<span class="nc" id="L366">      query = query.substring(0, query.length() - 1);</span>
    }

<span class="nc bnc" id="L369" title="All 2 branches missed.">    if (query.isEmpty()) {</span>
<span class="nc" id="L370">      return Collections.emptyIterator();</span>
    }

<span class="nc" id="L373">    List&lt;User&gt; users = new LinkedList&lt;User&gt;();</span>
<span class="nc" id="L374">    JaxbOrganization jaxbOrganization = JaxbOrganization.fromOrganization(organization);</span>
<span class="nc" id="L375">    JaxbUser queryUser = new JaxbUser(query, PROVIDER_NAME, jaxbOrganization, new HashSet&lt;JaxbRole&gt;());</span>
<span class="nc" id="L376">    users.add(queryUser);</span>

<span class="nc" id="L378">    return users.iterator();</span>
  }

  @Override
  public Iterator&lt;User&gt; getUsers() {
    // We never enumerate all users
<span class="nc" id="L384">    return Collections.emptyIterator();</span>
  }

  @Override
  public void invalidate(String userName) {
<span class="nc" id="L389">    cache.invalidate(userName);</span>
<span class="nc" id="L390">  }</span>

  @Override
  public long countUsers() {
    // Not meaningful, as we never enumerate users
<span class="nc" id="L395">    return 0;</span>
  }

  // RoleProvider methods

  @Override
  public List&lt;Role&gt; getRolesForUser(String userName) {

<span class="nc" id="L403">    List&lt;Role&gt; roles = new LinkedList&lt;Role&gt;();</span>

    // Don't answer for admin, anonymous or empty user
<span class="nc bnc" id="L406" title="All 6 branches missed.">    if (&quot;admin&quot;.equals(userName) || &quot;&quot;.equals(userName) || &quot;anonymous&quot;.equals(userName)) {</span>
<span class="nc" id="L407">      logger.debug(&quot;we don't answer for {}&quot;, userName);</span>
<span class="nc" id="L408">      return roles;</span>
    }

<span class="nc" id="L411">    logger.debug(&quot;getRolesForUser({})&quot;, userName);</span>

<span class="nc" id="L413">    User user = loadUser(userName);</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">    if (user != null) {</span>
<span class="nc" id="L415">      logger.debug(&quot;Returning cached role set for {}&quot;, userName);</span>
<span class="nc" id="L416">      return new ArrayList&lt;Role&gt;(user.getRoles());</span>
    }

    // Not found
<span class="nc" id="L420">    logger.debug(&quot;Return empty role set for {} - not found on Stud.IP&quot;, userName);</span>
<span class="nc" id="L421">    return new LinkedList&lt;&gt;();</span>
  }

  @Override
  public Iterator&lt;Role&gt; findRoles(String query, Role.Target target, int offset, int limit) {
<span class="nc" id="L426">    logger.debug(&quot;findRoles(query={} offset={} limit={})&quot;, query, offset, limit);</span>

    // Don't return roles for users or groups
<span class="nc bnc" id="L429" title="All 2 branches missed.">    if (target == Role.Target.USER) {</span>
<span class="nc" id="L430">      return Collections.emptyIterator();</span>
    }

<span class="nc bnc" id="L433" title="All 2 branches missed.">    if (query.endsWith(&quot;%&quot;)) {</span>
<span class="nc" id="L434">      query = query.substring(0, query.length() - 1);</span>
    }

<span class="nc bnc" id="L437" title="All 2 branches missed.">    if (query.isEmpty()) {</span>
<span class="nc" id="L438">      return Collections.emptyIterator();</span>
    }

    // Roles list
<span class="nc" id="L442">    List&lt;Role&gt; roles = new LinkedList&lt;&gt;();</span>

<span class="nc" id="L444">    return roles.iterator();</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>