<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>PlaylistRestService.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-playlists</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.playlists</a> &gt; <span class="el_source">PlaylistRestService.java</span></div><h1>PlaylistRestService.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.playlists;

import static javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;
import static javax.servlet.http.HttpServletResponse.SC_CREATED;
import static javax.servlet.http.HttpServletResponse.SC_NOT_FOUND;
import static javax.servlet.http.HttpServletResponse.SC_OK;
import static javax.servlet.http.HttpServletResponse.SC_UNAUTHORIZED;
import static org.apache.commons.lang3.StringUtils.trimToNull;
import static org.opencastproject.util.doc.rest.RestParameter.Type.BOOLEAN;
import static org.opencastproject.util.doc.rest.RestParameter.Type.INTEGER;
import static org.opencastproject.util.doc.rest.RestParameter.Type.LONG;
import static org.opencastproject.util.doc.rest.RestParameter.Type.STRING;
import static org.opencastproject.util.doc.rest.RestParameter.Type.TEXT;

import org.opencastproject.playlists.serialization.JaxbPlaylist;
import org.opencastproject.search.api.SearchService;
import org.opencastproject.security.api.AuthorizationService;
import org.opencastproject.security.api.UnauthorizedException;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.XmlSafeParser;
import org.opencastproject.util.data.Option;
import org.opencastproject.util.doc.rest.RestParameter;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestResponse;
import org.opencastproject.util.doc.rest.RestService;
import org.opencastproject.util.requests.SortCriterion;

import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.dataformat.xml.XmlMapper;
import com.fasterxml.jackson.module.jaxb.JaxbAnnotationModule;

import org.apache.commons.io.IOUtils;
import org.json.simple.parser.ParseException;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.jaxrs.whiteboard.propertytypes.JaxrsResource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.xml.sax.SAXException;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import javax.ws.rs.DELETE;
import javax.ws.rs.FormParam;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.PUT;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.core.GenericEntity;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import javax.xml.bind.JAXBContext;
import javax.xml.bind.JAXBException;

/**
 * A REST endpoint for the {@link PlaylistService}
 */
@Path(&quot;/playlists&quot;)
@RestService(
    name = &quot;playlistservice&quot;,
    title = &quot;Playlist Service&quot;,
    abstractText = &quot;This service lists available playlists and stuff&quot;,
    notes = {
    &quot;All paths above are relative to the REST endpoint base (something like http://your.server/files)&quot;,
    &quot;If the service is down or not working it will return a status 503, this means the the underlying service is &quot;
        + &quot;not working and is either restarting or has failed&quot;,
    &quot;A status code 500 means a general failure has occurred which is not recoverable and was not anticipated. In &quot;
        + &quot;other words, there is a bug! You should file an error report with your server logs from the time when the &quot;
        + &quot;error occurred: &lt;a href=\&quot;https://github.com/opencast/opencast/issues\&quot;&gt;Opencast Issue Tracker&lt;/a&gt;&quot; })
@Component(
    immediate = true,
    service = PlaylistRestService.class,
    property = {
        &quot;service.description=Playlist REST Endpoint&quot;,
        &quot;opencast.service.type=org.opencastproject.playlists&quot;,
        &quot;opencast.service.path=/playlists&quot;
    }
)
@JaxrsResource
<span class="nc" id="L106">public class PlaylistRestService {</span>
  /** The logger */
<span class="fc" id="L108">  private static final Logger logger = LoggerFactory.getLogger(PlaylistRestService.class);</span>

  public static final String SAMPLE_PLAYLIST_JSON = &quot;{\n&quot;
      + &quot;        \&quot;title\&quot;: \&quot;Opencast Playlist\&quot;,\n&quot;
      + &quot;        \&quot;description\&quot;: \&quot;This is a playlist about Opencast\&quot;,\n&quot;
      + &quot;        \&quot;creator\&quot;: \&quot;Opencast\&quot;,\n&quot;
      + &quot;        \&quot;entries\&quot;: [\n&quot;
      + &quot;            {\n&quot;
      + &quot;                \&quot;contentId\&quot;: \&quot;ID-about-opencast\&quot;,\n&quot;
      + &quot;                \&quot;type\&quot;: \&quot;EVENT\&quot;\n&quot;
      + &quot;            },\n&quot;
      + &quot;            {\n&quot;
      + &quot;                \&quot;contentId\&quot;: \&quot;ID-3d-print\&quot;,\n&quot;
      + &quot;                \&quot;type\&quot;: \&quot;EVENT\&quot;\n&quot;
      + &quot;            }\n&quot;
      + &quot;        ],\n&quot;
      + &quot;        \&quot;accessControlEntries\&quot;: [\n&quot;
      + &quot;            {\n&quot;
      + &quot;                \&quot;allow\&quot;: true,\n&quot;
      + &quot;                \&quot;role\&quot;: \&quot;ROLE_USER_BOB\&quot;,\n&quot;
      + &quot;                \&quot;action\&quot;: \&quot;read\&quot;\n&quot;
      + &quot;            }\n&quot;
      + &quot;        ]\n&quot;
      + &quot;}&quot;;

  public static final String SAMPLE_PLAYLIST_ENTRIES_JSON = &quot;[\n&quot;
      + &quot;            {\n&quot;
      + &quot;                \&quot;contentId\&quot;: \&quot;ID-about-opencast\&quot;,\n&quot;
      + &quot;                \&quot;type\&quot;: \&quot;EVENT\&quot;\n&quot;
      + &quot;            },\n&quot;
      + &quot;            {\n&quot;
      + &quot;                \&quot;contentId\&quot;: \&quot;ID-3d-print\&quot;,\n&quot;
      + &quot;                \&quot;type\&quot;: \&quot;EVENT\&quot;\n&quot;
      + &quot;            }\n&quot;
      + &quot;        ],&quot;;

  public static final String SAMPLE_PLAYLIST_XML = &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot; standalone=\&quot;yes\&quot;?&gt;&lt;&quot;
      + &quot;ns3:playlist xmlns:ns2=\&quot;http://mediapackage.opencastproject.org\&quot; &quot;
      + &quot;xmlns:ns3=\&quot;http://playlist.opencastproject.org\&quot;&gt;&lt;organization&gt;mh_default_org&lt;/organization&gt;&quot;
      + &quot;&lt;entries&gt;&lt;contentId&gt;ID-av-portal&lt;/contentId&gt;&lt;type&gt;EVENT&lt;/type&gt;&lt;/entries&gt;&lt;entries&gt;&quot;
      + &quot;&lt;contentId&gt;ID-av-print&lt;/contentId&gt;&lt;type&gt;EVENT&lt;/type&gt;&lt;/entries&gt;&lt;title&gt;Opencast Playlist&lt;/title&gt;&quot;
      + &quot;&lt;description&gt;This is a playlist about Opencast&lt;/description&gt;&lt;creator&gt;Opencast&lt;/creator&gt;&quot;
      + &quot;&lt;updated&gt;1701787700848&lt;/updated&gt;&lt;accessControlEntries&gt;&lt;allow&gt;true&lt;/allow&gt;&lt;role&gt;ROLE_USER_BOB&lt;/role&gt;&quot;
      + &quot;&lt;action&gt;read&lt;/action&gt;&lt;/accessControlEntries&gt;&lt;/ns3:playlist&gt;&quot;;

  public static final String SAMPLE_PLAYLIST_ENTRIES_XML =
      &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot; standalone=\&quot;yes\&quot;?&gt;\n&quot;
      + &quot;&lt;entries&gt;\n&quot;
      + &quot;\t&lt;entry id=\&quot;1061\&quot;&gt;\n&quot; + &quot;\t\t&lt;contentId&gt;ID-av-portal&lt;/contentId&gt;\n&quot; + &quot;\t\t&lt;type&gt;EVENT&lt;/type&gt;\n&quot;
      + &quot;\t&lt;/entry&gt;\n&quot;
      + &quot;\t&lt;entry id=\&quot;1062\&quot;&gt;\n&quot; + &quot;\t\t&lt;contentId&gt;ID-av-print&lt;/contentId&gt;\n&quot; + &quot;\t\t&lt;type&gt;EVENT&lt;/type&gt;\n&quot;
      + &quot;\t&lt;/entry&gt;\n&quot; + &quot;&lt;/entries&gt;&quot;;

  /** The playlist service instance */
  private PlaylistService service;

  /** The search service */
<span class="nc" id="L165">  protected SearchService searchService = null;</span>

  /** The authorization service */
<span class="nc" id="L168">  protected AuthorizationService authorizationService = null;</span>

  /**
   * Sets the playlist service
   *
   * @param service
   *          the playlist service instance
   */
  @Reference
  public void setService(PlaylistService service) {
<span class="nc" id="L178">    this.service = service;</span>
<span class="nc" id="L179">  }</span>

  @Reference
  protected void setSearchService(SearchService searchService) {
<span class="nc" id="L183">    this.searchService = searchService;</span>
<span class="nc" id="L184">  }</span>

  @Reference
  public void setAuthorizationService(AuthorizationService authorizationService) {
<span class="nc" id="L188">    this.authorizationService = authorizationService;</span>
<span class="nc" id="L189">  }</span>

  @GET
  @Produces(MediaType.APPLICATION_JSON)
  @Path(&quot;{id}.json&quot;)
  @RestQuery(
      name = &quot;playlist&quot;,
      description = &quot;Get a playlist.&quot;,
      returnDescription = &quot;A playlist as JSON&quot;,
      pathParameters = {
          @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;The playlist identifier&quot;, type = STRING),
      },
      restParameters = {
          @RestParameter(name = &quot;withPublications&quot;, isRequired = false, description = &quot;If available publications for&quot;
              + &quot;the content should be returned. Only works for content of type EVENT.&quot;, type = BOOLEAN,
              defaultValue = &quot;true&quot;)
      },
      responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;A playlist as JSON.&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No playlist with that identifier exists.&quot;),
          @RestResponse(responseCode = SC_UNAUTHORIZED, description = &quot;Not authorized to perform this action&quot;)
      })
  public Response getPlaylistAsJson(
      @PathParam(&quot;id&quot;) String id,
      @FormParam(&quot;withPublications&quot;) boolean withPublications)
          throws NotFoundException, UnauthorizedException {
<span class="nc" id="L215">    Playlist playlist = service.getPlaylistById(id);</span>

    JaxbPlaylist jaxbPlaylist;
<span class="nc bnc" id="L218" title="All 2 branches missed.">    if (withPublications) {</span>
<span class="nc" id="L219">      jaxbPlaylist = service.enrich(playlist);</span>
    } else {
<span class="nc" id="L221">      jaxbPlaylist = new JaxbPlaylist(playlist);</span>
    }

<span class="nc" id="L224">    return Response.ok().entity(jaxbPlaylist).build();</span>
  }

  @GET
  @Produces(MediaType.APPLICATION_XML)
  @Path(&quot;{id}.xml&quot;)
  @RestQuery(
      name = &quot;playlist&quot;,
      description = &quot;Get a playlist.&quot;,
      returnDescription = &quot;A playlist as XML&quot;,
      pathParameters = {
          @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;The playlist identifier&quot;, type = STRING),
      },
      restParameters = {
          @RestParameter(
              name = &quot;withPublications&quot;,
              isRequired = false,
              description = &quot;If available publications for&quot;
              + &quot;the content should be returned. Only works for content of type EVENT.&quot;,
              type = BOOLEAN,
              defaultValue = &quot;true&quot;
          )
      },
      responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;A playlist as XML.&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No playlist with that identifier exists.&quot;),
          @RestResponse(responseCode = SC_UNAUTHORIZED, description = &quot;Not authorized to perform this action&quot;)
      })
  public Response getPlaylistAsXml(
      @PathParam(&quot;id&quot;) String id,
      @FormParam(&quot;withPublications&quot;) boolean withPublications)
          throws NotFoundException, UnauthorizedException {
<span class="nc" id="L256">    return getPlaylistAsJson(id, withPublications);</span>
  }

  @GET
  @Produces(MediaType.APPLICATION_JSON)
  @Path(&quot;playlists.json&quot;)
  @RestQuery(
      name = &quot;playlists&quot;,
      description = &quot;Get playlists. Playlists that you do not have read access to will not show up.&quot;,
      returnDescription = &quot;A JSON object containing an array.&quot;,
      restParameters = {
          @RestParameter(
              name = &quot;limit&quot;,
              isRequired = false,
              type = INTEGER,
              description = &quot;The maximum number of results to return for a single request.&quot;,
              defaultValue = &quot;100&quot;
          ),
          @RestParameter(
              name = &quot;offset&quot;,
              isRequired = false,
              type = INTEGER,
              description = &quot;The index of the first result to return.&quot;
          ),
          @RestParameter(
              name = &quot;sort&quot;,
              isRequired = false,
              type = STRING,
              description = &quot;Sort the results based upon a sorting criteria. A criteria is specified as a pair such as:&quot;
                  + &quot;&lt;Sort Name&gt;:ASC or &lt;Sort Name&gt;:DESC. Adding the suffix ASC or DESC sets the order as ascending or&quot;
                  + &quot;descending order and is mandatory. Sort Name is case sensitive. Supported Sort Names are 'updated'&quot;
              ,
              defaultValue = &quot;updated:ASC&quot;
          ),
      },
      responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;A playlist as JSON.&quot;),
          @RestResponse(responseCode = SC_BAD_REQUEST, description = &quot;A request parameter was illegal.&quot;),
      })
  public Response getPlaylistsAsJson(
      @FormParam(&quot;limit&quot;) int limit,
      @FormParam(&quot;offset&quot;) int offset,
      @FormParam(&quot;sort&quot;) String sort)
          throws NotFoundException {
<span class="nc bnc" id="L300" title="All 2 branches missed.">    if (offset &lt; 0) {</span>
<span class="nc" id="L301">      return Response.status(SC_BAD_REQUEST).build();</span>
    }

<span class="nc bnc" id="L304" title="All 2 branches missed.">    if (limit &lt; 0) {</span>
<span class="nc" id="L305">      return Response.status(SC_BAD_REQUEST).build();</span>
    }

<span class="nc" id="L308">    SortCriterion sortCriterion = new SortCriterion(&quot;&quot;, SortCriterion.Order.None);</span>
<span class="nc" id="L309">    Option&lt;String&gt; optSort = Option.option(trimToNull(sort));</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">    if (optSort.isSome()) {</span>
<span class="nc" id="L311">      sortCriterion = SortCriterion.parse(optSort.get());</span>

<span class="nc bnc" id="L313" title="All 2 branches missed.">      switch (sortCriterion.getFieldName()) {</span>
        case &quot;updated&quot;:
<span class="nc" id="L315">          break;</span>
        default:
<span class="nc" id="L317">          logger.info(&quot;Unknown sort criteria {}&quot;, sortCriterion.getFieldName());</span>
<span class="nc" id="L318">          return Response.status(SC_BAD_REQUEST).build();</span>
      }
    }

<span class="nc" id="L322">    List&lt;JaxbPlaylist&gt; jaxbPlaylists = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">    for (Playlist playlist : service.getPlaylists(limit, offset, sortCriterion)) {</span>
<span class="nc" id="L324">      jaxbPlaylists.add(new JaxbPlaylist(playlist));</span>
<span class="nc" id="L325">    }</span>

<span class="nc" id="L327">    return Response.ok().entity(new GenericEntity&lt;&gt;(jaxbPlaylists) { }).build();</span>
  }

  @GET
  @Produces(MediaType.APPLICATION_XML)
  @Path(&quot;playlists.xml&quot;)
  @RestQuery(
      name = &quot;playlists&quot;,
      description = &quot;Get playlists. Playlists that you do not have read access to will not show up.&quot;,
      returnDescription = &quot;A XML object containing an array.&quot;,
      restParameters = {
          @RestParameter(
              name = &quot;limit&quot;,
              isRequired = false,
              type = INTEGER,
              description = &quot;The maximum number of results to return for a single request.&quot;,
              defaultValue = &quot;100&quot;
          ),
          @RestParameter(
              name = &quot;offset&quot;,
              isRequired = false,
              type = INTEGER,
              description = &quot;The index of the first result to return.&quot;
          ),
          @RestParameter(
              name = &quot;sort&quot;,
              isRequired = false,
              type = STRING,
              description = &quot;Sort the results based upon a sorting criteria. A criteria is specified as a pair such as:&quot;
                  + &quot;&lt;Sort Name&gt;:ASC or &lt;Sort Name&gt;:DESC. Adding the suffix ASC or DESC sets the order as ascending or&quot;
                  + &quot;descending order and is mandatory. Sort Name is case sensitive. Supported Sort Names are 'updated'&quot;
              ,
              defaultValue = &quot;updated:ASC&quot;
          ),
      },
      responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;A playlist as XML.&quot;),
      })
  public Response getPlaylistsAsXml(
      @FormParam(&quot;limit&quot;) int limit,
      @FormParam(&quot;offset&quot;) int offset,
      @FormParam(&quot;sort&quot;) String sort)
          throws NotFoundException {
<span class="nc" id="L370">    return getPlaylistsAsJson(limit, offset, sort);</span>
  }

  @POST
  @Produces(MediaType.APPLICATION_JSON)
  @Path(&quot;new.json&quot;)
  @RestQuery(
      name = &quot;create&quot;,
      description = &quot;Creates a playlist.&quot;,
      returnDescription = &quot;The created playlist.&quot;,
      restParameters = {
          @RestParameter(
              name = &quot;playlist&quot;,
              isRequired = false,
              description = &quot;Playlist in JSON format&quot;,
              type = TEXT,
              jaxbClass = JaxbPlaylist.class,
              defaultValue = SAMPLE_PLAYLIST_JSON
          )
      },
      responses = {
          @RestResponse(responseCode = SC_CREATED, description = &quot;Playlist created.&quot;),
          @RestResponse(responseCode = SC_UNAUTHORIZED, description = &quot;Not authorized to perform this action&quot;)
      })
  public Response createAsJson(@FormParam(&quot;playlist&quot;) String playlistText)
          throws UnauthorizedException {
    try {
      // Map JSON to JPA
<span class="nc" id="L398">      Playlist playlist = parseJsonToPlaylist(playlistText);</span>

      // Persist
<span class="nc" id="L401">      playlist = service.update(playlist);</span>
<span class="nc" id="L402">      return Response.status(Response.Status.CREATED).entity(new JaxbPlaylist(playlist)).build();</span>
<span class="nc" id="L403">    } catch (Exception e) {</span>
<span class="nc" id="L404">      return Response.serverError().build();</span>
    }
  }

  @POST
  @Produces(MediaType.APPLICATION_XML)
  @Path(&quot;new.xml&quot;)
  @RestQuery(
      name = &quot;create&quot;,
      description = &quot;Creates a playlist.&quot;,
      returnDescription = &quot;The created playlist.&quot;,
      restParameters = {
          @RestParameter(
              name = &quot;playlist&quot;,
              isRequired = false,
              description = &quot;Playlist in XML format&quot;,
              type = TEXT,
              jaxbClass = JaxbPlaylist.class,
              defaultValue = SAMPLE_PLAYLIST_XML
          )
      },
      responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Playlist updated.&quot;),
          @RestResponse(responseCode = SC_UNAUTHORIZED, description = &quot;Not authorized to perform this action&quot;)
      })
  public Response createAsXml(@FormParam(&quot;playlist&quot;) String playlistText)
          throws UnauthorizedException {
    try {
      // Map XML to JPA
<span class="nc" id="L433">      Playlist playlist = parseXmlToPlaylist(playlistText);</span>

      // Persist
<span class="nc" id="L436">      playlist = service.update(playlist);</span>
<span class="nc" id="L437">      return Response.ok().entity(new JaxbPlaylist(playlist)).build();</span>
<span class="nc" id="L438">    } catch (Exception e) {</span>
<span class="nc" id="L439">      return Response.serverError().build();</span>
    }
  }

  @PUT
  @Produces(MediaType.APPLICATION_JSON)
  @Path(&quot;{id}.json&quot;)
  @RestQuery(
      name = &quot;update&quot;,
      description = &quot;Updates a playlist.&quot;,
      returnDescription = &quot;The updated playlist.&quot;,
      pathParameters = {
          @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;Playlist identifier&quot;, type = STRING)
      },
      restParameters = {
          @RestParameter(
              name = &quot;playlist&quot;,
              isRequired = false,
              description = &quot;Playlist in JSON format&quot;,
              type = TEXT,
              jaxbClass = JaxbPlaylist.class,
              defaultValue = SAMPLE_PLAYLIST_JSON
          )
      },
      responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Playlist updated.&quot;),
          @RestResponse(responseCode = SC_UNAUTHORIZED, description = &quot;Not authorized to perform this action&quot;)
      })
  public Response updateAsJson(
      @PathParam(&quot;id&quot;) String id,
      @FormParam(&quot;playlist&quot;) String playlistText
  )
          throws UnauthorizedException {
    try {
<span class="nc" id="L473">      Playlist playlist = service.updateWithJson(id, playlistText);</span>
<span class="nc" id="L474">      return Response.ok().entity(new JaxbPlaylist(playlist)).build();</span>
<span class="nc" id="L475">    } catch (Exception e) {</span>
<span class="nc" id="L476">      return Response.serverError().build();</span>
    }
  }

  @PUT
  @Produces(MediaType.APPLICATION_XML)
  @Path(&quot;{id}.xml&quot;)
  @RestQuery(
      name = &quot;update&quot;,
      description = &quot;Updates a playlist.&quot;,
      returnDescription = &quot;The updated playlist.&quot;,
      pathParameters = {
          @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;Playlist identifier&quot;, type = STRING)
      },
      restParameters = {
          @RestParameter(
              name = &quot;playlist&quot;,
              isRequired = false,
              description = &quot;Playlist in XML format&quot;,
              type = TEXT,
              jaxbClass = JaxbPlaylist.class,
              defaultValue = SAMPLE_PLAYLIST_XML
          )
      },
      responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Playlist updated.&quot;),
          @RestResponse(responseCode = SC_UNAUTHORIZED, description = &quot;Not authorized to perform this action&quot;)
      })
  public Response updateAsXml(
      @PathParam(&quot;id&quot;) String id,
      @FormParam(&quot;playlist&quot;) String playlistText
  )
          throws UnauthorizedException {
    try {
<span class="nc" id="L510">      XmlMapper xmlMapper = new XmlMapper();</span>
<span class="nc" id="L511">      JsonNode node = xmlMapper.readTree(playlistText.getBytes());</span>

<span class="nc" id="L513">      ObjectMapper jsonMapper = new ObjectMapper();</span>
<span class="nc" id="L514">      jsonMapper.enable(DeserializationFeature.ACCEPT_SINGLE_VALUE_AS_ARRAY);</span>
<span class="nc" id="L515">      String json = jsonMapper.writeValueAsString(node);</span>

<span class="nc" id="L517">      Playlist playlist = service.updateWithJson(id, json);</span>
<span class="nc" id="L518">      return Response.ok().entity(new JaxbPlaylist(playlist)).build();</span>
<span class="nc" id="L519">    } catch (Exception e) {</span>
<span class="nc" id="L520">      return Response.serverError().build();</span>
    }
  }

  @DELETE
  @Produces(MediaType.APPLICATION_JSON)
  @Path(&quot;{id}&quot;)
  @RestQuery(
      name = &quot;remove&quot;,
      description = &quot;Removes a playlist.&quot;,
      returnDescription = &quot;The removed playlist.&quot;,
      pathParameters = {
          @RestParameter(
              name = &quot;id&quot;,
              isRequired = true,
              description = &quot;Playlist identifier&quot;,
              type = STRING
          )
      },
      responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Playlist removed.&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No playlist with that identifier exists.&quot;),
          @RestResponse(responseCode = SC_UNAUTHORIZED, description = &quot;Not authorized to perform this action&quot;)
      })
  public Response remove(@PathParam(&quot;id&quot;) String id) throws NotFoundException, UnauthorizedException {
    try {
      // Persist
<span class="nc" id="L547">      Playlist playlist = service.remove(id);</span>
<span class="nc" id="L548">      return Response.ok().entity(new JaxbPlaylist(playlist)).build();</span>
<span class="nc" id="L549">    } catch (Exception e) {</span>
<span class="nc" id="L550">      return Response.serverError().build();</span>
    }
  }

  @POST
  @Produces(MediaType.APPLICATION_JSON)
  @Path(&quot;{id}/entries/new&quot;)
  @RestQuery(
      name = &quot;addEntry&quot;,
      description = &quot;Add entry to playlist.&quot;,
      returnDescription = &quot;The playlist with the new entry.&quot;,
      pathParameters = {
          @RestParameter(name = &quot;id&quot;, isRequired = true, description = &quot;Playlist identifier&quot;, type = STRING),
      },
      restParameters = {
          @RestParameter(
              name = &quot;contentId&quot;,
              isRequired = false,
              description = &quot;Content identifier&quot;,
              type = STRING
          ),
          @RestParameter(
              name = &quot;type&quot;,
              isRequired = false,
              description = &quot;Entry type. Enum. Valid values are EVENT,&quot;
              + &quot; INACCESSIBLE.&quot;,
              type = STRING
          ),
      },
      responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Playlist updated.&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No playlist with that identifier exists.&quot;),
          @RestResponse(responseCode = SC_UNAUTHORIZED, description = &quot;Not authorized to perform this action&quot;)
      })
  public Response addEntry(
      @PathParam(&quot;id&quot;) String playlistId,
      @FormParam(&quot;contentId&quot;) String contentId,
      @FormParam(&quot;type&quot;) PlaylistEntryType type)
          throws NotFoundException, UnauthorizedException {
    try {
<span class="nc" id="L590">      Playlist playlist = service.addEntry(playlistId, contentId, type);</span>
<span class="nc" id="L591">      return Response.ok().entity(new JaxbPlaylist(playlist)).build();</span>
<span class="nc" id="L592">    } catch (Exception e) {</span>
<span class="nc" id="L593">      return Response.serverError().build();</span>
    }
  }

  @POST
  @Produces(MediaType.APPLICATION_JSON)
  @Path(&quot;{id}/entries/{entryId}&quot;)
  @RestQuery(
      name = &quot;removeEntry&quot;,
      description = &quot;Remove entry from playlist.&quot;,
      returnDescription = &quot;Playlist without the entry.&quot;,
      pathParameters = {
          @RestParameter(
              name = &quot;id&quot;,
              isRequired = true,
              type = STRING,
              description = &quot;Identifier of the playlist to delete from&quot;
          ),
          @RestParameter(
              name = &quot;entryId&quot;,
              isRequired = false,
              type = LONG,
              description = &quot;Identifier of the entry that should be deleted&quot;
          )
      },
      responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Playlist updated.&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;No playlist or entry with that identifier exists.&quot;),
          @RestResponse(responseCode = SC_UNAUTHORIZED, description = &quot;Not authorized to perform this action&quot;)
      })
  public Response addEntry(
      @PathParam(&quot;id&quot;) String playlistId,
      @PathParam(&quot;entryId&quot;) Long entryId)
          throws NotFoundException, UnauthorizedException {
    try {
<span class="nc" id="L628">      Playlist playlist = service.removeEntry(playlistId, entryId);</span>
<span class="nc" id="L629">      return Response.ok().entity(new JaxbPlaylist(playlist)).build();</span>
<span class="nc" id="L630">    } catch (Exception e) {</span>
<span class="nc" id="L631">      return Response.serverError().build();</span>
    }
  }

  /**
   * While jackson takes care of automatically converting JAXB to JSON when returning from a request, getting it to
   * parse JSON to JAXB when accepting a request is not that automatic. This functions takes care of that.
   * @param json Valid JSON as a string
   * @return A Playlist containing the information from the JSON
   * @throws ParseException
   * @throws IOException
   */
  public Playlist parseJsonToPlaylist(String json) throws ParseException, IOException {
<span class="nc" id="L644">    JaxbAnnotationModule module = new JaxbAnnotationModule();</span>
<span class="nc" id="L645">    ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="nc" id="L646">    objectMapper.registerModule(module);</span>

<span class="nc" id="L648">    JaxbPlaylist jaxbPlaylist = objectMapper.readValue(json, JaxbPlaylist.class);</span>
<span class="nc" id="L649">    return jaxbPlaylist.toPlaylist();</span>
  }

  private Playlist parseXmlToPlaylist(String xml) throws JAXBException, IOException, SAXException {
<span class="nc" id="L653">    JAXBContext context = JAXBContext.newInstance(JaxbPlaylist.class);</span>
<span class="nc" id="L654">    JaxbPlaylist jaxbPlaylist = context.createUnmarshaller()</span>
<span class="nc" id="L655">        .unmarshal(XmlSafeParser.parse(IOUtils.toInputStream(xml, &quot;UTF8&quot;)), JaxbPlaylist.class)</span>
<span class="nc" id="L656">        .getValue();</span>
<span class="nc" id="L657">    return jaxbPlaylist.toPlaylist();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>