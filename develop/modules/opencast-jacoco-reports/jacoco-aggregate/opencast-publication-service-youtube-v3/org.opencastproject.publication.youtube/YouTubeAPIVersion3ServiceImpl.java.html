<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>YouTubeAPIVersion3ServiceImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-publication-service-youtube-v3</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.publication.youtube</a> &gt; <span class="el_source">YouTubeAPIVersion3ServiceImpl.java</span></div><h1>YouTubeAPIVersion3ServiceImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.publication.youtube;

import org.opencastproject.publication.youtube.auth.ClientCredentials;
import org.opencastproject.publication.youtube.auth.OAuth2CredentialFactory;
import org.opencastproject.publication.youtube.auth.OAuth2CredentialFactoryImpl;
import org.opencastproject.util.data.Collections;

import com.google.api.client.googleapis.auth.oauth2.GoogleCredential;
import com.google.api.client.googleapis.media.MediaHttpUploader;
import com.google.api.client.http.InputStreamContent;
import com.google.api.client.http.javanet.NetHttpTransport;
import com.google.api.client.json.jackson2.JacksonFactory;
import com.google.api.services.youtube.YouTube;
import com.google.api.services.youtube.YouTubeRequest;
import com.google.api.services.youtube.model.Playlist;
import com.google.api.services.youtube.model.PlaylistItem;
import com.google.api.services.youtube.model.PlaylistItemListResponse;
import com.google.api.services.youtube.model.PlaylistItemSnippet;
import com.google.api.services.youtube.model.PlaylistListResponse;
import com.google.api.services.youtube.model.PlaylistSnippet;
import com.google.api.services.youtube.model.PlaylistStatus;
import com.google.api.services.youtube.model.ResourceId;
import com.google.api.services.youtube.model.SearchListResponse;
import com.google.api.services.youtube.model.Video;
import com.google.api.services.youtube.model.VideoListResponse;
import com.google.api.services.youtube.model.VideoSnippet;
import com.google.api.services.youtube.model.VideoStatus;

import org.apache.commons.lang3.ArrayUtils;

import java.io.BufferedInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.util.LinkedList;
import java.util.List;

<span class="nc" id="L59">public class YouTubeAPIVersion3ServiceImpl implements YouTubeAPIVersion3Service {</span>

  private YouTube youTube;

  @Override
  public void initialize(final ClientCredentials credentials) throws IOException {
<span class="nc" id="L65">    final OAuth2CredentialFactory factory = new OAuth2CredentialFactoryImpl();</span>
<span class="nc" id="L66">    final GoogleCredential credential = factory.getGoogleCredential(credentials);</span>
<span class="nc" id="L67">    youTube = new YouTube.Builder(new NetHttpTransport(), new JacksonFactory(), credential).build();</span>
<span class="nc" id="L68">  }</span>

  @Override
  public Video addVideoToMyChannel(final VideoUpload videoUpload) throws IOException {
<span class="nc" id="L72">    final Video videoObjectDefiningMetadata = new Video();</span>
<span class="nc" id="L73">    final VideoStatus status = new VideoStatus();</span>
<span class="nc" id="L74">    status.setPrivacyStatus(videoUpload.getPrivacyStatus());</span>
<span class="nc" id="L75">    videoObjectDefiningMetadata.setStatus(status);</span>
    // Metadata lives in VideoSnippet
<span class="nc" id="L77">    final VideoSnippet snippet = new VideoSnippet();</span>
<span class="nc" id="L78">    snippet.setTitle(videoUpload.getTitle());</span>
<span class="nc" id="L79">    snippet.setDescription(videoUpload.getDescription());</span>
<span class="nc" id="L80">    final String[] tags = videoUpload.getTags();</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">    if (ArrayUtils.isNotEmpty(tags)) {</span>
<span class="nc" id="L82">      snippet.setTags(Collections.list(tags));</span>
    }
    // Attach metadata to video object.
<span class="nc" id="L85">    videoObjectDefiningMetadata.setSnippet(snippet);</span>

<span class="nc" id="L87">    final File videoFile = videoUpload.getVideoFile();</span>
<span class="nc" id="L88">    final BufferedInputStream inputStream = new BufferedInputStream(new FileInputStream(videoFile));</span>
<span class="nc" id="L89">    final InputStreamContent mediaContent = new InputStreamContent(&quot;video/*&quot;, inputStream);</span>
<span class="nc" id="L90">    mediaContent.setLength(videoFile.length());</span>

<span class="nc" id="L92">    final YouTube.Videos.Insert videoInsert = youTube.videos()</span>
<span class="nc" id="L93">        .insert(&quot;snippet,statistics,status&quot;, videoObjectDefiningMetadata, mediaContent);</span>
<span class="nc" id="L94">    final MediaHttpUploader uploader = videoInsert.getMediaHttpUploader();</span>

<span class="nc" id="L96">    uploader.setDirectUploadEnabled(false);</span>
<span class="nc" id="L97">    uploader.setProgressListener(videoUpload.getProgressListener());</span>
<span class="nc" id="L98">    return execute(videoInsert);</span>
  }

  @Override
  public Playlist createPlaylist(final String title, final String description, final String... tags)
          throws IOException {
<span class="nc" id="L104">    final PlaylistSnippet playlistSnippet = new PlaylistSnippet();</span>
<span class="nc" id="L105">    playlistSnippet.setTitle(title);</span>
<span class="nc" id="L106">    playlistSnippet.setDescription(description);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">    if (tags.length &gt; 0) {</span>
<span class="nc" id="L108">      playlistSnippet.setTags(Collections.list(tags));</span>
    }
    // Playlists are always public. The videos therein might be private.
<span class="nc" id="L111">    final PlaylistStatus playlistStatus = new PlaylistStatus();</span>
<span class="nc" id="L112">    playlistStatus.setPrivacyStatus(&quot;public&quot;);</span>

    // Create playlist with metadata and status.
<span class="nc" id="L115">    final Playlist youTubePlaylist = new Playlist();</span>
<span class="nc" id="L116">    youTubePlaylist.setSnippet(playlistSnippet);</span>
<span class="nc" id="L117">    youTubePlaylist.setStatus(playlistStatus);</span>

    // The first argument tells the API what to return when a successful insert has been executed.
<span class="nc" id="L120">    final YouTube.Playlists.Insert command = youTube.playlists().insert(&quot;snippet,status&quot;, youTubePlaylist);</span>
<span class="nc" id="L121">    return execute(command);</span>
  }

  @Override
  public PlaylistItem addPlaylistItem(final String playlistId, final String videoId) throws IOException {
    // Resource type (video,playlist,channel) needs to be set along with resource id.
<span class="nc" id="L127">    final ResourceId resourceId = new ResourceId();</span>
<span class="nc" id="L128">    resourceId.setKind(&quot;youtube#video&quot;);</span>
<span class="nc" id="L129">    resourceId.setVideoId(videoId);</span>

    // Set the required snippet properties.
<span class="nc" id="L132">    final PlaylistItemSnippet playlistItemSnippet = new PlaylistItemSnippet();</span>
<span class="nc" id="L133">    playlistItemSnippet.setTitle(&quot;First video in the test playlist&quot;);</span>
<span class="nc" id="L134">    playlistItemSnippet.setPlaylistId(playlistId);</span>
<span class="nc" id="L135">    playlistItemSnippet.setResourceId(resourceId);</span>

    // Create the playlist item.
<span class="nc" id="L138">    final PlaylistItem playlistItem = new PlaylistItem();</span>
<span class="nc" id="L139">    playlistItem.setSnippet(playlistItemSnippet);</span>

    // The first argument tells the API what to return when a successful insert has been executed.
<span class="nc" id="L142">    final YouTube.PlaylistItems.Insert playlistItemsInsertCommand</span>
<span class="nc" id="L143">        = youTube.playlistItems().insert(&quot;snippet,contentDetails&quot;, playlistItem);</span>
<span class="nc" id="L144">    return execute(playlistItemsInsertCommand);</span>
  }

  @Override
  public void removeVideoFromPlaylist(final String playlistId, final String videoId) throws IOException {
<span class="nc" id="L149">    final PlaylistItem playlistItem = findPlaylistItem(playlistId, videoId);</span>
<span class="nc" id="L150">    final YouTube.PlaylistItems.Delete deleteRequest = youTube.playlistItems().delete(playlistItem.getId());</span>
<span class="nc" id="L151">    execute(deleteRequest);</span>
<span class="nc" id="L152">  }</span>

  @Override
  public void removeMyVideo(final String videoId) throws Exception {
<span class="nc" id="L156">    final YouTube.Videos.Delete deleteRequest = youTube.videos().delete(videoId);</span>
<span class="nc" id="L157">    execute(deleteRequest);</span>
<span class="nc" id="L158">  }</span>

  @Override
  public void removeMyPlaylist(final String playlistId) throws IOException {
<span class="nc" id="L162">    final YouTube.Playlists.Delete deleteRequest = youTube.playlists().delete(playlistId);</span>
<span class="nc" id="L163">    execute(deleteRequest);</span>
<span class="nc" id="L164">  }</span>

  @Override
  public SearchListResponse searchMyVideos(final String queryTerm, final String pageToken, final long maxResults)
          throws IOException {
<span class="nc" id="L169">    final YouTube.Search.List search = youTube.search().list(&quot;id,snippet&quot;);</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">    if (pageToken != null) {</span>
<span class="nc" id="L171">      search.set(&quot;pageToken&quot;, pageToken);</span>
    }
<span class="nc" id="L173">    search.setQ(queryTerm);</span>
<span class="nc" id="L174">    search.setType(&quot;video&quot;);</span>
<span class="nc" id="L175">    search.setForMine(true);</span>
<span class="nc" id="L176">    search.setMaxResults(maxResults);</span>
<span class="nc" id="L177">    search.setFields(&quot;items(id,kind,snippet),nextPageToken,pageInfo,prevPageToken,tokenPagination&quot;);</span>
<span class="nc" id="L178">    return execute(search);</span>
  }

  @Override
  public Video getVideoById(final String videoId) throws IOException {
<span class="nc" id="L183">    final YouTube.Videos.List search = youTube.videos().list(&quot;id,snippet&quot;);</span>
<span class="nc" id="L184">    search.setId(videoId);</span>
<span class="nc" id="L185">    search.setFields(&quot;items(id,kind,snippet),nextPageToken,pageInfo,prevPageToken,tokenPagination&quot;);</span>
<span class="nc" id="L186">    final VideoListResponse response = execute(search);</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">    return response.getItems().isEmpty() ? null : response.getItems().get(0);</span>
  }

  @Override
  public Playlist getMyPlaylistByTitle(final String title) throws IOException {
<span class="nc" id="L192">    final String trimmedTitle = title.trim();</span>
<span class="nc" id="L193">    boolean searchedAllPlaylist = false;</span>
<span class="nc" id="L194">    Playlist playlist = null;</span>
<span class="nc" id="L195">    String nextPageToken = null;</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">    while (!searchedAllPlaylist) {</span>
<span class="nc" id="L197">      final PlaylistListResponse searchResult = getMyPlaylists(nextPageToken, 50);</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">      for (final Playlist p : searchResult.getItems()) {</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (p.getSnippet().getTitle().trim().equals(trimmedTitle)) {</span>
<span class="nc" id="L200">          playlist = p;</span>
<span class="nc" id="L201">          break;</span>
        }
<span class="nc" id="L203">      }</span>
<span class="nc" id="L204">      nextPageToken = searchResult.getNextPageToken();</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">      searchedAllPlaylist = nextPageToken == null;</span>
<span class="nc" id="L206">    }</span>
<span class="nc" id="L207">    return playlist;</span>
  }

  @Override
  public PlaylistListResponse getMyPlaylists(final String pageToken, final long maxResults) throws IOException {
<span class="nc" id="L212">    final YouTube.Playlists.List search = youTube.playlists().list(&quot;id,snippet&quot;);</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">    if (pageToken != null) {</span>
<span class="nc" id="L214">      search.set(&quot;pageToken&quot;, pageToken);</span>
    }
<span class="nc" id="L216">    search.setMaxResults(maxResults);</span>
<span class="nc" id="L217">    search.setMine(true);</span>
<span class="nc" id="L218">    search.setFields(&quot;items(id,snippet),kind,nextPageToken,pageInfo,prevPageToken,tokenPagination&quot;);</span>
<span class="nc" id="L219">    return execute(search);</span>
  }

  @Override
  public PlaylistItemListResponse getPlaylistItems(
      final String playlistId,
      final String pageToken,
      final long maxResults
  ) throws IOException {
<span class="nc" id="L228">    final YouTube.PlaylistItems.List search = youTube.playlistItems().list(&quot;id,snippet&quot;);</span>
<span class="nc" id="L229">    search.setPlaylistId(playlistId);</span>
<span class="nc" id="L230">    search.setPageToken(pageToken);</span>
<span class="nc" id="L231">    search.setMaxResults(maxResults);</span>
<span class="nc" id="L232">    search.setFields(&quot;items(id,kind,snippet),nextPageToken,pageInfo,prevPageToken,tokenPagination&quot;);</span>
<span class="nc" id="L233">    return execute(search);</span>
  }

  /**
   * @param playlistId may not be {@code null}
   * @param videoId may not be {@code null}
   * @return null when not found.
   * @throws IOException when transaction fails.
   */
  private PlaylistItem findPlaylistItem(final String playlistId, final String videoId) throws IOException {
<span class="nc" id="L243">    final List&lt;PlaylistItem&gt; playlistItems = getAllPlaylistItems(playlistId);</span>
<span class="nc" id="L244">    PlaylistItem playlistItem = null;</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">    for (final PlaylistItem next : playlistItems) {</span>
<span class="nc" id="L246">      final String id = next.getSnippet().getResourceId().getVideoId();</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">      if (videoId.equals(id)) {</span>
<span class="nc" id="L248">        playlistItem = next;</span>
<span class="nc" id="L249">        break;</span>
      }
<span class="nc" id="L251">    }</span>
<span class="nc" id="L252">    return playlistItem;</span>
  }

  /**
   *
   * @param playlistId may not be {@code null}
   * @return zero or more playlist items.
   * @throws IOException  when transaction fails.
   */
  private List&lt;PlaylistItem&gt; getAllPlaylistItems(final String playlistId) throws IOException {
<span class="nc" id="L262">    final List&lt;PlaylistItem&gt; playlistItems = new LinkedList&lt;PlaylistItem&gt;();</span>
<span class="nc" id="L263">    boolean done = false;</span>
<span class="nc" id="L264">    String nextPageToken = null;</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">    while (!done) {</span>
<span class="nc" id="L266">      final PlaylistItemListResponse searchResult = getPlaylistItems(playlistId, nextPageToken, 50);</span>
<span class="nc" id="L267">      playlistItems.addAll(searchResult.getItems());</span>
<span class="nc" id="L268">      nextPageToken = searchResult.getNextPageToken();</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">      done = nextPageToken == null;</span>
<span class="nc" id="L270">    }</span>
<span class="nc" id="L271">    return playlistItems;</span>
  }

  /**
   * @see com.google.api.services.youtube.YouTubeRequest#execute()
   * @param command may not be {@code null}
   * @param &lt;T&gt; type of request.
   * @return result; may be {@code null}
   * @throws IOException  when transaction fails.
   */
  private &lt;T&gt; T execute(final YouTubeRequest&lt;T&gt; command) throws IOException {
<span class="nc" id="L282">    return command.execute();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>