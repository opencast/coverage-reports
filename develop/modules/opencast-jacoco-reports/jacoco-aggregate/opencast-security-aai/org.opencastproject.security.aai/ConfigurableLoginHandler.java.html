<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ConfigurableLoginHandler.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-security-aai</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.security.aai</a> &gt; <span class="el_source">ConfigurableLoginHandler.java</span></div><h1>ConfigurableLoginHandler.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.security.aai;

import static org.opencastproject.security.api.SecurityConstants.GLOBAL_ADMIN_ROLE;

import org.opencastproject.security.api.JaxbOrganization;
import org.opencastproject.security.api.JaxbRole;
import org.opencastproject.security.api.Organization;
import org.opencastproject.security.api.Role;
import org.opencastproject.security.api.RoleProvider;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.UserProvider;
import org.opencastproject.security.impl.jpa.JpaOrganization;
import org.opencastproject.security.impl.jpa.JpaRole;
import org.opencastproject.security.impl.jpa.JpaUserReference;
import org.opencastproject.security.shibboleth.ShibbolethLoginHandler;
import org.opencastproject.userdirectory.api.UserReferenceProvider;

import org.apache.commons.lang3.BooleanUtils;
import org.apache.commons.lang3.StringUtils;
import org.osgi.framework.BundleContext;
import org.osgi.framework.FrameworkUtil;
import org.osgi.service.cm.ConfigurationException;
import org.osgi.service.cm.ManagedService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.security.core.userdetails.UsernameNotFoundException;

import java.nio.charset.StandardCharsets;
import java.util.Arrays;
import java.util.Collections;
import java.util.Date;
import java.util.Dictionary;
import java.util.HashSet;
import java.util.Hashtable;
import java.util.Iterator;
import java.util.List;
import java.util.Set;
import java.util.regex.Pattern;

import javax.servlet.http.HttpServletRequest;

/**
 * This configurable implementation of the ShibbolethLoginHandler uses the UserReferenceProvider interface to create
 * and update Opencast reference users provided and authenticated by an external identity provider.
 * Note that this configurable implementation aims at requiring the minimum number of Shibboleth attributes
 * to make Opencast work with most Shibboleth-based Authentication and Authorization Infrastractures (AAI).
 */
public class ConfigurableLoginHandler implements ShibbolethLoginHandler, RoleProvider, ManagedService {

  /** Name of the configuration property that specifies whether AAI authencation is enabled. This is used to avoid log
      messages in case the module is included in the distribution but not in use */
  private static final String CFG_AAI_ENABLED_KEY = &quot;enabled&quot;;

  /** Default value of the configuration property CFG_AAI_ENABLED_KEY **/
  private static final boolean CFG_AAI_ENABLED_DEFAULT = false;

  /** Name of the configuration property specifying the ID of the bootstrap user. The bootstrap user
    * will be assigned the global admin role */
  private static final String CFG_BOOTSTRAP_USER_ID_KEY = &quot;bootstrap.user.id&quot;;

  /** Shibboleth header configuration */

  /** Name of the configuration property specifying the name of the HTTP request header where the users name can be
      extracted */
  private static final String CFG_HEADER_GIVEN_NAME_KEY = &quot;header.given_name&quot;;

  /** Name of the configuration property specifying the name of the HTTP request header where the users surname can be
      extracted */
  private static final String CFG_HEADER_SURNAME_KEY = &quot;header.surname&quot;;

  /** Name of the configuration property specifying the name of the HTTP request header where the users e-mail can be
      extracted */
  private static final String CFG_HEADER_MAIL_KEY = &quot;header.mail&quot;;

  /** Name of the optional configuration property specifying a list of home organizations */
  private static final String CFG_HEADER_HOME_ORGANIZATION_KEY = &quot;header.home_organization&quot;;

  /** Name of the optional configuration property specifying the name of the HTTP request header where affiliations
      can be extracted */
  private static final String CFG_HEADER_AFFILIATION_KEY = &quot;header.affiliation&quot;;

  /** Shibboleth roles configuration */

  /**
   * Name of the configuration property that specifies the prefix of the user role uniquely identifying a Shibboleth
   * authenticated users. The user role will be of the form ROLE_USER_PREFIX + SHIBBOLETH_UNIQUE_ID
   */
  private static final String CFG_ROLE_USER_PREFIX_KEY = &quot;role.user.prefix&quot;;

  /** Default value of configuration property CFG_ROLE_USER_PREFIX_KEY */
  private static final String CFG_ROLE_USER_PREFIX_DEFAULT = &quot;ROLE_AAI_USER_&quot;;

  /** The organization membership role indicates that a user belong to a specific AAI home organization.
      It has the from: valueOf(role.organization.prefix) + homeOrganization + valueOf(role.organization.suffix) */

  /** Name of the configuration property that specifies the prefix of the organization membership role */
  private static final String CFG_ROLE_ORGANIZATION_PREFIX_KEY = &quot;role.organization.prefix&quot;;

  /** Default value of configuration property CFG_ROLE_ORGANIZATION_PREFIX_KEY */
  private static final String CFG_ROLE_ORGANIZATION_PREFIX_DEFAULT = &quot;ROLE_AAI_ORG_&quot;;

  /** Name of the configuration property that specifies the prefix of the organization membership role */
  private static final String CFG_ROLE_ORGANIZATION_SUFFIX_KEY = &quot;role.organization.suffix&quot;;

  /** Default value of configuration property CFG_ROLE_ORGANIZATION_SUFFIX_KEY */
  private static final String CFG_ROLE_ORGANIZATION_SUFFIX_DEFAULT = &quot;_MEMBER&quot;;

  /** Name of the configuration property that specifies the name of the role assigned to all Shibboleth authenticated
      users, i.e. members of an Sibboleth federation */
  private static final String CFG_ROLE_FEDERATION_KEY = &quot;role.federation&quot;;

  /** Default value of the configuration property CFG_ROLE_FEDERATION_KEY */
  private static final String CFG_ROLE_FEDERATION_DEFAULT = &quot;ROLE_AAI_USER&quot;;

  /**
   * Name of the configuration property that specifies the prefix of the affiliation role for Shibboleth
   * authenticated users. The role will be of the form ROLE_AFFILIATION_PREFIX + SHIBBOLETH_EDUPERSONAFFILIATION
   */
  private static final String CFG_ROLE_AFFILIATION_PREFIX_KEY = &quot;role.affiliation.prefix&quot;;

  /** Default value of configuration property CFG_ROLE_USER_PREFIX_KEY */
  private static final String CFG_ROLE_AFFILIATION_PREFIX_DEFAULT = &quot;ROLE_AAI_USER_AFFILIATION_&quot;;

  /** The logging facility */
<span class="nc" id="L145">  private static final Logger logger = LoggerFactory.getLogger(ConfigurableLoginHandler.class);</span>

  /** The user reference provider */
<span class="nc" id="L148">  private UserReferenceProvider userReferenceProvider = null;</span>

  /** The security service */
<span class="nc" id="L151">  private SecurityService securityService = null;</span>

  /** Whether the configurable Shibboleth login handler */
<span class="nc" id="L154">  private boolean enabled = CFG_AAI_ENABLED_DEFAULT;</span>

  /** The ID of the bootstrap user if configured */
<span class="nc" id="L157">  private String bootstrapUserId = null;</span>

  /** Header to extract the given name (first name) from */
<span class="nc" id="L160">  private String headerGivenName = null;</span>

  /** Header to extract to surname */
<span class="nc" id="L163">  private String headerSurname = null;</span>

  /** Header to extract the e-mail address */
<span class="nc" id="L166">  private String headerMail = null;</span>

  /** Header to extract the home organization */
<span class="nc" id="L169">  private String headerHomeOrganization = null;</span>

  /** Header to extract the affiliation */
<span class="nc" id="L172">  private String headerAffiliation = null;</span>

  /** Role assigned to all Shibboleth authenticated users */
<span class="nc" id="L175">  private String roleFederationMember = CFG_ROLE_FEDERATION_DEFAULT;</span>

  /** Prefix of unique Shibboleth user role */
<span class="nc" id="L178">  private String roleUserPrefix = CFG_ROLE_USER_PREFIX_DEFAULT;</span>

  /** Prefix of the home organization membership role */
<span class="nc" id="L181">  private String roleOrganizationPrefix = CFG_ROLE_ORGANIZATION_PREFIX_DEFAULT;</span>

  /** Suffix of the home organization membership role */
<span class="nc" id="L184">  private String roleOrganizationSuffix = CFG_ROLE_ORGANIZATION_SUFFIX_DEFAULT;</span>

  /** Prefix of the affiliation role */
<span class="nc" id="L187">  private String roleAffiliationPrefix = CFG_ROLE_AFFILIATION_PREFIX_DEFAULT;</span>

  /*
   * It is the bundle kernel what will need to instantiate the ConfigurableLoginHandler
   * since it is wired using Spring Security.
   * Since Shibboleth support is supposed to be an optional extension of the bundle kernel,
   * we implement this as fragment bundle.
   * The use of the Service Component Runtime (SCR) would require us to declare this bundle as service
   * component in kernel which we don't want since it is optional.
   * To make us visible to the config admin and take advantage of the ManagedService mechanism, we
   * register us as ManagedService in the constructor.
   * An alternative solution would be to include the manifest of all fragments in kernel, i.e.
   * by specifying OSGI-INF/*.xml as service component in kernel.
   */
<span class="nc" id="L201">  public ConfigurableLoginHandler() {</span>
<span class="nc" id="L202">    BundleContext bundleContext = FrameworkUtil.getBundle(this.getClass()).getBundleContext();</span>
<span class="nc" id="L203">    registerAsManagedService(bundleContext);</span>
<span class="nc" id="L204">  }</span>

<span class="nc" id="L206">  protected ConfigurableLoginHandler(BundleContext bundleContext) {</span>
<span class="nc" id="L207">    registerAsManagedService(bundleContext);</span>
<span class="nc" id="L208">  }</span>

  private void registerAsManagedService(BundleContext bundleContext) {
<span class="nc" id="L211">    Dictionary&lt;String, String&gt; properties = new Hashtable&lt;String, String&gt;();</span>
<span class="nc" id="L212">    properties.put(&quot;service.pid&quot;, this.getClass().getName());</span>
<span class="nc" id="L213">    bundleContext.registerService(ManagedService.class.getName(), this, properties);</span>
<span class="nc" id="L214">  }</span>

  @Override
  public void updated(Dictionary properties) throws ConfigurationException {
<span class="nc bnc" id="L218" title="All 2 branches missed.">    if (properties == null) {</span>
<span class="nc" id="L219">      return;</span>
    }

<span class="nc" id="L222">    String cfgEnabled = StringUtils.trimToNull((String) properties.get(CFG_AAI_ENABLED_KEY));</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">    if (cfgEnabled != null) {</span>
<span class="nc" id="L224">      enabled = BooleanUtils.toBoolean(cfgEnabled);</span>
    }

<span class="nc bnc" id="L227" title="All 2 branches missed.">    if (enabled) {</span>
<span class="nc" id="L228">      logger.info(&quot;AAI login handler is enabled.&quot;);</span>
    } else {
<span class="nc" id="L230">      logger.info(&quot;AAI login handler is disabled.&quot;);</span>
<span class="nc" id="L231">      return;</span>
    }

<span class="nc" id="L234">    String cfgBootstrapUserId = StringUtils.trimToNull((String) properties.get(CFG_BOOTSTRAP_USER_ID_KEY));</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">    if (cfgBootstrapUserId != null) {</span>
<span class="nc" id="L236">      bootstrapUserId = cfgBootstrapUserId;</span>
<span class="nc" id="L237">      logger.warn(&quot;AAI User ID '{}' is configured as AAI boostrap user. You want to disable this after bootstrapping.&quot;,</span>
              bootstrapUserId);
    } else {
<span class="nc" id="L240">      bootstrapUserId = null;</span>
    }

    /* Shibboleth header configuration */

<span class="nc" id="L245">    String cfgGivenName = StringUtils.trimToNull((String) properties.get(CFG_HEADER_GIVEN_NAME_KEY));</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">    if (cfgGivenName != null) {</span>
<span class="nc" id="L247">      headerGivenName = cfgGivenName;</span>
<span class="nc" id="L248">      logger.info(&quot;Header '{}' set to '{}'&quot;, CFG_HEADER_GIVEN_NAME_KEY, headerGivenName);</span>
    } else {
<span class="nc" id="L250">      logger.error(&quot;Header '{}' is not configured &quot;, CFG_HEADER_GIVEN_NAME_KEY);</span>
    }

<span class="nc" id="L253">    String cfgSurname = StringUtils.trimToNull((String) properties.get(CFG_HEADER_SURNAME_KEY));</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">    if (cfgSurname != null) {</span>
<span class="nc" id="L255">      headerSurname = cfgSurname;</span>
<span class="nc" id="L256">      logger.info(&quot;Header '{}' set to '{}'&quot;, CFG_HEADER_SURNAME_KEY, headerSurname);</span>
    } else {
<span class="nc" id="L258">      logger.error(&quot;Header '{}' is not configured &quot;, CFG_HEADER_SURNAME_KEY);</span>
    }

<span class="nc" id="L261">    String cfgMail = StringUtils.trimToNull((String) properties.get(CFG_HEADER_MAIL_KEY));</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">    if (cfgMail != null) {</span>
<span class="nc" id="L263">      headerMail = cfgMail;</span>
<span class="nc" id="L264">      logger.info(&quot;Header '{}' set to '{}'&quot;, CFG_HEADER_MAIL_KEY, headerMail);</span>
    } else {
<span class="nc" id="L266">      logger.error(&quot;Header '{}' is not configured &quot;, CFG_HEADER_MAIL_KEY);</span>
    }

<span class="nc" id="L269">    String cfgHomeOrganization = StringUtils.trimToNull((String) properties.get(CFG_HEADER_HOME_ORGANIZATION_KEY));</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">    if (cfgHomeOrganization != null) {</span>
<span class="nc" id="L271">      headerHomeOrganization = cfgHomeOrganization;</span>
<span class="nc" id="L272">      logger.info(&quot;Header '{}' set to '{}'&quot;, CFG_HEADER_HOME_ORGANIZATION_KEY, headerHomeOrganization);</span>
    } else {
<span class="nc" id="L274">      logger.warn(&quot;Optional header '{}' is not configured &quot;, CFG_HEADER_HOME_ORGANIZATION_KEY);</span>
    }

<span class="nc" id="L277">    String cfgAffiliation = StringUtils.trimToNull((String) properties.get(CFG_HEADER_AFFILIATION_KEY));</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">    if (cfgAffiliation != null) {</span>
<span class="nc" id="L279">      headerAffiliation = cfgAffiliation;</span>
<span class="nc" id="L280">      logger.info(&quot;Header '{}' set to '{}'&quot;, CFG_HEADER_AFFILIATION_KEY, headerAffiliation);</span>
    } else {
<span class="nc" id="L282">      logger.warn(&quot;Optional header '{}' is not configured &quot;, CFG_HEADER_AFFILIATION_KEY);</span>
    }

    /* Shibboleth roles configuration */

<span class="nc" id="L287">    String cfgRoleFederationMember = StringUtils.trimToNull((String) properties.get(CFG_ROLE_FEDERATION_KEY));</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">    if (cfgRoleFederationMember != null) {</span>
<span class="nc" id="L289">      roleFederationMember = cfgRoleFederationMember;</span>
<span class="nc" id="L290">      logger.info(&quot;AAI federation membership role '{}' set to '{}'&quot;, CFG_ROLE_FEDERATION_KEY,</span>
              roleFederationMember);
    } else {
<span class="nc" id="L293">      roleFederationMember = CFG_ROLE_FEDERATION_DEFAULT;</span>
<span class="nc" id="L294">      logger.info(&quot;AAI federation membership role '{}' is not configured, using default '{}'&quot;,</span>
              CFG_ROLE_FEDERATION_KEY, roleFederationMember);
    }

<span class="nc" id="L298">    String cfgRoleUserPrefix = StringUtils.trimToNull((String) properties.get(CFG_ROLE_USER_PREFIX_KEY));</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">    if (cfgRoleUserPrefix != null) {</span>
<span class="nc" id="L300">      roleUserPrefix = cfgRoleUserPrefix;</span>
<span class="nc" id="L301">      logger.info(&quot;AAI user role prefix '{}' set to '{}'&quot;, CFG_ROLE_USER_PREFIX_KEY, roleUserPrefix);</span>
    } else {
<span class="nc" id="L303">      roleUserPrefix = CFG_ROLE_USER_PREFIX_DEFAULT;</span>
<span class="nc" id="L304">      logger.info(&quot;AAI user role prefix '{}' is not configured, using default '{}'&quot;, CFG_ROLE_USER_PREFIX_KEY,</span>
              roleUserPrefix);
    }

<span class="nc" id="L308">    String cfgRoleOrganizationPrefix = StringUtils.trimToNull((String) properties.get(</span>
            CFG_ROLE_ORGANIZATION_PREFIX_KEY));
<span class="nc bnc" id="L310" title="All 2 branches missed.">    if (cfgRoleOrganizationPrefix != null) {</span>
<span class="nc" id="L311">      roleOrganizationPrefix = cfgRoleOrganizationPrefix;</span>
<span class="nc" id="L312">      logger.info(&quot;AAI organization membership role prefix '{}' set to '{}'&quot;, CFG_ROLE_ORGANIZATION_PREFIX_KEY,</span>
              cfgRoleOrganizationPrefix);
    } else {
<span class="nc" id="L315">      roleOrganizationPrefix = CFG_ROLE_ORGANIZATION_PREFIX_DEFAULT;</span>
<span class="nc" id="L316">      logger.info(&quot;AAI organization membership role prefix '{}' is not configured, using default '{}'&quot;,</span>
              CFG_ROLE_ORGANIZATION_PREFIX_KEY, roleOrganizationPrefix);
    }

<span class="nc" id="L320">    String cfgRoleOrganizationSuffix = StringUtils.trimToNull((String) properties.get(</span>
            CFG_ROLE_ORGANIZATION_SUFFIX_KEY));
<span class="nc bnc" id="L322" title="All 2 branches missed.">    if (cfgRoleOrganizationSuffix != null) {</span>
<span class="nc" id="L323">      roleOrganizationSuffix = cfgRoleOrganizationSuffix;</span>
<span class="nc" id="L324">      logger.info(&quot;AAI organization membership role suffix '{}' set to '{}'&quot;, CFG_ROLE_ORGANIZATION_SUFFIX_KEY,</span>
              cfgRoleOrganizationSuffix);
    } else {
<span class="nc" id="L327">      roleOrganizationSuffix = CFG_ROLE_ORGANIZATION_SUFFIX_DEFAULT;</span>
<span class="nc" id="L328">      logger.info(&quot;AAI organization membership role suffix '{}' is not configured, using default '{}'&quot;,</span>
              CFG_ROLE_ORGANIZATION_SUFFIX_KEY, roleOrganizationSuffix);
    }

<span class="nc" id="L332">    String cfgRoleAffiliationPrefix = StringUtils.trimToNull((String) properties.get(</span>
            CFG_ROLE_AFFILIATION_PREFIX_KEY));
<span class="nc bnc" id="L334" title="All 2 branches missed.">    if (cfgRoleAffiliationPrefix != null) {</span>
<span class="nc" id="L335">      roleAffiliationPrefix = cfgRoleAffiliationPrefix;</span>
<span class="nc" id="L336">      logger.info(&quot;AAI affiliation role prefix '{}' set to '{}'&quot;, CFG_ROLE_AFFILIATION_PREFIX_KEY,</span>
              cfgRoleAffiliationPrefix);
    } else {
<span class="nc" id="L339">      roleAffiliationPrefix = CFG_ROLE_AFFILIATION_PREFIX_DEFAULT;</span>
<span class="nc" id="L340">      logger.info(&quot;AAI affiliation role prefix '{}' is not configured, using default '{}'&quot;,</span>
              CFG_ROLE_AFFILIATION_PREFIX_KEY, roleAffiliationPrefix);
    }
<span class="nc" id="L343">  }</span>

  /**
   * Handle a new user login.
   *
   * @param id
   *          The identity of the user, ideally the Shibboleth persistent unique identifier
   * @param request
   *          The request, for accessing any other Shibboleth variables
   */
  @Override
  public void newUserLogin(String id, HttpServletRequest request) {
<span class="nc" id="L355">    String name = extractName(request);</span>
<span class="nc" id="L356">    String email = extractEmail(request);</span>
<span class="nc" id="L357">    Date loginDate = new Date();</span>
<span class="nc" id="L358">    JpaOrganization organization = fromOrganization(securityService.getOrganization());</span>

    // Compile the list of roles
<span class="nc" id="L361">    Set&lt;JpaRole&gt; roles = extractRoles(id, request);</span>

    // Create the user reference
<span class="nc" id="L364">    JpaUserReference userReference = new JpaUserReference(id, name, email, MECH_SHIBBOLETH, loginDate, organization,</span>
            roles);

<span class="nc" id="L367">    logger.debug(&quot;Shibboleth user '{}' logged in for the first time&quot;, id);</span>
<span class="nc" id="L368">    userReferenceProvider.addUserReference(userReference, MECH_SHIBBOLETH);</span>
<span class="nc" id="L369">  }</span>

  /**
   * Handle an existing user login.
   *
   * @param id
   *          The identity of the user, ideally the Shibboleth persistent unique identifier
   * @param request
   *          The request, for accessing any other Shibboleth variables
   */
  @Override
  public void existingUserLogin(String id, HttpServletRequest request) {
<span class="nc" id="L381">    Organization organization = securityService.getOrganization();</span>

    // Load the user reference
<span class="nc" id="L384">    JpaUserReference userReference = userReferenceProvider.findUserReference(id, organization.getId());</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">    if (userReference == null) {</span>
<span class="nc" id="L386">      throw new UsernameNotFoundException(&quot;User reference '&quot; + id + &quot;' was not found&quot;);</span>
    }

    // Update the reference
<span class="nc" id="L390">    userReference.setName(extractName(request));</span>
<span class="nc" id="L391">    userReference.setEmail(extractEmail(request));</span>
<span class="nc" id="L392">    userReference.setLastLogin(new Date());</span>
<span class="nc" id="L393">    Set&lt;JpaRole&gt; roles = extractRoles(id, request);</span>
<span class="nc" id="L394">    userReference.setRoles(roles);</span>

<span class="nc" id="L396">    logger.debug(&quot;Shibboleth user '{}' logged in&quot;, id);</span>
<span class="nc" id="L397">    userReferenceProvider.updateUserReference(userReference);</span>
<span class="nc" id="L398">  }</span>

  /**
   * Sets the security service.
   *
   * @param securityService
   *          the security service
   */
  public void setSecurityService(SecurityService securityService) {
<span class="nc" id="L407">    this.securityService = securityService;</span>
<span class="nc" id="L408">  }</span>

  /**
   * Sets the user reference provider.
   *
   * @param userReferenceProvider
   *          the user reference provider
   */
  public void setUserReferenceProvider(UserReferenceProvider userReferenceProvider) {
<span class="nc" id="L417">    this.userReferenceProvider = userReferenceProvider;</span>
<span class="nc" id="L418">  }</span>

  /**
   * Extracts the name from the request.
   *
   * @param request
   *          the request
   * @return the name
   */
  private String extractName(HttpServletRequest request) {
<span class="nc bnc" id="L428" title="All 2 branches missed.">    String givenName = StringUtils.isBlank(request.getHeader(headerGivenName)) ? &quot;&quot;</span>
<span class="nc" id="L429">            : new String(request.getHeader(headerGivenName).getBytes(StandardCharsets.ISO_8859_1),</span>
                    StandardCharsets.UTF_8);
<span class="nc bnc" id="L431" title="All 2 branches missed.">    String surname = StringUtils.isBlank(request.getHeader(headerSurname)) ? &quot;&quot;</span>
<span class="nc" id="L432">            : new String(request.getHeader(headerSurname).getBytes(StandardCharsets.ISO_8859_1),</span>
                    StandardCharsets.UTF_8);

<span class="nc" id="L435">    return StringUtils.join(new String[] { givenName, surname }, &quot; &quot;);</span>
  }

  /**
   * Extracts the e-mail from the request.
   *
   * @param request
   *          the request
   * @return the e-mail address
   */
  private String extractEmail(HttpServletRequest request) {
<span class="nc" id="L446">    return request.getHeader(headerMail);</span>
  }

  /**
   * Extracts the roles from the request.
   *
   * @param request
   *          the request
   * @return the roles
   */
  private Set&lt;JpaRole&gt; extractRoles(String id, HttpServletRequest request) {
<span class="nc" id="L457">    JpaOrganization organization = fromOrganization(securityService.getOrganization());</span>
<span class="nc" id="L458">    Set&lt;JpaRole&gt; roles = new HashSet&lt;JpaRole&gt;();</span>
<span class="nc" id="L459">    roles.add(new JpaRole(roleFederationMember, organization));</span>
<span class="nc" id="L460">    roles.add(new JpaRole(roleUserPrefix + id, organization));</span>
<span class="nc" id="L461">    roles.add(new JpaRole(organization.getAnonymousRole(), organization));</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">    if (headerHomeOrganization != null) {</span>
<span class="nc" id="L463">      String homeOrganization = request.getHeader(headerHomeOrganization);</span>
<span class="nc" id="L464">      roles.add(new JpaRole(roleOrganizationPrefix + homeOrganization + roleOrganizationSuffix, organization));</span>
    }
<span class="nc bnc" id="L466" title="All 2 branches missed.">    if (StringUtils.equals(id, bootstrapUserId)) {</span>
<span class="nc" id="L467">      roles.add(new JpaRole(GLOBAL_ADMIN_ROLE, organization));</span>
    }
<span class="nc bnc" id="L469" title="All 2 branches missed.">    if (headerAffiliation != null) {</span>
<span class="nc" id="L470">      String affiliation = request.getHeader(headerAffiliation);</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">      if (affiliation != null) {</span>
<span class="nc" id="L472">        List&lt;String&gt; affiliations = Arrays.asList(affiliation.split(&quot;;&quot;));</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">        for (String eachAffiliation : affiliations) {</span>
<span class="nc" id="L474">          roles.add(new JpaRole(roleAffiliationPrefix + eachAffiliation, organization));</span>
<span class="nc" id="L475">        }</span>
      }
    }

<span class="nc" id="L479">    return roles;</span>
  }

  /**
   * Creates a JpaOrganization from an organization
   *
   * @param org
   *          the organization
   */
  private JpaOrganization fromOrganization(Organization org) {
<span class="nc bnc" id="L489" title="All 2 branches missed.">    if (org instanceof JpaOrganization) {</span>
<span class="nc" id="L490">      return (JpaOrganization) org;</span>
    } else {
<span class="nc" id="L492">      return new JpaOrganization(org.getId(), org.getName(), org.getServers(), org.getAdminRole(),</span>
<span class="nc" id="L493">           org.getAnonymousRole(), org.getProperties());</span>
    }
  }

  /**
   * @see org.opencastproject.security.api.RoleProvider#getRolesForUser(String)
   */
  @Override
  public List&lt;Role&gt; getRolesForUser(String userName) {
<span class="nc" id="L502">    return Collections.emptyList();</span>
  }

  /**
   * @see org.opencastproject.security.api.RoleProvider#getOrganization()
   */
  @Override
  public String getOrganization() {
<span class="nc" id="L510">    return UserProvider.ALL_ORGANIZATIONS;</span>
  }

  /**
   * @see org.opencastproject.security.api.RoleProvider#findRoles(String, Role.Target, int, int)
   */
  @Override
  public Iterator&lt;Role&gt; findRoles(String query, Role.Target target, int offset, int limit) {
<span class="nc bnc" id="L518" title="All 2 branches missed.">    if (query == null) {</span>
<span class="nc" id="L519">      throw new IllegalArgumentException(&quot;Query must be set&quot;);</span>
    }
<span class="nc" id="L521">    JaxbOrganization organization = JaxbOrganization.fromOrganization(securityService.getOrganization());</span>
<span class="nc" id="L522">    HashSet&lt;Role&gt; roles = new HashSet&lt;&gt;(2);</span>
<span class="nc" id="L523">    final String[] roleNames = new String[] {roleFederationMember, organization.getAnonymousRole()};</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">    for (String name: roleNames) {</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">      if (like(name, query)) {</span>
<span class="nc" id="L526">        roles.add(new JaxbRole(name, organization));</span>
      }
    }
<span class="nc" id="L529">    return offsetLimitCollection(offset, limit, roles).iterator();</span>
  }

  private &lt;T&gt; HashSet&lt;T&gt; offsetLimitCollection(int offset, int limit, HashSet&lt;T&gt; entries) {
<span class="nc" id="L533">    HashSet&lt;T&gt; result = new HashSet&lt;T&gt;();</span>
<span class="nc" id="L534">    int i = 0;</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">    for (T entry : entries) {</span>
<span class="nc bnc" id="L536" title="All 4 branches missed.">      if (limit != 0 &amp;&amp; result.size() &gt;= limit) {</span>
<span class="nc" id="L537">        break;</span>
      }
<span class="nc bnc" id="L539" title="All 2 branches missed.">      if (i &gt;= offset) {</span>
<span class="nc" id="L540">        result.add(entry);</span>
      }
<span class="nc" id="L542">      i++;</span>
<span class="nc" id="L543">    }</span>
<span class="nc" id="L544">    return result;</span>
  }

  private boolean like(String string, final String query) {
<span class="nc bnc" id="L548" title="All 2 branches missed.">    if (string == null) {</span>
<span class="nc" id="L549">      return false;</span>
    }
<span class="nc" id="L551">    String regex = query.replace(&quot;_&quot;, &quot;.&quot;).replace(&quot;%&quot;, &quot;.*?&quot;);</span>
<span class="nc" id="L552">    Pattern p = Pattern.compile(regex, Pattern.CASE_INSENSITIVE | Pattern.DOTALL);</span>
<span class="nc" id="L553">    return p.matcher(string).matches();</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>