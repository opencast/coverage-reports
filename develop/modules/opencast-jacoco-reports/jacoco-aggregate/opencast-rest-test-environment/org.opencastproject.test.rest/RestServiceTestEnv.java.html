<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>RestServiceTestEnv.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-rest-test-environment</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.test.rest</a> &gt; <span class="el_source">RestServiceTestEnv.java</span></div><h1>RestServiceTestEnv.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.test.rest;

import static org.opencastproject.util.data.functions.Misc.chuck;

import org.opencastproject.util.UrlSupport;

import org.eclipse.jetty.server.Server;
import org.eclipse.jetty.servlet.ServletContextHandler;
import org.eclipse.jetty.servlet.ServletHolder;
import org.glassfish.jersey.server.ResourceConfig;
import org.glassfish.jersey.servlet.ServletContainer;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.net.URL;
import java.util.concurrent.ThreadLocalRandom;

/**
 * Helper environment for creating REST service unit tests.
 * &lt;p&gt;
 * The REST endpoint to test needs a no-arg constructor in order to be created by the framework.
 * &lt;p&gt;
 * Write REST unit tests using &lt;a href=&quot;http://code.google.com/p/rest-assured/&quot;&gt;rest assured&lt;/a&gt;.
 * &lt;h2&gt;Example Usage&lt;/h2&gt;
 * 
 * &lt;pre&gt;
 *   import static com.jayway.restassured.RestAssured.*;
 *   import static com.jayway.restassured.matcher.RestAssuredMatchers.*;
 *   import static org.hamcrest.Matchers.*;
 *   import static org.opencastproject.rest.RestServiceTestEnv.*
 *
 *   public class RestEndpointTest {
 *   // create a local environment running on some random port
 *   // use rt.host(&quot;/path/to/service&quot;) to wrap all URL creations for HTTP request methods
 *   private static final RestServiceTestEnv rt = testEnvScanAllPackages(localhostRandomPort());
 *
 *   \@BeforeClass public static void oneTimeSetUp() {
 *   env.setUpServer();
 *   }
 *
 *   \@AfterClass public static void oneTimeTearDown() {
 *   env.tearDownServer();
 *   }
 *   }
 * &lt;/pre&gt;
 * 
 * Add the following dependencies to your pom
 * 
 * &lt;pre&gt;
 * &amp;lt;dependency&amp;gt;
 *   &amp;lt;groupId&amp;gt;com.jayway.restassured&amp;lt;/groupId&amp;gt;
 *   &amp;lt;artifactId&amp;gt;rest-assured&amp;lt;/artifactId&amp;gt;
 *   &amp;lt;version&amp;gt;1.7.2&amp;lt;/version&amp;gt;
 *   &amp;lt;scope&amp;gt;test&amp;lt;/scope&amp;gt;
 * &amp;lt;/dependency&amp;gt;
 * &amp;lt;dependency&amp;gt;
 *   &amp;lt;groupId&amp;gt;org.apache.httpcomponents&amp;lt;/groupId&amp;gt;
 *   &amp;lt;artifactId&amp;gt;httpcore&amp;lt;/artifactId&amp;gt;
 *   &amp;lt;version&amp;gt;4.2.4&amp;lt;/version&amp;gt;
 *   &amp;lt;scope&amp;gt;test&amp;lt;/scope&amp;gt;
 * &amp;lt;/dependency&amp;gt;
 * &lt;/pre&gt;
 */
public final class RestServiceTestEnv {
  private Server server;

<span class="fc" id="L89">  private URL baseUrl = null;</span>
  private final ResourceConfig cfg;

<span class="fc" id="L92">  private static final Logger logger = LoggerFactory.getLogger(RestServiceTestEnv.class);</span>

  /**
   * Create an environment for &lt;code&gt;baseUrl&lt;/code&gt;. The base URL should be the URL where the service to test is
   * mounted, e.g. http://localhost:8090/test
   */
<span class="fc" id="L98">  private RestServiceTestEnv(ResourceConfig cfg) {</span>
<span class="fc" id="L99">    this.cfg = cfg;</span>
<span class="fc" id="L100">  }</span>

  public static RestServiceTestEnv testEnvForClasses(Class&lt;?&gt;... restServices) {
<span class="fc" id="L103">    return new RestServiceTestEnv(new ResourceConfig(restServices));</span>
  }

  /** Create a URL suitable for rest-assured's post(), get() e.al. methods. */
  public String host(String path) {
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">    if (baseUrl == null) {</span>
<span class="nc" id="L109">      throw new RuntimeException(&quot;Server not yet started&quot;);</span>
    }
<span class="fc" id="L111">    return UrlSupport.url(baseUrl, path).toString();</span>
  }

  /**
   * Return the base URL of the HTTP server. &lt;code&gt;http://host:port&lt;/code&gt; public URL getBaseUrl() { return baseUrl; }
   *
   * Call in @BeforeClass annotated method.
   */
  public void setUpServer() {
<span class="fc" id="L120">    int port = -1;</span>
<span class="fc" id="L121">    int maxRetries = 100;</span>
    try {
<span class="fc" id="L123">      ServletContainer servletContainer = new ServletContainer(cfg);</span>
<span class="fc" id="L124">      ServletHolder jerseyServlet = new ServletHolder(servletContainer);</span>
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">      for (int tries = maxRetries; tries &gt; 0; tries--) {</span>
        try {
<span class="fc" id="L127">          port = 3000 + tries + ThreadLocalRandom.current().nextInt(62000);</span>
<span class="fc" id="L128">          logger.info(&quot;Starting http server at port {}&quot;, port);</span>
<span class="fc" id="L129">          server = new Server(port);</span>
<span class="fc" id="L130">          ServletContextHandler context = new ServletContextHandler(server, &quot;/&quot;);</span>
<span class="fc" id="L131">          context.addServlet(jerseyServlet, &quot;/*&quot;);</span>
<span class="fc" id="L132">          server.start();</span>
<span class="fc" id="L133">          baseUrl = UrlSupport.url(&quot;http&quot;, &quot;127.0.0.1&quot;, port);</span>
<span class="fc" id="L134">          return;</span>
<span class="nc" id="L135">        } catch (IOException e) {</span>
<span class="nc" id="L136">          logger.error(&quot;Couldn't bind server to port {}. Retrying with new port...&quot;, port, e);</span>
          // Rethrow exception after last try
<span class="nc bnc" id="L138" title="All 2 branches missed.">          if (tries == 1) {</span>
<span class="nc" id="L139">            logger.error(&quot;Couldn't start server after {} tries.&quot;, maxRetries);</span>
<span class="nc" id="L140">            throw e;</span>
          }
<span class="nc" id="L142">          Thread.sleep(100);</span>
        }
      }
<span class="nc" id="L145">    } catch (Exception e) {</span>
<span class="nc" id="L146">      logger.error(&quot;Unexpected Exception occurred while setting up http server&quot;);</span>
<span class="nc" id="L147">      chuck(e);</span>
<span class="nc" id="L148">    }</span>
<span class="nc" id="L149">  }</span>

  /** Call in @AfterClass annotated method. */
  public void tearDownServer() {
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">    if (server != null) {</span>
<span class="fc" id="L154">      logger.info(&quot;Stop http server&quot;);</span>
      try {
<span class="fc" id="L156">        server.stop();</span>
<span class="nc" id="L157">      } catch (Exception e) {</span>
<span class="nc" id="L158">        logger.warn(&quot;Stop http server - failed {}&quot;, e.getMessage());</span>
<span class="fc" id="L159">      }</span>
    }
<span class="fc" id="L161">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>