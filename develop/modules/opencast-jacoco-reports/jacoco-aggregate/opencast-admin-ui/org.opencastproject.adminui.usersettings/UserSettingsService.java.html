<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>UserSettingsService.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-admin-ui</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.adminui.usersettings</a> &gt; <span class="el_source">UserSettingsService.java</span></div><h1>UserSettingsService.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.adminui.usersettings;

import static org.opencastproject.db.Queries.namedQuery;

import org.opencastproject.adminui.usersettings.persistence.UserSettingDto;
import org.opencastproject.adminui.usersettings.persistence.UserSettingsServiceException;
import org.opencastproject.db.DBSession;
import org.opencastproject.db.DBSessionFactory;
import org.opencastproject.security.api.OrganizationDirectoryService;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.UserDirectoryService;

import org.apache.commons.lang3.tuple.Pair;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.List;
import java.util.Optional;
import java.util.function.Function;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;

/**
 * Finds the user settings and message signatures from the current user.
 */
@Component(
  immediate = true,
  service = UserSettingsService.class,
  property = {
    &quot;service.description=Admin UI - Users Settings Service&quot;,
    &quot;opencast.service.type=org.opencastproject.adminui.usersettings.UserSettingsService&quot;
  }
)
<span class="fc" id="L60">public class UserSettingsService {</span>
  public static final String PERSISTENCE_UNIT = &quot;org.opencastproject.adminui&quot;;

  /** Logging utilities */
<span class="fc" id="L64">  private static final Logger logger = LoggerFactory.getLogger(UserSettingsService.class);</span>

  /** Factory used to create {@link EntityManager}s for transactions */
  protected EntityManagerFactory emf;

  protected DBSessionFactory dbSessionFactory;

  protected DBSession db;

  /** The user directory service */
  protected UserDirectoryService userDirectoryService;

  /** The organization directory service */
  protected OrganizationDirectoryService organizationDirectoryService;

  /** The security service */
  protected SecurityService securityService;

  /**
   * Creates {@link EntityManagerFactory} using persistence provider and properties passed via OSGi.
   *
   * @param cc
   */
  @Activate
  public void activate(ComponentContext cc) {
<span class="fc" id="L89">    logger.info(&quot;Activating persistence manager for user settings&quot;);</span>
<span class="fc" id="L90">    db = dbSessionFactory.createSession(emf);</span>
<span class="fc" id="L91">  }</span>

  /** OSGi DI */
  @Reference(target = &quot;(osgi.unit.name=org.opencastproject.adminui)&quot;)
  public void setEntityManagerFactory(EntityManagerFactory emf) {
<span class="fc" id="L96">    this.emf = emf;</span>
<span class="fc" id="L97">  }</span>

  @Reference
  public void setDBSessionFactory(DBSessionFactory dbSessionFactory) {
<span class="fc" id="L101">    this.dbSessionFactory = dbSessionFactory;</span>
<span class="fc" id="L102">  }</span>

  /**
   * OSGi callback to set user directory service.
   *
   * @param userDirectoryService
   *          user directory service
   */
  @Reference
  public void setUserDirectoryService(UserDirectoryService userDirectoryService) {
<span class="fc" id="L112">    this.userDirectoryService = userDirectoryService;</span>
<span class="fc" id="L113">  }</span>

  /**
   * OSGi callback to set the security service.
   *
   * @param securityService
   *          the security service
   */
  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="fc" id="L123">    this.securityService = securityService;</span>
<span class="fc" id="L124">  }</span>

  /**
   * OSGi callback to set the organization directory service.
   *
   * @param organizationDirectoryService
   *          the organization directory service
   */
  public void setOrganizationDirectoryService(OrganizationDirectoryService organizationDirectoryService) {
<span class="nc" id="L133">    this.organizationDirectoryService = organizationDirectoryService;</span>
<span class="nc" id="L134">  }</span>

  /**
   * Finds the user settings for the current user.
   *
   * @param limit
   *          The maximum limit of results to return.
   * @param offset
   *          The starting page offset.
   * @return The user settings for the current user.
   * @throws UserSettingsServiceException
   */
  public UserSettings findUserSettings(int limit, int offset) throws UserSettingsServiceException {
    try {
<span class="fc" id="L148">      UserSettings userSettings = db.exec(getUserSettingsQuery(limit, offset));</span>
<span class="fc" id="L149">      userSettings.setTotal(db.exec(getUserSettingsTotalQuery()));</span>
<span class="fc" id="L150">      userSettings.setLimit(limit);</span>
<span class="fc" id="L151">      userSettings.setOffset(offset);</span>
<span class="fc" id="L152">      return userSettings;</span>
<span class="nc" id="L153">    } catch (Exception e) {</span>
<span class="nc" id="L154">      logger.error(&quot;Could not get user settings:&quot;, e);</span>
<span class="nc" id="L155">      throw new UserSettingsServiceException(e);</span>
    }
  }

  /**
   * @return Function that finds the total number of user settings for the current user.
   */
  private Function&lt;EntityManager, Integer&gt; getUserSettingsTotalQuery() {
<span class="fc" id="L163">    String orgId = securityService.getOrganization().getId();</span>
<span class="fc" id="L164">    String username = securityService.getUser().getUsername();</span>
<span class="fc" id="L165">    return namedQuery.find(</span>
        &quot;UserSettings.countByUserName&quot;,
        Number.class,
<span class="fc" id="L168">        Pair.of(&quot;username&quot;, username),</span>
<span class="fc" id="L169">        Pair.of(&quot;org&quot;, orgId)</span>
<span class="fc" id="L170">    ).andThen(Number::intValue);</span>
  }

  /**
   * @param offset
   *          The number of limits to page to.
   * @param limit
   *          The maximum number of settings to return.
   * @return Function that finds all of the user settings for the current user.
   */
  private Function&lt;EntityManager, UserSettings&gt; getUserSettingsQuery(int limit, int offset) {
<span class="fc" id="L181">    return em -&gt; {</span>
<span class="fc" id="L182">      String orgId = securityService.getOrganization().getId();</span>
<span class="fc" id="L183">      String username = securityService.getUser().getUsername();</span>
<span class="fc" id="L184">      logger.debug(&quot;Getting user settings for '{}' in org '{}'&quot;, username, orgId);</span>

<span class="fc" id="L186">      List&lt;UserSettingDto&gt; result = em</span>
<span class="fc" id="L187">          .createNamedQuery(&quot;UserSettings.findByUserName&quot;, UserSettingDto.class)</span>
<span class="fc" id="L188">          .setParameter(&quot;username&quot;, username)</span>
<span class="fc" id="L189">          .setParameter(&quot;org&quot;, orgId)</span>
<span class="fc" id="L190">          .setMaxResults(limit)</span>
<span class="fc" id="L191">          .setFirstResult(offset)</span>
<span class="fc" id="L192">          .getResultList();</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">      if (result.size() == 0) {</span>
<span class="fc" id="L194">        logger.debug(&quot;Found no user settings.&quot;);</span>
      }

<span class="fc" id="L197">      UserSettings userSettings = new UserSettings();</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">      for (UserSettingDto userSettingsDto : result) {</span>
<span class="fc" id="L199">        UserSetting userSetting = userSettingsDto.toUserSetting();</span>
<span class="fc" id="L200">        logger.debug(&quot;Found user setting id: {} key: {} value: {}&quot;, userSetting.getId(), userSetting.getKey(),</span>
<span class="fc" id="L201">            userSetting.getValue());</span>
<span class="fc" id="L202">        userSettings.addUserSetting(userSetting);</span>
<span class="fc" id="L203">      }</span>
<span class="fc" id="L204">      return userSettings;</span>
    };
  }

  /**
   * Create a new user setting key value pair.
   *
   * @param key
   *          The key to use for the current user setting.
   * @param value
   *          The value of the user setting.
   * @return A new user setting object
   * @throws UserSettingsServiceException
   */
  public UserSetting addUserSetting(String key, String value) throws UserSettingsServiceException {
<span class="fc" id="L219">    String orgId = securityService.getOrganization().getId();</span>
<span class="fc" id="L220">    String username = securityService.getUser().getUsername();</span>
<span class="fc" id="L221">    Optional&lt;UserSettingDto&gt; userSettingOpt = db.exec(getUserSettingsByKeyQuery(key)).stream()</span>
<span class="fc" id="L222">        .filter(setting -&gt; setting.getKey().equalsIgnoreCase(key))</span>
<span class="fc" id="L223">        .findFirst();</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">    if (userSettingOpt.isPresent()) {</span>
      try {
<span class="fc" id="L226">        return db.execTx(em -&gt; {</span>
<span class="fc" id="L227">          UserSettingDto userSettingDto = userSettingOpt.get();</span>
<span class="fc" id="L228">          userSettingDto.setValue(value);</span>
<span class="fc" id="L229">          em.merge(userSettingDto);</span>
<span class="fc" id="L230">          return userSettingDto.toUserSetting();</span>
        });
<span class="nc" id="L232">      } catch (Exception e) {</span>
<span class="nc" id="L233">        throw new UserSettingsServiceException(e);</span>
      }
    } else {
      try {
<span class="fc" id="L237">        return db.execTx(em -&gt; {</span>
<span class="fc" id="L238">          UserSettingDto userSettingDto = new UserSettingDto();</span>
<span class="fc" id="L239">          userSettingDto.setKey(key);</span>
<span class="fc" id="L240">          userSettingDto.setValue(value);</span>
<span class="fc" id="L241">          userSettingDto.setUsername(username);</span>
<span class="fc" id="L242">          userSettingDto.setOrganization(orgId);</span>
<span class="fc" id="L243">          em.persist(userSettingDto);</span>
<span class="fc" id="L244">          return userSettingDto.toUserSetting();</span>
        });
<span class="nc" id="L246">      } catch (Exception e) {</span>

<span class="nc" id="L248">        throw new UserSettingsServiceException(e);</span>
      }
    }
  }

  /**
   * Get all user settings based upon its key.
   * @param key The key to search for.
   * @return A function returning {@link UserSettingDto} that matches the key.
   */
  private Function&lt;EntityManager, List&lt;UserSettingDto&gt;&gt; getUserSettingsByKeyQuery(String key) {
<span class="fc" id="L259">    String orgId = securityService.getOrganization().getId();</span>
<span class="fc" id="L260">    String username = securityService.getUser().getUsername();</span>
<span class="fc" id="L261">    logger.debug(&quot;Getting user settings for '{}' in org '{}'&quot;, username, orgId);</span>
<span class="fc" id="L262">    return namedQuery.findAll(</span>
        &quot;UserSettings.findByKey&quot;,
        UserSettingDto.class,
<span class="fc" id="L265">        Pair.of(&quot;key&quot;, key),</span>
<span class="fc" id="L266">        Pair.of(&quot;username&quot;, username),</span>
<span class="fc" id="L267">        Pair.of(&quot;org&quot;, orgId)</span>
    );
  }

  /**
   * Update a user setting that currently exists using its key to find it.
   * @param key The key for the user setting.
   * @param value The new value to set for the user setting.
   * @return An updated {@link UserSetting}
   * @throws UserSettingsServiceException
   */
  public UserSetting updateUserSetting(String key, String value, String oldValue) throws UserSettingsServiceException {
    try {
<span class="fc" id="L280">      UserSettingDto userSettingDto = db.exec(getUserSettingsByKeyQuery(key)).stream()</span>
<span class="pc bpc" id="L281" title="2 of 4 branches missed.">          .filter(setting -&gt; setting.getKey().equalsIgnoreCase(key) &amp;&amp; setting.getValue().equalsIgnoreCase(oldValue))</span>
<span class="fc" id="L282">          .findFirst()</span>
<span class="pc" id="L283">          .orElseThrow(() -&gt; new UserSettingsServiceException(&quot;Unable to find user setting with key &quot; + key + &quot; value &quot;</span>
              + value + &quot; and old value &quot; + oldValue));

<span class="fc" id="L286">      return updateUserSetting(userSettingDto.getId(), key, value);</span>
<span class="nc" id="L287">    } catch (Exception e) {</span>
<span class="nc" id="L288">      logger.error(&quot;Could not update user setting&quot;, e);</span>
<span class="nc" id="L289">      throw new UserSettingsServiceException(e);</span>
    }
  }

  /**
   * Update a user setting that currently exists using its unique id to find it.
   * @param id The id for the user setting.
   * @param key The key for the user setting.
   * @param value The value for the user setting.
   * @return The updated {@link UserSetting}.
   * @throws UserSettingsServiceException
   */
  public UserSetting updateUserSetting(long id, String key, String value) throws UserSettingsServiceException {
<span class="fc" id="L302">    String orgId = securityService.getOrganization().getId();</span>
<span class="fc" id="L303">    String username = securityService.getUser().getUsername();</span>
<span class="fc" id="L304">    logger.debug(&quot;Updating user setting id: {} key: {} value: {}&quot;, id, key, value);</span>

    try {
<span class="fc" id="L307">      return db.execTx(em -&gt; {</span>
<span class="fc" id="L308">        UserSettingDto userSettingDto = em.find(UserSettingDto.class, id);</span>
<span class="fc" id="L309">        userSettingDto.setKey(key);</span>
<span class="fc" id="L310">        userSettingDto.setValue(value);</span>
<span class="fc" id="L311">        em.persist(userSettingDto);</span>
<span class="fc" id="L312">        return userSettingDto.toUserSetting();</span>
      });
<span class="nc" id="L314">    } catch (Exception e) {</span>
<span class="nc" id="L315">      logger.error(&quot;Could not update user setting username '{}' org: '{}' id: '{}' key: '{}' value: '{}'&quot;,</span>
<span class="nc" id="L316">        username, orgId, id, key, value, e);</span>
<span class="nc" id="L317">      throw new UserSettingsServiceException(e);</span>
    }
  }

  /**
   * Delete a user setting by using a unique id to find it.
   *
   * @param id
   *          The unique id for the user setting.
   * @throws UserSettingsServiceException
   */
  public void deleteUserSetting(long id) throws UserSettingsServiceException {
    try {
<span class="fc" id="L330">      db.execTx(em -&gt; {</span>
<span class="fc" id="L331">        UserSettingDto userSettingsDto = em.find(UserSettingDto.class, id);</span>
<span class="fc" id="L332">        em.remove(userSettingsDto);</span>
<span class="fc" id="L333">      });</span>
<span class="nc" id="L334">    } catch (Exception e) {</span>
<span class="nc" id="L335">      logger.error(&quot;Could not delete user setting '{}'&quot;, id, e);</span>
<span class="nc" id="L336">      throw new UserSettingsServiceException(e);</span>
<span class="fc" id="L337">    }</span>
<span class="fc" id="L338">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>