<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ThemesEndpoint.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-admin-ui</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.adminui.endpoint</a> &gt; <span class="el_source">ThemesEndpoint.java</span></div><h1>ThemesEndpoint.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.adminui.endpoint;

import static javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;
import static javax.servlet.http.HttpServletResponse.SC_NOT_FOUND;
import static javax.servlet.http.HttpServletResponse.SC_NO_CONTENT;
import static javax.servlet.http.HttpServletResponse.SC_OK;
import static javax.servlet.http.HttpServletResponse.SC_UNAUTHORIZED;
import static org.apache.commons.lang3.StringUtils.isNotBlank;
import static org.apache.commons.lang3.StringUtils.trimToNull;
import static org.opencastproject.index.service.util.JSONUtils.safeString;
import static org.opencastproject.index.service.util.RestUtils.notFound;
import static org.opencastproject.index.service.util.RestUtils.okJson;
import static org.opencastproject.index.service.util.RestUtils.okJsonList;
import static org.opencastproject.util.doc.rest.RestParameter.Type.STRING;

import org.opencastproject.elasticsearch.api.SearchIndexException;
import org.opencastproject.elasticsearch.api.SearchResult;
import org.opencastproject.elasticsearch.api.SearchResultItem;
import org.opencastproject.elasticsearch.index.ElasticsearchIndex;
import org.opencastproject.elasticsearch.index.objects.series.Series;
import org.opencastproject.elasticsearch.index.objects.series.SeriesSearchQuery;
import org.opencastproject.index.service.resources.list.query.ThemesListQuery;
import org.opencastproject.index.service.util.RestUtils;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.UnauthorizedException;
import org.opencastproject.security.api.User;
import org.opencastproject.series.api.SeriesException;
import org.opencastproject.series.api.SeriesService;
import org.opencastproject.staticfiles.api.StaticFileService;
import org.opencastproject.staticfiles.endpoint.StaticFileRestService;
import org.opencastproject.themes.Theme;
import org.opencastproject.themes.ThemesServiceDatabase;
import org.opencastproject.themes.persistence.ThemesServiceDatabaseException;
import org.opencastproject.util.DateTimeSupport;
import org.opencastproject.util.EqualsUtil;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.RestUtil;
import org.opencastproject.util.RestUtil.R;
import org.opencastproject.util.data.Option;
import org.opencastproject.util.doc.rest.RestParameter;
import org.opencastproject.util.doc.rest.RestParameter.Type;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestResponse;
import org.opencastproject.util.doc.rest.RestService;
import org.opencastproject.util.requests.SortCriterion;

import com.google.gson.JsonArray;
import com.google.gson.JsonObject;

import org.apache.commons.lang3.BooleanUtils;
import org.apache.commons.lang3.StringUtils;
import org.osgi.framework.BundleContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.jaxrs.whiteboard.propertytypes.JaxrsResource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Optional;

import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.DELETE;
import javax.ws.rs.FormParam;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.PUT;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.WebApplicationException;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.Response.Status;

@Path(&quot;/admin-ng/themes&quot;)
@RestService(name = &quot;themes&quot;, title = &quot;Themes facade service&quot;,
  abstractText = &quot;Provides operations for the themes&quot;,
  notes = { &quot;This service offers the default themes CRUD Operations for the admin UI.&quot;,
            &quot;&lt;strong&gt;Important:&lt;/strong&gt; &quot;
              + &quot;&lt;em&gt;This service is for exclusive use by the module admin-ui. Its API might change &quot;
              + &quot;anytime without prior notice. Any dependencies other than the admin UI will be strictly ignored. &quot;
              + &quot;DO NOT use this for integration of third-party applications.&lt;em&gt;&quot;})
@Component(
        immediate = true,
        service = ThemesEndpoint.class,
        property = {
                &quot;service.description=Admin UI - Themes Endpoint&quot;,
                &quot;opencast.service.type=org.opencastproject.adminui.ThemesEndpoint&quot;,
                &quot;opencast.service.path=/admin-ng/themes&quot;,
        }
)
@JaxrsResource
<span class="fc" id="L121">public class ThemesEndpoint {</span>

  /** The logging facility */
<span class="fc" id="L124">  private static final Logger logger = LoggerFactory.getLogger(ThemesEndpoint.class);</span>

  /** The themes service database */
  private ThemesServiceDatabase themesServiceDatabase;

  /** The security service */
  private SecurityService securityService;

  /** The admin UI search index */
  private ElasticsearchIndex searchIndex;

  /** The series service */
  private SeriesService seriesService;

  /** The static file service */
  private StaticFileService staticFileService;

  /** The static file REST service */
  private StaticFileRestService staticFileRestService;

  /** OSGi callback for the themes service database. */
  @Reference
  public void setThemesServiceDatabase(ThemesServiceDatabase themesServiceDatabase) {
<span class="fc" id="L147">    this.themesServiceDatabase = themesServiceDatabase;</span>
<span class="fc" id="L148">  }</span>

  /** OSGi callback for the security service. */
  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="fc" id="L153">    this.securityService = securityService;</span>
<span class="fc" id="L154">  }</span>

  /** OSGi DI. */
  @Reference
  public void setIndex(ElasticsearchIndex index) {
<span class="fc" id="L159">    this.searchIndex = index;</span>
<span class="fc" id="L160">  }</span>

  /** OSGi DI. */
  @Reference
  public void setSeriesService(SeriesService seriesService) {
<span class="fc" id="L165">    this.seriesService = seriesService;</span>
<span class="fc" id="L166">  }</span>

  /** OSGi DI. */
  @Reference
  public void setStaticFileService(StaticFileService staticFileService) {
<span class="fc" id="L171">    this.staticFileService = staticFileService;</span>
<span class="fc" id="L172">  }</span>

  /** OSGi DI. */
  @Reference
  public void setStaticFileRestService(StaticFileRestService staticFileRestService) {
<span class="fc" id="L177">    this.staticFileRestService = staticFileRestService;</span>
<span class="fc" id="L178">  }</span>

  @Activate
  public void activate(BundleContext bundleContext) {
<span class="nc" id="L182">    logger.info(&quot;Activate themes endpoint&quot;);</span>
<span class="nc" id="L183">  }</span>

  @GET
  @Produces({ MediaType.APPLICATION_JSON })
  @Path(&quot;themes.json&quot;)
  @RestQuery(name = &quot;getThemes&quot;, description = &quot;Return all of the known themes on the system&quot;, restParameters = {
          @RestParameter(name = &quot;filter&quot;, isRequired = false, description = &quot;The filter used for the query. They should be formated like that: 'filter1:value1,filter2:value2'&quot;, type = STRING),
          @RestParameter(defaultValue = &quot;0&quot;, description = &quot;The maximum number of items to return per page.&quot;, isRequired = false, name = &quot;limit&quot;, type = RestParameter.Type.INTEGER),
          @RestParameter(defaultValue = &quot;0&quot;, description = &quot;The page number.&quot;, isRequired = false, name = &quot;offset&quot;, type = RestParameter.Type.INTEGER),
          @RestParameter(name = &quot;sort&quot;, isRequired = false, description = &quot;The sort order. May include any of the following: NAME, CREATOR.  Add '_DESC' to reverse the sort order (e.g. CREATOR_DESC).&quot;, type = STRING) }, responses = { @RestResponse(description = &quot;A JSON representation of the themes&quot;, responseCode = HttpServletResponse.SC_OK) }, returnDescription = &quot;&quot;)
  public Response getThemes(@QueryParam(&quot;filter&quot;) String filter, @QueryParam(&quot;limit&quot;) int limit,
          @QueryParam(&quot;offset&quot;) int offset, @QueryParam(&quot;sort&quot;) String sort) {
<span class="fc" id="L195">    Optional&lt;Integer&gt; optLimit = Optional.ofNullable(limit);</span>
<span class="fc" id="L196">    Optional&lt;Integer&gt; optOffset = Optional.ofNullable(offset);</span>
<span class="fc" id="L197">    Optional&lt;String&gt; optSort = Optional.ofNullable(trimToNull(sort));</span>

<span class="fc" id="L199">    Map&lt;String, String&gt; filters = RestUtils.parseFilter(filter);</span>

    ArrayList&lt;SortCriterion&gt; sortCriteria;
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">    if (optSort.isPresent()) {</span>
<span class="nc" id="L203">      sortCriteria = RestUtils.parseSortQueryParameter(optSort.get());</span>
    } else {
<span class="fc" id="L205">      sortCriteria = new ArrayList&lt;&gt;();</span>
    }
<span class="fc" id="L207">    Optional&lt;String&gt; optCreatorFilter = Optional.ofNullable(filters.get(ThemesListQuery.FILTER_CREATOR_NAME));</span>
<span class="fc" id="L208">    Optional&lt;String&gt; optTextFilter = Optional.ofNullable(filters.get(ThemesListQuery.FILTER_TEXT_NAME));</span>

<span class="fc" id="L210">    List&lt;Theme&gt; results = null;</span>
    int total;
    try {
<span class="fc" id="L213">      results = themesServiceDatabase.findThemes(</span>
          optLimit,
          optOffset,
          sortCriteria,
          optCreatorFilter,
          optTextFilter
      );
<span class="fc" id="L220">      total = themesServiceDatabase.countThemes();</span>
<span class="nc" id="L221">    } catch (Exception e) {</span>
<span class="nc" id="L222">      logger.error(&quot;Could not get themes from the database:&quot;, e);</span>
<span class="nc" id="L223">      return RestUtil.R.serverError();</span>
<span class="fc" id="L224">    }</span>


<span class="fc" id="L227">    List&lt;JsonObject&gt; themesJSON = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L228" title="All 2 branches covered.">    for (Theme theme : results) {</span>
<span class="fc" id="L229">      themesJSON.add(themeToJSON(theme, false));</span>
<span class="fc" id="L230">    }</span>

<span class="fc" id="L232">    return okJsonList(</span>
        themesJSON,
<span class="fc" id="L234">        Optional.ofNullable(offset).orElse(0),</span>
<span class="fc" id="L235">        Optional.ofNullable(limit).orElse(0),</span>
        total
    );
  }

  @GET
  @Path(&quot;{themeId}.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;getTheme&quot;, description = &quot;Returns the theme by the given id as JSON&quot;, returnDescription = &quot;The theme as JSON&quot;, pathParameters = { @RestParameter(name = &quot;themeId&quot;, description = &quot;The theme id&quot;, isRequired = true, type = RestParameter.Type.INTEGER) }, responses = {
          @RestResponse(description = &quot;Returns the theme as JSON&quot;, responseCode = HttpServletResponse.SC_OK),
          @RestResponse(description = &quot;No theme with this identifier was found.&quot;, responseCode = HttpServletResponse.SC_NOT_FOUND) })
  public Response getThemeResponse(@PathParam(&quot;themeId&quot;) long id) {
    try {
<span class="fc" id="L248">      Theme theme = themesServiceDatabase.getTheme(id);</span>

<span class="fc" id="L250">      return okJson(themeToJSON(theme, true));</span>
<span class="nc" id="L251">    } catch (ThemesServiceDatabaseException e) {</span>
<span class="nc" id="L252">      return RestUtil.R.serverError();</span>
<span class="fc" id="L253">    } catch (NotFoundException e) {</span>
<span class="fc" id="L254">      return notFound(&quot;Cannot find a theme with id '%s'&quot;, id);</span>
    }
  }

  @GET
  @Path(&quot;{themeId}/usage.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;getThemeUsage&quot;, description = &quot;Returns the theme usage by the given id as JSON&quot;, returnDescription = &quot;The theme usage as JSON&quot;, pathParameters = { @RestParameter(name = &quot;themeId&quot;, description = &quot;The theme id&quot;, isRequired = true, type = RestParameter.Type.INTEGER) }, responses = {
          @RestResponse(description = &quot;Returns the theme usage as JSON&quot;, responseCode = HttpServletResponse.SC_OK),
          @RestResponse(description = &quot;Theme with the given id does not exist&quot;, responseCode = HttpServletResponse.SC_NOT_FOUND) })
  public Response getThemeUsage(@PathParam(&quot;themeId&quot;) long themeId) {
    try {
<span class="fc" id="L266">      themesServiceDatabase.getTheme(themeId);</span>

<span class="fc" id="L268">      SeriesSearchQuery query = new SeriesSearchQuery(securityService.getOrganization().getId(),</span>
<span class="fc" id="L269">              securityService.getUser()).withTheme(themeId);</span>
<span class="fc" id="L270">      SearchResult&lt;Series&gt; results = null;</span>
      try {
<span class="fc" id="L272">        results = searchIndex.getByQuery(query);</span>
<span class="nc" id="L273">      } catch (SearchIndexException e) {</span>
<span class="nc" id="L274">        logger.error(&quot;The admin UI Search Index was not able to get the series with theme '{}':&quot;, themeId,</span>
                e);
<span class="nc" id="L276">        return RestUtil.R.serverError();</span>
<span class="fc" id="L277">      }</span>
<span class="fc" id="L278">      JsonArray seriesValues = new JsonArray();</span>
<span class="fc bfc" id="L279" title="All 2 branches covered.">      for (SearchResultItem&lt;Series&gt; item : results.getItems()) {</span>
<span class="fc" id="L280">        Series series = item.getSource();</span>
<span class="fc" id="L281">        JsonObject seriesJson = new JsonObject();</span>
<span class="fc" id="L282">        seriesJson.addProperty(&quot;id&quot;, series.getIdentifier());</span>
<span class="fc" id="L283">        seriesJson.addProperty(&quot;title&quot;, series.getTitle());</span>
<span class="fc" id="L284">        seriesValues.add(seriesJson);</span>
      }
<span class="fc" id="L286">      JsonObject responseJson = new JsonObject();</span>
<span class="fc" id="L287">      responseJson.add(&quot;series&quot;, seriesValues);</span>

<span class="fc" id="L289">      return okJson(responseJson);</span>
<span class="nc" id="L290">    } catch (ThemesServiceDatabaseException e) {</span>
<span class="nc" id="L291">      return RestUtil.R.serverError();</span>
<span class="fc" id="L292">    } catch (NotFoundException e) {</span>
<span class="fc" id="L293">      return notFound(&quot;Cannot find a theme with id {}&quot;, themeId);</span>
    }
  }

  @POST
  @Path(&quot;&quot;)
  @RestQuery(name = &quot;createTheme&quot;, description = &quot;Add a theme&quot;, returnDescription = &quot;Return the created theme&quot;, restParameters = {
          @RestParameter(name = &quot;default&quot;, description = &quot;Whether the theme is default&quot;, isRequired = true, type = Type.BOOLEAN),
          @RestParameter(name = &quot;name&quot;, description = &quot;The theme name&quot;, isRequired = true, type = Type.STRING),
          @RestParameter(name = &quot;description&quot;, description = &quot;The theme description&quot;, isRequired = false, type = Type.TEXT),
          @RestParameter(name = &quot;bumperActive&quot;, description = &quot;Whether the theme bumper is active&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;trailerActive&quot;, description = &quot;Whether the theme trailer is active&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;titleSlideActive&quot;, description = &quot;Whether the theme title slide is active&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;licenseSlideActive&quot;, description = &quot;Whether the theme license slide is active&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;watermarkActive&quot;, description = &quot;Whether the theme watermark is active&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;bumperFile&quot;, description = &quot;The theme bumper file&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;trailerFile&quot;, description = &quot;The theme trailer file&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;watermarkFile&quot;, description = &quot;The theme watermark file&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;titleSlideBackground&quot;, description = &quot;The theme title slide background file&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;licenseSlideBackground&quot;, description = &quot;The theme license slide background file&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;titleSlideMetadata&quot;, description = &quot;The theme title slide metadata&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;licenseSlideDescription&quot;, description = &quot;The theme license slide description&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;watermarkPosition&quot;, description = &quot;The theme watermark position&quot;, isRequired = false, type = Type.STRING), }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Theme created&quot;),
          @RestResponse(responseCode = SC_BAD_REQUEST, description = &quot;The theme references a non-existing file&quot;) })
  public Response createTheme(@FormParam(&quot;default&quot;) boolean isDefault, @FormParam(&quot;name&quot;) String name,
          @FormParam(&quot;description&quot;) String description, @FormParam(&quot;bumperActive&quot;) Boolean bumperActive,
          @FormParam(&quot;trailerActive&quot;) Boolean trailerActive, @FormParam(&quot;titleSlideActive&quot;) Boolean titleSlideActive,
          @FormParam(&quot;licenseSlideActive&quot;) Boolean licenseSlideActive,
          @FormParam(&quot;watermarkActive&quot;) Boolean watermarkActive, @FormParam(&quot;bumperFile&quot;) String bumperFile,
          @FormParam(&quot;trailerFile&quot;) String trailerFile, @FormParam(&quot;watermarkFile&quot;) String watermarkFile,
          @FormParam(&quot;titleSlideBackground&quot;) String titleSlideBackground,
          @FormParam(&quot;licenseSlideBackground&quot;) String licenseSlideBackground,
          @FormParam(&quot;titleSlideMetadata&quot;) String titleSlideMetadata,
          @FormParam(&quot;licenseSlideDescription&quot;) String licenseSlideDescription,
          @FormParam(&quot;watermarkPosition&quot;) String watermarkPosition) {
<span class="fc" id="L329">    User creator = securityService.getUser();</span>

<span class="fc" id="L331">    Theme theme = new Theme(Option.&lt;Long&gt; none(), new Date(), isDefault, creator, name,</span>
<span class="fc" id="L332">            StringUtils.trimToNull(description), BooleanUtils.toBoolean(bumperActive),</span>
<span class="fc" id="L333">            StringUtils.trimToNull(bumperFile), BooleanUtils.toBoolean(trailerActive),</span>
<span class="fc" id="L334">            StringUtils.trimToNull(trailerFile), BooleanUtils.toBoolean(titleSlideActive),</span>
<span class="fc" id="L335">            StringUtils.trimToNull(titleSlideMetadata), StringUtils.trimToNull(titleSlideBackground),</span>
<span class="fc" id="L336">            BooleanUtils.toBoolean(licenseSlideActive), StringUtils.trimToNull(licenseSlideBackground),</span>
<span class="fc" id="L337">            StringUtils.trimToNull(licenseSlideDescription), BooleanUtils.toBoolean(watermarkActive),</span>
<span class="fc" id="L338">            StringUtils.trimToNull(watermarkFile), StringUtils.trimToNull(watermarkPosition));</span>

    try {
<span class="fc" id="L341">      persistReferencedFiles(theme);</span>
<span class="nc" id="L342">    } catch (NotFoundException e) {</span>
<span class="nc" id="L343">      logger.warn(&quot;A file that is referenced in theme '{}' was not found: {}&quot;, theme, e.getMessage());</span>
<span class="nc" id="L344">      return R.badRequest(&quot;Referenced non-existing file&quot;);</span>
<span class="nc" id="L345">    } catch (IOException e) {</span>
<span class="nc" id="L346">      logger.warn(&quot;Error while persisting file: {}&quot;, e.getMessage());</span>
<span class="nc" id="L347">      return R.serverError();</span>
<span class="fc" id="L348">    }</span>

    try {
<span class="fc" id="L351">      Theme createdTheme = themesServiceDatabase.updateTheme(theme);</span>
<span class="fc" id="L352">      return RestUtils.okJson(themeToJSON(createdTheme,false));</span>
<span class="nc" id="L353">    } catch (ThemesServiceDatabaseException e) {</span>
<span class="nc" id="L354">      logger.error(&quot;Unable to create a theme&quot;);</span>
<span class="nc" id="L355">      return RestUtil.R.serverError();</span>
    }
  }

  @PUT
  @Path(&quot;{themeId}&quot;)
  @RestQuery(name = &quot;updateTheme&quot;, description = &quot;Updates a theme&quot;, returnDescription = &quot;Return the updated theme&quot;, pathParameters = { @RestParameter(name = &quot;themeId&quot;, description = &quot;The theme identifier&quot;, isRequired = true, type = Type.INTEGER) }, restParameters = {
          @RestParameter(name = &quot;default&quot;, description = &quot;Whether the theme is default&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;name&quot;, description = &quot;The theme name&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;description&quot;, description = &quot;The theme description&quot;, isRequired = false, type = Type.TEXT),
          @RestParameter(name = &quot;bumperActive&quot;, description = &quot;Whether the theme bumper is active&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;trailerActive&quot;, description = &quot;Whether the theme trailer is active&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;titleSlideActive&quot;, description = &quot;Whether the theme title slide is active&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;licenseSlideActive&quot;, description = &quot;Whether the theme license slide is active&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;watermarkActive&quot;, description = &quot;Whether the theme watermark is active&quot;, isRequired = false, type = Type.BOOLEAN),
          @RestParameter(name = &quot;bumperFile&quot;, description = &quot;The theme bumper file&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;trailerFile&quot;, description = &quot;The theme trailer file&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;watermarkFile&quot;, description = &quot;The theme watermark file&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;titleSlideBackground&quot;, description = &quot;The theme title slide background file&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;licenseSlideBackground&quot;, description = &quot;The theme license slide background file&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;titleSlideMetadata&quot;, description = &quot;The theme title slide metadata&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;licenseSlideDescription&quot;, description = &quot;The theme license slide description&quot;, isRequired = false, type = Type.STRING),
          @RestParameter(name = &quot;watermarkPosition&quot;, description = &quot;The theme watermark position&quot;, isRequired = false, type = Type.STRING), }, responses = {
          @RestResponse(responseCode = SC_OK, description = &quot;Theme updated&quot;),
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;If the theme has not been found.&quot;), })
  public Response updateTheme(@PathParam(&quot;themeId&quot;) long themeId, @FormParam(&quot;default&quot;) Boolean isDefault,
          @FormParam(&quot;name&quot;) String name, @FormParam(&quot;description&quot;) String description,
          @FormParam(&quot;bumperActive&quot;) Boolean bumperActive, @FormParam(&quot;trailerActive&quot;) Boolean trailerActive,
          @FormParam(&quot;titleSlideActive&quot;) Boolean titleSlideActive,
          @FormParam(&quot;licenseSlideActive&quot;) Boolean licenseSlideActive,
          @FormParam(&quot;watermarkActive&quot;) Boolean watermarkActive, @FormParam(&quot;bumperFile&quot;) String bumperFile,
          @FormParam(&quot;trailerFile&quot;) String trailerFile, @FormParam(&quot;watermarkFile&quot;) String watermarkFile,
          @FormParam(&quot;titleSlideBackground&quot;) String titleSlideBackground,
          @FormParam(&quot;licenseSlideBackground&quot;) String licenseSlideBackground,
          @FormParam(&quot;titleSlideMetadata&quot;) String titleSlideMetadata,
          @FormParam(&quot;licenseSlideDescription&quot;) String licenseSlideDescription,
          @FormParam(&quot;watermarkPosition&quot;) String watermarkPosition) throws NotFoundException {
    try {
<span class="fc" id="L393">      Theme origTheme = themesServiceDatabase.getTheme(themeId);</span>

<span class="pc bpc" id="L395" title="1 of 2 branches missed.">      if (isDefault == null)</span>
<span class="nc" id="L396">        isDefault = origTheme.isDefault();</span>
<span class="pc bpc" id="L397" title="1 of 2 branches missed.">      if (StringUtils.isBlank(name))</span>
<span class="nc" id="L398">        name = origTheme.getName();</span>
<span class="pc bpc" id="L399" title="1 of 2 branches missed.">      if (StringUtils.isEmpty(description))</span>
<span class="nc" id="L400">        description = origTheme.getDescription();</span>
<span class="pc bpc" id="L401" title="1 of 2 branches missed.">      if (bumperActive == null)</span>
<span class="nc" id="L402">        bumperActive = origTheme.isBumperActive();</span>
<span class="pc bpc" id="L403" title="1 of 2 branches missed.">      if (StringUtils.isEmpty(bumperFile))</span>
<span class="nc" id="L404">        bumperFile = origTheme.getBumperFile();</span>
<span class="pc bpc" id="L405" title="1 of 2 branches missed.">      if (trailerActive == null)</span>
<span class="nc" id="L406">        trailerActive = origTheme.isTrailerActive();</span>
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">      if (StringUtils.isEmpty(trailerFile))</span>
<span class="nc" id="L408">        trailerFile = origTheme.getTrailerFile();</span>
<span class="pc bpc" id="L409" title="1 of 2 branches missed.">      if (titleSlideActive == null)</span>
<span class="nc" id="L410">        titleSlideActive = origTheme.isTitleSlideActive();</span>
<span class="pc bpc" id="L411" title="1 of 2 branches missed.">      if (StringUtils.isEmpty(titleSlideMetadata))</span>
<span class="nc" id="L412">        titleSlideMetadata = origTheme.getTitleSlideMetadata();</span>
<span class="pc bpc" id="L413" title="1 of 2 branches missed.">      if (StringUtils.isEmpty(titleSlideBackground))</span>
<span class="nc" id="L414">        titleSlideBackground = origTheme.getTitleSlideBackground();</span>
<span class="pc bpc" id="L415" title="1 of 2 branches missed.">      if (licenseSlideActive == null)</span>
<span class="nc" id="L416">        licenseSlideActive = origTheme.isLicenseSlideActive();</span>
<span class="pc bpc" id="L417" title="1 of 2 branches missed.">      if (StringUtils.isEmpty(licenseSlideBackground))</span>
<span class="nc" id="L418">        licenseSlideBackground = origTheme.getLicenseSlideBackground();</span>
<span class="pc bpc" id="L419" title="1 of 2 branches missed.">      if (StringUtils.isEmpty(licenseSlideDescription))</span>
<span class="nc" id="L420">        licenseSlideDescription = origTheme.getLicenseSlideDescription();</span>
<span class="pc bpc" id="L421" title="1 of 2 branches missed.">      if (watermarkActive == null)</span>
<span class="nc" id="L422">        watermarkActive = origTheme.isWatermarkActive();</span>
<span class="pc bpc" id="L423" title="1 of 2 branches missed.">      if (StringUtils.isEmpty(watermarkFile))</span>
<span class="nc" id="L424">        watermarkFile = origTheme.getWatermarkFile();</span>
<span class="pc bpc" id="L425" title="1 of 2 branches missed.">      if (StringUtils.isEmpty(watermarkPosition))</span>
<span class="nc" id="L426">        watermarkPosition = origTheme.getWatermarkPosition();</span>

<span class="fc" id="L428">      Theme theme = new Theme(origTheme.getId(), origTheme.getCreationDate(), isDefault, origTheme.getCreator(), name,</span>
<span class="fc" id="L429">              StringUtils.trimToNull(description), BooleanUtils.toBoolean(bumperActive),</span>
<span class="fc" id="L430">              StringUtils.trimToNull(bumperFile), BooleanUtils.toBoolean(trailerActive),</span>
<span class="fc" id="L431">              StringUtils.trimToNull(trailerFile), BooleanUtils.toBoolean(titleSlideActive),</span>
<span class="fc" id="L432">              StringUtils.trimToNull(titleSlideMetadata), StringUtils.trimToNull(titleSlideBackground),</span>
<span class="fc" id="L433">              BooleanUtils.toBoolean(licenseSlideActive), StringUtils.trimToNull(licenseSlideBackground),</span>
<span class="fc" id="L434">              StringUtils.trimToNull(licenseSlideDescription), BooleanUtils.toBoolean(watermarkActive),</span>
<span class="fc" id="L435">              StringUtils.trimToNull(watermarkFile), StringUtils.trimToNull(watermarkPosition));</span>

      try {
<span class="fc" id="L438">        updateReferencedFiles(origTheme, theme);</span>
<span class="nc" id="L439">      } catch (IOException e) {</span>
<span class="nc" id="L440">        logger.warn(&quot;Error while persisting file: {}&quot;, e.getMessage());</span>
<span class="nc" id="L441">        return R.serverError();</span>
<span class="nc" id="L442">      } catch (NotFoundException e) {</span>
<span class="nc" id="L443">        logger.warn(&quot;A file that is referenced in theme '{}' was not found: {}&quot;, theme, e.getMessage());</span>
<span class="nc" id="L444">        return R.badRequest(&quot;Referenced non-existing file&quot;);</span>
<span class="fc" id="L445">      }</span>

<span class="fc" id="L447">      Theme updatedTheme = themesServiceDatabase.updateTheme(theme);</span>
<span class="fc" id="L448">      return RestUtils.okJson(themeToJSON(updatedTheme, false));</span>
<span class="nc" id="L449">    } catch (ThemesServiceDatabaseException e) {</span>
<span class="nc" id="L450">      logger.error(&quot;Unable to update theme {}&quot;, themeId, e);</span>
<span class="nc" id="L451">      return RestUtil.R.serverError();</span>
    }
  }

  @DELETE
  @Path(&quot;{themeId}&quot;)
  @RestQuery(name = &quot;deleteTheme&quot;, description = &quot;Deletes a theme&quot;, returnDescription = &quot;The method doesn't return any content&quot;, pathParameters = { @RestParameter(name = &quot;themeId&quot;, isRequired = true, description = &quot;The theme identifier&quot;, type = RestParameter.Type.INTEGER) }, responses = {
          @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;If the theme has not been found.&quot;),
          @RestResponse(responseCode = SC_NO_CONTENT, description = &quot;The method does not return any content&quot;),
          @RestResponse(responseCode = SC_UNAUTHORIZED, description = &quot;If the current user is not authorized to perform this action&quot;) })
  public Response deleteTheme(@PathParam(&quot;themeId&quot;) long themeId) throws NotFoundException, UnauthorizedException {
    try {
<span class="fc" id="L463">      Theme theme = themesServiceDatabase.getTheme(themeId);</span>
      try {
<span class="fc" id="L465">        deleteReferencedFiles(theme);</span>
<span class="nc" id="L466">      } catch (IOException e) {</span>
<span class="nc" id="L467">        logger.warn(&quot;Error while deleting referenced file: {}&quot;, e.getMessage());</span>
<span class="nc" id="L468">        return R.serverError();</span>
<span class="fc" id="L469">      }</span>

<span class="fc" id="L471">      themesServiceDatabase.deleteTheme(themeId);</span>
<span class="fc" id="L472">      deleteThemeOnSeries(themeId);</span>

<span class="fc" id="L474">      return RestUtil.R.noContent();</span>
<span class="fc" id="L475">    } catch (NotFoundException e) {</span>
<span class="fc" id="L476">      logger.warn(&quot;Unable to find a theme with id &quot; + themeId);</span>
<span class="fc" id="L477">      throw e;</span>
<span class="nc" id="L478">    } catch (ThemesServiceDatabaseException e) {</span>
<span class="nc" id="L479">      logger.error(&quot;Error getting theme {} during delete operation because:&quot;, themeId,</span>
              e);
<span class="nc" id="L481">      return RestUtil.R.serverError();</span>
    }
  }

  /**
   * Deletes all related series theme entries
   *
   * @param themeId
   *          the theme id
   */
  private void deleteThemeOnSeries(long themeId) throws UnauthorizedException {
<span class="fc" id="L492">    SeriesSearchQuery query = new SeriesSearchQuery(securityService.getOrganization().getId(),</span>
<span class="fc" id="L493">            securityService.getUser()).withTheme(themeId);</span>
<span class="fc" id="L494">    SearchResult&lt;Series&gt; results = null;</span>
    try {
<span class="fc" id="L496">      results = searchIndex.getByQuery(query);</span>
<span class="nc" id="L497">    } catch (SearchIndexException e) {</span>
<span class="nc" id="L498">      logger.error(&quot;The admin UI Search Index was not able to get the series with theme '{}':&quot;, themeId, e);</span>
<span class="nc" id="L499">      throw new WebApplicationException(e, Status.INTERNAL_SERVER_ERROR);</span>
<span class="fc" id="L500">    }</span>
<span class="fc bfc" id="L501" title="All 2 branches covered.">    for (SearchResultItem&lt;Series&gt; item : results.getItems()) {</span>
<span class="fc" id="L502">      String seriesId = item.getSource().getIdentifier();</span>
      try {
<span class="fc" id="L504">        seriesService.deleteSeriesProperty(seriesId, SeriesEndpoint.THEME_KEY);</span>
<span class="nc" id="L505">      } catch (NotFoundException e) {</span>
<span class="nc" id="L506">        logger.warn(&quot;Theme {} already deleted on series {}&quot;, themeId, seriesId);</span>
<span class="nc" id="L507">      } catch (SeriesException e) {</span>
<span class="nc" id="L508">        logger.error(&quot;Unable to remove theme from series {}&quot;, seriesId, e);</span>
<span class="nc" id="L509">        throw new WebApplicationException(e, Status.INTERNAL_SERVER_ERROR);</span>
<span class="pc" id="L510">      }</span>
    }
<span class="fc" id="L512">  }</span>

  private void extendStaticFileInfo(String fieldName, String staticFileId, JsonObject json) {
<span class="pc bpc" id="L515" title="1 of 2 branches missed.">    if (StringUtils.isNotBlank(staticFileId)) {</span>
      try {
<span class="fc" id="L517">        String fileName = staticFileService.getFileName(staticFileId);</span>
<span class="fc" id="L518">        String fileUrl = staticFileRestService.getStaticFileURL(staticFileId).toString();</span>

<span class="fc" id="L520">        json.addProperty(fieldName + &quot;Name&quot;, fileName);</span>
<span class="fc" id="L521">        json.addProperty(fieldName + &quot;Url&quot;, safeString(fileUrl));</span>
<span class="nc" id="L522">      } catch (IllegalStateException | NotFoundException e) {</span>
<span class="nc" id="L523">        logger.error(&quot;Error retrieving static file '{}'&quot;, staticFileId, e);</span>
<span class="fc" id="L524">      }</span>
    }
<span class="fc" id="L526">  }</span>

  /**
   * Returns the JSON representation of this theme.
   *
   * @param theme
   *          the theme
   * @param editResponse
   *          whether the returning representation should contain edit information
   * @return the JSON representation of this theme.
   */
  private JsonObject themeToJSON(Theme theme, boolean editResponse) {
<span class="pc bpc" id="L538" title="1 of 2 branches missed.">    String creator = StringUtils.isNotBlank(theme.getCreator().getName())</span>
<span class="fc" id="L539">        ? theme.getCreator().getName()</span>
<span class="pc" id="L540">        : theme.getCreator().getUsername();</span>

<span class="fc" id="L542">    JsonObject json = new JsonObject();</span>

<span class="fc" id="L544">    json.addProperty(&quot;id&quot;,  theme.getId().getOrElse(-1L));</span>
<span class="fc" id="L545">    json.addProperty(&quot;creationDate&quot;, DateTimeSupport.toUTC(theme.getCreationDate().getTime()));</span>
<span class="fc" id="L546">    json.addProperty(&quot;default&quot;, theme.isDefault());</span>
<span class="fc" id="L547">    json.addProperty(&quot;name&quot;, theme.getName());</span>
<span class="fc" id="L548">    json.addProperty(&quot;creator&quot;, creator);</span>
<span class="fc" id="L549">    json.addProperty(&quot;description&quot;, safeString(theme.getDescription()));</span>
<span class="fc" id="L550">    json.addProperty(&quot;bumperActive&quot;, theme.isBumperActive());</span>
<span class="fc" id="L551">    json.addProperty(&quot;bumperFile&quot;, safeString(theme.getBumperFile()));</span>
<span class="fc" id="L552">    json.addProperty(&quot;trailerActive&quot;, theme.isTrailerActive());</span>
<span class="fc" id="L553">    json.addProperty(&quot;trailerFile&quot;, safeString(theme.getTrailerFile()));</span>
<span class="fc" id="L554">    json.addProperty(&quot;titleSlideActive&quot;, theme.isTitleSlideActive());</span>
<span class="fc" id="L555">    json.addProperty(&quot;titleSlideMetadata&quot;, safeString(theme.getTitleSlideMetadata()));</span>
<span class="fc" id="L556">    json.addProperty(&quot;titleSlideBackground&quot;, safeString(theme.getTitleSlideBackground()));</span>
<span class="fc" id="L557">    json.addProperty(&quot;licenseSlideActive&quot;, theme.isLicenseSlideActive());</span>
<span class="fc" id="L558">    json.addProperty(&quot;licenseSlideDescription&quot;, safeString(theme.getLicenseSlideDescription()));</span>
<span class="fc" id="L559">    json.addProperty(&quot;licenseSlideBackground&quot;, safeString(theme.getLicenseSlideBackground()));</span>
<span class="fc" id="L560">    json.addProperty(&quot;watermarkActive&quot;, theme.isWatermarkActive());</span>
<span class="pc bpc" id="L561" title="1 of 2 branches missed.">    json.addProperty(&quot;watermarkFile&quot;, theme.getWatermarkFile() != null ? theme.getWatermarkFile() : &quot;&quot;);</span>
<span class="pc bpc" id="L562" title="1 of 2 branches missed.">    json.addProperty(&quot;watermarkPosition&quot;, theme.getWatermarkPosition() != null ? theme.getWatermarkPosition() : &quot;&quot;);</span>

<span class="fc bfc" id="L564" title="All 2 branches covered.">    if (editResponse) {</span>
<span class="fc" id="L565">      extendStaticFileInfo(&quot;bumperFile&quot;, theme.getBumperFile(), json);</span>
<span class="fc" id="L566">      extendStaticFileInfo(&quot;trailerFile&quot;, theme.getTrailerFile(), json);</span>
<span class="fc" id="L567">      extendStaticFileInfo(&quot;titleSlideBackground&quot;, theme.getTitleSlideBackground(), json);</span>
<span class="fc" id="L568">      extendStaticFileInfo(&quot;licenseSlideBackground&quot;, theme.getLicenseSlideBackground(), json);</span>
<span class="fc" id="L569">      extendStaticFileInfo(&quot;watermarkFile&quot;, theme.getWatermarkFile(), json);</span>
    }

<span class="fc" id="L572">    return json;</span>
  }

  /**
   * Persist all files that are referenced in the theme.
   *
   * @param theme
   *          The theme
   * @throws NotFoundException
   *           If a referenced file is not found.
   * @throws IOException
   *           If there was an error while persisting the file.
   */
  private void persistReferencedFiles(Theme theme) throws NotFoundException, IOException {
<span class="pc bpc" id="L586" title="1 of 2 branches missed.">    if (isNotBlank(theme.getBumperFile()))</span>
<span class="fc" id="L587">      staticFileService.persistFile(theme.getBumperFile());</span>
<span class="pc bpc" id="L588" title="1 of 2 branches missed.">    if (isNotBlank(theme.getLicenseSlideBackground()))</span>
<span class="fc" id="L589">      staticFileService.persistFile(theme.getLicenseSlideBackground());</span>
<span class="pc bpc" id="L590" title="1 of 2 branches missed.">    if (isNotBlank(theme.getTitleSlideBackground()))</span>
<span class="fc" id="L591">      staticFileService.persistFile(theme.getTitleSlideBackground());</span>
<span class="pc bpc" id="L592" title="1 of 2 branches missed.">    if (isNotBlank(theme.getTrailerFile()))</span>
<span class="fc" id="L593">      staticFileService.persistFile(theme.getTrailerFile());</span>
<span class="pc bpc" id="L594" title="1 of 2 branches missed.">    if (isNotBlank(theme.getWatermarkFile()))</span>
<span class="fc" id="L595">      staticFileService.persistFile(theme.getWatermarkFile());</span>
<span class="fc" id="L596">  }</span>

  /**
   * Delete all files that are referenced in the theme.
   *
   * @param theme
   *          The theme
   * @throws NotFoundException
   *           If a referenced file is not found.
   * @throws IOException
   *           If there was an error while persisting the file.
   */
  private void deleteReferencedFiles(Theme theme) throws NotFoundException, IOException {
<span class="pc bpc" id="L609" title="1 of 2 branches missed.">    if (isNotBlank(theme.getBumperFile()))</span>
<span class="fc" id="L610">      staticFileService.deleteFile(theme.getBumperFile());</span>
<span class="pc bpc" id="L611" title="1 of 2 branches missed.">    if (isNotBlank(theme.getLicenseSlideBackground()))</span>
<span class="fc" id="L612">      staticFileService.deleteFile(theme.getLicenseSlideBackground());</span>
<span class="pc bpc" id="L613" title="1 of 2 branches missed.">    if (isNotBlank(theme.getTitleSlideBackground()))</span>
<span class="fc" id="L614">      staticFileService.deleteFile(theme.getTitleSlideBackground());</span>
<span class="pc bpc" id="L615" title="1 of 2 branches missed.">    if (isNotBlank(theme.getTrailerFile()))</span>
<span class="fc" id="L616">      staticFileService.deleteFile(theme.getTrailerFile());</span>
<span class="pc bpc" id="L617" title="1 of 2 branches missed.">    if (isNotBlank(theme.getWatermarkFile()))</span>
<span class="fc" id="L618">      staticFileService.deleteFile(theme.getWatermarkFile());</span>
<span class="fc" id="L619">  }</span>

  /**
   * Update all files that have changed between {@code original} and {@code updated}.
   *
   * @param original
   *          The original theme
   * @param updated
   *          The updated theme
   * @throws NotFoundException
   *           If one of the referenced files could not be found.
   * @throws IOException
   *           If there was an error while updating the referenced files.
   */
  private void updateReferencedFiles(Theme original, Theme updated) throws NotFoundException, IOException {
<span class="fc" id="L634">    updateReferencedFile(original.getBumperFile(), updated.getBumperFile());</span>
<span class="fc" id="L635">    updateReferencedFile(original.getLicenseSlideBackground(), updated.getLicenseSlideBackground());</span>
<span class="fc" id="L636">    updateReferencedFile(original.getTitleSlideBackground(), updated.getTitleSlideBackground());</span>
<span class="fc" id="L637">    updateReferencedFile(original.getTrailerFile(), updated.getTrailerFile());</span>
<span class="fc" id="L638">    updateReferencedFile(original.getWatermarkFile(), updated.getWatermarkFile());</span>
<span class="fc" id="L639">  }</span>

  /**
   * If the file resource has changed between {@code original} and {@code updated}, the original file is deleted and the
   * updated one persisted.
   *
   * @param original
   *          The UUID of the original file
   * @param updated
   *          The UUID of the updated file
   * @throws NotFoundException
   *           If the file could not be found
   * @throws IOException
   *           If there was an error while persisting or deleting one of the files.
   */
  private void updateReferencedFile(String original, String updated) throws NotFoundException, IOException {
<span class="pc bpc" id="L655" title="1 of 2 branches missed.">    if (EqualsUtil.ne(original, updated)) {</span>
<span class="pc bpc" id="L656" title="1 of 2 branches missed.">      if (isNotBlank(original))</span>
<span class="fc" id="L657">        staticFileService.deleteFile(original);</span>
<span class="pc bpc" id="L658" title="1 of 2 branches missed.">      if (isNotBlank(updated))</span>
<span class="fc" id="L659">        staticFileService.persistFile(updated);</span>
    }
<span class="fc" id="L661">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>