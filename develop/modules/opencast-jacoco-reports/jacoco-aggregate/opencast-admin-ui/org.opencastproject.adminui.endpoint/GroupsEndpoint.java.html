<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>GroupsEndpoint.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-admin-ui</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.adminui.endpoint</a> &gt; <span class="el_source">GroupsEndpoint.java</span></div><h1>GroupsEndpoint.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.adminui.endpoint;

import static java.lang.Math.max;
import static javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;
import static javax.servlet.http.HttpServletResponse.SC_CONFLICT;
import static javax.servlet.http.HttpServletResponse.SC_CREATED;
import static javax.servlet.http.HttpServletResponse.SC_FORBIDDEN;
import static javax.servlet.http.HttpServletResponse.SC_INTERNAL_SERVER_ERROR;
import static javax.servlet.http.HttpServletResponse.SC_NOT_FOUND;
import static javax.servlet.http.HttpServletResponse.SC_OK;
import static org.opencastproject.index.service.util.JSONUtils.safeString;
import static org.opencastproject.index.service.util.RestUtils.okJsonList;
import static org.opencastproject.util.doc.rest.RestParameter.Type.INTEGER;
import static org.opencastproject.util.doc.rest.RestParameter.Type.STRING;
import static org.opencastproject.util.doc.rest.RestParameter.Type.TEXT;

import org.opencastproject.elasticsearch.index.ElasticsearchIndex;
import org.opencastproject.index.service.api.IndexService;
import org.opencastproject.index.service.resources.list.query.GroupsListQuery;
import org.opencastproject.index.service.util.RestUtils;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.UnauthorizedException;
import org.opencastproject.security.api.User;
import org.opencastproject.security.api.UserDirectoryService;
import org.opencastproject.security.impl.jpa.JpaGroup;
import org.opencastproject.userdirectory.ConflictException;
import org.opencastproject.userdirectory.JpaGroupRoleProvider;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.doc.rest.RestParameter;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestResponse;
import org.opencastproject.util.doc.rest.RestService;
import org.opencastproject.util.requests.SortCriterion;

import com.google.gson.JsonArray;
import com.google.gson.JsonObject;

import org.apache.commons.lang3.StringUtils;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.jaxrs.whiteboard.propertytypes.JaxrsResource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.stream.Collectors;

import javax.ws.rs.DELETE;
import javax.ws.rs.FormParam;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.PUT;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.WebApplicationException;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.Response.Status;

@Path(&quot;/admin-ng/groups&quot;)
@RestService(name = &quot;groups&quot;, title = &quot;Group service&quot;,
  abstractText = &quot;Provides operations for groups&quot;,
  notes = { &quot;This service offers the default groups CRUD operations for the admin interface.&quot;,
            &quot;&lt;strong&gt;Important:&lt;/strong&gt; &quot;
              + &quot;&lt;em&gt;This service is for exclusive use by the module admin-ui. Its API might change &quot;
              + &quot;anytime without prior notice. Any dependencies other than the admin UI will be strictly ignored. &quot;
              + &quot;DO NOT use this for integration of third-party applications.&lt;em&gt;&quot;})
@Component(
        immediate = true,
        service = GroupsEndpoint.class,
        property = {
                &quot;service.description=Admin UI - Groups Endpoint&quot;,
                &quot;opencast.service.type=org.opencastproject.adminui.GroupsEndpoint&quot;,
                &quot;opencast.service.path=/admin-ng/groups&quot;,
        }
)
@JaxrsResource
<span class="nc" id="L110">public class GroupsEndpoint {</span>

  /** The logging facility */
<span class="nc" id="L113">  private static final Logger logger = LoggerFactory.getLogger(GroupsEndpoint.class);</span>

  /** The admin UI search index */
  private ElasticsearchIndex searchIndex;

  /** The security service */
  private SecurityService securityService;

  /** The user directory service */
  private UserDirectoryService userDirectoryService;

  /** The index service */
  private IndexService indexService;

  /** The group provider */
  private JpaGroupRoleProvider jpaGroupRoleProvider;

  /** OSGi callback for the security service. */
  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="nc" id="L133">    this.securityService = securityService;</span>
<span class="nc" id="L134">  }</span>

  /** OSGi callback for the index service. */
  @Reference
  public void setIndexService(IndexService indexService) {
<span class="nc" id="L139">    this.indexService = indexService;</span>
<span class="nc" id="L140">  }</span>

  /** OSGi callback for users services. */
  @Reference
  public void setUserDirectoryService(UserDirectoryService userDirectoryService) {
<span class="nc" id="L145">    this.userDirectoryService = userDirectoryService;</span>
<span class="nc" id="L146">  }</span>

  /** OSGi callback for the search index. */
  @Reference
  public void setSearchIndex(ElasticsearchIndex searchIndex) {
<span class="nc" id="L151">    this.searchIndex = searchIndex;</span>
<span class="nc" id="L152">  }</span>

  /** OSGi callback for the group provider. */
  @Reference
  public void setGroupRoleProvider(JpaGroupRoleProvider jpaGroupRoleProvider) {
<span class="nc" id="L157">    this.jpaGroupRoleProvider = jpaGroupRoleProvider;</span>
<span class="nc" id="L158">  }</span>

  /** OSGi callback. */
  @Activate
  protected void activate(ComponentContext cc) {
<span class="nc" id="L163">    logger.info(&quot;Activate the Admin ui - Groups facade endpoint&quot;);</span>
<span class="nc" id="L164">  }</span>

  @GET
  @Produces(MediaType.APPLICATION_JSON)
  @Path(&quot;groups.json&quot;)
  @RestQuery(
    name = &quot;allgroupsasjson&quot;,
    description = &quot;Returns a list of groups&quot;,
    returnDescription = &quot;List of groups for the current user's organization as JSON.&quot;,
    restParameters = {
      @RestParameter(name = &quot;filter&quot;, isRequired = false, type = STRING,
        description = &quot;Filter used for the query, formatted like: 'filter1:value1,filter2:value2'&quot;),
      @RestParameter(name = &quot;sort&quot;, isRequired = false, type = STRING,
        description = &quot;The sort order. May include any of the following: NAME, DESCRIPTION, ROLE. &quot;
        + &quot;Add '_DESC' to reverse the sort order (e.g. NAME_DESC).&quot;),
      @RestParameter(name = &quot;limit&quot;, isRequired = false, type = INTEGER, defaultValue = &quot;100&quot;,
        description = &quot;The maximum number of items to return per page.&quot;),
      @RestParameter(name = &quot;offset&quot;, isRequired = false, type = INTEGER, defaultValue = &quot;0&quot;,
        description = &quot;The page number.&quot;)},
    responses = {
      @RestResponse(responseCode = SC_OK, description = &quot;The groups.&quot;)})
  public Response getGroups(@QueryParam(&quot;filter&quot;) String filter, @QueryParam(&quot;sort&quot;) String sort,
          @QueryParam(&quot;offset&quot;) Integer offset, @QueryParam(&quot;limit&quot;) Integer limit) throws IOException {
<span class="nc" id="L187">    Optional&lt;Integer&gt; optLimit = Optional.ofNullable(limit);</span>
<span class="nc" id="L188">    Optional&lt;Integer&gt; optOffset = Optional.ofNullable(offset);</span>

<span class="nc" id="L190">    Map&lt;String, String&gt; filters = RestUtils.parseFilter(filter);</span>
<span class="nc" id="L191">    Optional&lt;String&gt; optNameFilter = Optional.ofNullable(filters.get(GroupsListQuery.FILTER_NAME_NAME));</span>
<span class="nc" id="L192">    Optional&lt;String&gt; optRoleFilter = Optional.ofNullable(filters.get(GroupsListQuery.FILTER_ROLE_NAME));</span>
<span class="nc" id="L193">    Optional&lt;String&gt; optTextFilter = Optional.ofNullable(filters.get(GroupsListQuery.FILTER_TEXT_NAME));</span>

<span class="nc" id="L195">    ArrayList&lt;SortCriterion&gt; sortCriteria = RestUtils.parseSortQueryParameter(sort);</span>

<span class="nc" id="L197">    List&lt;JpaGroup&gt; results = jpaGroupRoleProvider.getGroups(optLimit, optOffset, optNameFilter, optRoleFilter,</span>
        optTextFilter, sortCriteria);

    // load users
<span class="nc" id="L201">    List&lt;String&gt; userNames = results.stream().flatMap(item -&gt; item.getMembers().stream())</span>
<span class="nc" id="L202">            .collect(Collectors.toList());</span>
<span class="nc" id="L203">    final Map&lt;String, User&gt; users = new HashMap&lt;&gt;(userNames.size());</span>
<span class="nc" id="L204">    userDirectoryService.loadUsers(userNames).forEachRemaining(user -&gt; users.put(user.getUsername(), user));</span>

<span class="nc" id="L206">    List&lt;JsonObject&gt; groupsJsonArray = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">    for (JpaGroup group : results) {</span>
<span class="nc" id="L208">      JsonObject groupJson = new JsonObject();</span>
<span class="nc" id="L209">      groupJson.addProperty(&quot;id&quot;, group.getGroupId());</span>
<span class="nc" id="L210">      groupJson.addProperty(&quot;name&quot;, safeString(group.getName()));</span>
<span class="nc" id="L211">      groupJson.addProperty(&quot;description&quot;, safeString(group.getDescription()));</span>
<span class="nc" id="L212">      groupJson.addProperty(&quot;role&quot;, group.getRole());</span>
<span class="nc" id="L213">      groupJson.add(&quot;users&quot;,</span>
<span class="nc" id="L214">          membersToJSON(group.getMembers().stream().map(users::get).filter(Objects::nonNull).iterator()));</span>

<span class="nc" id="L216">      groupsJsonArray.add(groupJson);</span>
<span class="nc" id="L217">    }</span>

<span class="nc" id="L219">    long dbTotal = jpaGroupRoleProvider.countTotalGroups(optNameFilter, optRoleFilter, optTextFilter);</span>
<span class="nc" id="L220">    long resultsTotal = optOffset.orElse(0) + results.size();</span>

    // groups could've been added or deleted in the meantime, so...
    long total;
    // don't show next page if current page isn't full
<span class="nc bnc" id="L225" title="All 4 branches missed.">    if (!optLimit.isPresent() || results.size() &lt; optLimit.get()) {</span>
<span class="nc" id="L226">      total = resultsTotal;</span>
      // don't show less than the current results
    } else {
<span class="nc" id="L229">      total = max(dbTotal, resultsTotal);</span>
    }

<span class="nc" id="L232">    return okJsonList(groupsJsonArray, optOffset, optLimit, total);</span>
  }

  @DELETE
  @Path(&quot;{id}&quot;)
  @RestQuery(
    name = &quot;removegrouop&quot;,
    description = &quot;Remove a group&quot;,
    returnDescription = &quot;Returns no content&quot;,
    pathParameters = {
      @RestParameter(name = &quot;id&quot;, description = &quot;The group identifier&quot;, isRequired = true, type = STRING)},
    responses = {
      @RestResponse(responseCode = SC_OK, description = &quot;Group deleted&quot;),
      @RestResponse(responseCode = SC_FORBIDDEN, description = &quot;Not enough permissions to delete the group with admin role.&quot;),
      @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;Group not found.&quot;),
      @RestResponse(responseCode = SC_INTERNAL_SERVER_ERROR, description = &quot;An internal server error occured.&quot;)})
  public Response removeGroup(@PathParam(&quot;id&quot;) String groupId) throws NotFoundException {
    try {
<span class="nc" id="L250">      jpaGroupRoleProvider.removeGroup(groupId);</span>
<span class="nc" id="L251">      return Response.noContent().build();</span>
<span class="nc" id="L252">    } catch (NotFoundException e) {</span>
<span class="nc" id="L253">      return Response.status(SC_NOT_FOUND).build();</span>
<span class="nc" id="L254">    } catch (UnauthorizedException e) {</span>
<span class="nc" id="L255">      return Response.status(SC_FORBIDDEN).build();</span>
<span class="nc" id="L256">    } catch (Exception e) {</span>
<span class="nc" id="L257">      logger.error(&quot;Unable to delete group {}&quot;, groupId, e);</span>
<span class="nc" id="L258">      throw new WebApplicationException(e, SC_INTERNAL_SERVER_ERROR);</span>
    }
  }

  @POST
  @Path(&quot;&quot;)
  @RestQuery(
    name = &quot;createGroup&quot;,
    description = &quot;Add a group&quot;,
    returnDescription = &quot;Returns Created (201) if the group has been created&quot;,
    restParameters = {
      @RestParameter(name = &quot;name&quot;, description = &quot;The group name&quot;, isRequired = true, type = STRING),
      @RestParameter(name = &quot;description&quot;, description = &quot;The group description&quot;, isRequired = false, type = STRING),
      @RestParameter(name = &quot;roles&quot;, description = &quot;Comma seperated list of roles&quot;, isRequired = false, type = TEXT),
      @RestParameter(name = &quot;users&quot;, description = &quot;Comma seperated list of members&quot;, isRequired = false, type = TEXT)},
    responses = {
      @RestResponse(responseCode = SC_CREATED, description = &quot;Group created&quot;),
      @RestResponse(responseCode = SC_BAD_REQUEST, description = &quot;Name too long&quot;),
      @RestResponse(responseCode = SC_FORBIDDEN, description = &quot;Not enough permissions to create a group with admin role.&quot;),
      @RestResponse(responseCode = SC_CONFLICT, description = &quot;An group with this name already exists.&quot;) })
  public Response createGroup(@FormParam(&quot;name&quot;) String name, @FormParam(&quot;description&quot;) String description,
          @FormParam(&quot;roles&quot;) String roles, @FormParam(&quot;users&quot;) String users) {
    try {
<span class="nc" id="L281">      jpaGroupRoleProvider.createGroup(name, description, roles, users);</span>
<span class="nc" id="L282">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L283">      logger.warn(&quot;Unable to create group with name {}: {}&quot;, name, e.getMessage());</span>
<span class="nc" id="L284">      return Response.status(Status.BAD_REQUEST).build();</span>
<span class="nc" id="L285">    } catch (UnauthorizedException e) {</span>
<span class="nc" id="L286">      return Response.status(SC_FORBIDDEN).build();</span>
<span class="nc" id="L287">    } catch (ConflictException e) {</span>
<span class="nc" id="L288">      return Response.status(SC_CONFLICT).build();</span>
<span class="nc" id="L289">    }</span>
<span class="nc" id="L290">    return Response.status(Status.CREATED).build();</span>
  }

  @PUT
  @Path(&quot;{id}&quot;)
  @RestQuery(
    name = &quot;updateGroup&quot;,
    description = &quot;Update a group&quot;,
    returnDescription = &quot;Return the status codes&quot;,
    pathParameters = {
      @RestParameter(name = &quot;id&quot;, description = &quot;The group identifier&quot;, isRequired = true, type = STRING) },
    restParameters = {
      @RestParameter(name = &quot;name&quot;, description = &quot;The group name&quot;, isRequired = true, type = STRING),
      @RestParameter(name = &quot;description&quot;, description = &quot;The group description&quot;, isRequired = false, type = STRING),
      @RestParameter(name = &quot;roles&quot;, description = &quot;Comma seperated list of roles&quot;, isRequired = false, type = TEXT),
      @RestParameter(name = &quot;users&quot;, description = &quot;Comma seperated list of members&quot;, isRequired = false, type = TEXT)},
    responses = {
      @RestResponse(responseCode = SC_OK, description = &quot;Group updated&quot;),
      @RestResponse(responseCode = SC_FORBIDDEN, description = &quot;Not enough permissions to update the group with admin role.&quot;),
      @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;Group not found&quot;),
      @RestResponse(responseCode = SC_BAD_REQUEST, description = &quot;Name too long&quot;)})
  public Response updateGroup(@PathParam(&quot;id&quot;) String groupId, @FormParam(&quot;name&quot;) String name,
          @FormParam(&quot;description&quot;) String description, @FormParam(&quot;roles&quot;) String roles,
          @FormParam(&quot;users&quot;) String users) throws NotFoundException {
    try {
<span class="nc" id="L315">      jpaGroupRoleProvider.updateGroup(groupId, name, description, roles, users);</span>
<span class="nc" id="L316">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L317">      logger.warn(&quot;Unable to update group with id {}: {}&quot;, groupId, e.getMessage());</span>
<span class="nc" id="L318">      return Response.status(Status.BAD_REQUEST).build();</span>
<span class="nc" id="L319">    } catch (UnauthorizedException ex) {</span>
<span class="nc" id="L320">      return Response.status(SC_FORBIDDEN).build();</span>
<span class="nc" id="L321">    }</span>
<span class="nc" id="L322">    return Response.ok().build();</span>
  }

  @GET
  @Produces(MediaType.APPLICATION_JSON)
  @Path(&quot;{id}&quot;)
  @RestQuery(
    name = &quot;getGroup&quot;,
    description = &quot;Get a single group&quot;,
    returnDescription = &quot;Return the status codes&quot;,
    pathParameters = {
      @RestParameter(name = &quot;id&quot;, description = &quot;The group identifier&quot;, isRequired = true, type = STRING)},
    responses = {
      @RestResponse(responseCode = SC_OK, description = &quot;Group found and returned as JSON&quot;),
      @RestResponse(responseCode = SC_NOT_FOUND, description = &quot;Group not found&quot;)})
  public Response getGroup(@PathParam(&quot;id&quot;) String groupId) throws NotFoundException {
<span class="nc" id="L338">    JpaGroup group = jpaGroupRoleProvider.getGroup(groupId);</span>

<span class="nc bnc" id="L340" title="All 2 branches missed.">    if (group == null) {</span>
<span class="nc" id="L341">      throw new NotFoundException(&quot;Group &quot; + groupId + &quot; does not exist.&quot;);</span>
    }

    // Convert roles
<span class="nc" id="L345">    JsonArray rolesJSON = new JsonArray();</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">    for (String role : group.getRoleNames()) {</span>
<span class="nc" id="L347">      rolesJSON.add(role);</span>
<span class="nc" id="L348">    }</span>

<span class="nc" id="L350">    Iterator&lt;User&gt; users = userDirectoryService.loadUsers(group.getMembers());</span>
<span class="nc" id="L351">    JsonObject jsonGroup = new JsonObject();</span>
<span class="nc" id="L352">    jsonGroup.addProperty(&quot;id&quot;, group.getGroupId());</span>
<span class="nc" id="L353">    jsonGroup.addProperty(&quot;name&quot;, safeString(group.getName()));</span>
<span class="nc" id="L354">    jsonGroup.addProperty(&quot;description&quot;, safeString(group.getDescription()));</span>
<span class="nc" id="L355">    jsonGroup.addProperty(&quot;role&quot;, safeString(group.getRole()));</span>
<span class="nc" id="L356">    jsonGroup.add(&quot;roles&quot;, rolesJSON);</span>
<span class="nc" id="L357">    jsonGroup.add(&quot;users&quot;, membersToJSON(users));</span>

<span class="nc" id="L359">    return RestUtils.okJson(jsonGroup);</span>
  }

  /**
   * Generate a JSON array based on the given set of members
   *
   * @param members
   *          the members source
   * @return a JSON array ({@link JsonArray}) with the given members
   */

  private JsonArray membersToJSON(Iterator&lt;User&gt; members) {
<span class="nc" id="L371">    JsonArray membersJSON = new JsonArray();</span>

<span class="nc bnc" id="L373" title="All 2 branches missed.">    while (members.hasNext()) {</span>
<span class="nc" id="L374">      User user = members.next();</span>
<span class="nc" id="L375">      String name = user.getUsername();</span>

<span class="nc bnc" id="L377" title="All 2 branches missed.">      if (StringUtils.isNotBlank(user.getName())) {</span>
<span class="nc" id="L378">        name = user.getName();</span>
      }

<span class="nc" id="L381">      JsonObject jsonUser = new JsonObject();</span>
<span class="nc" id="L382">      jsonUser.addProperty(&quot;username&quot;, user.getUsername());</span>
<span class="nc" id="L383">      jsonUser.addProperty(&quot;name&quot;, name);</span>

<span class="nc" id="L385">      membersJSON.add(jsonUser);</span>
<span class="nc" id="L386">    }</span>

<span class="nc" id="L388">    return membersJSON;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>