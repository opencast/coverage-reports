<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>StatisticsEndpoint.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-admin-ui</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.adminui.endpoint</a> &gt; <span class="el_source">StatisticsEndpoint.java</span></div><h1>StatisticsEndpoint.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.adminui.endpoint;

import static org.opencastproject.security.api.SecurityConstants.GLOBAL_ADMIN_ROLE;
import static org.opencastproject.util.data.functions.Functions.chuck;
import static org.opencastproject.util.doc.rest.RestParameter.Type.STRING;

import org.opencastproject.adminui.impl.ProviderQuery;
import org.opencastproject.adminui.impl.RawProviderQuery;
import org.opencastproject.elasticsearch.api.SearchIndexException;
import org.opencastproject.elasticsearch.index.ElasticsearchIndex;
import org.opencastproject.elasticsearch.index.objects.event.Event;
import org.opencastproject.elasticsearch.index.objects.series.Series;
import org.opencastproject.index.service.api.IndexService;
import org.opencastproject.security.api.Organization;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.UnauthorizedException;
import org.opencastproject.security.api.User;
import org.opencastproject.statistics.api.DataResolution;
import org.opencastproject.statistics.api.ResourceType;
import org.opencastproject.statistics.api.StatisticsProvider;
import org.opencastproject.statistics.api.StatisticsService;
import org.opencastproject.statistics.api.TimeSeries;
import org.opencastproject.statistics.api.TimeSeriesProvider;
import org.opencastproject.statistics.export.api.StatisticsExportService;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.RestUtil;
import org.opencastproject.util.doc.rest.RestParameter;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestResponse;
import org.opencastproject.util.doc.rest.RestService;

import com.google.gson.Gson;

import org.apache.commons.lang3.StringUtils;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.jaxrs.whiteboard.propertytypes.JaxrsResource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.time.ZoneId;
import java.util.Arrays;
import java.util.Optional;
import java.util.Set;
import java.util.stream.Stream;

import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.FormParam;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;


@Path(&quot;/admin-ng/statistics&quot;)
@RestService(name = &quot;statistics&quot;, title = &quot;statistics fa√ßade service&quot;,
  abstractText = &quot;Provides statistics&quot;,
  notes = {&quot;This service provides statistics.&quot;
    + &quot;&lt;em&gt;This service is for exclusive use by the module admin-ui. Its API might change &quot;
    + &quot;anytime without prior notice. Any dependencies other than the admin UI will be strictly ignored. &quot;
    + &quot;DO NOT use this for integration of third-party applications.&lt;em&gt;&quot;})
@Component(
        immediate = true,
        service = StatisticsEndpoint.class,
        property = {
                &quot;service.description=Admin UI - Statistics Endpoint&quot;,
                &quot;opencast.service.type=org.opencastproject.adminui.StatisticsEndpoint&quot;,
                &quot;opencast.service.path=/admin-ng/statistics&quot;,
        }
)
@JaxrsResource
<span class="nc" id="L98">public class StatisticsEndpoint {</span>

  /** The logging facility */
<span class="nc" id="L101">  private static final Logger logger = LoggerFactory.getLogger(StatisticsEndpoint.class);</span>
  private static final String TIME_SERIES_PROVIDER_TYPE = &quot;timeSeries&quot;;
  private static final String STATISTICS_ORGANIZATION_UI_ROLE = &quot;ROLE_UI_STATISTICS_ORGANIZATION_VIEW&quot;;

  private SecurityService securityService;
  private IndexService indexService;
  private ElasticsearchIndex searchIndex;
  private StatisticsService statisticsService;
  private StatisticsExportService statisticsExportService;

  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="nc" id="L113">    this.securityService = securityService;</span>
<span class="nc" id="L114">  }</span>

  @Reference
  public void setIndexService(IndexService indexService) {
<span class="nc" id="L118">    this.indexService = indexService;</span>
<span class="nc" id="L119">  }</span>

  @Reference
  public void setSearchIndex(ElasticsearchIndex searchIndex) {
<span class="nc" id="L123">    this.searchIndex = searchIndex;</span>
<span class="nc" id="L124">  }</span>

  @Reference
  public void setStatisticsService(StatisticsService statisticsService) {
<span class="nc" id="L128">    this.statisticsService = statisticsService;</span>
<span class="nc" id="L129">  }</span>

  @Reference
  public void setStatisticsExportService(StatisticsExportService statisticsExportService) {
<span class="nc" id="L133">    this.statisticsExportService = statisticsExportService;</span>
<span class="nc" id="L134">  }</span>

  @GET
  @Path(&quot;providers.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;getprovidersbyresourcetype&quot;, description = &quot;Returns the available statistics providers for an (optional) resource type&quot;, returnDescription = &quot;The available statistics providers as JSON&quot;, restParameters = {
    @RestParameter(name = &quot;resourceType&quot;, description = &quot;The resource type: either 'episode', 'series' or 'organization'&quot;, isRequired = false, type = STRING)},
    responses = {
      @RestResponse(description = &quot;Returns the providers for the given resource type as JSON, or all, if the resource type is missing&quot;, responseCode = HttpServletResponse.SC_OK),
      @RestResponse(description = &quot;If the current user is not authorized to perform this action&quot;, responseCode = HttpServletResponse.SC_UNAUTHORIZED)
    })
  public Response getProviders(
    @QueryParam(&quot;resourceType&quot;) final String resourceTypeStr) {
    ResourceType resourceType;
    try {
<span class="nc bnc" id="L149" title="All 2 branches missed.">      if (resourceTypeStr == null) {</span>
<span class="nc" id="L150">        resourceType = null;</span>
      } else {
<span class="nc" id="L152">        resourceType = Enum.valueOf(ResourceType.class, resourceTypeStr.toUpperCase());</span>
      }
<span class="nc" id="L154">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L155">      return RestUtil.R.badRequest(&quot;invalid value for 'resourceType'&quot;);</span>
<span class="nc" id="L156">    }</span>

<span class="nc" id="L158">    JSONArray result = new JSONArray();</span>
<span class="nc" id="L159">    statisticsService</span>
<span class="nc" id="L160">      .getProviders(resourceType)</span>
<span class="nc" id="L161">      .stream()</span>
<span class="nc" id="L162">      .map(this::providerToJson)</span>
<span class="nc" id="L163">      .forEach(result::add);</span>
<span class="nc" id="L164">    return Response.ok(result.toJSONString()).build();</span>
  }

  private static String providerTypeString(StatisticsProvider provider) {
<span class="nc bnc" id="L168" title="All 2 branches missed.">    if (provider instanceof TimeSeriesProvider) {</span>
<span class="nc" id="L169">      return TIME_SERIES_PROVIDER_TYPE;</span>
    }
<span class="nc" id="L171">    return &quot;unknown&quot;;</span>
  }

  private JSONObject providerToJson(StatisticsProvider provider) {
<span class="nc" id="L175">    final JSONObject providerObj = new JSONObject();</span>
<span class="nc" id="L176">    providerObj.put(&quot;providerId&quot;, provider.getId());</span>
<span class="nc" id="L177">    providerObj.put(&quot;providerType&quot;, providerTypeString(provider));</span>
<span class="nc" id="L178">    providerObj.put(&quot;title&quot;, provider.getTitle());</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">    if (provider instanceof TimeSeriesProvider) {</span>
<span class="nc" id="L180">      providerObj.put(&quot;dataResolutions&quot;, resolutionsToJson(((TimeSeriesProvider) provider).getDataResolutions()));</span>
    }
<span class="nc" id="L182">    providerObj.put(&quot;description&quot;, provider.getDescription());</span>
<span class="nc" id="L183">    return providerObj;</span>
  }

  private JSONArray resolutionsToJson(Set&lt;DataResolution&gt; resolutions) {
<span class="nc" id="L187">    JSONArray result = new JSONArray();</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">    for (DataResolution dataResolution : resolutions) {</span>
<span class="nc" id="L189">      result.add(dataResolutionToJson(dataResolution));</span>
<span class="nc" id="L190">    }</span>
<span class="nc" id="L191">    return result;</span>
  }

  private String dataResolutionToJson(DataResolution dataResolution) {
<span class="nc" id="L195">    return dataResolution.toString().toLowerCase();</span>
  }

  @POST
  @Path(&quot;data.json&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  @RestQuery(name = &quot;getproviderdata&quot;, description = &quot;Returns the statistical data for a specific provider and a specific resource&quot;, returnDescription = &quot;The statistical data as JSON&quot;, restParameters = {
    @RestParameter(name = &quot;data&quot;, isRequired = true, description = &quot;A list of statistical data requests, containing a provider id, from, to, the resource id and a resolution - all as JSON&quot;, type = RestParameter.Type.TEXT) },
    responses = {
      @RestResponse(description = &quot;Returns the statistical data for the given resource type as JSON&quot;, responseCode = HttpServletResponse.SC_OK),
      @RestResponse(description = &quot;If the current user is not authorized to perform this action&quot;, responseCode = HttpServletResponse.SC_UNAUTHORIZED)
    })
  public Response getProviderData(@FormParam(&quot;data&quot;) String data) {
<span class="nc bnc" id="L208" title="All 2 branches missed.">    if (StringUtils.isBlank(data)) {</span>
<span class="nc" id="L209">      return RestUtil.R.badRequest(&quot;No data set&quot;);</span>
    }
<span class="nc" id="L211">    Gson gson = new Gson();</span>
    RawProviderQuery[] dataJson;
    try {
<span class="nc" id="L214">      dataJson = gson.fromJson(data, RawProviderQuery[].class);</span>
<span class="nc" id="L215">    } catch (Exception e) {</span>
<span class="nc" id="L216">      logger.warn(&quot;Unable to parse data {}&quot;, data);</span>
<span class="nc" id="L217">      return RestUtil.R.badRequest(&quot;Unable to parse data&quot;);</span>
<span class="nc" id="L218">    }</span>

<span class="nc" id="L220">    JSONArray result = new JSONArray();</span>
    try {
<span class="nc" id="L222">      Arrays</span>
<span class="nc" id="L223">        .stream(dataJson)</span>
<span class="nc" id="L224">        .map(ProviderQuery::new)</span>
<span class="nc" id="L225">        .flatMap(q -&gt;</span>
          statisticsService
<span class="nc" id="L227">            .getProvider(q.getProviderId())</span>
<span class="nc" id="L228">            .map(Stream::of).orElseGet(Stream::empty)</span>
<span class="nc" id="L229">            .peek(p -&gt; checkAccess(q.getResourceId(), p.getResourceType()))</span>
<span class="nc" id="L230">            .map(p -&gt; timeSeriesToJson(</span>
<span class="nc" id="L231">              p.getId(),</span>
<span class="nc" id="L232">              statisticsService.getTimeSeriesData(p, q.getResourceId(), q.getFrom(), q.getTo(), q.getDataResolution(),</span>
<span class="nc" id="L233">                ZoneId.systemDefault()))))</span>
<span class="nc" id="L234">        .forEach(result::add);</span>
<span class="nc" id="L235">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L236">      return RestUtil.R.badRequest(e.getMessage());</span>
<span class="nc" id="L237">    }</span>
<span class="nc" id="L238">    return Response.ok(result.toJSONString()).build();</span>
  }

  @GET
  @Path(&quot;export.csv&quot;)
  @Produces(MediaType.TEXT_PLAIN)
  @RestQuery(name = &quot;getcsvdata&quot;, description = &quot;Returns the statistical data for a specific provider and a specific resource as CSV.&quot;, returnDescription = &quot;The statistical data as CSV&quot;, restParameters = {
    @RestParameter(name = &quot;providerId&quot;, isRequired = true, description = &quot;The provider id&quot;, type = RestParameter.Type.TEXT),
    @RestParameter(name = &quot;resourceId&quot;, isRequired = true, description = &quot;The resource id&quot;, type = RestParameter.Type.TEXT),
    @RestParameter(name = &quot;from&quot;, isRequired = true, description = &quot;The from date in iso 8601 UTC notation&quot;, type = RestParameter.Type.TEXT),
    @RestParameter(name = &quot;to&quot;, isRequired = true, description = &quot;The to date in iso 8601 UTC notation&quot;, type = RestParameter.Type.TEXT),
    @RestParameter(name = &quot;dataResolution&quot;, isRequired = true, description = &quot;The data resolution. Valid values are 'HOURLY', 'DAILY', 'WEEKLY', 'MONTHLY', and 'YEARLY'&quot;, type = RestParameter.Type.TEXT)},
    responses = {
      @RestResponse(description = &quot;Returns the statistical data for the given resource type as csv&quot;, responseCode = HttpServletResponse.SC_OK),
      @RestResponse(description = &quot;If the current user is not authorized to perform this action&quot;, responseCode = HttpServletResponse.SC_UNAUTHORIZED)
    })
  public Response getCSVData(
    @QueryParam(&quot;providerId&quot;) String providerId,
    @QueryParam(&quot;resourceId&quot;) String resourceId,
    @QueryParam(&quot;from&quot;) String fromStr,
    @QueryParam(&quot;to&quot;) String toStr,
    @QueryParam(&quot;dataResolution&quot;) String dataResolutionStr) {
    try {
<span class="nc" id="L261">      final ProviderQuery q = new ProviderQuery(providerId, fromStr, toStr, dataResolutionStr, resourceId);</span>
<span class="nc" id="L262">      final StatisticsProvider p = statisticsService</span>
<span class="nc" id="L263">        .getProvider(providerId).orElseThrow(() -&gt; new IllegalArgumentException(&quot;Unknown provider: &quot; + providerId));</span>
<span class="nc" id="L264">      checkAccess(q.getResourceId(), p.getResourceType());</span>
<span class="nc" id="L265">      final String csv = statisticsExportService.getCSV(p, q.getResourceId(), q.getFrom(), q.getTo(), q.getDataResolution(),</span>
<span class="nc" id="L266">        searchIndex, ZoneId.systemDefault());</span>
<span class="nc" id="L267">      return Response.ok().entity(csv).build();</span>
<span class="nc" id="L268">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L269">      return RestUtil.R.badRequest(e.getMessage());</span>
<span class="nc" id="L270">    } catch (SearchIndexException e) {</span>
<span class="nc" id="L271">      return RestUtil.R.serverError();</span>
<span class="nc" id="L272">    } catch (NotFoundException e) {</span>
<span class="nc" id="L273">      return RestUtil.R.notFound(resourceId);</span>
<span class="nc" id="L274">    } catch (UnauthorizedException e) {</span>
<span class="nc" id="L275">      return Response.status(Response.Status.UNAUTHORIZED).build();</span>
    }
  }

  private JSONObject timeSeriesToJson(String providerId, TimeSeries timeSeriesData) {
<span class="nc" id="L280">    final JSONObject result = new JSONObject();</span>
<span class="nc" id="L281">    result.put(&quot;providerId&quot;, providerId);</span>
<span class="nc" id="L282">    result.put(&quot;providerType&quot;, &quot;timeSeries&quot;);</span>
<span class="nc" id="L283">    result.put(&quot;labels&quot;, timeSeriesData.getLabels());</span>
<span class="nc" id="L284">    result.put(&quot;values&quot;, timeSeriesData.getValues());</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">    if (timeSeriesData.getTotal().isPresent()) {</span>
<span class="nc" id="L286">      result.put(&quot;total&quot;, timeSeriesData.getTotal().getAsDouble());</span>
    }
<span class="nc" id="L288">    return result;</span>
  }

  private void checkAccess(final String resourceId, final ResourceType resourceType) {
    try {
<span class="nc bnc" id="L293" title="All 4 branches missed.">      switch (resourceType) {</span>
        case EPISODE:
<span class="nc" id="L295">          checkMediapackageAccess(resourceId);</span>
<span class="nc" id="L296">          break;</span>
        case SERIES:
<span class="nc" id="L298">          checkSeriesAccess(resourceId);</span>
<span class="nc" id="L299">          break;</span>
        case ORGANIZATION:
<span class="nc" id="L301">          checkOrganizationAccess(resourceId);</span>
<span class="nc" id="L302">          break;</span>
        // Thanks CheckStyle, very sensible
        default:
          break;
      }
<span class="nc" id="L307">    } catch (UnauthorizedException | SearchIndexException e) {</span>
<span class="nc" id="L308">      chuck(e);</span>
<span class="nc" id="L309">    }</span>
<span class="nc" id="L310">  }</span>

  private void checkMediapackageAccess(final String mpId) throws UnauthorizedException, SearchIndexException {
<span class="nc" id="L313">    final Optional&lt;Event&gt; event = indexService.getEvent(mpId, searchIndex);</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">    if (event.isEmpty()) {</span>
      // IndexService checks permissions and returns None if user is unauthorized
<span class="nc" id="L316">      throw new UnauthorizedException(securityService.getUser(), &quot;read&quot;);</span>
    }
<span class="nc" id="L318">  }</span>

  private void checkSeriesAccess(final String seriesId) throws UnauthorizedException, SearchIndexException {
<span class="nc" id="L321">    final Optional&lt;Series&gt; series = searchIndex.getSeries(seriesId, securityService.getOrganization().getId(), securityService.getUser());</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">    if (series.isEmpty()) {</span>
      // IndexService checks permissions and returns None if user is unauthorized
<span class="nc" id="L324">      throw new UnauthorizedException(securityService.getUser(), &quot;read&quot;);</span>
    }
<span class="nc" id="L326">  }</span>

  private void checkOrganizationAccess(final String orgId) throws UnauthorizedException {
<span class="nc" id="L329">    final User currentUser = securityService.getUser();</span>
<span class="nc" id="L330">    final Organization currentOrg = securityService.getOrganization();</span>
<span class="nc" id="L331">    final String currentOrgAdminRole = currentOrg.getAdminRole();</span>
<span class="nc" id="L332">    final String currentOrgId = currentOrg.getId();</span>

<span class="nc" id="L334">    final boolean userIsInOrg = currentOrgId.equals(orgId);</span>

<span class="nc bnc" id="L336" title="All 2 branches missed.">    boolean userIsAdmin = currentUser.hasRole(GLOBAL_ADMIN_ROLE)</span>
<span class="nc bnc" id="L337" title="All 4 branches missed.">      || (currentUser.hasRole(currentOrgAdminRole) &amp;&amp; userIsInOrg);</span>

<span class="nc bnc" id="L339" title="All 4 branches missed.">    boolean userIsAuthorized = currentUser.hasRole(STATISTICS_ORGANIZATION_UI_ROLE) &amp;&amp; userIsInOrg;</span>

<span class="nc bnc" id="L341" title="All 4 branches missed.">    if (!userIsAdmin &amp;&amp; !userIsAuthorized) {</span>
<span class="nc" id="L342">      throw new UnauthorizedException(currentUser, &quot;read&quot;);</span>
    }
<span class="nc" id="L344">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>