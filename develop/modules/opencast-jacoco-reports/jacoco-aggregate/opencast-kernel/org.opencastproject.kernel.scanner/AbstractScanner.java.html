<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AbstractScanner.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-kernel</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.kernel.scanner</a> &gt; <span class="el_source">AbstractScanner.java</span></div><h1>AbstractScanner.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.kernel.scanner;

import static org.opencastproject.security.util.SecurityUtil.createSystemUser;

import org.opencastproject.security.api.Organization;
import org.opencastproject.security.api.OrganizationDirectoryService;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.util.SecurityContext;
import org.opencastproject.security.util.SecurityUtil;
import org.opencastproject.serviceregistry.api.ServiceRegistry;
import org.opencastproject.util.NeedleEye;
import org.opencastproject.util.data.Function0;
import org.opencastproject.util.data.Option;

import org.osgi.service.component.ComponentContext;
import org.quartz.CronTrigger;
import org.quartz.Job;
import org.quartz.JobExecutionContext;
import org.quartz.JobExecutionException;
import org.quartz.Scheduler;
import org.quartz.SchedulerException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.text.ParseException;

/**
 * This class is designed to provide a template for sub classes that will scan
 * their data and respond accordingly.
 */
<span class="fc" id="L52">public abstract class AbstractScanner {</span>
  /** The logging facility */
<span class="fc" id="L54">  private static final Logger logger = LoggerFactory.getLogger(AbstractScanner.class);</span>

  public static final String JOB_PARAM_PARENT = &quot;parent&quot;;
  /** The key whose value will be used to determine if a scanner is enabled or disabled.*/
  public static final String PARAM_KEY_ENABLED = &quot;enabled&quot;;
  /** The key whose value will be a cron expression to determine how often the Scanner scans.*/
  public static final String PARAM_KEY_CRON_EXPR = &quot;cron-expression&quot;;

  /** The quartz scheduler */
  protected Scheduler quartz;

  /** Is the scanner enabled? */
<span class="fc" id="L66">  private boolean enabled = false;</span>

  /** Cron schedule expression */
<span class="fc" id="L69">  private String cronExpression = &quot;0 0 2 * * ?&quot;; // every day at 2:00 am</span>

  /** Reference to the service registry */
  private ServiceRegistry serviceRegistry;

  /** Reference to the security service */
  private SecurityService securityService;

  /** Reference to the organization directory service */
  private OrganizationDirectoryService directoryService;

  private String systemUserName;

  /** The name of the job group to schedule this quartz job under. */
  public abstract String getJobGroup();

  /** The name of the job */
  public abstract String getJobName();

  /** The name of the group to store the quartz triggers under. */
  public abstract String getTriggerGroupName();

  /** The name of the triggers to use for the quartz jobs. */
  public abstract String getTriggerName();

  /** The name of the scanner to use in log files. */
  public abstract String getScannerName();

  public abstract void scan();

  /** Returns a cron style statement that defines how often this scanner will run. */
  public String getCronExpression() {
<span class="fc" id="L101">    return cronExpression;</span>
  }

  public void setCronExpression(String cronExpression) {
<span class="fc" id="L105">    this.cronExpression = cronExpression;</span>
<span class="fc" id="L106">  }</span>

  /**
   * @return Returns the current quartz scheduler used to schedule scanning jobs.
   */
  protected Scheduler getQuartz() {
<span class="fc" id="L112">    return quartz;</span>
  }

  protected void setQuartz(Scheduler quartz) {
<span class="fc" id="L116">    this.quartz = quartz;</span>
<span class="fc" id="L117">  }</span>

  /** True if this scanner should be enabled. */
  public boolean isEnabled() {
<span class="fc" id="L121">    return enabled;</span>
  }

  public void setEnabled(boolean enabled) {
<span class="fc" id="L125">    this.enabled = enabled;</span>
<span class="fc" id="L126">  }</span>

  /**
   * Schedule the scanning job to execute according to the cron schedule.
   */
  public void schedule() {
<span class="fc bfc" id="L132" title="All 2 branches covered.">    if (!isEnabled()) {</span>
<span class="fc" id="L133">      logger.info(getScannerName() + &quot; is disabled&quot;);</span>
<span class="fc" id="L134">      return;</span>
    }

<span class="fc bfc" id="L137" title="All 2 branches covered.">    if (quartz == null) {</span>
<span class="fc" id="L138">      logger.warn(&quot;No quartz scheduler available to schedule scanner.&quot;);</span>
<span class="fc" id="L139">      return;</span>
    }

<span class="fc" id="L142">    logger.info(&quot;Schedule &quot; + getScannerName() + &quot; as a cron job ({})&quot;, getCronExpression());</span>
    try {
<span class="fc" id="L144">      final CronTrigger trigger = new CronTrigger();</span>
<span class="fc" id="L145">      trigger.setCronExpression(getCronExpression());</span>
<span class="fc" id="L146">      trigger.setName(getTriggerName());</span>
<span class="fc" id="L147">      trigger.setGroup(getTriggerGroupName());</span>
<span class="fc" id="L148">      trigger.setJobName(getJobName());</span>
<span class="fc" id="L149">      trigger.setJobGroup(getJobGroup());</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">      if (getQuartz().getTriggersOfJob(getJobName(), getJobGroup()).length == 0) {</span>
<span class="fc" id="L151">        getQuartz().scheduleJob(trigger);</span>
      } else {
<span class="fc" id="L153">        getQuartz().rescheduleJob(getTriggerName(), getTriggerGroupName(), trigger);</span>
      }
<span class="fc" id="L155">    } catch (ParseException e) {</span>
<span class="fc" id="L156">      logger.error(&quot;Error scheduling &quot; + getScannerName() + &quot;, the cron expression '{}' could not be parsed: {}&quot;,</span>
<span class="fc" id="L157">              getCronExpression(), e.getMessage());</span>
<span class="fc" id="L158">    } catch (Exception e) {</span>
<span class="fc" id="L159">      logger.error(&quot;Error scheduling &quot; + getScannerName(), e);</span>
<span class="fc" id="L160">    }</span>
<span class="fc" id="L161">  }</span>

  /**
   * Unschedule the scanning job.
   */
  public void unschedule() {
    try {
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">      if (quartz != null) {</span>
<span class="fc" id="L169">        quartz.unscheduleJob(getTriggerName(), getTriggerGroupName());</span>
      }
<span class="fc" id="L171">    } catch (SchedulerException e) {</span>
<span class="fc" id="L172">      logger.error(&quot;Error unscheduling &quot; + getScannerName(), e);</span>
<span class="fc" id="L173">    }</span>
<span class="fc" id="L174">  }</span>

  /** OSGi callback to set organization directory service */
  protected void bindOrganizationDirectoryService(OrganizationDirectoryService directoryService) {
<span class="nc" id="L178">    this.directoryService = directoryService;</span>
<span class="nc" id="L179">  }</span>

  /** OSGi callback to set security service */
  protected void bindSecurityService(SecurityService securityService) {
<span class="nc" id="L183">    this.securityService = securityService;</span>
<span class="nc" id="L184">  }</span>

  protected void bindServiceRegistry(ServiceRegistry serviceRegistry) {
<span class="nc" id="L187">    this.serviceRegistry = serviceRegistry;</span>
<span class="nc" id="L188">  }</span>

  /** Get an organization directory service */
  public OrganizationDirectoryService getOrganizationDirectoryService() {
<span class="nc" id="L192">    return directoryService;</span>
  }

  /**
   * Get a system administrator context for the given organization id.
   * @param orgId The organization's id.
   * @return A SecurityContext for the admin.
   */
  public SecurityContext getAdminContextFor(String orgId) {
    try {
<span class="nc" id="L202">      final Organization org = directoryService.getOrganization(orgId);</span>
<span class="nc" id="L203">      return new SecurityContext(securityService, org, createSystemUser(systemUserName, org));</span>
<span class="nc" id="L204">    } catch (Exception e) {</span>
<span class="nc" id="L205">      throw new Error(e);</span>
    }
  }

  /** Get a service registry */
  public ServiceRegistry getServiceRegistry() {
<span class="nc" id="L211">    return this.serviceRegistry;</span>
  }

  /** The user name to run this scanner job under. */
  public String getSystemUserName() {
<span class="nc" id="L216">    return systemUserName;</span>
  }

  /** OSGi component activate callback */
  protected void activate(ComponentContext cc) {
<span class="nc" id="L221">    systemUserName = cc.getBundleContext().getProperty(SecurityUtil.PROPERTY_KEY_SYS_USER);</span>
<span class="nc" id="L222">  }</span>

  /** OSGi deactivate component callback. */
  public void deactivate() {
<span class="nc" id="L226">    shutdown();</span>
<span class="nc" id="L227">  }</span>

  /** Shutdown the scheduler. */
  public void shutdown() {
    try {
<span class="fc bfc" id="L232" title="All 2 branches covered.">      if (quartz != null) {</span>
<span class="fc" id="L233">        quartz.shutdown();</span>
      }
<span class="fc" id="L235">    } catch (org.quartz.SchedulerException e) {</span>
<span class="fc" id="L236">      logger.debug(&quot;Exception while shutting down quartz scheduler this will be ignored:&quot;, e);</span>
<span class="fc" id="L237">    }</span>
<span class="fc" id="L238">  }</span>

  /** Trigger the scheduler once independent of it's actual schedule. */
  public void trigger() {
    try {
<span class="fc" id="L243">      quartz.triggerJobWithVolatileTrigger(getJobName(), getJobGroup());</span>
<span class="fc" id="L244">    } catch (Exception e) {</span>
<span class="fc" id="L245">      logger.error(&quot;Error triggering Quartz job&quot;, e);</span>
<span class="fc" id="L246">    }</span>
<span class="fc" id="L247">  }</span>

  /** Just to make sure Quartz is being shut down... */
  @Override
  protected void finalize() throws Throwable {
<span class="fc" id="L252">    super.finalize();</span>
<span class="fc" id="L253">    shutdown();</span>
<span class="fc" id="L254">  }</span>


  /**
   * Please remember that derived classes need a no-arg constructor in order to work with Quartz. Sample usage:
   *
   * &lt;pre&gt;
   * public class Runner extends TypedQuartzJob&amp;lt;Scheduler&amp;gt; {
   *   protected abstract void execute(Scheduler parameters, JobExecutionContext ctx) {
   *     // type safe parameter access
   *     parameters.getConfig();
   *   }
   * }
   *
   * public class Scheduler {
   *   ...
   *   // create the job
   *   final JobDetail job = new JobDetail(JOB_NAME, JOB_GROUP, Runner.class);
   *   // set the scheduler as parameter source
   *   job.getJobDataMap().put(JOB_PARAM_PARENT, this);
   *   // add to Quartz scheduler
   *   quartz.addJob(job, true);
   *   ...
   *   // provide a config string
   *   public String getConfig() {...}
   * }
   * &lt;/pre&gt;
   */
  public abstract static class TypedQuartzJob&lt;A&gt; implements Job {
    private final Option&lt;NeedleEye&gt; allowParallel;

    /**
     * @param allowParallel
     *          Pass a needle eye if only one job may be run at a time. Make the needle eye static to the inheriting
     *          class.
     */
<span class="nc" id="L290">    protected TypedQuartzJob(Option&lt;NeedleEye&gt; allowParallel) {</span>
<span class="nc" id="L291">      this.allowParallel = allowParallel;</span>
<span class="nc" id="L292">    }</span>

    @Override
    public final void execute(final JobExecutionContext ctx) throws JobExecutionException {
<span class="nc bnc" id="L296" title="All 2 branches missed.">      for (NeedleEye eye : allowParallel) {</span>
<span class="nc" id="L297">        eye.apply(executeF(ctx));</span>
<span class="nc" id="L298">        return;</span>
      }
<span class="nc" id="L300">      executeF(ctx).apply();</span>
<span class="nc" id="L301">    }</span>

    /** Typesafe replacement for {@link #execute(org.quartz.JobExecutionContext)}. */
    protected abstract void execute(A parameters, JobExecutionContext ctx);

    private Function0&lt;Integer&gt; executeF(final JobExecutionContext ctx) {
<span class="nc" id="L307">      return new Function0.X&lt;Integer&gt;() {</span>
        @Override
        public Integer xapply() throws Exception {
          try {
<span class="nc" id="L311">            execute((A) ctx.getJobDetail().getJobDataMap().get(JOB_PARAM_PARENT), ctx);</span>
<span class="nc" id="L312">            return 0;</span>
<span class="nc" id="L313">          } catch (Exception e) {</span>
<span class="nc" id="L314">            logger.error(&quot;An error occurred while harvesting schedule&quot;, e);</span>
<span class="nc" id="L315">            throw new JobExecutionException(&quot;An error occurred while harvesting schedule&quot;, e);</span>
          }
        }
      };
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>