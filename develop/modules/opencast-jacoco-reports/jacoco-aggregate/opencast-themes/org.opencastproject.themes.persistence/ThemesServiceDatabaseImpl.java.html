<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ThemesServiceDatabaseImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-themes</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.themes.persistence</a> &gt; <span class="el_source">ThemesServiceDatabaseImpl.java</span></div><h1>ThemesServiceDatabaseImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.themes.persistence;

import static org.opencastproject.db.Queries.namedQuery;

import org.opencastproject.db.DBSession;
import org.opencastproject.db.DBSessionFactory;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.UserDirectoryService;
import org.opencastproject.themes.Theme;
import org.opencastproject.themes.ThemesServiceDatabase;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.requests.SortCriterion;

import org.apache.commons.lang3.tuple.Pair;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.function.Function;
import java.util.stream.Collectors;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.TypedQuery;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Expression;
import javax.persistence.criteria.Order;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;

/**
 * Implements {@link ThemesServiceDatabase}. Defines permanent storage for themes.
 */
@Component(
    immediate = true,
    service = { ThemesServiceDatabase.class },
    property = {
        &quot;service.description=Themes Database Service&quot;
    }
)
<span class="fc" id="L69">public class ThemesServiceDatabaseImpl implements ThemesServiceDatabase {</span>

  public static final String PERSISTENCE_UNIT = &quot;org.opencastproject.themes&quot;;

  /** Logging utilities */
<span class="fc" id="L74">  private static final Logger logger = LoggerFactory.getLogger(ThemesServiceDatabaseImpl.class);</span>

  /** Factory used to create {@link EntityManager}s for transactions */
  protected EntityManagerFactory emf;

  protected DBSessionFactory dbSessionFactory;

  protected DBSession db;

  /** The security service */
  protected SecurityService securityService;

  /** The user directory service */
  protected UserDirectoryService userDirectoryService;

  /** The component context for this themes service database */
  private ComponentContext cc;

  /**
   * Creates {@link EntityManagerFactory} using persistence provider and properties passed via OSGi.
   *
   * @param cc
   */
  @Activate
  public void activate(ComponentContext cc) {
<span class="fc" id="L99">    logger.info(&quot;Activating persistence manager for themes&quot;);</span>
<span class="fc" id="L100">    this.cc = cc;</span>
<span class="fc" id="L101">    db = dbSessionFactory.createSession(emf);</span>
<span class="fc" id="L102">  }</span>

  /** OSGi DI */
  @Reference(target = &quot;(osgi.unit.name=org.opencastproject.themes)&quot;)
  public void setEntityManagerFactory(EntityManagerFactory emf) {
<span class="fc" id="L107">    this.emf = emf;</span>
<span class="fc" id="L108">  }</span>

  @Reference
  public void setDBSessionFactory(DBSessionFactory dbSessionFactory) {
<span class="fc" id="L112">    this.dbSessionFactory = dbSessionFactory;</span>
<span class="fc" id="L113">  }</span>

  /**
   * OSGi callback to set the security service.
   *
   * @param securityService
   *          the security service
   */
  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="fc" id="L123">    this.securityService = securityService;</span>
<span class="fc" id="L124">  }</span>

  /**
   * OSGi callback to set the user directory service
   *
   * @param userDirectoryService
   *          the user directory service
   */
  @Reference
  public void setUserDirectoryService(UserDirectoryService userDirectoryService) {
<span class="fc" id="L134">    this.userDirectoryService = userDirectoryService;</span>
<span class="fc" id="L135">  }</span>

  @Override
  public Theme getTheme(long id) throws ThemesServiceDatabaseException, NotFoundException {
    try {
<span class="fc" id="L140">      return db.exec(getThemeDtoQuery(id))</span>
<span class="fc" id="L141">          .map(t -&gt; t.toTheme(userDirectoryService))</span>
<span class="fc" id="L142">          .orElseThrow(() -&gt; new NotFoundException(&quot;No theme with id=&quot; + id + &quot; exists&quot;));</span>
<span class="fc" id="L143">    } catch (NotFoundException e) {</span>
<span class="fc" id="L144">      throw e;</span>
<span class="nc" id="L145">    } catch (Exception e) {</span>
<span class="nc" id="L146">      logger.error(&quot;Could not get theme&quot;, e);</span>
<span class="nc" id="L147">      throw new ThemesServiceDatabaseException(e);</span>
    }
  }

  private List&lt;Theme&gt; getThemes() throws ThemesServiceDatabaseException {
    try {
<span class="nc" id="L153">      String orgId = securityService.getOrganization().getId();</span>
<span class="nc" id="L154">      return db.exec(namedQuery.findAll(</span>
          &quot;Themes.findByOrg&quot;,
              ThemeDto.class,
<span class="nc" id="L157">              Pair.of(&quot;org&quot;, orgId)</span>
<span class="nc" id="L158">          )).stream()</span>
<span class="nc" id="L159">          .map(t -&gt; t.toTheme(userDirectoryService))</span>
<span class="nc" id="L160">          .collect(Collectors.toList());</span>
<span class="nc" id="L161">    } catch (Exception e) {</span>
<span class="nc" id="L162">      logger.error(&quot;Could not get themes&quot;, e);</span>
<span class="nc" id="L163">      throw new ThemesServiceDatabaseException(e);</span>
    }
  }

  public List&lt;Theme&gt; findThemes(
      Optional&lt;Integer&gt; limit,
      Optional&lt;Integer&gt; offset,
      ArrayList&lt;SortCriterion&gt; sortCriteria,
      Optional&lt;String&gt; creatorFilter,
      Optional&lt;String&gt; textFilter
  ) {
<span class="fc" id="L174">    String orgId = securityService.getOrganization().getId();</span>

<span class="fc" id="L176">    return db.execTxChecked(em -&gt; {</span>
<span class="fc" id="L177">      CriteriaBuilder cb = em.getCriteriaBuilder();</span>
<span class="fc" id="L178">      final CriteriaQuery&lt;ThemeDto&gt; query = cb.createQuery(ThemeDto.class);</span>
<span class="fc" id="L179">      Root&lt;ThemeDto&gt; theme = query.from(ThemeDto.class);</span>
<span class="fc" id="L180">      query.select(theme);</span>
<span class="fc" id="L181">      query.distinct(true);</span>

      // filter
<span class="fc" id="L184">      List&lt;Predicate&gt; conditions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L185">      conditions.add(cb.equal(theme.get(&quot;organization&quot;), orgId));</span>

      // exact match, case sensitive
<span class="fc bfc" id="L188" title="All 2 branches covered.">      if (creatorFilter.isPresent()) {</span>
<span class="fc" id="L189">        conditions.add(cb.equal(theme.get(&quot;username&quot;), creatorFilter.get()));</span>
      }
      // not exact match, case-insensitive, each token needs to match at least one field
<span class="fc bfc" id="L192" title="All 2 branches covered.">      if (textFilter.isPresent()) {</span>
<span class="fc" id="L193">        List&lt;Predicate&gt; fulltextConditions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L194">        String[] tokens = textFilter.get().split(&quot;\\s+&quot;);</span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">        for (String token: tokens) {</span>
<span class="fc" id="L196">          List&lt;Predicate&gt; fieldConditions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L197">          Expression&lt;String&gt; literal = cb.literal(&quot;%&quot; + token + &quot;%&quot;);</span>

<span class="fc" id="L199">          fieldConditions.add(cb.like(cb.lower(theme.get(&quot;username&quot;)), cb.lower(literal)));</span>
<span class="fc" id="L200">          fieldConditions.add(cb.like(cb.lower(theme.get(&quot;name&quot;)), cb.lower(literal)));</span>
<span class="fc" id="L201">          fieldConditions.add(cb.like(cb.lower(theme.get(&quot;description&quot;)), cb.lower(literal)));</span>

          // token needs to match at least one field
<span class="fc" id="L204">          fulltextConditions.add(cb.or(fieldConditions.toArray(new Predicate[0])));</span>
        }
        // all token have to match something
        // (different to fulltext search for Elasticsearch, where only one token has to match!)
<span class="fc" id="L208">        conditions.add(cb.and(fulltextConditions.toArray(new Predicate[0])));</span>
      }
<span class="fc" id="L210">      query.where(cb.and(conditions.toArray(new Predicate[0])));</span>

      // sort
<span class="fc" id="L213">      List&lt;Order&gt; orders = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">      for (SortCriterion criterion : sortCriteria) {</span>
<span class="fc" id="L215">        String fieldName = criterion.getFieldName();</span>
<span class="pc bpc" id="L216" title="4 of 6 branches missed.">        switch(fieldName) {</span>
          case &quot;name&quot;:
<span class="fc" id="L218">            break;</span>
          case &quot;description&quot;:
<span class="nc" id="L220">            break;</span>
          case &quot;creator&quot;:
<span class="nc" id="L222">            fieldName = &quot;username&quot;;</span>
<span class="nc" id="L223">            break;</span>
          case &quot;default&quot;:
<span class="nc" id="L225">            fieldName = &quot;isDefault&quot;;</span>
<span class="nc" id="L226">            break;</span>
          case &quot;creation_date&quot;:
<span class="fc" id="L228">            fieldName = &quot;creationDate&quot;;</span>
<span class="fc" id="L229">            break;</span>
          default:
<span class="nc" id="L231">            throw new IllegalArgumentException(&quot;Sorting criterion &quot; + criterion.getFieldName() + &quot; is not supported &quot;</span>
                + &quot;for themes.&quot;);
        }

<span class="fc" id="L235">        Expression expression = theme.get(fieldName);</span>
<span class="fc bfc" id="L236" title="All 2 branches covered.">        if (criterion.getOrder() == SortCriterion.Order.Ascending) {</span>
<span class="fc" id="L237">          orders.add(cb.asc(expression));</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">        } else if (criterion.getOrder() == SortCriterion.Order.Descending) {</span>
<span class="fc" id="L239">          orders.add(cb.desc(expression));</span>
        }

<span class="fc" id="L242">      }</span>
<span class="fc" id="L243">      query.orderBy(orders);</span>

      // other
<span class="fc" id="L246">      TypedQuery&lt;ThemeDto&gt; typedQuery = em.createQuery(query);</span>
<span class="fc bfc" id="L247" title="All 2 branches covered.">      if (limit.isPresent()) {</span>
<span class="fc" id="L248">        typedQuery.setMaxResults(limit.get());</span>
      }
<span class="fc bfc" id="L250" title="All 2 branches covered.">      if (offset.isPresent()) {</span>
<span class="fc" id="L251">        typedQuery.setFirstResult(offset.get());</span>
      }

<span class="fc" id="L254">      return typedQuery.getResultList().stream()</span>
<span class="fc" id="L255">          .map(t -&gt; t.toTheme(userDirectoryService))</span>
<span class="fc" id="L256">          .collect(Collectors.toList());</span>
    });
  }

  @Override
  public Theme updateTheme(final Theme theme) throws ThemesServiceDatabaseException {
    try {
<span class="fc" id="L263">      Theme newTheme = db.execTxChecked(em -&gt; {</span>
<span class="fc" id="L264">        ThemeDto themeDto = null;</span>
<span class="fc bfc" id="L265" title="All 2 branches covered.">        if (theme.getId().isSome()) {</span>
<span class="fc" id="L266">          themeDto = getThemeDtoQuery(theme.getId().get()).apply(em).orElse(null);</span>
        }

<span class="fc bfc" id="L269" title="All 2 branches covered.">        if (themeDto == null) {</span>
          // no theme stored, create new entity
<span class="fc" id="L271">          themeDto = new ThemeDto();</span>
<span class="fc" id="L272">          themeDto.setOrganization(securityService.getOrganization().getId());</span>
<span class="fc" id="L273">          updateTheme(theme, themeDto);</span>
<span class="fc" id="L274">          em.persist(themeDto);</span>
        } else {
<span class="fc" id="L276">          updateTheme(theme, themeDto);</span>
<span class="fc" id="L277">          em.merge(themeDto);</span>
        }

<span class="fc" id="L280">        return themeDto.toTheme(userDirectoryService);</span>
      });

<span class="fc" id="L283">      return newTheme;</span>
<span class="nc" id="L284">    } catch (Exception e) {</span>
<span class="nc" id="L285">      logger.error(&quot;Could not update theme {}&quot;, theme, e);</span>
<span class="nc" id="L286">      throw new ThemesServiceDatabaseException(e);</span>
    }
  }

  private void updateTheme(Theme theme, ThemeDto themeDto) {
<span class="fc bfc" id="L291" title="All 2 branches covered.">    if (theme.getId().isSome()) {</span>
<span class="fc" id="L292">      themeDto.setId(theme.getId().get());</span>
    }
<span class="fc" id="L294">    themeDto.setUsername(theme.getCreator().getUsername());</span>
<span class="fc" id="L295">    themeDto.setCreationDate(theme.getCreationDate());</span>
<span class="fc" id="L296">    themeDto.setDefault(theme.isDefault());</span>
<span class="fc" id="L297">    themeDto.setName(theme.getName());</span>
<span class="fc" id="L298">    themeDto.setDescription(theme.getDescription());</span>
<span class="fc" id="L299">    themeDto.setBumperActive(theme.isBumperActive());</span>
<span class="fc" id="L300">    themeDto.setBumperFile(theme.getBumperFile());</span>
<span class="fc" id="L301">    themeDto.setTrailerActive(theme.isTrailerActive());</span>
<span class="fc" id="L302">    themeDto.setTrailerFile(theme.getTrailerFile());</span>
<span class="fc" id="L303">    themeDto.setTitleSlideActive(theme.isTitleSlideActive());</span>
<span class="fc" id="L304">    themeDto.setTitleSlideBackground(theme.getTitleSlideBackground());</span>
<span class="fc" id="L305">    themeDto.setTitleSlideMetadata(theme.getTitleSlideMetadata());</span>
<span class="fc" id="L306">    themeDto.setLicenseSlideActive(theme.isLicenseSlideActive());</span>
<span class="fc" id="L307">    themeDto.setLicenseSlideBackground(theme.getLicenseSlideBackground());</span>
<span class="fc" id="L308">    themeDto.setLicenseSlideDescription(theme.getLicenseSlideDescription());</span>
<span class="fc" id="L309">    themeDto.setWatermarkActive(theme.isWatermarkActive());</span>
<span class="fc" id="L310">    themeDto.setWatermarkFile(theme.getWatermarkFile());</span>
<span class="fc" id="L311">    themeDto.setWatermarkPosition(theme.getWatermarkPosition());</span>
<span class="fc" id="L312">  }</span>

  @Override
  public void deleteTheme(long id) throws ThemesServiceDatabaseException, NotFoundException {
    try {
<span class="fc" id="L317">      db.execTxChecked(em -&gt; {</span>
<span class="fc" id="L318">        ThemeDto themeDto = getThemeDtoQuery(id).apply(em)</span>
<span class="pc" id="L319">            .orElseThrow(() -&gt; new NotFoundException(&quot;No theme with id=&quot; + id + &quot; exists&quot;));</span>
<span class="fc" id="L320">        namedQuery.remove(themeDto).accept(em);</span>
<span class="fc" id="L321">      });</span>
<span class="nc" id="L322">    } catch (NotFoundException e) {</span>
<span class="nc" id="L323">      throw e;</span>
<span class="nc" id="L324">    } catch (Exception e) {</span>
<span class="nc" id="L325">      logger.error(&quot;Could not delete theme '{}'&quot;, id, e);</span>
<span class="nc" id="L326">      throw new ThemesServiceDatabaseException(e);</span>
<span class="fc" id="L327">    }</span>
<span class="fc" id="L328">  }</span>

  @Override
  public int countThemes() throws ThemesServiceDatabaseException {
    try {
<span class="fc" id="L333">      String orgId = securityService.getOrganization().getId();</span>
<span class="fc" id="L334">      return db.exec(namedQuery.find(</span>
          &quot;Themes.count&quot;,
          Number.class,
<span class="fc" id="L337">          Pair.of(&quot;org&quot;, orgId)</span>
<span class="fc" id="L338">      )).intValue();</span>
<span class="nc" id="L339">    } catch (Exception e) {</span>
<span class="nc" id="L340">      logger.error(&quot;Could not count themes&quot;, e);</span>
<span class="nc" id="L341">      throw new ThemesServiceDatabaseException(e);</span>
    }
  }

  /**
   * Gets a theme by its ID, using the current organizational context.
   *
   * @param id
   *          the theme identifier
   * @return a query function returning an optional theme entity
   */
  private Function&lt;EntityManager, Optional&lt;ThemeDto&gt;&gt; getThemeDtoQuery(long id) {
<span class="fc" id="L353">    String orgId = securityService.getOrganization().getId();</span>
<span class="fc" id="L354">    return namedQuery.findOpt(</span>
        &quot;Themes.findById&quot;,
        ThemeDto.class,
<span class="fc" id="L357">        Pair.of(&quot;id&quot;, id),</span>
<span class="fc" id="L358">        Pair.of(&quot;org&quot;, orgId)</span>
    );
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>