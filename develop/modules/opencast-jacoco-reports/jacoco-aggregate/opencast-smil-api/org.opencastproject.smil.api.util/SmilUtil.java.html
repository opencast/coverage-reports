<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SmilUtil.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-smil-api</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.smil.api.util</a> &gt; <span class="el_source">SmilUtil.java</span></div><h1>SmilUtil.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.smil.api.util;

import org.opencastproject.mediapackage.Catalog;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.mediapackage.MediaPackageElement;
import org.opencastproject.mediapackage.MediaPackageElementFlavor;
import org.opencastproject.mediapackage.selector.AbstractMediaPackageElementSelector;
import org.opencastproject.mediapackage.selector.CatalogSelector;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.XmlUtil;
import org.opencastproject.util.data.Either;
import org.opencastproject.util.data.functions.Misc;
import org.opencastproject.workspace.api.Workspace;

import com.android.mms.dom.smil.parser.SmilXmlParser;

import org.apache.commons.httpclient.util.URIUtil;
import org.apache.commons.io.IOUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.smil.SMILDocument;
import org.xml.sax.InputSource;
import org.xml.sax.SAXException;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.URI;
import java.util.Collection;

/**
 * General purpose utility functions for dealing with SMIL.
 */
public final class SmilUtil {

<span class="fc" id="L60">  private static final Logger logger = LoggerFactory.getLogger(SmilUtil.class);</span>

  public static final String SMIL_NODE_NAME = &quot;smil&quot;;
  public static final String SMIL_NS_URI = &quot;http://www.w3.org/ns/SMIL&quot;;

<span class="fc" id="L65">  public enum TrackType {</span>
<span class="fc" id="L66">    PRESENTER, PRESENTATION</span>
  }

  private SmilUtil() {
  }

  /**
   * Load the SMIL document identified by &lt;code&gt;mpe&lt;/code&gt;. Throws an exception if it does not exist or cannot be loaded
   * by any reason.
   *
   * @return the document
   */
  public static Document loadSmilDocument(InputStream in, MediaPackageElement mpe) {
    try {
<span class="nc" id="L80">      Either&lt;Exception, org.w3c.dom.Document&gt; eitherDocument = XmlUtil.parseNs(new InputSource(in));</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">      if (eitherDocument.isRight()) {</span>
<span class="nc" id="L82">        return eitherDocument.right().value();</span>
      }

<span class="nc" id="L85">      throw eitherDocument.left().value();</span>
<span class="nc" id="L86">    } catch (Exception e) {</span>
<span class="nc" id="L87">      logger.warn(&quot;Unable to load smil document from catalog '{}'&quot;, mpe, e);</span>
<span class="nc" id="L88">      return Misc.chuck(e);</span>
    }
  }

  /**
   * Creates a skeleton SMIL document
   *
   * @return the SMIL document
   */
  public static Document createSmil() {
<span class="fc" id="L98">    Document smilDocument = XmlUtil.newDocument();</span>
<span class="fc" id="L99">    smilDocument.setXmlVersion(&quot;1.1&quot;);</span>
<span class="fc" id="L100">    Element smil = smilDocument.createElementNS(SMIL_NS_URI, SMIL_NODE_NAME);</span>
<span class="fc" id="L101">    smil.setAttribute(&quot;version&quot;, &quot;3.0&quot;);</span>
<span class="fc" id="L102">    smilDocument.appendChild(smil);</span>
<span class="fc" id="L103">    Node head = smilDocument.createElement(&quot;head&quot;);</span>
<span class="fc" id="L104">    smil.appendChild(head);</span>
<span class="fc" id="L105">    Node body = smilDocument.createElement(&quot;body&quot;);</span>
<span class="fc" id="L106">    smil.appendChild(body);</span>
<span class="fc" id="L107">    Element parallel = smilDocument.createElement(&quot;par&quot;);</span>
<span class="fc" id="L108">    parallel.setAttribute(&quot;dur&quot;, &quot;0ms&quot;);</span>
<span class="fc" id="L109">    body.appendChild(parallel);</span>
<span class="fc" id="L110">    return smilDocument;</span>
  }

  /**
   * Adds a track to the SMIL document.
   *
   * @param smilDocument
   *          the SMIL document
   * @param trackType
   *          the track type
   * @param hasVideo
   *          whether the track has a video stream
   * @param startTime
   *          the start time
   * @param duration
   *          the duration
   * @param uri
   *          the track URI
   * @param trackId
   *          the Id of the track
   * @return the augmented SMIL document
   */
  public static Document addTrack(Document smilDocument, TrackType trackType, boolean hasVideo, long startTime,
          long duration, URI uri, String trackId) {
<span class="fc" id="L134">    Element parallel = (Element) smilDocument.getElementsByTagName(&quot;par&quot;).item(0);</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">    if (parallel.getChildNodes().getLength() == 0) {</span>
<span class="fc" id="L136">      Node presenterSeq = smilDocument.createElement(&quot;seq&quot;);</span>
<span class="fc" id="L137">      parallel.appendChild(presenterSeq);</span>
<span class="fc" id="L138">      Node presentationSeq = smilDocument.createElement(&quot;seq&quot;);</span>
<span class="fc" id="L139">      parallel.appendChild(presentationSeq);</span>
    }

<span class="fc" id="L142">    String trackDurationString = parallel.getAttribute(&quot;dur&quot;);</span>
<span class="fc" id="L143">    Long oldTrackDuration = Long.parseLong(trackDurationString.substring(0, trackDurationString.indexOf(&quot;ms&quot;)));</span>
<span class="fc" id="L144">    Long newTrackDuration = startTime + duration;</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">    if (newTrackDuration &gt; oldTrackDuration) {</span>
<span class="fc" id="L146">      parallel.setAttribute(&quot;dur&quot;, newTrackDuration + &quot;ms&quot;);</span>
    }

    Node sequence;
<span class="pc bpc" id="L150" title="1 of 3 branches missed.">    switch (trackType) {</span>
      case PRESENTER:
<span class="fc" id="L152">        sequence = parallel.getChildNodes().item(0);</span>
<span class="fc" id="L153">        break;</span>
      case PRESENTATION:
<span class="fc" id="L155">        sequence = parallel.getChildNodes().item(1);</span>
<span class="fc" id="L156">        break;</span>
      default:
<span class="nc" id="L158">        throw new IllegalStateException(&quot;Unknown track type &quot; + trackType.toString());</span>
    }

<span class="fc bfc" id="L161" title="All 2 branches covered.">    Element element = smilDocument.createElement(hasVideo ? &quot;video&quot; : &quot;audio&quot;);</span>
<span class="fc" id="L162">    element.setAttribute(&quot;begin&quot;, Long.toString(startTime) + &quot;ms&quot;);</span>
<span class="fc" id="L163">    element.setAttribute(&quot;dur&quot;, Long.toString(duration) + &quot;ms&quot;);</span>
<span class="fc" id="L164">    element.setAttribute(&quot;src&quot;, URIUtil.getPath(uri.toString()));</span>
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">    if (trackId != null) {</span>
<span class="fc" id="L166">      element.setAttribute(&quot;xml:id&quot;, trackId);</span>
    }
<span class="fc" id="L168">    sequence.appendChild(element);</span>
<span class="fc" id="L169">    return smilDocument;</span>
  }


  public static SMILDocument getSmilDocumentFromMediaPackage(MediaPackage mp, MediaPackageElementFlavor smilFlavor,
      Workspace workspace)
          throws IOException, SAXException, NotFoundException {
<span class="fc" id="L176">    final AbstractMediaPackageElementSelector&lt;Catalog&gt; smilSelector = new CatalogSelector();</span>
<span class="fc" id="L177">    smilSelector.addFlavor(smilFlavor);</span>
<span class="fc" id="L178">    final Collection&lt;Catalog&gt; smilCatalog = smilSelector.select(mp, false);</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">    if (smilCatalog.size() == 1) {</span>
<span class="fc" id="L180">      return getSmilDocument(smilCatalog.iterator().next(), workspace);</span>
    } else {
<span class="fc" id="L182">      logger.error(&quot;More or less than one smil catalog found: {}&quot;, smilCatalog);</span>
<span class="fc" id="L183">      throw new IllegalStateException(&quot;More or less than one smil catalog found!&quot;);</span>
    }
  }

  /** Get the SMIL document from a catalog. */
  private static SMILDocument getSmilDocument(final Catalog smilCatalog, Workspace workspace) throws NotFoundException,
          IOException, SAXException {
<span class="fc" id="L190">    FileInputStream in = null;</span>
    try {
<span class="fc" id="L192">      File smilXmlFile = workspace.get(smilCatalog.getURI());</span>
<span class="fc" id="L193">      SmilXmlParser smilParser = new SmilXmlParser();</span>
<span class="fc" id="L194">      in = new FileInputStream(smilXmlFile);</span>
<span class="fc" id="L195">      return smilParser.parse(in);</span>
    } finally {
<span class="fc" id="L197">      IOUtils.closeQuietly(in);</span>
    }
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>