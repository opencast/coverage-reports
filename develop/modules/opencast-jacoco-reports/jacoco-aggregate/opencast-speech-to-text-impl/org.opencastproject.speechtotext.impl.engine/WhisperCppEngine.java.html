<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>WhisperCppEngine.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-speech-to-text-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.speechtotext.impl.engine</a> &gt; <span class="el_source">WhisperCppEngine.java</span></div><h1>WhisperCppEngine.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.speechtotext.impl.engine;

import org.opencastproject.speechtotext.api.SpeechToTextEngine;
import org.opencastproject.speechtotext.api.SpeechToTextEngineException;
import org.opencastproject.speechtotext.util.LangCodeUtil;
import org.opencastproject.util.IoSupport;
import org.opencastproject.util.OsgiUtil;
import org.opencastproject.util.data.Option;
import org.opencastproject.util.data.functions.Strings;

import org.apache.commons.io.FileUtils;
import org.apache.commons.io.FilenameUtils;
import org.apache.commons.io.IOUtils;
import org.apache.commons.lang3.BooleanUtils;
import org.apache.commons.lang3.StringUtils;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Modified;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Locale;
import java.util.Objects;
import java.util.UUID;

/** WhisperC++ implementation of the Speech-to-text engine interface. */
@Component(
    property = {
        &quot;service.description=WhisperC++ implementation of the SpeechToTextEngine interface&quot;,
        &quot;enginetype=whispercpp&quot;
    }
)

<span class="nc" id="L67">public class WhisperCppEngine implements SpeechToTextEngine {</span>

<span class="nc" id="L69">  private static final Logger logger = LoggerFactory.getLogger(WhisperCppEngine.class);</span>

  /** Name of the engine. */
  private static final String engineName = &quot;WhisperC++&quot;;

  /** Config key for setting the path to WhisperC++. */
  private static final String WHISPERCPP_EXECUTABLE_PATH_CONFIG_KEY = &quot;whispercpp.root.path&quot;;

  /** Default path to WhisperC++. */
  public static final String WHISPERCPP_EXECUTABLE_DEFAULT_PATH = &quot;whisper-cli&quot;;

  /** Currently used path of the WhisperC++ installation. */
<span class="nc" id="L81">  private String whispercppExecutable = WHISPERCPP_EXECUTABLE_DEFAULT_PATH;</span>

  /** Config key for setting whispercpp model */
  private static final String WHISPERCPP_MODEL_CONFIG_KEY = &quot;whispercpp.model&quot;;

  /** Default whispercpp model */
  public static final String WHISPERCPP_MODEL_DEFAULT = &quot;/usr/share/whisper.cpp/models/ggml-base.bin&quot;;

  /** Currently used whispercpp model */
<span class="nc" id="L90">  private String whispercppModel = WHISPERCPP_MODEL_DEFAULT;</span>

  /** Config key for additional Whisper args */
  private static final String WHISPERCPP_ARGS_CONFIG_KEY = &quot;whispercpp.args&quot;;

  /** Currently used Whisper args */
  private String[] whispercppArgs;

  /** Config key for setting whispercpp beam size */
  private static final String WHISPERCPP_BEAM_SIZE_CONFIG_KEY = &quot;whispercpp.beam-size&quot;;

  /** Currently used whispercpp beam size */
  private Option&lt;Integer&gt; whispercppBeamSize;

  /** Config key for setting whispercpp maximum segment length */
  private static final String WHISPERCPP_MAX_LENGTH_CONFIG_KEY = &quot;whispercpp.max-len&quot;;

  /** Currently used whispercpp maximum segment length */
  private Option&lt;Integer&gt; whispercppMaxLength;

  /** Config key for setting whispercpp number of threads */
  private static final String WHISPERCPP_THREADS_CONFIG_KEY = &quot;whispercpp.threads&quot;;

  /** Currently used whispercpp number of threads */
  private Option&lt;Integer&gt; whispercppThreads;

  /** Config key for setting whispercpp number of processors */
  private static final String WHISPERCPP_PROCESSORS_CONFIG_KEY = &quot;whispercpp.processors&quot;;

  /** Currently used whispercpp number of processors */
  private Option&lt;Integer&gt; whispercppProcessors;

  /** Config key for setting whispercpp maximum context */
  private static final String WHISPERCPP_MAX_CONTEXT_CONFIG_KEY = &quot;whispercpp.max-context&quot;;

  /** Currently used whispercpp maximum context */
  private Option&lt;Integer&gt; whispercppMaxContext;

  /** Config key for setting whispercpp split on word */
  private static final String WHISPERCPP_SPLIT_ON_WORD_CONFIG_KEY = &quot;whispercpp.split-on-word&quot;;

  /** Currently used whispercpp split on word */
  private Option&lt;Boolean&gt; whispercppSplitOnWord;

  /** Config key for setting whispercpp number of best candidates to keep */
  private static final String WHISPERCPP_BEST_OF_CONFIG_KEY = &quot;whispercpp.best-of&quot;;

  /** Currently used whispercpp number of best candidates to keep */
  private Option&lt;Integer&gt; whispercppBestOf;

  /** Config key for setting whispercpp word probability threshold */
  private static final String WHISPERCPP_WORD_THRESHOLD_CONFIG_KEY = &quot;whispercpp.word-thold&quot;;

  /** Currently used whispercpp word probability threshold */
  private Option&lt;Double&gt; whispercppWordThreshold;

  /** Config key for setting whispercpp entropy threshold for decoder fail */
  private static final String WHISPERCPP_ENTROPY_THRESHOLD_CONFIG_KEY = &quot;whispercpp.entropy-thold&quot;;

  /** Currently used whispercpp entropy threshold for decoder fail */
  private Option&lt;Double&gt; whispercppEntropyThreshold;

  /** Config key for setting whispercpp log probability threshold for decoder fail */
  private static final String WHISPERCPP_LOG_PROB_THRESHOLD_CONFIG_KEY = &quot;whispercpp.logprob-thold&quot;;

  /** Currently used whispercpp log probability threshold for decoder fail */
  private Option&lt;Double&gt; whispercppLogProbThreshold;

  /** Config key for setting whispercpp diarization */
  private static final String WHISPERCPP_DIARIZATION_CONFIG_KEY = &quot;whispercpp.diarize&quot;;

  /** Currently used whispercpp diarization */
  private Option&lt;Boolean&gt; whispercppDiarization;

  /** Config key for setting whispercpp tinydiarization */
  private static final String WHISPERCPP_TINY_DIARIZATION_CONFIG_KEY = &quot;whispercpp.tinydiarize&quot;;

  /** Currently used whispercpp tinydiarization */
  private Option&lt;Boolean&gt; whispercppTinyDiarization;

  /** Config key for setting whispercpp no fallback */
  private static final String WHISPERCPP_NO_FALLBACK_CONFIG_KEY = &quot;whispercpp.no-fallback&quot;;

  /** Currently used whispercpp no fallback */
  private Option&lt;Boolean&gt; whispercppNoFallback;

  /** Config key for setting whispercpp Voice Activity Detection (VAD) */
  private static final String WHISPERCPP_VAD_CONFIG_KEY = &quot;whispercpp.vad&quot;;

  /** Currently used whispercpp Voice Activity Detection (VAD) */
  private Option&lt;Boolean&gt; whispercppVad;

  /** Config key for setting whispercpp VAD model */
  private static final String WHISPERCPP_VAD_MODEL_CONFIG_KEY = &quot;whispercpp.vad-model&quot;;

  /** Currently used whispercpp VAD model */
  private Option&lt;String&gt; whispercppVadModel;

  /** Config key for setting whispercpp VAD threshold */
  private static final String WHISPERCPP_VAD_THRESHOLD_CONFIG_KEY = &quot;whispercpp.vad-thold&quot;;

  /** Currently used whispercpp VAD threshold */
  private Option&lt;Double&gt; whispercppVadThreshold;

  /** Config key for setting whispercpp VAD min speech duration */
  private static final String WHISPERCPP_VAD_MIN_SPEECH_CONFIG_KEY = &quot;whispercpp.vad-min-speech-dur&quot;;

  /** Currently used whispercpp VAD min speech duration */
  private Option&lt;Integer&gt; whispercppVadMinSpeech;

  /** Config key for setting whispercpp VAD min silence duration */
  private static final String WHISPERCPP_VAD_MIN_SILENCE_CONFIG_KEY = &quot;whispercpp.vad-min-silence-dur&quot;;

  /** Currently used whispercpp VAD min silence duration */
  private Option&lt;Integer&gt; whispercppVadMinSilence;

  /** Config key for setting whispercpp VAD max speech duration */
  private static final String WHISPERCPP_VAD_MAX_SPEECH_CONFIG_KEY = &quot;whispercpp.vad-max-speech-dur&quot;;

  /** Currently used whispercpp VAD max speech duration */
  private Option&lt;Double&gt; whispercppVadMaxSpeech;

  /** Config key for setting whispercpp VAD speech padding */
  private static final String WHISPERCPP_VAD_SPEECH_PADDING_CONFIG_KEY = &quot;whispercpp.vad-speech-pad&quot;;

  /** Currently used whispercpp VAD speech padding */
  private Option&lt;Integer&gt; whispercppVadSpeechPadding;

  /** Config key for setting whispercpp VAD samples overlap */
  private static final String WHISPERCPP_VAD_SAMPLES_OVERLAP_CONFIG_KEY = &quot;whispercpp.vad-samples-overlap&quot;;

  /** Currently used whispercpp samples overlap */
  private Option&lt;Double&gt; whispercppVadSamplesOverlap;

  /** Config key for automatic audio encoding */
  private static final String AUTO_ENCODING_CONFIG_KEY = &quot;whispercpp.auto-encode&quot;;

  /** Default value for automatic audio encoding */
<span class="nc" id="L228">  private static final Boolean AUTO_ENCODING_DEFAULT = true;</span>

  /** If Opencast should automatically re-encode tracks so that they are compatible with Whisper.cpp */
<span class="nc" id="L231">  private boolean autoEncode = AUTO_ENCODING_DEFAULT;</span>

  /** The key to look for in the service configuration file to override the DEFAULT_FFMPEG_BINARY */
  public static final String FFMPEG_BINARY_CONFIG_KEY = &quot;org.opencastproject.composer.ffmpeg.path&quot;;

  /** The default path to the ffmpeg binary */
  public static final String DEFAULT_FFMPEG_BINARY = &quot;ffmpeg&quot;;

  /** Path to the executable */
<span class="nc" id="L240">  protected String ffmpegBinary = DEFAULT_FFMPEG_BINARY;</span>

  @Override
  public String getEngineName() {
<span class="nc" id="L244">    return engineName;</span>
  }

  @Activate
  @Modified
  public void activate(ComponentContext cc) {
<span class="nc" id="L250">    logger.debug(&quot;Activated/Modified WhisperC++ engine service class&quot;);</span>
<span class="nc" id="L251">    whispercppExecutable = StringUtils.defaultIfBlank(</span>
<span class="nc" id="L252">        (String) cc.getProperties().get(WHISPERCPP_EXECUTABLE_PATH_CONFIG_KEY), WHISPERCPP_EXECUTABLE_DEFAULT_PATH);</span>
<span class="nc" id="L253">    logger.debug(&quot;Set WhisperC++ path to {}&quot;, whispercppExecutable);</span>

<span class="nc" id="L255">    whispercppModel = StringUtils.defaultIfBlank(</span>
<span class="nc" id="L256">        (String) cc.getProperties().get(WHISPERCPP_MODEL_CONFIG_KEY), WHISPERCPP_MODEL_DEFAULT);</span>
<span class="nc" id="L257">    logger.debug(&quot;WhisperC++ Language model set to {}&quot;, whispercppModel);</span>

<span class="nc" id="L259">    whispercppBeamSize = OsgiUtil.getOptCfgAsInt(cc.getProperties(), WHISPERCPP_BEAM_SIZE_CONFIG_KEY);</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">    if (whispercppBeamSize.isSome()) {</span>
<span class="nc" id="L261">      logger.debug(&quot;WhisperC++ beam size set to {}&quot;, whispercppBeamSize);</span>
    }

<span class="nc" id="L264">    whispercppMaxLength = OsgiUtil.getOptCfgAsInt(cc.getProperties(), WHISPERCPP_MAX_LENGTH_CONFIG_KEY);</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">    if (whispercppMaxLength.isSome()) {</span>
<span class="nc" id="L266">      logger.debug(&quot;WhisperC++ maximum segment length set to {}&quot;, whispercppMaxLength);</span>
    }

<span class="nc" id="L269">    whispercppThreads = OsgiUtil.getOptCfgAsInt(cc.getProperties(), WHISPERCPP_THREADS_CONFIG_KEY);</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">    if (whispercppThreads.isSome()) {</span>
<span class="nc" id="L271">      logger.debug(&quot;WhisperC++ number of threads set to {}&quot;, whispercppThreads);</span>
    }

<span class="nc" id="L274">    whispercppProcessors = OsgiUtil.getOptCfgAsInt(cc.getProperties(), WHISPERCPP_PROCESSORS_CONFIG_KEY);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">    if (whispercppProcessors.isSome()) {</span>
<span class="nc" id="L276">      logger.debug(&quot;WhisperC++ number of processors set to {}&quot;, whispercppProcessors);</span>
    }

<span class="nc" id="L279">    whispercppMaxContext = OsgiUtil.getOptCfgAsInt(cc.getProperties(), WHISPERCPP_MAX_CONTEXT_CONFIG_KEY);</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">    if (whispercppMaxContext.isSome()) {</span>
<span class="nc" id="L281">      logger.debug(&quot;WhisperC++ max context set to {}&quot;, whispercppMaxContext);</span>
    }

<span class="nc" id="L284">    whispercppSplitOnWord = OsgiUtil.getOptCfgAsBoolean(cc.getProperties(), WHISPERCPP_SPLIT_ON_WORD_CONFIG_KEY);</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">    if (whispercppSplitOnWord.isSome()) {</span>
<span class="nc" id="L286">      logger.debug(&quot;WhisperC++ split on word set to {}&quot;, whispercppSplitOnWord);</span>
    }

<span class="nc" id="L289">    whispercppBestOf = OsgiUtil.getOptCfgAsInt(cc.getProperties(), WHISPERCPP_BEST_OF_CONFIG_KEY);</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">    if (whispercppBestOf.isSome()) {</span>
<span class="nc" id="L291">      logger.debug(&quot;WhisperC++ best of set to {}&quot;, whispercppBestOf);</span>
    }

<span class="nc" id="L294">    whispercppWordThreshold = OsgiUtil.getOptCfg(cc.getProperties(), WHISPERCPP_WORD_THRESHOLD_CONFIG_KEY).bind(</span>
        Strings.toDouble);
<span class="nc bnc" id="L296" title="All 2 branches missed.">    if (whispercppWordThreshold.isSome()) {</span>
<span class="nc" id="L297">      logger.debug(&quot;WhisperC++ word threshold set to {}&quot;, whispercppWordThreshold);</span>
    }

<span class="nc" id="L300">    whispercppEntropyThreshold = OsgiUtil.getOptCfg(cc.getProperties(), WHISPERCPP_ENTROPY_THRESHOLD_CONFIG_KEY).bind(</span>
        Strings.toDouble);
<span class="nc bnc" id="L302" title="All 2 branches missed.">    if (whispercppEntropyThreshold.isSome()) {</span>
<span class="nc" id="L303">      logger.debug(&quot;WhisperC++ entropy threshold set to {}&quot;, whispercppEntropyThreshold);</span>
    }

<span class="nc" id="L306">    whispercppLogProbThreshold = OsgiUtil.getOptCfg(cc.getProperties(), WHISPERCPP_LOG_PROB_THRESHOLD_CONFIG_KEY).bind(</span>
        Strings.toDouble);
<span class="nc bnc" id="L308" title="All 2 branches missed.">    if (whispercppLogProbThreshold.isSome()) {</span>
<span class="nc" id="L309">      logger.debug(&quot;WhisperC++ log prob threshold set to {}&quot;, whispercppLogProbThreshold);</span>
    }

<span class="nc" id="L312">    whispercppDiarization = OsgiUtil.getOptCfgAsBoolean(cc.getProperties(), WHISPERCPP_DIARIZATION_CONFIG_KEY);</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">    if (whispercppDiarization.isSome()) {</span>
<span class="nc" id="L314">      logger.debug(&quot;WhisperC++ diarization set to {}&quot;, whispercppDiarization);</span>
    }

<span class="nc" id="L317">    whispercppTinyDiarization = OsgiUtil.getOptCfgAsBoolean(cc.getProperties(), WHISPERCPP_TINY_DIARIZATION_CONFIG_KEY);</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">    if (whispercppTinyDiarization.isSome()) {</span>
<span class="nc" id="L319">      logger.debug(&quot;WhisperC++ tiny diarization set to {}&quot;, whispercppTinyDiarization);</span>
    }

<span class="nc" id="L322">    whispercppNoFallback = OsgiUtil.getOptCfgAsBoolean(cc.getProperties(), WHISPERCPP_NO_FALLBACK_CONFIG_KEY);</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">    if (whispercppNoFallback.isSome()) {</span>
<span class="nc" id="L324">      logger.debug(&quot;WhisperC++ no fallback set to {}&quot;, whispercppNoFallback);</span>
    }

<span class="nc" id="L327">    whispercppVad = OsgiUtil.getOptCfgAsBoolean(cc.getProperties(), WHISPERCPP_VAD_CONFIG_KEY);</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">    if (whispercppVad.isSome()) {</span>
<span class="nc" id="L329">      logger.debug(&quot;WhisperC++ VAD set to {}&quot;, whispercppVad);</span>
    }

<span class="nc" id="L332">    whispercppVadModel = OsgiUtil.getOptCfg(cc.getProperties(), WHISPERCPP_VAD_MODEL_CONFIG_KEY);</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">    if (whispercppVadModel.isSome()) {</span>
<span class="nc" id="L334">      logger.debug(&quot;WhisperC++ VAD model set to {}&quot;, whispercppVadModel);</span>
    }

<span class="nc" id="L337">    whispercppVadThreshold = OsgiUtil.getOptCfg(cc.getProperties(), WHISPERCPP_VAD_THRESHOLD_CONFIG_KEY).bind(</span>
        Strings.toDouble);
<span class="nc bnc" id="L339" title="All 2 branches missed.">    if (whispercppVadThreshold.isSome()) {</span>
<span class="nc" id="L340">      logger.debug(&quot;WhisperC++ VAD threshold set to {}&quot;, whispercppVadThreshold);</span>
    }

<span class="nc" id="L343">    whispercppVadMinSpeech = OsgiUtil.getOptCfgAsInt(cc.getProperties(), WHISPERCPP_VAD_MIN_SPEECH_CONFIG_KEY);</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">    if (whispercppVadMinSpeech.isSome()) {</span>
<span class="nc" id="L345">      logger.debug(&quot;WhisperC++ VAD min speech set to {}&quot;, whispercppVadMinSpeech);</span>
    }

<span class="nc" id="L348">    whispercppVadMinSilence = OsgiUtil.getOptCfgAsInt(cc.getProperties(), WHISPERCPP_VAD_MIN_SILENCE_CONFIG_KEY);</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">    if (whispercppVadMinSilence.isSome()) {</span>
<span class="nc" id="L350">      logger.debug(&quot;WhisperC++ VAD min silence set to {}&quot;, whispercppVadMinSilence);</span>
    }

<span class="nc" id="L353">    whispercppVadMaxSpeech = OsgiUtil.getOptCfg(cc.getProperties(), WHISPERCPP_VAD_MAX_SPEECH_CONFIG_KEY).bind(</span>
        Strings.toDouble);
<span class="nc bnc" id="L355" title="All 2 branches missed.">    if (whispercppVadMaxSpeech.isSome()) {</span>
<span class="nc" id="L356">      logger.debug(&quot;WhisperC++ VAD max speech set to {}&quot;, whispercppVadMaxSpeech);</span>
    }

<span class="nc" id="L359">    whispercppVadSpeechPadding = OsgiUtil.getOptCfgAsInt(cc.getProperties(), WHISPERCPP_VAD_SPEECH_PADDING_CONFIG_KEY);</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">    if (whispercppVadSpeechPadding.isSome()) {</span>
<span class="nc" id="L361">      logger.debug(&quot;WhisperC++ VAD speech padding set to {}&quot;, whispercppVadSpeechPadding);</span>
    }

<span class="nc" id="L364">    whispercppVadSamplesOverlap = OsgiUtil.getOptCfg(cc.getProperties(), WHISPERCPP_VAD_SAMPLES_OVERLAP_CONFIG_KEY)</span>
<span class="nc" id="L365">        .bind(Strings.toDouble);</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">    if (whispercppVadSamplesOverlap.isSome()) {</span>
<span class="nc" id="L367">      logger.debug(&quot;WhisperC++ VAD samples overlap set to {}&quot;, whispercppVadSamplesOverlap);</span>
    }

<span class="nc" id="L370">    whispercppArgs = Objects.toString(cc.getProperties().get(WHISPERCPP_ARGS_CONFIG_KEY), &quot;&quot;).trim().split(&quot;\\s+&quot;);</span>
<span class="nc" id="L371">    logger.debug(&quot;Additional args for WhisperC++: {}&quot;, (Object) whispercppArgs);</span>

<span class="nc" id="L373">    autoEncode = BooleanUtils.toBoolean(Objects.toString(</span>
<span class="nc" id="L374">        cc.getProperties().get(AUTO_ENCODING_CONFIG_KEY),</span>
<span class="nc" id="L375">        AUTO_ENCODING_DEFAULT.toString()));</span>
<span class="nc" id="L376">    logger.debug(&quot;Automatically convert input media: {}&quot;, autoEncode);</span>

<span class="nc" id="L378">    ffmpegBinary = Objects.toString(cc.getBundleContext().getProperty(FFMPEG_BINARY_CONFIG_KEY), DEFAULT_FFMPEG_BINARY);</span>
<span class="nc" id="L379">    logger.debug(&quot;ffmpeg binary set to {}&quot;, ffmpegBinary);</span>

<span class="nc" id="L381">    logger.debug(&quot;Finished activating/updating speech-to-text service&quot;);</span>
<span class="nc" id="L382">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.speechtotext.api.SpeechToTextEngine#generateSubtitlesFile(File, File, String, Boolean)
   */
  @Override
  public Result generateSubtitlesFile(File mediaFile, File workingDirectory, String language, Boolean translate)
          throws SpeechToTextEngineException {

<span class="nc" id="L393">    var whisperInput = mediaFile.getAbsolutePath();</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">    if (autoEncode) {</span>
<span class="nc" id="L395">      whisperInput = FilenameUtils.concat(workingDirectory.getAbsolutePath(), UUID.randomUUID() + &quot;.wav&quot;);</span>
<span class="nc" id="L396">      var ffmpegCommand = List.of(</span>
          ffmpegBinary,
<span class="nc" id="L398">          &quot;-i&quot;, mediaFile.getAbsolutePath(),</span>
          &quot;-ar&quot;, &quot;16000&quot;,
          &quot;-ac&quot;, &quot;1&quot;,
          &quot;-c:a&quot;, &quot;pcm_s16le&quot;,
          whisperInput);
      try {
<span class="nc" id="L404">        execCommand(ffmpegCommand);</span>
<span class="nc" id="L405">      } catch (IOException e) {</span>
<span class="nc" id="L406">        throw new SpeechToTextEngineException(&quot;Failed to convert audio file&quot;, e);</span>
<span class="nc" id="L407">      } catch (InterruptedException e) {</span>
<span class="nc" id="L408">        throw new RuntimeException(e);</span>
<span class="nc" id="L409">      }</span>
    }

<span class="nc bnc" id="L412" title="All 2 branches missed.">    if (!whisperInput.toLowerCase().endsWith(&quot;.wav&quot;)) {</span>
<span class="nc" id="L413">      throw new SpeechToTextEngineException(&quot;WhisperC++ currently doesn't support any media extension other than wav&quot;);</span>
    }

<span class="nc" id="L416">    String outputName = FilenameUtils.getBaseName(mediaFile.getAbsolutePath());</span>

<span class="nc" id="L418">    List&lt;String&gt; command = new ArrayList&lt;&gt;(List.of(</span>
        whispercppExecutable,
        whisperInput,
        &quot;--model&quot;, whispercppModel,
        &quot;-ovtt&quot;,
        &quot;-oj&quot;,
<span class="nc" id="L424">        &quot;--output-file&quot;, FilenameUtils.concat(workingDirectory.getAbsolutePath(), outputName)));</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">    if (whispercppBeamSize.isSome()) {</span>
<span class="nc" id="L426">      command.add(&quot;-bs&quot;);</span>
<span class="nc" id="L427">      command.add(Integer.toString(whispercppBeamSize.get()));</span>
    }
<span class="nc bnc" id="L429" title="All 2 branches missed.">    if (whispercppMaxLength.isSome()) {</span>
<span class="nc" id="L430">      command.add(&quot;-ml&quot;);</span>
<span class="nc" id="L431">      command.add(Integer.toString(whispercppMaxLength.get()));</span>
    }
<span class="nc bnc" id="L433" title="All 2 branches missed.">    if (whispercppThreads.isSome()) {</span>
<span class="nc" id="L434">      command.add(&quot;-t&quot;);</span>
<span class="nc" id="L435">      command.add(Integer.toString(whispercppThreads.get()));</span>
    }
<span class="nc bnc" id="L437" title="All 2 branches missed.">    if (whispercppProcessors.isSome()) {</span>
<span class="nc" id="L438">      command.add(&quot;-p&quot;);</span>
<span class="nc" id="L439">      command.add(Integer.toString(whispercppProcessors.get()));</span>
    }
<span class="nc bnc" id="L441" title="All 2 branches missed.">    if (whispercppMaxContext.isSome()) {</span>
<span class="nc" id="L442">      command.add(&quot;-mc&quot;);</span>
<span class="nc" id="L443">      command.add(Integer.toString(whispercppMaxContext.get()));</span>
    }
<span class="nc bnc" id="L445" title="All 4 branches missed.">    if (whispercppSplitOnWord.isSome() &amp;&amp; whispercppSplitOnWord.get()) {</span>
<span class="nc" id="L446">      command.add(&quot;-sow&quot;);</span>
    }
<span class="nc bnc" id="L448" title="All 2 branches missed.">    if (whispercppBestOf.isSome()) {</span>
<span class="nc" id="L449">      command.add(&quot;-bo&quot;);</span>
<span class="nc" id="L450">      command.add(Integer.toString(whispercppBestOf.get()));</span>
    }
<span class="nc bnc" id="L452" title="All 2 branches missed.">    if (whispercppWordThreshold.isSome()) {</span>
<span class="nc" id="L453">      command.add(&quot;-wt&quot;);</span>
<span class="nc" id="L454">      command.add(String.format(Locale.US, &quot;%f&quot;, whispercppWordThreshold.get()));</span>
    }
<span class="nc bnc" id="L456" title="All 2 branches missed.">    if (whispercppEntropyThreshold.isSome()) {</span>
<span class="nc" id="L457">      command.add(&quot;-et&quot;);</span>
<span class="nc" id="L458">      command.add(String.format(Locale.US, &quot;%f&quot;, whispercppEntropyThreshold.get()));</span>
    }
<span class="nc bnc" id="L460" title="All 2 branches missed.">    if (whispercppLogProbThreshold.isSome()) {</span>
<span class="nc" id="L461">      command.add(&quot;-lpt&quot;);</span>
<span class="nc" id="L462">      command.add(String.format(Locale.US, &quot;%f&quot;, whispercppLogProbThreshold.get()));</span>
    }
<span class="nc bnc" id="L464" title="All 4 branches missed.">    if (whispercppDiarization.isSome() &amp;&amp; whispercppDiarization.get()) {</span>
<span class="nc" id="L465">      command.add(&quot;-di&quot;);</span>
    }
<span class="nc bnc" id="L467" title="All 4 branches missed.">    if (whispercppTinyDiarization.isSome() &amp;&amp; whispercppTinyDiarization.get()) {</span>
<span class="nc" id="L468">      command.add(&quot;-tdrz&quot;);</span>
    }
<span class="nc bnc" id="L470" title="All 4 branches missed.">    if (whispercppNoFallback.isSome() &amp;&amp; whispercppNoFallback.get()) {</span>
<span class="nc" id="L471">      command.add(&quot;-nf&quot;);</span>
    }

    // Optional VAD parameters
<span class="nc bnc" id="L475" title="All 4 branches missed.">    if (whispercppVad.isSome() &amp;&amp; whispercppVad.get()) {</span>
<span class="nc" id="L476">      command.add(&quot;--vad&quot;);</span>
    }
<span class="nc bnc" id="L478" title="All 2 branches missed.">    if (whispercppVadModel.isSome()) {</span>
<span class="nc" id="L479">      command.add(&quot;-vm&quot;);</span>
<span class="nc" id="L480">      command.add(whispercppVadModel.get());</span>
    }
<span class="nc bnc" id="L482" title="All 2 branches missed.">    if (whispercppVadThreshold.isSome()) {</span>
<span class="nc" id="L483">      command.add(&quot;-vt&quot;);</span>
<span class="nc" id="L484">      command.add(String.format(Locale.US, &quot;%f&quot;, whispercppVadThreshold.get()));</span>
    }
<span class="nc bnc" id="L486" title="All 2 branches missed.">    if (whispercppVadMinSpeech.isSome()) {</span>
<span class="nc" id="L487">      command.add(&quot;-vspd&quot;);</span>
<span class="nc" id="L488">      command.add(Integer.toString(whispercppVadMinSpeech.get()));</span>
    }
<span class="nc bnc" id="L490" title="All 2 branches missed.">    if (whispercppVadMinSilence.isSome()) {</span>
<span class="nc" id="L491">      command.add(&quot;-vsd&quot;);</span>
<span class="nc" id="L492">      command.add(Integer.toString(whispercppVadMinSilence.get()));</span>
    }
<span class="nc bnc" id="L494" title="All 2 branches missed.">    if (whispercppVadMaxSpeech.isSome()) {</span>
<span class="nc" id="L495">      command.add(&quot;-vmsd&quot;);</span>
<span class="nc" id="L496">      command.add(String.format(Locale.US, &quot;%f&quot;, whispercppVadMaxSpeech.get()));</span>
    }
<span class="nc bnc" id="L498" title="All 2 branches missed.">    if (whispercppVadSpeechPadding.isSome()) {</span>
<span class="nc" id="L499">      command.add(&quot;-vp&quot;);</span>
<span class="nc" id="L500">      command.add(Integer.toString(whispercppVadSpeechPadding.get()));</span>
    }
<span class="nc bnc" id="L502" title="All 2 branches missed.">    if (whispercppVadSamplesOverlap.isSome()) {</span>
<span class="nc" id="L503">      command.add(&quot;-vo&quot;);</span>
<span class="nc" id="L504">      command.add(String.format(Locale.US, &quot;%f&quot;, whispercppVadSamplesOverlap.get()));</span>
    }

    String subtitleLanguage;

    // set language of the source audio if known
<span class="nc bnc" id="L510" title="All 2 branches missed.">    if (!language.isBlank()) {</span>
      // Convert ISO3 language code to ISO2 if possible, as WhisperC++ expects ISO2 codes.
      // If the conversion is not possible, retain the original language code.
<span class="nc" id="L513">      logger.info(&quot;Found language '{}'&quot;, language);</span>
<span class="nc" id="L514">      language = LangCodeUtil.iso3ToIso2(language, language);</span>
<span class="nc" id="L515">      logger.info(&quot;Using language code '{}' for transcription process&quot;, language);</span>
<span class="nc" id="L516">      command.add(&quot;--language&quot;);</span>
<span class="nc" id="L517">      command.add(language);</span>
    } else {
<span class="nc" id="L519">      logger.debug(&quot;Auto-detecting language&quot;);</span>
<span class="nc" id="L520">      command.add(&quot;--language&quot;);</span>
<span class="nc" id="L521">      command.add(&quot;auto&quot;);</span>
    }

<span class="nc bnc" id="L524" title="All 2 branches missed.">    if (translate) {</span>
<span class="nc" id="L525">      command.add(&quot;--translate&quot;);</span>
<span class="nc" id="L526">      logger.info(&quot;Translation enabled&quot;);</span>
<span class="nc" id="L527">      subtitleLanguage = &quot;en&quot;;</span>
    } else {
<span class="nc" id="L529">      subtitleLanguage = language;</span>
    }

<span class="nc" id="L532">    command.addAll(Arrays.asList(whispercppArgs));</span>

<span class="nc" id="L534">    logger.info(&quot;Executing WhisperC++'s transcription command: {}&quot;, command);</span>

    File vtt;

    try {
<span class="nc" id="L539">      execCommand(command);</span>

<span class="nc" id="L541">      vtt = new File(workingDirectory, outputName + &quot;.vtt&quot;);</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">      if (!vtt.isFile()) {</span>
<span class="nc" id="L543">        throw new SpeechToTextEngineException(&quot;WhisperC++ produced no output&quot;);</span>
      }
<span class="nc" id="L545">      logger.info(&quot;Subtitles file generated successfully: {}&quot;, vtt);</span>
<span class="nc" id="L546">    } catch (Exception e) {</span>
<span class="nc" id="L547">      logger.info(&quot;Transcription failed closing WhisperC++ transcription process for: {}&quot;, whisperInput);</span>
<span class="nc" id="L548">      throw new SpeechToTextEngineException(e);</span>
<span class="nc" id="L549">    }</span>

    // Detect language if not set
<span class="nc bnc" id="L552" title="All 2 branches missed.">    if (subtitleLanguage.isBlank()) {</span>
<span class="nc" id="L553">      JSONParser jsonParser = new JSONParser();</span>
<span class="nc" id="L554">      File json = new File(workingDirectory, outputName + &quot;.json&quot;);</span>
      try {
<span class="nc" id="L556">        FileReader reader = new FileReader(json);</span>
<span class="nc" id="L557">        Object obj = jsonParser.parse(reader);</span>
<span class="nc" id="L558">        JSONObject jsonObject = (JSONObject) obj;</span>
<span class="nc" id="L559">        JSONObject result = (JSONObject) jsonObject.get(&quot;result&quot;);</span>
<span class="nc" id="L560">        subtitleLanguage = (String) result.get(&quot;language&quot;);</span>
        // convert language name to iso3 if necessary or take default
<span class="nc" id="L562">        subtitleLanguage = LangCodeUtil.getIso2FromLang(subtitleLanguage, subtitleLanguage);</span>
<span class="nc" id="L563">        logger.info(&quot;Language detected by WhisperC++: {}&quot;, subtitleLanguage);</span>
<span class="nc" id="L564">      } catch (Exception e) {</span>
<span class="nc" id="L565">        logger.info(&quot;Error reading WhisperC++ JSON file for: {}&quot;, mediaFile);</span>
<span class="nc" id="L566">        throw new SpeechToTextEngineException(e);</span>
      } finally {
<span class="nc" id="L568">        FileUtils.deleteQuietly(json);</span>
      }
    }

<span class="nc" id="L572">    return new Result(subtitleLanguage, vtt);</span>
  }

  private void execCommand(List&lt;String&gt; command) throws IOException, InterruptedException, SpeechToTextEngineException {
<span class="nc" id="L576">    logger.info(&quot;Executing command: {}&quot;, command);</span>
<span class="nc" id="L577">    Process process = null;</span>

    try {
<span class="nc" id="L580">      ProcessBuilder processBuilder = new ProcessBuilder(command);</span>
<span class="nc" id="L581">      processBuilder.redirectErrorStream(true);</span>
<span class="nc" id="L582">      processBuilder.redirectInput(ProcessBuilder.Redirect.PIPE)</span>
<span class="nc" id="L583">          .redirectError(ProcessBuilder.Redirect.PIPE)</span>
<span class="nc" id="L584">          .redirectOutput(ProcessBuilder.Redirect.PIPE);</span>
<span class="nc" id="L585">      process = processBuilder.start();</span>

<span class="nc" id="L587">      try (BufferedReader in = new BufferedReader(new InputStreamReader(process.getInputStream()))) {</span>
        String line;
<span class="nc bnc" id="L589" title="All 2 branches missed.">        while ((line = in.readLine()) != null) { // consume process output</span>
<span class="nc" id="L590">          logger.debug(line);</span>
        }
      }

      // wait until the task is finished
<span class="nc" id="L595">      int exitCode = process.waitFor();</span>
<span class="nc" id="L596">      logger.info(&quot;Process finished with exit code {}&quot;, exitCode);</span>

<span class="nc bnc" id="L598" title="All 2 branches missed.">      if (exitCode != 0) {</span>
<span class="nc" id="L599">        var error = &quot;&quot;;</span>
<span class="nc" id="L600">        try (var errorStream = process.getInputStream()) {</span>
<span class="nc" id="L601">          error = &quot;\n Output:\n&quot; + IOUtils.toString(errorStream, StandardCharsets.UTF_8);</span>
        }
<span class="nc" id="L603">        throw new SpeechToTextEngineException(</span>
<span class="nc" id="L604">            String.format(&quot;Process exited abnormally with status %d (command: %s) %s&quot;, exitCode, command, error));</span>
      }
    } finally {
<span class="nc" id="L607">      IoSupport.closeQuietly(process);</span>
    }
<span class="nc" id="L609">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>