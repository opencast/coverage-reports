<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>Event.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-elasticsearch-index</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.elasticsearch.index.objects.event</a> &gt; <span class="el_source">Event.java</span></div><h1>Event.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.elasticsearch.index.objects.event;

import org.opencastproject.elasticsearch.index.objects.IndexObject;
import org.opencastproject.mediapackage.Publication;
import org.opencastproject.scheduler.api.RecordingState;
import org.opencastproject.util.IoSupport;
import org.opencastproject.util.XmlSafeParser;
import org.opencastproject.util.jaxb.ExtendedMetadataAdapter;
import org.opencastproject.workflow.api.WorkflowInstance.WorkflowState;

import org.apache.commons.lang3.StringUtils;
import org.codehaus.jettison.json.JSONException;
import org.codehaus.jettison.json.JSONObject;
import org.codehaus.jettison.mapped.Configuration;
import org.codehaus.jettison.mapped.MappedNamespaceConvention;
import org.codehaus.jettison.mapped.MappedXMLStreamReader;
import org.codehaus.jettison.mapped.MappedXMLStreamWriter;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.xml.sax.SAXException;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.StringWriter;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.xml.bind.JAXBContext;
import javax.xml.bind.JAXBException;
import javax.xml.bind.Marshaller;
import javax.xml.bind.Unmarshaller;
import javax.xml.bind.annotation.XmlAccessType;
import javax.xml.bind.annotation.XmlAccessorType;
import javax.xml.bind.annotation.XmlElement;
import javax.xml.bind.annotation.XmlElementWrapper;
import javax.xml.bind.annotation.XmlRootElement;
import javax.xml.bind.annotation.XmlType;
import javax.xml.bind.annotation.adapters.XmlJavaTypeAdapter;
import javax.xml.stream.XMLStreamException;
import javax.xml.stream.XMLStreamReader;
import javax.xml.stream.XMLStreamWriter;

/**
 * Object wrapper for a recording event.
 */
@XmlType(
    name = &quot;event&quot;,
    namespace = IndexObject.INDEX_XML_NAMESPACE,
    propOrder = {
        &quot;identifier&quot;, &quot;organization&quot;, &quot;title&quot;, &quot;description&quot;, &quot;subject&quot;, &quot;location&quot;, &quot;presenters&quot;,
        &quot;contributors&quot;, &quot;seriesId&quot;, &quot;seriesName&quot;, &quot;language&quot;, &quot;source&quot;, &quot;created&quot;, &quot;creator&quot;,
        &quot;publisher&quot;, &quot;license&quot;, &quot;rights&quot;, &quot;extendedMetadata&quot;, &quot;accessPolicy&quot;, &quot;managedAcl&quot;, &quot;workflowState&quot;,
        &quot;workflowId&quot;, &quot;workflowDefinitionId&quot;, &quot;recordingStartTime&quot;, &quot;recordingEndTime&quot;, &quot;duration&quot;,
        &quot;hasComments&quot;, &quot;hasOpenComments&quot;, &quot;comments&quot;, &quot;hasPreview&quot;, &quot;needsCutting&quot;, &quot;publications&quot;,
        &quot;archiveVersion&quot;, &quot;recordingStatus&quot;, &quot;eventStatus&quot;, &quot;agentId&quot;, &quot;agentConfigurations&quot;,
        &quot;technicalStartTime&quot;, &quot;technicalEndTime&quot;, &quot;technicalPresenters&quot;
    }
)
@XmlRootElement(name = &quot;event&quot;, namespace = IndexObject.INDEX_XML_NAMESPACE)
@XmlAccessorType(XmlAccessType.NONE)
public class Event implements IndexObject {

  /** The logger */
<span class="fc" id="L89">  private static final Logger logger = LoggerFactory.getLogger(Event.class);</span>

  /** The document type */
  public static final String DOCUMENT_TYPE = &quot;event&quot;;

  /** The name of the surrounding XML tag to wrap a result of multiple events */
  public static final String XML_SURROUNDING_TAG = &quot;events&quot;;

  /** The mapping of recording and workflow states */
<span class="fc" id="L98">  private static final Map&lt;String, String&gt; workflowStatusMapping = new HashMap&lt;&gt;();</span>
<span class="fc" id="L99">  private static final Map&lt;String, String&gt; recordingStatusMapping = new HashMap&lt;&gt;();</span>

  static {
<span class="fc" id="L102">    recordingStatusMapping.put(RecordingState.CAPTURING, &quot;EVENTS.EVENTS.STATUS.RECORDING&quot;);</span>
<span class="fc" id="L103">    recordingStatusMapping.put(RecordingState.CAPTURE_FINISHED, &quot;EVENTS.EVENTS.STATUS.RECORDING&quot;);</span>
<span class="fc" id="L104">    recordingStatusMapping.put(RecordingState.MANIFEST, &quot;EVENTS.EVENTS.STATUS.INGESTING&quot;);</span>
<span class="fc" id="L105">    recordingStatusMapping.put(RecordingState.MANIFEST_FINISHED, &quot;EVENTS.EVENTS.STATUS.INGESTING&quot;);</span>
<span class="fc" id="L106">    recordingStatusMapping.put(RecordingState.COMPRESSING, &quot;EVENTS.EVENTS.STATUS.INGESTING&quot;);</span>
<span class="fc" id="L107">    recordingStatusMapping.put(RecordingState.UPLOADING, &quot;EVENTS.EVENTS.STATUS.INGESTING&quot;);</span>
<span class="fc" id="L108">    recordingStatusMapping.put(RecordingState.UPLOAD_FINISHED, &quot;EVENTS.EVENTS.STATUS.INGESTING&quot;);</span>
<span class="fc" id="L109">    recordingStatusMapping.put(RecordingState.CAPTURE_ERROR, &quot;EVENTS.EVENTS.STATUS.RECORDING_FAILURE&quot;);</span>
<span class="fc" id="L110">    recordingStatusMapping.put(RecordingState.MANIFEST_ERROR, &quot;EVENTS.EVENTS.STATUS.RECORDING_FAILURE&quot;);</span>
<span class="fc" id="L111">    recordingStatusMapping.put(RecordingState.COMPRESSING_ERROR, &quot;EVENTS.EVENTS.STATUS.RECORDING_FAILURE&quot;);</span>
<span class="fc" id="L112">    recordingStatusMapping.put(RecordingState.UPLOAD_ERROR, &quot;EVENTS.EVENTS.STATUS.RECORDING_FAILURE&quot;);</span>
<span class="fc" id="L113">    workflowStatusMapping.put(WorkflowState.INSTANTIATED.toString(), &quot;EVENTS.EVENTS.STATUS.PENDING&quot;);</span>
<span class="fc" id="L114">    workflowStatusMapping.put(WorkflowState.RUNNING.toString(), &quot;EVENTS.EVENTS.STATUS.PROCESSING&quot;);</span>
<span class="fc" id="L115">    workflowStatusMapping.put(WorkflowState.FAILING.toString(), &quot;EVENTS.EVENTS.STATUS.PROCESSING&quot;);</span>
<span class="fc" id="L116">    workflowStatusMapping.put(WorkflowState.PAUSED.toString(), &quot;EVENTS.EVENTS.STATUS.PAUSED&quot;);</span>
<span class="fc" id="L117">    workflowStatusMapping.put(WorkflowState.SUCCEEDED.toString(), &quot;EVENTS.EVENTS.STATUS.PROCESSED&quot;);</span>
<span class="fc" id="L118">    workflowStatusMapping.put(WorkflowState.FAILED.toString(), &quot;EVENTS.EVENTS.STATUS.PROCESSING_FAILURE&quot;);</span>
<span class="fc" id="L119">    workflowStatusMapping.put(WorkflowState.STOPPED.toString(), &quot;EVENTS.EVENTS.STATUS.PROCESSING_CANCELLED&quot;);</span>
  }

  /** The identifier */
<span class="fc" id="L123">  @XmlElement(name = &quot;identifier&quot;)</span>
  private String identifier = null;

  /** The organization identifier */
<span class="fc" id="L127">  @XmlElement(name = &quot;organization&quot;)</span>
  private String organization = null;

  /** The title */
<span class="fc" id="L131">  @XmlElement(name = &quot;title&quot;)</span>
  private String title = null;

  /** The description */
<span class="fc" id="L135">  @XmlElement(name = &quot;description&quot;)</span>
  private String description = null;

  /** The subject */
<span class="fc" id="L139">  @XmlElement(name = &quot;subject&quot;)</span>
  private String subject = null;

  /** The location */
<span class="fc" id="L143">  @XmlElement(name = &quot;location&quot;)</span>
  private String location = null;

<span class="fc" id="L146">  @XmlElementWrapper(name = &quot;presenters&quot;)</span>
  @XmlElement(name = &quot;presenter&quot;)
  private List&lt;String&gt; presenters = null;

<span class="fc" id="L150">  @XmlElementWrapper(name = &quot;contributors&quot;)</span>
  @XmlElement(name = &quot;contributor&quot;)
  private List&lt;String&gt; contributors = null;

  /** The series identifier */
<span class="fc" id="L155">  @XmlElement(name = &quot;series_id&quot;)</span>
  private String seriesId = null;

  /** The series name */
<span class="fc" id="L159">  @XmlElement(name = &quot;series_name&quot;)</span>
  private String seriesName = null;

  /** The language for the event */
<span class="fc" id="L163">  @XmlElement(name = &quot;language&quot;)</span>
  private String language = null;

  /** The source for the event */
<span class="fc" id="L167">  @XmlElement(name = &quot;source&quot;)</span>
  private String source = null;

  /** The creation date of the event */
<span class="fc" id="L171">  @XmlElement(name = &quot;created&quot;)</span>
  private String created = null;

  /** The creator of the event */
<span class="fc" id="L175">  @XmlElement(name = &quot;creator&quot;)</span>
  private String creator = null;

  /** The publisher of the event */
<span class="fc" id="L179">  @XmlElement(name = &quot;publisher&quot;)</span>
  private String publisher = null;

  /** The license of the event */
<span class="fc" id="L183">  @XmlElement(name = &quot;license&quot;)</span>
  private String license = null;

  /** The rights of the event */
<span class="fc" id="L187">  @XmlElement(name = &quot;rights&quot;)</span>
  private String rights = null;

<span class="fc" id="L190">  @XmlElement(name = &quot;extendedMetadata&quot;)</span>
  @XmlJavaTypeAdapter(ExtendedMetadataAdapter.class)
  private Map&lt;String, Map&lt;String, List&lt;String&gt;&gt;&gt; extendedMetadata = new HashMap();

  /** The access policy of the event */
<span class="fc" id="L195">  @XmlElement(name = &quot;access_policy&quot;)</span>
  private String accessPolicy = null;

  /** The name of the managed ACL used by the series (if set) */
<span class="fc" id="L199">  @XmlElement(name = &quot;managed_acl&quot;)</span>
  private String managedAcl = null;

  /** The current state of the workflow related to this event */
<span class="fc" id="L203">  @XmlElement(name = &quot;workflow_state&quot;)</span>
  private String workflowState = null;

  /** The workflow id related to this event */
<span class="fc" id="L207">  @XmlElement(name = &quot;workflow_id&quot;)</span>
  private Long workflowId = null;

  /** The workflow definition id related to this event */
<span class="fc" id="L211">  @XmlElement(name = &quot;workflow_definition_id&quot;)</span>
  private String workflowDefinitionId = null;

  /** The recording start date from this event */
<span class="fc" id="L215">  @XmlElement(name = &quot;recording_start_time&quot;)</span>
  private String recordingStartTime = null;

  /** The recording end date from this event */
<span class="fc" id="L219">  @XmlElement(name = &quot;recording_end_time&quot;)</span>
  private String recordingEndTime = null;

  /** The recording duration from this event */
<span class="fc" id="L223">  @XmlElement(name = &quot;duration&quot;)</span>
  private Long duration = null;

  /** The status of the event */
<span class="fc" id="L227">  @XmlElement(name = &quot;event_status&quot;)</span>
  private String eventStatus = null;

  /** Whether the event has comments */
<span class="fc" id="L231">  @XmlElement(name = &quot;has_comments&quot;)</span>
<span class="fc" id="L232">  private Boolean hasComments = false;</span>

  /** Whether the event has open comments */
<span class="fc" id="L235">  @XmlElement(name = &quot;has_open_comments&quot;)</span>
<span class="fc" id="L236">  private Boolean hasOpenComments = false;</span>

  /** Comments on the event */
<span class="fc" id="L239">  @XmlElement(name = &quot;comments&quot;)</span>
  private List&lt;Comment&gt; comments = new ArrayList&lt;&gt;();

  /** Whether the event has preview files */
<span class="fc" id="L243">  @XmlElement(name = &quot;has_preview&quot;)</span>
<span class="fc" id="L244">  private Boolean hasPreview = false;</span>

  /** Whether the event has open needs cutting comment */
<span class="fc" id="L247">  @XmlElement(name = &quot;needs_cutting&quot;)</span>
<span class="fc" id="L248">  private Boolean needsCutting = false;</span>

  /** The list of publications from this event */
<span class="fc" id="L251">  @XmlElementWrapper(name = &quot;publications&quot;)</span>
  @XmlElement(name = &quot;publication&quot;)
  private List&lt;Publication&gt; publications = new ArrayList&lt;&gt;();

  /** The recording status of the event */
<span class="fc" id="L256">  @XmlElement(name = &quot;recording_status&quot;)</span>
  private String recordingStatus = null;

  /** The archive version of the event */
<span class="fc" id="L260">  @XmlElement(name = &quot;archive_version&quot;)</span>
  private Long archiveVersion = null;

  /** The id of the capture agent */
<span class="fc" id="L264">  @XmlElement(name = &quot;agent_id&quot;)</span>
  private String agentId = null;

  /** The configuration of the capture agent */
<span class="fc" id="L268">  @XmlElementWrapper(name = &quot;agent_configuration&quot;)</span>
  private Map&lt;String, String&gt; agentConfigurations = new HashMap&lt;String, String&gt;();

  /** The technical end time of the recording */
<span class="fc" id="L272">  @XmlElement(name = &quot;technical_end_time&quot;)</span>
  private String technicalEndTime = null;

  /** The technical start time of the recording */
<span class="fc" id="L276">  @XmlElement(name = &quot;technical_start_time&quot;)</span>
  private String technicalStartTime = null;

<span class="fc" id="L279">  @XmlElementWrapper(name = &quot;technical_presenters&quot;)</span>
  @XmlElement(name = &quot;technical_presenter&quot;)
  private List&lt;String&gt; technicalPresenters = null;

  /** Context for serializing and deserializing */
<span class="fc" id="L284">  private static JAXBContext context = null;</span>

  /**
   * Required default no arg constructor for JAXB.
   */
<span class="fc" id="L289">  public Event() {</span>

<span class="fc" id="L291">  }</span>

  /**
   * The recording identifier.
   *
   * @param identifier
   *          the object identifier
   * @param organization
   *          the organization
   */
<span class="fc" id="L301">  public Event(String identifier, String organization) {</span>
<span class="fc" id="L302">    this.identifier = identifier;</span>
<span class="fc" id="L303">    this.organization = organization;</span>
<span class="fc" id="L304">    updateEventStatus();</span>
<span class="fc" id="L305">  }</span>

  /**
   * Returns the recording event identifier.
   *
   * @return the identifier
   */
  public String getIdentifier() {
<span class="fc" id="L313">    return identifier;</span>
  }

  /**
   * Returns the organization of the recording.
   *
   * @return the organization
   */
  public String getOrganization() {
<span class="nc" id="L322">    return organization;</span>
  }

  /**
   * Sets the recording title.
   *
   * @param title
   *          the title
   */
  public void setTitle(String title) {
<span class="fc" id="L332">    this.title = title;</span>
<span class="fc" id="L333">  }</span>

  /**
   * Returns the recording title.
   *
   * @return the title
   */
  public String getTitle() {
<span class="fc" id="L341">    return title;</span>
  }

  /**
   * Sets the recording description.
   *
   * @param description
   *          the description
   */
  public void setDescription(String description) {
<span class="fc" id="L351">    this.description = description;</span>
<span class="fc" id="L352">  }</span>

  /**
   * Returns the recording description.
   *
   * @return the description
   */
  public String getDescription() {
<span class="fc" id="L360">    return description;</span>
  }

  /**
   * Sets the recording subject
   *
   * @param subject
   *          the subject to set
   */
  public void setSubject(String subject) {
<span class="fc" id="L370">    this.subject = subject;</span>
<span class="fc" id="L371">  }</span>

  /**
   * Returns the recording subject.
   *
   * @return the subject
   */
  public String getSubject() {
<span class="fc" id="L379">    return subject;</span>
  }

  /**
   * Sets the recording location.
   *
   * @param location
   *          the location
   */
  public void setLocation(String location) {
<span class="fc" id="L389">    this.location = location;</span>
<span class="fc" id="L390">  }</span>

  /**
   * Returns the recording location.
   *
   * @return the location
   */
  public String getLocation() {
<span class="fc" id="L398">    return location;</span>
  }

  /**
   * Sets the series identifier
   *
   * @param seriesId
   *          the series identifier
   */
  public void setSeriesId(String seriesId) {
<span class="fc" id="L408">    this.seriesId = seriesId;</span>
<span class="fc" id="L409">  }</span>

  /**
   * Returns the series identifier
   *
   * @return the series identifier
   */
  public String getSeriesId() {
<span class="fc" id="L417">    return seriesId;</span>
  }

  /**
   * Sets the series name
   *
   * @param seriesName
   *          the series name
   */
  public void setSeriesName(String seriesName) {
<span class="nc" id="L427">    this.seriesName = seriesName;</span>
<span class="nc" id="L428">  }</span>

  /**
   * Returns the series name
   *
   * @return the series name
   */
  public String getSeriesName() {
<span class="nc" id="L436">    return seriesName;</span>
  }

  /**
   * Sets the language
   *
   * @param language
   *          the language
   */
  public void setLanguage(String language) {
<span class="fc" id="L446">    this.language = language;</span>
<span class="fc" id="L447">  }</span>

  /**
   * Returns the language
   *
   * @return the language
   */
  public String getLanguage() {
<span class="fc" id="L455">    return language;</span>
  }

  /**
   * Sets the source of this event
   *
   * @param source
   *          the source
   */
  public void setSource(String source) {
<span class="fc" id="L465">    this.source = source;</span>
<span class="fc" id="L466">  }</span>

  /**
   * Returns the source of this event
   *
   * @return the source
   */
  public String getSource() {
<span class="fc" id="L474">    return source;</span>
  }

  /**
   * Sets the creation date
   *
   * @param created
   *          the creation date
   */
  public void setCreated(String created) {
<span class="fc" id="L484">    this.created = created;</span>
<span class="fc" id="L485">  }</span>

  /**
   * Returns the creation date
   *
   * @return the creation date
   */
  public String getCreated() {
<span class="fc" id="L493">    return created;</span>
  }

  /**
   * Sets the creator
   *
   * @param creator
   *          the language
   */
  public void setCreator(String creator) {
<span class="fc" id="L503">    this.creator = creator;</span>
<span class="fc" id="L504">  }</span>

  /**
   * Returns the creator
   *
   * @return the language
   */
  public String getCreator() {
<span class="fc" id="L512">    return creator;</span>
  }

  /**
   * Sets the publisher
   *
   * @param publisher
   *          the publisher
   */
  public void setPublisher(String publisher) {
<span class="fc" id="L522">    this.publisher = publisher;</span>
<span class="fc" id="L523">  }</span>

  /**
   * Returns the publisher
   *
   * @return the publisher
   */
  public String getPublisher() {
<span class="nc" id="L531">    return publisher;</span>
  }

  /**
   * Sets the license
   *
   * @param license
   *          the language
   */
  public void setLicense(String license) {
<span class="fc" id="L541">    this.license = license;</span>
<span class="fc" id="L542">  }</span>

  /**
   * Returns the license
   *
   * @return the license
   */
  public String getLicense() {
<span class="fc" id="L550">    return license;</span>
  }

  /**
   * Sets the rights
   *
   * @param rights
   *          the rights
   */
  public void setRights(String rights) {
<span class="fc" id="L560">    this.rights = rights;</span>
<span class="fc" id="L561">  }</span>

  /**
   * Returns the rights
   *
   * @return the rights
   */
  public String getRights() {
<span class="fc" id="L569">    return rights;</span>
  }

  /**
   * Sets the access policy
   *
   * @param accessPolicy
   *          the access policy
   */
  public void setAccessPolicy(String accessPolicy) {
<span class="fc" id="L579">    this.accessPolicy = accessPolicy;</span>
<span class="fc" id="L580">  }</span>

  /**
   * Returns the access policy
   *
   * @return the access policy
   */
  public String getAccessPolicy() {
<span class="nc" id="L588">    return accessPolicy;</span>
  }

  /**
   * Sets the name of the managed ACL used by the event.
   *
   * @param managedAcl
   *          the managed ACL name
   */
  public void setManagedAcl(String managedAcl) {
<span class="nc" id="L598">    this.managedAcl = managedAcl;</span>
<span class="nc" id="L599">  }</span>

  /**
   * Returns the name of the managed ACL, if the event does not have a custom ACL.
   *
   * @return the managed ACL name
   */
  public String getManagedAcl() {
<span class="nc" id="L607">    return managedAcl;</span>
  }

  /**
   * Sets the current workflow state related to this event
   *
   * @param workflowState
   *          the current workflow state
   */
  public void setWorkflowState(WorkflowState workflowState) {
<span class="nc bnc" id="L617" title="All 2 branches missed.">    this.workflowState = workflowState == null ? null : workflowState.toString();</span>
<span class="nc" id="L618">    updateEventStatus();</span>
<span class="nc" id="L619">  }</span>

  /**
   * Returns the current workflow state related to this event
   *
   * @return the workflow state
   */
  public String getWorkflowState() {
<span class="fc" id="L627">    return workflowState;</span>
  }

  /**
   * Sets the current workflow id related to this event
   *
   * @param workflowId
   *          the current workflow id
   */
  public void setWorkflowId(Long workflowId) {
<span class="nc" id="L637">    this.workflowId = workflowId;</span>
<span class="nc" id="L638">  }</span>

  /**
   * Returns the current workflow id related to this event
   *
   * @return the workflow id
   */
  public Long getWorkflowId() {
<span class="fc" id="L646">    return workflowId;</span>
  }

  /**
   * Sets the current workflow definition id related to this event
   *
   * @param workflowDefinitionId
   *          the current workflow definition id
   */
  public void setWorkflowDefinitionId(String workflowDefinitionId) {
<span class="nc" id="L656">    this.workflowDefinitionId = workflowDefinitionId;</span>
<span class="nc" id="L657">  }</span>

  /**
   * Returns the current workflow definition id related to this event
   *
   * @return the workflow definition id
   */
  public String getWorkflowDefinitionId() {
<span class="nc" id="L665">    return workflowDefinitionId;</span>
  }

  /**
   * Sets the start date
   *
   * @param recordingStartTime
   *          the start date
   */
  public void setRecordingStartDate(String recordingStartTime) {
<span class="fc" id="L675">    this.recordingStartTime = recordingStartTime;</span>
<span class="fc" id="L676">  }</span>

  /**
   * Returns the start date
   *
   * @return the start date
   */
  public String getRecordingStartDate() {
<span class="fc" id="L684">    return recordingStartTime;</span>
  }

  /**
   * Sets the recording end date
   *
   * @param recordingEndTime
   *          the end date
   */
  public void setRecordingEndDate(String recordingEndTime) {
<span class="fc" id="L694">    this.recordingEndTime = recordingEndTime;</span>
<span class="fc" id="L695">  }</span>

  /**
   * Returns the recording end date
   *
   * @return the end date
   */
  public String getRecordingEndDate() {
<span class="fc" id="L703">    return recordingEndTime;</span>
  }

  /**
   * Sets the recording duration
   *
   * @param duration
   *          the recording duration
   */
  public void setDuration(long duration) {
<span class="fc" id="L713">    this.duration = duration;</span>
<span class="fc" id="L714">  }</span>

  /**
   * Returns the recording duration
   *
   * @return the recording duration
   */
  public Long getDuration() {
<span class="fc" id="L722">    return duration;</span>
  }

  /**
   * Sets the list of presenters.
   *
   * @param presenters
   *          the presenters for this event
   */
  public void setPresenters(List&lt;String&gt; presenters) {
<span class="fc" id="L732">    this.presenters = presenters;</span>
<span class="fc" id="L733">  }</span>

  /**
   * Returns the recording presenters.
   *
   * @return the presenters
   */
  public List&lt;String&gt; getPresenters() {
<span class="fc" id="L741">    return presenters;</span>
  }

  /**
   * Sets the list of contributors.
   *
   * @param contributors
   *          the contributors for this event
   */
  public void setContributors(List&lt;String&gt; contributors) {
<span class="fc" id="L751">    this.contributors = contributors;</span>
<span class="fc" id="L752">  }</span>

  /**
   * Returns the recording contributors.
   *
   * @return the contributors
   */
  public List&lt;String&gt; getContributors() {
<span class="fc" id="L760">    return contributors;</span>
  }

  /**
   * Sets the has comments status from this event
   *
   * @param hasComments
   *          the has comments status from this event
   */
  public void setHasComments(boolean hasComments) {
<span class="nc" id="L770">    this.hasComments = hasComments;</span>
<span class="nc" id="L771">  }</span>

  /**
   * Returns the has comments status from this event
   *
   * @return the has comments status from this event
   */
  public boolean hasComments() {
<span class="nc" id="L779">    return hasComments;</span>
  }

  /**
   * Sets the has open comments status from this event
   *
   * @param hasOpenComments
   *          the has open comments status from this event
   */
  public void setHasOpenComments(boolean hasOpenComments) {
<span class="nc" id="L789">    this.hasOpenComments = hasOpenComments;</span>
<span class="nc" id="L790">  }</span>

  /**
   * Returns the has comments status from this event
   *
   * @return the has comments status from this event
   */
  public boolean hasOpenComments() {
<span class="nc" id="L798">    return hasOpenComments;</span>
  }

  /**
   * Sets the list of comments.
   *
   * @param comments
   *          the comments for this event
   */
  public void setComments(List&lt;Comment&gt; comments) {
<span class="nc" id="L808">    this.comments = comments;</span>
<span class="nc" id="L809">  }</span>

  /**
   * Returns the event comments.
   *
   * @return the comments
   */
  public List&lt;Comment&gt; comments() {
<span class="nc" id="L817">    return comments;</span>
  }

  /**
   * Sets the has preview status from this event
   *
   * @param hasPreview
   *          the has preview status from this event
   */
  public void setHasPreview(boolean hasPreview) {
<span class="nc" id="L827">    this.hasPreview = hasPreview;</span>
<span class="nc" id="L828">  }</span>

  /**
   * Returns the has preview status from this event
   *
   * @return the has preview status from this event
   */
  public boolean hasPreview() {
<span class="nc" id="L836">    return hasPreview;</span>
  }

  /**
   * Sets the subtype of the publication element that indicates a preview element.
   *
   * @param previewSubtype
   *          the subtype
   */
  public void updatePreview(String previewSubtype) {
<span class="nc" id="L846">    hasPreview = EventIndexUtils.subflavorMatches(publications, previewSubtype);</span>
<span class="nc" id="L847">  }</span>

  /**
   * Sets the has open needs cutting comment for this event
   *
   * @param needsCutting
   *          this event has the open comments status that it needs cutting
   */
  public void setNeedsCutting(boolean needsCutting) {
<span class="nc" id="L856">    this.needsCutting = needsCutting;</span>
<span class="nc" id="L857">  }</span>

  /**
   * Returns the has comment needs cutting for this event
   *
   * @return the event has the comments status that it needs cutting
   */
  public boolean needsCutting() {
<span class="nc" id="L865">    return needsCutting;</span>
  }

  /**
   * Sets the list of publications.
   *
   * @param publications
   *          the publications for this event
   */
  public void setPublications(List&lt;Publication&gt; publications) {
<span class="nc" id="L875">    this.publications = publications;</span>
<span class="nc" id="L876">  }</span>

  /**
   * Returns the event publications.
   *
   * @return the publications
   */
  public List&lt;Publication&gt; getPublications() {
<span class="nc" id="L884">    return publications;</span>
  }

  /**
   * Sets the archive version
   *
   * @param archiveVersion
   *          the archive version
   */
  public void setArchiveVersion(Long archiveVersion) {
<span class="nc" id="L894">    this.archiveVersion = archiveVersion;</span>
<span class="nc" id="L895">  }</span>

  /**
   * Returns the archive version
   *
   * @return the archive version
   */
  public Long getArchiveVersion() {
<span class="fc" id="L903">    return archiveVersion;</span>
  }

  private void updateEventStatus() {
<span class="pc bpc" id="L907" title="3 of 4 branches missed.">    if (getWorkflowId() != null &amp;&amp; StringUtils.isBlank(getWorkflowState())</span>
<span class="pc bpc" id="L908" title="2 of 4 branches missed.">            || getWorkflowId() == null &amp;&amp; StringUtils.isNotBlank(getWorkflowState())) {</span>
<span class="nc" id="L909">      logger.warn(&quot;The workflow id {} and workflow state {} are not in sync on event {} organization {}&quot;,</span>
<span class="nc" id="L910">              getWorkflowId(), getWorkflowState(), getIdentifier(), getOrganization());</span>
    }

<span class="pc bpc" id="L913" title="3 of 4 branches missed.">    if (getWorkflowId() != null &amp;&amp; StringUtils.isNotBlank(getWorkflowState())) {</span>
<span class="nc" id="L914">      eventStatus = workflowStatusMapping.get(getWorkflowState());</span>
<span class="fc bfc" id="L915" title="All 2 branches covered.">    } else if (&quot;EVENTS.EVENTS.STATUS.PROCESSED&quot;.equals(eventStatus)</span>
<span class="pc bpc" id="L916" title="1 of 2 branches missed.">            &amp;&amp; (RecordingState.CAPTURE_FINISHED.equals(getRecordingStatus())</span>
<span class="pc bpc" id="L917" title="1 of 2 branches missed.">            || RecordingState.UPLOAD_FINISHED.equals(getRecordingStatus()))) {</span>
<span class="nc" id="L918">      eventStatus = &quot;EVENTS.EVENTS.STATUS.PROCESSED&quot;;</span>
<span class="pc bpc" id="L919" title="1 of 2 branches missed.">    } else if (&quot;EVENTS.EVENTS.STATUS.PROCESSING_FAILURE&quot;.equals(eventStatus)</span>
<span class="pc bnc" id="L920" title="All 2 branches missed.">            &amp;&amp; RecordingState.CAPTURE_ERROR.equals(getRecordingStatus())</span>
<span class="pc bpc" id="L921" title="1 of 2 branches missed.">            || RecordingState.UPLOAD_ERROR.equals(getRecordingStatus())) {</span>
<span class="nc" id="L922">      eventStatus = recordingStatusMapping.get(getRecordingStatus());</span>
<span class="fc bfc" id="L923" title="All 2 branches covered.">    } else if (StringUtils.isNotBlank(getRecordingStatus())) {</span>
<span class="fc" id="L924">      eventStatus = recordingStatusMapping.get(getRecordingStatus());</span>
<span class="pc bpc" id="L925" title="1 of 2 branches missed.">    } else if (isScheduledEvent()) {</span>
<span class="nc" id="L926">      eventStatus = &quot;EVENTS.EVENTS.STATUS.SCHEDULED&quot;;</span>
    } else {
      /* This can be the case if all workflows of an event have been deleted */
      /* It also happens to events with running workflows while rebuilding the index */
<span class="fc" id="L930">      eventStatus = &quot;EVENTS.EVENTS.STATUS.PROCESSED&quot;;</span>
    }
<span class="fc" id="L932">  }</span>

  /**
   * Return the displayable status of this event
   *
   * @param customWorkflowStatusMapping
   *          The mappings used to get the displayable status for the workflow state.
   *
   * @return the displayable status of this event
   */
  public String getDisplayableStatus(Map&lt;String, Map&lt;String, String&gt;&gt; customWorkflowStatusMapping) {
<span class="nc bnc" id="L943" title="All 4 branches missed.">    if (getWorkflowId() != null &amp;&amp; StringUtils.isNotBlank(getWorkflowState())</span>
<span class="nc bnc" id="L944" title="All 2 branches missed.">          &amp;&amp; customWorkflowStatusMapping.containsKey(getWorkflowDefinitionId())</span>
<span class="nc bnc" id="L945" title="All 2 branches missed.">          &amp;&amp; customWorkflowStatusMapping.get(getWorkflowDefinitionId()).containsKey(getWorkflowState())) {</span>
<span class="nc" id="L946">      return customWorkflowStatusMapping.get(getWorkflowDefinitionId()).get(getWorkflowState());</span>
    }
<span class="nc" id="L948">    return getEventStatus();</span>
  }

  public boolean isScheduledEvent() {
    /* Only scheduled events have a capture ID assigned */
<span class="fc" id="L953">    return StringUtils.isNotBlank(getAgentId());</span>
  }

  /**
   * Check whether the recording of the event already has started.
   * Always returns false for uploaded events.
   *
   * @return &lt;code&gt;true&lt;/code&gt; if recording of this event has started, and &lt;code&gt;false&lt;/code&gt; otherwise
   */
  public boolean hasRecordingStarted() {
<span class="fc bfc" id="L963" title="All 4 branches covered.">    return isScheduledEvent() &amp;&amp; StringUtils.isNotBlank(getRecordingStatus());</span>
  }

  /**
   * Sets the recording status
   *
   * @param recordingStatus
   *          the recording status
   */
  public void setRecordingStatus(String recordingStatus) {
<span class="fc" id="L973">    this.recordingStatus = recordingStatus;</span>
<span class="fc" id="L974">    updateEventStatus();</span>
<span class="fc" id="L975">  }</span>

  /**
   * Returns the recording status
   *
   * @return the recording status
   */
  public String getRecordingStatus() {
<span class="fc" id="L983">    return recordingStatus;</span>
  }

  /**
   * Returns the event status
   *
   * @return the event status
   */
  public String getEventStatus() {
<span class="nc" id="L992">    updateEventStatus();</span>
<span class="nc" id="L993">    return eventStatus;</span>
  }

  /**
   * Returns the agent id
   *
   * @return the agent id
   */
  public String getAgentId() {
<span class="fc" id="L1002">    return agentId;</span>
  }

  /**
   * Sets the agent id
   *
   * @param agentId
   *          the agent id
   */
  public void setAgentId(String agentId) {
<span class="fc" id="L1012">    this.agentId = agentId;</span>
<span class="fc" id="L1013">  }</span>

  /**
   * Returns the agent configuration
   *
   * @return the agent configuration
   */
  public Map&lt;String, String&gt; getAgentConfiguration() {
<span class="nc" id="L1021">    return agentConfigurations;</span>
  }

  /**
   * Sets the agent configuration
   *
   * @param agentConfigurations
   *          the agent configuration
   */
  public void setAgentConfiguration(Map&lt;String, String&gt; agentConfigurations) {
<span class="fc" id="L1031">    this.agentConfigurations = agentConfigurations;</span>
<span class="fc" id="L1032">  }</span>

  /**
   * Returns the technical end time
   *
   * @return the technical end time
   */
  public String getTechnicalEndTime() {
<span class="fc" id="L1040">    return technicalEndTime;</span>
  }

  /**
   * Sets the technical end time
   *
   * @param technicalEndTime
   *          the technical end time
   */
  public void setTechnicalEndTime(String technicalEndTime) {
<span class="fc" id="L1050">    this.technicalEndTime = technicalEndTime;</span>
<span class="fc" id="L1051">  }</span>

  /**
   * Returns the technical start time
   *
   * @return the technical start time
   */
  public String getTechnicalStartTime() {
<span class="fc" id="L1059">    return technicalStartTime;</span>
  }

  /**
   * Sets the technical start time
   *
   * @param technicalStartTime
   *          the technical start time
   */
  public void setTechnicalStartTime(String technicalStartTime) {
<span class="fc" id="L1069">    this.technicalStartTime = technicalStartTime;</span>
<span class="fc" id="L1070">  }</span>

  /**
   * Returns the technical presenters
   *
   * @return the technical presenters
   */
  public List&lt;String&gt; getTechnicalPresenters() {
<span class="nc" id="L1078">    return technicalPresenters;</span>
  }

  /**
   * Sets the technical presenters
   *
   * @param technicalPresenters
   *          the technical presenters
   */
  public void setTechnicalPresenters(List&lt;String&gt; technicalPresenters) {
<span class="fc" id="L1088">    this.technicalPresenters = technicalPresenters;</span>
<span class="fc" id="L1089">  }</span>

  /**
   * Sets the external metadata for a catalog flavor.
   *
   * @param type
   *         The catalog type
   * @param metadata
   *         The metadata
   */
  public void setExtendedMetadata(String type, Map&lt;String, List&lt;String&gt;&gt; metadata) {
<span class="nc" id="L1100">    extendedMetadata.put(type, metadata);</span>
<span class="nc" id="L1101">  }</span>

  /**
   * Removes all external metadata.
   */
  public void resetExtendedMetadata() {
<span class="nc" id="L1107">    extendedMetadata.clear();</span>
<span class="nc" id="L1108">  }</span>

  /**
   * Returns the extended metadata
   *
   * @return the extended metadata in a map by catalog type
   */
  public Map&lt;String, Map&lt;String, List&lt;String&gt;&gt;&gt; getExtendedMetadata() {
<span class="nc" id="L1116">    return extendedMetadata;</span>
  }

  /**
   * Reads the recording event from the input stream.
   *
   * @param xml
   *          the input stream
   * @param unmarshaller the unmarshaller to use
   * @return the deserialized recording event
   * @throws IOException
   */
  public static Event valueOf(InputStream xml, Unmarshaller unmarshaller) throws IOException {
    try {
<span class="nc bnc" id="L1130" title="All 2 branches missed.">      if (context == null) {</span>
<span class="nc" id="L1131">        createJAXBContext();</span>
      }
<span class="nc" id="L1133">      return unmarshaller.unmarshal(XmlSafeParser.parse(xml), Event.class).getValue();</span>
<span class="nc" id="L1134">    } catch (JAXBException e) {</span>
<span class="nc bnc" id="L1135" title="All 2 branches missed.">      throw new IOException(e.getLinkedException() != null ? e.getLinkedException() : e);</span>
<span class="nc" id="L1136">    } catch (SAXException e) {</span>
<span class="nc" id="L1137">      throw new IOException(e);</span>
    } finally {
<span class="nc" id="L1139">      IoSupport.closeQuietly(xml);</span>
    }
  }

  /**
   * Reads the recording event from the input stream.
   *
   * @param json
   *          the input stream
   * @return the deserialized recording event
   * @throws JSONException
   * @throws XMLStreamException
   * @throws JAXBException
   */
  public static Event valueOfJson(InputStream json)
          throws IOException, JSONException, XMLStreamException, JAXBException {
    // TODO Get this to work, it is currently returning null properties for all properties.
<span class="nc bnc" id="L1156" title="All 2 branches missed.">    if (context == null) {</span>
<span class="nc" id="L1157">      createJAXBContext();</span>
    }

<span class="nc" id="L1160">    BufferedReader streamReader = new BufferedReader(new InputStreamReader(json, &quot;UTF-8&quot;));</span>
<span class="nc" id="L1161">    StringBuilder jsonStringBuilder = new StringBuilder();</span>
    String inputStr;
<span class="nc bnc" id="L1163" title="All 2 branches missed.">    while ((inputStr = streamReader.readLine()) != null) {</span>
<span class="nc" id="L1164">      jsonStringBuilder.append(inputStr);</span>
    }

<span class="nc" id="L1167">    JSONObject obj = new JSONObject(jsonStringBuilder.toString());</span>
<span class="nc" id="L1168">    Configuration config = new Configuration();</span>
<span class="nc" id="L1169">    config.setSupressAtAttributes(true);</span>
<span class="nc" id="L1170">    Map&lt;String, String&gt; xmlToJsonNamespaces = new HashMap&lt;String, String&gt;(1);</span>
<span class="nc" id="L1171">    xmlToJsonNamespaces.put(IndexObject.INDEX_XML_NAMESPACE, &quot;&quot;);</span>
<span class="nc" id="L1172">    config.setXmlToJsonNamespaces(xmlToJsonNamespaces);</span>
<span class="nc" id="L1173">    MappedNamespaceConvention con = new MappedNamespaceConvention(config);</span>
<span class="nc" id="L1174">    Unmarshaller unmarshaller = context.createUnmarshaller();</span>
    // CHECKSTYLE:OFF
    // the xml is parsed from json and should be safe
<span class="nc" id="L1177">    XMLStreamReader xmlStreamReader = new MappedXMLStreamReader(obj, con);</span>
<span class="nc" id="L1178">    Event event = (Event) unmarshaller.unmarshal(xmlStreamReader);</span>
    // CHECKSTYLE:ON
<span class="nc" id="L1180">    return event;</span>
  }

  /**
   * Initialize the JAXBContext.
   */
  private static void createJAXBContext() throws JAXBException {
<span class="fc" id="L1187">    context = JAXBContext.newInstance(Event.class);</span>
<span class="fc" id="L1188">  }</span>

  /**
   * Serializes the recording event.
   *
   * @return the serialized recording event
   */
  public String toJSON() {
    try {
<span class="fc bfc" id="L1197" title="All 2 branches covered.">      if (context == null) {</span>
<span class="fc" id="L1198">        createJAXBContext();</span>
      }
<span class="fc" id="L1200">      Marshaller marshaller = Event.context.createMarshaller();</span>

<span class="fc" id="L1202">      Configuration config = new Configuration();</span>
<span class="fc" id="L1203">      config.setSupressAtAttributes(true);</span>
<span class="fc" id="L1204">      MappedNamespaceConvention con = new MappedNamespaceConvention(config);</span>
<span class="fc" id="L1205">      StringWriter writer = new StringWriter();</span>
<span class="fc" id="L1206">      XMLStreamWriter xmlStreamWriter = new MappedXMLStreamWriter(con, writer) {</span>
        @Override
        public void writeStartElement(String prefix, String local, String uri) throws XMLStreamException {
<span class="fc" id="L1209">          super.writeStartElement(&quot;&quot;, local, &quot;&quot;);</span>
<span class="fc" id="L1210">        }</span>

        @Override
        public void writeStartElement(String uri, String local) throws XMLStreamException {
<span class="nc" id="L1214">          super.writeStartElement(&quot;&quot;, local, &quot;&quot;);</span>
<span class="nc" id="L1215">        }</span>

        @Override
        public void setPrefix(String pfx, String uri) throws XMLStreamException {
<span class="nc" id="L1219">        }</span>

        @Override
        public void setDefaultNamespace(String uri) throws XMLStreamException {
<span class="nc" id="L1223">        }</span>
      };

<span class="fc" id="L1226">      marshaller.marshal(this, xmlStreamWriter);</span>
<span class="fc" id="L1227">      return writer.toString();</span>
<span class="nc" id="L1228">    } catch (JAXBException e) {</span>
<span class="nc bnc" id="L1229" title="All 2 branches missed.">      throw new IllegalStateException(e.getLinkedException() != null ? e.getLinkedException() : e);</span>
    }
  }

  /**
   * Serializes the recording event to an XML format.
   *
   * @return A String with this event's content as XML.
   */
  public String toXML() {
    try {
<span class="nc bnc" id="L1240" title="All 2 branches missed.">      if (context == null) {</span>
<span class="nc" id="L1241">        createJAXBContext();</span>
      }
<span class="nc" id="L1243">      StringWriter writer = new StringWriter();</span>
<span class="nc" id="L1244">      Marshaller marshaller = Event.context.createMarshaller();</span>
<span class="nc" id="L1245">      marshaller.marshal(this, writer);</span>
<span class="nc" id="L1246">      return writer.toString();</span>
<span class="nc" id="L1247">    } catch (JAXBException e) {</span>
<span class="nc bnc" id="L1248" title="All 2 branches missed.">      throw new IllegalStateException(e.getLinkedException() != null ? e.getLinkedException() : e);</span>
    }
  }

  /**
   * Create an unmarshaller for events
   * @return an unmarshaller for events
   * @throws IOException
   */
  public static Unmarshaller createUnmarshaller() throws IOException {
    try {
<span class="nc bnc" id="L1259" title="All 2 branches missed.">      if (context == null) {</span>
<span class="nc" id="L1260">        createJAXBContext();</span>
      }
<span class="nc" id="L1262">      return context.createUnmarshaller();</span>
<span class="nc" id="L1263">    } catch (JAXBException e) {</span>
<span class="nc bnc" id="L1264" title="All 2 branches missed.">      throw new IOException(e.getLinkedException() != null ? e.getLinkedException() : e);</span>
    }
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>