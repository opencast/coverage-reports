<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>Comment.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-elasticsearch-index</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.elasticsearch.index.objects.event</a> &gt; <span class="el_source">Comment.java</span></div><h1>Comment.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.elasticsearch.index.objects.event;

import org.opencastproject.elasticsearch.index.objects.IndexObject;
import org.opencastproject.util.IoSupport;
import org.opencastproject.util.XmlSafeParser;

import org.codehaus.jettison.json.JSONException;
import org.codehaus.jettison.json.JSONObject;
import org.codehaus.jettison.mapped.Configuration;
import org.codehaus.jettison.mapped.MappedNamespaceConvention;
import org.codehaus.jettison.mapped.MappedXMLStreamReader;
import org.codehaus.jettison.mapped.MappedXMLStreamWriter;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.xml.sax.SAXException;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.StringWriter;
import java.util.HashMap;
import java.util.Map;

import javax.xml.bind.JAXBContext;
import javax.xml.bind.JAXBException;
import javax.xml.bind.Marshaller;
import javax.xml.bind.Unmarshaller;
import javax.xml.bind.annotation.XmlAccessType;
import javax.xml.bind.annotation.XmlAccessorType;
import javax.xml.bind.annotation.XmlElement;
import javax.xml.bind.annotation.XmlRootElement;
import javax.xml.bind.annotation.XmlType;
import javax.xml.stream.XMLStreamException;
import javax.xml.stream.XMLStreamReader;
import javax.xml.stream.XMLStreamWriter;

/**
 * Object wrapper for a recording comment.
 */
@XmlType(
        name = &quot;comment&quot;,
        namespace = IndexObject.INDEX_XML_NAMESPACE,
        propOrder = {
                &quot;id&quot;, &quot;reason&quot;, &quot;text&quot;, &quot;resolvedStatus&quot;
        }
)
@XmlRootElement(name = &quot;comment&quot;, namespace = IndexObject.INDEX_XML_NAMESPACE)
@XmlAccessorType(XmlAccessType.NONE)
public class Comment implements IndexObject {

  /** The logger */
<span class="nc" id="L74">  private static final Logger logger = LoggerFactory.getLogger(Comment.class);</span>

  /** The document id */
  public static final String DOCUMENT_TYPE = &quot;comment&quot;;

  /** The name of the surrounding XML tag to wrap a result of multiple comments */
  public static final String XML_SURROUNDING_TAG = &quot;comments&quot;;

  /** The identifier */
<span class="nc" id="L83">  @XmlElement(name = &quot;id&quot;)</span>
  private String id = null;

  /** The organization identifier */
<span class="nc" id="L87">  @XmlElement(name = &quot;reason&quot;)</span>
  private String reason = null;

  /** The title */
<span class="nc" id="L91">  @XmlElement(name = &quot;text&quot;)</span>
  private String text = null;

  /** The title */
<span class="nc" id="L95">  @XmlElement(name = &quot;resolvedStatus&quot;)</span>
  private Boolean resolvedStatus = null;

  /** Context for serializing and deserializing */
<span class="nc" id="L99">  private static JAXBContext context = null;</span>

  /**
   * Required default no arg constructor for JAXB.
   */
<span class="nc" id="L104">  public Comment() {</span>

<span class="nc" id="L106">  }</span>

  /**
   * The recording identifier.
   *
   * @param id
   *          the object id
   * @param reason
   *          the reason
   */
<span class="nc" id="L116">  public Comment(String id, String reason, String text, boolean resolvedStatus) {</span>
<span class="nc" id="L117">    this.id = id;</span>
<span class="nc" id="L118">    this.reason = reason;</span>
<span class="nc" id="L119">    this.text = text;</span>
<span class="nc" id="L120">    this.resolvedStatus = resolvedStatus;</span>
<span class="nc" id="L121">  }</span>

  public String getId() {
<span class="nc" id="L124">    return id;</span>
  }

  public void setId(String id) {
<span class="nc" id="L128">    this.id = id;</span>
<span class="nc" id="L129">  }</span>

  public String getReason() {
<span class="nc" id="L132">    return reason;</span>
  }

  public void setReason(String reason) {
<span class="nc" id="L136">    this.reason = reason;</span>
<span class="nc" id="L137">  }</span>

  public String getText() {
<span class="nc" id="L140">    return text;</span>
  }

  public void setText(String text) {
<span class="nc" id="L144">    this.text = text;</span>
<span class="nc" id="L145">  }</span>

  public Boolean isResolvedStatus() {
<span class="nc" id="L148">    return resolvedStatus;</span>
  }

  public void setResolvedStatus(Boolean resolvedStatus) {
<span class="nc" id="L152">    this.resolvedStatus = resolvedStatus;</span>
<span class="nc" id="L153">  }</span>

  /**
   * Reads the recording comment from the input stream.
   *
   * @param xml
   *          the input stream
   * @param unmarshaller the unmarshaller to use
   * @return the deserialized recording comment
   * @throws IOException
   */
  public static Comment valueOf(InputStream xml, Unmarshaller unmarshaller) throws IOException {
    try {
<span class="nc bnc" id="L166" title="All 2 branches missed.">      if (context == null) {</span>
<span class="nc" id="L167">        createJAXBContext();</span>
      }
<span class="nc" id="L169">      return unmarshaller.unmarshal(XmlSafeParser.parse(xml), Comment.class).getValue();</span>
<span class="nc" id="L170">    } catch (JAXBException e) {</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">      throw new IOException(e.getLinkedException() != null ? e.getLinkedException() : e);</span>
<span class="nc" id="L172">    } catch (SAXException e) {</span>
<span class="nc" id="L173">      throw new IOException(e);</span>
    } finally {
<span class="nc" id="L175">      IoSupport.closeQuietly(xml);</span>
    }
  }

  /**
   * Reads the recording comment from the input stream.
   *
   * @param json
   *          the input stream
   * @return the deserialized recording comment
   * @throws JSONException
   * @throws XMLStreamException
   * @throws JAXBException
   */
  public static Comment valueOfJson(InputStream json)
          throws IOException, JSONException, XMLStreamException, JAXBException {
    // TODO Get this to work, it is currently returning null properties for all properties.
<span class="nc bnc" id="L192" title="All 2 branches missed.">    if (context == null) {</span>
<span class="nc" id="L193">      createJAXBContext();</span>
    }

<span class="nc" id="L196">    BufferedReader streamReader = new BufferedReader(new InputStreamReader(json, &quot;UTF-8&quot;));</span>
<span class="nc" id="L197">    StringBuilder jsonStringBuilder = new StringBuilder();</span>
    String inputStr;
<span class="nc bnc" id="L199" title="All 2 branches missed.">    while ((inputStr = streamReader.readLine()) != null) {</span>
<span class="nc" id="L200">      jsonStringBuilder.append(inputStr);</span>
    }

<span class="nc" id="L203">    JSONObject obj = new JSONObject(jsonStringBuilder.toString());</span>
<span class="nc" id="L204">    Configuration config = new Configuration();</span>
<span class="nc" id="L205">    config.setSupressAtAttributes(true);</span>
<span class="nc" id="L206">    Map&lt;String, String&gt; xmlToJsonNamespaces = new HashMap&lt;String, String&gt;(1);</span>
<span class="nc" id="L207">    xmlToJsonNamespaces.put(IndexObject.INDEX_XML_NAMESPACE, &quot;&quot;);</span>
<span class="nc" id="L208">    config.setXmlToJsonNamespaces(xmlToJsonNamespaces);</span>
<span class="nc" id="L209">    MappedNamespaceConvention con = new MappedNamespaceConvention(config);</span>
<span class="nc" id="L210">    Unmarshaller unmarshaller = context.createUnmarshaller();</span>
    // CHECKSTYLE:OFF
    // the xml is parsed from json and should be safe
<span class="nc" id="L213">    XMLStreamReader xmlStreamReader = new MappedXMLStreamReader(obj, con);</span>
<span class="nc" id="L214">    Comment comment = (Comment) unmarshaller.unmarshal(xmlStreamReader);</span>
    // CHECKSTYLE:ON
<span class="nc" id="L216">    return comment;</span>
  }

  /**
   * Initialize the JAXBContext.
   */
  private static void createJAXBContext() throws JAXBException {
<span class="nc" id="L223">    context = JAXBContext.newInstance(Comment.class);</span>
<span class="nc" id="L224">  }</span>

  /**
   * Serializes the recording comment.
   *
   * @return the serialized recording comment
   */
  public String toJSON() {
    try {
<span class="nc bnc" id="L233" title="All 2 branches missed.">      if (context == null) {</span>
<span class="nc" id="L234">        createJAXBContext();</span>
      }
<span class="nc" id="L236">      Marshaller marshaller = Comment.context.createMarshaller();</span>

<span class="nc" id="L238">      Configuration config = new Configuration();</span>
<span class="nc" id="L239">      config.setSupressAtAttributes(true);</span>
<span class="nc" id="L240">      MappedNamespaceConvention con = new MappedNamespaceConvention(config);</span>
<span class="nc" id="L241">      StringWriter writer = new StringWriter();</span>
<span class="nc" id="L242">      XMLStreamWriter xmlStreamWriter = new MappedXMLStreamWriter(con, writer) {</span>
        @Override
        public void writeStartElement(String prefix, String local, String uri) throws XMLStreamException {
<span class="nc" id="L245">          super.writeStartElement(&quot;&quot;, local, &quot;&quot;);</span>
<span class="nc" id="L246">        }</span>

        @Override
        public void writeStartElement(String uri, String local) throws XMLStreamException {
<span class="nc" id="L250">          super.writeStartElement(&quot;&quot;, local, &quot;&quot;);</span>
<span class="nc" id="L251">        }</span>

        @Override
        public void setPrefix(String pfx, String uri) throws XMLStreamException {
<span class="nc" id="L255">        }</span>

        @Override
        public void setDefaultNamespace(String uri) throws XMLStreamException {
<span class="nc" id="L259">        }</span>
      };

<span class="nc" id="L262">      marshaller.marshal(this, xmlStreamWriter);</span>
<span class="nc" id="L263">      return writer.toString();</span>
<span class="nc" id="L264">    } catch (JAXBException e) {</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">      throw new IllegalStateException(e.getLinkedException() != null ? e.getLinkedException() : e);</span>
    }
  }

  /**
   * Serializes the recording comment to an XML format.
   *
   * @return A String with this comment's content as XML.
   */
  public String toXML() {
    try {
<span class="nc bnc" id="L276" title="All 2 branches missed.">      if (context == null) {</span>
<span class="nc" id="L277">        createJAXBContext();</span>
      }
<span class="nc" id="L279">      StringWriter writer = new StringWriter();</span>
<span class="nc" id="L280">      Marshaller marshaller = Comment.context.createMarshaller();</span>
<span class="nc" id="L281">      marshaller.marshal(this, writer);</span>
<span class="nc" id="L282">      return writer.toString();</span>
<span class="nc" id="L283">    } catch (JAXBException e) {</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">      throw new IllegalStateException(e.getLinkedException() != null ? e.getLinkedException() : e);</span>
    }
  }

  /**
   * Create an unmarshaller for comments
   * @return an unmarshaller for comments
   * @throws IOException
   */
  public static Unmarshaller createUnmarshaller() throws IOException {
    try {
<span class="nc bnc" id="L295" title="All 2 branches missed.">      if (context == null) {</span>
<span class="nc" id="L296">        createJAXBContext();</span>
      }
<span class="nc" id="L298">      return context.createUnmarshaller();</span>
<span class="nc" id="L299">    } catch (JAXBException e) {</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">      throw new IOException(e.getLinkedException() != null ? e.getLinkedException() : e);</span>
    }
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>