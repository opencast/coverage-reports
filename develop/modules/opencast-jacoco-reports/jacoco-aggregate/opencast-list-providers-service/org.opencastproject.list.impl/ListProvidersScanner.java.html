<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ListProvidersScanner.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-list-providers-service</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.list.impl</a> &gt; <span class="el_source">ListProvidersScanner.java</span></div><h1>ListProvidersScanner.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.list.impl;

import static org.opencastproject.list.impl.ListProvidersServiceImpl.ALL_ORGANIZATIONS;
import static org.opencastproject.list.impl.ListProvidersServiceImpl.ResourceTuple;

import org.opencastproject.list.api.ListProvidersService;
import org.opencastproject.list.api.ResourceListProvider;
import org.opencastproject.list.api.ResourceListQuery;

import org.apache.commons.lang3.BooleanUtils;
import org.apache.commons.lang3.StringUtils;
import org.apache.felix.fileinstall.ArtifactInstaller;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;
import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import java.util.Objects;
import java.util.Properties;

@Component(
    immediate = true,
    service = { ArtifactInstaller.class,ListProvidersScanner.class },
    property = {
        &quot;service.description=List Providers Scanner&quot;
    }
)
<span class="fc" id="L57">public class ListProvidersScanner implements ArtifactInstaller {</span>
  /** The directory name that has the properties file defining the list providers **/
  public static final String LIST_PROVIDERS_DIRECTORY = &quot;listproviders&quot;;
  /** The key to look for in the properties file to name the list provider. **/
  public static final String LIST_NAME_KEY = &quot;list.name&quot;;
  /** The key to look for in the properties file defining if the list's values should be translated */
  public static final String LIST_TRANSLATABLE_KEY = &quot;list.translatable&quot;;
  /** The key to attach this list to a particular org, if not present then all orgs can get list **/
  public static final String LIST_ORG_KEY = &quot;list.org&quot;;
  /** The key to define a default value **/
  public static final String LIST_DEFAULT_KEY = &quot;list.default&quot;;


  /** The logging instance */
<span class="fc" id="L71">  private static final Logger logger = LoggerFactory.getLogger(ListProvidersScanner.class);</span>
  /** The Map to go from file locations of properties files to list names. **/
<span class="fc" id="L73">  private Map&lt;String, ListProvidersServiceImpl.ResourceTuple&gt; fileToListNames = new HashMap&lt;&gt;();</span>
  /** The list providers service to add the list provider to. **/
  private ListProvidersService listProvidersService;

  @Reference
  public void setListProvidersService(ListProvidersService listProvidersService) {
<span class="fc" id="L79">    this.listProvidersService = listProvidersService;</span>
<span class="fc" id="L80">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.apache.felix.fileinstall.ArtifactListener#canHandle(java.io.File)
   */
  @Override
  public boolean canHandle(File artifact) {
<span class="fc bfc" id="L89" title="All 2 branches covered.">    return LIST_PROVIDERS_DIRECTORY.equals(artifact.getParentFile().getName())</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">            &amp;&amp; artifact.getName().endsWith(&quot;.properties&quot;);</span>
  }

  /**
   * Inner class used to represent a new list.
   */
  private static class SingleResourceListProviderImpl implements ResourceListProvider {
    private String listName;
    private String orgId;
    private Map&lt;String, String&gt; list;
    private boolean translatable;
    private String defaultKey;

    SingleResourceListProviderImpl(String listName, Map&lt;String, String&gt; list, String organizationId,
<span class="fc" id="L104">            boolean translatable) {</span>
<span class="fc" id="L105">      this.listName = listName;</span>
<span class="fc" id="L106">      this.list = list;</span>
<span class="fc" id="L107">      this.orgId = organizationId;</span>
<span class="fc" id="L108">      this.translatable = translatable;</span>
<span class="fc" id="L109">    }</span>

    public String getListName() {
<span class="nc" id="L112">      return listName;</span>
    }

    @Override
    public String[] getListNames() {
<span class="nc" id="L117">      return new String[] { listName };</span>
    }

    @Override
    public Map&lt;String, String&gt; getList(String listName, ResourceListQuery query)
            throws ListProviderNotFoundException {
<span class="fc" id="L123">      logger.debug(&quot;Getting list {} with query {} for org {}&quot;, listName, query, orgId);</span>
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">      if (this.listName.equals(listName)) {</span>
<span class="fc" id="L125">        return Collections.unmodifiableMap(list);</span>
      } else {
<span class="nc" id="L127">        throw new ListProviderNotFoundException(&quot;Unable to read list data from file&quot;);</span>
      }
    }

    @Override
    public boolean isTranslatable(String listName) {
<span class="fc" id="L133">      return translatable;</span>
    }

    public void setDefault(String defaultKey) {
<span class="fc" id="L137">      this.defaultKey = defaultKey;</span>
<span class="fc" id="L138">    }</span>

    @Override
    public String getDefault() {
<span class="fc" id="L142">      return defaultKey;</span>
    }
  }

  /**
   * Adds a resource list provider to the provider service
   *
   * @param path the path to the property file
   * @param properties the properties from the property file
   */
  private void addResourceListProvider(String path, Properties properties) {
<span class="fc" id="L153">    String listName = properties.getProperty(LIST_NAME_KEY);</span>
<span class="fc bfc" id="L154" title="All 2 branches covered.">    if (StringUtils.isBlank(listName)) {</span>
<span class="fc" id="L155">      logger.error(&quot;Unable to add {} as a list provider because the {} entry was empty. &quot;</span>
              + &quot;Please add it to get this list provider to work.&quot;, path, LIST_NAME_KEY);
<span class="fc" id="L157">      return;</span>
    }
<span class="fc" id="L159">    String defaultKey = properties.getProperty(LIST_DEFAULT_KEY);</span>
<span class="fc" id="L160">    boolean translatable = BooleanUtils.toBoolean(properties.getProperty(LIST_TRANSLATABLE_KEY));</span>
<span class="fc" id="L161">    String orgId = Objects.toString(properties.getProperty(LIST_ORG_KEY), ALL_ORGANIZATIONS);</span>

<span class="fc" id="L163">    logger.info(&quot;Adding {} for {}&quot;, listName, orgId);</span>

<span class="fc" id="L165">    HashMap&lt;String, String&gt; list = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">    for (Map.Entry&lt;Object, Object&gt; entry: properties.entrySet()) {</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">      switch (entry.getKey().toString().toLowerCase()) {</span>
        case LIST_NAME_KEY:
        case LIST_TRANSLATABLE_KEY:
        case LIST_DEFAULT_KEY:
        case LIST_ORG_KEY:
<span class="fc" id="L172">          logger.debug(&quot;Skipping key: {}&quot;, entry.getKey());</span>
<span class="fc" id="L173">          break;</span>
        default:
<span class="fc" id="L175">          list.put(entry.getKey().toString(), entry.getValue().toString());</span>
<span class="fc" id="L176">          logger.debug(&quot;Found entry: {}&quot;, entry);</span>
      }
<span class="fc" id="L178">    }</span>

<span class="fc" id="L180">    SingleResourceListProviderImpl listProvider = new SingleResourceListProviderImpl(</span>
            listName,
            list,
            orgId,
            translatable);
<span class="fc bfc" id="L185" title="All 2 branches covered.">    if (StringUtils.isNotBlank(defaultKey)) {</span>
<span class="fc" id="L186">      listProvider.setDefault(defaultKey);</span>
    }
<span class="fc" id="L188">    fileToListNames.put(path, new ResourceTuple(listName, orgId));</span>
<span class="fc" id="L189">    listProvidersService.addProvider(listName, listProvider, orgId);</span>
<span class="fc" id="L190">  }</span>

  private static Properties readProperties(File file) throws IOException {
<span class="fc" id="L193">    Properties properties = new Properties();</span>
<span class="fc" id="L194">    try (InputStreamReader reader = new InputStreamReader(new FileInputStream(file), StandardCharsets.UTF_8)) {</span>
<span class="fc" id="L195">      properties.load(reader);</span>
    }
<span class="fc" id="L197">    return properties;</span>
  }

  /**
   * Remove a list provider based upon the location of its configuration file.
   *
   * @param artifact
   *          The File representing the configuration file for the list.
   */
  private void removeResourceListProvider(File artifact) {
<span class="fc" id="L207">    ResourceTuple resource = fileToListNames.remove(artifact.getAbsolutePath());</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">    if (resource != null) {</span>
<span class="nc" id="L209">      logger.info(&quot;Removing {} for {}&quot;, resource.getResourceName(), resource.getOrganizationId());</span>
<span class="nc" id="L210">      listProvidersService.removeProvider(resource.getResourceName(), resource.getOrganizationId());</span>
    }
<span class="fc" id="L212">  }</span>

  @Override
  public void install(File artifact) {
<span class="fc" id="L216">    String filePath = artifact.getAbsolutePath();</span>
<span class="fc" id="L217">    logger.info(&quot;Installing list provider {}&quot;, filePath);</span>

    Properties properties;
    try {
<span class="fc" id="L221">      properties = readProperties(artifact);</span>
<span class="nc" id="L222">    } catch (IOException e) {</span>
<span class="nc" id="L223">      logger.error(&quot;Unable to read file &quot; + filePath);</span>
<span class="nc" id="L224">      return;</span>
<span class="fc" id="L225">    }</span>
<span class="fc" id="L226">    addResourceListProvider(filePath, properties);</span>
<span class="fc" id="L227">  }</span>

  @Override
  public void update(File artifact) {
<span class="fc" id="L231">    String filePath = artifact.getAbsolutePath();</span>
<span class="fc" id="L232">    logger.info(&quot;Updating list provider {}&quot;, filePath);</span>
    // get the previous affiliation
<span class="fc" id="L234">    ResourceTuple resource = fileToListNames.get(filePath);</span>

    Properties properties;
    try {
<span class="fc" id="L238">      properties = readProperties(artifact);</span>
<span class="nc" id="L239">    } catch (IOException e) {</span>
<span class="nc" id="L240">      logger.error(&quot;Unable to read file &quot; + filePath);</span>
<span class="nc" id="L241">      return;</span>
<span class="fc" id="L242">    }</span>
<span class="fc" id="L243">    String orgId = Objects.toString(properties.getProperty(LIST_ORG_KEY), ALL_ORGANIZATIONS);</span>
<span class="pc bpc" id="L244" title="3 of 4 branches missed.">    if (resource != null &amp;&amp; !orgId.equals(resource.getOrganizationId())) { // the org ID was changed</span>
<span class="nc" id="L245">      removeResourceListProvider(artifact);</span>
    }
<span class="fc" id="L247">    addResourceListProvider(filePath, properties);</span>
<span class="fc" id="L248">  }</span>

  @Override
  public void uninstall(File artifact) {
<span class="fc" id="L252">    logger.info(&quot;Removing list provider {}&quot;, artifact.getAbsolutePath());</span>
<span class="fc" id="L253">    removeResourceListProvider(artifact);</span>
<span class="fc" id="L254">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>