<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SchedulerUtil.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-scheduler-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.scheduler.impl</a> &gt; <span class="el_source">SchedulerUtil.java</span></div><h1>SchedulerUtil.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.scheduler.impl;

import org.opencastproject.mediapackage.Catalog;
import org.opencastproject.mediapackage.EName;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.mediapackage.MediaPackageElementFlavor;
import org.opencastproject.mediapackage.MediaPackageElements;
import org.opencastproject.metadata.dublincore.DublinCore;
import org.opencastproject.metadata.dublincore.DublinCoreCatalog;
import org.opencastproject.metadata.dublincore.DublinCoreUtil;
import org.opencastproject.metadata.dublincore.DublinCoreValue;
import org.opencastproject.scheduler.api.SchedulerEvent;
import org.opencastproject.scheduler.api.TechnicalMetadata;
import org.opencastproject.security.api.AccessControlList;
import org.opencastproject.security.api.AccessControlUtil;
import org.opencastproject.util.Checksum;
import org.opencastproject.util.DateTimeSupport;
import org.opencastproject.workspace.api.Workspace;

import org.apache.commons.lang3.CharUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Optional;
import java.util.Set;
import java.util.TreeMap;

/**
 * Functions to support scheduler service operations.
 */
public final class SchedulerUtil {

  /** The logger */
<span class="fc" id="L65">  private static final Logger logger = LoggerFactory.getLogger(SchedulerUtil.class);</span>

  private SchedulerUtil() {
  }

<span class="fc" id="L70">  public static final Comparator&lt;Catalog&gt; sortCatalogById = new Comparator&lt;Catalog&gt;() {</span>
    @Override
    public int compare(Catalog c1, Catalog c2) {
<span class="fc" id="L73">      return c1.getIdentifier().compareTo(c2.getIdentifier());</span>
    }
  };

  public static String calculateChecksum(
      Workspace workspace,
      List&lt;MediaPackageElementFlavor&gt; eventCatalogUIAdapterFlavors,
      Date startDateTime,
      Date endDateTime,
      String captureAgentId,
      Set&lt;String&gt; userIds,
      MediaPackage mediaPackage,
      Optional&lt;DublinCoreCatalog&gt; episodeDublincore,
      Map&lt;String, String&gt; wfProperties,
      Map&lt;String, String&gt; finalCaProperties,
      AccessControlList acl) {
<span class="fc" id="L89">    List&lt;String&gt; userIdsList = new ArrayList&lt;&gt;(userIds);</span>
<span class="fc" id="L90">    Collections.sort(userIdsList);</span>
<span class="fc" id="L91">    final MessageDigest messageDigest = mkMd5MessageDigest();</span>
<span class="fc" id="L92">    messageDigest.update(mkChecksumInput(startDateTime));</span>
<span class="fc" id="L93">    messageDigest.update(mkChecksumInput(endDateTime));</span>
<span class="fc" id="L94">    messageDigest.update(mkChecksumInput(captureAgentId));</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">    for (String user : userIdsList) {</span>
<span class="fc" id="L96">      messageDigest.update(mkChecksumInput(user));</span>
<span class="fc" id="L97">    }</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">    if (episodeDublincore.isPresent()) {</span>
<span class="fc" id="L99">      Catalog episodeCatalog = Arrays.stream(mediaPackage.getCatalogs())</span>
<span class="fc" id="L100">          .filter(catalog -&gt; MediaPackageElements.EPISODE.matches(catalog.getFlavor()))</span>
<span class="fc" id="L101">          .findFirst()</span>
<span class="fc" id="L102">          .orElse(null);</span>
<span class="fc" id="L103">      Checksum checksum = episodeCatalog.getChecksum();</span>
<span class="fc bfc" id="L104" title="All 2 branches covered.">      if (checksum == null) {</span>
<span class="fc" id="L105">        checksum = DublinCoreUtil.calculateChecksum(episodeDublincore.get());</span>
<span class="fc" id="L106">        episodeCatalog.setChecksum(checksum);</span>
      }
<span class="fc" id="L108">      messageDigest.update(mkChecksumInput(checksum.toString()));</span>
    }
    // Add extended metadata to calculation
<span class="fc" id="L111">    Catalog[] catalogs = mediaPackage.getCatalogs();</span>
<span class="fc" id="L112">    Arrays.sort(catalogs, sortCatalogById);</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">    for (Catalog c : catalogs) {</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">      if (eventCatalogUIAdapterFlavors.contains(c.getFlavor())) {</span>
<span class="fc" id="L115">        Checksum checksum = c.getChecksum();</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">        if (checksum == null) {</span>
<span class="fc" id="L117">          DublinCoreCatalog dublinCore = DublinCoreUtil.loadDublinCore(workspace, c);</span>
<span class="fc" id="L118">          checksum = DublinCoreUtil.calculateChecksum(dublinCore);</span>
<span class="fc" id="L119">          c.setChecksum(checksum);</span>
        }
<span class="fc" id="L121">        messageDigest.update(mkChecksumInput(checksum.toString()));</span>
      }
    }
<span class="fc" id="L124">    messageDigest.update(mkChecksumInput(AccessControlUtil.calculateChecksum(acl).toString()));</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">    for (Entry&lt;String, String&gt; entry : new TreeMap&lt;&gt;(wfProperties).entrySet()) {</span>
<span class="fc" id="L126">      messageDigest.update(mkChecksumInput(entry.getKey()));</span>
<span class="fc" id="L127">      messageDigest.update(mkChecksumInput(entry.getValue()));</span>
<span class="fc" id="L128">    }</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">    for (Entry&lt;String, String&gt; entry : new TreeMap&lt;&gt;(finalCaProperties).entrySet()) {</span>
<span class="fc" id="L130">      messageDigest.update(mkChecksumInput(entry.getKey()));</span>
<span class="fc" id="L131">      messageDigest.update(mkChecksumInput(entry.getValue()));</span>
<span class="fc" id="L132">    }</span>
<span class="fc" id="L133">    return Checksum.convertToHex(messageDigest.digest());</span>
  }

  private static MessageDigest mkMd5MessageDigest() {
    try {
<span class="fc" id="L138">      return MessageDigest.getInstance(&quot;MD5&quot;);</span>
<span class="nc" id="L139">    } catch (NoSuchAlgorithmException e) {</span>
<span class="nc" id="L140">      logger.error(&quot;Unable to create md5 message digest&quot;);</span>
<span class="nc" id="L141">      throw new RuntimeException(e);</span>
    }
  }

  private static byte[] mkChecksumInput(String input) {
<span class="fc" id="L146">    return input.getBytes(StandardCharsets.UTF_8);</span>
  }

  private static byte[] mkChecksumInput(Date input) {
<span class="fc" id="L150">    return mkChecksumInput(Long.toString(input.getTime()));</span>
  }

  /**
   * Converts a scheduler event to a human readable string
   *
   * @param workspace
   *          the workspace
   * @param catalogFlavors
   *          the event catalog flavors
   * @param event
   *          the scheduler event
   * @return a human readable string
   */
  public static String toHumanReadableString(Workspace workspace, List&lt;MediaPackageElementFlavor&gt; catalogFlavors,
          SchedulerEvent event) {
<span class="nc" id="L166">    TechnicalMetadata technicalMetadata = event.getTechnicalMetadata();</span>
<span class="nc" id="L167">    StringBuilder sb = new StringBuilder(&quot;Event: &quot;).append(CharUtils.LF);</span>
<span class="nc" id="L168">    sb.append(&quot;- &quot;).append(event.getEventId()).append(CharUtils.LF);</span>
<span class="nc" id="L169">    sb.append(CharUtils.LF);</span>

<span class="nc" id="L171">    sb.append(&quot;Version&quot;).append(CharUtils.LF);</span>
<span class="nc" id="L172">    sb.append(&quot;- &quot;).append(event.getVersion()).append(CharUtils.LF);</span>
<span class="nc" id="L173">    sb.append(CharUtils.LF);</span>

<span class="nc" id="L175">    sb.append(&quot;Start&quot;).append(CharUtils.LF);</span>
<span class="nc" id="L176">    sb.append(&quot;- &quot;).append(DateTimeSupport.toUTC(technicalMetadata.getStartDate().getTime())).append(CharUtils.LF);</span>
<span class="nc" id="L177">    sb.append(CharUtils.LF);</span>

<span class="nc" id="L179">    sb.append(&quot;End&quot;).append(CharUtils.LF);</span>
<span class="nc" id="L180">    sb.append(&quot;- &quot;).append(DateTimeSupport.toUTC(technicalMetadata.getEndDate().getTime())).append(CharUtils.LF);</span>
<span class="nc" id="L181">    sb.append(CharUtils.LF);</span>

<span class="nc" id="L183">    sb.append(&quot;Room&quot;).append(CharUtils.LF);</span>
<span class="nc" id="L184">    sb.append(&quot;- &quot;).append(technicalMetadata.getAgentId()).append(CharUtils.LF);</span>
<span class="nc" id="L185">    sb.append(CharUtils.LF);</span>

<span class="nc" id="L187">    sb.append(&quot;Scheduling configuration&quot;).append(CharUtils.LF);</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">    for (Entry&lt;String, String&gt; entry : technicalMetadata.getCaptureAgentConfiguration().entrySet()) {</span>
<span class="nc" id="L189">      sb.append(&quot;- &quot;).append(entry.getKey()).append(&quot;: &quot;).append(entry.getValue()).append(CharUtils.LF);</span>
<span class="nc" id="L190">    }</span>
<span class="nc" id="L191">    sb.append(CharUtils.LF);</span>

<span class="nc" id="L193">    sb.append(&quot;Presenters&quot;).append(CharUtils.LF);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">    for (String presenter : technicalMetadata.getPresenters()) {</span>
<span class="nc" id="L195">      sb.append(&quot;- &quot;).append(presenter).append(CharUtils.LF);</span>
<span class="nc" id="L196">    }</span>
<span class="nc" id="L197">    sb.append(CharUtils.LF);</span>

<span class="nc" id="L199">    sb.append(&quot;Workflow configuration&quot;).append(CharUtils.LF);</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">    for (Entry&lt;String, String&gt; entry : technicalMetadata.getWorkflowProperties().entrySet()) {</span>
<span class="nc" id="L201">      sb.append(&quot;- &quot;).append(entry.getKey()).append(&quot;: &quot;).append(entry.getValue()).append(CharUtils.LF);</span>
<span class="nc" id="L202">    }</span>
<span class="nc" id="L203">    sb.append(CharUtils.LF);</span>

<span class="nc bnc" id="L205" title="All 2 branches missed.">    for (Catalog c : event.getMediaPackage().getCatalogs()) {</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">      if (!catalogFlavors.contains(c.getFlavor()))</span>
<span class="nc" id="L207">        continue;</span>

      DublinCoreCatalog dublinCore;
      try {
<span class="nc" id="L211">        dublinCore = DublinCoreUtil.loadDublinCore(workspace, c);</span>
<span class="nc" id="L212">      } catch (Exception e) {</span>
<span class="nc" id="L213">        logger.error(&quot;Unable to read event dublincore&quot;, e);</span>
<span class="nc" id="L214">        continue;</span>
<span class="nc" id="L215">      }</span>

<span class="nc" id="L217">      sb.append(&quot;Event metadata &quot;).append(&quot;(&quot;).append(c.getFlavor().toString()).append(&quot;)&quot;).append(CharUtils.LF);</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">      for (Entry&lt;EName, List&lt;DublinCoreValue&gt;&gt; entry : dublinCore.getValues().entrySet()) {</span>
<span class="nc" id="L219">        EName eName = entry.getKey();</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">        for (DublinCoreValue value : entry.getValue()) {</span>
<span class="nc" id="L221">          sb.append(&quot;- &quot;).append(eName.getNamespaceURI()).append(&quot;:&quot;).append(eName.getLocalName()).append(&quot;: &quot;)</span>
<span class="nc" id="L222">                  .append(value.getValue());</span>

<span class="nc bnc" id="L224" title="All 2 branches missed.">          boolean hasLanguageDefined = !DublinCore.LANGUAGE_UNDEFINED.equals(value.getLanguage());</span>

<span class="nc bnc" id="L226" title="All 4 branches missed.">          if (hasLanguageDefined || value.getEncodingScheme().isPresent()) {</span>
<span class="nc" id="L227">            sb.append(&quot; (&quot;);</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">            if (hasLanguageDefined) {</span>
<span class="nc" id="L229">              sb.append(&quot;lang:&quot;).append(value.getLanguage());</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">              if (value.getEncodingScheme().isPresent())</span>
<span class="nc" id="L231">                sb.append(&quot;/&quot;);</span>
            }

<span class="nc bnc" id="L234" title="All 2 branches missed.">            if (value.getEncodingScheme().isPresent()) {</span>
<span class="nc" id="L235">              sb.append(value.getEncodingScheme().get().getLocalName());</span>
            }
<span class="nc" id="L237">            sb.append(&quot;)&quot;);</span>
          }
<span class="nc" id="L239">          sb.append(CharUtils.LF);</span>
<span class="nc" id="L240">        }</span>
<span class="nc" id="L241">      }</span>
<span class="nc" id="L242">      sb.append(CharUtils.LF);</span>
    }
<span class="nc" id="L244">    return sb.toString();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>