<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CalendarGenerator.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-scheduler-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.scheduler.impl</a> &gt; <span class="el_source">CalendarGenerator.java</span></div><h1>CalendarGenerator.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.scheduler.impl;

import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.metadata.dublincore.DublinCore;
import org.opencastproject.metadata.dublincore.DublinCoreCatalog;
import org.opencastproject.security.api.UnauthorizedException;
import org.opencastproject.series.api.SeriesException;
import org.opencastproject.series.api.SeriesService;
import org.opencastproject.util.NotFoundException;

import net.fortuna.ical4j.model.Calendar;
import net.fortuna.ical4j.model.DateTime;
import net.fortuna.ical4j.model.ParameterList;
import net.fortuna.ical4j.model.component.VEvent;
import net.fortuna.ical4j.model.parameter.Encoding;
import net.fortuna.ical4j.model.parameter.FmtType;
import net.fortuna.ical4j.model.parameter.Value;
import net.fortuna.ical4j.model.parameter.XParameter;
import net.fortuna.ical4j.model.property.Attach;
import net.fortuna.ical4j.model.property.CalScale;
import net.fortuna.ical4j.model.property.Description;
import net.fortuna.ical4j.model.property.LastModified;
import net.fortuna.ical4j.model.property.Location;
import net.fortuna.ical4j.model.property.ProdId;
import net.fortuna.ical4j.model.property.RelatedTo;
import net.fortuna.ical4j.model.property.Uid;
import net.fortuna.ical4j.model.property.Version;

import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

/**
 * Create an iCalendar from the provided scheduled events.
 */
public class CalendarGenerator {

  /** Logging utility */
<span class="fc" id="L65">  private static final Logger logger = LoggerFactory.getLogger(CalendarGenerator.class);</span>

  /** iCalendar */
  protected Calendar cal;

  /** Series service for Series DC retrieval */
  protected SeriesService seriesService;

<span class="fc" id="L73">  private final Map&lt;String, DublinCoreCatalog&gt; series = new HashMap&lt;&gt;();</span>

  /**
   * Default constructor that creates a CalendarGenerator object
   *
   * @param seriesService
   *          the series service
   */
<span class="fc" id="L81">  public CalendarGenerator(SeriesService seriesService) {</span>
<span class="fc" id="L82">    cal = new Calendar();</span>
<span class="fc" id="L83">    cal.getProperties().add(new ProdId(&quot;Opencast Calendar File 0.5&quot;));</span>
<span class="fc" id="L84">    cal.getProperties().add(Version.VERSION_2_0);</span>
<span class="fc" id="L85">    cal.getProperties().add(CalScale.GREGORIAN);</span>
<span class="fc" id="L86">    this.seriesService = seriesService;</span>
<span class="fc" id="L87">  }</span>

  /**
   * gets the iCalendar creates by this object.
   *
   * @return the iCalendar
   */
  public Calendar getCalendar() {
<span class="fc" id="L95">    return cal;</span>
  }

  /**
   * Sets an iCalender to work with
   *
   * @param cal
   *          the iCalendar to set
   */
  public void setCalendar(Calendar cal) {
<span class="nc" id="L105">    this.cal = cal;</span>
<span class="nc" id="L106">  }</span>

  /**
   * Adds an SchedulerEvent as a new entry to this iCalendar
   *
   * @param mp
   *          {@link MediaPackage} of event
   * @param agentId
   *          the agent identifier
   * @param start
   *          the start date
   * @param end
   *          the end date
   * @param captureAgentMetadata
   *          properties for capture agent metadata
   *
   * @return true if the event could be added.
   */
  public boolean addEvent(MediaPackage mp, DublinCoreCatalog catalog, String agentId, Date start, Date end,
          Date lastModified, String captureAgentMetadata) {
<span class="fc" id="L126">    String eventId = mp.getIdentifier().toString();</span>

<span class="fc" id="L128">    logger.debug(&quot;Creating iCalendar VEvent from scheduled event '{}'&quot;, eventId);</span>

<span class="fc" id="L130">    DateTime startDate = new DateTime(start);</span>
<span class="fc" id="L131">    DateTime endDate = new DateTime(end);</span>
<span class="fc" id="L132">    Date marginEndDate = new org.joda.time.DateTime(endDate.getTime()).plusHours(1).toDate();</span>
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">    if (marginEndDate.before(new Date())) {</span>
<span class="nc" id="L134">      logger.debug(&quot;Event has already passed more than an hour, skipping!&quot;);</span>
<span class="nc" id="L135">      return false;</span>
    }
<span class="fc" id="L137">    startDate.setUtc(true);</span>
<span class="fc" id="L138">    endDate.setUtc(true);</span>
<span class="fc" id="L139">    String seriesID = null;</span>

<span class="fc" id="L141">    VEvent event = new VEvent(startDate, endDate, catalog.getFirst(DublinCore.PROPERTY_TITLE));</span>
    try {
<span class="fc" id="L143">      event.getProperties().add(new Uid(eventId));</span>

<span class="fc" id="L145">      DateTime lastModifiedDate = new DateTime(lastModified);</span>
<span class="fc" id="L146">      lastModifiedDate.setUtc(true);</span>
<span class="fc" id="L147">      event.getProperties().add(new LastModified(lastModifiedDate));</span>

<span class="pc bpc" id="L149" title="1 of 2 branches missed.">      if (StringUtils.isNotEmpty(catalog.getFirst(DublinCore.PROPERTY_DESCRIPTION))) {</span>
<span class="fc" id="L150">        event.getProperties().add(new Description(catalog.getFirst(DublinCore.PROPERTY_DESCRIPTION)));</span>
      }
<span class="fc" id="L152">      event.getProperties().add(new Location(agentId));</span>
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">      if (StringUtils.isNotEmpty(catalog.getFirst(DublinCore.PROPERTY_IS_PART_OF))) {</span>
<span class="nc" id="L154">        seriesID = catalog.getFirst(DublinCore.PROPERTY_IS_PART_OF);</span>
<span class="nc" id="L155">        event.getProperties().add(new RelatedTo(seriesID));</span>
      }

<span class="fc" id="L158">      ParameterList dcParameters = new ParameterList();</span>
<span class="fc" id="L159">      dcParameters.add(new FmtType(&quot;application/xml&quot;));</span>
<span class="fc" id="L160">      dcParameters.add(Value.BINARY);</span>
<span class="fc" id="L161">      dcParameters.add(Encoding.BASE64);</span>
<span class="fc" id="L162">      dcParameters.add(new XParameter(&quot;X-APPLE-FILENAME&quot;, &quot;episode.xml&quot;));</span>
<span class="fc" id="L163">      Attach metadataAttachment = new Attach(dcParameters, catalog.toXmlString().getBytes(&quot;UTF-8&quot;));</span>
<span class="fc" id="L164">      event.getProperties().add(metadataAttachment);</span>

<span class="fc" id="L166">      String seriesDC = getSeriesDublinCoreAsString(seriesID);</span>
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">      if (seriesDC != null) {</span>
<span class="nc" id="L168">        logger.debug(&quot;Attaching series {} information to event {}&quot;, seriesID, eventId);</span>
<span class="nc" id="L169">        ParameterList sDcParameters = new ParameterList();</span>
<span class="nc" id="L170">        sDcParameters.add(new FmtType(&quot;application/xml&quot;));</span>
<span class="nc" id="L171">        sDcParameters.add(Value.BINARY);</span>
<span class="nc" id="L172">        sDcParameters.add(Encoding.BASE64);</span>
<span class="nc" id="L173">        sDcParameters.add(new XParameter(&quot;X-APPLE-FILENAME&quot;, &quot;series.xml&quot;));</span>
<span class="nc" id="L174">        Attach seriesAttachment = new Attach(sDcParameters, seriesDC.getBytes(&quot;UTF-8&quot;));</span>
<span class="nc" id="L175">        event.getProperties().add(seriesAttachment);</span>
<span class="nc" id="L176">      } else {</span>
<span class="fc" id="L177">        logger.debug(&quot;No series provided for event {}.&quot;, eventId);</span>
      }

<span class="fc" id="L180">      ParameterList caParameters = new ParameterList();</span>
<span class="fc" id="L181">      caParameters.add(new FmtType(&quot;application/text&quot;));</span>
<span class="fc" id="L182">      caParameters.add(Value.BINARY);</span>
<span class="fc" id="L183">      caParameters.add(Encoding.BASE64);</span>
<span class="fc" id="L184">      caParameters.add(new XParameter(&quot;X-APPLE-FILENAME&quot;, &quot;org.opencastproject.capture.agent.properties&quot;));</span>
<span class="fc" id="L185">      Attach agentsAttachment = new Attach(caParameters, captureAgentMetadata.getBytes(&quot;UTF-8&quot;));</span>
<span class="fc" id="L186">      event.getProperties().add(agentsAttachment);</span>

<span class="nc" id="L188">    } catch (Exception e) {</span>
<span class="nc" id="L189">      logger.error(&quot;Unable to add event '{}' to recording calendar&quot;, eventId, e);</span>
<span class="nc" id="L190">      return false;</span>
<span class="fc" id="L191">    }</span>

<span class="fc" id="L193">    cal.getComponents().add(event);</span>

<span class="fc" id="L195">    logger.debug(&quot;new VEvent = {} &quot;, event.toString());</span>
<span class="fc" id="L196">    return true;</span>
  }

  /**
   * Returns series DC associated with this event or null if {@link SeriesService} is not available or does not contain
   * entry for series with specified ID.
   *
   * @param seriesID
   *          {@link DublinCoreCatalog} to be retrieved
   * @return DC serialized to string or null
   * @throws UnauthorizedException
   *           if the current user is not allowed to view this series
   * @throws NotFoundException
   *           if the series cannot be found
   */
  private String getSeriesDublinCoreAsString(String seriesID) throws UnauthorizedException, NotFoundException {
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">    if (StringUtils.isBlank(seriesID))</span>
<span class="fc" id="L213">      return null;</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">    if (seriesService == null) {</span>
<span class="nc" id="L215">      logger.warn(&quot;No SeriesService available&quot;);</span>
<span class="nc" id="L216">      return null;</span>
    }

<span class="nc" id="L219">    DublinCoreCatalog seriesDC = series.get(seriesID);</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">    if (seriesDC == null) {</span>
      try {
<span class="nc" id="L222">        seriesDC = seriesService.getSeries(seriesID);</span>
<span class="nc" id="L223">        series.put(seriesID, seriesDC);</span>
<span class="nc" id="L224">      } catch (SeriesException e) {</span>
<span class="nc" id="L225">        logger.error(&quot;Error loading DublinCoreCatalog for series '{}'&quot;, seriesID, e);</span>
<span class="nc" id="L226">        return null;</span>
<span class="nc" id="L227">      }</span>
    }

    try {
<span class="nc" id="L231">      return seriesDC.toXmlString();</span>
<span class="nc" id="L232">    } catch (IOException e) {</span>
<span class="nc" id="L233">      logger.error(&quot;Error serializing DublinCoreCatalog of series '{}'&quot;, seriesID, e);</span>
<span class="nc" id="L234">      return null;</span>
    }
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>