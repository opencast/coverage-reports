<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>UrlSigningFilter.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-urlsigning-verifier-service-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.security.urlsigning.filter</a> &gt; <span class="el_source">UrlSigningFilter.java</span></div><h1>UrlSigningFilter.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.security.urlsigning.filter;

import org.opencastproject.security.urlsigning.exception.UrlSigningException;
import org.opencastproject.security.urlsigning.verifier.UrlSigningVerifier;
import org.opencastproject.urlsigning.common.ResourceRequest;

import org.apache.commons.lang3.StringUtils;
import org.apache.commons.lang3.exception.ExceptionUtils;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Modified;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.component.annotations.ServiceScope;
import org.osgi.service.component.propertytypes.ServiceRanking;
import org.osgi.service.http.whiteboard.propertytypes.HttpWhiteboardContextSelect;
import org.osgi.service.http.whiteboard.propertytypes.HttpWhiteboardFilterName;
import org.osgi.service.http.whiteboard.propertytypes.HttpWhiteboardFilterPattern;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Component(
    scope = ServiceScope.PROTOTYPE,
    property = {
        &quot;service.description=Url Signing Filter&quot;,
    }
)
@ServiceRanking(7)
@HttpWhiteboardFilterName(&quot;UrlSigningFilter&quot;)
@HttpWhiteboardFilterPattern(&quot;/*&quot;)
@HttpWhiteboardContextSelect(&quot;(osgi.http.whiteboard.context.name=opencast)&quot;)
<span class="fc" id="L68">public class UrlSigningFilter implements Filter {</span>
  /** The prefix in the configuration file to define the regex that will match a url path. */
  public static final String URL_REGEX_PREFIX = &quot;url.regex&quot;;
  /** The property in the configuration file to enable or disable this filter. */
  public static final String ENABLE_FILTER_CONFIG_KEY = &quot;enabled&quot;;

  /** The property in the configuration file to enable or disable strict checking of the resource. */
  public static final String STRICT_FILTER_CONFIG_KEY = &quot;strict&quot;;

<span class="fc" id="L77">  private static final Logger logger = LoggerFactory.getLogger(UrlSigningFilter.class);</span>

  private UrlSigningVerifier urlSigningVerifier;

<span class="fc" id="L81">  private List&lt;String&gt; urlRegularExpressions = new LinkedList&lt;&gt;();</span>

<span class="fc" id="L83">  private boolean enabled = true;</span>

<span class="fc" id="L85">  private boolean strict = true;</span>

  /** OSGi DI */
  @Reference
  public void setUrlSigningVerifier(UrlSigningVerifier urlSigningVerifier) {
<span class="fc" id="L90">    this.urlSigningVerifier = urlSigningVerifier;</span>
<span class="fc" id="L91">  }</span>

  /**
   * @see javax.servlet.Filter#doFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse,
   *      javax.servlet.FilterChain)
   */
  @Override
  public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
          throws IOException, ServletException {
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">    if (!enabled) {</span>
<span class="nc" id="L101">      chain.doFilter(request, response);</span>
<span class="nc" id="L102">      return;</span>
    }

<span class="fc bfc" id="L105" title="All 2 branches covered.">    if (urlRegularExpressions.size() == 0) {</span>
<span class="fc" id="L106">      logger.debug(&quot;There are no regular expressions configured to protect endpoints, skipping filter.&quot;);</span>
<span class="fc" id="L107">      chain.doFilter(request, response);</span>
<span class="fc" id="L108">      return;</span>
    }

<span class="fc" id="L111">    HttpServletRequest httpRequest = (HttpServletRequest) request;</span>
<span class="fc" id="L112">    HttpServletResponse httpResponse = (HttpServletResponse) response;</span>

<span class="pc bpc" id="L114" title="1 of 4 branches missed.">    if (!(&quot;GET&quot;.equalsIgnoreCase(httpRequest.getMethod()) || &quot;HEAD&quot;.equalsIgnoreCase(httpRequest.getMethod()))) {</span>
<span class="fc" id="L115">      logger.debug(&quot;The request '{}' is not a GET or HEAD request so skipping the filter.&quot;,</span>
<span class="fc" id="L116">              httpRequest.getRequestURL());</span>
<span class="fc" id="L117">      chain.doFilter(request, response);</span>
<span class="fc" id="L118">      return;</span>
    }

<span class="fc" id="L121">    boolean matches = false;</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">    for (String urlRegularExpression : urlRegularExpressions) {</span>
<span class="fc" id="L123">      Pattern p = Pattern.compile(urlRegularExpression);</span>
<span class="fc" id="L124">      Matcher m = p.matcher(httpRequest.getRequestURL());</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">      if (m.matches()) {</span>
<span class="fc" id="L126">        matches = true;</span>
<span class="fc" id="L127">        break;</span>
      }
<span class="fc" id="L129">    }</span>

<span class="fc bfc" id="L131" title="All 2 branches covered.">    if (!matches) {</span>
<span class="fc" id="L132">      logger.debug(&quot;The request '{}' doesn't match any of the configured regular expressions so skipping the filter.&quot;,</span>
<span class="fc" id="L133">              httpRequest.getRequestURL());</span>
<span class="fc" id="L134">      chain.doFilter(request, response);</span>
<span class="fc" id="L135">      return;</span>
    }

    ResourceRequest resourceRequest;
    try {
<span class="fc" id="L140">      resourceRequest = urlSigningVerifier.verify(httpRequest.getQueryString(), httpRequest.getRemoteAddr(),</span>
<span class="fc" id="L141">              httpRequest.getRequestURL().toString(), strict);</span>

<span class="pc bpc" id="L143" title="1 of 2 branches missed.">      if (resourceRequest == null) {</span>
<span class="nc" id="L144">        logger.error(&quot;Unable to process httpRequest '{}' because we got a null object as the verification.&quot;,</span>
<span class="nc" id="L145">                httpRequest.getRequestURL());</span>
<span class="nc" id="L146">        httpResponse.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR,</span>
                &quot;Unable to process http request because we got a null object as the verification.&quot;);
<span class="nc" id="L148">        return;</span>
      }

<span class="pc bpc" id="L151" title="1 of 5 branches missed.">      switch (resourceRequest.getStatus()) {</span>
        case Ok:
<span class="fc" id="L153">          logger.trace(&quot;The request '{}' matched a regular expression path and was accepted as a properly signed url.&quot;,</span>
<span class="fc" id="L154">                  httpRequest.getRequestURL());</span>
<span class="fc" id="L155">          chain.doFilter(httpRequest, response);</span>
<span class="fc" id="L156">          return;</span>
        case BadRequest:
<span class="fc" id="L158">          logger.debug(</span>
              &quot;Unable to process httpRequest '{}' because it was rejected as a Bad Request, &quot;
                  + &quot;usually a problem with query string: {}&quot;,
<span class="fc" id="L161">              httpRequest.getRequestURL(), resourceRequest.getRejectionReason());</span>
<span class="fc" id="L162">          httpResponse.sendError(HttpServletResponse.SC_BAD_REQUEST);</span>
<span class="fc" id="L163">          return;</span>
        case Forbidden:
<span class="fc" id="L165">          logger.debug(</span>
              &quot;Unable to process httpRequest '{}' because is was rejected as Forbidden, usually a &quot;
                  + &quot;problem with making policy matching the signature: {}&quot;,
<span class="fc" id="L168">              httpRequest.getRequestURL(), resourceRequest.getRejectionReason());</span>
<span class="fc" id="L169">          httpResponse.sendError(HttpServletResponse.SC_FORBIDDEN);</span>
<span class="fc" id="L170">          return;</span>
        case Gone:
<span class="fc" id="L172">          logger.debug(&quot;Unable to process httpRequest '{}' because is was rejected as Gone: {}&quot;,</span>
<span class="fc" id="L173">              httpRequest.getRequestURL(), resourceRequest.getRejectionReason());</span>
<span class="fc" id="L174">          httpResponse.sendError(HttpServletResponse.SC_GONE);</span>
<span class="fc" id="L175">          return;</span>
        default:
<span class="nc" id="L177">          logger.error(</span>
              &quot;Unable to process httpRequest '{}' because is was rejected as status {} which is &quot;
                  + &quot;not a status we should be handling here. This must be due to a code change &quot;
                  + &quot;and is a bug.: {}&quot;,
<span class="nc" id="L181">              httpRequest.getRequestURL(), resourceRequest.getStatus(), resourceRequest.getRejectionReason());</span>
<span class="nc" id="L182">          httpResponse.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);</span>
<span class="nc" id="L183">          return;</span>

      }
<span class="fc" id="L186">    } catch (UrlSigningException e) {</span>
<span class="fc" id="L187">      logger.error(&quot;Unable to verify request for '{}' with query string '{}' from host '{}' because:&quot;,</span>
<span class="fc" id="L188">              httpRequest.getRequestURL(), httpRequest.getQueryString(), httpRequest.getRemoteAddr(), e);</span>
<span class="fc" id="L189">      httpResponse.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR,</span>
<span class="fc" id="L190">              String.format(&quot;%s is unable to verify request for '%s' with query string '%s' from host '%s' because: %s&quot;,</span>
<span class="fc" id="L191">                      getName(), httpRequest.getRequestURL(), httpRequest.getQueryString(), httpRequest.getRemoteAddr(),</span>
<span class="fc" id="L192">                      ExceptionUtils.getStackTrace(e)));</span>
<span class="fc" id="L193">      return;</span>
    }
  }

  @Override
  public void init(FilterConfig filterConfig) throws ServletException {

<span class="nc" id="L200">  }</span>

  @Override
  public void destroy() {
<span class="nc" id="L204">  }</span>

  private String getName() {
<span class="fc" id="L207">    return this.getClass().getSimpleName();</span>
  }

  @Activate
  @Modified
  public void updated(Map&lt;String, Object&gt; properties) {
<span class="fc" id="L213">    logger.info(&quot;Updating UrlSigningFilter&quot;);</span>

<span class="fc" id="L215">    String enableFilterConfig = (String) properties.get(ENABLE_FILTER_CONFIG_KEY);</span>
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">    if (enableFilterConfig != null) {</span>
<span class="nc" id="L217">      enabled = Boolean.parseBoolean(enableFilterConfig);</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">      if (enabled) {</span>
<span class="nc" id="L219">        logger.info(&quot;The UrlSigningFilter is configured to be enabled.&quot;);</span>
      } else {
<span class="nc" id="L221">        logger.info(&quot;The UrlSigningFilter is configured to be disabled.&quot;);</span>
      }
    } else {
<span class="fc" id="L224">      enabled = true;</span>
<span class="fc" id="L225">      logger.info(</span>
          &quot;The UrlSigningFilter is enabled by default. Use the '{}' property in its properties &quot;
              + &quot;file to enable or disable it.&quot;,
          ENABLE_FILTER_CONFIG_KEY);
    }

<span class="fc" id="L231">    String strictFilterConfig = (String) properties.get(STRICT_FILTER_CONFIG_KEY);</span>
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">    if (strictFilterConfig != null) {</span>
<span class="nc" id="L233">      strict = Boolean.parseBoolean(strictFilterConfig);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">      if (strict) {</span>
<span class="nc" id="L235">        logger.info(&quot;The UrlSigningFilter is configured to use strict checking of resource URLs.&quot;);</span>
      } else {
<span class="nc" id="L237">        logger.info(&quot;The UrlSigningFilter is configured to not use strict checking of resource URLs.&quot;);</span>
      }
    } else {
<span class="fc" id="L240">      strict = true;</span>
<span class="fc" id="L241">      logger.info(</span>
          &quot;The UrlSigningFilter is using strict checking of resource URLs by default. Use the &quot;
              + &quot;'{}' property in its properties file to enable or disable it.&quot;,
          STRICT_FILTER_CONFIG_KEY);
    }

    // Clear the current set of keys
<span class="fc" id="L248">    urlRegularExpressions.clear();</span>

<span class="pc bpc" id="L250" title="1 of 2 branches missed.">    if (properties == null) {</span>
<span class="nc" id="L251">      logger.warn(&quot;UrlSigningFilter has no paths to match&quot;);</span>
<span class="nc" id="L252">      return;</span>
    }

<span class="fc bfc" id="L255" title="All 2 branches covered.">    for (String propertyKey : properties.keySet()) {</span>
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">      if (!propertyKey.startsWith(URL_REGEX_PREFIX)) {</span>
<span class="nc" id="L257">        continue;</span>
      }

<span class="fc" id="L260">      String urlRegularExpression = StringUtils.trimToNull((String) properties.get(propertyKey));</span>
<span class="fc" id="L261">      logger.debug(&quot;Looking for configuration of {} and found '{}'&quot;, propertyKey, urlRegularExpression);</span>
      // Has the url signing provider been fully configured
<span class="pc bpc" id="L263" title="1 of 2 branches missed.">      if (urlRegularExpression == null) {</span>
<span class="nc" id="L264">        logger.debug(&quot;Unable to configure url regular expression with id '{}' because it is missing. &quot;</span>
            + &quot;Stopping to look for new keys.&quot;, propertyKey);
<span class="nc" id="L266">        break;</span>
      }

<span class="fc" id="L269">      urlRegularExpressions.add(urlRegularExpression);</span>
<span class="fc" id="L270">    }</span>

<span class="pc bpc" id="L272" title="1 of 2 branches missed.">    if (urlRegularExpressions.size() == 0) {</span>
<span class="nc" id="L273">      logger.info(&quot;UrlSigningFilter configured to not verify any urls.&quot;);</span>
<span class="nc" id="L274">      return;</span>
    }
<span class="fc" id="L276">    logger.info(&quot;Finished updating UrlSigningFilter&quot;);</span>
<span class="fc" id="L277">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>