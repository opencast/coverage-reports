<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>StaticFileServiceImpl.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-static-file-service-impl</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.staticfiles.impl</a> &gt; <span class="el_source">StaticFileServiceImpl.java</span></div><h1>StaticFileServiceImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.staticfiles.impl;

import static java.lang.String.format;
import static org.opencastproject.util.RequireUtil.notNull;

import org.opencastproject.security.api.Organization;
import org.opencastproject.security.api.OrganizationDirectoryService;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.staticfiles.api.StaticFileService;
import org.opencastproject.staticfiles.jmx.UploadStatistics;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.OsgiUtil;
import org.opencastproject.util.ProgressInputStream;
import org.opencastproject.util.jmx.JmxUtil;

import com.google.common.util.concurrent.AbstractScheduledService;
import com.google.common.util.concurrent.MoreExecutors;
import com.google.common.util.concurrent.Service.Listener;
import com.google.common.util.concurrent.Service.State;

import org.apache.commons.io.FileUtils;
import org.apache.commons.lang3.StringUtils;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.ComponentException;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Deactivate;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.nio.file.DirectoryStream;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.Date;
import java.util.UUID;
import java.util.concurrent.TimeUnit;

import javax.management.ObjectInstance;

/**
 * Stores and retrieves static file resources.
 */
@Component(
    immediate = true,
    service = StaticFileService.class,
    property = {
        &quot;service.description=Static File Service&quot;,
        &quot;service.PID=org.opencastproject.staticfiles.impl.StaticFileServiceImpl&quot;
    }
)
<span class="fc" id="L79">public class StaticFileServiceImpl implements StaticFileService {</span>

  /** The logger */
<span class="fc" id="L82">  private static final Logger logger = LoggerFactory.getLogger(StaticFileServiceImpl.class);</span>

  /** The key to find the root directory for the static file service in the OSGi properties. */
  public static final String STATICFILES_ROOT_DIRECTORY_KEY = &quot;org.opencastproject.staticfiles.rootdir&quot;;

  /** The JMX business object for uploaded statistics */
<span class="fc" id="L88">  private UploadStatistics staticFileStatistics = new UploadStatistics();</span>

  /** The JMX bean object instance */
  private ObjectInstance registerMXBean;

  // OSGi service references
<span class="fc" id="L94">  private SecurityService securityService = null;</span>
<span class="fc" id="L95">  private OrganizationDirectoryService orgDirectory = null;</span>

  /** The root directory for storing static files. */
  private String rootDirPath;

  private PurgeTemporaryStorageService purgeService;

  /**
   * OSGI callback for activating this component
   *
   * @param cc
   *          the osgi component context
   */
  @Activate
  public void activate(ComponentContext cc) {
<span class="fc" id="L110">    logger.info(&quot;Upload Static Resource Service started.&quot;);</span>
<span class="fc" id="L111">    registerMXBean = JmxUtil.registerMXBean(staticFileStatistics, &quot;UploadStatistics&quot;);</span>
<span class="fc" id="L112">    rootDirPath = OsgiUtil.getContextProperty(cc, STATICFILES_ROOT_DIRECTORY_KEY);</span>

<span class="fc" id="L114">    final File rootFile = new File(rootDirPath);</span>
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">    if (!rootFile.exists()) {</span>
      try {
<span class="nc" id="L117">        FileUtils.forceMkdir(rootFile);</span>
<span class="nc" id="L118">      } catch (IOException e) {</span>
<span class="nc" id="L119">        throw new ComponentException(</span>
<span class="nc" id="L120">                String.format(&quot;%s does not exists and could not be created&quot;, rootFile.getAbsolutePath()));</span>
<span class="nc" id="L121">      }</span>
    }
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">    if (!rootFile.canRead()) {</span>
<span class="nc" id="L124">      throw new ComponentException(String.format(&quot;Cannot read from %s&quot;, rootFile.getAbsolutePath()));</span>
    }

<span class="fc" id="L127">    purgeService = new PurgeTemporaryStorageService();</span>
<span class="fc" id="L128">    purgeService.addListener(new Listener() {</span>
      @Override
      public void failed(State from, Throwable failure) {
<span class="nc" id="L131">        logger.warn(&quot;Temporary storage purging service failed:&quot;, failure);</span>
<span class="nc" id="L132">      }</span>
<span class="fc" id="L133">    }, MoreExecutors.directExecutor());</span>
<span class="fc" id="L134">    purgeService.startAsync();</span>
<span class="fc" id="L135">    logger.info(&quot;Purging of temporary storage section scheduled&quot;);</span>
<span class="fc" id="L136">  }</span>

  /**
   * Callback from OSGi on service deactivation.
   */
  @Deactivate
  public void deactivate() {
<span class="nc" id="L143">    JmxUtil.unregisterMXBean(registerMXBean);</span>

<span class="nc" id="L145">    purgeService.stopAsync();</span>
<span class="nc" id="L146">    purgeService = null;</span>
<span class="nc" id="L147">  }</span>

  /** OSGi DI */
  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="fc" id="L152">    this.securityService = securityService;</span>
<span class="fc" id="L153">  }</span>

  /** OSGi DI */
  @Reference
  public void setOrganizationDirectoryService(OrganizationDirectoryService directoryService) {
<span class="fc" id="L158">    orgDirectory = directoryService;</span>
<span class="fc" id="L159">  }</span>

  @Override
  public String storeFile(String filename, InputStream inputStream) throws IOException {
<span class="fc" id="L163">    notNull(filename, &quot;filename&quot;);</span>
<span class="fc" id="L164">    notNull(inputStream, &quot;inputStream&quot;);</span>
<span class="fc" id="L165">    final String uuid = UUID.randomUUID().toString();</span>
<span class="fc" id="L166">    final String org = securityService.getOrganization().getId();</span>

<span class="fc" id="L168">    Path file = getTemporaryStorageDir(org).resolve(Paths.get(uuid, filename));</span>
<span class="fc" id="L169">    try (ProgressInputStream progressInputStream = new ProgressInputStream(inputStream)) {</span>
<span class="fc" id="L170">      progressInputStream.addPropertyChangeListener(new PropertyChangeListener() {</span>
        @Override
        public void propertyChange(PropertyChangeEvent evt) {
<span class="fc" id="L173">          long totalNumBytesRead = (Long) evt.getNewValue();</span>
<span class="fc" id="L174">          long oldTotalNumBytesRead = (Long) evt.getOldValue();</span>
<span class="fc" id="L175">          staticFileStatistics.add(totalNumBytesRead - oldTotalNumBytesRead);</span>
<span class="fc" id="L176">        }</span>
      });

<span class="fc" id="L179">      Files.createDirectories(file.getParent());</span>
<span class="fc" id="L180">      Files.copy(progressInputStream, file);</span>
<span class="nc" id="L181">    } catch (IOException e) {</span>
<span class="nc" id="L182">      logger.error(&quot;Unable to save file '{}' to {}&quot;, filename, file, e);</span>
<span class="nc" id="L183">      throw e;</span>
<span class="fc" id="L184">    }</span>

<span class="fc" id="L186">    return uuid;</span>
  }

  @Override
  public InputStream getFile(final String uuid) throws NotFoundException, IOException {
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">    if (StringUtils.isBlank(uuid)) {</span>
<span class="nc" id="L192">      throw new IllegalArgumentException(&quot;The uuid must not be blank&quot;);</span>
    }

<span class="fc" id="L195">    final String org = securityService.getOrganization().getId();</span>

<span class="fc" id="L197">    return Files.newInputStream(getFile(org, uuid));</span>
  }

  @Override
  public void persistFile(final String uuid) throws NotFoundException, IOException {
<span class="fc" id="L202">    final String org = securityService.getOrganization().getId();</span>
<span class="fc" id="L203">    try (DirectoryStream&lt;Path&gt; folders = Files.newDirectoryStream(getTemporaryStorageDir(org),</span>
<span class="fc" id="L204">            getDirsEqualsUuidFilter(uuid))) {</span>
<span class="fc bfc" id="L205" title="All 2 branches covered.">      for (Path folder : folders) {</span>
<span class="fc" id="L206">        Files.move(folder, getDurableStorageDir(org).resolve(folder.getFileName()));</span>
<span class="fc" id="L207">      }</span>
    }
<span class="fc" id="L209">  }</span>

  @Override
  public void deleteFile(String uuid) throws NotFoundException, IOException {
<span class="fc" id="L213">    final String org = securityService.getOrganization().getId();</span>
<span class="fc" id="L214">    Path file = getFile(org, uuid);</span>
<span class="fc" id="L215">    Files.deleteIfExists(file);</span>
<span class="fc" id="L216">  }</span>

  @Override
  public String getFileName(String uuid) throws NotFoundException {
<span class="fc" id="L220">    final String org = securityService.getOrganization().getId();</span>
    try {
<span class="fc" id="L222">      Path file = getFile(org, uuid);</span>
<span class="fc" id="L223">      return file.getFileName().toString();</span>
<span class="nc" id="L224">    } catch (IOException e) {</span>
<span class="nc" id="L225">      logger.warn(&quot;Error while reading file:&quot;, e);</span>
<span class="nc" id="L226">      throw new NotFoundException(e);</span>
    }
  }

  @Override
  public Long getContentLength(String uuid) throws NotFoundException {
<span class="nc" id="L232">    final String org = securityService.getOrganization().getId();</span>
    try {
<span class="nc" id="L234">      Path file = getFile(org, uuid);</span>
<span class="nc" id="L235">      return Files.size(file);</span>
<span class="nc" id="L236">    } catch (IOException e) {</span>
<span class="nc" id="L237">      logger.warn(&quot;Error while reading file:&quot;, e);</span>
<span class="nc" id="L238">      throw new NotFoundException(e);</span>
    }
  }

  /**
   * Returns a {@link DirectoryStream.Filter} to filter the entries of a directory and only return items which filename
   * starts with the UUID.
   *
   * @param uuid
   *          The UUID to filter by
   * @return the filter
   */
  private static DirectoryStream.Filter&lt;Path&gt; getDirsEqualsUuidFilter(final String uuid) {
<span class="fc" id="L251">    return new DirectoryStream.Filter&lt;Path&gt;() {</span>
      @Override
      public boolean accept(Path entry) throws IOException {
<span class="pc bpc" id="L254" title="1 of 4 branches missed.">        return Files.isDirectory(entry) &amp;&amp; entry.getFileName().toString().equals(uuid);</span>
      }
    };
  };

  /**
   * Returns the temporary storage directory for an organization.
   *
   * @param org
   *          The organization
   * @return Path to the temporary storage directory
   */
  private Path getTemporaryStorageDir(final String org) {
<span class="fc" id="L267">    return Paths.get(rootDirPath, org, &quot;temp&quot;);</span>
  }

  private Path getDurableStorageDir(final String org) {
<span class="fc" id="L271">    return Paths.get(rootDirPath, org);</span>
  }

  private Path getFile(final String org, final String uuid) throws NotFoundException, IOException {
    // First check if the file is part of the durable storage section
<span class="fc" id="L276">    try (DirectoryStream&lt;Path&gt; dirs = Files.newDirectoryStream(getDurableStorageDir(org),</span>
<span class="fc" id="L277">            getDirsEqualsUuidFilter(uuid))) {</span>
<span class="fc bfc" id="L278" title="All 2 branches covered.">      for (Path dir : dirs) {</span>
<span class="fc" id="L279">        try (DirectoryStream&lt;Path&gt; files = Files.newDirectoryStream(dir)) {</span>
<span class="pc bpc" id="L280" title="1 of 2 branches missed.">          for (Path file : files) {</span>
<span class="fc" id="L281">            return file;</span>
          }
<span class="pc bpc" id="L283" title="1 of 2 branches missed.">        }</span>
<span class="nc" id="L284">      }</span>
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">    }</span>

    // Second check if the file is part of the temporary storage section
<span class="fc" id="L288">    try (DirectoryStream&lt;Path&gt; dirs = Files.newDirectoryStream(getTemporaryStorageDir(org),</span>
<span class="fc" id="L289">            getDirsEqualsUuidFilter(uuid))) {</span>
<span class="fc bfc" id="L290" title="All 2 branches covered.">      for (Path dir : dirs) {</span>
<span class="fc" id="L291">        try (DirectoryStream&lt;Path&gt; files = Files.newDirectoryStream(dir)) {</span>
<span class="fc bfc" id="L292" title="All 2 branches covered.">          for (Path file : files) {</span>
<span class="fc" id="L293">            return file;</span>
          }
<span class="pc bpc" id="L295" title="1 of 2 branches missed.">        }</span>
<span class="fc" id="L296">      }</span>
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">    }</span>

<span class="fc" id="L299">    throw new NotFoundException(format(&quot;No file with UUID '%s' found.&quot;, uuid));</span>
  }

  /**
   * Deletes all files found in the temporary storage section of an organization.
   *
   * @param org
   *          The organization identifier
   * @throws IOException
   *           if there was an error while deleting the files.
   */
  void purgeTemporaryStorageSection(final String org, final long lifetime) throws IOException {
<span class="fc" id="L311">    logger.debug(&quot;Purge temporary storage section of organization '{}'&quot;, org);</span>
<span class="fc" id="L312">    final Path temporaryStorageDir = getTemporaryStorageDir(org);</span>
<span class="pc bpc" id="L313" title="1 of 2 branches missed.">    if (Files.exists(temporaryStorageDir)) {</span>
<span class="fc" id="L314">      try (DirectoryStream&lt;Path&gt; tempFilesStream = Files.newDirectoryStream(temporaryStorageDir,</span>
<span class="fc" id="L315">          new DirectoryStream.Filter&lt;Path&gt;() {</span>
            @Override
            public boolean accept(Path path) throws IOException {
<span class="pc bpc" id="L318" title="1 of 2 branches missed.">              return (Files.getLastModifiedTime(path).toMillis() &lt; (new Date()).getTime() - lifetime);</span>
            }
          })) {
<span class="fc bfc" id="L321" title="All 2 branches covered.">        for (Path file : tempFilesStream) {</span>
<span class="fc" id="L322">          FileUtils.deleteQuietly(file.toFile());</span>
<span class="fc" id="L323">        }</span>
      }
    }
<span class="fc" id="L326">  }</span>

  /**
   * Deletes all files found in the temporary storage section of all known organizations.
   *
   * @throws IOException
   *           if there was an error while deleting the files.
   */
  void purgeTemporaryStorageSection() throws IOException {
<span class="fc" id="L335">    logger.info(&quot;Start purging temporary storage section of all known organizations&quot;);</span>
<span class="pc bpc" id="L336" title="1 of 2 branches missed.">    for (Organization org : orgDirectory.getOrganizations()) {</span>
<span class="nc" id="L337">      purgeTemporaryStorageSection(org.getId(), TimeUnit.DAYS.toMillis(1));</span>
<span class="nc" id="L338">    }</span>
<span class="fc" id="L339">  }</span>

  /** Scheduled service for purging temporary storage sections. */
<span class="fc" id="L342">  private class PurgeTemporaryStorageService extends AbstractScheduledService {</span>

    @Override
    protected void runOneIteration() throws Exception {
<span class="fc" id="L346">      StaticFileServiceImpl.this.purgeTemporaryStorageSection();</span>
<span class="fc" id="L347">    }</span>

    @Override
    protected Scheduler scheduler() {
<span class="fc" id="L351">      return Scheduler.newFixedRateSchedule(0, 1, TimeUnit.HOURS);</span>
    }

  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>