<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>LtiServlet.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-lti</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.lti</a> &gt; <span class="el_source">LtiServlet.java</span></div><h1>LtiServlet.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.lti;

import org.apache.commons.lang3.StringUtils;
import org.json.simple.JSONObject;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.http.whiteboard.propertytypes.HttpWhiteboardContextSelect;
import org.osgi.service.http.whiteboard.propertytypes.HttpWhiteboardServletName;
import org.osgi.service.http.whiteboard.propertytypes.HttpWhiteboardServletPattern;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.net.URI;
import java.net.URISyntaxException;
import java.net.URLDecoder;
import java.nio.charset.StandardCharsets;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;
import java.util.SortedSet;
import java.util.TreeSet;

import javax.servlet.Servlet;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import javax.ws.rs.core.UriBuilder;

/**
 * A servlet to accept an LTI login via POST. The actual authentication happens in LtiProcessingFilter. GET requests
 * produce JSON containing the LTI parameters passed during LTI launch.
 */
@Component(
    service = Servlet.class,
    property = {
        &quot;service.description=LTI Servlet&quot;,
    }
)
@HttpWhiteboardServletName(&quot;/lti&quot;)
@HttpWhiteboardServletPattern(&quot;/lti/*&quot;)
@HttpWhiteboardContextSelect(&quot;(osgi.http.whiteboard.context.name=opencast)&quot;)
<span class="nc" id="L65">public class LtiServlet extends HttpServlet {</span>

  private static final String LTI_CUSTOM_PREFIX = &quot;custom_&quot;;
  private static final String LTI_CUSTOM_TOOL = &quot;custom_tool&quot;;
  private static final String LTI_CUSTOM_TEST = &quot;custom_test&quot;;

  /** The logger */
<span class="nc" id="L72">  private static final Logger logger = LoggerFactory.getLogger(LtiServlet.class);</span>

  /** The serialization uid */
  private static final long serialVersionUID = 6138043870346176520L;

  /** The key used to store the LTI attributes in the HTTP session */
  public static final String SESSION_ATTRIBUTE_KEY = &quot;org.opencastproject.lti.LtiServlet&quot;;

  /** Path under which all the LTI tools are available */
  private static final String TOOLS_URL = &quot;/ltitools&quot;;

  // The following LTI launch parameters are made available to GET requests at the /lti endpoint.
  // See https://www.imsglobal.org/specs/ltiv1p2/implementation-guide for the meaning of each.

  /** See the LTI specification */
  public static final String LTI_MESSAGE_TYPE = &quot;lti_message_type&quot;;

  /** See the LTI specification */
  public static final String LTI_VERSION = &quot;lti_version&quot;;

  /** See the LTI specification */
  public static final String RESOURCE_LINK_ID = &quot;resource_link_id&quot;;

  /** See the LTI specification */
  public static final String RESOURCE_LINK_TITLE = &quot;resource_link_title&quot;;

  /** See the LTI specification */
  public static final String RESOURCE_LINK_DESCRIPTION = &quot;resource_link_description&quot;;

  /** See the LTI specification */
  public static final String USER_ID = &quot;user_id&quot;;

  /** See the LTI specification */
  public static final String USER_IMAGE = &quot;user_image&quot;;

  /** See the LTI specification */
  public static final String ROLES = &quot;roles&quot;;

  /** See the LTI specification */
  public static final String GIVEN_NAME = &quot;lis_person_name_given&quot;;

  /** See the LTI specification */
  public static final String FAMILY_NAME = &quot;lis_person_name_family&quot;;

  /** See the LTI specification */
  public static final String FULL_NAME = &quot;lis_person_name_full&quot;;

  /** See the LTI specification */
  public static final String EMAIL = &quot;lis_person_contact_email_primary&quot;;

  /** See the LTI specification */
  public static final String CONTEXT_ID = &quot;context_id&quot;;

  /** See the LTI specification */
  public static final String CONTEXT_TYPE = &quot;context_type&quot;;

  /** See the LTI specification */
  public static final String CONTEXT_TITLE = &quot;context_title&quot;;

  /** See the LTI specification */
  public static final String CONTEXT_LABEL = &quot;context_label&quot;;

  /** See the LTI specification */
  public static final String LOCALE = &quot;launch_presentation_locale&quot;;

  /** See the LTI specification */
  public static final String TARGET = &quot;launch_presentation_document_target&quot;;

  /** See the LTI specification */
  public static final String WIDTH = &quot;launch_presentation_width&quot;;

  /** See the LTI specification */
  public static final String HEIGHT = &quot;launch_presentation_height&quot;;

  /** See the LTI specification */
  public static final String RETURN_URL = &quot;launch_presentation_return_url&quot;;

  /** See the LTI specification */
  public static final String CONSUMER_GUID = &quot;tool_consumer_instance_guid&quot;;

  /** See the LTI specification */
  public static final String CONSUMER_NAME = &quot;tool_consumer_instance_name&quot;;

  /** See the LTI specification */
  public static final String CONSUMER_DESCRIPTION = &quot;tool_consumer_instance_description&quot;;

  /** See the LTI specification */
  public static final String CONSUMER_URL = &quot;tool_consumer_instance_url&quot;;

  /** See the LTI specification */
  public static final String CONSUMER_CONTACT = &quot;tool_consumer_instance_contact_email&quot;;

  /** See the LTI specification */
  public static final String COURSE_OFFERING = &quot;lis_course_offering_sourcedid&quot;;

  /** See the LTI specification */
  public static final String COURSE_SECTION = &quot;lis_course_section_sourcedid&quot;;

  public static final SortedSet&lt;String&gt; LTI_CONSTANTS;

  static {
<span class="nc" id="L173">    LTI_CONSTANTS = new TreeSet&lt;String&gt;();</span>
<span class="nc" id="L174">    LTI_CONSTANTS.add(LTI_MESSAGE_TYPE);</span>
<span class="nc" id="L175">    LTI_CONSTANTS.add(LTI_VERSION);</span>
<span class="nc" id="L176">    LTI_CONSTANTS.add(RESOURCE_LINK_ID);</span>
<span class="nc" id="L177">    LTI_CONSTANTS.add(RESOURCE_LINK_TITLE);</span>
<span class="nc" id="L178">    LTI_CONSTANTS.add(RESOURCE_LINK_DESCRIPTION);</span>
<span class="nc" id="L179">    LTI_CONSTANTS.add(USER_ID);</span>
<span class="nc" id="L180">    LTI_CONSTANTS.add(USER_IMAGE);</span>
<span class="nc" id="L181">    LTI_CONSTANTS.add(ROLES);</span>
<span class="nc" id="L182">    LTI_CONSTANTS.add(GIVEN_NAME);</span>
<span class="nc" id="L183">    LTI_CONSTANTS.add(FAMILY_NAME);</span>
<span class="nc" id="L184">    LTI_CONSTANTS.add(FULL_NAME);</span>
<span class="nc" id="L185">    LTI_CONSTANTS.add(EMAIL);</span>
<span class="nc" id="L186">    LTI_CONSTANTS.add(CONTEXT_ID);</span>
<span class="nc" id="L187">    LTI_CONSTANTS.add(CONTEXT_TYPE);</span>
<span class="nc" id="L188">    LTI_CONSTANTS.add(CONTEXT_TITLE);</span>
<span class="nc" id="L189">    LTI_CONSTANTS.add(CONTEXT_LABEL);</span>
<span class="nc" id="L190">    LTI_CONSTANTS.add(LOCALE);</span>
<span class="nc" id="L191">    LTI_CONSTANTS.add(TARGET);</span>
<span class="nc" id="L192">    LTI_CONSTANTS.add(WIDTH);</span>
<span class="nc" id="L193">    LTI_CONSTANTS.add(HEIGHT);</span>
<span class="nc" id="L194">    LTI_CONSTANTS.add(RETURN_URL);</span>
<span class="nc" id="L195">    LTI_CONSTANTS.add(CONSUMER_GUID);</span>
<span class="nc" id="L196">    LTI_CONSTANTS.add(CONSUMER_NAME);</span>
<span class="nc" id="L197">    LTI_CONSTANTS.add(CONSUMER_DESCRIPTION);</span>
<span class="nc" id="L198">    LTI_CONSTANTS.add(CONSUMER_URL);</span>
<span class="nc" id="L199">    LTI_CONSTANTS.add(CONSUMER_CONTACT);</span>
<span class="nc" id="L200">    LTI_CONSTANTS.add(COURSE_OFFERING);</span>
<span class="nc" id="L201">    LTI_CONSTANTS.add(COURSE_SECTION);</span>
<span class="nc" id="L202">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see javax.servlet.http.HttpServlet#doPost(javax.servlet.http.HttpServletRequest,
   *      javax.servlet.http.HttpServletResponse)
   */
  @Override
  protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
    // Store the LTI data as a map in the session
<span class="nc" id="L213">    HttpSession session = req.getSession(false);</span>
<span class="nc" id="L214">    session.setAttribute(SESSION_ATTRIBUTE_KEY, getLtiValuesAsMap(req));</span>

    // We must return a 200 for some OAuth client libraries to accept this as a valid response

    // The URL of the LTI tool. If no specific tool is passed we use the test tool
    UriBuilder builder;
    try {
<span class="nc" id="L221">      String customTool = URLDecoder</span>
<span class="nc" id="L222">              .decode(StringUtils.trimToEmpty(req.getParameter(LTI_CUSTOM_TOOL)), StandardCharsets.UTF_8.displayName());</span>
<span class="nc" id="L223">      customTool = customTool.replaceAll(</span>
          &quot;/?ltitools/(?&lt;tool&gt;[^/]*)/index.html\\??&quot;,
          &quot;/ltitools/index.html?subtool=${tool}&amp;&quot;
      );
<span class="nc" id="L227">      URI toolUri = new URI(customTool);</span>

<span class="nc bnc" id="L229" title="All 2 branches missed.">      if (toolUri.getPath().isEmpty()) {</span>
<span class="nc" id="L230">        throw new URISyntaxException(toolUri.toString(), &quot;Provided 'custom_tool' has an empty path&quot;);</span>
      }

      // Make sure that the URI path starts with '/'. Otherwise, UriBuilder handles URIs incorrectly
<span class="nc bnc" id="L234" title="All 4 branches missed.">      if (!toolUri.isOpaque() &amp;&amp; !toolUri.getPath().startsWith(&quot;/&quot;)) {</span>
        // Also, remove the schema and &quot;authority&quot; parts of the URI for security reasons
<span class="nc" id="L236">        builder = UriBuilder</span>
<span class="nc" id="L237">                .fromUri(new URI(null, null, '/' + toolUri.getPath(), toolUri.getQuery(), toolUri.getFragment()));</span>
      } else {
        // Remove the schema and &quot;authority&quot; parts of the URI for security reasons.
        // &quot;authority&quot; consists of user-info, host and port.
<span class="nc" id="L241">        builder = UriBuilder.fromUri(toolUri).scheme(null).host(null).userInfo(null).port(-1);</span>
      }
<span class="nc" id="L243">    } catch (URISyntaxException ex) {</span>
<span class="nc" id="L244">      logger.debug(&quot;The 'custom_tool' parameter was invalid: '{}'. Reverting to default: '{}'&quot;,</span>
<span class="nc" id="L245">              Arrays.toString(req.getParameterValues(LTI_CUSTOM_TOOL)), TOOLS_URL);</span>
<span class="nc" id="L246">      builder = UriBuilder.fromPath(TOOLS_URL);</span>
<span class="nc" id="L247">    }</span>

    // We need to add the custom params to the outgoing request
<span class="nc bnc" id="L250" title="All 2 branches missed.">    for (String key : req.getParameterMap().keySet()) {</span>
<span class="nc" id="L251">      logger.debug(&quot;Found query parameter '{}'&quot;, key);</span>
<span class="nc bnc" id="L252" title="All 4 branches missed.">      if (key.startsWith(LTI_CUSTOM_PREFIX) &amp;&amp; (!LTI_CUSTOM_TOOL.equals(key))) {</span>
<span class="nc" id="L253">        String paramValue = req.getParameter(key);</span>
        // we need to remove the prefix custom_
<span class="nc" id="L255">        String paramName = key.substring(LTI_CUSTOM_PREFIX.length());</span>
<span class="nc" id="L256">        builder.queryParam(paramName, paramValue);</span>
      }
<span class="nc" id="L258">    }</span>

    // Add locale param from LMS
<span class="nc" id="L261">    String localeParamValue = req.getParameter(LOCALE);</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">    if (StringUtils.isNotBlank(localeParamValue)) {</span>
      // 'lng' is query param for i18next-browser-languagedetector
<span class="nc" id="L264">      builder.queryParam(&quot;lng&quot;, localeParamValue);</span>
    }

    // Build the final URL (as a string)
<span class="nc" id="L268">    String redirectUrl = builder.build().toString();</span>

    // Always set the session cookie
<span class="nc" id="L271">    resp.setHeader(&quot;Set-Cookie&quot;, &quot;JSESSIONID=&quot; + session.getId() + &quot;;Path=/&quot;);</span>

    // The client can specify debug option by passing a value to test
    // if in test mode display details where we go
<span class="nc bnc" id="L275" title="All 2 branches missed.">    if (Boolean.valueOf(StringUtils.trimToEmpty(req.getParameter(LTI_CUSTOM_TEST)))) {</span>
<span class="nc" id="L276">      resp.setContentType(&quot;text/html&quot;);</span>
<span class="nc" id="L277">      resp.getWriter().write(&quot;&lt;html&gt;&lt;body&gt;Welcome to Opencast LTI; you are going to &quot; + redirectUrl + &quot;&lt;br&gt;&quot;);</span>
<span class="nc" id="L278">      resp.getWriter().write(&quot;&lt;a href=\&quot;&quot; + redirectUrl + &quot;\&quot;&gt;continue...&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;&quot;);</span>
      // TODO we should probably print the parameters.
    } else {
<span class="nc" id="L281">      resp.sendRedirect(redirectUrl);</span>
    }
<span class="nc" id="L283">  }</span>

  /**
   * Builds a map of LTI parameters
   *
   * @param req
   *          the LTI Launch HttpServletRequest
   * @return the map of LTI parameters to the values for this launch
   */
  protected Map&lt;String, String&gt; getLtiValuesAsMap(HttpServletRequest req) {
<span class="nc" id="L293">    Map&lt;String, String&gt; ltiValues = new HashMap&lt;String, String&gt;();</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">    for (String key : LTI_CONSTANTS) {</span>
<span class="nc" id="L295">      String value = StringUtils.trimToNull(req.getParameter(key));</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">      if (value != null) {</span>
<span class="nc" id="L297">        ltiValues.put(key, value);</span>
      }
<span class="nc" id="L299">    }</span>
<span class="nc" id="L300">    return ltiValues;</span>
  }

  /**
   * {@inheritDoc}
   *
   * @see javax.servlet.http.HttpServlet#doGet(javax.servlet.http.HttpServletRequest,
   *      javax.servlet.http.HttpServletResponse)
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  @Override
  protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
<span class="nc" id="L312">    HttpSession session = req.getSession(false);</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">    if (session == null) {</span>
      // If there is no session, there is nothing to see here
<span class="nc" id="L315">      resp.sendError(HttpServletResponse.SC_NOT_FOUND);</span>
    } else {
<span class="nc" id="L317">      Map&lt;String, String&gt; ltiAttributes = (Map&lt;String, String&gt;) session.getAttribute(SESSION_ATTRIBUTE_KEY);</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">      if (ltiAttributes == null) {</span>
<span class="nc" id="L319">        ltiAttributes = new HashMap&lt;&gt;();</span>
<span class="nc" id="L320">        ltiAttributes.put(&quot;roles&quot;, &quot;Instructor&quot;);</span>
      }
<span class="nc" id="L322">      resp.setContentType(&quot;application/json&quot;);</span>
<span class="nc" id="L323">      JSONObject.writeJSONString(ltiAttributes, resp.getWriter());</span>
    }
<span class="nc" id="L325">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>