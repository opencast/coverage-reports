<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SchemaService.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-graphql</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.graphql.schema</a> &gt; <span class="el_source">SchemaService.java</span></div><h1>SchemaService.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.graphql.schema;

import org.opencastproject.graphql.provider.GraphQLAdditionalTypeProvider;
import org.opencastproject.graphql.provider.GraphQLCodeRegistryProvider;
import org.opencastproject.graphql.provider.GraphQLDynamicTypeProvider;
import org.opencastproject.graphql.provider.GraphQLExtensionProvider;
import org.opencastproject.graphql.provider.GraphQLFieldVisibilityProvider;
import org.opencastproject.graphql.provider.GraphQLMutationProvider;
import org.opencastproject.graphql.provider.GraphQLQueryProvider;
import org.opencastproject.graphql.provider.GraphQLTypeFunctionProvider;
import org.opencastproject.security.api.Organization;
import org.opencastproject.security.api.OrganizationDirectoryListener;
import org.opencastproject.security.api.OrganizationDirectoryService;

import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Deactivate;
import org.osgi.service.component.annotations.Modified;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.component.annotations.ReferenceCardinality;
import org.osgi.service.component.annotations.ReferencePolicy;
import org.osgi.service.component.annotations.ReferencePolicyOption;
import org.osgi.service.component.propertytypes.ServiceDescription;
import org.osgi.service.metatype.annotations.ObjectClassDefinition;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.CopyOnWriteArrayList;
import java.util.concurrent.Executors;
import java.util.concurrent.RejectedExecutionException;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.ScheduledFuture;
import java.util.concurrent.ThreadFactory;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.AtomicInteger;

import graphql.schema.GraphQLSchema;

@Component(
    service = {SchemaService.class, OrganizationDirectoryListener.class}
)
@ServiceDescription(&quot;GraphQL Schema Service&quot;)
public class SchemaService implements OrganizationDirectoryListener {

  @ObjectClassDefinition
  public @interface SchemaConfiguration {

    int schema_update_trigger_delay() default 3000;

  }

<span class="nc" id="L76">  private static final Logger logger = LoggerFactory.getLogger(SchemaService.class);</span>

  private final OrganizationDirectoryService organizationDirectoryService;

<span class="nc" id="L80">  private final Map&lt;String, GraphQLSchema&gt; schemas = new ConcurrentHashMap&lt;&gt;(8, 0.9f, 1);</span>

<span class="nc" id="L82">  private final List&lt;GraphQLQueryProvider&gt; queryProviders = new CopyOnWriteArrayList&lt;&gt;();</span>

<span class="nc" id="L84">  private final List&lt;GraphQLMutationProvider&gt; mutationProviders = new CopyOnWriteArrayList&lt;&gt;();</span>

<span class="nc" id="L86">  private final List&lt;GraphQLExtensionProvider&gt; extensionsProviders = new CopyOnWriteArrayList&lt;&gt;();</span>

<span class="nc" id="L88">  private final List&lt;GraphQLAdditionalTypeProvider&gt; additionalTypesProviders = new CopyOnWriteArrayList&lt;&gt;();</span>

<span class="nc" id="L90">  private final List&lt;GraphQLFieldVisibilityProvider&gt; fieldVisibilityProviders = new CopyOnWriteArrayList&lt;&gt;();</span>

<span class="nc" id="L92">  private final List&lt;GraphQLDynamicTypeProvider&gt; dynamicTypeProviders = new CopyOnWriteArrayList&lt;&gt;();</span>

<span class="nc" id="L94">  private final List&lt;GraphQLTypeFunctionProvider&gt; typeFunctionProviders = new CopyOnWriteArrayList&lt;&gt;();</span>

<span class="nc" id="L96">  private final List&lt;GraphQLCodeRegistryProvider&gt; codeRegistryProviders = new CopyOnWriteArrayList&lt;&gt;();</span>

  private final ScheduledExecutorService schemaUpdateExecutor;

  private int schemaUpdateTriggerDelay;

<span class="nc" id="L102">  private final Map&lt;Organization, ScheduledFuture&lt;?&gt;&gt; scheduledFutureMap = new ConcurrentHashMap&lt;&gt;();</span>

  @Activate
  public SchemaService(
      @Reference OrganizationDirectoryService organizationDirectoryService,
      final SchemaConfiguration config
<span class="nc" id="L108">  ) {</span>
<span class="nc" id="L109">    this.organizationDirectoryService = organizationDirectoryService;</span>
<span class="nc" id="L110">    schemaUpdateExecutor = Executors.newSingleThreadScheduledExecutor(new SchemaUpdateThreadFactory());</span>

<span class="nc" id="L112">    updateConfiguration(config);</span>
<span class="nc" id="L113">  }</span>

  @Modified
  public void updateConfiguration(SchemaConfiguration config) {
<span class="nc bnc" id="L117" title="All 2 branches missed.">    if (config.schema_update_trigger_delay() &lt; 0) {</span>
<span class="nc" id="L118">      throw new IllegalArgumentException(&quot;Schema update trigger delay must be greater than or equal to 0&quot;);</span>
    }
<span class="nc" id="L120">    this.schemaUpdateTriggerDelay = config.schema_update_trigger_delay();</span>
<span class="nc" id="L121">    triggerSchemaUpdate();</span>
<span class="nc" id="L122">  }</span>

  @Deactivate
  protected void dispose() {
<span class="nc" id="L126">    scheduledFutureMap.forEach((organization, scheduledFuture) -&gt; {</span>
<span class="nc" id="L127">      scheduledFuture.cancel(true);</span>
<span class="nc" id="L128">    });</span>
<span class="nc" id="L129">    schemaUpdateExecutor.shutdown();</span>
<span class="nc" id="L130">  }</span>

  public GraphQLSchema get(String organizationId) {
<span class="nc" id="L133">    return schemas.get(organizationId);</span>
  }

  public GraphQLSchema buildSchema(Organization organization) {
<span class="nc" id="L137">    logger.info(&quot;Building GraphQL schema for organization {}&quot;, organization.getId());</span>
<span class="nc" id="L138">    var schemaBuilder = new SchemaBuilder(organization)</span>
<span class="nc" id="L139">        .extensionProviders(extensionsProviders)</span>
<span class="nc" id="L140">        .dynamicTypeProviders(dynamicTypeProviders)</span>
<span class="nc" id="L141">        .queryProviders(queryProviders)</span>
<span class="nc" id="L142">        .mutationProviders(mutationProviders)</span>
<span class="nc" id="L143">        .codeRegistryProviders(codeRegistryProviders)</span>
<span class="nc" id="L144">        .additionalTypeProviders(additionalTypesProviders)</span>
<span class="nc" id="L145">        .fieldVisibilityProviders(fieldVisibilityProviders)</span>
<span class="nc" id="L146">        .typeFunctionProviders(typeFunctionProviders);</span>
<span class="nc" id="L147">    return schemaBuilder.build();</span>
  }

  private void triggerSchemaUpdate() {
    try {
<span class="nc" id="L152">      organizationDirectoryService.getOrganizations().forEach(this::triggerSchemaUpdate);</span>
<span class="nc" id="L153">    } catch (RejectedExecutionException e) {</span>
<span class="nc" id="L154">      logger.debug(&quot;Scheduler [shutdown: {}, terminated: {}] does not except jobs, skipping schema update trigger.&quot;,</span>
<span class="nc" id="L155">          schemaUpdateExecutor.isShutdown(),</span>
<span class="nc" id="L156">          schemaUpdateExecutor.isTerminated()</span>
      );
<span class="nc" id="L158">    }</span>
<span class="nc" id="L159">  }</span>

  private void triggerSchemaUpdate(Organization organization) {
<span class="nc" id="L162">    ScheduledFuture&lt;?&gt; future = scheduledFutureMap.get(organization);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">    if (future != null) {</span>
<span class="nc" id="L164">      future.cancel(true);</span>
    }

<span class="nc" id="L167">    scheduledFutureMap.put(organization,</span>
<span class="nc" id="L168">        schemaUpdateExecutor.schedule(() -&gt; updateSchema(organization), schemaUpdateTriggerDelay,</span>
            TimeUnit.MILLISECONDS));
<span class="nc" id="L170">  }</span>

  public void updateSchema(Organization organization) {
    try {
<span class="nc" id="L174">      schemas.put(organization.getId(), buildSchema(organization));</span>
<span class="nc" id="L175">    } catch (Throwable t) {</span>
<span class="nc" id="L176">      logger.error(&quot;Error building GraphQL schema for organization {}&quot;, organization.getId(), t);</span>
<span class="nc" id="L177">    }</span>
<span class="nc" id="L178">  }</span>

  @Override
  public void organizationRegistered(Organization organization) {
<span class="nc" id="L182">    logger.info(&quot;Trigger GraphQL schema update for organization {}&quot;, organization.getId());</span>
<span class="nc" id="L183">    triggerSchemaUpdate(organization);</span>
<span class="nc" id="L184">  }</span>

  @Override
  public void organizationUnregistered(Organization organization) {
<span class="nc" id="L188">    logger.info(&quot;Removing GraphQL schema for organization {}&quot;, organization.getId());</span>
<span class="nc" id="L189">    schemas.remove(organization.getId());</span>
<span class="nc" id="L190">  }</span>

  @Override
  public void organizationUpdated(Organization organization) {
<span class="nc" id="L194">    logger.trace(&quot;Organization {} updated&quot;, organization.getId());</span>
<span class="nc" id="L195">    triggerSchemaUpdate(organization);</span>
<span class="nc" id="L196">  }</span>

  @Reference(
      policy = ReferencePolicy.DYNAMIC,
      policyOption = ReferencePolicyOption.GREEDY,
      cardinality = ReferenceCardinality.MULTIPLE
  )
  public void bindQueryProvider(GraphQLQueryProvider provider) {
<span class="nc" id="L204">    queryProviders.add(provider);</span>
<span class="nc" id="L205">    triggerSchemaUpdate();</span>
<span class="nc" id="L206">  }</span>

  public void unbindQueryProvider(GraphQLQueryProvider provider) {
<span class="nc" id="L209">    queryProviders.remove(provider);</span>
<span class="nc" id="L210">    triggerSchemaUpdate();</span>
<span class="nc" id="L211">  }</span>

  @Reference(
      policy = ReferencePolicy.DYNAMIC,
      policyOption = ReferencePolicyOption.GREEDY,
      cardinality = ReferenceCardinality.MULTIPLE
  )
  public void bindMutationProvider(GraphQLMutationProvider provider) {
<span class="nc" id="L219">    mutationProviders.add(provider);</span>
<span class="nc" id="L220">    triggerSchemaUpdate();</span>
<span class="nc" id="L221">  }</span>

  public void unbindMutationProvider(GraphQLMutationProvider provider) {
<span class="nc" id="L224">    mutationProviders.remove(provider);</span>
<span class="nc" id="L225">    triggerSchemaUpdate();</span>
<span class="nc" id="L226">  }</span>

  @Reference(
      policy = ReferencePolicy.DYNAMIC,
      policyOption = ReferencePolicyOption.GREEDY,
      cardinality = ReferenceCardinality.MULTIPLE
  )
  public void bindExtensionProvider(GraphQLExtensionProvider provider) {
<span class="nc" id="L234">    extensionsProviders.add(provider);</span>
<span class="nc" id="L235">    triggerSchemaUpdate();</span>
<span class="nc" id="L236">  }</span>

  public void unbindExtensionProvider(GraphQLExtensionProvider provider) {
<span class="nc" id="L239">    extensionsProviders.remove(provider);</span>
<span class="nc" id="L240">    triggerSchemaUpdate();</span>
<span class="nc" id="L241">  }</span>

  @Reference(
      policy = ReferencePolicy.DYNAMIC,
      policyOption = ReferencePolicyOption.GREEDY,
      cardinality = ReferenceCardinality.MULTIPLE
  )
  public void bindAdditionalTypeProvider(GraphQLAdditionalTypeProvider provider) {
<span class="nc" id="L249">    additionalTypesProviders.add(provider);</span>
<span class="nc" id="L250">    triggerSchemaUpdate();</span>
<span class="nc" id="L251">  }</span>

  public void unbindAdditionalTypeProvider(GraphQLAdditionalTypeProvider provider) {
<span class="nc" id="L254">    additionalTypesProviders.remove(provider);</span>
<span class="nc" id="L255">    triggerSchemaUpdate();</span>
<span class="nc" id="L256">  }</span>

  @Reference(
      policy = ReferencePolicy.DYNAMIC,
      policyOption = ReferencePolicyOption.GREEDY,
      cardinality = ReferenceCardinality.MULTIPLE
  )
  public void bindFieldVisibilityProvider(GraphQLFieldVisibilityProvider provider) {
<span class="nc" id="L264">    fieldVisibilityProviders.add(provider);</span>
<span class="nc" id="L265">    triggerSchemaUpdate();</span>
<span class="nc" id="L266">  }</span>

  public void unbindFieldVisibilityProvider(GraphQLFieldVisibilityProvider provider) {
<span class="nc" id="L269">    fieldVisibilityProviders.remove(provider);</span>
<span class="nc" id="L270">    triggerSchemaUpdate();</span>
<span class="nc" id="L271">  }</span>

  @Reference(
      policy = ReferencePolicy.DYNAMIC,
      policyOption = ReferencePolicyOption.GREEDY,
      cardinality = ReferenceCardinality.MULTIPLE
  )
  public void bindDynamicTypeProvider(GraphQLDynamicTypeProvider provider) {
<span class="nc" id="L279">    dynamicTypeProviders.add(provider);</span>
<span class="nc" id="L280">    triggerSchemaUpdate();</span>
<span class="nc" id="L281">  }</span>

  public void unbindDynamicTypeProvider(GraphQLDynamicTypeProvider provider) {
<span class="nc" id="L284">    dynamicTypeProviders.remove(provider);</span>
<span class="nc" id="L285">    triggerSchemaUpdate();</span>
<span class="nc" id="L286">  }</span>

  @Reference(
      policy = ReferencePolicy.DYNAMIC,
      policyOption = ReferencePolicyOption.GREEDY,
      cardinality = ReferenceCardinality.MULTIPLE
  )
  public void bindTypeFunctionProvider(GraphQLTypeFunctionProvider provider) {
<span class="nc" id="L294">    typeFunctionProviders.add(provider);</span>
<span class="nc" id="L295">    triggerSchemaUpdate();</span>
<span class="nc" id="L296">  }</span>

  public void unbindTypeFunctionProvider(GraphQLTypeFunctionProvider provider) {
<span class="nc" id="L299">    typeFunctionProviders.remove(provider);</span>
<span class="nc" id="L300">    triggerSchemaUpdate();</span>
<span class="nc" id="L301">  }</span>

<span class="nc" id="L303">  public static class SchemaUpdateThreadFactory implements ThreadFactory {</span>

<span class="nc" id="L305">    private final AtomicInteger threadNumber = new AtomicInteger(0);</span>

    @Override
    public Thread newThread(Runnable r) {
<span class="nc" id="L309">      var thread = new Thread(r, &quot;GraphQL-Schema-Update-&quot; + threadNumber.getAndIncrement());</span>
<span class="nc" id="L310">      thread.setDaemon(true);</span>
<span class="nc" id="L311">      return thread;</span>
    }

  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>