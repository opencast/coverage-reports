<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SegmentPreviewsWorkflowOperationHandler.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-composer-workflowoperation</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.workflow.handler.composer</a> &gt; <span class="el_source">SegmentPreviewsWorkflowOperationHandler.java</span></div><h1>SegmentPreviewsWorkflowOperationHandler.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.workflow.handler.composer;

import org.opencastproject.composer.api.ComposerService;
import org.opencastproject.composer.api.EncoderException;
import org.opencastproject.composer.api.EncodingProfile;
import org.opencastproject.job.api.Job;
import org.opencastproject.job.api.JobContext;
import org.opencastproject.mediapackage.Attachment;
import org.opencastproject.mediapackage.Catalog;
import org.opencastproject.mediapackage.MediaPackage;
import org.opencastproject.mediapackage.MediaPackageElement;
import org.opencastproject.mediapackage.MediaPackageElementFlavor;
import org.opencastproject.mediapackage.MediaPackageElementParser;
import org.opencastproject.mediapackage.MediaPackageElements;
import org.opencastproject.mediapackage.MediaPackageException;
import org.opencastproject.mediapackage.MediaPackageReference;
import org.opencastproject.mediapackage.MediaPackageReferenceImpl;
import org.opencastproject.mediapackage.Track;
import org.opencastproject.mediapackage.selector.TrackSelector;
import org.opencastproject.metadata.mpeg7.MediaTimePoint;
import org.opencastproject.metadata.mpeg7.Mpeg7Catalog;
import org.opencastproject.metadata.mpeg7.Mpeg7CatalogService;
import org.opencastproject.metadata.mpeg7.Segment;
import org.opencastproject.metadata.mpeg7.TemporalDecomposition;
import org.opencastproject.metadata.mpeg7.Video;
import org.opencastproject.serviceregistry.api.ServiceRegistry;
import org.opencastproject.serviceregistry.api.ServiceRegistryException;
import org.opencastproject.util.MimeTypes;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.UnknownFileTypeException;
import org.opencastproject.workflow.api.AbstractWorkflowOperationHandler;
import org.opencastproject.workflow.api.ConfiguredTagsAndFlavors;
import org.opencastproject.workflow.api.WorkflowInstance;
import org.opencastproject.workflow.api.WorkflowOperationException;
import org.opencastproject.workflow.api.WorkflowOperationHandler;
import org.opencastproject.workflow.api.WorkflowOperationInstance;
import org.opencastproject.workflow.api.WorkflowOperationResult;
import org.opencastproject.workflow.api.WorkflowOperationResult.Action;
import org.opencastproject.workspace.api.Workspace;

import org.apache.commons.io.IOUtils;
import org.apache.commons.lang3.StringUtils;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.Collection;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.List;
import java.util.Set;
import java.util.concurrent.ExecutionException;

/**
 * The workflow definition for creating segment preview images from an segment mpeg-7 catalog.
 */
@Component(
    immediate = true,
    service = WorkflowOperationHandler.class,
    property = {
        &quot;service.description=Segment Preview Images Workflow Operation Handler&quot;,
        &quot;workflow.operation=segmentpreviews&quot;
    }
)
<span class="nc" id="L92">public class SegmentPreviewsWorkflowOperationHandler extends AbstractWorkflowOperationHandler {</span>

  /** The logging facility */
<span class="nc" id="L95">  private static final Logger logger = LoggerFactory.getLogger(SegmentPreviewsWorkflowOperationHandler.class);</span>

  /** The composer service */
<span class="nc" id="L98">  private ComposerService composerService = null;</span>

  /** The mpeg7 catalog service */
<span class="nc" id="L101">  private Mpeg7CatalogService mpeg7CatalogService = null;</span>

  /** The local workspace */
<span class="nc" id="L104">  private Workspace workspace = null;</span>

  /**
   * Callback for the OSGi declarative services configuration.
   *
   * @param composerService
   *          the composer service
   */
  @Reference
  protected void setComposerService(ComposerService composerService) {
<span class="nc" id="L114">    this.composerService = composerService;</span>
<span class="nc" id="L115">  }</span>

  /**
   * Callback for the OSGi declarative services configuration.
   *
   * @param catalogService
   *          the catalog service
   */
  @Reference(name = &quot;Mpeg7Service&quot;)
  protected void setMpeg7CatalogService(Mpeg7CatalogService catalogService) {
<span class="nc" id="L125">    mpeg7CatalogService = catalogService;</span>
<span class="nc" id="L126">  }</span>

  /**
   * Callback for declarative services configuration that will introduce us to the local workspace service.
   * Implementation assumes that the reference is configured as being static.
   *
   * @param workspace
   *          an instance of the workspace
   */
  @Reference
  public void setWorkspace(Workspace workspace) {
<span class="nc" id="L137">    this.workspace = workspace;</span>
<span class="nc" id="L138">  }</span>

  @Reference
  @Override
  public void setServiceRegistry(ServiceRegistry serviceRegistry) {
<span class="nc" id="L143">    super.setServiceRegistry(serviceRegistry);</span>
<span class="nc" id="L144">  }</span>

  /**
   * {@inheritDoc}
   *
   * @see org.opencastproject.workflow.api.WorkflowOperationHandler#start(org.opencastproject.workflow.api.WorkflowInstance,
   *      JobContext)
   */
  @Override
  public WorkflowOperationResult start(final WorkflowInstance workflowInstance, JobContext context)
          throws WorkflowOperationException {
<span class="nc" id="L155">    logger.debug(&quot;Running segments preview workflow operation on {}&quot;, workflowInstance);</span>

    // Check if there is an mpeg-7 catalog containing video segments
<span class="nc" id="L158">    MediaPackage src = (MediaPackage) workflowInstance.getMediaPackage().clone();</span>
<span class="nc" id="L159">    Catalog[] segmentCatalogs = src.getCatalogs(MediaPackageElements.SEGMENTS);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">    if (segmentCatalogs.length == 0) {</span>
<span class="nc" id="L161">      logger.info(&quot;Media package {} does not contain segment information&quot;, src);</span>
<span class="nc" id="L162">      return createResult(Action.CONTINUE);</span>
    }

    // Create the images
    try {
<span class="nc" id="L167">      return createPreviews(src, workflowInstance);</span>
<span class="nc" id="L168">    } catch (Exception e) {</span>
<span class="nc" id="L169">      throw new WorkflowOperationException(e);</span>
    }

  }

  /**
   * Encode tracks from MediaPackage using profiles stored in properties and updates current MediaPackage.
   *
   * @param mediaPackage
   * @return the operation result containing the updated mediapackage
   * @throws EncoderException
   * @throws ExecutionException
   * @throws InterruptedException
   * @throws IOException
   * @throws NotFoundException
   * @throws WorkflowOperationException
   */
  private WorkflowOperationResult createPreviews(final MediaPackage mediaPackage, WorkflowInstance wi)
          throws EncoderException, InterruptedException, ExecutionException, NotFoundException, MediaPackageException,
          IOException, WorkflowOperationException {
<span class="nc" id="L189">    long totalTimeInQueue = 0;</span>

<span class="nc" id="L191">    WorkflowOperationInstance operation = wi.getCurrentOperation();</span>

    // Read the configuration properties
<span class="nc" id="L194">    ConfiguredTagsAndFlavors tagsAndFlavors = getTagsAndFlavors(wi,</span>
        Configuration.many, Configuration.one, Configuration.many, Configuration.one);
<span class="nc" id="L196">    MediaPackageElementFlavor sourceVideoFlavor = tagsAndFlavors.getSingleSrcFlavor();</span>
<span class="nc" id="L197">    List&lt;String&gt; sourceTagSet = tagsAndFlavors.getSrcTags();</span>
<span class="nc" id="L198">    List&lt;String&gt; targetImageTags = tagsAndFlavors.getTargetTags();</span>
<span class="nc" id="L199">    MediaPackageElementFlavor targetImageFlavor = tagsAndFlavors.getSingleTargetFlavor();</span>
<span class="nc" id="L200">    String encodingProfileName = StringUtils.trimToNull(operation.getConfiguration(&quot;encoding-profile&quot;));</span>
<span class="nc" id="L201">    String referenceFlavor = StringUtils.trimToNull(operation.getConfiguration(&quot;reference-flavor&quot;));</span>
<span class="nc" id="L202">    String referenceTags = StringUtils.trimToNull(operation.getConfiguration(&quot;reference-tags&quot;));</span>

    // Find the encoding profile
<span class="nc" id="L205">    EncodingProfile profile = composerService.getProfile(encodingProfileName);</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">    if (profile == null)</span>
<span class="nc" id="L207">      throw new IllegalStateException(&quot;Encoding profile '&quot; + encodingProfileName + &quot;' was not found&quot;);</span>

    // Select the tracks based on the tags and flavors
<span class="nc" id="L210">    TrackSelector trackSelector = new TrackSelector();</span>
<span class="nc" id="L211">    trackSelector.addFlavor(sourceVideoFlavor);</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">    for (String tag : sourceTagSet) {</span>
<span class="nc" id="L213">      trackSelector.addTag(tag);</span>
<span class="nc" id="L214">    }</span>
<span class="nc" id="L215">    Collection&lt;Track&gt; tracks = trackSelector.select(mediaPackage, true);</span>

<span class="nc" id="L217">    Set&lt;Track&gt; videoTrackSet = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">    for (Track track: tracks) {</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">      if (track.hasVideo()) {</span>
<span class="nc" id="L220">        videoTrackSet.add(track);</span>
      }
<span class="nc" id="L222">    }</span>

<span class="nc bnc" id="L224" title="All 2 branches missed.">    if (videoTrackSet.size() == 0) {</span>
<span class="nc" id="L225">      logger.debug(&quot;Mediapackage {} has no suitable tracks to extract images based on tags {} and flavor {}&quot;,</span>
              mediaPackage, sourceTagSet, sourceVideoFlavor);
<span class="nc" id="L227">      return createResult(mediaPackage, Action.CONTINUE);</span>
    } else {

      // Determine the tagset for the reference
<span class="nc" id="L231">      List&lt;String&gt; referenceTagSet = asList(referenceTags);</span>

      // Determine the reference master
<span class="nc bnc" id="L234" title="All 2 branches missed.">      for (Track t : videoTrackSet) {</span>

        // Try to load the segments catalog
<span class="nc" id="L237">        MediaPackageReference trackReference = new MediaPackageReferenceImpl(t);</span>
<span class="nc" id="L238">        Catalog[] segmentCatalogs = mediaPackage.getCatalogs(MediaPackageElements.SEGMENTS, trackReference);</span>
<span class="nc" id="L239">        Mpeg7Catalog mpeg7 = null;</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (segmentCatalogs.length &gt; 0) {</span>
<span class="nc" id="L241">          mpeg7 = loadMpeg7Catalog(segmentCatalogs[0]);</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">          if (segmentCatalogs.length &gt; 1)</span>
<span class="nc" id="L243">            logger.warn(&quot;More than one segments catalog found for track {}. Resuming with the first one ({})&quot;, t,</span>
                    mpeg7);
        } else {
<span class="nc" id="L246">          logger.debug(&quot;No segments catalog found for track {}&quot;, t);</span>
<span class="nc" id="L247">          continue;</span>
        }

        // Check the catalog's consistency
<span class="nc bnc" id="L251" title="All 4 branches missed.">        if (mpeg7.videoContent() == null || mpeg7.videoContent().next() == null) {</span>
<span class="nc" id="L252">          logger.info(&quot;Segments catalog {} contains no video content&quot;, mpeg7);</span>
<span class="nc" id="L253">          continue;</span>
        }

<span class="nc" id="L256">        Video videoContent = mpeg7.videoContent().next();</span>
<span class="nc" id="L257">        TemporalDecomposition&lt;? extends Segment&gt; decomposition = videoContent.getTemporalDecomposition();</span>

        // Are there any segments?
<span class="nc bnc" id="L260" title="All 4 branches missed.">        if (decomposition == null || !decomposition.hasSegments()) {</span>
<span class="nc" id="L261">          logger.info(&quot;Segments catalog {} contains no video content&quot;, mpeg7);</span>
<span class="nc" id="L262">          continue;</span>
        }

        // Is a derived track with the configured reference flavor available?
<span class="nc" id="L266">        MediaPackageElement referenceMaster = getReferenceMaster(mediaPackage, t, referenceFlavor, referenceTagSet);</span>

        // Create the preview images according to the mpeg7 segments
<span class="nc bnc" id="L269" title="All 4 branches missed.">        if (t.hasVideo() &amp;&amp; mpeg7 != null) {</span>

<span class="nc" id="L271">          Iterator&lt;? extends Segment&gt; segmentIterator = decomposition.segments();</span>

<span class="nc" id="L273">          List&lt;MediaTimePoint&gt; timePointList = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">          while (segmentIterator.hasNext()) {</span>
<span class="nc" id="L275">            Segment segment = segmentIterator.next();</span>
<span class="nc" id="L276">            MediaTimePoint tp = segment.getMediaTime().getMediaTimePoint();</span>
<span class="nc" id="L277">            timePointList.add(tp);</span>
<span class="nc" id="L278">          }</span>

          // convert to time array
<span class="nc" id="L281">          double[] timeArray = new double[timePointList.size()];</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">          for (int i = 0; i &lt; timePointList.size(); i++)</span>
<span class="nc" id="L283">            timeArray[i] = (double) timePointList.get(i).getTimeInMilliseconds() / 1000;</span>

<span class="nc" id="L285">          Job job = composerService.image(t, profile.getIdentifier(), timeArray);</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">          if (!waitForStatus(job).isSuccess()) {</span>
<span class="nc" id="L287">            throw new WorkflowOperationException(&quot;Extracting preview image from &quot; + t + &quot; failed&quot;);</span>
          }

          // Get the latest copy
          try {
<span class="nc" id="L292">            job = serviceRegistry.getJob(job.getId());</span>
<span class="nc" id="L293">          } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L294">            throw new WorkflowOperationException(e);</span>
<span class="nc" id="L295">          }</span>

          // add this receipt's queue time to the total
<span class="nc" id="L298">          totalTimeInQueue += job.getQueueTime();</span>

<span class="nc" id="L300">          List&lt;? extends MediaPackageElement&gt; composedImages = MediaPackageElementParser</span>
<span class="nc" id="L301">                  .getArrayFromXml(job.getPayload());</span>
<span class="nc" id="L302">          Iterator&lt;MediaTimePoint&gt; it = timePointList.iterator();</span>

<span class="nc bnc" id="L304" title="All 2 branches missed.">          for (MediaPackageElement element : composedImages) {</span>
<span class="nc" id="L305">            Attachment composedImage = (Attachment) element;</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">            if (composedImage == null)</span>
<span class="nc" id="L307">              throw new IllegalStateException(&quot;Unable to compose image&quot;);</span>

            // Add the flavor, either from the operation configuration or from the composer
<span class="nc bnc" id="L310" title="All 2 branches missed.">            if (targetImageFlavor != null) {</span>
<span class="nc" id="L311">              composedImage.setFlavor(targetImageFlavor);</span>
<span class="nc" id="L312">              logger.debug(&quot;Preview image has flavor '{}'&quot;, composedImage.getFlavor());</span>
            }

            // Set the mimetype
            try {
<span class="nc" id="L317">              composedImage.setMimeType(MimeTypes.fromURI(composedImage.getURI()));</span>
<span class="nc" id="L318">            } catch (UnknownFileTypeException e) {</span>
<span class="nc" id="L319">              logger.warn(&quot;Mime type unknown for file {}. Setting none.&quot;, composedImage.getURI(), e);</span>
<span class="nc" id="L320">            }</span>

            // Add tags
<span class="nc bnc" id="L323" title="All 2 branches missed.">            for (String tag : targetImageTags) {</span>
<span class="nc" id="L324">              logger.trace(&quot;Tagging image with '{}'&quot;, tag);</span>
<span class="nc" id="L325">              composedImage.addTag(tag);</span>
<span class="nc" id="L326">            }</span>

            // Refer to the original track including a timestamp
<span class="nc" id="L329">            MediaPackageReferenceImpl ref = new MediaPackageReferenceImpl(referenceMaster);</span>
<span class="nc" id="L330">            ref.setProperty(&quot;time&quot;, it.next().toString());</span>
<span class="nc" id="L331">            composedImage.setReference(ref);</span>

            // store new image in the mediaPackage
<span class="nc" id="L334">            mediaPackage.add(composedImage);</span>
<span class="nc" id="L335">            String fileName = getFileNameFromElements(t, composedImage);</span>
<span class="nc" id="L336">            composedImage.setURI(workspace.moveTo(composedImage.getURI(), mediaPackage.getIdentifier().toString(),</span>
<span class="nc" id="L337">                    composedImage.getIdentifier(), fileName));</span>
<span class="nc" id="L338">          }</span>
        }
<span class="nc" id="L340">      }</span>
    }

<span class="nc" id="L343">    return createResult(mediaPackage, Action.CONTINUE, totalTimeInQueue);</span>
  }

  /**
   * Returns the track that is used as the reference for the segment previews. It is either identified by flavor and tag
   * set and being derived from &lt;code&gt;t&lt;/code&gt; or &lt;code&gt;t&lt;/code&gt; itself.
   *
   * @param mediaPackage
   *          the media package
   * @param t
   *          the source track for the images
   * @param referenceFlavor
   *          the required flavor
   * @param referenceTagSet
   *          the required tagset
   * @return the reference master
   */
  private MediaPackageElement getReferenceMaster(MediaPackage mediaPackage, Track t, String referenceFlavor,
          Collection&lt;String&gt; referenceTagSet) {
<span class="nc" id="L362">    MediaPackageElement referenceMaster = t;</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">    if (referenceFlavor != null) {</span>
<span class="nc" id="L364">      MediaPackageElementFlavor flavor = MediaPackageElementFlavor.parseFlavor(referenceFlavor);</span>
      // Find a track with the given flavor that is (indirectly) derived from t?
<span class="nc bnc" id="L366" title="All 2 branches missed.">      locateReferenceMaster: for (Track e : mediaPackage.getTracks(flavor)) {</span>
<span class="nc" id="L367">        MediaPackageReference ref = e.getReference();</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">        while (ref != null) {</span>
<span class="nc" id="L369">          MediaPackageElement tr = mediaPackage.getElementByReference(ref);</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">          if (tr == null)</span>
<span class="nc" id="L371">            break locateReferenceMaster;</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">          if (tr.equals(t)) {</span>
<span class="nc" id="L373">            boolean matches = true;</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">            for (String tag : referenceTagSet) {</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">              if (!e.containsTag(tag))</span>
<span class="nc" id="L376">                matches = false;</span>
<span class="nc" id="L377">            }</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">            if (matches) {</span>
<span class="nc" id="L379">              referenceMaster = e;</span>
<span class="nc" id="L380">              break locateReferenceMaster;</span>
            }
          }
<span class="nc" id="L383">          ref = tr.getReference();</span>
<span class="nc" id="L384">        }</span>
      }
    }
<span class="nc" id="L387">    return referenceMaster;</span>
  }

  /**
   * Loads an mpeg7 catalog from a mediapackage's catalog reference
   *
   * @param catalog
   *          the mediapackage's reference to this catalog
   * @return the mpeg7
   * @throws IOException
   *           if there is a problem loading or parsing the mpeg7 object
   */
  protected Mpeg7Catalog loadMpeg7Catalog(Catalog catalog) throws IOException {
<span class="nc" id="L400">    InputStream in = null;</span>
    try {
<span class="nc" id="L402">      File f = workspace.get(catalog.getURI());</span>
<span class="nc" id="L403">      in = new FileInputStream(f);</span>
<span class="nc" id="L404">      return mpeg7CatalogService.load(in);</span>
<span class="nc" id="L405">    } catch (NotFoundException e) {</span>
<span class="nc" id="L406">      throw new IOException(&quot;Unable to open catalog &quot; + catalog + &quot;: &quot; + e.getMessage());</span>
    } finally {
<span class="nc" id="L408">      IOUtils.closeQuietly(in);</span>
    }
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>