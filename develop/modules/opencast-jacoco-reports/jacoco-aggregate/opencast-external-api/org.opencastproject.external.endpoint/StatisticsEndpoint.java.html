<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>StatisticsEndpoint.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-external-api</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.external.endpoint</a> &gt; <span class="el_source">StatisticsEndpoint.java</span></div><h1>StatisticsEndpoint.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */

package org.opencastproject.external.endpoint;

import static org.opencastproject.security.api.SecurityConstants.GLOBAL_ADMIN_ROLE;
import static org.opencastproject.util.data.functions.Functions.chuck;

import org.opencastproject.elasticsearch.api.SearchIndexException;
import org.opencastproject.elasticsearch.index.ElasticsearchIndex;
import org.opencastproject.elasticsearch.index.objects.event.Event;
import org.opencastproject.elasticsearch.index.objects.series.Series;
import org.opencastproject.external.common.ApiMediaType;
import org.opencastproject.external.common.ApiResponseBuilder;
import org.opencastproject.external.util.statistics.QueryUtils;
import org.opencastproject.external.util.statistics.ResourceTypeUtils;
import org.opencastproject.external.util.statistics.StatisticsProviderUtils;
import org.opencastproject.index.service.api.IndexService;
import org.opencastproject.security.api.Organization;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.UnauthorizedException;
import org.opencastproject.security.api.User;
import org.opencastproject.statistics.api.ResourceType;
import org.opencastproject.statistics.api.StatisticsProvider;
import org.opencastproject.statistics.api.StatisticsService;
import org.opencastproject.statistics.export.api.StatisticsExportService;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.RestUtil;
import org.opencastproject.util.doc.rest.RestParameter;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestResponse;
import org.opencastproject.util.doc.rest.RestService;

import org.apache.commons.lang3.StringUtils;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.jaxrs.whiteboard.propertytypes.JaxrsResource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.time.ZoneId;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.stream.Collectors;

import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.FormParam;
import javax.ws.rs.GET;
import javax.ws.rs.HeaderParam;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.core.Response;

@Path(&quot;/api/statistics&quot;)
@Produces({ ApiMediaType.JSON, ApiMediaType.VERSION_1_3_0, ApiMediaType.VERSION_1_4_0, ApiMediaType.VERSION_1_5_0,
            ApiMediaType.VERSION_1_6_0, ApiMediaType.VERSION_1_7_0, ApiMediaType.VERSION_1_8_0,
            ApiMediaType.VERSION_1_9_0, ApiMediaType.VERSION_1_10_0, ApiMediaType.VERSION_1_11_0 })
@RestService(
  name = &quot;externalapistatistics&quot;, title = &quot;External API Statistics Endpoint&quot;,
  notes = {}, abstractText = &quot;Provides statistics&quot;)
@Component(
    immediate = true,
    service = StatisticsEndpoint.class,
    property = {
        &quot;service.description=External API - Statistics Endpoint&quot;,
        &quot;opencast.service.type=org.opencastproject.external.statistics&quot;,
        &quot;opencast.service.path=/api/statistics&quot;
    }
)
@JaxrsResource
<span class="nc" id="L100">public class StatisticsEndpoint {</span>

  /** The logging facility */
<span class="nc" id="L103">  private static final Logger logger = LoggerFactory.getLogger(StatisticsEndpoint.class);</span>

  private SecurityService securityService;
  private IndexService indexService;
  private ElasticsearchIndex elasticsearchIndex;
  private StatisticsService statisticsService;
  private StatisticsExportService statisticsExportService;

  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="nc" id="L113">    this.securityService = securityService;</span>
<span class="nc" id="L114">  }</span>

  @Reference
  public void setIndexService(IndexService indexService) {
<span class="nc" id="L118">    this.indexService = indexService;</span>
<span class="nc" id="L119">  }</span>

  @Reference
  public void setElasticsearchIndex(ElasticsearchIndex elasticsearchIndex) {
<span class="nc" id="L123">    this.elasticsearchIndex = elasticsearchIndex;</span>
<span class="nc" id="L124">  }</span>

  @Reference
  public void setStatisticsService(StatisticsService statisticsService) {
<span class="nc" id="L128">    this.statisticsService = statisticsService;</span>
<span class="nc" id="L129">  }</span>

  @Reference
  public void setStatisticsExportService(StatisticsExportService statisticsExportService) {
<span class="nc" id="L133">    this.statisticsExportService = statisticsExportService;</span>
<span class="nc" id="L134">  }</span>

  /** OSGi activation method */
  @Activate
  void activate(ComponentContext cc) {
<span class="nc" id="L139">    logger.info(&quot;Activating External API - Statistics Endpoint&quot;);</span>
<span class="nc" id="L140">  }</span>

  @GET
  @Path(&quot;providers&quot;)
  @RestQuery(
    name = &quot;getproviders&quot;,
    description = &quot;Returns a list of available statistics providers&quot;,
    returnDescription = &quot;The list of available statistics providers as JSON&quot;,
    restParameters = {
      @RestParameter(
        name = &quot;filter&quot;, isRequired = false,
        description = &quot;Usage [Filter Name]:[Value to Filter With]. Available filter: \&quot;resourceType\&quot;&quot;,
        type = RestParameter.Type.STRING),
      @RestParameter(
        name = &quot;withparameters&quot;, isRequired = false,
        description = &quot;Whether the parameters should be included in the response.&quot;,
        type = RestParameter.Type.BOOLEAN)
    },
    responses = {
      @RestResponse(
        description = &quot;Returns the requested statistics providers as JSON&quot;,
        responseCode = HttpServletResponse.SC_OK),
      @RestResponse(
        description = &quot;If the current user is not authorized to perform this action&quot;,
        responseCode = HttpServletResponse.SC_UNAUTHORIZED)
    })
  public Response getProviders(@HeaderParam(&quot;Accept&quot;) String acceptHeader, @QueryParam(&quot;filter&quot;) String filter,
        @QueryParam(&quot;withparameters&quot;) Boolean withParameters) {

<span class="nc" id="L169">    ResourceType resourceType = null;</span>

<span class="nc bnc" id="L171" title="All 2 branches missed.">    if (StringUtils.isNotBlank(filter)) {</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">      for (String f : filter.split(&quot;,&quot;)) {</span>
<span class="nc" id="L173">        String[] filterTuple = f.split(&quot;:&quot;);</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (filterTuple.length != 2) {</span>
<span class="nc" id="L175">          logger.debug(&quot;No value for filter {} in filters list: {}&quot;, filterTuple[0], filter);</span>
<span class="nc" id="L176">          continue;</span>
        }
<span class="nc" id="L178">        String name = filterTuple[0];</span>
<span class="nc" id="L179">        String value = f.substring(name.length() + 1);</span>

<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (&quot;resourceType&quot;.equals(name)) {</span>
          try {
<span class="nc" id="L183">            resourceType = ResourceTypeUtils.fromString(value);</span>
<span class="nc" id="L184">          } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L185">            return RestUtil.R.badRequest(&quot;Invalid value for 'resourceType'&quot;);</span>
<span class="nc" id="L186">          }</span>
        } else {
<span class="nc" id="L188">          logger.warn(&quot;Unknown filter criteria {}&quot;, name);</span>
<span class="nc" id="L189">          return RestUtil.R.badRequest(&quot;Unknown filter&quot;);</span>
        }
      }
    }

    Set&lt;StatisticsProvider&gt; providers;
<span class="nc bnc" id="L195" title="All 2 branches missed.">    if (resourceType != null) {</span>
<span class="nc" id="L196">      providers = statisticsService.getProviders(resourceType);</span>
    } else {
<span class="nc" id="L198">      providers = statisticsService.getProviders();</span>
    }

<span class="nc" id="L201">    JSONArray result = new JSONArray();</span>
<span class="nc" id="L202">    providers.stream().map(p -&gt; StatisticsProviderUtils.toJson(p, withParameters)).forEach(result::add);</span>

<span class="nc" id="L204">    return ApiResponseBuilder.Json.ok(acceptHeader, result.toJSONString());</span>
  }

  @GET
  @Path(&quot;providers/{providerId}&quot;)
  @RestQuery(
    name = &quot;getprovider&quot;,
    description = &quot;Returns the statistics provider with the specified id&quot;,
    returnDescription = &quot;The requested statistics provider&quot;,
    pathParameters = {
      @RestParameter(
        name = &quot;providerId&quot;, description = &quot;The identifier of the statistics provider&quot;,
        isRequired = true, type = RestParameter.Type.STRING)
    },
    restParameters = {
      @RestParameter(
        name = &quot;withparameters&quot;, isRequired = false,
        description = &quot;Whether the parameters should be included in the response.&quot;,
        type = RestParameter.Type.BOOLEAN)
    },
    responses = {
      @RestResponse(
        description = &quot;Returns the requested statistics provider as JSON&quot;,
        responseCode = HttpServletResponse.SC_OK)
    })
  public Response getProvider(@HeaderParam(&quot;Accept&quot;) String acceptHeader, @PathParam(&quot;providerId&quot;) String id,
        @QueryParam(&quot;withparameters&quot;) Boolean withParameters) {

<span class="nc bnc" id="L232" title="All 2 branches missed.">    if (StringUtils.isNotBlank(id)) {</span>
<span class="nc" id="L233">      Optional&lt;StatisticsProvider&gt; provider = statisticsService.getProvider(id);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">      if (provider.isPresent()) {</span>
<span class="nc" id="L235">        return ApiResponseBuilder.Json.ok(acceptHeader, StatisticsProviderUtils.toJson(provider.get(),</span>
<span class="nc" id="L236">            withParameters).toJSONString());</span>
      } else {
<span class="nc" id="L238">        return ApiResponseBuilder.notFound(&quot;Cannot find a statistics provider with id '%s'.&quot;, id);</span>
      }
    } else {
<span class="nc" id="L241">      return RestUtil.R.badRequest(&quot;Invalid value for providerId&quot;);</span>
    }
  }

  @POST
  @Path(&quot;data/query&quot;)
  @RestQuery(
    name = &quot;getstatistics&quot;,
    description = &quot;Returns the statistical data based on the query posted&quot;,
    returnDescription = &quot;The statistical data as JSON array&quot;,
    restParameters = {
      @RestParameter(
        name = &quot;data&quot;, description = &quot;An JSON array describing the queries to be executed&quot;,
        isRequired = true, type = RestParameter.Type.TEXT)
    },
    responses = {
      @RestResponse(
        description = &quot;Returns the statistical data as requested by the query as JSON array&quot;,
        responseCode = HttpServletResponse.SC_OK),
      @RestResponse(
        description = &quot;If the current user is not authorized to perform this action&quot;,
        responseCode = HttpServletResponse.SC_UNAUTHORIZED)
    })
  public Response getStatistics(@HeaderParam(&quot;Accept&quot;) String acceptHeader, @FormParam(&quot;data&quot;) String data) {

<span class="nc" id="L266">    List&lt;QueryUtils.Query&gt; queries = null;</span>
    try {
<span class="nc" id="L268">      queries = QueryUtils.parse(data, statisticsService);</span>
<span class="nc" id="L269">    } catch (Exception e) {</span>
<span class="nc" id="L270">      logger.debug(&quot;Unable to parse form parameter 'data' {}, exception&quot;, data, e);</span>
<span class="nc" id="L271">      return RestUtil.R.badRequest(&quot;Unable to parse form parameter 'data': &quot; + e.getMessage());</span>
<span class="nc" id="L272">    }</span>

<span class="nc" id="L274">    JSONArray result = new JSONArray();</span>
<span class="nc" id="L275">    queries.stream()</span>
<span class="nc" id="L276">      .peek(query -&gt; checkAccess(query.getParameters().getResourceId(), query.getProvider().getResourceType()))</span>
<span class="nc" id="L277">      .map(query -&gt; QueryUtils.execute(query))</span>
<span class="nc" id="L278">      .forEach(result::add);</span>

<span class="nc" id="L280">    return ApiResponseBuilder.Json.ok(acceptHeader, result.toJSONString());</span>
  }

  @POST
  @Produces({ ApiMediaType.JSON, ApiMediaType.VERSION_1_4_0, ApiMediaType.VERSION_1_5_0, ApiMediaType.VERSION_1_6_0,
              ApiMediaType.VERSION_1_7_0, ApiMediaType.VERSION_1_8_0, ApiMediaType.VERSION_1_9_0 })
  @Path(&quot;data/export.csv&quot;)
  @RestQuery(
          name = &quot;getexportcsv&quot;,
          description = &quot;Returns a statistics csv export&quot;,
          returnDescription = &quot;The requested statistics csv export&quot;,
          restParameters = {
                  @RestParameter(
                          name = &quot;data&quot;, description = &quot;A JSON object describing the query to be executed&quot;,
                          isRequired = true, type = RestParameter.Type.TEXT),
                  @RestParameter(
                          name = &quot;limit&quot;, description = &quot;Limit for pagination.&quot;,
                          isRequired = false, type = RestParameter.Type.INTEGER),
                  @RestParameter(
                          name = &quot;offset&quot;, description = &quot;Offset for pagination.&quot;,
                          isRequired = false, type = RestParameter.Type.INTEGER),
                  @RestParameter(
                          name = &quot;filter&quot;, description = &quot;Usage [Filter Name]:[Value to Filter With]. Multiple filters can be used by combining them with commas \&quot;,\&quot;.&quot;,
                          isRequired = false, type = RestParameter.Type.STRING)
          },
          responses = {
                  @RestResponse(
                          description = &quot;Returns the csv data as requested by the query as plain text&quot;,
                          responseCode = HttpServletResponse.SC_OK),
                  @RestResponse(
                          description = &quot;If the current user is not authorized to perform this action&quot;,
                          responseCode = HttpServletResponse.SC_UNAUTHORIZED)
          })
  public Response getExportCSV(
          @HeaderParam(&quot;Accept&quot;) String acceptHeader,
          @FormParam(&quot;data&quot;) String data,
          @FormParam(&quot;limit&quot;) Integer limit,
          @FormParam(&quot;offset&quot;) Integer offset,
          @FormParam(&quot;filter&quot;) String filter
  ) throws NotFoundException, SearchIndexException, UnauthorizedException {

<span class="nc bnc" id="L321" title="All 2 branches missed.">    final int lim = limit != null ? Math.max(0, limit) : 0;</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">    final int off = offset != null ? Math.max(0, offset) : 0;</span>

<span class="nc" id="L324">    final Map&lt;String, String&gt; filters = Arrays.stream(Optional.ofNullable(filter).orElse(&quot;&quot;)</span>
<span class="nc" id="L325">            .split(&quot;,&quot;))</span>
<span class="nc" id="L326">            .filter(f -&gt; f.contains(&quot;:&quot;))</span>
<span class="nc" id="L327">            .collect(Collectors.toMap(</span>
<span class="nc" id="L328">                    f -&gt; f.substring(0, f.indexOf(&quot;:&quot;)),</span>
<span class="nc" id="L329">                    f -&gt; f.substring(f.indexOf(&quot;:&quot;) + 1)));</span>

<span class="nc" id="L331">    QueryUtils.Query query = null;</span>
    try {
<span class="nc" id="L333">      query = QueryUtils.parseQuery(data, statisticsService);</span>
<span class="nc" id="L334">    } catch (Exception e) {</span>
<span class="nc" id="L335">      logger.debug(&quot;Unable to parse form parameter 'data' {}, exception&quot;, data, e);</span>
<span class="nc" id="L336">      return RestUtil.R.badRequest(&quot;Unable to parse form parameter 'data': &quot; + e.getMessage());</span>
<span class="nc" id="L337">    }</span>
<span class="nc" id="L338">    checkAccess(query.getParameters().getResourceId(), query.getProvider().getResourceType());</span>

<span class="nc" id="L340">    final QueryUtils.ExportParameters parameters = (QueryUtils.ExportParameters) query.getParameters();</span>
<span class="nc" id="L341">    final String result = statisticsExportService.getCSV(</span>
<span class="nc" id="L342">            query.getProvider(),</span>
<span class="nc" id="L343">            parameters.getResourceId(),</span>
<span class="nc" id="L344">            parameters.getFrom(),</span>
<span class="nc" id="L345">            parameters.getTo(),</span>
<span class="nc" id="L346">            parameters.getDataResolution(),</span>
            this.elasticsearchIndex,
<span class="nc" id="L348">            ZoneId.systemDefault(),</span>
            true,
<span class="nc" id="L350">            parameters.getDetailLevel(),</span>
            lim,
            off,
            filters
    );

<span class="nc" id="L356">    return ApiResponseBuilder.Json.ok(acceptHeader, new JSONObject(Collections.singletonMap(&quot;csv&quot;, result)).toJSONString());</span>
  }

  private void checkAccess(final String resourceId, final ResourceType resourceType) {
    try {
<span class="nc bnc" id="L361" title="All 4 branches missed.">      switch (resourceType) {</span>
        case EPISODE:
<span class="nc" id="L363">          checkMediapackageAccess(resourceId);</span>
<span class="nc" id="L364">          break;</span>
        case SERIES:
<span class="nc" id="L366">          checkSeriesAccess(resourceId);</span>
<span class="nc" id="L367">          break;</span>
        case ORGANIZATION:
<span class="nc" id="L369">          checkOrganizationAccess(resourceId);</span>
<span class="nc" id="L370">          break;</span>
        default:
          break;
      }
<span class="nc" id="L374">    } catch (UnauthorizedException | SearchIndexException e) {</span>
<span class="nc" id="L375">      chuck(e);</span>
<span class="nc" id="L376">    }</span>
<span class="nc" id="L377">  }</span>

  private void checkMediapackageAccess(final String mpId) throws UnauthorizedException, SearchIndexException {
<span class="nc" id="L380">    final Optional&lt;Event&gt; event = indexService.getEvent(mpId, elasticsearchIndex);</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">    if (event.isEmpty()) {</span>
      // IndexService checks permissions and returns None if user is unauthorized
<span class="nc" id="L383">      throw new UnauthorizedException(securityService.getUser(), &quot;read&quot;);</span>
    }
<span class="nc" id="L385">  }</span>

  private void checkSeriesAccess(final String seriesId) throws UnauthorizedException, SearchIndexException {
<span class="nc" id="L388">    final Optional&lt;Series&gt; series = elasticsearchIndex.getSeries(seriesId, securityService.getOrganization().getId(), securityService.getUser());</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">    if (series.isEmpty()) {</span>
      // IndexService checks permissions and returns None if user is unauthorized
<span class="nc" id="L391">      throw new UnauthorizedException(securityService.getUser(), &quot;read&quot;);</span>
    }
<span class="nc" id="L393">  }</span>

  private void checkOrganizationAccess(final String orgId) throws UnauthorizedException {
<span class="nc" id="L396">    final User currentUser = securityService.getUser();</span>
<span class="nc" id="L397">    final Organization currentOrg = securityService.getOrganization();</span>
<span class="nc" id="L398">    final String currentOrgAdminRole = currentOrg.getAdminRole();</span>
<span class="nc" id="L399">    final String currentOrgId = currentOrg.getId();</span>

<span class="nc bnc" id="L401" title="All 2 branches missed.">    boolean authorized = currentUser.hasRole(GLOBAL_ADMIN_ROLE)</span>
<span class="nc bnc" id="L402" title="All 4 branches missed.">            || (currentUser.hasRole(currentOrgAdminRole) &amp;&amp; currentOrgId.equals(orgId));</span>

<span class="nc bnc" id="L404" title="All 2 branches missed.">    if (!authorized) {</span>
<span class="nc" id="L405">      throw new UnauthorizedException(currentUser, &quot;read&quot;);</span>
    }
<span class="nc" id="L407">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>