<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CaptureAgentsEndpoint.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-external-api</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.external.endpoint</a> &gt; <span class="el_source">CaptureAgentsEndpoint.java</span></div><h1>CaptureAgentsEndpoint.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.external.endpoint;

import static org.opencastproject.external.util.CaptureAgentUtils.generateJsonAgent;
import static org.opencastproject.util.doc.rest.RestParameter.Type.STRING;

import org.opencastproject.capture.admin.api.Agent;
import org.opencastproject.capture.admin.api.CaptureAgentStateService;
import org.opencastproject.external.common.ApiMediaType;
import org.opencastproject.external.common.ApiResponseBuilder;
import org.opencastproject.util.doc.rest.RestParameter;
import org.opencastproject.util.doc.rest.RestParameter.Type;
import org.opencastproject.util.doc.rest.RestQuery;
import org.opencastproject.util.doc.rest.RestResponse;
import org.opencastproject.util.doc.rest.RestService;

import com.google.gson.JsonArray;

import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.jaxrs.whiteboard.propertytypes.JaxrsResource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.ArrayList;
import java.util.List;

import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.GET;
import javax.ws.rs.HeaderParam;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.core.Response;

@Path(&quot;/api/agents&quot;)
@Produces({ ApiMediaType.JSON, ApiMediaType.VERSION_1_1_0, ApiMediaType.VERSION_1_2_0, ApiMediaType.VERSION_1_3_0,
            ApiMediaType.VERSION_1_4_0, ApiMediaType.VERSION_1_5_0, ApiMediaType.VERSION_1_6_0,
            ApiMediaType.VERSION_1_7_0, ApiMediaType.VERSION_1_8_0, ApiMediaType.VERSION_1_9_0,
            ApiMediaType.VERSION_1_10_0, ApiMediaType.VERSION_1_11_0 })
@RestService(
    name = &quot;externalapicaptureagents&quot;,
    title = &quot;External API Capture Agents Service&quot;,
    notes = {},
    abstractText = &quot;Provides resources and operations related to the capture agents&quot;
)
@Component(
    immediate = true,
    service = CaptureAgentsEndpoint.class,
    property = {
        &quot;service.description=External API - Capture Agents Endpoint&quot;,
        &quot;opencast.service.type=org.opencastproject.external.agents&quot;,
        &quot;opencast.service.path=/api/agents&quot;
    }
)
@JaxrsResource
<span class="fc" id="L79">public class CaptureAgentsEndpoint {</span>

  /** The logging facility */
<span class="fc" id="L82">  private static final Logger logger = LoggerFactory.getLogger(CaptureAgentsEndpoint.class);</span>

  /** The capture agent service */
  private CaptureAgentStateService agentStateService;

  /** OSGi DI */
  public CaptureAgentStateService getAgentStateService() {
<span class="nc" id="L89">    return agentStateService;</span>
  }

  /** OSGi DI */
  @Reference
  public void setAgentStateService(CaptureAgentStateService agentStateService) {
<span class="fc" id="L95">    this.agentStateService = agentStateService;</span>
<span class="fc" id="L96">  }</span>


  /** OSGi activation method */
  @Activate
  void activate(ComponentContext cc) {
<span class="nc" id="L102">    logger.info(&quot;Activating External API - Capture Agents Endpoint&quot;);</span>
<span class="nc" id="L103">  }</span>

  @GET
  @Path(&quot;{agentId}&quot;)
  @RestQuery(
      name = &quot;getagent&quot;,
      description = &quot;Returns a single capture agent.&quot;,
      returnDescription = &quot;&quot;,
      pathParameters = {
          @RestParameter(name = &quot;agentId&quot;, description = &quot;The agent id&quot;, isRequired = true, type = STRING)
      },
      responses = {
          @RestResponse(description = &quot;The agent is returned.&quot;, responseCode = HttpServletResponse.SC_OK),
          @RestResponse(description = &quot;The specified agent does not exist.&quot;, responseCode = HttpServletResponse.SC_NOT_FOUND)
      }
  )
  public Response getAgent(
      @HeaderParam(&quot;Accept&quot;) String acceptHeader,
      @PathParam(&quot;agentId&quot;) String id) throws Exception {
<span class="fc" id="L122">    final Agent agent = agentStateService.getAgent(id);</span>

<span class="fc bfc" id="L124" title="All 2 branches covered.">    if (agent == null) {</span>
<span class="fc" id="L125">      return ApiResponseBuilder.notFound(&quot;Cannot find an agent with id '%s'.&quot;, id);</span>
    }

<span class="fc" id="L128">    return ApiResponseBuilder.Json.ok(acceptHeader, generateJsonAgent(agent));</span>
  }

  @GET
  @Path(&quot;/&quot;)
  @RestQuery(
      name = &quot;getagents&quot;,
      description = &quot;Returns a list of agents.&quot;,
      returnDescription = &quot;&quot;,
      restParameters = {
          @RestParameter(name = &quot;limit&quot;, description = &quot;The maximum number of results to return for a single request.&quot;, isRequired = false, type = Type.INTEGER),
          @RestParameter(name = &quot;offset&quot;, description = &quot;The index of the first result to return.&quot;, isRequired = false, type = Type.INTEGER)
      },
      responses = {
          @RestResponse(description = &quot;A (potentially empty) list of agents is returned.&quot;, responseCode = HttpServletResponse.SC_OK)
      }
  )
  public Response getAgents(
      @HeaderParam(&quot;Accept&quot;) String acceptHeader,
      @QueryParam(&quot;offset&quot;) Integer offset,
      @QueryParam(&quot;limit&quot;) Integer limit) {

<span class="fc" id="L150">    List&lt;Agent&gt; agents = new ArrayList&lt;&gt;(agentStateService.getKnownAgents().values());</span>

    // Apply offset
<span class="pc bpc" id="L153" title="1 of 4 branches missed.">    if (offset != null &amp;&amp; offset &gt; 0) {</span>
<span class="fc" id="L154">      agents = agents.subList(Math.min(offset, agents.size()), agents.size());</span>
    }

    // Apply limit
<span class="fc bfc" id="L158" title="All 4 branches covered.">    if (limit != null &amp;&amp; limit &gt; 0) {</span>
<span class="fc" id="L159">      agents = agents.subList(0, Math.min(limit, agents.size()));</span>
    }

<span class="fc" id="L162">    JsonArray agentsJSON = new JsonArray();</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">    for (Agent a : agents) {</span>
<span class="fc" id="L164">      agentsJSON.add(generateJsonAgent(a));</span>
<span class="fc" id="L165">    }</span>

<span class="fc" id="L167">    return ApiResponseBuilder.Json.ok(acceptHeader, agentsJSON);</span>
  }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>