<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ExternalGroupLoader.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-external-api</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.external.userdirectory</a> &gt; <span class="el_source">ExternalGroupLoader.java</span></div><h1>ExternalGroupLoader.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.external.userdirectory;

import static java.nio.charset.StandardCharsets.UTF_8;

import org.opencastproject.security.api.Organization;
import org.opencastproject.security.api.OrganizationDirectoryService;
import org.opencastproject.security.api.SecurityConstants;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.UnauthorizedException;
import org.opencastproject.security.impl.jpa.JpaGroup;
import org.opencastproject.security.impl.jpa.JpaOrganization;
import org.opencastproject.security.impl.jpa.JpaRole;
import org.opencastproject.security.util.SecurityUtil;
import org.opencastproject.userdirectory.JpaGroupRoleProvider;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.UrlSupport;

import org.apache.commons.io.IOUtils;
import org.apache.commons.lang3.BooleanUtils;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.io.InputStream;
import java.util.Dictionary;
import java.util.HashSet;
import java.util.Objects;
import java.util.Set;
import java.util.TreeSet;

/**
 * The external group loader
 */
@Component(
    immediate = true,
    service = ExternalGroupLoader.class,
    property = {
        &quot;service.description=External group loader&quot;
    }
)
<span class="nc" id="L65">public class ExternalGroupLoader {</span>

  /** The logging facility */
<span class="nc" id="L68">  private static final Logger logger = LoggerFactory.getLogger(ExternalGroupLoader.class);</span>

  /** The config key, which specifies whether default groups should be created */
  public static final String SHOULD_CREATE_DEFAULT_GROUPS_CONFIG_KEY = &quot;create_default_groups&quot;;

  /** The external applications group suffix */
  public static final String EXTERNAL_GROUP_SUFFIX = &quot;_EXTERNAL_APPLICATIONS&quot;;

  /** Path to the list of roles */
  public static final String ROLES_PATH_PREFIX = &quot;/roles&quot;;

  /** The path to the external applications list of roles */
  public static final String EXTERNAL_APPLICATIONS_ROLES_FILE = &quot;external-applications&quot;;

  /** The group role provider */
  protected JpaGroupRoleProvider groupRoleProvider;

  /** The organization directory service */
  protected OrganizationDirectoryService organizationDirectoryService;

  /** The security service to use to run as the context for adding the groups */
  protected SecurityService securityService;

  /**
   * @param groupRoleProvider
   *          the groupRoleProvider to set
   */
  @Reference
  public void setGroupRoleProvider(JpaGroupRoleProvider groupRoleProvider) {
<span class="nc" id="L97">    this.groupRoleProvider = groupRoleProvider;</span>
<span class="nc" id="L98">  }</span>

  /**
   * @param organizationDirectoryService
   *          the organizationDirectoryService to set
   */
  @Reference
  public void setOrganizationDirectoryService(OrganizationDirectoryService organizationDirectoryService) {
<span class="nc" id="L106">    this.organizationDirectoryService = organizationDirectoryService;</span>
<span class="nc" id="L107">  }</span>

  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="nc" id="L111">    this.securityService = securityService;</span>
<span class="nc" id="L112">  }</span>

  /**
   * Callback for activation of this component.
   *
   * @param cc
   *          the component context
   */
  @Activate
  public void activate(ComponentContext cc) throws Exception {
<span class="nc" id="L122">    logger.debug(&quot;Activate external group loader&quot;);</span>

<span class="nc" id="L124">    Dictionary properties = cc.getProperties();</span>
<span class="nc" id="L125">    boolean shouldCreateDefaultGroups = BooleanUtils.toBoolean(Objects.toString(properties.get(SHOULD_CREATE_DEFAULT_GROUPS_CONFIG_KEY), &quot;true&quot;));</span>

<span class="nc bnc" id="L127" title="All 2 branches missed.">    if (shouldCreateDefaultGroups) {</span>
<span class="nc" id="L128">      createDefaultGroups(cc);</span>
    } else {
<span class="nc" id="L130">      logger.info(&quot;Disabled generation of External Application group&quot;);</span>
    }
<span class="nc" id="L132">  }</span>

  /**
   * Creates initial groups for external applications per organization
   *
   * @throws IllegalStateException
   *           if a specified role or user list is unavailable
   */
  private void createDefaultGroups(ComponentContext cc) {
<span class="nc bnc" id="L141" title="All 2 branches missed.">    for (final Organization organization : organizationDirectoryService.getOrganizations()) {</span>
<span class="nc" id="L142">      SecurityUtil.runAs(securityService, organization, SecurityUtil.createSystemUser(cc, organization), () -&gt; {</span>
        try {
<span class="nc" id="L144">          Organization testOrg = organizationDirectoryService.getOrganization(organization.getId());</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">          if (!(testOrg instanceof JpaOrganization)) {</span>
<span class="nc" id="L146">            logger.info(&quot;Note: Ignoring organization with id &quot; + testOrg.getId() + &quot; because it is not a JpaOrganization&quot;);</span>
<span class="nc" id="L147">            return;</span>
          }
<span class="nc" id="L149">          JpaOrganization org = (JpaOrganization) testOrg;</span>

          // External Applications
<span class="nc" id="L152">          String externalApplicationsGroupId = org.getId().toUpperCase().concat(EXTERNAL_GROUP_SUFFIX);</span>
<span class="nc" id="L153">          JpaGroup externalApplicationGroup = groupRoleProvider.loadGroup(externalApplicationsGroupId,</span>
<span class="nc" id="L154">                  org.getId());</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">          if (externalApplicationGroup == null) {</span>
<span class="nc" id="L156">            String externalApplicationsGroupname = org.getName().concat(&quot; External Applications&quot;);</span>
<span class="nc" id="L157">            String externalApplicationsGroupDescription = &quot;External application users of '&quot; + org.getName() + &quot;'&quot;;</span>
<span class="nc" id="L158">            Set&lt;JpaRole&gt; roles = new HashSet&lt;JpaRole&gt;();</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">            for (String role : loadRoles(EXTERNAL_APPLICATIONS_ROLES_FILE)) {</span>
<span class="nc" id="L160">              roles.add(new JpaRole(role, org));</span>
<span class="nc" id="L161">            }</span>
<span class="nc" id="L162">            roles.add(new JpaRole(SecurityConstants.GLOBAL_SUDO_ROLE, org));</span>
<span class="nc" id="L163">            externalApplicationGroup = new JpaGroup(externalApplicationsGroupId, org, externalApplicationsGroupname,</span>
                    externalApplicationsGroupDescription, roles, new HashSet&lt;String&gt;());
<span class="nc" id="L165">            groupRoleProvider.addGroup(externalApplicationGroup);</span>
          }
<span class="nc" id="L167">        } catch (NotFoundException | IllegalStateException | IOException | UnauthorizedException e) {</span>
<span class="nc" id="L168">          logger.error(&quot;Unable to load external API groups&quot;, e);</span>
<span class="nc" id="L169">        }</span>
<span class="nc" id="L170">      });</span>
<span class="nc" id="L171">    }</span>
<span class="nc" id="L172">  }</span>

  /**
   * Loads the set of roles from the properties file.
   *
   * @param roleFileName
   *          name of the properties file containing the roles
   * @return the set of roles
   */
  private Set&lt;String&gt; loadRoles(String roleFileName) throws IllegalStateException, IOException {
<span class="nc" id="L182">    String propertiesFile = UrlSupport.concat(ROLES_PATH_PREFIX, roleFileName);</span>

      // Load the properties
<span class="nc" id="L185">    try (InputStream rolesIS = getClass().getResourceAsStream(propertiesFile)) {</span>
<span class="nc" id="L186">      return new TreeSet&lt;&gt;(IOUtils.readLines(rolesIS, UTF_8));</span>
<span class="nc" id="L187">    } catch (IOException e) {</span>
<span class="nc" id="L188">      logger.error(&quot;Error loading roles from file {}&quot;, propertiesFile);</span>
<span class="nc" id="L189">      throw e;</span>
    }

  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>