<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>QueryUtils.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-external-api</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.external.util.statistics</a> &gt; <span class="el_source">QueryUtils.java</span></div><h1>QueryUtils.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.external.util.statistics;

import org.opencastproject.statistics.api.DataResolution;
import org.opencastproject.statistics.api.StatisticsProvider;
import org.opencastproject.statistics.api.StatisticsService;
import org.opencastproject.statistics.api.TimeSeries;
import org.opencastproject.statistics.api.TimeSeriesProvider;
import org.opencastproject.statistics.export.api.DetailLevel;

import org.apache.commons.lang3.StringUtils;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;

import java.time.Instant;
import java.time.ZoneId;
import java.time.format.DateTimeParseException;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

public final class QueryUtils {

  private QueryUtils() {
  }

  public static class Query {
    private StatisticsProvider provider;
    private Parameters parameters;

<span class="nc" id="L52">    Query(StatisticsProvider provider, Parameters parameters) {</span>
<span class="nc" id="L53">      this.provider = provider;</span>
<span class="nc" id="L54">      this.parameters = parameters;</span>
<span class="nc" id="L55">    }</span>

    public StatisticsProvider getProvider() {
<span class="nc" id="L58">      return provider;</span>
    }

    public Parameters getParameters() {
<span class="nc" id="L62">      return parameters;</span>
    }
  }

  public static class QueryResult {
    private Query query;
    protected JSONObject data;

<span class="nc" id="L70">    QueryResult(Query query) {</span>
<span class="nc" id="L71">      this.query = query;</span>
<span class="nc" id="L72">      this.data = new JSONObject();</span>
<span class="nc" id="L73">    }</span>

    public JSONObject getData() {
<span class="nc" id="L76">      return data;</span>
    }

    public JSONObject get() {
<span class="nc" id="L80">      JSONObject result = new JSONObject();</span>
      // Add provider information
<span class="nc" id="L82">      JSONObject providerObj = new JSONObject();</span>
<span class="nc" id="L83">      providerObj.put(&quot;identifier&quot;, query.getProvider().getId());</span>
<span class="nc" id="L84">      providerObj.put(&quot;type&quot;, StatisticsProviderUtils.typeOf(query.getProvider()));</span>
<span class="nc" id="L85">      providerObj.put(&quot;resourceType&quot;, ResourceTypeUtils.toString(query.getProvider().getResourceType()));</span>
<span class="nc" id="L86">      result.put(&quot;provider&quot;, providerObj);</span>

      // Add parameter information
<span class="nc" id="L89">      result.put(&quot;parameters&quot;, query.getParameters().get());</span>

      // Add query result data
<span class="nc" id="L92">      result.put(&quot;data&quot;, getData());</span>
<span class="nc" id="L93">      return result;</span>
    }
  }

  public static class QueryResultTimeSeries extends QueryResult {

    QueryResultTimeSeries(Query query, TimeSeries timeseries) {
<span class="nc" id="L100">      super(query);</span>
<span class="nc" id="L101">      data.put(&quot;labels&quot;, timeseries.getLabels());</span>
<span class="nc" id="L102">      data.put(&quot;values&quot;, timeseries.getValues());</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">      if (timeseries.getTotal().isPresent()) {</span>
<span class="nc" id="L104">        data.put(&quot;total&quot;, timeseries.getTotal().getAsDouble());</span>
      }
<span class="nc" id="L106">    }</span>
  }

  public static class Parameters {

    private String resourceId;
    private JSONObject raw;

<span class="nc" id="L114">    Parameters(String resourceId, JSONObject raw) {</span>
<span class="nc" id="L115">      this.resourceId = resourceId;</span>
<span class="nc" id="L116">      this.raw = raw;</span>
<span class="nc" id="L117">    }</span>

    public String getResourceId() {
<span class="nc" id="L120">      return resourceId;</span>
    }

    public JSONObject get() {
<span class="nc" id="L124">      return raw;</span>
    }

<span class="nc" id="L127">    void validate() { }</span>
  }

   public static class TimeSeriesParameters extends Parameters {

    private Instant from;
    private Instant to;
    private DataResolution dataResolution;

    TimeSeriesParameters(String resourceId, JSONObject raw) {
<span class="nc" id="L137">      super(resourceId, raw);</span>
<span class="nc" id="L138">    }</span>

    public Instant getFrom() {
<span class="nc" id="L141">      return from;</span>
    }

    void setFrom(String from) {
      try {
<span class="nc" id="L146">        this.from = Instant.parse(from);</span>
<span class="nc" id="L147">      } catch (DateTimeParseException e) {</span>
<span class="nc" id="L148">        throw new IllegalArgumentException(&quot;Parameter 'from' not in ISO 8601 UTC format&quot;);</span>
<span class="nc" id="L149">      }</span>
<span class="nc" id="L150">    }</span>

    public Instant getTo() {
<span class="nc" id="L153">      return to;</span>
    }

    void setTo(String to) {
      try {
<span class="nc" id="L158">        this.to = Instant.parse(to);</span>
<span class="nc" id="L159">      } catch (DateTimeParseException e) {</span>
<span class="nc" id="L160">        throw new IllegalArgumentException(&quot;Parameter 'to' not in ISO 8601 UTC format&quot;);</span>
<span class="nc" id="L161">      }</span>
<span class="nc" id="L162">    }</span>

    public DataResolution getDataResolution() {
<span class="nc" id="L165">      return dataResolution;</span>
    }

    void setDataResolution(String dataResolution) {
<span class="nc" id="L169">      Optional&lt;DataResolution&gt; resolution = DataResolutionUtils.fromString(dataResolution);</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">      if (!resolution.isPresent()) {</span>
<span class="nc" id="L171">        throw new IllegalArgumentException(&quot;Illegal value for 'resolution'&quot;);</span>
      }
<span class="nc" id="L173">      this.dataResolution = resolution.get();</span>
<span class="nc" id="L174">    }</span>

    void validate() {
<span class="nc" id="L177">      super.validate();</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">      if (this.to.compareTo(this.from) &lt;= 0) {</span>
<span class="nc" id="L179">        throw new IllegalArgumentException(&quot;'from' date must be before 'to' date&quot;);</span>
      }
<span class="nc" id="L181">    }</span>
  }

  public static class ExportParameters extends TimeSeriesParameters {

    private DetailLevel detailLevel;

    ExportParameters(String resourceId, JSONObject raw) {
<span class="nc" id="L189">      super(resourceId, raw);</span>
<span class="nc" id="L190">    }</span>

    void setDetailLevel(String detailLevel) {
<span class="nc" id="L193">      Optional&lt;DetailLevel&gt; level = DetailLevelUtils.fromString(detailLevel);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">      if (!level.isPresent()) {</span>
<span class="nc" id="L195">        throw new IllegalArgumentException(&quot;Illegal value for 'detailLevel'&quot;);</span>
      }
<span class="nc" id="L197">      this.detailLevel = level.get();</span>
<span class="nc" id="L198">    }</span>

    public DetailLevel getDetailLevel() {
<span class="nc" id="L201">      return this.detailLevel;</span>
    }
  }

  public static List&lt;Query&gt; parse(String queryString, StatisticsService statisticsService) {

<span class="nc bnc" id="L207" title="All 2 branches missed.">    if (StringUtils.isBlank(queryString)) {</span>
<span class="nc" id="L208">      throw new IllegalArgumentException(&quot;No query data provided&quot;);</span>
    }

<span class="nc" id="L211">    JSONParser parser = new JSONParser();</span>
    JSONArray queriesJson;
    try {
<span class="nc" id="L214">      queriesJson = (JSONArray) parser.parse(queryString);</span>
<span class="nc" id="L215">    } catch (ParseException e) {</span>
<span class="nc" id="L216">      throw new IllegalArgumentException(&quot;JSON malformed&quot;);</span>
<span class="nc" id="L217">    }</span>

<span class="nc" id="L219">    List&lt;Query&gt; queries = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L221">    queriesJson.forEach(item -&gt; {</span>
<span class="nc" id="L222">        Query query = parseQuery((JSONObject) item, statisticsService);</span>
<span class="nc" id="L223">        queries.add(query);</span>
<span class="nc" id="L224">    });</span>

<span class="nc" id="L226">    return queries;</span>
  }

  public static Query parseQuery(String queryString, StatisticsService statisticsService) {
<span class="nc bnc" id="L230" title="All 2 branches missed.">    if (StringUtils.isBlank(queryString)) {</span>
<span class="nc" id="L231">      throw new IllegalArgumentException(&quot;No query data provided&quot;);</span>
    }

<span class="nc" id="L234">    JSONParser parser = new JSONParser();</span>
    JSONObject queryJson;
    try {
<span class="nc" id="L237">      queryJson = (JSONObject) parser.parse(queryString);</span>
<span class="nc" id="L238">    } catch (ParseException e) {</span>
<span class="nc" id="L239">      throw new IllegalArgumentException(&quot;JSON malformed&quot;);</span>
<span class="nc" id="L240">    }</span>
<span class="nc" id="L241">    return parseQuery(queryJson, statisticsService);</span>

  }

  private static Query parseQuery(JSONObject queryJson, StatisticsService statisticsService) {

    // Get the mandatory provider identifier
<span class="nc" id="L248">    JSONObject providerJson = (JSONObject) queryJson.get(&quot;provider&quot;);</span>
<span class="nc" id="L249">    String providerId = getField(providerJson, &quot;identifier&quot;, &quot;Identifier of provider is missing&quot;);</span>

<span class="nc" id="L251">    Optional&lt;StatisticsProvider&gt; provider = statisticsService.getProvider(providerId);</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">    if (!provider.isPresent()) {</span>
<span class="nc" id="L253">      throw new IllegalArgumentException(&quot;Provider not found&quot;);</span>
    }

    // Get the query parameters
<span class="nc" id="L257">    JSONObject parametersJson = (JSONObject) queryJson.get(&quot;parameters&quot;);</span>
<span class="nc" id="L258">    Parameters parameters = parseParameters(parametersJson, provider.get());</span>

<span class="nc" id="L260">    return new Query(provider.get(), parameters);</span>
  }

  public static Parameters parseParameters(JSONObject parametersJson, StatisticsProvider provider) {

    Parameters result;

<span class="nc" id="L267">    String resourceId = getField(parametersJson, &quot;resourceId&quot;, &quot;Parameter 'resourceId' is missing&quot;);</span>

    // The other parameters are specific to statistics provider implementations
<span class="nc bnc" id="L270" title="All 2 branches missed.">    if (provider instanceof TimeSeriesProvider) {</span>
      TimeSeriesParameters p;
<span class="nc bnc" id="L272" title="All 2 branches missed.">      if (parametersJson.containsKey(&quot;detailLevel&quot;)) {</span>
<span class="nc" id="L273">        p = new ExportParameters(resourceId, parametersJson);</span>
<span class="nc" id="L274">        ((ExportParameters)p).setDetailLevel(getField(parametersJson, &quot;detailLevel&quot;, &quot;Parameter 'detailLevel' is misisng&quot;));</span>
      } else {
<span class="nc" id="L276">        p = new TimeSeriesParameters(resourceId, parametersJson);</span>
      }
<span class="nc" id="L278">      p.setFrom(getField(parametersJson, &quot;from&quot;, &quot;Parameter 'from' is missing&quot;));</span>
<span class="nc" id="L279">      p.setTo(getField(parametersJson, &quot;to&quot;, &quot;Parameter 'to' is missing&quot;));</span>
<span class="nc" id="L280">      p.setDataResolution(getField(parametersJson, &quot;dataResolution&quot;, &quot;Parameter 'dataResolution' is missing&quot;));</span>
<span class="nc" id="L281">      result = p;</span>
<span class="nc" id="L282">    } else {</span>
<span class="nc" id="L283">      result = new Parameters(resourceId, parametersJson);</span>
      // Currently, we don't support other parameter types
    }
<span class="nc" id="L286">    result.validate();</span>
<span class="nc" id="L287">    return result;</span>
  }

  private static String getField(JSONObject object, String field, String exceptionMessage) {
    String value;
    try {
<span class="nc" id="L293">      value = (String) object.get(field);</span>
<span class="nc" id="L294">    } catch (Exception e) {</span>
<span class="nc" id="L295">      throw new IllegalArgumentException(exceptionMessage);</span>
<span class="nc" id="L296">    }</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">    if (StringUtils.isBlank(value)) {</span>
<span class="nc" id="L298">      throw new IllegalArgumentException(exceptionMessage);</span>
    }
<span class="nc" id="L300">    return value;</span>
  }

  public static JSONObject execute(Query query) {
    QueryResult result;
<span class="nc" id="L305">    StatisticsProvider provider = query.getProvider();</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">    if (provider instanceof TimeSeriesProvider) {</span>
<span class="nc" id="L307">      TimeSeriesParameters p = (TimeSeriesParameters) query.getParameters();</span>
<span class="nc" id="L308">      TimeSeriesProvider tsp = (TimeSeriesProvider) provider;</span>
<span class="nc" id="L309">      TimeSeries timeseries = tsp.getValues(p.getResourceId(), p.getFrom(), p.getTo(), p.getDataResolution(),</span>
<span class="nc" id="L310">          ZoneId.systemDefault());</span>
<span class="nc" id="L311">      result = new QueryResultTimeSeries(query, timeseries);</span>
<span class="nc" id="L312">    } else {</span>
<span class="nc" id="L313">      result = new QueryResult(query);</span>
    }
<span class="nc" id="L315">    return result.get();</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>