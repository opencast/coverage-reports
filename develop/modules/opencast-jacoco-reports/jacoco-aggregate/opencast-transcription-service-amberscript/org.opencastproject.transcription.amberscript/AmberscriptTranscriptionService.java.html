<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AmberscriptTranscriptionService.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Opencast :: jacoco-reports</a> &gt; <a href="../index.html" class="el_bundle">opencast-transcription-service-amberscript</a> &gt; <a href="index.source.html" class="el_package">org.opencastproject.transcription.amberscript</a> &gt; <span class="el_source">AmberscriptTranscriptionService.java</span></div><h1>AmberscriptTranscriptionService.java</h1><pre class="source lang-java linenums">/*
 * Licensed to The Apereo Foundation under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 *
 * The Apereo Foundation licenses this file to you under the Educational
 * Community License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License
 * at:
 *
 *   http://opensource.org/licenses/ecl2.txt
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 */
package org.opencastproject.transcription.amberscript;

import org.opencastproject.assetmanager.api.AssetManager;
import org.opencastproject.assetmanager.api.Snapshot;
import org.opencastproject.assetmanager.util.Workflows;
import org.opencastproject.job.api.AbstractJobProducer;
import org.opencastproject.job.api.Job;
import org.opencastproject.mediapackage.Catalog;
import org.opencastproject.mediapackage.MediaPackageElement;
import org.opencastproject.mediapackage.MediaPackageElementBuilder;
import org.opencastproject.mediapackage.MediaPackageElementBuilderFactory;
import org.opencastproject.mediapackage.MediaPackageElementFlavor;
import org.opencastproject.mediapackage.MediaPackageElementParser;
import org.opencastproject.mediapackage.MediaPackageElements;
import org.opencastproject.mediapackage.MediaPackageException;
import org.opencastproject.mediapackage.Track;
import org.opencastproject.metadata.dublincore.DublinCore;
import org.opencastproject.metadata.dublincore.DublinCoreCatalog;
import org.opencastproject.metadata.dublincore.DublinCoreValue;
import org.opencastproject.metadata.dublincore.DublinCores;
import org.opencastproject.security.api.DefaultOrganization;
import org.opencastproject.security.api.Organization;
import org.opencastproject.security.api.OrganizationDirectoryService;
import org.opencastproject.security.api.SecurityService;
import org.opencastproject.security.api.UserDirectoryService;
import org.opencastproject.security.util.SecurityUtil;
import org.opencastproject.serviceregistry.api.ServiceRegistry;
import org.opencastproject.serviceregistry.api.ServiceRegistryException;
import org.opencastproject.systems.OpencastConstants;
import org.opencastproject.transcription.api.TranscriptionService;
import org.opencastproject.transcription.api.TranscriptionServiceException;
import org.opencastproject.transcription.persistence.TranscriptionDatabase;
import org.opencastproject.transcription.persistence.TranscriptionDatabaseException;
import org.opencastproject.transcription.persistence.TranscriptionJobControl;
import org.opencastproject.transcription.persistence.TranscriptionProviderControl;
import org.opencastproject.util.NotFoundException;
import org.opencastproject.util.OsgiUtil;
import org.opencastproject.util.data.Option;
import org.opencastproject.workflow.api.ConfiguredWorkflow;
import org.opencastproject.workflow.api.WorkflowDefinition;
import org.opencastproject.workflow.api.WorkflowInstance;
import org.opencastproject.workflow.api.WorkflowService;
import org.opencastproject.workingfilerepository.api.WorkingFileRepository;
import org.opencastproject.workspace.api.Workspace;

import org.apache.commons.lang3.StringUtils;
import org.apache.http.HttpEntity;
import org.apache.http.HttpStatus;
import org.apache.http.client.config.RequestConfig;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.ContentType;
import org.apache.http.entity.mime.HttpMultipartMode;
import org.apache.http.entity.mime.MultipartEntityBuilder;
import org.apache.http.entity.mime.content.FileBody;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClientBuilder;
import org.apache.http.util.EntityUtils;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Deactivate;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.io.InputStream;
import java.net.URI;
import java.util.Arrays;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;

@Component(
    immediate = true,
    service = { TranscriptionService.class,AmberscriptTranscriptionService.class },
    property = {
        &quot;service.description=AmberScript Transcription Service&quot;,
        &quot;provider=amberscript&quot;
    }
)
public class AmberscriptTranscriptionService extends AbstractJobProducer implements TranscriptionService {

<span class="nc" id="L116">  private static final Logger logger = LoggerFactory.getLogger(AmberscriptTranscriptionService.class);</span>

  private static final String JOB_TYPE = &quot;org.opencastproject.transcription.amberscript&quot;;

  public static final String SUBMISSION_COLLECTION = &quot;amberscript-submission&quot;;
  private static final String TRANSCRIPT_COLLECTION = &quot;amberscript-transcripts&quot;;

  private static final int CONNECTION_TIMEOUT = 60000; // ms, 1 minute
  private static final int SOCKET_TIMEOUT = 60000; // ms, 1 minute



  private static final String BASE_URL = &quot;https://qs.amberscript.com&quot;;
  private static final String STATUS_OPEN = &quot;OPEN&quot;;
  private static final String STATUS_DONE = &quot;DONE&quot;;
  private static final String STATUS_ERROR = &quot;ERROR&quot;;

  private static final String ERROR_NO_SPEECH = &quot;No speech found&quot;;

  private static final String PROVIDER = &quot;amberscript&quot;;

  private AssetManager assetManager;
  private OrganizationDirectoryService organizationDirectoryService;
  private ScheduledExecutorService scheduledExecutor;
  private SecurityService securityService;
  private ServiceRegistry serviceRegistry;
  private TranscriptionDatabase database;
  private UserDirectoryService userDirectoryService;
  private WorkflowService workflowService;
  private WorkingFileRepository wfr;
  private Workspace workspace;

  // Only used by unit tests
  private Workflows wfUtil;

<span class="nc" id="L151">  private enum Operation {</span>
<span class="nc" id="L152">    StartTranscription</span>
  }

  // Enum for configuring which metadata field shall be used
  // for determining the number of speakers of an event
<span class="nc" id="L157">  private enum SpeakerMetadataField {</span>
<span class="nc" id="L158">    creator, contributor, both</span>
  }

  // service configuration keys
  private static final String ENABLED_CONFIG = &quot;enabled&quot;;
  private static final String CLIENT_KEY = &quot;client.key&quot;;
  private static final String LANGUAGE = &quot;language&quot;;
  private static final String LANGUAGE_FROM_DUBLINCORE = &quot;language.from.dublincore&quot;;
  private static final String LANGUAGE_CODE_MAP = &quot;language.code.map&quot;;
  private static final String AMBERSCRIPTJOBTYPE = &quot;jobtype&quot;;
  private static final String WORKFLOW_CONFIG = &quot;workflow&quot;;
  private static final String DISPATCH_WORKFLOW_INTERVAL_CONFIG = &quot;workflow.dispatch.interval&quot;;
  private static final String MAX_PROCESSING_TIME_CONFIG = &quot;max.overdue.time&quot;;
  private static final String CLEANUP_RESULTS_DAYS_CONFIG = &quot;cleanup.results.days&quot;;
  private static final String SPEAKER = &quot;speaker&quot;;
  private static final String SPEAKER_FROM_DUBLINCORE = &quot;speaker.from.dublincore&quot;;
  private static final String SPEAKER_METADATA_FIELD = &quot;speaker.metadata.field&quot;;
  private static final String TRANSCRIPTIONTYPE = &quot;transcriptiontype&quot;;
  private static final String GLOSSARY = &quot;glossary&quot;;
  private static final String TRANSCRIPTIONSTYLE = &quot;cleanread&quot;;
  private static final String TARGETLANGUAGE = &quot;targetlanguage&quot;;

  // service configuration default values
<span class="nc" id="L181">  private boolean enabled = false;</span>
  private String clientKey;
<span class="nc" id="L183">  private String language = &quot;en&quot;;</span>
  /** determines if the transcription language should be taken from the dublincore */
  private boolean languageFromDublinCore;
<span class="nc" id="L186">  private String amberscriptJobType = &quot;direct&quot;;</span>
<span class="nc" id="L187">  private String workflowDefinitionId = &quot;amberscript-attach-transcripts&quot;;</span>
<span class="nc" id="L188">  private long workflowDispatchIntervalSeconds = 60;</span>
<span class="nc" id="L189">  private long maxProcessingSeconds = 8 * 24 * 60 * 60; // maximum runtime for jobType perfect is 8 days</span>
<span class="nc" id="L190">  private int cleanupResultDays = 7;</span>
<span class="nc" id="L191">  private int numberOfSpeakers = 1;</span>
<span class="nc" id="L192">  private boolean speakerFromDublinCore = true;</span>
<span class="nc" id="L193">  private SpeakerMetadataField speakerMetadataField = SpeakerMetadataField.creator;</span>
<span class="nc" id="L194">  private String transcriptionType = &quot;transcription&quot;;</span>
<span class="nc" id="L195">  private String glossary = &quot;&quot;;</span>
<span class="nc" id="L196">  private String transcriptionStyle = &quot;cleanread&quot;;</span>
<span class="nc" id="L197">  private String targetLanguage = &quot;&quot;;</span>

  /**
   * Contains mappings from several possible ways of writing a language name/code to the
   * corresponding amberscript language code
   */
  private AmberscriptLangUtil amberscriptLangUtil;

  private String systemAccount;

  public AmberscriptTranscriptionService() {
<span class="nc" id="L208">    super(JOB_TYPE);</span>
<span class="nc" id="L209">  }</span>

  @Activate
  public void activate(ComponentContext cc) {

<span class="nc" id="L214">    Option&lt;Boolean&gt; enabledOpt = OsgiUtil.getOptCfgAsBoolean(cc.getProperties(), ENABLED_CONFIG);</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">    if (enabledOpt.isSome()) {</span>
<span class="nc" id="L216">      enabled = enabledOpt.get();</span>
    }

<span class="nc bnc" id="L219" title="All 2 branches missed.">    if (!enabled) {</span>
<span class="nc" id="L220">      logger.info(&quot;Amberscript Transcription Service disabled.&quot;</span>
              + &quot; If you want to enable it, please update the service configuration.&quot;);
<span class="nc" id="L222">      return;</span>
    }

<span class="nc" id="L225">    Option&lt;String&gt; clientKeyOpt = OsgiUtil.getOptCfg(cc.getProperties(), CLIENT_KEY);</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">    if (clientKeyOpt.isSome()) {</span>
<span class="nc" id="L227">      clientKey = clientKeyOpt.get();</span>
    } else {
<span class="nc" id="L229">      logger.warn(&quot;API key was not set.&quot;);</span>
<span class="nc" id="L230">      return;</span>
    }

<span class="nc" id="L233">    Option&lt;String&gt; languageOpt = OsgiUtil.getOptCfg(cc.getProperties(), LANGUAGE);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">    if (languageOpt.isSome()) {</span>
<span class="nc" id="L235">      language = languageOpt.get();</span>
<span class="nc" id="L236">      logger.info(&quot;Default language is set to '{}'.&quot;, language);</span>
    } else {
<span class="nc" id="L238">      logger.info(&quot;Default language '{}' will be used.&quot;, language);</span>
    }

<span class="nc" id="L241">    Option&lt;String&gt; languageFromDublinCoreOpt = OsgiUtil.getOptCfg(cc.getProperties(), LANGUAGE_FROM_DUBLINCORE);</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">    if (languageFromDublinCoreOpt.isSome()) {</span>
      try {
<span class="nc" id="L244">        languageFromDublinCore = Boolean.parseBoolean(languageFromDublinCoreOpt.get());</span>
<span class="nc" id="L245">      } catch (Exception e) {</span>
<span class="nc" id="L246">        logger.warn(&quot;Configuration value for '{}' is invalid, defaulting to false.&quot;, LANGUAGE_FROM_DUBLINCORE);</span>
<span class="nc" id="L247">      }</span>
    }
<span class="nc" id="L249">    logger.info(&quot;Configuration value for '{}' is set to '{}'.&quot;, LANGUAGE_FROM_DUBLINCORE, languageFromDublinCore);</span>

<span class="nc" id="L251">    amberscriptLangUtil = AmberscriptLangUtil.getInstance();</span>
<span class="nc" id="L252">    int customMapEntriesCount = 0;</span>
<span class="nc" id="L253">    Option&lt;String&gt; langCodeMapOpt = OsgiUtil.getOptCfg(cc.getProperties(), LANGUAGE_CODE_MAP);</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">    if (langCodeMapOpt.isSome()) {</span>
      try {
<span class="nc" id="L256">        String langCodeMapStr = langCodeMapOpt.get();</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (langCodeMapStr != null) {</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">          for (String mapping : langCodeMapStr.split(&quot;,&quot;)) {</span>
<span class="nc" id="L259">            String[] mapEntries = mapping.split(&quot;:&quot;);</span>
<span class="nc" id="L260">            amberscriptLangUtil.addCustomMapping(mapEntries[0], mapEntries[1]);</span>
<span class="nc" id="L261">            customMapEntriesCount += 1;</span>
          }
        }
<span class="nc" id="L264">      } catch (Exception e) {</span>
<span class="nc" id="L265">        logger.warn(&quot;Configuration '{}' is invalid. Using just default mapping.&quot;, LANGUAGE_CODE_MAP);</span>
<span class="nc" id="L266">      }</span>
    }
<span class="nc" id="L268">    logger.info(&quot;Language code map was set. Added '{}' additional entries.&quot;, customMapEntriesCount);</span>

<span class="nc" id="L270">    Option&lt;String&gt; amberscriptJobTypeOpt = OsgiUtil.getOptCfg(cc.getProperties(), AMBERSCRIPTJOBTYPE);</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">    if (amberscriptJobTypeOpt.isSome()) {</span>
<span class="nc" id="L272">      amberscriptJobType = amberscriptJobTypeOpt.get();</span>
<span class="nc" id="L273">      logger.info(&quot;Default Amberscript job type is set to '{}'.&quot;, amberscriptJobType);</span>
    } else {
<span class="nc" id="L275">      logger.info(&quot;Default Amberscript job type '{}' will be used.&quot;, amberscriptJobType);</span>
    }

<span class="nc" id="L278">    Option&lt;String&gt; wfOpt = OsgiUtil.getOptCfg(cc.getProperties(), WORKFLOW_CONFIG);</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">    if (wfOpt.isSome()) {</span>
<span class="nc" id="L280">      workflowDefinitionId = wfOpt.get();</span>
<span class="nc" id="L281">      logger.info(&quot;Workflow is set to '{}'.&quot;, workflowDefinitionId);</span>
    } else {
<span class="nc" id="L283">      logger.info(&quot;Default workflow '{}' will be used.&quot;, workflowDefinitionId);</span>
    }

<span class="nc" id="L286">    Option&lt;String&gt; intervalOpt = OsgiUtil.getOptCfg(cc.getProperties(), DISPATCH_WORKFLOW_INTERVAL_CONFIG);</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">    if (intervalOpt.isSome()) {</span>
      try {
<span class="nc" id="L289">        workflowDispatchIntervalSeconds = Long.parseLong(intervalOpt.get());</span>
<span class="nc" id="L290">      } catch (NumberFormatException e) {</span>
<span class="nc" id="L291">        logger.warn(&quot;Configured '{}' is invalid. Using default.&quot;, DISPATCH_WORKFLOW_INTERVAL_CONFIG);</span>
<span class="nc" id="L292">      }</span>
    }
<span class="nc" id="L294">    logger.info(&quot;Workflow dispatch interval is {} seconds.&quot;, workflowDispatchIntervalSeconds);</span>

<span class="nc" id="L296">    Option&lt;String&gt; maxProcessingOpt = OsgiUtil.getOptCfg(cc.getProperties(), MAX_PROCESSING_TIME_CONFIG);</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">    if (maxProcessingOpt.isSome()) {</span>
      try {
<span class="nc" id="L299">        maxProcessingSeconds = Long.parseLong(maxProcessingOpt.get());</span>
<span class="nc" id="L300">      } catch (NumberFormatException e) {</span>
<span class="nc" id="L301">        logger.warn(&quot;Configured '{}' is invalid. Using default.&quot;, MAX_PROCESSING_TIME_CONFIG);</span>
<span class="nc" id="L302">      }</span>
    }
<span class="nc" id="L304">    logger.info(&quot;Maximum processing time for transcription job is {} seconds.&quot;, maxProcessingSeconds);</span>

<span class="nc" id="L306">    Option&lt;String&gt; cleanupOpt = OsgiUtil.getOptCfg(cc.getProperties(), CLEANUP_RESULTS_DAYS_CONFIG);</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">    if (cleanupOpt.isSome()) {</span>
      try {
<span class="nc" id="L309">        cleanupResultDays = Integer.parseInt(cleanupOpt.get());</span>
<span class="nc" id="L310">      } catch (NumberFormatException e) {</span>
<span class="nc" id="L311">        logger.warn(&quot;Configured '{}' is invalid. Using default.&quot;, CLEANUP_RESULTS_DAYS_CONFIG);</span>
<span class="nc" id="L312">      }</span>
    }
<span class="nc" id="L314">    logger.info(&quot;Cleanup result files after {} days.&quot;, cleanupResultDays);</span>

<span class="nc" id="L316">    Option&lt;String&gt; speakerOpt = OsgiUtil.getOptCfg(cc.getProperties(), SPEAKER);</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">    if (speakerOpt.isSome()) {</span>
      try {
<span class="nc" id="L319">        numberOfSpeakers = Integer.parseInt(speakerOpt.get());</span>
<span class="nc" id="L320">      } catch (NumberFormatException e) {</span>
<span class="nc" id="L321">        logger.warn(&quot;Configured '{}' is invalid. Using default.&quot;, SPEAKER);</span>
<span class="nc" id="L322">      }</span>
    }
<span class="nc" id="L324">    logger.info(&quot;Default number of speakers is set to '{}'.&quot;, numberOfSpeakers);</span>

<span class="nc" id="L326">    Option&lt;String&gt; speakerFromDublinCoreOpt = OsgiUtil.getOptCfg(cc.getProperties(), SPEAKER_FROM_DUBLINCORE);</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">    if (speakerFromDublinCoreOpt.isSome()) {</span>
      try {
<span class="nc" id="L329">        speakerFromDublinCore = Boolean.parseBoolean(speakerFromDublinCoreOpt.get());</span>
<span class="nc" id="L330">      } catch (Exception e) {</span>
<span class="nc" id="L331">        logger.warn(&quot;Configuration value for '{}' is invalid, defaulting to true.&quot;, SPEAKER_FROM_DUBLINCORE);</span>
<span class="nc" id="L332">      }</span>
    }
<span class="nc" id="L334">    logger.info(&quot;Configuration value for '{}' is set to '{}'.&quot;, SPEAKER_FROM_DUBLINCORE, speakerFromDublinCore);</span>

<span class="nc" id="L336">    Option&lt;String&gt; speakerMetadataFieldOpt = OsgiUtil.getOptCfg(cc.getProperties(), SPEAKER_METADATA_FIELD);</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">    if (speakerMetadataFieldOpt.isSome()) {</span>
      try {
<span class="nc" id="L339">        speakerMetadataField = SpeakerMetadataField.valueOf(speakerMetadataFieldOpt.get());</span>
<span class="nc" id="L340">      } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L341">        logger.warn(&quot;Value '{}' is invalid for configuration '{}'. Using default: '{}'.&quot;,</span>
<span class="nc" id="L342">            speakerMetadataFieldOpt.get(), SPEAKER_METADATA_FIELD, speakerMetadataField);</span>
<span class="nc" id="L343">      }</span>
    }
<span class="nc" id="L345">    logger.info(&quot;Default metadata field for calculating the amount of speakers is set to '{}'.&quot;, speakerMetadataField);</span>

<span class="nc" id="L347">    Option&lt;String&gt; transcriptionTypeOpt = OsgiUtil.getOptCfg(cc.getProperties(), TRANSCRIPTIONTYPE);</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">    if (transcriptionTypeOpt.isSome()) {</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">      if (List.of(&quot;transcription&quot;, &quot;captions&quot;, &quot;translatedSubtitles&quot;).contains(transcriptionType)) {</span>
<span class="nc" id="L350">        transcriptionType = transcriptionTypeOpt.get();</span>
<span class="nc" id="L351">        logger.info(&quot;Default transcription type is set to '{}'.&quot;, transcriptionType);</span>
      } else {
<span class="nc" id="L353">        logger.warn(&quot;Value '{}' is invalid for configuration '{}'. Using default: '{}'.&quot;,</span>
<span class="nc" id="L354">            transcriptionTypeOpt.get(), TRANSCRIPTIONTYPE, transcriptionType);</span>
      }
    } else {
<span class="nc" id="L357">      logger.info(&quot;Default transcription type '{}' will be used.&quot;, transcriptionType);</span>
    }

<span class="nc" id="L360">    Option&lt;String&gt; glossaryOpt = OsgiUtil.getOptCfg(cc.getProperties(), GLOSSARY);</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">    if (glossaryOpt.isSome()) {</span>
<span class="nc" id="L362">      glossary = glossaryOpt.get();</span>
<span class="nc" id="L363">      logger.info(&quot;Default glossary is set to '{}'.&quot;, glossary);</span>
    } else {
<span class="nc" id="L365">      logger.info(&quot;No glossary will be used by default&quot;);</span>
    }

<span class="nc" id="L368">    Option&lt;String&gt; transcriptionStyleOpt = OsgiUtil.getOptCfg(cc.getProperties(), TRANSCRIPTIONSTYLE);</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">    if (transcriptionStyleOpt.isSome()) {</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">      if (List.of(&quot;cleanread&quot;, &quot;verbatim&quot;).contains(transcriptionStyle)) {</span>
<span class="nc" id="L371">        transcriptionStyle = transcriptionStyleOpt.get();</span>
<span class="nc" id="L372">        logger.info(&quot;Default transcription style is set to '{}'.&quot;, transcriptionStyle);</span>
      } else {
<span class="nc" id="L374">        logger.warn(&quot;Value '{}' is invalid for configuration '{}'. Using default: '{}'.&quot;,</span>
<span class="nc" id="L375">            transcriptionStyleOpt.get(), TRANSCRIPTIONSTYLE, transcriptionStyle);</span>
      }
    } else {
<span class="nc" id="L378">      logger.info(&quot;Default transcription style '{}' will be used.&quot;, transcriptionStyle);</span>
    }

<span class="nc" id="L381">    Option&lt;String&gt; targetLanguageOpt = OsgiUtil.getOptCfg(cc.getProperties(), TARGETLANGUAGE);</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">    if (targetLanguageOpt.isSome()) {</span>
<span class="nc" id="L383">      targetLanguage = targetLanguageOpt.get();</span>
<span class="nc" id="L384">      logger.info(&quot;Default target language is set to '{}'.&quot;, targetLanguage);</span>
    } else {
<span class="nc" id="L386">      logger.info(&quot;Transcriptions won't be translated&quot;);</span>
    }

<span class="nc" id="L389">    systemAccount = OsgiUtil.getContextProperty(cc, OpencastConstants.DIGEST_USER_PROPERTY);</span>

<span class="nc" id="L391">    scheduledExecutor = Executors.newScheduledThreadPool(2);</span>

<span class="nc" id="L393">    scheduledExecutor.scheduleWithFixedDelay(new WorkflowDispatcher(), 120, workflowDispatchIntervalSeconds,</span>
            TimeUnit.SECONDS);

<span class="nc" id="L396">    scheduledExecutor.scheduleWithFixedDelay(new ResultsFileCleanup(), 1, 1, TimeUnit.DAYS);</span>

<span class="nc" id="L398">    logger.info(&quot;Activated.&quot;);</span>
<span class="nc" id="L399">  }</span>

  @Deactivate
  public void deactivate() {
<span class="nc bnc" id="L403" title="All 2 branches missed.">    if (scheduledExecutor != null) {</span>
<span class="nc" id="L404">      scheduledExecutor.shutdown();</span>
    }
<span class="nc" id="L406">  }</span>

  @Override
  public Job startTranscription(String mpId, Track track) throws TranscriptionServiceException {
<span class="nc" id="L410">    throw new UnsupportedOperationException(&quot;Not supported.&quot;);</span>
  }

  @Override
  public Job startTranscription(String mpId, Track track, String... args) throws TranscriptionServiceException {
<span class="nc bnc" id="L415" title="All 2 branches missed.">    if (!enabled) {</span>
<span class="nc" id="L416">      throw new TranscriptionServiceException(&quot;AmberScript Transcription Service disabled.&quot;</span>
              + &quot; If you want to enable it, please update the service configuration.&quot;);
    }

<span class="nc" id="L420">    String language = null;</span>

<span class="nc bnc" id="L422" title="All 2 branches missed.">    if (languageFromDublinCore) {</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">      for (Catalog catalog : track.getMediaPackage().getCatalogs(MediaPackageElements.EPISODE)) {</span>
<span class="nc" id="L424">        try (InputStream in = workspace.read(catalog.getURI())) {</span>
<span class="nc" id="L425">          DublinCoreCatalog dublinCatalog = DublinCores.read(in);</span>
<span class="nc" id="L426">          String dublinCoreLang = dublinCatalog.getFirst(DublinCore.PROPERTY_LANGUAGE);</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">          if (dublinCoreLang != null) {</span>
<span class="nc" id="L428">            language = amberscriptLangUtil.getLanguageCodeOrNull(dublinCoreLang);</span>
          }
<span class="nc bnc" id="L430" title="All 2 branches missed.">          if (language != null) {</span>
<span class="nc" id="L431">            break;</span>
          }
<span class="nc bnc" id="L433" title="All 2 branches missed.">        } catch (IOException | NotFoundException e) {</span>
<span class="nc" id="L434">          logger.error(String.format(&quot;Unable to load dublin core catalog for event '%s'&quot;,</span>
<span class="nc" id="L435">              track.getMediaPackage().getIdentifier()), e);</span>
<span class="nc" id="L436">        }</span>
      }
    }

<span class="nc bnc" id="L440" title="All 2 branches missed.">    if (language == null) {</span>
<span class="nc bnc" id="L441" title="All 4 branches missed.">      if (args.length &gt; 0 &amp;&amp; StringUtils.isNotBlank(args[0])) {</span>
<span class="nc" id="L442">        language = args[0];</span>
      } else {
<span class="nc" id="L444">        language = getLanguage();</span>
      }
    }

    String jobType;
<span class="nc bnc" id="L449" title="All 4 branches missed.">    if (args.length &gt; 1 &amp;&amp; StringUtils.isNotBlank(args[1])) {</span>
<span class="nc" id="L450">      jobType = args[1];</span>
    } else {
<span class="nc" id="L452">      jobType = getAmberscriptJobType();</span>
    }

<span class="nc" id="L455">    int numberOfSpeakers = 0;</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">    if (speakerFromDublinCore) {</span>
<span class="nc" id="L457">      Set&lt;String&gt; speakers = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">      for (Catalog catalog : track.getMediaPackage().getCatalogs(MediaPackageElements.EPISODE)) {</span>
<span class="nc" id="L459">        try (InputStream in = workspace.read(catalog.getURI())) {</span>
<span class="nc" id="L460">          DublinCoreCatalog dublinCatalog = DublinCores.read(in);</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">          if (speakerMetadataField.equals(SpeakerMetadataField.creator)</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">                  || speakerMetadataField.equals(SpeakerMetadataField.both)) {</span>
<span class="nc" id="L463">            dublinCatalog.get(DublinCore.PROPERTY_CREATOR).stream()</span>
<span class="nc" id="L464">                    .map(DublinCoreValue::getValue).forEach(speakers::add);</span>
          }
<span class="nc bnc" id="L466" title="All 2 branches missed.">          if (speakerMetadataField.equals(SpeakerMetadataField.contributor)</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">                  || speakerMetadataField.equals(SpeakerMetadataField.both)) {</span>
<span class="nc" id="L468">            dublinCatalog.get(DublinCore.PROPERTY_CONTRIBUTOR).stream()</span>
<span class="nc" id="L469">                    .map(DublinCoreValue::getValue).forEach(speakers::add);</span>
          }

<span class="nc" id="L472">        } catch (IOException | NotFoundException e) {</span>
<span class="nc" id="L473">          logger.error(&quot;Unable to load dublin core catalog for event '{}'&quot;,</span>
<span class="nc" id="L474">                  track.getMediaPackage().getIdentifier(), e);</span>
<span class="nc" id="L475">        }</span>
      }

<span class="nc bnc" id="L478" title="All 2 branches missed.">      if (speakers.size() &gt;= 1) {</span>
<span class="nc" id="L479">        numberOfSpeakers = speakers.size();</span>
      }
    }

<span class="nc bnc" id="L483" title="All 2 branches missed.">    if (numberOfSpeakers == 0) {</span>
<span class="nc bnc" id="L484" title="All 4 branches missed.">      if (args.length &gt; 2 &amp;&amp; StringUtils.isNotBlank(args[2])) {</span>
<span class="nc" id="L485">        numberOfSpeakers = Integer.parseInt(args[2]);</span>
      } else {
<span class="nc" id="L487">        numberOfSpeakers = getNumberOfSpeakers();</span>
      }
    }

    String transcriptionType;
<span class="nc bnc" id="L492" title="All 4 branches missed.">    if (args.length &gt; 3 &amp;&amp; StringUtils.isNotBlank(args[3])) {</span>
<span class="nc" id="L493">      transcriptionType = args[3];</span>
    } else {
<span class="nc" id="L495">      transcriptionType = getTranscriptionType();</span>
    }

    String glossary;
<span class="nc bnc" id="L499" title="All 4 branches missed.">    if (args.length &gt; 4 &amp;&amp; args[4] != null) {</span>
<span class="nc" id="L500">      glossary = args[4];</span>
    } else {
<span class="nc" id="L502">      glossary = getGlossary();</span>
    }

    String transcriptionStyle;
<span class="nc bnc" id="L506" title="All 4 branches missed.">    if (args.length &gt; 5 &amp;&amp; StringUtils.isNotBlank(args[5])) {</span>
<span class="nc" id="L507">      transcriptionStyle = args[5];</span>
    } else {
<span class="nc" id="L509">      transcriptionStyle = getTranscriptionStyle();</span>
    }

    String targetLanguage;
<span class="nc bnc" id="L513" title="All 4 branches missed.">    if (args.length &gt; 6 &amp;&amp; args[6] != null) {</span>
<span class="nc" id="L514">      targetLanguage = args[6];</span>
    } else {
<span class="nc" id="L516">      targetLanguage = getTargetLanguage();</span>
    }

<span class="nc" id="L519">    logger.info(&quot;New transcription job for mpId '{}' language '{}' job type '{}' speakers '{}' transcription type '{}'&quot;</span>
<span class="nc" id="L520">            + &quot;glossary '{}'.&quot;, mpId, language, jobType, numberOfSpeakers, transcriptionType, glossary);</span>

    try {
<span class="nc" id="L523">      return serviceRegistry.createJob(JOB_TYPE, Operation.StartTranscription.name(), Arrays.asList(</span>
<span class="nc" id="L524">          mpId, MediaPackageElementParser.getAsXml(track), language, jobType, Integer.toString(numberOfSpeakers),</span>
          transcriptionType, glossary, transcriptionStyle, targetLanguage));
<span class="nc" id="L526">    } catch (ServiceRegistryException e) {</span>
<span class="nc" id="L527">      throw new TranscriptionServiceException(&quot;Unable to create a job&quot;, e);</span>
<span class="nc" id="L528">    } catch (MediaPackageException e) {</span>
<span class="nc" id="L529">      throw new TranscriptionServiceException(&quot;Invalid track '&quot; + track.toString() + &quot;'&quot;, e);</span>
    }
  }

  @Override
<span class="nc" id="L534">  public void transcriptionDone(String mpId, Object results) { }</span>

  private void transcriptionDone(String mpId, String jobId) {
    try {
<span class="nc" id="L538">      logger.info(&quot;Transcription done for mpId '{}'.&quot;, mpId);</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">      if (getAndSaveJobResult(jobId)) {</span>
<span class="nc" id="L540">        database.updateJobControl(jobId, TranscriptionJobControl.Status.TranscriptionComplete.name());</span>
      } else {
<span class="nc" id="L542">        logger.debug(&quot;Unable to get and save the transcription result for mpId '{}'.&quot;, mpId);</span>
      }
<span class="nc" id="L544">    } catch (IOException | TranscriptionServiceException e) {</span>
<span class="nc" id="L545">      logger.warn(&quot;Could not save transcription results file for mpId '{}': {}&quot;, mpId, e.toString());</span>
<span class="nc" id="L546">    } catch (TranscriptionDatabaseException e) {</span>
<span class="nc" id="L547">      logger.warn(&quot;Transcription results file were saved but state in db not updated for mpId '{}': &quot;, mpId, e);</span>
<span class="nc" id="L548">    }</span>
<span class="nc" id="L549">  }</span>

  @Override
  public void transcriptionError(String mpId, Object obj) throws TranscriptionServiceException {
<span class="nc" id="L553">    JSONObject jsonObj = null;</span>
<span class="nc" id="L554">    String jobId = null;</span>
    try {
<span class="nc" id="L556">      jsonObj = (JSONObject) obj;</span>
<span class="nc" id="L557">      jobId = (String) jsonObj.get(&quot;name&quot;);</span>
      // Update state in database
<span class="nc" id="L559">      database.updateJobControl(jobId, TranscriptionJobControl.Status.Error.name());</span>
<span class="nc" id="L560">      TranscriptionJobControl jobControl = database.findByJob(jobId);</span>
<span class="nc" id="L561">      logger.warn(String.format(&quot;Error received for media package %s, job id %s&quot;,</span>
<span class="nc" id="L562">              jobControl.getMediaPackageId(), jobId));</span>
      // Send notification email
<span class="nc" id="L564">    } catch (TranscriptionDatabaseException e) {</span>
<span class="nc" id="L565">      logger.warn(&quot;Transcription error. State in db could not be updated to error for mpId {}, jobId {}&quot;, mpId, jobId);</span>
<span class="nc" id="L566">      throw new TranscriptionServiceException(&quot;Could not update transcription job control db&quot;, e);</span>
<span class="nc" id="L567">    }</span>
<span class="nc" id="L568">  }</span>

  @Override
  public Map&lt;String, Object&gt; getReturnValues(String mpId, String jobId) throws TranscriptionServiceException {
<span class="nc" id="L572">    throw new TranscriptionServiceException(&quot;Method not implemented&quot;);</span>
  }

  @Override
  public String getLanguage() {
<span class="nc" id="L577">    return language;</span>
  }

  public String getAmberscriptJobType() {
<span class="nc" id="L581">    return amberscriptJobType;</span>
  }

  public int getNumberOfSpeakers() {
<span class="nc" id="L585">    return numberOfSpeakers;</span>
  }

  public String getTranscriptionType() {
<span class="nc" id="L589">    return transcriptionType;</span>
  }

  public String getGlossary() {
<span class="nc" id="L593">    return glossary;</span>
  }

  public String getTranscriptionStyle() {
<span class="nc" id="L597">    return transcriptionStyle;</span>
  }

  public String getTargetLanguage() {
<span class="nc" id="L601">    return targetLanguage;</span>
  }

  // Called by workflow
  @Override
  protected String process(Job job) throws Exception {
<span class="nc" id="L607">    Operation op = null;</span>
<span class="nc" id="L608">    String operation = job.getOperation();</span>
<span class="nc" id="L609">    List&lt;String&gt; arguments = job.getArguments();</span>
<span class="nc" id="L610">    String result = &quot;&quot;;</span>
<span class="nc" id="L611">    op = Operation.valueOf(operation);</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">    switch (op) {</span>
      case StartTranscription:
<span class="nc" id="L614">        String mpId = arguments.get(0);</span>
<span class="nc" id="L615">        Track track = (Track) MediaPackageElementParser.getFromXml(arguments.get(1));</span>
<span class="nc" id="L616">        String languageCode = arguments.get(2);</span>
<span class="nc" id="L617">        String jobType = arguments.get(3);</span>
<span class="nc" id="L618">        String numberOfSpeakers = arguments.get(4);</span>
<span class="nc" id="L619">        String transcriptionType = arguments.get(5);</span>
<span class="nc" id="L620">        String glossary = arguments.get(6);</span>
<span class="nc" id="L621">        String transcriptionStyle = arguments.get(7);</span>
<span class="nc" id="L622">        String targetLanguage = arguments.get(8);</span>
<span class="nc" id="L623">        createRecognitionsJob(mpId, track, languageCode, jobType, numberOfSpeakers, transcriptionType, glossary,</span>
                transcriptionStyle, targetLanguage);
<span class="nc" id="L625">        break;</span>
      default:
<span class="nc" id="L627">        throw new IllegalStateException(&quot;Don't know how to handle operation '&quot; + operation + &quot;'&quot;);</span>
    }
<span class="nc" id="L629">    return result;</span>
  }

  void createRecognitionsJob(String mpId, Track track, String languageCode, String jobType, String numberOfSpeakers,
          String transcriptionType, String glossary, String transcriptionStyle, String targetLanguage)
          throws TranscriptionServiceException {
    // Timeout 3 hours (needs to include the time for the remote service to
    // fetch the media URL before sending final response)
<span class="nc" id="L637">    CloseableHttpClient httpClient = makeHttpClient(3 * 3600 * 1000);</span>
<span class="nc" id="L638">    CloseableHttpResponse response = null;</span>

<span class="nc" id="L640">    String submitUrl = BASE_URL + &quot;/jobs/upload-media&quot;</span>
            + &quot;?apiKey=&quot; + clientKey
            + &quot;&amp;language=&quot; + languageCode
            + &quot;&amp;jobType=&quot; + jobType
            + &quot;&amp;numberOfSpeakers=&quot; + numberOfSpeakers
            + &quot;&amp;transcriptionType=&quot; + transcriptionType
            + &quot;&amp;transcriptionStyle=&quot; + transcriptionStyle;
<span class="nc bnc" id="L647" title="All 2 branches missed.">    if (StringUtils.isNotBlank(glossary)) {</span>
<span class="nc" id="L648">      submitUrl += &quot;&amp;glossary=&quot; + glossary;</span>
    }
<span class="nc bnc" id="L650" title="All 2 branches missed.">    if (StringUtils.isNotBlank(targetLanguage)) {</span>
<span class="nc" id="L651">      submitUrl += &quot;&amp;targetLanguage=&quot; + targetLanguage;</span>
    }

    try {
<span class="nc" id="L655">      FileBody fileBody = new FileBody(workspace.get(track.getURI()), ContentType.DEFAULT_BINARY);</span>
<span class="nc" id="L656">      MultipartEntityBuilder builder = MultipartEntityBuilder.create();</span>
<span class="nc" id="L657">      builder.setMode(HttpMultipartMode.BROWSER_COMPATIBLE);</span>
<span class="nc" id="L658">      builder.addPart(&quot;file&quot;, fileBody);</span>
<span class="nc" id="L659">      HttpEntity multipartEntity = builder.build();</span>

<span class="nc" id="L661">      HttpPost httpPost = new HttpPost(submitUrl);</span>
<span class="nc" id="L662">      httpPost.setEntity(multipartEntity);</span>

<span class="nc" id="L664">      response = httpClient.execute(httpPost);</span>
<span class="nc" id="L665">      int code = response.getStatusLine().getStatusCode();</span>
<span class="nc" id="L666">      HttpEntity entity = response.getEntity();</span>

<span class="nc" id="L668">      String jsonString = EntityUtils.toString(response.getEntity());</span>
<span class="nc" id="L669">      JSONParser jsonParser = new JSONParser();</span>
<span class="nc" id="L670">      JSONObject jsonObject = (JSONObject) jsonParser.parse(jsonString);</span>

<span class="nc" id="L672">      logger.debug(&quot;Submitting new transcription job: {}&quot; + System.lineSeparator()</span>
<span class="nc" id="L673">              + &quot;Response: {}&quot;, removePrivateInfo(submitUrl), jsonString);</span>

<span class="nc" id="L675">      JSONObject result = (JSONObject) jsonObject.get(&quot;jobStatus&quot;);</span>
<span class="nc" id="L676">      String jobId = (String) result.get(&quot;jobId&quot;);</span>

<span class="nc bnc" id="L678" title="All 2 branches missed.">      switch (code) {</span>
        case HttpStatus.SC_OK: // 200
<span class="nc" id="L680">          logger.info(&quot;mp {} has been submitted to AmberScript service with jobId {}.&quot;, mpId, jobId);</span>
<span class="nc" id="L681">          database.storeJobControl(mpId, track.getIdentifier(), jobId, TranscriptionJobControl.Status.InProgress.name(),</span>
<span class="nc bnc" id="L682" title="All 2 branches missed.">                  track.getDuration() == null ? 0 : track.getDuration().longValue(), new Date(), PROVIDER);</span>
<span class="nc" id="L683">          EntityUtils.consume(entity);</span>
<span class="nc" id="L684">          return;</span>
        default:
<span class="nc" id="L686">          String error = (String) result.get(&quot;error&quot;);</span>
<span class="nc" id="L687">          String message = (String) result.get(&quot;message&quot;);</span>
<span class="nc" id="L688">          String msg = String.format(&quot;Unable to submit job: API returned %s - %s: %s&quot;, code, error, message);</span>
<span class="nc" id="L689">          logger.warn(msg);</span>
<span class="nc" id="L690">          throw new TranscriptionServiceException(msg);</span>
      }
<span class="nc" id="L692">    } catch (Exception e) {</span>
<span class="nc" id="L693">      logger.warn(&quot;Exception when calling the captions endpoint&quot;, e);</span>
<span class="nc" id="L694">      throw new TranscriptionServiceException(&quot;Exception when calling the captions endpoint&quot;, e);</span>
    } finally {
      try {
<span class="nc" id="L697">        httpClient.close();</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">        if (response != null) {</span>
<span class="nc" id="L699">          response.close();</span>
        }
<span class="nc" id="L701">      } catch (IOException e) {</span>
<span class="nc" id="L702">      }</span>
    }
  }

  boolean checkJobResults(String jobId) throws TranscriptionServiceException {

<span class="nc" id="L708">    String mpId = &quot;unknown&quot;;</span>

<span class="nc" id="L710">    CloseableHttpClient httpClient = makeHttpClient();</span>
<span class="nc" id="L711">    CloseableHttpResponse response = null;</span>

<span class="nc" id="L713">    String checkUrl = BASE_URL + &quot;/jobs/status?jobId=&quot; + jobId + &quot;&amp;apiKey=&quot; + clientKey;</span>

    try {
<span class="nc" id="L716">      HttpGet httpGet = new HttpGet(checkUrl);</span>
<span class="nc" id="L717">      response = httpClient.execute(httpGet);</span>
<span class="nc" id="L718">      int code = response.getStatusLine().getStatusCode();</span>

<span class="nc" id="L720">      HttpEntity entity = response.getEntity();</span>
<span class="nc" id="L721">      String jsonString = EntityUtils.toString(entity);</span>
<span class="nc" id="L722">      EntityUtils.consume(entity);</span>

<span class="nc" id="L724">      logger.debug(&quot;AmberScript API call was '{}'.&quot; + System.lineSeparator() + &quot;Response: {}&quot;,</span>
<span class="nc" id="L725">              removePrivateInfo(checkUrl), jsonString);</span>

<span class="nc" id="L727">      JSONParser jsonParser = new JSONParser();</span>
<span class="nc" id="L728">      JSONObject jsonObject = (JSONObject) jsonParser.parse(jsonString);</span>

<span class="nc bnc" id="L730" title="All 2 branches missed.">      switch (code) {</span>
        case HttpStatus.SC_OK:
<span class="nc" id="L732">          JSONObject result = (JSONObject) jsonObject.get(&quot;jobStatus&quot;);</span>
<span class="nc" id="L733">          String status = (String) result.get(&quot;status&quot;);</span>
<span class="nc bnc" id="L734" title="All 4 branches missed.">          switch (status) {</span>
            case STATUS_OPEN:
<span class="nc" id="L736">              logger.debug(&quot;Captions job '{}' has not finished yet.&quot;, jobId);</span>
<span class="nc" id="L737">              return false;</span>
            case STATUS_ERROR:
<span class="nc" id="L739">              var errorMsg = (String) result.get(&quot;errorMsg&quot;);</span>
<span class="nc" id="L740">              throw new TranscriptionServiceException(</span>
<span class="nc" id="L741">                      String.format(&quot;Captions job '%s' failed: %s&quot;, jobId, errorMsg),</span>
                      code,
<span class="nc" id="L743">                      ERROR_NO_SPEECH.equals(errorMsg));</span>
            case STATUS_DONE:
<span class="nc" id="L745">              logger.info(&quot;Captions job '{}' has finished.&quot;, jobId);</span>
<span class="nc" id="L746">              TranscriptionJobControl jc = database.findByJob(jobId);</span>
<span class="nc bnc" id="L747" title="All 2 branches missed.">              if (jc != null) {</span>
<span class="nc" id="L748">                mpId = jc.getMediaPackageId();</span>
              }
<span class="nc" id="L750">              transcriptionDone(mpId, jobId);</span>
<span class="nc" id="L751">              return true;</span>
            default:
<span class="nc" id="L753">              return false; // only here to obey checkstyle</span>
          }
        default:
<span class="nc" id="L756">          String error = (String) jsonObject.get(&quot;error&quot;);</span>
<span class="nc" id="L757">          String errorMessage = (String) jsonObject.get(&quot;errorMessage&quot;);</span>
<span class="nc" id="L758">          logger.warn(&quot;Error while checking status: {}.&quot;</span>
<span class="nc" id="L759">                  + System.lineSeparator() + &quot;{}: {}&quot;, code, error, errorMessage);</span>
<span class="nc" id="L760">          throw new TranscriptionServiceException(</span>
<span class="nc" id="L761">                  String.format(&quot;Captions job '%s' failed: Return Code %d&quot;, jobId, code), code);</span>
      }
<span class="nc" id="L763">    } catch (TranscriptionDatabaseException | IOException | ParseException e) {</span>
<span class="nc" id="L764">      logger.warn(&quot;Error while checking status: {}&quot;, e.toString());</span>
    } finally {
      try {
<span class="nc" id="L767">        httpClient.close();</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">        if (response != null) {</span>
<span class="nc" id="L769">          response.close();</span>
        }
<span class="nc" id="L771">      } catch (IOException e) {</span>
<span class="nc" id="L772">      }</span>
    }
<span class="nc" id="L774">    return false;</span>
  }

  private boolean getAndSaveJobResult(String jobId) throws TranscriptionServiceException, IOException {

<span class="nc" id="L779">    CloseableHttpClient httpClient = makeHttpClient();</span>
<span class="nc" id="L780">    CloseableHttpResponse response = null;</span>

<span class="nc" id="L782">    String transcriptUrl = BASE_URL + &quot;/jobs/export?format=srt&amp;jobId=&quot; + jobId + &quot;&amp;apiKey=&quot; + clientKey;</span>

<span class="nc" id="L784">    boolean done = false;</span>

    try {
<span class="nc" id="L787">      HttpGet httpGet = new HttpGet(transcriptUrl);</span>

<span class="nc" id="L789">      response = httpClient.execute(httpGet);</span>
<span class="nc" id="L790">      int code = response.getStatusLine().getStatusCode();</span>

<span class="nc" id="L792">      logger.debug(&quot;AmberScript API {} http response {}&quot;, removePrivateInfo(transcriptUrl), code);</span>

<span class="nc bnc" id="L794" title="All 2 branches missed.">      switch (code) {</span>
        case HttpStatus.SC_OK: // 200
<span class="nc" id="L796">          HttpEntity entity = response.getEntity();</span>
<span class="nc" id="L797">          logger.info(&quot;Retrieved details for transcription with jobid: '{}'&quot;, jobId);</span>

          // Save the result subrip (srt) file into a collection
<span class="nc" id="L800">          workspace.putInCollection(TRANSCRIPT_COLLECTION, jobId + &quot;.srt&quot;, entity.getContent());</span>
<span class="nc" id="L801">          done = true;</span>
<span class="nc" id="L802">          break;</span>

        default:
<span class="nc" id="L805">          logger.warn(&quot;Error retrieving details for transcription with jobid: '{}', return status: {}.&quot;, jobId, code);</span>
          break;
      }
<span class="nc" id="L808">    } catch (Exception e) {</span>
<span class="nc" id="L809">      throw new TranscriptionServiceException(String.format(</span>
              &quot;Exception when calling the transcription service for jobid: %s&quot;, jobId), e);
    } finally {
      try {
<span class="nc" id="L813">        httpClient.close();</span>
<span class="nc bnc" id="L814" title="All 2 branches missed.">        if (response != null) {</span>
<span class="nc" id="L815">          response.close();</span>
        }
<span class="nc" id="L817">      } catch (IOException e) {</span>
<span class="nc" id="L818">      }</span>
    }

<span class="nc" id="L821">    return done;</span>
  }

  @Override
  // Called by the attach workflow operation
  public MediaPackageElement getGeneratedTranscription(String mpId, String jobId, MediaPackageElement.Type type)
          throws TranscriptionServiceException {
    try {
      // If jobId is unknown, look for all jobs associated to that mpId
<span class="nc bnc" id="L830" title="All 4 branches missed.">      if (jobId == null || &quot;null&quot;.equals(jobId)) {</span>
<span class="nc" id="L831">        jobId = null;</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">        for (TranscriptionJobControl jc : database.findByMediaPackage(mpId)) {</span>
<span class="nc bnc" id="L833" title="All 2 branches missed.">          if (TranscriptionJobControl.Status.Closed.name().equals(jc.getStatus())</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">                  || TranscriptionJobControl.Status.TranscriptionComplete.name().equals(jc.getStatus())) {</span>
<span class="nc" id="L835">            jobId = jc.getTranscriptionJobId();</span>
          }
<span class="nc" id="L837">        }</span>
      }

<span class="nc bnc" id="L840" title="All 2 branches missed.">      if (jobId == null) {</span>
<span class="nc" id="L841">        throw new TranscriptionServiceException(</span>
                &quot;No completed or closed transcription job found in database for media package &quot; + mpId);
      }

      // Results already saved?
<span class="nc" id="L846">      URI uri = workspace.getCollectionURI(TRANSCRIPT_COLLECTION, jobId + &quot;.srt&quot;);</span>

<span class="nc" id="L848">      logger.info(&quot;Looking for transcript at URI: {}&quot;, uri);</span>

      try {
<span class="nc" id="L851">        workspace.get(uri);</span>
<span class="nc" id="L852">        logger.info(&quot;Found captions at URI: {}&quot;, uri);</span>
<span class="nc" id="L853">      } catch (Exception e) {</span>
<span class="nc" id="L854">        logger.info(&quot;Results not saved: getting from service for jobId {}&quot;, jobId);</span>
        // Not saved yet so call the transcription service to get the results
<span class="nc" id="L856">        checkJobResults(jobId);</span>
<span class="nc" id="L857">      }</span>
<span class="nc" id="L858">      MediaPackageElementBuilder builder = MediaPackageElementBuilderFactory.newInstance().newElementBuilder();</span>
<span class="nc" id="L859">      logger.debug(&quot;Returning MPE with results file URI: {}&quot;, uri);</span>
<span class="nc" id="L860">      return builder.elementFromURI(uri, type, new MediaPackageElementFlavor(&quot;captions&quot;, &quot;srt&quot;));</span>
<span class="nc" id="L861">    } catch (TranscriptionDatabaseException e) {</span>
<span class="nc" id="L862">      throw new TranscriptionServiceException(&quot;Job id not informed and could not find transcription&quot;, e);</span>
    }
  }

  /**
   * Get mediapackage transcription status
   *
   * @param mpId, mediapackage id
   * @return transcription status
   * @throws TranscriptionServiceException
   */
  public String getTranscriptionStatus(String mpId) throws TranscriptionServiceException {
    try {
<span class="nc bnc" id="L875" title="All 2 branches missed.">      for (TranscriptionJobControl jc : database.findByMediaPackage(mpId)) {</span>
<span class="nc" id="L876">        return jc.getStatus();</span>
      }
<span class="nc" id="L878">    } catch (TranscriptionDatabaseException e) {</span>
<span class="nc" id="L879">      throw new TranscriptionServiceException(&quot;Mediapackage id transcription status unknown&quot;, e);</span>
<span class="nc" id="L880">    }</span>
<span class="nc" id="L881">    return &quot;Unknown&quot;;</span>
  }

  /**
   * Creates a closable http client with default configuration.
   *
   * @return closable http client
   */
  protected CloseableHttpClient makeHttpClient() {
<span class="nc" id="L890">    return makeHttpClient(SOCKET_TIMEOUT);</span>
  }

  /**
   * Creates a closable http client.
   *
   * @param socketTimeout http socket timeout value in milliseconds
   */
  protected CloseableHttpClient makeHttpClient(int socketTimeout) {
<span class="nc" id="L899">    RequestConfig reqConfig = RequestConfig.custom()</span>
<span class="nc" id="L900">        .setConnectTimeout(AmberscriptTranscriptionService.CONNECTION_TIMEOUT)</span>
<span class="nc" id="L901">        .setSocketTimeout(socketTimeout)</span>
<span class="nc" id="L902">        .setConnectionRequestTimeout(AmberscriptTranscriptionService.CONNECTION_TIMEOUT)</span>
<span class="nc" id="L903">        .build();</span>
<span class="nc" id="L904">    CloseableHttpClient httpClient = HttpClientBuilder.create()</span>
<span class="nc" id="L905">        .useSystemProperties()</span>
<span class="nc" id="L906">        .setDefaultRequestConfig(reqConfig)</span>
<span class="nc" id="L907">        .build();</span>
<span class="nc" id="L908">    return httpClient;</span>
  }

  // Called when a transcription job has been submitted
  protected void deleteStorageFile(String filename) {
    try {
<span class="nc" id="L914">      logger.debug(&quot;Removing {} from collection {}.&quot;, filename, SUBMISSION_COLLECTION);</span>
<span class="nc" id="L915">      wfr.deleteFromCollection(SUBMISSION_COLLECTION, filename, false);</span>
<span class="nc" id="L916">    } catch (IOException e) {</span>
<span class="nc" id="L917">      logger.warn(&quot;Unable to remove submission file {} from collection {}&quot;, filename, SUBMISSION_COLLECTION);</span>
<span class="nc" id="L918">    }</span>
<span class="nc" id="L919">  }</span>

  @Reference
  public void setServiceRegistry(ServiceRegistry serviceRegistry) {
<span class="nc" id="L923">    this.serviceRegistry = serviceRegistry;</span>
<span class="nc" id="L924">  }</span>

  @Reference
  public void setSecurityService(SecurityService securityService) {
<span class="nc" id="L928">    this.securityService = securityService;</span>
<span class="nc" id="L929">  }</span>

  @Reference
  public void setUserDirectoryService(UserDirectoryService userDirectoryService) {
<span class="nc" id="L933">    this.userDirectoryService = userDirectoryService;</span>
<span class="nc" id="L934">  }</span>

  @Reference
  public void setOrganizationDirectoryService(OrganizationDirectoryService organizationDirectoryService) {
<span class="nc" id="L938">    this.organizationDirectoryService = organizationDirectoryService;</span>
<span class="nc" id="L939">  }</span>

  @Reference
  public void setWorkspace(Workspace ws) {
<span class="nc" id="L943">    this.workspace = ws;</span>
<span class="nc" id="L944">  }</span>

  @Reference
  public void setWorkingFileRepository(WorkingFileRepository wfr) {
<span class="nc" id="L948">    this.wfr = wfr;</span>
<span class="nc" id="L949">  }</span>

  @Reference
  public void setDatabase(TranscriptionDatabase service) {
<span class="nc" id="L953">    this.database = service;</span>
<span class="nc" id="L954">  }</span>

  @Reference
  public void setAssetManager(AssetManager service) {
<span class="nc" id="L958">    this.assetManager = service;</span>
<span class="nc" id="L959">  }</span>

  @Reference
  public void setWorkflowService(WorkflowService service) {
<span class="nc" id="L963">    this.workflowService = service;</span>
<span class="nc" id="L964">  }</span>

  @Override
  protected ServiceRegistry getServiceRegistry() {
<span class="nc" id="L968">    return serviceRegistry;</span>
  }

  @Override
  protected SecurityService getSecurityService() {
<span class="nc" id="L973">    return securityService;</span>
  }

  @Override
  protected UserDirectoryService getUserDirectoryService() {
<span class="nc" id="L978">    return userDirectoryService;</span>
  }

  @Override
  protected OrganizationDirectoryService getOrganizationDirectoryService() {
<span class="nc" id="L983">    return organizationDirectoryService;</span>
  }

  // Only used by unit tests!
  void setWfUtil(Workflows wfUtil) {
<span class="nc" id="L988">    this.wfUtil = wfUtil;</span>
<span class="nc" id="L989">  }</span>

<span class="nc" id="L991">  class WorkflowDispatcher implements Runnable {</span>

    /**
     * {@inheritDoc}
     *
     * @see java.lang.Thread#run()
     */
    @Override
    public void run() {
<span class="nc" id="L1000">      logger.debug(&quot;WorkflowDispatcher waking up...&quot;);</span>

      try {
        // Find jobs that are in progress and jobs that had transcription complete

        long providerId;
<span class="nc" id="L1006">        TranscriptionProviderControl providerInfo = database.findIdByProvider(PROVIDER);</span>
<span class="nc bnc" id="L1007" title="All 2 branches missed.">        if (providerInfo != null) {</span>
<span class="nc" id="L1008">          providerId = providerInfo.getId();</span>
        } else {
<span class="nc" id="L1010">          logger.debug(&quot;No jobs yet for provider {}.&quot;, PROVIDER);</span>
<span class="nc" id="L1011">          return;</span>
        }

<span class="nc" id="L1014">        List&lt;TranscriptionJobControl&gt; jobs = database.findByStatus(TranscriptionJobControl.Status.InProgress.name(),</span>
<span class="nc" id="L1015">                TranscriptionJobControl.Status.TranscriptionComplete.name());</span>

<span class="nc bnc" id="L1017" title="All 2 branches missed.">        for (TranscriptionJobControl j : jobs) {</span>

          // Don't process jobs for other services
<span class="nc bnc" id="L1020" title="All 2 branches missed.">          if (j.getProviderId() != providerId) {</span>
<span class="nc" id="L1021">            continue;</span>
          }

<span class="nc" id="L1024">          String mpId = j.getMediaPackageId();</span>
<span class="nc" id="L1025">          String jobId = j.getTranscriptionJobId();</span>

          // If the job in progress, check if it should already have finished.
<span class="nc bnc" id="L1028" title="All 2 branches missed.">          if (TranscriptionJobControl.Status.InProgress.name().equals(j.getStatus())) {</span>
            // If job should already have been completed, try to get the results.
<span class="nc bnc" id="L1030" title="All 2 branches missed.">            if (j.getDateExpected().getTime() &lt; System.currentTimeMillis()) {</span>
              try {
<span class="nc bnc" id="L1032" title="All 2 branches missed.">                if (!checkJobResults(jobId)) {</span>
                  // Job still running, not finished, so check if it should have finished more than N seconds ago
<span class="nc bnc" id="L1034" title="All 2 branches missed.">                  if (j.getDateExpected().getTime() + maxProcessingSeconds * 1000 &lt; System.currentTimeMillis()) {</span>
                    // Processing for too long, mark job as canceled and don't check anymore
<span class="nc" id="L1036">                    database.updateJobControl(jobId, TranscriptionJobControl.Status.Canceled.name());</span>
                  }
                  // else Job still running, not finished
<span class="nc" id="L1039">                  continue;</span>
                }
<span class="nc" id="L1041">              } catch (TranscriptionServiceException e) {</span>
                try {
<span class="nc" id="L1043">                  database.updateJobControl(jobId, TranscriptionJobControl.Status.Canceled.name());</span>
<span class="nc" id="L1044">                  continue;</span>
<span class="nc" id="L1045">                } catch (TranscriptionDatabaseException ex) {</span>
<span class="nc" id="L1046">                  logger.warn(&quot;Could not cancel job '{}'.&quot;, jobId);</span>
                }
<span class="nc" id="L1048">              }</span>
            } else {
              continue; // Not time to check yet
            }
          }

          // Jobs that get here have state TranscriptionCompleted
          try {
<span class="nc" id="L1056">            DefaultOrganization defaultOrg = new DefaultOrganization();</span>
<span class="nc" id="L1057">            securityService.setOrganization(defaultOrg);</span>
<span class="nc" id="L1058">            securityService.setUser(SecurityUtil.createSystemUser(systemAccount, defaultOrg));</span>

            // Find the episode
<span class="nc" id="L1061">            Optional&lt;Snapshot&gt; snapshot = assetManager.getLatestSnapshot(mpId);</span>
<span class="nc bnc" id="L1062" title="All 2 branches missed.">            if (snapshot.isEmpty()) {</span>
<span class="nc" id="L1063">              logger.warn(&quot;Media package {} no longer exists in the asset manager. It was likely deleted. &quot;</span>
                  + &quot;Dropping the generated transcription.&quot;, mpId);
<span class="nc" id="L1065">              database.updateJobControl(jobId, TranscriptionJobControl.Status.Error.name());</span>
<span class="nc" id="L1066">              continue;</span>
            }

<span class="nc" id="L1069">            String org = snapshot.get().getOrganizationId();</span>
<span class="nc" id="L1070">            Organization organization = organizationDirectoryService.getOrganization(org);</span>
<span class="nc bnc" id="L1071" title="All 2 branches missed.">            if (organization == null) {</span>
<span class="nc" id="L1072">              logger.warn(&quot;Media package {} has an unknown organization {}. Skipped.&quot;, mpId, org);</span>
<span class="nc" id="L1073">              continue;</span>
            }
<span class="nc" id="L1075">            securityService.setOrganization(organization);</span>

            // Build workflow
<span class="nc" id="L1078">            Map&lt;String, String&gt; params = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L1079">            params.put(&quot;transcriptionJobId&quot;, jobId);</span>
<span class="nc" id="L1080">            WorkflowDefinition wfDef = workflowService.getWorkflowDefinitionById(workflowDefinitionId);</span>

            // Apply workflow
            // wfUtil is only used by unit tests
<span class="nc bnc" id="L1084" title="All 2 branches missed.">            Workflows workflows = wfUtil != null ? wfUtil : new Workflows(assetManager, workflowService);</span>
<span class="nc" id="L1085">            Set&lt;String&gt; mpIds = new HashSet&lt;String&gt;();</span>
<span class="nc" id="L1086">            mpIds.add(mpId);</span>
<span class="nc" id="L1087">            List&lt;WorkflowInstance&gt; wfList = workflows</span>
<span class="nc" id="L1088">                    .applyWorkflowToLatestVersion(mpIds, ConfiguredWorkflow.workflow(wfDef, params));</span>
<span class="nc bnc" id="L1089" title="All 2 branches missed.">            String wfId = wfList.size() &gt; 0 ? Long.toString(wfList.get(0).getId()) : &quot;Unknown&quot;;</span>

            // Update state in the database
<span class="nc" id="L1092">            database.updateJobControl(jobId, TranscriptionJobControl.Status.Closed.name());</span>
<span class="nc" id="L1093">            logger.info(&quot;Attach transcription workflow {} scheduled for mp {}, transcription service job {}&quot;,</span>
                    wfId, mpId, jobId);
<span class="nc" id="L1095">          } catch (Exception e) {</span>
<span class="nc" id="L1096">            logger.warn(&quot;Attach transcription workflow could NOT be scheduled for mp {}, amberscript job {}, {}: {}&quot;,</span>
<span class="nc" id="L1097">                    mpId, jobId, e.getClass().getName(), e.getMessage());</span>
<span class="nc" id="L1098">          }</span>
<span class="nc" id="L1099">        }</span>
<span class="nc" id="L1100">      } catch (TranscriptionDatabaseException e) {</span>
<span class="nc" id="L1101">        logger.warn(&quot;Could not read transcription job control database: {}&quot;, e.getMessage());</span>
<span class="nc" id="L1102">      }</span>
<span class="nc" id="L1103">    }</span>
  }

<span class="nc" id="L1106">  class ResultsFileCleanup implements Runnable {</span>

    @Override
    public void run() {
<span class="nc" id="L1110">      logger.info(&quot;ResultsFileCleanup waking up...&quot;);</span>
      try {
        // Cleans up results files older than CLEANUP_RESULT_FILES_DAYS days
<span class="nc" id="L1113">        wfr.cleanupOldFilesFromCollection(TRANSCRIPT_COLLECTION, cleanupResultDays);</span>
<span class="nc" id="L1114">        wfr.cleanupOldFilesFromCollection(SUBMISSION_COLLECTION, cleanupResultDays);</span>
<span class="nc" id="L1115">      } catch (IOException e) {</span>
<span class="nc" id="L1116">        logger.warn(&quot;Could not cleanup old submission and transcript results files&quot;, e);</span>
<span class="nc" id="L1117">      }</span>
<span class="nc" id="L1118">    }</span>
  }

  private String removePrivateInfo(String unsafeString) {
<span class="nc" id="L1122">    String safeString = unsafeString.replace(clientKey, &quot;__api-key-was-hidden__&quot;);</span>
<span class="nc" id="L1123">    return safeString;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>